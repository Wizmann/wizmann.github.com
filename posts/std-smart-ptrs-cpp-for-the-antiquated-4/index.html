<!doctype html><html><head><script>window.MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"],["\\[","\\]"]]},svg:{fontCache:"global"}}</script><script defer src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script></head><body><header class=header-wrapper><div class=header><a class=site-title href=https://wizmann.top/>Maerlyn's Rainbow</a><nav class=menu></nav></div></header><main class=main-wrapper><div class=main><section class=single><h1 class=title>åŠ¨æ‰‹å®ç°æ™ºèƒ½æŒ‡é’ˆ ï¼ˆä¸Šç¯‡ï¼‰ - C++ for the Antiquatedï¼ˆä¹‹å››ï¼‰</h1><div class=tip><time datetime="2025-01-21 00:00:00 +0000 UTC">2025/01/21</time>
<span class=split>Â·</span>
<span>4119 words </span><span class=split>Â·</span>
<span>9 minutes to read</span></div><div class=taxonomies><div>Tags:
<a href=/tags/cpp>cpp</a>
<a href=/tags/modern-cpp>modern cpp</a></div></div><hr><div class=content><p>æ™ºèƒ½æŒ‡é’ˆï¼ˆå¦‚ <code>std::shared_ptr</code> å’Œ <code>std::weak_ptr</code>ï¼‰å·²ç»æˆä¸ºç°ä»£ C++ ç¼–ç¨‹çš„é‡è¦å·¥å…·ï¼Œå°½ç®¡å®ƒä»¬å¹¶ä¸ç®—æ˜¯â€œæ–°å…´â€çš„ç‰¹æ€§ã€‚åœ¨ C++11 æ ‡å‡†ä¹‹å‰ï¼ŒBoost åº“å°±å·²ç»å¼•å…¥äº†æ™ºèƒ½æŒ‡é’ˆçš„å®ç°ï¼Œç‰¹åˆ«æ˜¯ <code>boost::shared_ptr</code> å’Œ <code>boost::weak_ptr</code>ï¼Œå®ƒä»¬ä¸º C++11 çš„æ™ºèƒ½æŒ‡é’ˆç‰¹æ€§å¥ å®šäº†åŸºç¡€ã€‚å› æ­¤ï¼Œå¯ä»¥è¯´æ™ºèƒ½æŒ‡é’ˆåœ¨ C++ ä¸­çš„å‘å±•å†ç¨‹å·²ç»æœ‰å¾ˆé•¿æ—¶é—´ï¼Œè€Œå®ƒä»¬çš„å¼•å…¥æå¤§åœ°ç®€åŒ–äº†å†…å­˜ç®¡ç†å’Œé¿å…äº†å¸¸è§çš„å†…å­˜æ³„æ¼å’Œæ‚¬æŒ‚æŒ‡é’ˆé—®é¢˜ã€‚</p><p>æœ¬æ–‡å°†å›´ç»•ä»¥ä¸‹ä¸»é¢˜å±•å¼€è®¨è®ºï¼š</p><ul><li>C++ æ™ºèƒ½æŒ‡é’ˆçš„å®ç°åŸç†</li><li>éä¾µå…¥å¼æ™ºèƒ½æŒ‡é’ˆä¸ä¾µå…¥å¼æ™ºèƒ½æŒ‡é’ˆçš„åŒºåˆ«</li><li>åˆ©ç”¨ <code>atomic</code> é¿å…å¤šçº¿ç¨‹ç«æ€æ¡ä»¶</li><li>å¦‚ä½•å®ç°ä¾µå…¥å¼ç‰ˆæœ¬çš„ <code>shared_ptr</code> å’Œ <code>weak_ptr</code></li><li>é‡‡ç”¨ <code>concept</code> çº¦æŸæ¨¡æ¿ç±»å‹</li><li>æ¢è®¨å®Œç¾è½¬å‘ï¼ˆ<code>std::forward&lt;T></code>ï¼‰åœ¨æ™ºèƒ½æŒ‡é’ˆä¸­çš„åº”ç”¨</li></ul><h2 id=c-ä¸­çš„æ™ºèƒ½æŒ‡é’ˆ>C++ ä¸­çš„æ™ºèƒ½æŒ‡é’ˆ <a href=#c-%e4%b8%ad%e7%9a%84%e6%99%ba%e8%83%bd%e6%8c%87%e9%92%88 class=anchor>ğŸ”—</a></h2><h3 id=stdshared_ptrçš„å®ç°><code>std::shared_ptr</code>çš„å®ç° <a href=#stdshared_ptr%e7%9a%84%e5%ae%9e%e7%8e%b0 class=anchor>ğŸ”—</a></h3><p><code>std::shared_ptr</code> æ˜¯ä¸€ç§æ™ºèƒ½æŒ‡é’ˆï¼Œèƒ½å¤Ÿè‡ªåŠ¨ç®¡ç†å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸã€‚å®ƒé€šè¿‡å¼•ç”¨è®¡æ•°çš„æ–¹å¼æ¥è·Ÿè¸ªæœ‰å¤šå°‘ä¸ª <code>shared_ptr</code> å®ä¾‹æŒ‡å‘åŒä¸€ä¸ªå¯¹è±¡ï¼Œç¡®ä¿å½“æœ€åä¸€ä¸ª <code>shared_ptr</code> è¢«é”€æ¯æ—¶ï¼Œå¯¹è±¡çš„å†…å­˜èƒ½å¤Ÿè‡ªåŠ¨é‡Šæ”¾ã€‚</p><h4 id=å¼•ç”¨è®¡æ•°ä¸åŸå­æ“ä½œ>å¼•ç”¨è®¡æ•°ä¸åŸå­æ“ä½œ <a href=#%e5%bc%95%e7%94%a8%e8%ae%a1%e6%95%b0%e4%b8%8e%e5%8e%9f%e5%ad%90%e6%93%8d%e4%bd%9c class=anchor>ğŸ”—</a></h4><p><code>std::shared_ptr</code> çš„æ ¸å¿ƒæœºåˆ¶æ˜¯å¼•ç”¨è®¡æ•°ã€‚æ¯ä¸ª <code>shared_ptr</code> ä¼šç»´æŠ¤ä¸€ä¸ªå¼•ç”¨è®¡æ•°ã€‚å½“å¤šä¸ª <code>shared_ptr</code> æŒ‡å‘åŒä¸€ä¸ªå¯¹è±¡æ—¶ï¼Œè®¡æ•°å™¨ä¼šå¢åŠ ï¼›å½“ä¸€ä¸ª <code>shared_ptr</code> è¢«é”€æ¯æ—¶ï¼Œè®¡æ•°å™¨ä¼šå‡å°‘ã€‚å¦‚æœè®¡æ•°å™¨å½’é›¶ï¼Œè¡¨æ˜æ²¡æœ‰ä»»ä½• <code>shared_ptr</code> å†æŒ‡å‘è¯¥å¯¹è±¡ï¼Œè¿™æ—¶å¯¹è±¡ä¼šè¢«åˆ é™¤ã€‚</p><p>å¼•ç”¨è®¡æ•°é€šå¸¸ç”±ä¸€ä¸ªæ§åˆ¶å—ï¼ˆcontrol blockï¼‰ç®¡ç†ã€‚æ§åˆ¶å—ä¸ä»…ä¿å­˜å¼•ç”¨è®¡æ•°ï¼Œè¿˜ä¼šä¿å­˜å¯¹è±¡æœ¬èº«ä»¥åŠä¸å¯¹è±¡ç”Ÿå‘½å‘¨æœŸç›¸å…³çš„å…¶ä»–ä¿¡æ¯ã€‚<code>std::shared_ptr</code> çš„å®ç°ä¸€èˆ¬ä½¿ç”¨â€œéä¾µå…¥å¼å¼•ç”¨è®¡æ•°â€ï¼ˆå³ä¸åµŒå…¥å¯¹è±¡æœ¬èº«ï¼‰ã€‚</p><p>ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>template</span> <span style=color:#f92672>&lt;</span><span style=color:#66d9ef>typename</span> T<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>control_block</span> {
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>    control_block(T<span style=color:#f92672>*</span> ptr)
</span></span><span style=display:flex><span>        <span style=color:#f92672>:</span> ref_count(<span style=color:#ae81ff>1</span>), obj(ptr) {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// å¢åŠ å¼•ç”¨è®¡æ•°
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>add_ref</span>() { <span style=color:#f92672>++</span>ref_count; }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// å‡å°‘å¼•ç”¨è®¡æ•°
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>release_ref</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>--</span>ref_count <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>delete</span> obj;  <span style=color:#75715e>// åˆ é™¤å¯¹è±¡
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>delete</span> <span style=color:#66d9ef>this</span>; <span style=color:#75715e>// åˆ é™¤æ§åˆ¶å—
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    T<span style=color:#f92672>*</span> <span style=color:#a6e22e>get</span>() { <span style=color:#66d9ef>return</span> obj; }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>    std<span style=color:#f92672>::</span>atomic<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>int</span><span style=color:#f92672>&gt;</span> ref_count;    <span style=color:#75715e>// å¼•ç”¨è®¡æ•°
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    T<span style=color:#f92672>*</span> obj;                        <span style=color:#75715e>// å®é™…å¯¹è±¡
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>};
</span></span></code></pre></div><h4 id=ç®€åŒ–ç‰ˆ-shared_ptr-å®ç°>ç®€åŒ–ç‰ˆ <code>shared_ptr</code> å®ç° <a href=#%e7%ae%80%e5%8c%96%e7%89%88-shared_ptr-%e5%ae%9e%e7%8e%b0 class=anchor>ğŸ”—</a></h4><p>ä¸‹é¢æ˜¯ä¸€ä¸ªç®€åŒ–ç‰ˆçš„ <code>shared_ptr</code> å®ç°ç¤ºä¾‹ã€‚è¿™ä¸ªç‰ˆæœ¬ä»ç„¶æœ‰ä¸€äº›é‡è¦ç»†èŠ‚éœ€è¦æ³¨æ„ï¼Œæ¯”å¦‚åŸå­æ“ä½œå’Œå¼‚å¸¸å®‰å…¨ç­‰é—®é¢˜ï¼Œä½†å¯ä»¥å¸®åŠ©ç†è§£ <code>shared_ptr</code> çš„åŸºæœ¬åŸç†ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>template</span> <span style=color:#f92672>&lt;</span><span style=color:#66d9ef>typename</span> T<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>my_shared_ptr</span> {
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>    T<span style=color:#f92672>*</span> ptr;
</span></span><span style=display:flex><span>    control_block<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;*</span> ctrl_block;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>explicit</span> my_shared_ptr(T<span style=color:#f92672>*</span> p <span style=color:#f92672>=</span> <span style=color:#66d9ef>nullptr</span>) 
</span></span><span style=display:flex><span>        <span style=color:#f92672>:</span> ptr(p), ctrl_block(<span style=color:#66d9ef>new</span> control_block<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span>(p)) {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ‹·è´æ„é€ å‡½æ•°
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    my_shared_ptr(<span style=color:#66d9ef>const</span> my_shared_ptr<span style=color:#f92672>&amp;</span> other) 
</span></span><span style=display:flex><span>        <span style=color:#f92672>:</span> ptr(other.ptr), ctrl_block(other.ctrl_block) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (ctrl_block) {
</span></span><span style=display:flex><span>            ctrl_block<span style=color:#f92672>-&gt;</span>add_ref();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ææ„å‡½æ•°
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>~</span>my_shared_ptr() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (ctrl_block) {
</span></span><span style=display:flex><span>            ctrl_block<span style=color:#f92672>-&gt;</span>release_ref();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    T<span style=color:#f92672>*</span> <span style=color:#66d9ef>operator</span><span style=color:#f92672>-&gt;</span>() { <span style=color:#66d9ef>return</span> ptr; }
</span></span><span style=display:flex><span>    T<span style=color:#f92672>&amp;</span> <span style=color:#66d9ef>operator</span><span style=color:#f92672>*</span>() { <span style=color:#66d9ef>return</span> <span style=color:#f92672>*</span>ptr; }
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><h3 id=stdweak_ptrçš„å®ç°><code>std::weak_ptr</code>çš„å®ç° <a href=#stdweak_ptr%e7%9a%84%e5%ae%9e%e7%8e%b0 class=anchor>ğŸ”—</a></h3><p><code>std::weak_ptr</code> æ˜¯ä¸ <code>std::shared_ptr</code> é…åˆä½¿ç”¨çš„æ™ºèƒ½æŒ‡é’ˆï¼Œå®ƒè§£å†³äº† <code>shared_ptr</code> åœ¨æŸäº›åœºæ™¯ä¸‹çš„å¾ªç¯å¼•ç”¨é—®é¢˜ã€‚</p><p>å¾ªç¯å¼•ç”¨é—®é¢˜å‘ç”Ÿåœ¨ä¸¤ä¸ªæˆ–å¤šä¸ªå¯¹è±¡é€šè¿‡ <code>shared_ptr</code> ç›¸äº’å¼•ç”¨æ—¶ï¼Œå¯¼è‡´å¼•ç”¨è®¡æ•°æ°¸è¿œä¸ä¸ºé›¶ï¼Œä»è€Œå¼•å‘å†…å­˜æ³„æ¼ã€‚ä¸ºäº†é¿å…è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¼•å…¥äº† <code>weak_ptr</code>ã€‚</p><h4 id=ä¸ºä»€ä¹ˆéœ€è¦-weak_ptr>ä¸ºä»€ä¹ˆéœ€è¦ <code>weak_ptr</code> <a href=#%e4%b8%ba%e4%bb%80%e4%b9%88%e9%9c%80%e8%a6%81-weak_ptr class=anchor>ğŸ”—</a></h4><p><code>std::weak_ptr</code> ä¸å¢åŠ å¼•ç”¨è®¡æ•°ï¼Œå› æ­¤å®ƒä¸ä¼šå½±å“å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸã€‚å½“ä¸€ä¸ªå¯¹è±¡çš„æ‰€æœ‰ <code>shared_ptr</code> è¢«é”€æ¯åï¼Œ<code>weak_ptr</code> å°†å˜ä¸ºâ€œæ‚¬æŒ‚â€çŠ¶æ€ã€‚è¿™ä¸æ™®é€šæŒ‡é’ˆçš„â€œç©ºæ‚¬æŒ‡é’ˆâ€ï¼ˆdangling pointerï¼‰ä¸åŒï¼Œç©ºæ‚¬çš„ <code>weak_ptr</code> ä¼šè¿”å›ç©ºæŒ‡é’ˆ <code>nullptr</code>ï¼Œè¡¨æ˜è¯¥å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸå·²ç»ç»“æŸã€‚</p><p><code>weak_ptr</code> æä¾›äº†ä¸€ç§è®¿é—® <code>shared_ptr</code> çš„æ–¹å¼ï¼Œä½†å¹¶ä¸æ§åˆ¶å¯¹è±¡çš„é”€æ¯ï¼Œå› æ­¤å®ƒå¯ä»¥æœ‰æ•ˆé¿å…å¾ªç¯å¼•ç”¨é—®é¢˜ã€‚</p><p>é€šè¿‡ <code>weak_ptr</code>ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¸å»¶é•¿å¯¹è±¡ç”Ÿå‘½å‘¨æœŸçš„å‰æä¸‹ï¼Œæ£€æŸ¥å¯¹è±¡æ˜¯å¦ä»ç„¶å­˜åœ¨ï¼Œå¹¶è®¿é—®å®ƒã€‚å…·ä½“æ¥è¯´ï¼Œ<code>weak_ptr</code> å¯ä»¥é€šè¿‡è°ƒç”¨ <code>lock()</code> æ–¹æ³•æ¥åˆ›å»ºä¸€ä¸ª <code>shared_ptr</code>ï¼Œå¦‚æœå¯¹è±¡è¿˜å­˜åœ¨ï¼ˆå³å¼•ç”¨è®¡æ•°å¤§äºé›¶ï¼‰ï¼Œåˆ™è¿”å›ä¸€ä¸ªæœ‰æ•ˆçš„ <code>shared_ptr</code>ï¼Œå¦åˆ™è¿”å›ç©ºæŒ‡é’ˆã€‚</p><h4 id=æ§åˆ¶å—çš„æ‰©å±•>æ§åˆ¶å—çš„æ‰©å±• <a href=#%e6%8e%a7%e5%88%b6%e5%9d%97%e7%9a%84%e6%89%a9%e5%b1%95 class=anchor>ğŸ”—</a></h4><p>ä¸ºäº†æ”¯æŒ<code>std::weak_ptr</code>ï¼Œ æˆ‘ä»¬éœ€è¦æ‰©å±•æ§åˆ¶å—çš„åŠŸèƒ½ ï¼Œä½¿å…¶èƒ½åŒæ—¶ç®¡ç†å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ï¼ˆ<code>ref_count</code>ï¼‰å’Œå¼±å¼•ç”¨è®¡æ•°ï¼ˆ<code>weak_count</code>ï¼‰ï¼Œä»è€Œä¿æŒå¯¹å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸçš„æ­£ç¡®ç®¡ç†ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>template</span> <span style=color:#f92672>&lt;</span><span style=color:#66d9ef>typename</span> T<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>control_block</span> {
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>    control_block(T<span style=color:#f92672>*</span> ptr)
</span></span><span style=display:flex><span>        <span style=color:#f92672>:</span> ref_count(<span style=color:#ae81ff>1</span>), weak_count(<span style=color:#ae81ff>1</span>), obj(ptr) {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// å¢åŠ å¼•ç”¨è®¡æ•°
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>add_ref</span>() { <span style=color:#f92672>++</span>ref_count; }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// å¢åŠ å¼•ç”¨è®¡æ•°
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>bool</span> <span style=color:#a6e22e>lock</span>() { 
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> prev <span style=color:#f92672>=</span> ref_count.load();  <span style=color:#75715e>// ä½¿ç”¨åŠ è½½å½“å‰å€¼ï¼Œé¿å…é‡å¤è¯»å–
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>while</span> (prev <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>ref_count.compare_exchange_weak(prev, prev <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>)) {
</span></span><span style=display:flex><span>            prev <span style=color:#f92672>=</span> ref_count.load();   <span style=color:#75715e>// å¦‚æœå¤±è´¥ï¼Œé‡æ–°åŠ è½½å½“å‰å€¼
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> prev <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>;  <span style=color:#75715e>// å¦‚æœ prev &gt; 0ï¼Œè¡¨ç¤ºé”å®šæˆåŠŸ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// å‡å°‘å¼•ç”¨è®¡æ•°
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>release_ref</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>--</span>ref_count <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>delete</span> obj;  <span style=color:#75715e>// åˆ é™¤å¯¹è±¡
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            release_control_block(); <span style=color:#75715e>// å°è¯•åˆ é™¤æ§åˆ¶å—
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// å¢åŠ å¼±å¼•ç”¨è®¡æ•°
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>add_weak_ref</span>() { <span style=color:#f92672>++</span>weak_count; }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// å‡å°‘å¼±å¼•ç”¨è®¡æ•°
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>release_weak_ref</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (weak_count.fetch_sub(<span style=color:#ae81ff>1</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>delete</span> <span style=color:#66d9ef>this</span>; <span style=color:#75715e>// åˆ é™¤æ§åˆ¶å—
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    T<span style=color:#f92672>*</span> <span style=color:#a6e22e>get</span>() { <span style=color:#66d9ef>return</span> obj; }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// åˆ é™¤æ§åˆ¶å—ï¼Œåªæœ‰åœ¨å¼±å¼•ç”¨è®¡æ•°ä¸º0æ—¶æ‰åˆ é™¤æ§åˆ¶å—
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>void</span> release_control_block() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (weak_count <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>delete</span> <span style=color:#66d9ef>this</span>; <span style=color:#75715e>// åˆ é™¤æ§åˆ¶å—
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    std<span style=color:#f92672>::</span>atomic<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>int</span><span style=color:#f92672>&gt;</span> ref_count;    <span style=color:#75715e>// å¼ºå¼•ç”¨è®¡æ•°
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    std<span style=color:#f92672>::</span>atomic<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>int</span><span style=color:#f92672>&gt;</span> weak_count;   <span style=color:#75715e>// å¼±å¼•ç”¨è®¡æ•°
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    T<span style=color:#f92672>*</span> obj;                        <span style=color:#75715e>// å®é™…å¯¹è±¡
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>};
</span></span></code></pre></div><h4 id=weak_ptr-çš„ç®€åŒ–ç‰ˆå®ç°><code>weak_ptr</code> çš„ç®€åŒ–ç‰ˆå®ç° <a href=#weak_ptr-%e7%9a%84%e7%ae%80%e5%8c%96%e7%89%88%e5%ae%9e%e7%8e%b0 class=anchor>ğŸ”—</a></h4><p>ä¸‹é¢æ˜¯ä¸€ä¸ªç®€åŒ–ç‰ˆçš„ <code>weak_ptr</code> å®ç°ï¼Œå®ƒä¸ <code>shared_ptr</code> å…±äº«ç›¸åŒçš„æ§åˆ¶å—ã€‚<code>weak_ptr</code> æœ¬èº«ä¸å¢åŠ å¼•ç”¨è®¡æ•°ï¼Œå› æ­¤ä¸ä¼šå½±å“å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>template</span> <span style=color:#f92672>&lt;</span><span style=color:#66d9ef>typename</span> T<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>my_weak_ptr</span> {
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>    my_weak_ptr() <span style=color:#f92672>:</span> ctrl_block(<span style=color:#66d9ef>nullptr</span>) {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ä» shared_ptr æ„é€  my_weak_ptr
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    my_weak_ptr(<span style=color:#66d9ef>const</span> std<span style=color:#f92672>::</span>shared_ptr<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;&amp;</span> shared)
</span></span><span style=display:flex><span>        <span style=color:#f92672>:</span> ctrl_block(shared.ctrl_block) {
</span></span><span style=display:flex><span>        ctrl_block<span style=color:#f92672>-&gt;</span>add_weak_ref();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>~</span>my_weak_ptr() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (ctrl_block) {
</span></span><span style=display:flex><span>            ctrl_block<span style=color:#f92672>-&gt;</span>release_weak_ref();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// å°è¯•è·å–æŒ‡å‘å¯¹è±¡çš„ shared_ptr
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    std<span style=color:#f92672>::</span>shared_ptr<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> lock() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> std<span style=color:#f92672>::</span>shared_ptr<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span>(<span style=color:#f92672>*</span><span style=color:#66d9ef>this</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>    control_block<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;*</span> ctrl_block; <span style=color:#75715e>// æ§åˆ¶å—
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>template</span> <span style=color:#f92672>&lt;</span><span style=color:#66d9ef>typename</span> T<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>my_shared_ptr</span> {
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>    T<span style=color:#f92672>*</span> ptr;
</span></span><span style=display:flex><span>    control_block<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;*</span> ctrl_block;
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    my_shared_ptr(<span style=color:#66d9ef>const</span> my_weak_ptr<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;&amp;</span> weak_ptr) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (weak_ptr.ctrl_block <span style=color:#f92672>&amp;&amp;</span> weak_ptr.ctrl_block<span style=color:#f92672>-&gt;</span>lock()) {
</span></span><span style=display:flex><span>            ptr <span style=color:#f92672>=</span> weak_ptr.ptr;
</span></span><span style=display:flex><span>            ctrl_block <span style=color:#f92672>=</span> weak_ptr.ctrl_block();
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#a6e22e>exception</span>(<span style=color:#e6db74>&#34;bad weak ptr&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>};
</span></span></code></pre></div><h2 id=ç†è§£å¹¶ä¼˜åŒ–stdatomictæ“ä½œ>ç†è§£å¹¶ä¼˜åŒ–<code>std::atomic&lt;T></code>æ“ä½œ <a href=#%e7%90%86%e8%a7%a3%e5%b9%b6%e4%bc%98%e5%8c%96stdatomict%e6%93%8d%e4%bd%9c class=anchor>ğŸ”—</a></h2><p>åœ¨ä¸Šé¢çš„ä»£ç ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†<code>std::atomic&lt;int></code>ä½œä¸ºæ™ºèƒ½æŒ‡é’ˆçš„å¼•ç”¨è®¡æ•°ã€‚ä¸ç›´æ¥ä½¿ç”¨<code>int</code>å˜é‡ä¸åŒï¼Œ<code>std::atomic&lt;int></code>å¯ä»¥åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­æ­£ç¡®åœ°ç®¡ç†å¯¹åŒä¸€æ™ºèƒ½æŒ‡é’ˆçš„å¼•ç”¨è®¡æ•°ã€‚</p><p>ç„¶è€Œï¼Œåœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œæˆ‘ä»¬ä»…ä½¿ç”¨äº†<code>std::atomic&lt;int></code>çš„åŸºæœ¬æ“ä½œï¼ˆå¦‚è‡ªå¢ã€è‡ªå‡å’Œèµ‹å€¼ç­‰ï¼‰ï¼Œè¿™äº›æ“ä½œé»˜è®¤ä½¿ç”¨<code>memory_order_seq_cst</code>å†…å­˜åºï¼ˆç¨åä¼šè®¨è®ºï¼‰ã€‚åœ¨å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­ï¼Œ<code>std::atomic&lt;T></code>æä¾›äº†å¤šç§å†…å­˜åºï¼ˆmemory orderingï¼‰é€‰é¡¹ï¼Œç”¨ä»¥æ§åˆ¶æ“ä½œçš„å¯è§æ€§å’Œæ‰§è¡Œé¡ºåºï¼Œä»¥ç¡®ä¿æ•°æ®ä¸€è‡´æ€§ã€‚ä¸åŒçš„å†…å­˜åºç­–ç•¥å†³å®šäº†ç¼–è¯‘å™¨å’ŒCPUå¯¹æŒ‡ä»¤çš„é‡æ’åºç¨‹åº¦ã€‚</p><p>å¼€å‘è€…çš„ç›®æ ‡æ˜¯é€‰æ‹©åˆé€‚çš„å†…å­˜åºï¼Œä¼˜åŒ–ç¨‹åºæ€§èƒ½ï¼ŒåŒæ—¶ç¡®ä¿ç¨‹åºçš„æ­£ç¡®æ€§ã€‚</p><h3 id=å†…å­˜åºçš„æ ¸å¿ƒæ¦‚å¿µ>å†…å­˜åºçš„æ ¸å¿ƒæ¦‚å¿µ <a href=#%e5%86%85%e5%ad%98%e5%ba%8f%e7%9a%84%e6%a0%b8%e5%bf%83%e6%a6%82%e5%bf%b5 class=anchor>ğŸ”—</a></h3><p>ç†è§£å†…å­˜åºçš„å…³é”®åœ¨äº<strong>é‡æ’åº</strong>å’Œ<strong>è·¨çº¿ç¨‹å¯è§æ€§</strong>ï¼š</p><ol><li><p><strong>é‡æ’åºï¼ˆReorderingï¼‰</strong><br>ç¼–è¯‘å™¨å’ŒCPUå¯èƒ½ä¼šé‡æ’æŒ‡ä»¤ï¼Œä»¥ä¼˜åŒ–æ€§èƒ½ã€‚ä¾‹å¦‚ï¼Œå®ƒä»¬å¯èƒ½ä¼šæå‰æ‰§è¡ŒæŸäº›è®¡ç®—ï¼Œæˆ–è€…å°†å­˜å‚¨æ“ä½œæ¨è¿Ÿæ‰§è¡Œã€‚æ­£ç¡®ä½¿ç”¨<code>std::atomic</code>å¯ä»¥é˜²æ­¢æŸäº›å…³é”®æ“ä½œè¢«é”™è¯¯åœ°é‡æ’åºã€‚</p></li><li><p><strong>å¯è§æ€§ï¼ˆVisibilityï¼‰</strong><br>åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­ï¼Œä¸€ä¸ªçº¿ç¨‹å¯¹å˜é‡çš„ä¿®æ”¹å¯èƒ½ä¸ä¼šç«‹å³è¢«å…¶ä»–çº¿ç¨‹çœ‹åˆ°ï¼Œæˆ–è€…å¤šä¸ªçº¿ç¨‹å¯¹åŒä¸€å˜é‡çš„æ“ä½œé¡ºåºå¯èƒ½ä¸ç¡®å®šã€‚åŸå­æ“ä½œçš„å†…å­˜åºå†³å®šäº†å…¶ä»–çº¿ç¨‹ä½•æ—¶èƒ½çœ‹åˆ°è¿™äº›ä¿®æ”¹ã€‚</p></li></ol><h3 id=ä¸åŒå†…å­˜åºçš„ä½œç”¨åŠä½¿ç”¨åœºæ™¯>ä¸åŒå†…å­˜åºçš„ä½œç”¨åŠä½¿ç”¨åœºæ™¯ <a href=#%e4%b8%8d%e5%90%8c%e5%86%85%e5%ad%98%e5%ba%8f%e7%9a%84%e4%bd%9c%e7%94%a8%e5%8f%8a%e4%bd%bf%e7%94%a8%e5%9c%ba%e6%99%af class=anchor>ğŸ”—</a></h3><h4 id=memory_order_relaxedæ¾æ•£é¡ºåºæœ€ä½å¼€é”€><code>memory_order_relaxed</code>ï¼ˆæ¾æ•£é¡ºåºï¼Œæœ€ä½å¼€é”€ï¼‰ <a href=#memory_order_relaxed%e6%9d%be%e6%95%a3%e9%a1%ba%e5%ba%8f%e6%9c%80%e4%bd%8e%e5%bc%80%e9%94%80 class=anchor>ğŸ”—</a></h4><ul><li><strong>ç‰¹ç‚¹</strong>ï¼šä¸ä¿è¯é¡ºåºï¼Œä»…ä¿è¯æ“ä½œæ˜¯<strong>åŸå­çš„</strong>ã€‚</li><li><strong>ä½œç”¨</strong>ï¼šç¡®ä¿åŒä¸€<code>std::atomic&lt;T></code>å˜é‡çš„è¯»å†™æ“ä½œæ˜¯åŸå­çš„ï¼Œä½†ä¸æä¾›çº¿ç¨‹é—´çš„åŒæ­¥ï¼Œä¸å½±å“å¯è§æ€§æˆ–é¡ºåºã€‚</li><li><strong>é€‚ç”¨åœºæ™¯</strong>ï¼šé€‚ç”¨äº<strong>æ•°æ®ç«äº‰ä¸å½±å“ç¨‹åºæ­£ç¡®æ€§</strong>çš„åœºæ™¯ï¼Œå¦‚<strong>æ— ä¾èµ–çš„è®¡æ•°</strong>ï¼ˆç»Ÿè®¡çº¿ç¨‹æ•°ã€äº‹ä»¶è®¡æ•°ç­‰ï¼‰ã€‚</li></ul><p><strong>ç¤ºä¾‹</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>std<span style=color:#f92672>::</span>atomic<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>int</span><span style=color:#f92672>&gt;</span> counter{<span style=color:#ae81ff>0</span>};
</span></span><span style=display:flex><span>counter.fetch_add(<span style=color:#ae81ff>1</span>, std<span style=color:#f92672>::</span>memory_order_relaxed);  <span style=color:#75715e>// ä»…ä¿è¯åŸå­æ€§ï¼Œä¸ä¿è¯å¯è§æ€§
</span></span></span></code></pre></div><p>è¿™é‡Œï¼Œ<code>fetch_add</code>ç¡®ä¿<code>counter</code>è‡ªå¢æ“ä½œä¸ä¼šä¸¢å¤±ï¼Œä½†ä¸åŒçº¿ç¨‹çš„ä¿®æ”¹å¯èƒ½ä¼šè¢«å»¶è¿Ÿçœ‹åˆ°ã€‚</p><h4 id=memory_order_acquireè·å–é˜²æ­¢é‡æ’åºåˆ°å‰><code>memory_order_acquire</code>ï¼ˆè·å–ï¼Œé˜²æ­¢é‡æ’åºåˆ°å‰ï¼‰ <a href=#memory_order_acquire%e8%8e%b7%e5%8f%96%e9%98%b2%e6%ad%a2%e9%87%8d%e6%8e%92%e5%ba%8f%e5%88%b0%e5%89%8d class=anchor>ğŸ”—</a></h4><ul><li><strong>ç‰¹ç‚¹</strong>ï¼šä¿è¯<strong>å½“å‰çº¿ç¨‹</strong>åœ¨<code>acquire</code>ä¹‹åçš„æ‰€æœ‰æ“ä½œä¸ä¼šè¢«é‡æ’åºåˆ°<code>acquire</code>ä¹‹å‰ï¼Œå› æ­¤ï¼Œå…¶ä»–çº¿ç¨‹ä¸­ç›¸åŒåŸå­å˜é‡çš„é‡Šæ”¾æ“ä½œï¼ˆrelease operationï¼‰ä¹‹å‰çš„å†™å…¥å¯¹å½“å‰çº¿ç¨‹æ˜¯å¯è§çš„ã€‚</li><li><strong>é€‚ç”¨åœºæ™¯</strong>ï¼šç”¨äº<strong>è¯»å–</strong>å…±äº«æ•°æ®ï¼Œç¡®ä¿å½“å‰çº¿ç¨‹èƒ½å¤Ÿçœ‹åˆ°å…¶ä»–çº¿ç¨‹ä¹‹å‰å¯¹è¯¥å˜é‡çš„ä¿®æ”¹ã€‚</li></ul><h4 id=memory_order_releaseé‡Šæ”¾é˜²æ­¢é‡æ’åºåˆ°å><code>memory_order_release</code>ï¼ˆé‡Šæ”¾ï¼Œé˜²æ­¢é‡æ’åºåˆ°åï¼‰ <a href=#memory_order_release%e9%87%8a%e6%94%be%e9%98%b2%e6%ad%a2%e9%87%8d%e6%8e%92%e5%ba%8f%e5%88%b0%e5%90%8e class=anchor>ğŸ”—</a></h4><ul><li><strong>ç‰¹ç‚¹</strong>ï¼šç¡®ä¿<strong>å½“å‰çº¿ç¨‹</strong>åœ¨<code>release</code>ä¹‹å‰çš„æ‰€æœ‰æ“ä½œä¸ä¼šè¢«é‡æ’åºåˆ°<code>release</code>ä¹‹åï¼Œå› æ­¤ï¼Œå½“å‰æ“ä½œæ‰€åœ¨çº¿ç¨‹ä¹‹å‰çš„å†™å…¥ï¼Œåœ¨å…¶ä»–çº¿ç¨‹æ–½åŠ å æœ‰æ“ä½œï¼ˆacquire operationï¼‰ä¹‹åæ˜¯å¯è§çš„ã€‚</li><li><strong>é€‚ç”¨åœºæ™¯</strong>ï¼šç”¨äº<strong>å†™å…¥</strong>å…±äº«æ•°æ®ï¼Œç¡®ä¿å…¶ä»–çº¿ç¨‹èƒ½åœ¨<code>acquire</code>è¯»å–æ—¶çœ‹åˆ°ä¿®æ”¹ã€‚</li></ul><p><strong>ç¤ºä¾‹</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>std<span style=color:#f92672>::</span>atomic<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>int</span><span style=color:#f92672>&gt;</span> flag{<span style=color:#ae81ff>0</span>};
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> data <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>producer</span>() {
</span></span><span style=display:flex><span>  data <span style=color:#f92672>=</span> <span style=color:#ae81ff>42</span>;
</span></span><span style=display:flex><span>  flag.store(<span style=color:#ae81ff>1</span>, std<span style=color:#f92672>::</span>memory_order_release);  <span style=color:#75715e>// è®©æ¶ˆè´¹è€…å¯ä»¥çœ‹åˆ° data=42
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>consumer</span>() {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>while</span> (flag.load(std<span style=color:#f92672>::</span>memory_order_acquire) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>1</span>);  <span style=color:#75715e>// ç¡®ä¿ data=42 å¯è§
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  std<span style=color:#f92672>::</span>cout <span style=color:#f92672>&lt;&lt;</span> data <span style=color:#f92672>&lt;&lt;</span> std<span style=color:#f92672>::</span>endl;  <span style=color:#75715e>// ç¡®ä¿ data çš„ä¿®æ”¹å¯¹æœ¬çº¿ç¨‹å¯è§
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><ul><li><code>store(release)</code>ç¡®ä¿<code>data=42</code>å‘ç”Ÿåœ¨<code>flag=1</code>ä¹‹å‰ã€‚</li><li><code>load(acquire)</code>ç¡®ä¿<code>flag=1</code>ä¹‹åï¼Œ<code>data=42</code>å¯¹æ¶ˆè´¹è€…çº¿ç¨‹å¯è§ã€‚</li><li>é€šè¿‡<code>acquire-release</code>ï¼Œæ¶ˆè´¹è€…çº¿ç¨‹èƒ½å¤Ÿæ­£ç¡®çœ‹åˆ°ç”Ÿäº§è€…çº¿ç¨‹çš„<code>data</code>ä¿®æ”¹ã€‚</li></ul><h4 id=memory_order_acq_relè·å–-é‡Šæ”¾åŒå‘åŒæ­¥><code>memory_order_acq_rel</code>ï¼ˆè·å–-é‡Šæ”¾ï¼ŒåŒå‘åŒæ­¥ï¼‰ <a href=#memory_order_acq_rel%e8%8e%b7%e5%8f%96-%e9%87%8a%e6%94%be%e5%8f%8c%e5%90%91%e5%90%8c%e6%ad%a5 class=anchor>ğŸ”—</a></h4><ul><li><strong>ç‰¹ç‚¹</strong>ï¼šç»“åˆ<code>acquire</code>å’Œ<code>release</code>ï¼Œç”¨äº**è¯»-æ”¹-å†™ï¼ˆRead-Modify-Write, RMWï¼‰**æ“ä½œï¼Œç¡®ä¿ï¼š<ul><li>è¯»å–æ—¶ä½¿ç”¨<code>acquire</code>è¯­ä¹‰ï¼Œä¿è¯ä¹‹å‰çš„ä¿®æ”¹å¯¹å½“å‰çº¿ç¨‹å¯è§ã€‚</li><li>å†™å…¥æ—¶ä½¿ç”¨<code>release</code>è¯­ä¹‰ï¼Œä¿è¯å½“å‰ä¿®æ”¹å¯¹åç»­çº¿ç¨‹å¯è§ã€‚</li></ul></li><li><strong>é€‚ç”¨åœºæ™¯</strong>ï¼šç”¨äº<strong>è¯»-æ”¹-å†™</strong>ï¼ˆå¦‚<code>fetch_add()</code>ã€<code>exchange()</code>ï¼‰æ“ä½œï¼Œç¡®ä¿å¤šä¸ªçº¿ç¨‹èƒ½å¤Ÿæ­£ç¡®åè°ƒã€‚</li></ul><p><strong>ç¤ºä¾‹</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>std<span style=color:#f92672>::</span>atomic<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>int</span><span style=color:#f92672>&gt;</span> value{<span style=color:#ae81ff>0</span>};
</span></span><span style=display:flex><span>value.fetch_add(<span style=color:#ae81ff>1</span>, std<span style=color:#f92672>::</span>memory_order_acq_rel);  <span style=color:#75715e>// è¯»å†™éƒ½ä¿è¯å¯è§æ€§
</span></span></span></code></pre></div><p>åœ¨è¿™é‡Œï¼Œ<code>fetch_add</code>åŒæ—¶è¯»å–æ—§å€¼å¹¶å†™å…¥æ–°å€¼ï¼š</p><ul><li>è¯»å–æ—¶ä½¿ç”¨<code>acquire</code>è¯­ä¹‰ï¼Œç¡®ä¿å®ƒèƒ½çœ‹åˆ°å…¶ä»–çº¿ç¨‹çš„ä¿®æ”¹ã€‚</li><li>å†™å…¥æ—¶ä½¿ç”¨<code>release</code>è¯­ä¹‰ï¼Œç¡®ä¿å®ƒçš„ä¿®æ”¹èƒ½è¢«å…¶ä»–çº¿ç¨‹çœ‹åˆ°ã€‚</li></ul><h4 id=memory_order_seq_csté¡ºåºä¸€è‡´æ€§æœ€ä¸¥æ ¼><code>memory_order_seq_cst</code>ï¼ˆé¡ºåºä¸€è‡´æ€§ï¼Œæœ€ä¸¥æ ¼ï¼‰ <a href=#memory_order_seq_cst%e9%a1%ba%e5%ba%8f%e4%b8%80%e8%87%b4%e6%80%a7%e6%9c%80%e4%b8%a5%e6%a0%bc class=anchor>ğŸ”—</a></h4><ul><li><strong>ç‰¹ç‚¹</strong>ï¼šæ‰€æœ‰ä½¿ç”¨<code>memory_order_seq_cst</code>çš„åŸå­æ“ä½œåœ¨<strong>æ‰€æœ‰çº¿ç¨‹çœ‹æ¥</strong>éƒ½æ˜¯æŒ‰ç…§ç›¸åŒçš„é¡ºåºæ‰§è¡Œçš„ï¼Œå³å…¨å±€ä¸€è‡´çš„æ—¶åºã€‚</li><li><strong>é€‚ç”¨åœºæ™¯</strong>ï¼š<ul><li>éœ€è¦ä¸¥æ ¼åŒæ­¥çš„åœºæ™¯ï¼Œå¦‚<strong>é”</strong>ã€<strong>åŒæ­¥å˜é‡</strong>ã€<strong>ä¸´ç•ŒåŒºä¿æŠ¤</strong>ç­‰ã€‚</li><li>é€‚ç”¨äº<strong>å¤šçº¿ç¨‹äº¤äº’å¤æ‚</strong>ã€éš¾ä»¥ç®¡ç†ä¾èµ–å…³ç³»çš„æƒ…å†µã€‚</li></ul></li></ul><p><strong>ä¿è¯</strong>ï¼š</p><ul><li><code>seq_cst</code>ç¡®ä¿æ‰€æœ‰æ“ä½œä¸¥æ ¼æŒ‰ç…§å…¨å±€ç»Ÿä¸€é¡ºåºæ‰§è¡Œï¼Œé¿å…ä¹±åºé—®é¢˜ã€‚</li></ul><h3 id=ç›´è§‚æ¯”å–»>ç›´è§‚æ¯”å–» <a href=#%e7%9b%b4%e8%a7%82%e6%af%94%e5%96%bb class=anchor>ğŸ”—</a></h3><ul><li><code>relaxed</code>ï¼šéšæ„å†™ç¬”è®°ï¼Œä½†ä¸ä¿è¯åˆ«äººèƒ½çœ‹åˆ°ã€‚</li><li><code>acquire</code>ï¼š<strong>è¿›é—¨æ£€æŸ¥å…¬å‘Šæ </strong>ï¼Œç¡®ä¿çœ‹åˆ°ä¹‹å‰çš„é€šçŸ¥ã€‚</li><li><code>release</code>ï¼š<strong>ç¦»å¼€æ—¶æ›´æ–°å…¬å‘Šæ </strong>ï¼Œè®©åæ¥çš„äººçœ‹åˆ°ã€‚</li><li><code>acq_rel</code>ï¼š<strong>è¿›é—¨çœ‹å…¬å‘Š + èµ°å‰æ›´æ–°å…¬å‘Š</strong>ã€‚</li><li><code>seq_cst</code>ï¼š<strong>æ‰€æœ‰äººæŒ‰åŒæ ·é¡ºåºå†™ã€çœ‹å…¬å‘Š</strong>ï¼Œä¿è¯ä¸€è‡´æ€§ã€‚</li></ul><p>æ ¹æ®ä¸åŒåœºæ™¯åˆç†é€‰æ‹©å†…å­˜åºï¼Œå¯ä»¥æé«˜å¹¶å‘ç¨‹åºçš„æ­£ç¡®æ€§å’Œæ€§èƒ½ã€‚</p><h3 id=ä¼˜åŒ–æ§åˆ¶å—ä¸­çš„åŸå­å˜é‡>ä¼˜åŒ–æ§åˆ¶å—ä¸­çš„åŸå­å˜é‡ <a href=#%e4%bc%98%e5%8c%96%e6%8e%a7%e5%88%b6%e5%9d%97%e4%b8%ad%e7%9a%84%e5%8e%9f%e5%ad%90%e5%8f%98%e9%87%8f class=anchor>ğŸ”—</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;atomic&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>template</span> <span style=color:#f92672>&lt;</span><span style=color:#66d9ef>typename</span> T<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>control_block</span> {
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>    control_block(T<span style=color:#f92672>*</span> ptr)
</span></span><span style=display:flex><span>        <span style=color:#f92672>:</span> ref_count(<span style=color:#ae81ff>1</span>), weak_count(<span style=color:#ae81ff>1</span>), obj(ptr) {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// å¢åŠ å¼•ç”¨è®¡æ•°
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>add_ref</span>() {
</span></span><span style=display:flex><span>        ref_count.fetch_add(<span style=color:#ae81ff>1</span>, std<span style=color:#f92672>::</span>memory_order_relaxed);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// å°è¯•å¢åŠ å¼ºå¼•ç”¨è®¡æ•°ï¼ˆä»…å½“å¯¹è±¡ä»ç„¶å­˜æ´»æ—¶ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>bool</span> <span style=color:#a6e22e>lock</span>() { 
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> prev <span style=color:#f92672>=</span> ref_count.load(std<span style=color:#f92672>::</span>memory_order_acquire);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>while</span> (prev <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (ref_count.compare_exchange_weak(prev, prev <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, 
</span></span><span style=display:flex><span>                std<span style=color:#f92672>::</span>memory_order_acquire, std<span style=color:#f92672>::</span>memory_order_relaxed)) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> true; <span style=color:#75715e>// æˆåŠŸé”å®š
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> false; <span style=color:#75715e>// å¯¹è±¡å·²è¢«é‡Šæ”¾
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// é‡Šæ”¾å¼ºå¼•ç”¨
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>release_ref</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (ref_count.fetch_sub(<span style=color:#ae81ff>1</span>, std<span style=color:#f92672>::</span>memory_order_acq_rel) <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>delete</span> obj;  <span style=color:#75715e>// åˆ é™¤å¯¹è±¡
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            release_control_block(); <span style=color:#75715e>// å°è¯•åˆ é™¤æ§åˆ¶å—
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// å¢åŠ å¼±å¼•ç”¨è®¡æ•°
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>add_weak_ref</span>() {
</span></span><span style=display:flex><span>        weak_count.fetch_add(<span style=color:#ae81ff>1</span>, std<span style=color:#f92672>::</span>memory_order_relaxed);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// é‡Šæ”¾å¼±å¼•ç”¨è®¡æ•°
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>release_weak_ref</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (weak_count.fetch_sub(<span style=color:#ae81ff>1</span>, std<span style=color:#f92672>::</span>memory_order_acq_rel) <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>delete</span> <span style=color:#66d9ef>this</span>; <span style=color:#75715e>// åˆ é™¤æ§åˆ¶å—
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    T<span style=color:#f92672>*</span> <span style=color:#a6e22e>get</span>() { <span style=color:#66d9ef>return</span> obj; }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// åˆ é™¤æ§åˆ¶å—ï¼Œä»…å½“å¼±å¼•ç”¨è®¡æ•°ä¹Ÿå½’é›¶æ—¶
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>void</span> release_control_block() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (weak_count.fetch_sub(<span style=color:#ae81ff>1</span>, std<span style=color:#f92672>::</span>memory_order_acq_rel) <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>delete</span> <span style=color:#66d9ef>this</span>; <span style=color:#75715e>// åˆ é™¤æ§åˆ¶å—
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    std<span style=color:#f92672>::</span>atomic<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>int</span><span style=color:#f92672>&gt;</span> ref_count;    <span style=color:#75715e>// å¼ºå¼•ç”¨è®¡æ•°
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    std<span style=color:#f92672>::</span>atomic<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>int</span><span style=color:#f92672>&gt;</span> weak_count;   <span style=color:#75715e>// å¼±å¼•ç”¨è®¡æ•°
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    T<span style=color:#f92672>*</span> obj;                        <span style=color:#75715e>// å®é™…å¯¹è±¡
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>};
</span></span></code></pre></div><h2 id=å‚è€ƒ>å‚è€ƒ <a href=#%e5%8f%82%e8%80%83 class=anchor>ğŸ”—</a></h2><ul><li><a href=https://zhuanlan.zhihu.com/p/532215950>C++å†…å­˜ç®¡ç†ï¼šshared_ptr/weak_ptræºç </a></li><li><a href=https://www.cnblogs.com/Solstice/archive/2010/02/10/dtor_meets_threads.html>å½“ææ„å‡½æ•°é‡åˆ°å¤šçº¿ç¨‹ â”€â”€ C++ ä¸­çº¿ç¨‹å®‰å…¨çš„å¯¹è±¡å›è°ƒ</a></li><li><a href=https://liam.page/2021/12/11/memory-order-cpp-02/>ç¨‹åºå‘˜çš„è‡ªæˆ‘ä¿®å…»ï¼ˆâ‘«ï¼‰ï¼šC++ çš„å†…å­˜é¡ºåº</a></li></ul></div></section></div><div class=side><div class=side-recent><h2 class=side-title><a href=/posts/>Recent Posts</a></h2><hr><ul><li><a href=/posts/why-not-start-with-ddia-part-1/>ä¸ºä»€ä¹ˆæˆ‘ä¸å»ºè®®ä½ é˜…è¯»ã€Šæ•°æ®å¯†é›†å‹åº”ç”¨ç³»ç»Ÿè®¾è®¡ã€‹ï¼ˆä¹‹ä¸€ï¼‰</a></li><li><a href=/posts/vertical-axis-wind-turbine-3d-model/>é£åŠ›æ¶¡è½®æœº 3D æ¨¡å‹ / Vertical Axis Wind Turbine (VAWT) 3D Model</a></li><li><a href=/posts/press-pad-3d-model/>3Dæ‰“å°è§£å‹ç©å…· / 3D Printed Fidget Toy</a></li><li><a href=/posts/lava-store/>è®ºæ–‡é˜…è¯»ï¼šLavaStore - é«˜æ€§èƒ½ã€æœ¬åœ°å­˜å‚¨å¼•æ“çš„æ¼”è¿›</a></li><li><a href=/posts/std-smart-ptrs-cpp-for-the-antiquated-4/>åŠ¨æ‰‹å®ç°æ™ºèƒ½æŒ‡é’ˆ ï¼ˆä¸Šç¯‡ï¼‰ - C++ for the Antiquatedï¼ˆä¹‹å››ï¼‰</a></li></ul></div><div class=side-categories><h2>Categories</h2><hr><ul></ul></div><div class=side-tags><h2>Tags</h2><hr><ul><li><a href=/tags/.net>.net (1)</a></li><li><a href=/tags/3d-printing>3d printing (2)</a></li><li><a href=/tags/a2b>a2b (1)</a></li><li><a href=/tags/ahk>ahk (1)</a></li><li><a href=/tags/algorithm>algorithm (26)</a></li><li><a href=/tags/alloca>alloca (1)</a></li><li><a href=/tags/allocate>allocate (1)</a></li><li><a href=/tags/arduino>arduino (1)</a></li><li><a href=/tags/asm>asm (1)</a></li><li><a href=/tags/async>async (2)</a></li><li><a href=/tags/atcoder>atcoder (1)</a></li><li><a href=/tags/autohotkey>autohotkey (1)</a></li><li><a href=/tags/autopilot>autopilot (1)</a></li><li><a href=/tags/azure>azure (2)</a></li><li><a href=/tags/b-tree>b-tree (1)</a></li><li><a href=/tags/basic-paxos>basic paxos (2)</a></li><li><a href=/tags/bbr>bbr (1)</a></li><li><a href=/tags/binary-indexed-tree>binary indexed tree (1)</a></li><li><a href=/tags/binary-tree>binary tree (1)</a></li><li><a href=/tags/bittorrent>bittorrent (1)</a></li><li><a href=/tags/borg>borg (1)</a></li><li><a href=/tags/bw-tree>bw-tree (1)</a></li><li><a href=/tags/c>c# (1)</a></li><li><a href=/tags/c++>c++ (6)</a></li><li><a href=/tags/cache>cache (1)</a></li><li><a href=/tags/cachegrind>cachegrind (1)</a></li><li><a href=/tags/cap>cap (1)</a></li><li><a href=/tags/career>career (1)</a></li><li><a href=/tags/cas>cas (3)</a></li><li><a href=/tags/ceph>ceph (1)</a></li><li><a href=/tags/chrome-extension>chrome-extension (2)</a></li><li><a href=/tags/cmpxchg>cmpxchg (2)</a></li><li><a href=/tags/cocurrency>cocurrency (1)</a></li><li><a href=/tags/code-golf>code golf (1)</a></li><li><a href=/tags/codeforces>codeforces (14)</a></li><li><a href=/tags/compare-ans-swap>compare-ans-swap (1)</a></li><li><a href=/tags/computational-geometry>computational geometry (1)</a></li><li><a href=/tags/consistency>consistency (1)</a></li><li><a href=/tags/cpp>cpp (9)</a></li><li><a href=/tags/cpu>cpu (1)</a></li><li><a href=/tags/cse351>cse351 (2)</a></li><li><a href=/tags/csharp>csharp (1)</a></li><li><a href=/tags/css>css (1)</a></li><li><a href=/tags/data-center>data center (1)</a></li><li><a href=/tags/data-center-management>data center management (1)</a></li><li><a href=/tags/defer>defer (1)</a></li><li><a href=/tags/distributed-system>distributed system (4)</a></li><li><a href=/tags/epoll>epoll (1)</a></li><li><a href=/tags/ergodone>ergodone (1)</a></li><li><a href=/tags/fifo>fifo (1)</a></li><li><a href=/tags/flatbuffer>flatbuffer (2)</a></li><li><a href=/tags/fn-layer>fn-layer (1)</a></li><li><a href=/tags/front-end-development>front-end development (1)</a></li><li><a href=/tags/functional-programming>functional programming (1)</a></li><li><a href=/tags/game>game (1)</a></li><li><a href=/tags/gcj>gcj (1)</a></li><li><a href=/tags/geohash>geohash (1)</a></li><li><a href=/tags/geometric>geometric (1)</a></li><li><a href=/tags/geometry>geometry (1)</a></li><li><a href=/tags/get-things-done>get things done (1)</a></li><li><a href=/tags/google>google (3)</a></li><li><a href=/tags/graph>graph (1)</a></li><li><a href=/tags/head-first>head-first (1)</a></li><li><a href=/tags/heap>heap (1)</a></li><li><a href=/tags/herd7>herd7 (1)</a></li><li><a href=/tags/induction>induction (2)</a></li><li><a href=/tags/interview>interview (5)</a></li><li><a href=/tags/keyboard>keyboard (2)</a></li><li><a href=/tags/kubernetes>kubernetes (1)</a></li><li><a href=/tags/lavastore>lavastore (1)</a></li><li><a href=/tags/leetcode>leetcode (4)</a></li><li><a href=/tags/leveldb>leveldb (1)</a></li><li><a href=/tags/linkedin>linkedin (1)</a></li><li><a href=/tags/linux>linux (1)</a></li><li><a href=/tags/litmus>litmus (1)</a></li><li><a href=/tags/lock-less>lock-less (1)</a></li><li><a href=/tags/lsm-tree>lsm-tree (1)</a></li><li><a href=/tags/markdown>markdown (1)</a></li><li><a href=/tags/median>median (1)</a></li><li><a href=/tags/memory>memory (1)</a></li><li><a href=/tags/memory-barrier>memory-barrier (3)</a></li><li><a href=/tags/mesi>mesi (1)</a></li><li><a href=/tags/message-queue>message queue (1)</a></li><li><a href=/tags/metadata>metadata (1)</a></li><li><a href=/tags/metaprogramming>metaprogramming (1)</a></li><li><a href=/tags/microsoft>microsoft (2)</a></li><li><a href=/tags/misaka>misaka (1)</a></li><li><a href=/tags/modern-c++>modern c++ (1)</a></li><li><a href=/tags/modern-cpp>modern cpp (4)</a></li><li><a href=/tags/mosca>mosca (1)</a></li><li><a href=/tags/mq>mq (1)</a></li><li><a href=/tags/multi-paxos>multi paxos (1)</a></li><li><a href=/tags/multi-thread>multi-thread (3)</a></li><li><a href=/tags/multiprocess>multiprocess (1)</a></li><li><a href=/tags/multithread>multithread (3)</a></li><li><a href=/tags/network>network (1)</a></li><li><a href=/tags/networking>networking (4)</a></li><li><a href=/tags/non-blocking>non-blocking (1)</a></li><li><a href=/tags/normal-distribution>normal-distribution (1)</a></li><li><a href=/tags/ocaml>ocaml (1)</a></li><li><a href=/tags/ot>ot (1)</a></li><li><a href=/tags/parallel>parallel (1)</a></li><li><a href=/tags/partition>partition (1)</a></li><li><a href=/tags/paxos>paxos (2)</a></li><li><a href=/tags/pecifica>pecifica (1)</a></li><li><a href=/tags/pelican>pelican (1)</a></li><li><a href=/tags/phxrpc>phxrpc (8)</a></li><li><a href=/tags/pl>pl (1)</a></li><li><a href=/tags/poi>poi (1)</a></li><li><a href=/tags/poll>poll (1)</a></li><li><a href=/tags/powershell>powershell (1)</a></li><li><a href=/tags/priority-queue>priority queue (1)</a></li><li><a href=/tags/priority_queue>priority_queue (1)</a></li><li><a href=/tags/profile>profile (1)</a></li><li><a href=/tags/programming-interview>programming interview (1)</a></li><li><a href=/tags/promela>promela (2)</a></li><li><a href=/tags/protobuf>protobuf (1)</a></li><li><a href=/tags/protocol>protocol (4)</a></li><li><a href=/tags/python>python (3)</a></li><li><a href=/tags/quartile>quartile (1)</a></li><li><a href=/tags/queue>queue (2)</a></li><li><a href=/tags/quick-sort>quick sort (1)</a></li><li><a href=/tags/quora>quora (1)</a></li><li><a href=/tags/racket>racket (1)</a></li><li><a href=/tags/raft>raft (2)</a></li><li><a href=/tags/rocksdb>rocksdb (2)</a></li><li><a href=/tags/rpc>rpc (4)</a></li><li><a href=/tags/social-network>social network (1)</a></li><li><a href=/tags/socket>socket (1)</a></li><li><a href=/tags/solution>solution (2)</a></li><li><a href=/tags/sort>sort (1)</a></li><li><a href=/tags/spin>spin (4)</a></li><li><a href=/tags/spin/promela>spin/promela (2)</a></li><li><a href=/tags/stack>stack (2)</a></li><li><a href=/tags/stdfunction>std::function (1)</a></li><li><a href=/tags/stl>stl (1)</a></li><li><a href=/tags/storage>storage (3)</a></li><li><a href=/tags/storage-system>storage system (2)</a></li><li><a href=/tags/streambuf>streambuf (1)</a></li><li><a href=/tags/string>string (1)</a></li><li><a href=/tags/stup>stup (3)</a></li><li><a href=/tags/stylish>stylish (1)</a></li><li><a href=/tags/system>system (1)</a></li><li><a href=/tags/system-design>system design (5)</a></li><li><a href=/tags/tcp>tcp (4)</a></li><li><a href=/tags/tcpip>tcpip (1)</a></li><li><a href=/tags/thread>thread (3)</a></li><li><a href=/tags/tlv>tlv (1)</a></li><li><a href=/tags/twisted>twisted (1)</a></li><li><a href=/tags/ucontext>ucontext (2)</a></li><li><a href=/tags/udp>udp (3)</a></li><li><a href=/tags/useless>useless (1)</a></li><li><a href=/tags/userscript>userscript (1)</a></li><li><a href=/tags/valgrind>valgrind (1)</a></li><li><a href=/tags/wait-free>wait-free (1)</a></li><li><a href=/tags/was>was (1)</a></li><li><a href=/tags/wisckey>wisckey (1)</a></li><li><a href=/tags/workflowy>workflowy (1)</a></li><li><a href=/tags/wsl>wsl (1)</a></li><li><a href=/tags/yunfile>yunfile (1)</a></li><li><a href=/tags/zeromq>zeromq (1)</a></li><li><a href=/tags/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B>å¹¶å‘ç¼–ç¨‹ (1)</a></li><li><a href=/tags/%E7%B3%99%E5%BF%AB%E7%8C%9B>ç³™å¿«çŒ› (1)</a></li><li><a href=/tags/%E5%88%9B%E9%80%A0%E5%8A%9B>åˆ›é€ åŠ› (1)</a></li><li><a href=/tags/%E8%AF%BB%E4%B9%A6>è¯»ä¹¦ (2)</a></li><li><a href=/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B>å¤šçº¿ç¨‹ (2)</a></li><li><a href=/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F>åˆ†å¸ƒå¼ç³»ç»Ÿ (6)</a></li><li><a href=/tags/%E5%88%86%E7%B1%BB%E5%99%A8>åˆ†ç±»å™¨ (1)</a></li><li><a href=/tags/%E5%85%AC%E5%BC%80%E8%AF%BE>å…¬å¼€è¯¾ (4)</a></li><li><a href=/tags/%E8%AE%A1%E6%95%B0>è®¡æ•° (1)</a></li><li><a href=/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6>è®¡ç®—æœºç§‘å­¦ (1)</a></li><li><a href=/tags/%E9%93%BE%E8%A1%A8>é“¾è¡¨ (1)</a></li><li><a href=/tags/%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB>è®ºæ–‡é˜…è¯» (1)</a></li><li><a href=/tags/%E9%9D%A2%E8%AF%95>é¢è¯• (1)</a></li><li><a href=/tags/%E5%AE%B9%E6%96%A5%E5%8E%9F%E7%90%86>å®¹æ–¥åŸç† (1)</a></li><li><a href=/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F>è®¾è®¡æ¨¡å¼ (2)</a></li><li><a href=/tags/%E6%95%B0%E6%8D%AE%E7%BC%96%E7%A0%81>æ•°æ®ç¼–ç  (1)</a></li><li><a href=/tags/%E6%95%B0%E6%8D%AE%E5%BA%93>æ•°æ®åº“ (4)</a></li><li><a href=/tags/%E6%95%B0%E6%8D%AE%E5%AF%86%E9%9B%86%E5%9E%8B%E5%BA%94%E7%94%A8%E7%B3%BB%E7%BB%9F>æ•°æ®å¯†é›†å‹åº”ç”¨ç³»ç»Ÿ (1)</a></li><li><a href=/tags/%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B>æ•°æ®æ¨¡å‹ (1)</a></li><li><a href=/tags/%E6%95%B0%E6%8D%AE%E7%B3%BB%E7%BB%9F>æ•°æ®ç³»ç»Ÿ (1)</a></li><li><a href=/tags/%E6%80%9D%E7%BB%B4>æ€ç»´ (1)</a></li><li><a href=/tags/%E7%AE%97%E6%B3%95>ç®—æ³• (14)</a></li><li><a href=/tags/%E7%B4%A2%E5%BC%95>ç´¢å¼• (1)</a></li><li><a href=/tags/%E7%B4%A2%E5%BC%95%E7%BB%93%E6%9E%84>ç´¢å¼•ç»“æ„ (1)</a></li><li><a href=/tags/%E9%A2%98%E8%A7%A3>é¢˜è§£ (11)</a></li><li><a href=/tags/%E9%97%B2%E8%81%8A>é—²èŠ (3)</a></li><li><a href=/tags/%E5%8D%8F%E7%A8%8B>åç¨‹ (1)</a></li><li><a href=/tags/%E5%8E%8B%E7%BC%A9>å‹ç¼© (1)</a></li><li><a href=/tags/%E4%B8%80%E8%87%B4%E6%80%A7>ä¸€è‡´æ€§ (3)</a></li><li><a href=/tags/%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6>ä¸»ä»å¤åˆ¶ (1)</a></li><li><a href=/tags/%E5%AD%97%E7%AC%A6%E4%B8%B2>å­—ç¬¦ä¸² (1)</a></li><li><a href=/tags/%E6%9C%80%E5%B0%8F%E8%A1%A8%E7%A4%BA%E6%B3%95>æœ€å°è¡¨ç¤ºæ³• (1)</a></li></ul></div></div></main><footer class=footer><div class=footer-row><a class=footer-item href=https://wizmann.top/posts/index.xml>Feed of Posts
<i class=icofont-rss></i></a></div></footer></body></html>