<!doctype html><html><head><script>window.MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"],["\\[","\\]"]]},svg:{fontCache:"global"}}</script><script defer src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script></head><body><header class=header-wrapper><div class=header><a class=site-title href=https://wizmann.top/>Maerlyn's Rainbow</a><nav class=menu></nav></div></header><main class=main-wrapper><div class=main><section class=single><h1 class=title>è‡ªå®šä¹‰ä½ çš„stream buffer - phxrpcé˜…è¯»ç¬”è®°(1)</h1><div class=tip><time datetime="2016-09-28 22:35:55 +0000 UTC">2016/09/28</time>
<span class=split>Â·</span>
<span>6347 words </span><span class=split>Â·</span>
<span>13 minutes to read</span></div><div class=taxonomies><div>Tags:
<a href=/tags/system-design>System Design</a>
<a href=/tags/rpc>RPC</a>
<a href=/tags/streambuf>streambuf</a>
<a href=/tags/c++>C++</a>
<a href=/tags/phxrpc>phxrpc</a></div></div><hr><div class=content><h2 id=å†™åœ¨å‰é¢>å†™åœ¨å‰é¢ <a href=#%e5%86%99%e5%9c%a8%e5%89%8d%e9%9d%a2 class=anchor>ğŸ”—</a></h2><p><a href=https://github.com/tencent-wechat/phxrpc>phxrpc</a>æ˜¯å¾®ä¿¡å›¢é˜Ÿå¼€æºçš„ä¸€ä¸ªè½»é‡çº§RPCæ¡†æ¶ã€‚</p><p>æˆ‘å¯¹RPCè¿™äº›ä¸œè¥¿äº†è§£ä¸å¤šï¼Œçœ‹åˆ°phxrpcçš„ä»£ç ç›¸å¯¹ç®€å•ï¼Œè€Œä¸”è¿˜åœ¨åˆæ­¥å¼€å‘é˜¶æ®µï¼ˆåœ¨æœ¬æ–‡å†™ä½œæ—¶ï¼Œç‰ˆæœ¬å·æ˜¯0.8ï¼‰ã€‚æ‰€ä»¥æƒ³è¯»ä¸€è¯»ï¼Œæé«˜ä¸€ä¸‹å§¿åŠ¿æ°´å¹³ã€‚</p><p>å°±æ˜¯è¿™æ ·ã€‚</p><h2 id=è‡ªå®šä¹‰stream-buffer>è‡ªå®šä¹‰stream buffer <a href=#%e8%87%aa%e5%ae%9a%e4%b9%89stream-buffer class=anchor>ğŸ”—</a></h2><p><code>network/socket_stream_base.[h|cpp]</code>ä¸­çš„<code>class BaseTcpStreamBuf</code>ç»§æ‰¿äº†<code>std::streambuf</code>ï¼Œè‡ªå®šä¹‰äº†ä¸€ä¸ªæµç¼“å†²åŒºï¼Œç”¨äºæ¥æ”¶/å‘é€TCPæ•°æ®åŒ…ã€‚</p><p>è¿™ä¸ªç”¨æ³•æ¯”è¾ƒæ–°é¢–ï¼ˆæˆ–è€…æ˜¯æˆ‘è§è¯†å°‘ï¼‰ï¼Œç½‘ä¸Šçš„èµ„æ–™ä¹Ÿä¸å¤šã€‚è¿™é‡Œç¿»è¯‘ä¸€ç¯‡<a href=http://www.mr-edd.co.uk/blog/beginners_guide_streambuf>ä»‹ç»æ–‡ç« </a>ï¼Œå­¦ä¹ ä¸€ä¸‹æ–°å§¿åŠ¿ã€‚</p><h2 id=a-beginners-guide-to-writing-a-custom-stream-buffer>A beginner&rsquo;s guide to writing a custom stream buffer <a href=#a-beginners-guide-to-writing-a-custom-stream-buffer class=anchor>ğŸ”—</a></h2><p>æµ(streams)æ˜¯STLä¸­æä¾›çš„ä¸€ä¸ªé‡è¦çš„æŠ½è±¡æ¦‚å¿µã€‚è‘—åçš„â€œHello worldâ€ç¨‹åºï¼Œä¾¿æ˜¯ä½¿ç”¨äº†std::coutå°†å­—ç¬¦ä¸²å†™å…¥æ ‡å‡†è¾“å‡ºæµ(stdout)ã€‚</p><p>æµå½“ç„¶å¯ä»¥åšæ¯”cin/coutæ›´æœ‰æ„æ€çš„äº‹ã€‚è¿™ç¯‡æ–‡ç« æˆ‘ä»¬ä¼šç ”ç©¶å¦‚ä½•æ‰©å±•C++æµï¼Œæ¥å®ç°è‡ªå®šä¹‰çš„æµç¼“å†²åŒº(stream buffer)ã€‚p.s. å»ºè®®æœ¬æ–‡çš„è¯»è€…è‡³å°‘è¦æœ‰åŸºç¡€çš„C++çŸ¥è¯†ã€‚</p><p>C++æ ‡å‡†åº“ä¸ºç£ç›˜æ–‡ä»¶æ“ä½œæä¾›äº†åŸºç¡€çš„æ¥å£ï¼Œå¦‚<code>std::fstream</code>ï¼Œ<code>std::ifstream</code>å’Œ<code>std::ofstream</code>ã€‚æˆ‘ä»¬è¿˜æœ‰<code>stringstream</code>ï¼Œå¯ä»¥åƒæµä¸€æ ·æ“ä½œå­—ç¬¦ä¸²ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>std<span style=color:#f92672>::</span>ostringstream oss;
</span></span><span style=display:flex><span>oss <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#34;Hello, world!</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>n&#34;</span>;
</span></span><span style=display:flex><span>oss <span style=color:#f92672>&lt;&lt;</span> <span style=color:#ae81ff>123</span> <span style=color:#f92672>&lt;&lt;</span> <span style=color:#960050;background-color:#1e0010>&#39;\\</span>n<span style=color:#960050;background-color:#1e0010>&#39;</span>;
</span></span><span style=display:flex><span>std<span style=color:#f92672>::</span>string s <span style=color:#f92672>=</span> oss.str();
</span></span></code></pre></div><p>ç›¸ä¼¼çš„ï¼Œæˆ‘ä»¬å¯ä»¥ä»<code>std::istringstream</code>ä¸­ä½¿ç”¨<code>>></code>æ“ä½œç¬¦è¯»å–æ•°æ®ã€‚</p><p>Booståº“ä¸­çš„<code>lexical_cast</code>æ­£æ˜¯ä½¿ç”¨äº†è¿™ç§æœºåˆ¶ï¼Œè®©ç”¨æˆ·å¯ä»¥ä½¿ç”¨ç»Ÿä¸€çš„æ–¹å¼å°†ä¸€ä¸ªå¯¹è±¡(object)è½¬æ¢ä¸ºå­—ç¬¦ä¸²è¡¨ç¤ºã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>using</span> boost<span style=color:#f92672>::</span>lexical_cast;
</span></span><span style=display:flex><span><span style=color:#66d9ef>using</span> std<span style=color:#f92672>::</span>string;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> x <span style=color:#f92672>=</span> <span style=color:#ae81ff>5</span>;
</span></span><span style=display:flex><span>string s <span style=color:#f92672>=</span> lexical_cast<span style=color:#f92672>&lt;</span>string<span style=color:#f92672>&gt;</span>(x);
</span></span><span style=display:flex><span>assert(s <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;5&#34;</span>);
</span></span></code></pre></div><p>æµç¼“å†²åŒºæœ‰ç€å¾ˆå¼ºçš„çµæ´»æ€§ï¼Œå¯ä»¥æ»¡è¶³ä¸åŒçš„â€œç¼“å†²å¹¶ä¼ è¾“å­—ç¬¦ï¼ˆä¸²ï¼‰â€éœ€æ±‚ï¼Œæ¯”å¦‚æ–‡ä»¶æ“ä½œã€å­—ç¬¦ä¸²æ“ä½œã€å‘½ä»¤è¡Œ(Console)æ“ä½œç­‰ã€‚æˆ‘ä»¬å¯ä»¥ä»ç½‘ç»œã€é—ªå­˜(Flash memory)ç­‰ä¸åŒè®¾å¤‡ï¼Œä½¿ç”¨åŒæ ·çš„æ¥å£è·å–æµå¼å­—ç¬¦ä¸²ã€‚â€œæµç¼“å†²åŒºâ€ä¸â€œæµâ€æ˜¯æ­£äº¤çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥è‡ªç”±çš„äº¤æ¢ã€æ›´æ”¹(swap and change)æµæ‰€ä½¿ç”¨çš„ç¼“å†²åŒºï¼Œæˆ–è€…å°†å…¶é‡å®šå‘åˆ°å…¶å®ƒåœ°æ–¹ã€‚æˆ‘è®¤ä¸ºC++ä¸­çš„æµï¼Œæ­£æ˜¯â€œç­–ç•¥æ¨¡å¼â€(strategy design pattern)çš„ä¸€ä¸ªè‰¯å¥½èŒƒä¾‹ã€‚</p><p>æ¯”å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥é‡å®šå‘æ ‡å‡†æ—¥å¿—æµ<code>std::clog</code>åˆ°ä¸€ä¸ªå­—ç¬¦ä¸²æµï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;iostream&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;iomanip&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;string&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;sstream&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    std<span style=color:#f92672>::</span>ostringstream oss;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Make clog use the buffer from oss
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    std<span style=color:#f92672>::</span>streambuf <span style=color:#f92672>*</span>former_buff <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>        std<span style=color:#f92672>::</span>clog.rdbuf(oss.rdbuf());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    std<span style=color:#f92672>::</span>clog <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#34;This will appear in oss!&#34;</span> <span style=color:#f92672>&lt;&lt;</span> std<span style=color:#f92672>::</span>flush;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    std<span style=color:#f92672>::</span>cout <span style=color:#f92672>&lt;&lt;</span> oss.str() <span style=color:#f92672>&lt;&lt;</span> <span style=color:#960050;background-color:#1e0010>&#39;\\</span>n<span style=color:#960050;background-color:#1e0010>&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Give clog back its previous buffer
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    std<span style=color:#f92672>::</span>clog.rdbuf(former_buff);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>ä¸è¿‡ï¼Œè‡ªå®šä¹‰ä¸€ä¸ªæµç¼“å†²åŒºå´æ˜¯æœ‰ä¸€ç‚¹trickyï¼Œæˆ–è€…è¯´æœ‰ä¸€ç‚¹å“äººï¼Œå°¤å…¶æ˜¯å½“ä½ ç¬¬ä¸€æ¬¡å°è¯•çš„æ—¶å€™ã€‚æ‰€ä»¥æœ¬æ–‡æ„åœ¨æä¾›ä¸€äº›æµç¼“å†²çš„å®ç°èŒƒä¾‹ã€‚</p><p>é¦–å…ˆæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹æµç¼“å†²åŒºçš„ä¸€äº›åŸºæœ¬æ¦‚å¿µã€‚æ‰€æœ‰çš„æµç¼“å†²åŒºç»§æ‰¿è‡ª<code>std::streambuf</code>ï¼Œå¹¶ä¸”éœ€è¦è¦†ç›–ä¸€äº›è™šå‡½æ•°æ¥å®ç°è‡ªå®šä¹‰åŠŸèƒ½ã€‚<code>std::streambuf</code>æ˜¯â€œé¡ºåºè¯»å–è®¾å¤‡â€çš„ä¸€ä¸ªæŠ½è±¡ï¼Œå³æˆ‘ä»¬å¯ä»¥ä»ä¸­é¡ºåºçš„è¯»å–å­—ç¬¦åºåˆ—ã€‚åœ¨ç‰¹å®šçš„åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥é‡å¡«(re-fill)ã€å†²æ´—(flush)ä»¥åŠæ¸…ç©º(empty)ä¸€ä¸ªç¼“å†²åŒºã€‚</p><p>å½“æˆ‘ä»¬å‘ä¸€ä¸ª<code>ostream</code>ä¸­æ’å…¥æ•°æ®æ—¶ï¼Œæ•°æ®å°†ä¼šè¢«å†™å…¥ç¼“å†²åŒºä¸­çš„ä¸€ä¸ªæ•°ç»„ã€‚å½“æ•°ç»„ä¸Šæº¢(overflow)æ—¶ï¼Œæ•°ç»„ä¸­çš„æ•°æ®å°†ä¼šè¢«å†²æ´—(flush)åˆ°ç›®æ ‡æ¥å—è€…ï¼Œä¹‹åè¿™ä¸ªæ•°ç»„çš„çŠ¶æ€å°†ä¼šé‡ç½®ï¼Œä»¥ä¾¿å­˜å‚¨åç»­çš„å­—ç¬¦ã€‚</p><p>å½“æˆ‘ä»¬ä»ä¸€ä¸ª<code>istream</code>ä¸­è·å–æ•°æ®æ—¶ï¼Œæ•°æ®ä»ç¼“å†²åŒºçš„æ•°ç»„ä¸­è¯»å‡ºã€‚å½“æ•°ç»„ä¸‹æº¢æ—¶(underflow)ï¼Œæ²¡æœ‰æ•°æ®å¯è¯»ï¼Œæˆ‘ä»¬ä¼šä»æ•°æ®æºé‡æ–°æ‹‰å–ä¿¡æ¯æ¥å¡«å……ç¼“å†²åŒºï¼Œä¹‹åè¿™ä¸ªæ•°ç»„çš„çŠ¶æ€ä¹Ÿå°†è¢«é‡ç½®ã€‚</p><p>æˆ‘ä»¬ä½¿ç”¨6ä¸ªæŒ‡é’ˆï¼Œæ¥ç»´æŠ¤ç¼“å†²åŒºçš„å†…éƒ¨çŠ¶æ€ã€‚è¾“å…¥å’Œè¾“å‡ºç¼“å†²å„ä½¿ç”¨3ä¸ªæŒ‡é’ˆã€‚</p><h3 id=ç»´æŠ¤è¾“å‡ºç¼“å†²åŒºçš„çŠ¶æ€>ç»´æŠ¤è¾“å‡ºç¼“å†²åŒºçš„çŠ¶æ€ <a href=#%e7%bb%b4%e6%8a%a4%e8%be%93%e5%87%ba%e7%bc%93%e5%86%b2%e5%8c%ba%e7%9a%84%e7%8a%b6%e6%80%81 class=anchor>ğŸ”—</a></h3><ul><li><p>put base pointer<br>è¾“å‡ºåŸºæŒ‡é’ˆï¼Œç”¨æ¥æŒ‡å®šç¼“å†²åŒºå†…éƒ¨æ•°ç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´ ã€‚å¯ä»¥ä½¿ç”¨<code>std::streambuf::pbase()</code>æ¥è·å–</p></li><li><p>put pointer<br>è¾“å‡ºæŒ‡é’ˆï¼Œç”¨æ¥æŒ‡å‘å†…éƒ¨æ•°ç»„ä¸‹ä¸€ä¸ªå†™å…¥çš„åœ°å€ã€‚å¯ä»¥ä½¿ç”¨<code>std::streambuf::pptr()</code>æ¥è·å–</p></li><li><p>end put pointer<br>è¾“å‡ºå“¨å…µæŒ‡é’ˆï¼ŒæŒ‡å‘å†…éƒ¨æ•°ç»„æœ€åä¸€ä¸ªå†åé¢ä¸€ä¸ª(one-past-the-last-element)çš„åœ°å€ï¼ˆè¯‘æ³¨ï¼šç±»ä¼¼<code>std::vector::end()</code>ï¼‰ã€‚å¯ä»¥ä½¿ç”¨<code>std::streambuf:epptr()</code>æ¥è·å–</p></li></ul><p><img src=http://i1.piimg.com/567571/630a89fe635e1635.png alt></p><p>ä¸€èˆ¬æ¥è¯´ï¼ŒåŸºæŒ‡é’ˆå’Œå“¨å…µæŒ‡é’ˆä¸ä¼šæ”¹å˜ï¼Œåœ¨ä½¿ç”¨æ—¶ï¼Œä»¥è¾“å‡ºæŒ‡é’ˆç»´æŠ¤å†…éƒ¨çŠ¶æ€ã€‚</p><h3 id=ç»´æŠ¤è¾“å…¥ç¼“å†²åŒºçš„çŠ¶æ€>ç»´æŠ¤è¾“å…¥ç¼“å†²åŒºçš„çŠ¶æ€ <a href=#%e7%bb%b4%e6%8a%a4%e8%be%93%e5%85%a5%e7%bc%93%e5%86%b2%e5%8c%ba%e7%9a%84%e7%8a%b6%e6%80%81 class=anchor>ğŸ”—</a></h3><p>è¾“å…¥ç¼“å†²åŒºå’ŒçŠ¶æ€ç»´æŠ¤å’Œè¾“å‡ºç¼“å†²åŒºç±»ä¼¼ï¼Œæˆ‘ä»¬æœ‰ï¼š</p><ul><li>end back pointer<br>è¾“å…¥åŸºæŒ‡é’ˆï¼ŒæŒ‡å‘ç¼“å†²åŒºæ•°ç»„å†…çš„æœ€åä¸€ä¸ªå­—ç¬¦ã€‚å¯ä»¥ä½¿ç”¨<code>std::streambuf::eback()</code>æ¥è·å–</li><li>get pointer<br>è¾“å…¥æŒ‡é’ˆï¼ŒæŒ‡å‘ç¼“å†²åŒºä¸‹ä¸€ä¸ªè¯»å–çš„å­—ç¬¦åœ°å€ã€‚å¯ä»¥ä½¿ç”¨<code>std::streambuf::gptr()</code>æ¥è·å–</li><li>end get pointer<br>è¾“å…¥å“¨å…µæŒ‡é’ˆï¼Œæ‰¹å·å‘å†…éƒ¨æ•°ç»„æœ€åä¸€ä¸ªå†åé¢ä¸€ä¸ª(one-past-the-last-element)çš„åœ°å€ã€‚å¯ä»¥ä½¿ç”¨<code>std::streambuf::egptr()</code>æ¥è·å–</li></ul><p><img src=https://github.com/Wizmann/assets/raw/master/wizmann-pic/16-9-27/33500590.jpg alt></p><p>åŒæ ·ï¼ŒåŸºæŒ‡é’ˆå’Œå“¨å…µæŒ‡é’ˆåœ¨æµç¼“å†²åŒºçš„ç”Ÿå‘½å‘¨æœŸä¸­ä¹Ÿä¸ä¼šæ”¹å˜ã€‚</p><p>ç”±äºè¾“å…¥ç¼“å†²åŒºè¦æ”¯æŒ<code>putback()</code>æ“ä½œï¼Œå³å°†è¯»å‡ºçš„å­—ç¬¦é‡æ–°æ”¾å›ç¼“å†²åŒºï¼Œæ‰€ä»¥è¾“å…¥ç¼“å†²åŒºæ¯”è¾“å‡ºç¼“å†²åŒºæ›´å¤æ‚ä¸€ç‚¹ã€‚é€šå¸¸æ¥è¯´ï¼Œ<code>putback()</code>æ“ä½œæ”¯æŒæ”¾å›ä¸€ä¸ªå­—ç¬¦å³å¯ã€‚</p><p>ä¸€ä¸ª<code>std::streambuf</code>å¯ä»¥åŒæ—¶æ”¯æŒè¾“å…¥è¾“å‡ºä¸¤ç§æ“ä½œï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸éœ€è¦æˆ‘åˆ†åˆ«å®ç°<code>std::istreambuf</code>å’Œ<code>std::ostreambuf</code>ã€‚<code>std::fstream</code>æ˜¯ä¸€ä¸ªè‰¯å¥½çš„ä¾‹å­ã€‚ä½†æ˜¯ï¼Œå®ç°ä¸€ä¸ªå…¨åŠŸèƒ½çš„ç¼“å†²åŒºç›¸å¯¹æ›´å¤æ‚ä¸€äº›ï¼Œæ‰€ä»¥æˆ‘å°±ä¸è¶Ÿæµ‘æ°´å•¦~ ï¼šï¼‰</p><p>åŒæ—¶ï¼Œæµç¼“å†²åŒºä¹Ÿå¯ä»¥æ”¯æŒå®½å­—ç¬¦(wide character)ã€‚<code>std::streambuf</code>æ˜¯<code>std::basic_streambuf&lt;char></code>çš„åˆ«åï¼Œå¦‚æœä½ éœ€è¦å®½å­—ç¬¦æµç¼“å†²åŒºï¼Œå¯ä»¥ä½¿ç”¨<code>std::basic_streambuf&lt;wchar_t></code>ã€‚</p><h3 id=ä¾‹1æ–‡ä»¶ç¼“å†²åŒº--ä¸cä»£ç é›†æˆ>ä¾‹1ï¼šæ–‡ä»¶ç¼“å†²åŒº â€”â€” ä¸Cä»£ç é›†æˆ <a href=#%e4%be%8b1%e6%96%87%e4%bb%b6%e7%bc%93%e5%86%b2%e5%8c%ba--%e4%b8%8ec%e4%bb%a3%e7%a0%81%e9%9b%86%e6%88%90 class=anchor>ğŸ”—</a></h3><p>å‡è®¾æˆ‘ä»¬éœ€è¦è°ƒç”¨ä¸€ä¸ªå†å²æ‚ ä¹…çš„åº“ï¼Œä¸€ä¸ªæ–‡ä»¶æ“ä½œå‡½æ•°ä¼šè¿”å›ç»™ä¸€ä¸ª<code>FILE*</code>æŒ‡é’ˆï¼Œä½†æ˜¯æˆ‘ä»¬æƒ³ç”¨C++çš„æµæ¥å£æ¥è¯»å†™æ•°æ®ã€‚æˆ‘ä»¬å…ˆä»è¯»æ–‡ä»¶å¼€å§‹ï¼Œç”¨<code>std::istream</code>åŒ…è£…<code>FILE*</code>çš„è¯»æ“ä½œã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;streambuf&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;vector&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;cstdlib&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;cstdio&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>FILE_buffer</span> <span style=color:#f92672>:</span> <span style=color:#66d9ef>public</span> std<span style=color:#f92672>::</span>streambuf
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>explicit</span> FILE_buffer(FILE <span style=color:#f92672>*</span>fptr, std<span style=color:#f92672>::</span>size_t buff_sz <span style=color:#f92672>=</span> <span style=color:#ae81ff>256</span>, std<span style=color:#f92672>::</span>size_t put_back <span style=color:#f92672>=</span> <span style=color:#ae81ff>8</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// overrides base class underflow()
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        int_type underflow();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// copy ctor and assignment not implemented;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// copying not allowed
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        FILE_buffer(<span style=color:#66d9ef>const</span> FILE_buffer <span style=color:#f92672>&amp;</span>);
</span></span><span style=display:flex><span>        FILE_buffer <span style=color:#f92672>&amp;</span><span style=color:#66d9ef>operator</span><span style=color:#f92672>=</span> (<span style=color:#66d9ef>const</span> FILE_buffer <span style=color:#f92672>&amp;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>        FILE <span style=color:#f92672>*</span>fptr_;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> std<span style=color:#f92672>::</span>size_t put_back_;
</span></span><span style=display:flex><span>        std<span style=color:#f92672>::</span>vector<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>char</span><span style=color:#f92672>&gt;</span> buffer_;
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>ç”±äºåŠŸèƒ½ç®€å•ï¼Œæˆ‘ä»¬åªéœ€è¦å®ç°æ„é€ å‡½æ•°ä»¥åŠ<code>underflow</code>æ¥å£å°±å¯ä»¥å®ç°æˆ‘ä»¬çš„åŠŸèƒ½ã€‚</p><p>æ„é€ å‡½æ•°æŒ‡å®šäº†è¯»å–æ–‡ä»¶çš„<code>FILE*</code>æŒ‡é’ˆï¼Œä»¥åŠå†…éƒ¨ç¼“å†²æ•°ç»„çš„å¤§å°ã€‚æ•°ç»„å¤§å°ç”±ä¸¤ä¸ªå‚æ•°å†³å®šï¼š</p><ul><li>put-back area size</li><li>buffer size</li></ul><p>æˆ‘ä»¬ä½¿ç”¨<code>std::vector&lt;char></code>åšä¸ºç¼“å†²åŒºåŸŸã€‚<code>put_back_</code>å˜é‡ç”¨äºå­˜å‚¨"put-back"åŒºåŸŸçš„å¤§å°ã€‚</p><p>ä»¥ä¸‹æ˜¯æ„é€ å‡½æ•°çš„å®ç°ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>using</span> std<span style=color:#f92672>::</span>size_t;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>FILE_buffer<span style=color:#f92672>::</span>FILE_buffer(FILE <span style=color:#f92672>*</span>fptr, size_t buff_sz, size_t put_back) <span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>    fptr_(fptr),
</span></span><span style=display:flex><span>    put_back_(std<span style=color:#f92672>::</span>max(put_back, size_t(<span style=color:#ae81ff>1</span>))),
</span></span><span style=display:flex><span>    buffer_(std<span style=color:#f92672>::</span>max(buff_sz, put_back_) <span style=color:#f92672>+</span> put_back_)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>end <span style=color:#f92672>=</span> <span style=color:#f92672>&amp;</span>buffer_.front() <span style=color:#f92672>+</span> buffer_.size();
</span></span><span style=display:flex><span>    setg(end, end, end);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>åœ¨åˆå§‹åŒ–åˆ—è¡¨ä¸­ï¼Œæˆ‘ä»¬å°†ç¼“å†²åŒºçš„å¸¸é‡è¿›è¡Œèµ‹å€¼ã€‚ä¹‹åä½¿ç”¨<code>std::streambuf::setg()</code>æ¥åˆå§‹åŒ–è¾“å‡ºç¼“å†²åŒºã€‚</p><p><code>setg()</code>çš„ä¸‰ä¸ªå‚æ•°åˆ†åˆ«ä»£è¡¨<code>eback()</code>ï¼Œ<code>gptr()</code>ï¼Œ<code>egptr()</code>ä¸‰ä¸ªå†…éƒ¨æŒ‡é’ˆçš„å€¼ã€‚ä¸€å¼€å§‹ï¼Œæˆ‘ä»¬å°†å®ƒä»¬éƒ½æŒ‡å‘åŒä¸€ä¸ªåœ°å€ã€‚è¡¨æ˜bufferæ˜¯ç©ºçš„ï¼Œåœ¨ä¸‹ä¸€æ¬¡è¯»å–æ—¶ï¼Œä¼šé‡æ–°å¡«å……ç¼“å†²åŒºã€‚</p><p><code>underflow()</code>ä¼šè¿”å›æ•°æ®æºä¸­å½“å‰çš„å­—ç¬¦ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œä¼šè¿”å›bufferä¸­çš„ä¸‹ä¸€ä¸ªå¯ç”¨å­—ç¬¦ã€‚ç„¶åå½“bufferä¸ºç©ºæ—¶ï¼Œ<code>underflow()</code>åº”è¯¥é‡æ–°å¡«å……ç¼“å†²åŒºæ•°ç»„ï¼Œåœ¨æœ¬ä¾‹ä¸­ï¼Œå³ä»<code>FILE*</code>ä¸­è¯»å–å­—ç¬¦ã€‚å½“ç¼“å†²åŒºé‡å¡«åï¼Œæˆ‘ä»¬éœ€è¦å†æ¬¡è°ƒç”¨<code>setg()</code>æ›´æ–°æµç¼“å†²åŒºçš„çŠ¶æ€ã€‚</p><p>å½“æ•°æ®æºä¸­çš„æ•°æ®è¯»å®Œ(depleted)åï¼Œ<code>underflow()</code>ä¼šè¿”å›ä¸€ä¸ª<code>traits_type::eof()</code>ã€‚è¿™é‡Œè¦æ³¨æ„ï¼Œ<code>underflow()</code>çš„è¿”å›å€¼æ˜¯<code>int_type</code>ï¼Œè¿™ä¸ªå€¼è¶³å¤Ÿè£…ä¸‹<code>eof()</code>ï¼ŒåŒæ—¶ä¹Ÿè¶³å¤Ÿè£…ä¸‹ä»»ä½•çš„å­—ç¬¦ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>std<span style=color:#f92672>::</span>streambuf<span style=color:#f92672>::</span>int_type FILE_buffer<span style=color:#f92672>::</span>underflow()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (gptr() <span style=color:#f92672>&lt;</span> egptr()) <span style=color:#75715e>// buffer not exhausted
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>return</span> traits_type<span style=color:#f92672>::</span>to_int_type(<span style=color:#f92672>*</span>gptr());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>base <span style=color:#f92672>=</span> <span style=color:#f92672>&amp;</span>buffer_.front();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>start <span style=color:#f92672>=</span> base;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (eback() <span style=color:#f92672>==</span> base) <span style=color:#75715e>// true when this isn&#39;t the first fill
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Make arrangements for putback characters
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        std<span style=color:#f92672>::</span>memmove(base, egptr() <span style=color:#f92672>-</span> put_back_, put_back_);
</span></span><span style=display:flex><span>        start <span style=color:#f92672>+=</span> put_back_;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// start is now the start of the buffer, proper.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// Read from fptr_ in to the provided buffer
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    size_t n <span style=color:#f92672>=</span> std<span style=color:#f92672>::</span>fread(start, <span style=color:#ae81ff>1</span>, buffer_.size() <span style=color:#f92672>-</span> (start <span style=color:#f92672>-</span> base), fptr_);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (n <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> traits_type<span style=color:#f92672>::</span>eof();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Set buffer pointers
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    setg(base, start, start <span style=color:#f92672>+</span> n);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> traits_type<span style=color:#f92672>::</span>to_int_type(<span style=color:#f92672>*</span>gptr());
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>å‡½æ•°çš„ç¬¬ä¸€è¡Œï¼Œé¦–å…ˆåˆ¤æ–­bufferæ˜¯å¦è€—å°½ã€‚å¦‚æœå¦ï¼Œåˆ™è¿”å›å½“å‰å­—ç¬¦ï¼Œå³<code>*gptr()</code>ã€‚å¦‚æœæ˜¯ï¼Œåˆ™è¿›è¡Œé‡å¡«(re-fill)æ“ä½œã€‚</p><p>å›æƒ³ä¸€ä¸‹æˆ‘ä»¬åœ¨æ„é€ å‡½æ•°ä¸­çš„å®ç°ï¼Œä¸‰ä¸ªçŠ¶æ€æŒ‡é’ˆå…¨éƒ½æŒ‡å‘ç¼“å†²åŒºçš„æœ«å°¾ã€‚å¦‚æœæˆ‘ä»¬è°ƒç”¨<code>underflow()</code>æ—¶ï¼Œå‘ç°çŠ¶æ€æŒ‡é’ˆå¹¶éå¦‚æ­¤ï¼Œåˆ™è¯´æ˜ç¼“å†²åŒºå·²ç»è¢«å¡«å……äº†è‡³å°‘ä¸€æ¬¡ã€‚</p><p>ç°åœ¨æˆ‘ä»¬è€ƒè™‘é‡å¡«æ“ä½œï¼Œæˆ‘ä»¬<code>memmove</code>æœ€å<code>put_back_</code>ä¸ªå­—ç¬¦åˆ°bufferçš„æœ«å°¾ï¼Œç”¨åš"put-back area"ã€‚ï¼ˆæˆ‘ä»¬ä¸ç”¨<code>memcopy</code>å› ä¸ºæˆ‘ä»¬çš„bufferæ¯”è¾ƒå°ï¼Œ`memmove()çš„æ•ˆç‡ä¼šæ›´é«˜ä¸€äº›ï¼‰</p><blockquote><p>è¯‘æ³¨ï¼šå®é™…ä¸Šï¼Œ<code>memcopy</code>ä¸<code>memmove</code>å„æœ‰æ‰€é•¿ã€‚<code>memcopy</code>ä¸éœ€è¦åˆ¤æ–­å†…å­˜overlapçš„æƒ…å†µï¼Œå³å¦‚æœæºåŒºé—´ä¸ç›®æ ‡åŒºé—´æœ‰é‡å ï¼Œé‚£ä¹ˆå¾—åˆ°çš„ç»“æœä¼šæ˜¯é”™çš„ã€‚è€Œ<code>memmove</code>ç”±äºæ˜¯ç§»åŠ¨è¯­ä¹‰ï¼Œæ‰€ä»¥åœ¨ç§»åŠ¨æ­¥é•¿è¾ƒå°æ—¶ï¼Œå¯ä»¥åªæ“ä½œcacheã€‚æ‰€ä»¥äºŒè€…å„æœ‰æ‰€é•¿ï¼Œè¦æ ¹æ®å…·ä½“æƒ…å†µåˆ¤æ–­ä¼˜åŠ£ã€‚Stackoverflowä¸Šæœ‰æ›´è¯¦ç»†çš„<a href=http://stackoverflow.com/questions/28623895/why-is-memmove-faster-than-memcpy>è®¨è®º</a></p></blockquote><p>æˆ‘ä»¬å¤„ç†å®Œ"put-back area"ä¹‹åï¼Œå°±å¯ä»¥ä½¿ç”¨<code>fread()</code>å‡½æ•°æ¥é‡å¡«ç¼“å†²åŒºäº†ã€‚å¦‚æœè¯»ä¸åˆ°æ•°æ®ï¼Œåˆ™æ„å‘³ç€æ–‡ä»¶å·²ç»è¯»åˆ°äº†ç»“å°¾ï¼ˆå½“ç„¶è¿™æ˜¯ä¸€ç§ç®€åŒ–æƒ…å†µï¼Œä½†åœ¨ç°å®ä¸­99.9%çš„è¯»å–å¤±è´¥éƒ½æ˜¯å› ä¸ºæ–‡ä»¶ç»“æŸï¼‰ã€‚</p><p>åœ¨<code>fread()</code>æˆåŠŸè¯»å–æ•°æ®ä¹‹åï¼Œæˆ‘ä»¬é€šçŸ¥streambufæ›´æ–°å†…éƒ¨çš„ä¸‰ä¸ªçŠ¶æ€æŒ‡é’ˆã€‚ä¹‹åè¿”å›bufferå½“å‰çš„æŒ‡é’ˆã€‚</p><p>è¿™å°±æ˜¯æˆ‘ä»¬çš„æµç¼“å†²åŒºçš„åŸºæœ¬å®ç°ï¼Œå¸Œæœ›è¿™å¹¶ä¸æ˜¯å¤ªéš¾ã€‚å½“ç„¶æˆ‘ä»¬è¿˜å¯ä»¥æ·»åŠ æ›´å¤šçš„åŠŸèƒ½ã€‚ç‰¹åˆ«çš„æ˜¯æˆ‘ä»¬å¯ä»¥åœ¨ç¼“å†²åŒºé‡Œé¢è¿›è¡ŒæŸ¥æ‰¾ã€‚å¦‚æœä½ æƒ³å®ç°å®ƒçš„è¯ï¼Œå¯ä»¥è¯•è¯•é‡å†™<code>std::streambuf::seekoff()</code>å’Œ<code>std::streambuf::seekpos</code>è™šæˆå‘˜å‡½æ•°ã€‚</p><p>æˆ‘ä»¬ä¹Ÿå¯ä»¥å®ç°å†™ç¼“å†²åŒºã€‚ä¸è¿‡ï¼Œåœ¨ä½ ä»¬è¯»å®Œç¬¬ä¸‰ä¸ªä¾‹å­ä¹‹åï¼Œä½ ä»¬å°±å¯ä»¥è½»æ¾æ„‰å¿«çš„å®ç°è‡ªå·±çš„ç‰ˆæœ¬äº†ï¼Œä¸éª—ä½ ã€‚</p><h3 id=ä¾‹2è¯»å–å†…å­˜ä¸­çš„æ•°ç»„>ä¾‹2ï¼šè¯»å–å†…å­˜ä¸­çš„æ•°ç»„ <a href=#%e4%be%8b2%e8%af%bb%e5%8f%96%e5%86%85%e5%ad%98%e4%b8%ad%e7%9a%84%e6%95%b0%e7%bb%84 class=anchor>ğŸ”—</a></h3><p>æœ¬ä¾‹ä¸­ï¼Œæˆ‘ä»¬è¦ä½¿ç”¨<code>std::istream</code>åŒ…è£…å†…å­˜ä¸­çš„ä¸€ä¸ªåªè¯»æ•°ç»„ï¼Œå¹¶ä¸”æ ¼å¼åŒ–çš„è¿›è¡Œè¯»å…¥ã€‚è¿™ä¸ªä¾‹å­å’Œä¸Šä¸€ä¸ªä¾‹å­æœ‰ä¸€ç‚¹ä¸åŒçš„æ˜¯ï¼Œæˆ‘ä»¬å¹¶ä¸éœ€è¦ä¸€ä¸ªçœŸæ­£çš„ç¼“å†²æ•°ç»„ï¼Œä»æºæ•°ç»„ä¸€æ¬¡æ€§è¯»å–å°±å¥½äº†ã€‚</p><p>æƒ³è±¡ä¸­çš„å®ç°æ˜¯è¿™ä¸ªæ ·å¼å„¿çš„ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>char_array_buffer</span> <span style=color:#f92672>:</span> <span style=color:#66d9ef>public</span> std<span style=color:#f92672>::</span>streambuf
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>        char_array_buffer(<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>begin, <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>end)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            setg(begin, begin, end);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        int_type <span style=color:#a6e22e>underflow</span>()
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span>  gptr() <span style=color:#f92672>==</span> egptr() <span style=color:#f92672>?</span>
</span></span><span style=display:flex><span>                    traits_type<span style=color:#f92672>::</span>eof() <span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                    traits_type<span style=color:#f92672>::</span>to_int_type(<span style=color:#f92672>*</span>gptr());
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>ä½†æ˜¯ï¼Œè¿™å¹¶æ²¡æœ‰ä»€ä¹ˆåµç”¨ã€‚å› ä¸º<code>setg()</code>å‡½æ•°åªæ¥å—éå¸¸é‡(non-const)æŒ‡é’ˆå‚æ•°ã€‚è¿™æ˜¾è€Œæ˜“è§ï¼Œå¦‚æœä¸€ä¸ªç¼“å†²åŒºä¸å¯å†™ï¼Œæˆ‘ä»¬å°±ä¸èƒ½æä¾›"put-back"åŠŸèƒ½ã€‚æ‰€ä»¥æˆ‘ä»¬è¦åŠ¨ä¸€åŠ¨æ‰‹è„šï¼Œé‡æ–°å®ç°ä¸€ä¸‹è¿™ä¸ªç±»ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;streambuf&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>char_array_buffer</span> <span style=color:#f92672>:</span> <span style=color:#66d9ef>public</span> std<span style=color:#f92672>::</span>streambuf
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>        char_array_buffer(<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>begin, <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>end);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>explicit</span> <span style=color:#a6e22e>char_array_buffer</span>(<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>str);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>        int_type underflow();
</span></span><span style=display:flex><span>        int_type <span style=color:#a6e22e>uflow</span>();
</span></span><span style=display:flex><span>        int_type <span style=color:#a6e22e>pbackfail</span>(int_type ch);
</span></span><span style=display:flex><span>        std<span style=color:#f92672>::</span>streamsize showmanyc();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// copy ctor and assignment not implemented;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// copying not allowed
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        char_array_buffer(<span style=color:#66d9ef>const</span> char_array_buffer <span style=color:#f92672>&amp;</span>);
</span></span><span style=display:flex><span>        char_array_buffer <span style=color:#f92672>&amp;</span><span style=color:#66d9ef>operator</span><span style=color:#f92672>=</span> (<span style=color:#66d9ef>const</span> char_array_buffer <span style=color:#f92672>&amp;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>const</span> begin_;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>const</span> end_;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span> current_;
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>åœ¨è¿™ä¸ªç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬é‡å†™äº†å‡ ä¸ªç§æœ‰å‡½æ•°ï¼Œè¿™äº›å‡½æ•°éƒ½æ˜¯ä»<code>std::streambuf</code>ç»§æ‰¿è€Œæ¥ã€‚</p><p>ç¬¬ä¸€ä¸ªæ„é€ å‡½æ•°éœ€è¦ç”¨æˆ·æŒ‡å®šèµ·æ­¢æŒ‡é’ˆï¼Œè€Œç¬¬äºŒä¸ªæ„é€ å‡½æ•°åªéœ€è¦æŒ‡å®šèµ·å§‹æŒ‡é’ˆï¼Œä¹‹åæˆ‘ä»¬ä¼šè°ƒç”¨<code>std::strlen()</code>æ¥åˆ¤æ–­å­—ç¬¦ä¸²çš„å¤§å°ã€‚</p><p>æˆ‘ä»¬ä½¿ç”¨<code>uflow()</code>, <code>pbackfail()</code>å’Œ<code>showmanyc()</code>æ¥ç»´æŠ¤ç¼“å†²åŒºå†…éƒ¨çš„çŠ¶æ€ï¼Œè€Œä¸æ˜¯è°ƒç”¨<code>setg()</code>ï¼Œå› ä¸ºbufferå¹¶ä¸å¯å†™ã€‚</p><p>åœ¨è¿™ä¸ªç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬è¦æ‰‹åŠ¨ç»´æŠ¤<code>eback</code>, <code>gptr</code>, <code>egptr</code>ä¸‰ä¸ªæŒ‡é’ˆã€‚åœ¨æ„é€ å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬å°†å¯¹å…¶è¿›è¡Œèµ‹å€¼ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;char_array_buffer.hpp&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;functional&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;cassert&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;cstring&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>char_array_buffer<span style=color:#f92672>::</span>char_array_buffer(<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>begin, <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>end) <span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>    begin_(begin),
</span></span><span style=display:flex><span>    end_(end),
</span></span><span style=display:flex><span>    current_(begin_)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    assert(std<span style=color:#f92672>::</span>less_equal<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*&gt;</span>()(begin_, end_));
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>char_array_buffer<span style=color:#f92672>::</span>char_array_buffer(<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>str) <span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>    begin_(str),
</span></span><span style=display:flex><span>    end_(begin_ <span style=color:#f92672>+</span> std<span style=color:#f92672>::</span>strlen(str)),
</span></span><span style=display:flex><span>    current_(begin_)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>ä¹‹å‰æˆ‘ä»¬ä½¿ç”¨<code>underflow()</code>æ¥è·å–å½“å‰å­—ç¬¦ï¼Œä½†è¿™æ¬¡æˆ‘ä»¬éœ€è¦ä½¿ç”¨<code>uflow()</code>ã€‚å› ä¸º<code>uflow()</code>éœ€è¦åŒæ—¶æ‰§è¡Œä¸¤æ­¥æ“ä½œï¼Œä¸€æ˜¯è·å–å½“å‰å­—ç¬¦ï¼ŒäºŒæ˜¯è®©<code>gptr()</code>å‰è¿›ä¸€æ­¥ã€‚ä½†æ˜¯åˆå› ä¸ºç¼“å†²åŒºç”±æˆ‘ä»¬æ‰‹åŠ¨ç®¡ç†ï¼Œ<code>std::streambuf</code>å¹¶ä¸èƒ½æ­£ç¡®çš„æ‰§è¡Œç®¡ç†æ“ä½œã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦é‡å†™<code>uflow()</code>è€Œä¸æ˜¯<code>underflow()</code>ã€‚</p><div class=mermaid>char_array_buffer::int_type char_array_buffer::uflow()
{
if (current_ == end_)
return traits_type::eof();
return traits_type::to_int_type(*current_++);
}</div><p>ä¸‹ä¸€æ­¥æˆ‘ä»¬è¿˜è¦å®ç°<code>pbackfail()</code>ã€‚å½“æˆ‘ä»¬è°ƒç”¨<code>std::istream::unget()</code>æˆ–<code>std::istream::putback(ch)</code>æ—¶ï¼Œæˆ‘ä»¬ä¼šæŠŠå·²ç»è¯»å‡ºçš„æ•°æ®å†™å›æ•°ç»„ä¸­ã€‚ä½†æ˜¯ç”±äºæ•°ç»„æ˜¯åªè¯»çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬åªèƒ½æ¨¡æ‹Ÿè¿™ç§æ“ä½œã€‚</p><p>åœ¨é»˜è®¤çš„å®ç°ä¸­<code>pbackfail()</code>åªä¼šè¿”å›<code>traits_type::eof()</code>ï¼Œè€Œåœ¨æˆ‘ä»¬çš„ç‰ˆæœ¬ä¸­ï¼Œå¦‚æœå†™å›æˆåŠŸï¼Œå°†ä¼šè¿”å›å†™å›çš„å­—ç¬¦ï¼Œä¸æˆåŠŸè¿”å›eofã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>char_array_buffer<span style=color:#f92672>::</span>int_type char_array_buffer<span style=color:#f92672>::</span>pbackfail(int_type ch)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (current_ <span style=color:#f92672>==</span> begin_ <span style=color:#f92672>||</span> (ch <span style=color:#f92672>!=</span> traits_type<span style=color:#f92672>::</span>eof() <span style=color:#f92672>&amp;&amp;</span> ch <span style=color:#f92672>!=</span> current_[<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>]))
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> traits_type<span style=color:#f92672>::</span>eof();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> traits_type<span style=color:#f92672>::</span>to_int_type(<span style=color:#f92672>*--</span>current_);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>åœ¨<code>FILE_buffer</code>ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥è€ƒè™‘é‡å†™<code>pbackfail()</code>ï¼Œæ¥æä¾›åå‘æŸ¥æ‰¾ä»¥åŠï¼ˆç”¨å‰é¢çš„æ•°æ®ï¼‰é‡å¡«bufferçš„åŠŸèƒ½ã€‚</p><p>æœ€åä¸€ä¸ªé‡å†™çš„å‡½æ•°æ˜¯<code>showmanyc()</code>ï¼Œè¿™ä¸ªå‡½æ•°è¢«<code>std::streambuf::in_avail()</code>è°ƒç”¨ï¼Œä»¥åˆ¤æ–­å½“å‰æœ‰å¤šå°‘ä¸ªå­—ç¬¦å¯ä»¥è¿”å›ã€‚ç”±äºæˆ‘ä»¬æ¥ç®¡äº†çŠ¶æ€æŒ‡é’ˆï¼Œæ‰€ä»¥è¿™ä¸ªå‡½æ•°ä¹Ÿè¦æˆ‘ä»¬è‡ªå·±æ¥å®ç°å•Šã€‚ï¼ˆè¯‘è€…ï¼šä¸ºä»€ä¹ˆè¦ç»™è‡ªå·±æ‰¾éº»çƒ¦ã€‚ã€‚ã€‚ï¼‰</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>std<span style=color:#f92672>::</span>streamsize char_array_buffer<span style=color:#f92672>::</span>showmanyc()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    assert(std<span style=color:#f92672>::</span>less_equal<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*&gt;</span>()(current_, end_));
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> end_ <span style=color:#f92672>-</span> current_;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>ç”±æ­¤å¯è§ï¼Œæœ¬ä¾‹ä¸­çš„bufferæ¯”å‰é¢çš„è¦å¤æ‚ä¸€ç‚¹ç‚¹ã€‚è¿™æ˜¯å› ä¸ºæˆ‘ä»¬æ¥ç®¡äº†çŠ¶æ€ç»´æŠ¤çš„å·¥ä½œã€‚è¿™ä½¿å¾—æˆ‘ä»¬æ›´å¥½çš„ç†è§£äº†<code>std::streambuf</code>å†…éƒ¨æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚</p><h3 id=ä¾‹3å¥é¦–å˜å¤§å†™çš„ç¼“å†²åŒº>ä¾‹3ï¼šå¥é¦–å˜å¤§å†™çš„ç¼“å†²åŒº <a href=#%e4%be%8b3%e5%8f%a5%e9%a6%96%e5%8f%98%e5%a4%a7%e5%86%99%e7%9a%84%e7%bc%93%e5%86%b2%e5%8c%ba class=anchor>ğŸ”—</a></h3><p>æœ¬ä¾‹ä¸­æˆ‘ä»¬å°†è¦å®ç°ä¸€ä¸ªå°†å¥é¦–å­—ç¬¦å˜å¤§å†™çš„bufferã€‚å½“ç„¶æˆ‘ä»¬åªè€ƒè™‘æœ€åŸºæœ¬çš„æƒ…å†µï¼Œç§»æ¤åˆ°ä¸åŒçš„åŒºåŸŸå’Œè¯­è¨€ï¼Œå…¶å®æ˜¯å¾ˆçç¢çš„äº‹æƒ…ã€‚ï¼ˆè¯‘è€…ï¼šæ–‡å­—ç¼–ç å‘çš„äº²å¦ˆéƒ½ä¸è®¤äº†ï¼‰</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;streambuf&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;iosfwd&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;cstdlib&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;vector&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>caps_buffer</span> <span style=color:#f92672>:</span> <span style=color:#66d9ef>public</span> std<span style=color:#f92672>::</span>streambuf
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>explicit</span> caps_buffer(std<span style=color:#f92672>::</span>ostream <span style=color:#f92672>&amp;</span>sink, std<span style=color:#f92672>::</span>size_t buff_sz <span style=color:#f92672>=</span> <span style=color:#ae81ff>256</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>bool</span> do_caps_and_flush();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>        int_type overflow(int_type ch);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>sync</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// copy ctor and assignment not implemented;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// copying not allowed
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        caps_buffer(<span style=color:#66d9ef>const</span> caps_buffer <span style=color:#f92672>&amp;</span>);
</span></span><span style=display:flex><span>        caps_buffer <span style=color:#f92672>&amp;</span><span style=color:#66d9ef>operator</span><span style=color:#f92672>=</span> (<span style=color:#66d9ef>const</span> caps_buffer <span style=color:#f92672>&amp;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>bool</span> cap_next_;
</span></span><span style=display:flex><span>        std<span style=color:#f92672>::</span>ostream <span style=color:#f92672>&amp;</span>sink_;
</span></span><span style=display:flex><span>        std<span style=color:#f92672>::</span>vector<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>char</span><span style=color:#f92672>&gt;</span> buffer_;
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>è¿™é‡Œæˆ‘ä»¬éœ€è¦é‡å†™<code>overflow()</code>å’Œ<code>sync()</code>å‡½æ•°ã€‚<code>overflow()</code>åœ¨è¾“å…¥ç¼“å†²åŒºæ»¡çš„æ—¶å€™è¢«è°ƒç”¨ï¼Œå¹¶ä¸”åœ¨æˆåŠŸæ—¶è¿”å›ä»»æ„éeofçš„å€¼ã€‚</p><p><code>sync()</code>çš„ä½œç”¨æ˜¯æŠŠå½“å‰çš„bufferå†™å…¥ç›®æ ‡ï¼Œå³ä½¿å½“å‰bufferå¹¶æœªå¡«æ»¡ã€‚<code>std::flush()</code>ä¼šè°ƒç”¨<code>sync()</code>å‡½æ•°ï¼Œå½“å¤±è´¥æ—¶è¿”å›-1ã€‚</p><p>æˆ‘ä»¬ç¼–å†™ä¸€ä¸ªè¾…åŠ©å‡½æ•°<code>do_caps_and_flush()</code>ï¼Œç”¨æ¥å°†å°å†™å˜å¤§å†™ï¼Œå¹¶å†™å…¥<code>sink_</code>è¾“å‡ºæµã€‚æˆ‘ä»¬å†å£°æ˜ä¸€ä¸ªå“¨å…µå˜é‡<code>cap_next_</code>æ¥æ ‡è¯†ä¸‹ä¸€ä¸ªå­—ç¬¦æ˜¯å¦éœ€è¦å°å†™å˜å¤§å†™ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;caps_buffer.hpp&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;cctype&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;ostream&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;functional&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;cassert&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>caps_buffer<span style=color:#f92672>::</span>caps_buffer(std<span style=color:#f92672>::</span>ostream <span style=color:#f92672>&amp;</span>sink, std<span style=color:#f92672>::</span>size_t buff_sz) <span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>    cap_next_(true),
</span></span><span style=display:flex><span>    sink_(sink),
</span></span><span style=display:flex><span>    buffer_(buff_sz <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    sink_.clear();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>base <span style=color:#f92672>=</span> <span style=color:#f92672>&amp;</span>buffer_.front();
</span></span><span style=display:flex><span>    setp(base, base <span style=color:#f92672>+</span> buffer_.size() <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>); <span style=color:#75715e>// -1 to make overflow() easier
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p><code>buffer_</code>çš„æœ€å°å¯èƒ½å¤§å°æ˜¯1ï¼ŒåŒæ—¶æˆ‘ä»¬ä¹Ÿåªéœ€è¦ç»´æŠ¤ä¸¤ä¸ªæŒ‡é’ˆï¼Œå› ä¸ºè¿™é‡Œä¸éœ€è¦åƒè¾“å…¥ç¼“å†²åŒºä¸€æ ·çš„ç»´æŠ¤"put-back area"ã€‚</p><p>æˆ‘ä»¬æŠŠ<code>buffer_</code>çš„å¤§å°è®¾æˆ<code>buff_sz + 1</code>ï¼Œè¿™æ ·æ˜¯ä¸ºäº†<code>overflow()</code>è¢«è°ƒç”¨æ—¶ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªé¢å¤–çš„ç©ºé—´å­˜å‚¨å½“å‰çš„å­—ç¬¦ã€‚æœ€åå°†ç¼“å†²åŒºæ•°ç»„å’Œæœ€åä¸€ä¸ªå­—ç¬¦ä¸€èµ·åˆ·æ–°åˆ°<code>ostream</code>ä¸­ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>caps_buffer<span style=color:#f92672>::</span>int_type caps_buffer<span style=color:#f92672>::</span>overflow(int_type ch)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (sink_ <span style=color:#f92672>&amp;&amp;</span> ch <span style=color:#f92672>!=</span> traits_type<span style=color:#f92672>::</span>eof())
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        assert(std<span style=color:#f92672>::</span>less_equal<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>char</span> <span style=color:#f92672>*&gt;</span>()(pptr(), epptr()));
</span></span><span style=display:flex><span>        <span style=color:#f92672>*</span>pptr() <span style=color:#f92672>=</span> ch;
</span></span><span style=display:flex><span>        pbump(<span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (do_caps_and_flush())
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> ch;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> traits_type<span style=color:#f92672>::</span>eof();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>ç¬¬ä¸€æ­¥æ˜¯æŠŠchå†™å…¥<code>buffer_</code>ï¼Œå¹¶ä¸”ä½¿ç”¨<code>pbump(1)</code>å°†<code>pptr()</code>å‘å‰ç§»ä¸€ä½ã€‚ä¹‹åè°ƒç”¨<code>do_caps_and_flush()</code>åšä¸€äº›è„æ´»ï¼Œä¹‹åè¿”å›ä¸€ä¸ªå­—ç¬¦å£°æ˜è°ƒç”¨æˆåŠŸã€‚</p><p><code>sync()</code>çš„å®ç°ä¹Ÿéå¸¸ç®€å•:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>int</span> caps_buffer<span style=color:#f92672>::</span>sync()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>do_caps_and_flush</span>() <span style=color:#f92672>?</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>:</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>æˆ‘ä»¬å†çœ‹ä¸€çœ‹<code>do_caps_and_flush()</code>å‡½æ•°</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>bool</span> caps_buffer<span style=color:#f92672>::</span>do_caps_and_flush()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>p <span style=color:#f92672>=</span> pbase(), <span style=color:#f92672>*</span>e <span style=color:#f92672>=</span> pptr(); p <span style=color:#f92672>!=</span> e; <span style=color:#f92672>++</span>p)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>*</span>p <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;.&#39;</span>)
</span></span><span style=display:flex><span>            cap_next_ <span style=color:#f92672>=</span> true;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span> <span style=color:#a6e22e>if</span> (std<span style=color:#f92672>::</span>isalpha(<span style=color:#f92672>*</span>p))
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (cap_next_)
</span></span><span style=display:flex><span>                <span style=color:#f92672>*</span>p <span style=color:#f92672>=</span> std<span style=color:#f92672>::</span>toupper(<span style=color:#f92672>*</span>p);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            cap_next_ <span style=color:#f92672>=</span> false;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    std<span style=color:#f92672>::</span>ptrdiff_t n <span style=color:#f92672>=</span> pptr() <span style=color:#f92672>-</span> pbase();
</span></span><span style=display:flex><span>    pbump(<span style=color:#f92672>-</span>n);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> sink_.write(pbase(), n);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>å¯¹äºæœ¬ä¾‹æ¥è¯´ï¼Œå†…éƒ¨çš„ç¼“å†²åŒºå¹¶éå¿…è¦ï¼Œæˆ‘ä»¬å¯ä»¥ä¸€ä¸ªå­—ç¬¦ä¸€ä¸ªå­—ç¬¦æŠŠæ•°æ®å‘åˆ°<code>sink</code>ä¸­ã€‚ä½†æ˜¯æˆ‘çš„è§‚ç‚¹æ˜¯ä¸€ä¸ªå†…éƒ¨bufferä»æœ‰å…¶ç”¨å¤„ã€‚</p><h3 id=ä»‹ç»-boost-iostreams-åº“>ä»‹ç» Boost IOStreams åº“ <a href=#%e4%bb%8b%e7%bb%8d-boost-iostreams-%e5%ba%93 class=anchor>ğŸ”—</a></h3><p>å¦‚æœä½ æ˜¯æµç¼“å†²åŒºçš„æ–°æ‰‹ï¼Œå¸Œæœ›ä½ å·²ç»å¯¹å®ƒæœ‰ä¸€ç‚¹ç‚¹äº†è§£äº†ã€‚æœ¬æ–‡ä¸­çš„ä¾‹å­éƒ½éå¸¸åŸºç¡€ï¼Œä½†æ˜¯ä½ å¯ä»¥ç”¨å®ƒä»¬åšæ›´å¤šæœ‰æ„æ€çš„äº‹æƒ…ã€‚ä½†æ˜¯å½“æˆ‘å®ç°æ›´å¤æ‚çš„æµç¼“å†²åŒºæ—¶ï¼Œé—®é¢˜çš„å¤æ‚åº¦å´ä¸Šå‡çš„å¾ˆå¿«ã€‚è¿™æ—¶æˆ‘å‘ç°äº†<code>Boost IOStreams</code>åº“ï¼Œå®ƒä¸ºæ›´å¤æ‚çš„ç¼“å†²åŒºå’Œæµæä¾›äº†å¿…è¦çš„æ¡†æ¶æ”¯æŒã€‚</p><p>å®ƒå…è®¸ä½ è§£è€¦æ•°æ®æºï¼Œæ•°æ®è¾“å‡ºï¼Œè¿‡æ»¤å™¨ä»¥åŠå…¶å®ƒä¸€äº›æ¦‚å¿µã€‚åœ¨æˆ‘ä»¬çš„æœ€åä¸€ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ç¡¬ç¼–ç æ•°æ®è¾“å‡ºåˆ°<code>std::ostream</code>ä¸­ã€‚å¦‚æœæˆ‘ä»¬è¦è¾“å‡ºåˆ°ä¸€ä¸ªæ²¡æœ‰æµæ¥å£çš„ç±»å‘¢ï¼Ÿ<code>Boost IOStreams</code>åº“æä¾›äº†æ›´å¤šçš„çµæ´»æ€§ï¼Œå°†ä¸€å¨ç´§è€¦åˆçš„ä»£ç åˆ†è§£æˆç‹¬ç«‹çš„æŠ½è±¡æ¦‚å¿µã€‚</p><h3 id=æ‰©å±•é˜…è¯»>æ‰©å±•é˜…è¯» <a href=#%e6%89%a9%e5%b1%95%e9%98%85%e8%af%bb class=anchor>ğŸ”—</a></h3><ul><li>The C++ Standard Library by Nicolai M. Josuttis</li><li>The C++ Standard, BS ISO/IEC 14882:2003 (Second Edition)</li><li><a href=http://www.dinkumware.com/manuals/>Dinkum Compleat Reference online</a></li></ul></div></section></div><div class=side><div class=side-recent><h2 class=side-title><a href=/posts/>Recent Posts</a></h2><hr><ul><li><a href=/posts/why-not-start-with-ddia-part-1/>ä¸ºä»€ä¹ˆæˆ‘ä¸å»ºè®®ä½ é˜…è¯»ã€Šæ•°æ®å¯†é›†å‹åº”ç”¨ç³»ç»Ÿè®¾è®¡ã€‹ï¼ˆä¹‹ä¸€ï¼‰</a></li><li><a href=/posts/vertical-axis-wind-turbine-3d-model/>é£åŠ›æ¶¡è½®æœº 3D æ¨¡å‹ / Vertical Axis Wind Turbine (VAWT) 3D Model</a></li><li><a href=/posts/press-pad-3d-model/>3Dæ‰“å°è§£å‹ç©å…· / 3D Printed Fidget Toy</a></li><li><a href=/posts/lava-store/>è®ºæ–‡é˜…è¯»ï¼šLavaStore - é«˜æ€§èƒ½ã€æœ¬åœ°å­˜å‚¨å¼•æ“çš„æ¼”è¿›</a></li><li><a href=/posts/std-smart-ptrs-cpp-for-the-antiquated-4/>åŠ¨æ‰‹å®ç°æ™ºèƒ½æŒ‡é’ˆ ï¼ˆä¸Šç¯‡ï¼‰ - C++ for the Antiquatedï¼ˆä¹‹å››ï¼‰</a></li></ul></div><div class=side-categories><h2>Categories</h2><hr><ul></ul></div><div class=side-tags><h2>Tags</h2><hr><ul><li><a href=/tags/.net>.net (1)</a></li><li><a href=/tags/3d-printing>3d printing (2)</a></li><li><a href=/tags/a2b>a2b (1)</a></li><li><a href=/tags/ahk>ahk (1)</a></li><li><a href=/tags/algorithm>algorithm (26)</a></li><li><a href=/tags/alloca>alloca (1)</a></li><li><a href=/tags/allocate>allocate (1)</a></li><li><a href=/tags/arduino>arduino (1)</a></li><li><a href=/tags/asm>asm (1)</a></li><li><a href=/tags/async>async (2)</a></li><li><a href=/tags/atcoder>atcoder (1)</a></li><li><a href=/tags/autohotkey>autohotkey (1)</a></li><li><a href=/tags/autopilot>autopilot (1)</a></li><li><a href=/tags/azure>azure (2)</a></li><li><a href=/tags/b-tree>b-tree (1)</a></li><li><a href=/tags/basic-paxos>basic paxos (2)</a></li><li><a href=/tags/bbr>bbr (1)</a></li><li><a href=/tags/binary-indexed-tree>binary indexed tree (1)</a></li><li><a href=/tags/binary-tree>binary tree (1)</a></li><li><a href=/tags/bittorrent>bittorrent (1)</a></li><li><a href=/tags/borg>borg (1)</a></li><li><a href=/tags/bw-tree>bw-tree (1)</a></li><li><a href=/tags/c>c# (1)</a></li><li><a href=/tags/c++>c++ (6)</a></li><li><a href=/tags/cache>cache (1)</a></li><li><a href=/tags/cachegrind>cachegrind (1)</a></li><li><a href=/tags/cap>cap (1)</a></li><li><a href=/tags/career>career (1)</a></li><li><a href=/tags/cas>cas (3)</a></li><li><a href=/tags/ceph>ceph (1)</a></li><li><a href=/tags/chrome-extension>chrome-extension (2)</a></li><li><a href=/tags/cmpxchg>cmpxchg (2)</a></li><li><a href=/tags/cocurrency>cocurrency (1)</a></li><li><a href=/tags/code-golf>code golf (1)</a></li><li><a href=/tags/codeforces>codeforces (14)</a></li><li><a href=/tags/compare-ans-swap>compare-ans-swap (1)</a></li><li><a href=/tags/computational-geometry>computational geometry (1)</a></li><li><a href=/tags/consistency>consistency (1)</a></li><li><a href=/tags/cpp>cpp (9)</a></li><li><a href=/tags/cpu>cpu (1)</a></li><li><a href=/tags/cse351>cse351 (2)</a></li><li><a href=/tags/csharp>csharp (1)</a></li><li><a href=/tags/css>css (1)</a></li><li><a href=/tags/data-center>data center (1)</a></li><li><a href=/tags/data-center-management>data center management (1)</a></li><li><a href=/tags/defer>defer (1)</a></li><li><a href=/tags/distributed-system>distributed system (4)</a></li><li><a href=/tags/epoll>epoll (1)</a></li><li><a href=/tags/ergodone>ergodone (1)</a></li><li><a href=/tags/fifo>fifo (1)</a></li><li><a href=/tags/flatbuffer>flatbuffer (2)</a></li><li><a href=/tags/fn-layer>fn-layer (1)</a></li><li><a href=/tags/front-end-development>front-end development (1)</a></li><li><a href=/tags/functional-programming>functional programming (1)</a></li><li><a href=/tags/game>game (1)</a></li><li><a href=/tags/gcj>gcj (1)</a></li><li><a href=/tags/geohash>geohash (1)</a></li><li><a href=/tags/geometric>geometric (1)</a></li><li><a href=/tags/geometry>geometry (1)</a></li><li><a href=/tags/get-things-done>get things done (1)</a></li><li><a href=/tags/google>google (3)</a></li><li><a href=/tags/graph>graph (1)</a></li><li><a href=/tags/head-first>head-first (1)</a></li><li><a href=/tags/heap>heap (1)</a></li><li><a href=/tags/herd7>herd7 (1)</a></li><li><a href=/tags/induction>induction (2)</a></li><li><a href=/tags/interview>interview (5)</a></li><li><a href=/tags/keyboard>keyboard (2)</a></li><li><a href=/tags/kubernetes>kubernetes (1)</a></li><li><a href=/tags/lavastore>lavastore (1)</a></li><li><a href=/tags/leetcode>leetcode (4)</a></li><li><a href=/tags/leveldb>leveldb (1)</a></li><li><a href=/tags/linkedin>linkedin (1)</a></li><li><a href=/tags/linux>linux (1)</a></li><li><a href=/tags/litmus>litmus (1)</a></li><li><a href=/tags/lock-less>lock-less (1)</a></li><li><a href=/tags/lsm-tree>lsm-tree (1)</a></li><li><a href=/tags/markdown>markdown (1)</a></li><li><a href=/tags/median>median (1)</a></li><li><a href=/tags/memory>memory (1)</a></li><li><a href=/tags/memory-barrier>memory-barrier (3)</a></li><li><a href=/tags/mesi>mesi (1)</a></li><li><a href=/tags/message-queue>message queue (1)</a></li><li><a href=/tags/metadata>metadata (1)</a></li><li><a href=/tags/metaprogramming>metaprogramming (1)</a></li><li><a href=/tags/microsoft>microsoft (2)</a></li><li><a href=/tags/misaka>misaka (1)</a></li><li><a href=/tags/modern-c++>modern c++ (1)</a></li><li><a href=/tags/modern-cpp>modern cpp (4)</a></li><li><a href=/tags/mosca>mosca (1)</a></li><li><a href=/tags/mq>mq (1)</a></li><li><a href=/tags/multi-paxos>multi paxos (1)</a></li><li><a href=/tags/multi-thread>multi-thread (3)</a></li><li><a href=/tags/multiprocess>multiprocess (1)</a></li><li><a href=/tags/multithread>multithread (3)</a></li><li><a href=/tags/network>network (1)</a></li><li><a href=/tags/networking>networking (4)</a></li><li><a href=/tags/non-blocking>non-blocking (1)</a></li><li><a href=/tags/normal-distribution>normal-distribution (1)</a></li><li><a href=/tags/ocaml>ocaml (1)</a></li><li><a href=/tags/ot>ot (1)</a></li><li><a href=/tags/parallel>parallel (1)</a></li><li><a href=/tags/partition>partition (1)</a></li><li><a href=/tags/paxos>paxos (2)</a></li><li><a href=/tags/pecifica>pecifica (1)</a></li><li><a href=/tags/pelican>pelican (1)</a></li><li><a href=/tags/phxrpc>phxrpc (8)</a></li><li><a href=/tags/pl>pl (1)</a></li><li><a href=/tags/poi>poi (1)</a></li><li><a href=/tags/poll>poll (1)</a></li><li><a href=/tags/powershell>powershell (1)</a></li><li><a href=/tags/priority-queue>priority queue (1)</a></li><li><a href=/tags/priority_queue>priority_queue (1)</a></li><li><a href=/tags/profile>profile (1)</a></li><li><a href=/tags/programming-interview>programming interview (1)</a></li><li><a href=/tags/promela>promela (2)</a></li><li><a href=/tags/protobuf>protobuf (1)</a></li><li><a href=/tags/protocol>protocol (4)</a></li><li><a href=/tags/python>python (3)</a></li><li><a href=/tags/quartile>quartile (1)</a></li><li><a href=/tags/queue>queue (2)</a></li><li><a href=/tags/quick-sort>quick sort (1)</a></li><li><a href=/tags/quora>quora (1)</a></li><li><a href=/tags/racket>racket (1)</a></li><li><a href=/tags/raft>raft (2)</a></li><li><a href=/tags/rocksdb>rocksdb (2)</a></li><li><a href=/tags/rpc>rpc (4)</a></li><li><a href=/tags/social-network>social network (1)</a></li><li><a href=/tags/socket>socket (1)</a></li><li><a href=/tags/solution>solution (2)</a></li><li><a href=/tags/sort>sort (1)</a></li><li><a href=/tags/spin>spin (4)</a></li><li><a href=/tags/spin/promela>spin/promela (2)</a></li><li><a href=/tags/stack>stack (2)</a></li><li><a href=/tags/stdfunction>std::function (1)</a></li><li><a href=/tags/stl>stl (1)</a></li><li><a href=/tags/storage>storage (3)</a></li><li><a href=/tags/storage-system>storage system (2)</a></li><li><a href=/tags/streambuf>streambuf (1)</a></li><li><a href=/tags/string>string (1)</a></li><li><a href=/tags/stup>stup (3)</a></li><li><a href=/tags/stylish>stylish (1)</a></li><li><a href=/tags/system>system (1)</a></li><li><a href=/tags/system-design>system design (5)</a></li><li><a href=/tags/tcp>tcp (4)</a></li><li><a href=/tags/tcpip>tcpip (1)</a></li><li><a href=/tags/thread>thread (3)</a></li><li><a href=/tags/tlv>tlv (1)</a></li><li><a href=/tags/twisted>twisted (1)</a></li><li><a href=/tags/ucontext>ucontext (2)</a></li><li><a href=/tags/udp>udp (3)</a></li><li><a href=/tags/useless>useless (1)</a></li><li><a href=/tags/userscript>userscript (1)</a></li><li><a href=/tags/valgrind>valgrind (1)</a></li><li><a href=/tags/wait-free>wait-free (1)</a></li><li><a href=/tags/was>was (1)</a></li><li><a href=/tags/wisckey>wisckey (1)</a></li><li><a href=/tags/workflowy>workflowy (1)</a></li><li><a href=/tags/wsl>wsl (1)</a></li><li><a href=/tags/yunfile>yunfile (1)</a></li><li><a href=/tags/zeromq>zeromq (1)</a></li><li><a href=/tags/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B>å¹¶å‘ç¼–ç¨‹ (1)</a></li><li><a href=/tags/%E7%B3%99%E5%BF%AB%E7%8C%9B>ç³™å¿«çŒ› (1)</a></li><li><a href=/tags/%E5%88%9B%E9%80%A0%E5%8A%9B>åˆ›é€ åŠ› (1)</a></li><li><a href=/tags/%E8%AF%BB%E4%B9%A6>è¯»ä¹¦ (2)</a></li><li><a href=/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B>å¤šçº¿ç¨‹ (2)</a></li><li><a href=/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F>åˆ†å¸ƒå¼ç³»ç»Ÿ (6)</a></li><li><a href=/tags/%E5%88%86%E7%B1%BB%E5%99%A8>åˆ†ç±»å™¨ (1)</a></li><li><a href=/tags/%E5%85%AC%E5%BC%80%E8%AF%BE>å…¬å¼€è¯¾ (4)</a></li><li><a href=/tags/%E8%AE%A1%E6%95%B0>è®¡æ•° (1)</a></li><li><a href=/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6>è®¡ç®—æœºç§‘å­¦ (1)</a></li><li><a href=/tags/%E9%93%BE%E8%A1%A8>é“¾è¡¨ (1)</a></li><li><a href=/tags/%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB>è®ºæ–‡é˜…è¯» (1)</a></li><li><a href=/tags/%E9%9D%A2%E8%AF%95>é¢è¯• (1)</a></li><li><a href=/tags/%E5%AE%B9%E6%96%A5%E5%8E%9F%E7%90%86>å®¹æ–¥åŸç† (1)</a></li><li><a href=/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F>è®¾è®¡æ¨¡å¼ (2)</a></li><li><a href=/tags/%E6%95%B0%E6%8D%AE%E7%BC%96%E7%A0%81>æ•°æ®ç¼–ç  (1)</a></li><li><a href=/tags/%E6%95%B0%E6%8D%AE%E5%BA%93>æ•°æ®åº“ (4)</a></li><li><a href=/tags/%E6%95%B0%E6%8D%AE%E5%AF%86%E9%9B%86%E5%9E%8B%E5%BA%94%E7%94%A8%E7%B3%BB%E7%BB%9F>æ•°æ®å¯†é›†å‹åº”ç”¨ç³»ç»Ÿ (1)</a></li><li><a href=/tags/%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B>æ•°æ®æ¨¡å‹ (1)</a></li><li><a href=/tags/%E6%95%B0%E6%8D%AE%E7%B3%BB%E7%BB%9F>æ•°æ®ç³»ç»Ÿ (1)</a></li><li><a href=/tags/%E6%80%9D%E7%BB%B4>æ€ç»´ (1)</a></li><li><a href=/tags/%E7%AE%97%E6%B3%95>ç®—æ³• (14)</a></li><li><a href=/tags/%E7%B4%A2%E5%BC%95>ç´¢å¼• (1)</a></li><li><a href=/tags/%E7%B4%A2%E5%BC%95%E7%BB%93%E6%9E%84>ç´¢å¼•ç»“æ„ (1)</a></li><li><a href=/tags/%E9%A2%98%E8%A7%A3>é¢˜è§£ (11)</a></li><li><a href=/tags/%E9%97%B2%E8%81%8A>é—²èŠ (3)</a></li><li><a href=/tags/%E5%8D%8F%E7%A8%8B>åç¨‹ (1)</a></li><li><a href=/tags/%E5%8E%8B%E7%BC%A9>å‹ç¼© (1)</a></li><li><a href=/tags/%E4%B8%80%E8%87%B4%E6%80%A7>ä¸€è‡´æ€§ (3)</a></li><li><a href=/tags/%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6>ä¸»ä»å¤åˆ¶ (1)</a></li><li><a href=/tags/%E5%AD%97%E7%AC%A6%E4%B8%B2>å­—ç¬¦ä¸² (1)</a></li><li><a href=/tags/%E6%9C%80%E5%B0%8F%E8%A1%A8%E7%A4%BA%E6%B3%95>æœ€å°è¡¨ç¤ºæ³• (1)</a></li></ul></div></div></main><footer class=footer><div class=footer-row><a class=footer-item href=https://wizmann.top/posts/index.xml>Feed of Posts
<i class=icofont-rss></i></a></div></footer></body></html>