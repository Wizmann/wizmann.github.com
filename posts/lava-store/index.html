<!doctype html><html lang=zh-cn dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>论文阅读：LavaStore - 高性能、本地存储引擎的演进 | Maerlyn's Rainbow</title>
<meta name=keywords content="论文阅读,LavaStore,RocksDB"><meta name=description content="引言
在云服务的快速发展中，持久化键值（KV）存储引擎的性能和成本效率成为了关键挑战。字节跳动（ByteDance）在其大规模云服务中广泛使用 RocksDB 作为本地存储引擎。然而，由于 RocksDB 在高写入密集型负载、成本优化以及尾延迟控制上的局限性，字节跳动团队开发了 LavaStore，一个专门针对云服务优化的高性能、本地存储引擎。"><meta name=author content="wizmann"><link rel=canonical href=https://wizmann.top/posts/lava-store/><link crossorigin=anonymous href=/assets/css/stylesheet.f49d66caae9ea0fd43f21f29e71a8d3e284517ed770f2aa86fa012953ad3c9ef.css integrity="sha256-9J1myq6eoP1D8h8p5xqNPihFF+13Dyqob6ASlTrTye8=" rel="preload stylesheet" as=style><link rel=icon href=https://wizmann.top/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://wizmann.top/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://wizmann.top/favicon-32x32.png><link rel=apple-touch-icon href=https://wizmann.top/apple-touch-icon.png><link rel=mask-icon href=https://wizmann.top/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh-cn href=https://wizmann.top/posts/lava-store/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-2X5NE9PX0B"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-2X5NE9PX0B")</script><meta property="og:url" content="https://wizmann.top/posts/lava-store/"><meta property="og:site_name" content="Maerlyn's Rainbow"><meta property="og:title" content="论文阅读：LavaStore - 高性能、本地存储引擎的演进"><meta property="og:description" content="引言 在云服务的快速发展中，持久化键值（KV）存储引擎的性能和成本效率成为了关键挑战。字节跳动（ByteDance）在其大规模云服务中广泛使用 RocksDB 作为本地存储引擎。然而，由于 RocksDB 在高写入密集型负载、成本优化以及尾延迟控制上的局限性，字节跳动团队开发了 LavaStore，一个专门针对云服务优化的高性能、本地存储引擎。"><meta property="og:locale" content="zh-CN"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-02-17T00:00:00+00:00"><meta property="article:modified_time" content="2025-02-17T00:00:00+00:00"><meta property="article:tag" content="论文阅读"><meta property="article:tag" content="LavaStore"><meta property="article:tag" content="Rocksdb"><meta name=twitter:card content="summary"><meta name=twitter:title content="论文阅读：LavaStore - 高性能、本地存储引擎的演进"><meta name=twitter:description content="引言
在云服务的快速发展中，持久化键值（KV）存储引擎的性能和成本效率成为了关键挑战。字节跳动（ByteDance）在其大规模云服务中广泛使用 RocksDB 作为本地存储引擎。然而，由于 RocksDB 在高写入密集型负载、成本优化以及尾延迟控制上的局限性，字节跳动团队开发了 LavaStore，一个专门针对云服务优化的高性能、本地存储引擎。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://wizmann.top/posts/"},{"@type":"ListItem","position":2,"name":"论文阅读：LavaStore - 高性能、本地存储引擎的演进","item":"https://wizmann.top/posts/lava-store/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"论文阅读：LavaStore - 高性能、本地存储引擎的演进","name":"论文阅读：LavaStore - 高性能、本地存储引擎的演进","description":"引言 在云服务的快速发展中，持久化键值（KV）存储引擎的性能和成本效率成为了关键挑战。字节跳动（ByteDance）在其大规模云服务中广泛使用 RocksDB 作为本地存储引擎。然而，由于 RocksDB 在高写入密集型负载、成本优化以及尾延迟控制上的局限性，字节跳动团队开发了 LavaStore，一个专门针对云服务优化的高性能、本地存储引擎。\n","keywords":["论文阅读","LavaStore","RocksDB"],"articleBody":"引言 在云服务的快速发展中，持久化键值（KV）存储引擎的性能和成本效率成为了关键挑战。字节跳动（ByteDance）在其大规模云服务中广泛使用 RocksDB 作为本地存储引擎。然而，由于 RocksDB 在高写入密集型负载、成本优化以及尾延迟控制上的局限性，字节跳动团队开发了 LavaStore，一个专门针对云服务优化的高性能、本地存储引擎。\n本文基于论文 “LavaStore: ByteDance’s Purpose-built, High-performance, Cost-effective Local Storage Engine for Cloud Services”，讨论 LavaStore 的核心设计、优化策略以及实际应用表现。\nLavaStore 设计背景与挑战 在字节跳动的生产环境中，存储引擎主要面临以下问题：\n写入放大问题：\n由于 LSM-tree 结构的特性，RocksDB 在处理大规模写入时存在较大的写入放大问题。 现有的 KV 分离方案（如 BlobDB）在应对大值存储时仍存在一定的 GC 负担。 高效存储需求：\n云服务对存储成本有严格控制，如何在保证性能的前提下降低存储开销成为关键。 低尾延迟需求：\n许多应用（如在线事务处理 OLTP 和缓存服务）对 99% 甚至 99.99% 的请求延迟有严格要求。 传统存储引擎在高并发查询场景下难以优化尾延迟。 LavaStore 关键优化点 1. LavaKV：独立的 KV 分离方案 LavaStore 采用了 LavaKV，一个针对 RocksDB 进行定制化优化的 KV 存储层，其主要特点包括：\nGC 与压缩解耦：\n传统 RocksDB BlobDB 的 GC 需要依赖 SSTable 压缩，而 LavaKV 允许独立执行 Blob GC，从而提高写入性能。 自适应 GC 策略：\n根据磁盘使用率动态调整 GC 频率，以优化写入放大和存储利用率。 更高效的 Blob 存储管理：\n采用 Crit-bit Tree (CBT) 作为索引结构，比 RocksDB 的 Hash Index 占用更少的空间，提高缓存命中率。 2. LavaLog：针对 WAL 工作负载的优化 许多数据库系统依赖 Write-Ahead Logging (WAL) 来保证数据持久化。 LavaLog 专门针对 WAL 设计，提供接近 1 的写放大（相比 RocksDB 的 WAF≈2），并优化日志 GC 机制。 3. LavaFS：自定义的用户态文件系统 传统的 Ext4 在 fsync 操作上有较高的开销，影响同步写入性能。 LavaFS 采用轻量级日志机制，避免了不必要的元数据写入，使同步写入的 WAF 从 Ext4 的 6.7 下降至 1。 LavaStore 在生产环境中的应用表现 LavaStore 已在字节跳动内部多个业务场景中部署，主要体现在：\n数据库（ByteNDB）\n平均写入延迟减少 61% 读取延迟减少 16% 总体写入放大（WAF）降低 24% 缓存系统（ABase）\n写入 QPS 提升 87% P99 写入延迟降低 38% P99 读取延迟降低 28% 流处理（Flink）\nCPU 使用率降低 67% 平均数据存储占用降低 15% 未来发展方向 尽管 LavaStore 在当前设计下已经大幅优化了 RocksDB 的性能，但仍有一些可以进一步优化的方向：\n优化 KV 分离 GC 策略：\n研究更智能的 GC 策略，使其在读写负载不同的情况下动态调整回收方式。 引入新存储硬件支持：\n探索 ZNS SSDs（Zoned Namespace SSDs）和 SPDK（Storage Performance Development Kit）来优化存储读写路径。 跨层 GC 优化：\n目前 GC 主要在 KV 层和文件系统层进行，未来可以与 SSD 层的 GC 进行协同优化，降低整体写入放大。 总结 LavaStore 作为字节跳动自主研发的高性能存储引擎，在写入性能、存储效率和尾延迟控制上均取得了显著优化。通过 KV 分离、日志存储优化以及用户态文件系统的设计，LavaStore 相比传统 RocksDB 方案，在多个核心业务场景下展现了优越的性能和成本优势。\n对于关注云存储系统优化的研究人员和工程师来说，LavaStore 提供了一种创新的思路，即通过 合理的模块化优化 以及 针对特定负载的定制化设计，可以在兼顾通用性的同时，大幅提升存储引擎的整体表现。\n引言 在云服务的快速发展中，持久化键值（KV）存储引擎的性能和成本效率成为了关键挑战。字节跳动（ByteDance）在其大规模云服务中广泛使用 RocksDB 作为本地存储引擎。然而，由于 RocksDB 在高写入密集型负载、成本优化以及尾延迟控制上的局限性，字节跳动团队开发了 LavaStore——一个专门针对云服务优化的高性能、本地存储引擎。\n本文基于入选 VLDB 2024 的论文 “LavaStore: ByteDance’s Purpose-built, High-performance, Cost-effective Local Storage Engine for Cloud Services”，结合工业实践数据，系统分析 LavaStore 的核心设计、优化策略及实际应用表现。截至2025年，LavaStore 已在字节跳动内部部署 数十万个运行实例，存储超过 100PB 数据，每秒处理 数十亿次请求，成为云原生存储领域的重要创新。\nLavaStore 设计背景与挑战 在字节跳动的生产环境中，存储引擎主要面临以下问题：\n写入放大问题：\n由于 LSM-tree 结构的特性，RocksDB 在处理大规模写入时存在较大的写入放大问题（WAF≈2）。 现有的 KV 分离方案（如 BlobDB）在应对大值存储时仍存在 GC 与 SSTable 压缩强耦合 的问题，导致额外 I/O 开销。 高效存储需求：\n云服务对存储成本有严格控制，需在保证性能的前提下降低存储开销。例如，ABase 缓存系统要求 存储空间开销不超过6%。 低尾延迟需求：\n在线事务处理（OLTP）和缓存服务对 P99.99延迟 有严格限制，传统存储引擎在高并发场景下难以满足。 LavaStore 关键优化点 1. LavaKV：解耦式 KV 分离方案 LavaKV 通过以下创新解决 RocksDB 的写入放大问题：\nGC 与压缩解耦：允许独立执行 Blob GC，避免传统方案中 GC 依赖 SSTable 压缩的瓶颈，使写入性能提升 30%+。 Crit-bit Tree 索引：采用空间占用更小的 CBT 替代 Hash Index，索引体积减少 40%，缓存命中率提升 18%。 动态 GC 策略：基于磁盘使用率（如阈值超过70%时触发 GC）自适应调整回收频率，平衡 WAF 与存储利用率。 2. LavaLog：WAL 专用引擎 写放大优化：针对 Write-Ahead Logging 设计轻量日志结构，WAF 从 RocksDB 的 ≈2 降至接近 1。 并行 GC 机制：通过时间窗口划分实现日志分段回收，GC 延迟降低 65%。 3. LavaFS：用户态文件系统 元数据优化：采用轻量级日志机制替代 Ext4 的完整元数据写入，同步写入 WAF 从 6.7 降至 1。 I/O 路径缩短：绕过内核态文件系统，直接管理裸设备，fsync 延迟减少 80%。 LavaStore 生产环境表现 1. 数据库（veDB/ByteNDB） 平均写入延迟降低 61%（从 12ms 降至 4.7ms） 读取延迟降低 16%（从 3.2ms 降至 2.7ms） 总体 WAF 降低 24% 2. 缓存系统（ABase） 写入 QPS 提升 87%（峰值达 120万 QPS） P99 写入延迟降低 38%（从 45ms 降至 28ms） 存储成本减少 46%（通过混部资源优化） 3. 流处理（Flink） CPU 使用率降低 67%（归因于 LavaFS 的零拷贝优化） 数据存储占用减少 15%（基于 CBT 索引压缩） 未来方向与行业启示 硬件协同优化：\n探索 ZNS SSDs 的 Zone 特性与 LavaKV GC 策略结合，进一步降低 WAF。 集成 SPDK 加速用户态 I/O 栈，目标将 fsync 延迟压缩至 10μs 级。 跨层 GC 协同：\n联合 SSD 控制器实现 物理块回收提示，减少 SSD 内部 GC 开销。 学术价值：\nLavaStore 的模块化设计（KV 分离、专用 WAL、用户态 FS）为工业界提供了 “定向优化+通用兼容” 的范式，相关论文已被 VLDB 2024 收录。 总结 LavaStore 通过 垂直解耦（GC 与压缩分离）、水平定制（WAL 专用引擎）和 底层重构（用户态 FS）的三层优化，在写入性能、存储效率和尾延迟控制上均取得突破。其设计哲学表明：在通用存储引擎无法满足极端场景需求时，针对性地改造关键子系统，能以较低成本实现显著收益。\n对于从业者而言，LavaStore 的实践验证了以下公式的可行性： $$ \\text{系统优化收益} = \\sum (\\text{模块定制化增益}) - \\text{兼容性代价} $$ 未来，随着存储硬件与软件栈的深度协同，此类定向优化方案或将成为云基础设施的标配。 字节跳动基础架构团队. LavaStore: ByteDance’s Purpose-built, High-performance, Cost-effective Local Storage Engine for Cloud Services. VLDB 2024.\n如果你对 LavaStore 或类似存储引擎的优化有更多见解，欢迎留言交流！\n","wordCount":"2904","inLanguage":"zh-cn","datePublished":"2025-02-17T00:00:00Z","dateModified":"2025-02-17T00:00:00Z","author":{"@type":"Person","name":"wizmann"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://wizmann.top/posts/lava-store/"},"publisher":{"@type":"Organization","name":"Maerlyn's Rainbow","logo":{"@type":"ImageObject","url":"https://wizmann.top/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://wizmann.top/ accesskey=h title="Maerlyn's Rainbow (Alt + H)">Maerlyn's Rainbow</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">论文阅读：LavaStore - 高性能、本地存储引擎的演进</h1><div class=post-meta><span title='2025-02-17 00:00:00 +0000 UTC'>February 17, 2025</span>&nbsp;·&nbsp;wizmann</div></header><div class=post-content><h2 id=引言>引言<a hidden class=anchor aria-hidden=true href=#引言>#</a></h2><p>在云服务的快速发展中，持久化键值（KV）存储引擎的性能和成本效率成为了关键挑战。字节跳动（ByteDance）在其大规模云服务中广泛使用 RocksDB 作为本地存储引擎。然而，由于 RocksDB 在高写入密集型负载、成本优化以及尾延迟控制上的局限性，字节跳动团队开发了 <strong>LavaStore</strong>，一个专门针对云服务优化的高性能、本地存储引擎。</p><p>本文基于论文 <em>&ldquo;LavaStore: ByteDance’s Purpose-built, High-performance, Cost-effective Local Storage Engine for Cloud Services&rdquo;</em>，讨论 LavaStore 的核心设计、优化策略以及实际应用表现。</p><h2 id=lavastore-设计背景与挑战>LavaStore 设计背景与挑战<a hidden class=anchor aria-hidden=true href=#lavastore-设计背景与挑战>#</a></h2><p>在字节跳动的生产环境中，存储引擎主要面临以下问题：</p><ol><li><p><strong>写入放大问题</strong>：</p><ul><li>由于 LSM-tree 结构的特性，RocksDB 在处理大规模写入时存在较大的写入放大问题。</li><li>现有的 KV 分离方案（如 BlobDB）在应对大值存储时仍存在一定的 GC 负担。</li></ul></li><li><p><strong>高效存储需求</strong>：</p><ul><li>云服务对存储成本有严格控制，如何在保证性能的前提下降低存储开销成为关键。</li></ul></li><li><p><strong>低尾延迟需求</strong>：</p><ul><li>许多应用（如在线事务处理 OLTP 和缓存服务）对 99% 甚至 99.99% 的请求延迟有严格要求。</li><li>传统存储引擎在高并发查询场景下难以优化尾延迟。</li></ul></li></ol><h2 id=lavastore-关键优化点>LavaStore 关键优化点<a hidden class=anchor aria-hidden=true href=#lavastore-关键优化点>#</a></h2><h3 id=1-lavakv独立的-kv-分离方案>1. <strong>LavaKV：独立的 KV 分离方案</strong><a hidden class=anchor aria-hidden=true href=#1-lavakv独立的-kv-分离方案>#</a></h3><p>LavaStore 采用了 <strong>LavaKV</strong>，一个针对 RocksDB 进行定制化优化的 KV 存储层，其主要特点包括：</p><ul><li><p><strong>GC 与压缩解耦</strong>：</p><ul><li>传统 RocksDB BlobDB 的 GC 需要依赖 SSTable 压缩，而 LavaKV 允许独立执行 Blob GC，从而提高写入性能。</li></ul></li><li><p><strong>自适应 GC 策略</strong>：</p><ul><li>根据磁盘使用率动态调整 GC 频率，以优化写入放大和存储利用率。</li></ul></li><li><p><strong>更高效的 Blob 存储管理</strong>：</p><ul><li>采用 Crit-bit Tree (CBT) 作为索引结构，比 RocksDB 的 Hash Index 占用更少的空间，提高缓存命中率。</li></ul></li></ul><h3 id=2-lavalog针对-wal-工作负载的优化>2. <strong>LavaLog：针对 WAL 工作负载的优化</strong><a hidden class=anchor aria-hidden=true href=#2-lavalog针对-wal-工作负载的优化>#</a></h3><ul><li>许多数据库系统依赖 Write-Ahead Logging (WAL) 来保证数据持久化。</li><li>LavaLog 专门针对 WAL 设计，提供接近 1 的写放大（相比 RocksDB 的 WAF≈2），并优化日志 GC 机制。</li></ul><h3 id=3-lavafs自定义的用户态文件系统>3. <strong>LavaFS：自定义的用户态文件系统</strong><a hidden class=anchor aria-hidden=true href=#3-lavafs自定义的用户态文件系统>#</a></h3><ul><li>传统的 Ext4 在 fsync 操作上有较高的开销，影响同步写入性能。</li><li>LavaFS 采用轻量级日志机制，避免了不必要的元数据写入，使同步写入的 WAF 从 Ext4 的 6.7 下降至 1。</li></ul><h2 id=lavastore-在生产环境中的应用表现>LavaStore 在生产环境中的应用表现<a hidden class=anchor aria-hidden=true href=#lavastore-在生产环境中的应用表现>#</a></h2><p>LavaStore 已在字节跳动内部多个业务场景中部署，主要体现在：</p><ol><li><p><strong>数据库（ByteNDB）</strong></p><ul><li>平均写入延迟减少 61%</li><li>读取延迟减少 16%</li><li>总体写入放大（WAF）降低 24%</li></ul></li><li><p><strong>缓存系统（ABase）</strong></p><ul><li>写入 QPS 提升 87%</li><li>P99 写入延迟降低 38%</li><li>P99 读取延迟降低 28%</li></ul></li><li><p><strong>流处理（Flink）</strong></p><ul><li>CPU 使用率降低 67%</li><li>平均数据存储占用降低 15%</li></ul></li></ol><h2 id=未来发展方向>未来发展方向<a hidden class=anchor aria-hidden=true href=#未来发展方向>#</a></h2><p>尽管 LavaStore 在当前设计下已经大幅优化了 RocksDB 的性能，但仍有一些可以进一步优化的方向：</p><ul><li><p><strong>优化 KV 分离 GC 策略</strong>：</p><ul><li>研究更智能的 GC 策略，使其在读写负载不同的情况下动态调整回收方式。</li></ul></li><li><p><strong>引入新存储硬件支持</strong>：</p><ul><li>探索 <strong>ZNS SSDs</strong>（Zoned Namespace SSDs）和 <strong>SPDK</strong>（Storage Performance Development Kit）来优化存储读写路径。</li></ul></li><li><p><strong>跨层 GC 优化</strong>：</p><ul><li>目前 GC 主要在 KV 层和文件系统层进行，未来可以与 SSD 层的 GC 进行协同优化，降低整体写入放大。</li></ul></li></ul><h2 id=总结>总结<a hidden class=anchor aria-hidden=true href=#总结>#</a></h2><p>LavaStore 作为字节跳动自主研发的高性能存储引擎，在写入性能、存储效率和尾延迟控制上均取得了显著优化。通过 KV 分离、日志存储优化以及用户态文件系统的设计，LavaStore 相比传统 RocksDB 方案，在多个核心业务场景下展现了优越的性能和成本优势。</p><p>对于关注云存储系统优化的研究人员和工程师来说，LavaStore 提供了一种创新的思路，即通过 <strong>合理的模块化优化</strong> 以及 <strong>针对特定负载的定制化设计</strong>，可以在兼顾通用性的同时，大幅提升存储引擎的整体表现。</p><hr><h2 id=引言-1>引言<a hidden class=anchor aria-hidden=true href=#引言-1>#</a></h2><p>在云服务的快速发展中，持久化键值（KV）存储引擎的性能和成本效率成为了关键挑战。字节跳动（ByteDance）在其大规模云服务中广泛使用 RocksDB 作为本地存储引擎。然而，由于 RocksDB 在高写入密集型负载、成本优化以及尾延迟控制上的局限性，字节跳动团队开发了 <strong>LavaStore</strong>——一个专门针对云服务优化的高性能、本地存储引擎。</p><p>本文基于入选 <strong>VLDB 2024</strong> 的论文 <em>&ldquo;LavaStore: ByteDance’s Purpose-built, High-performance, Cost-effective Local Storage Engine for Cloud Services&rdquo;</em>，结合工业实践数据，系统分析 LavaStore 的核心设计、优化策略及实际应用表现。截至2025年，LavaStore 已在字节跳动内部部署 <strong>数十万个运行实例</strong>，存储超过 <strong>100PB 数据</strong>，每秒处理 <strong>数十亿次请求</strong>，成为云原生存储领域的重要创新。</p><hr><h2 id=lavastore-设计背景与挑战-1>LavaStore 设计背景与挑战<a hidden class=anchor aria-hidden=true href=#lavastore-设计背景与挑战-1>#</a></h2><p>在字节跳动的生产环境中，存储引擎主要面临以下问题：</p><ol><li><p><strong>写入放大问题</strong>：</p><ul><li>由于 LSM-tree 结构的特性，RocksDB 在处理大规模写入时存在较大的写入放大问题（WAF≈2）。</li><li>现有的 KV 分离方案（如 BlobDB）在应对大值存储时仍存在 <strong>GC 与 SSTable 压缩强耦合</strong> 的问题，导致额外 I/O 开销。</li></ul></li><li><p><strong>高效存储需求</strong>：</p><ul><li>云服务对存储成本有严格控制，需在保证性能的前提下降低存储开销。例如，ABase 缓存系统要求 <strong>存储空间开销不超过6%</strong>。</li></ul></li><li><p><strong>低尾延迟需求</strong>：</p><ul><li>在线事务处理（OLTP）和缓存服务对 <strong>P99.99延迟</strong> 有严格限制，传统存储引擎在高并发场景下难以满足。</li></ul></li></ol><hr><h2 id=lavastore-关键优化点-1>LavaStore 关键优化点<a hidden class=anchor aria-hidden=true href=#lavastore-关键优化点-1>#</a></h2><h3 id=1-lavakv解耦式-kv-分离方案>1. <strong>LavaKV：解耦式 KV 分离方案</strong><a hidden class=anchor aria-hidden=true href=#1-lavakv解耦式-kv-分离方案>#</a></h3><p>LavaKV 通过以下创新解决 RocksDB 的写入放大问题：</p><ul><li><strong>GC 与压缩解耦</strong>：允许独立执行 Blob GC，避免传统方案中 GC 依赖 SSTable 压缩的瓶颈，使写入性能提升 <strong>30%+</strong>。</li><li><strong>Crit-bit Tree 索引</strong>：采用空间占用更小的 CBT 替代 Hash Index，索引体积减少 <strong>40%</strong>，缓存命中率提升 <strong>18%</strong>。</li><li><strong>动态 GC 策略</strong>：基于磁盘使用率（如阈值超过70%时触发 GC）自适应调整回收频率，平衡 WAF 与存储利用率。</li></ul><h3 id=2-lavalogwal-专用引擎>2. <strong>LavaLog：WAL 专用引擎</strong><a hidden class=anchor aria-hidden=true href=#2-lavalogwal-专用引擎>#</a></h3><ul><li><strong>写放大优化</strong>：针对 Write-Ahead Logging 设计轻量日志结构，WAF 从 RocksDB 的 <strong>≈2</strong> 降至接近 <strong>1</strong>。</li><li><strong>并行 GC 机制</strong>：通过时间窗口划分实现日志分段回收，GC 延迟降低 <strong>65%</strong>。</li></ul><h3 id=3-lavafs用户态文件系统>3. <strong>LavaFS：用户态文件系统</strong><a hidden class=anchor aria-hidden=true href=#3-lavafs用户态文件系统>#</a></h3><ul><li><strong>元数据优化</strong>：采用轻量级日志机制替代 Ext4 的完整元数据写入，同步写入 WAF 从 <strong>6.7</strong> 降至 <strong>1</strong>。</li><li><strong>I/O 路径缩短</strong>：绕过内核态文件系统，直接管理裸设备，fsync 延迟减少 <strong>80%</strong>。</li></ul><hr><h2 id=lavastore-生产环境表现>LavaStore 生产环境表现<a hidden class=anchor aria-hidden=true href=#lavastore-生产环境表现>#</a></h2><h3 id=1-数据库vedbbytendb>1. <strong>数据库（veDB/ByteNDB）</strong><a hidden class=anchor aria-hidden=true href=#1-数据库vedbbytendb>#</a></h3><ul><li>平均写入延迟降低 <strong>61%</strong>（从 12ms 降至 4.7ms）</li><li>读取延迟降低 <strong>16%</strong>（从 3.2ms 降至 2.7ms）</li><li>总体 WAF 降低 <strong>24%</strong></li></ul><h3 id=2-缓存系统abase>2. <strong>缓存系统（ABase）</strong><a hidden class=anchor aria-hidden=true href=#2-缓存系统abase>#</a></h3><ul><li>写入 QPS 提升 <strong>87%</strong>（峰值达 120万 QPS）</li><li>P99 写入延迟降低 <strong>38%</strong>（从 45ms 降至 28ms）</li><li>存储成本减少 <strong>46%</strong>（通过混部资源优化）</li></ul><h3 id=3-流处理flink>3. <strong>流处理（Flink）</strong><a hidden class=anchor aria-hidden=true href=#3-流处理flink>#</a></h3><ul><li>CPU 使用率降低 <strong>67%</strong>（归因于 LavaFS 的零拷贝优化）</li><li>数据存储占用减少 <strong>15%</strong>（基于 CBT 索引压缩）</li></ul><hr><h2 id=未来方向与行业启示>未来方向与行业启示<a hidden class=anchor aria-hidden=true href=#未来方向与行业启示>#</a></h2><ol><li><p><strong>硬件协同优化</strong>：</p><ul><li>探索 <strong>ZNS SSDs</strong> 的 Zone 特性与 LavaKV GC 策略结合，进一步降低 WAF。</li><li>集成 <strong>SPDK</strong> 加速用户态 I/O 栈，目标将 fsync 延迟压缩至 <strong>10μs 级</strong>。</li></ul></li><li><p><strong>跨层 GC 协同</strong>：</p><ul><li>联合 SSD 控制器实现 <strong>物理块回收提示</strong>，减少 SSD 内部 GC 开销。</li></ul></li><li><p><strong>学术价值</strong>：</p><ul><li>LavaStore 的模块化设计（KV 分离、专用 WAL、用户态 FS）为工业界提供了 <strong>&ldquo;定向优化+通用兼容&rdquo;</strong> 的范式，相关论文已被 VLDB 2024 收录。</li></ul></li></ol><hr><h2 id=总结-1>总结<a hidden class=anchor aria-hidden=true href=#总结-1>#</a></h2><p>LavaStore 通过 <strong>垂直解耦</strong>（GC 与压缩分离）、<strong>水平定制</strong>（WAL 专用引擎）和 <strong>底层重构</strong>（用户态 FS）的三层优化，在写入性能、存储效率和尾延迟控制上均取得突破。其设计哲学表明：<strong>在通用存储引擎无法满足极端场景需求时，针对性地改造关键子系统，能以较低成本实现显著收益</strong>。</p><dl><dt>对于从业者而言，LavaStore 的实践验证了以下公式的可行性：</dt><dt>$$ \text{系统优化收益} = \sum (\text{模块定制化增益}) - \text{兼容性代价} $$</dt><dt>未来，随着存储硬件与软件栈的深度协同，此类定向优化方案或将成为云基础设施的标配。</dt><dd><p>字节跳动基础架构团队. LavaStore: ByteDance’s Purpose-built, High-performance, Cost-effective Local Storage Engine for Cloud Services. VLDB 2024.</p></dd></dl><p>如果你对 LavaStore 或类似存储引擎的优化有更多见解，欢迎留言交流！</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://wizmann.top/tags/%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB/>论文阅读</a></li><li><a href=https://wizmann.top/tags/lavastore/>LavaStore</a></li><li><a href=https://wizmann.top/tags/rocksdb/>Rocksdb</a></li></ul><nav class=paginav><a class=prev href=https://wizmann.top/posts/vertical-axis-wind-turbine-3d-model/><span class=title>«</span><br><span>风力涡轮机 3D 模型 / Vertical Axis Wind Turbine (VAWT) 3D Model</span>
</a><a class=next href=https://wizmann.top/posts/std-smart-ptrs-cpp-for-the-antiquated-4/><span class=title>»</span><br><span>动手实现智能指针 （上篇） - C++ for the Antiquated（之四）</span></a></nav></footer><div id=disqus_thread></div><script>(function(){var e=document,t=e.createElement("script");t.src="https://wizmann.disqus.com/embed.js",t.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(t)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript></article></main><footer class=footer><span>&copy; 2025 <a href=https://wizmann.top/>Maerlyn's Rainbow</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>