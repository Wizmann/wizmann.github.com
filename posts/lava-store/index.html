<!doctype html><html lang=zh-CN dir=ltr><head><script>window.MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"],["\\[","\\]"]]},svg:{fontCache:"global"}}</script><script defer src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script></head><body class=notransition><div id=container><header id=main-header><div role=navigation aria-label=Main><div class=nav-left><a href=https://wizmann.top/ style=color:inherit>Maerlyn's Rainbow</a></div><div class=nav-right><div style=position:absolute;width:0;height:0><div id=nav-dropdown-menu class=hidden href=#><div class=nav-item><a aria-current=true class=ancestor href=/posts/>Posts</a></div></div></div><a id=nav-dropdown-button href=#><svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M4 6H20M4 12H20M4 18H20" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></a><div id=nav-menu><div class=nav-item><a aria-current=true class=ancestor href=/posts/>Posts</a></div></div><a id=theme-switcher href=#><svg class="light-icon" viewBox="0 0 24 24" fill="none"><path d="M12 3V4m0 16v1M4 12H3M6.31412 6.31412 5.5 5.5m12.1859.81412L18.5 5.5M6.31412 17.69 5.5 18.5001M17.6859 17.69 18.5 18.5001M21 12H20m-4 0c0 2.2091-1.7909 4-4 4-2.20914.0-4-1.7909-4-4 0-2.20914 1.79086-4 4-4 2.2091.0 4 1.79086 4 4z" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg><svg class="dark-icon" viewBox="0 0 24 24" fill="none"><path d="M3.32031 11.6835c0 4.9706 4.02944 9 8.99999 9 3.7872.0 7.028-2.3392 8.3565-5.6515C19.6402 15.4486 18.5059 15.6834 17.3203 15.6834c-4.9706.0-8.99999-4.0294-8.99999-8.99998C8.32031 5.50338 8.55165 4.36259 8.96453 3.32996 5.65605 4.66028 3.32031 7.89912 3.32031 11.6835z" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></a></div></div></header><div class="flex grow"><div id=main-pane><main id=main-content><div class=single-header><ol class=breadcrumbs itemscope itemtype=https://schema.org/BreadcrumbList><li itemprop=itemListElement itemscope itemtype=https://schema.org/ListItem><a itemprop=item href=https://wizmann.top/><span itemprop=name></span>
</a><meta itemprop=position content='1'></li><span>&nbsp»&nbsp</span><li itemprop=itemListElement itemscope itemtype=https://schema.org/ListItem><a itemprop=item href=https://wizmann.top/posts/><span itemprop=name>Posts</span>
</a><meta itemprop=position content='2'></li><span>&nbsp»&nbsp</span></ol><h1>论文阅读：LavaStore - 高性能、本地存储引擎的演进</h1><time class=dim datetime=2025-02-17T00:00:00+00:00>February 17, 2025</time><div class=term-container><div class=tag><a href=https://wizmann.top/tags/%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB/>#论文阅读</a></div><div class=tag><a href=https://wizmann.top/tags/lavastore/>#LavaStore</a></div><div class=tag><a href=https://wizmann.top/tags/rocksdb/>#RocksDB</a></div></ol></div><section class=page-section><h2 id=引言>引言</h2><p>在云服务的快速发展中，持久化键值（KV）存储引擎的性能和成本效率成为了关键挑战。字节跳动（ByteDance）在其大规模云服务中广泛使用 RocksDB 作为本地存储引擎。然而，由于 RocksDB 在高写入密集型负载、成本优化以及尾延迟控制上的局限性，字节跳动团队开发了 <strong>LavaStore</strong>，一个专门针对云服务优化的高性能、本地存储引擎。</p><p>本文基于论文 <em>&ldquo;LavaStore: ByteDance’s Purpose-built, High-performance, Cost-effective Local Storage Engine for Cloud Services&rdquo;</em>，讨论 LavaStore 的核心设计、优化策略以及实际应用表现。</p><h2 id=lavastore-设计背景与挑战>LavaStore 设计背景与挑战</h2><p>在字节跳动的生产环境中，存储引擎主要面临以下问题：</p><ol><li><p><strong>写入放大问题</strong>：</p><ul><li>由于 LSM-tree 结构的特性，RocksDB 在处理大规模写入时存在较大的写入放大问题。</li><li>现有的 KV 分离方案（如 BlobDB）在应对大值存储时仍存在一定的 GC 负担。</li></ul></li><li><p><strong>高效存储需求</strong>：</p><ul><li>云服务对存储成本有严格控制，如何在保证性能的前提下降低存储开销成为关键。</li></ul></li><li><p><strong>低尾延迟需求</strong>：</p><ul><li>许多应用（如在线事务处理 OLTP 和缓存服务）对 99% 甚至 99.99% 的请求延迟有严格要求。</li><li>传统存储引擎在高并发查询场景下难以优化尾延迟。</li></ul></li></ol><h2 id=lavastore-关键优化点>LavaStore 关键优化点</h2><h3 id=1-lavakv独立的-kv-分离方案>1. <strong>LavaKV：独立的 KV 分离方案</strong></h3><p>LavaStore 采用了 <strong>LavaKV</strong>，一个针对 RocksDB 进行定制化优化的 KV 存储层，其主要特点包括：</p><ul><li><p><strong>GC 与压缩解耦</strong>：</p><ul><li>传统 RocksDB BlobDB 的 GC 需要依赖 SSTable 压缩，而 LavaKV 允许独立执行 Blob GC，从而提高写入性能。</li></ul></li><li><p><strong>自适应 GC 策略</strong>：</p><ul><li>根据磁盘使用率动态调整 GC 频率，以优化写入放大和存储利用率。</li></ul></li><li><p><strong>更高效的 Blob 存储管理</strong>：</p><ul><li>采用 Crit-bit Tree (CBT) 作为索引结构，比 RocksDB 的 Hash Index 占用更少的空间，提高缓存命中率。</li></ul></li></ul><h3 id=2-lavalog针对-wal-工作负载的优化>2. <strong>LavaLog：针对 WAL 工作负载的优化</strong></h3><ul><li>许多数据库系统依赖 Write-Ahead Logging (WAL) 来保证数据持久化。</li><li>LavaLog 专门针对 WAL 设计，提供接近 1 的写放大（相比 RocksDB 的 WAF≈2），并优化日志 GC 机制。</li></ul><h3 id=3-lavafs自定义的用户态文件系统>3. <strong>LavaFS：自定义的用户态文件系统</strong></h3><ul><li>传统的 Ext4 在 fsync 操作上有较高的开销，影响同步写入性能。</li><li>LavaFS 采用轻量级日志机制，避免了不必要的元数据写入，使同步写入的 WAF 从 Ext4 的 6.7 下降至 1。</li></ul><h2 id=lavastore-在生产环境中的应用表现>LavaStore 在生产环境中的应用表现</h2><p>LavaStore 已在字节跳动内部多个业务场景中部署，主要体现在：</p><ol><li><p><strong>数据库（ByteNDB）</strong></p><ul><li>平均写入延迟减少 61%</li><li>读取延迟减少 16%</li><li>总体写入放大（WAF）降低 24%</li></ul></li><li><p><strong>缓存系统（ABase）</strong></p><ul><li>写入 QPS 提升 87%</li><li>P99 写入延迟降低 38%</li><li>P99 读取延迟降低 28%</li></ul></li><li><p><strong>流处理（Flink）</strong></p><ul><li>CPU 使用率降低 67%</li><li>平均数据存储占用降低 15%</li></ul></li></ol><h2 id=未来发展方向>未来发展方向</h2><p>尽管 LavaStore 在当前设计下已经大幅优化了 RocksDB 的性能，但仍有一些可以进一步优化的方向：</p><ul><li><p><strong>优化 KV 分离 GC 策略</strong>：</p><ul><li>研究更智能的 GC 策略，使其在读写负载不同的情况下动态调整回收方式。</li></ul></li><li><p><strong>引入新存储硬件支持</strong>：</p><ul><li>探索 <strong>ZNS SSDs</strong>（Zoned Namespace SSDs）和 <strong>SPDK</strong>（Storage Performance Development Kit）来优化存储读写路径。</li></ul></li><li><p><strong>跨层 GC 优化</strong>：</p><ul><li>目前 GC 主要在 KV 层和文件系统层进行，未来可以与 SSD 层的 GC 进行协同优化，降低整体写入放大。</li></ul></li></ul><h2 id=总结>总结</h2><p>LavaStore 作为字节跳动自主研发的高性能存储引擎，在写入性能、存储效率和尾延迟控制上均取得了显著优化。通过 KV 分离、日志存储优化以及用户态文件系统的设计，LavaStore 相比传统 RocksDB 方案，在多个核心业务场景下展现了优越的性能和成本优势。</p><p>对于关注云存储系统优化的研究人员和工程师来说，LavaStore 提供了一种创新的思路，即通过 <strong>合理的模块化优化</strong> 以及 <strong>针对特定负载的定制化设计</strong>，可以在兼顾通用性的同时，大幅提升存储引擎的整体表现。</p><hr><h2 id=引言-1>引言</h2><p>在云服务的快速发展中，持久化键值（KV）存储引擎的性能和成本效率成为了关键挑战。字节跳动（ByteDance）在其大规模云服务中广泛使用 RocksDB 作为本地存储引擎。然而，由于 RocksDB 在高写入密集型负载、成本优化以及尾延迟控制上的局限性，字节跳动团队开发了 <strong>LavaStore</strong>——一个专门针对云服务优化的高性能、本地存储引擎。</p><p>本文基于入选 <strong>VLDB 2024</strong> 的论文 <em>&ldquo;LavaStore: ByteDance’s Purpose-built, High-performance, Cost-effective Local Storage Engine for Cloud Services&rdquo;</em>，结合工业实践数据，系统分析 LavaStore 的核心设计、优化策略及实际应用表现。截至2025年，LavaStore 已在字节跳动内部部署 <strong>数十万个运行实例</strong>，存储超过 <strong>100PB 数据</strong>，每秒处理 <strong>数十亿次请求</strong>，成为云原生存储领域的重要创新。</p><hr><h2 id=lavastore-设计背景与挑战-1>LavaStore 设计背景与挑战</h2><p>在字节跳动的生产环境中，存储引擎主要面临以下问题：</p><ol><li><p><strong>写入放大问题</strong>：</p><ul><li>由于 LSM-tree 结构的特性，RocksDB 在处理大规模写入时存在较大的写入放大问题（WAF≈2）。</li><li>现有的 KV 分离方案（如 BlobDB）在应对大值存储时仍存在 <strong>GC 与 SSTable 压缩强耦合</strong> 的问题，导致额外 I/O 开销。</li></ul></li><li><p><strong>高效存储需求</strong>：</p><ul><li>云服务对存储成本有严格控制，需在保证性能的前提下降低存储开销。例如，ABase 缓存系统要求 <strong>存储空间开销不超过6%</strong>。</li></ul></li><li><p><strong>低尾延迟需求</strong>：</p><ul><li>在线事务处理（OLTP）和缓存服务对 <strong>P99.99延迟</strong> 有严格限制，传统存储引擎在高并发场景下难以满足。</li></ul></li></ol><hr><h2 id=lavastore-关键优化点-1>LavaStore 关键优化点</h2><h3 id=1-lavakv解耦式-kv-分离方案>1. <strong>LavaKV：解耦式 KV 分离方案</strong></h3><p>LavaKV 通过以下创新解决 RocksDB 的写入放大问题：</p><ul><li><strong>GC 与压缩解耦</strong>：允许独立执行 Blob GC，避免传统方案中 GC 依赖 SSTable 压缩的瓶颈，使写入性能提升 <strong>30%+</strong>。</li><li><strong>Crit-bit Tree 索引</strong>：采用空间占用更小的 CBT 替代 Hash Index，索引体积减少 <strong>40%</strong>，缓存命中率提升 <strong>18%</strong>。</li><li><strong>动态 GC 策略</strong>：基于磁盘使用率（如阈值超过70%时触发 GC）自适应调整回收频率，平衡 WAF 与存储利用率。</li></ul><h3 id=2-lavalogwal-专用引擎>2. <strong>LavaLog：WAL 专用引擎</strong></h3><ul><li><strong>写放大优化</strong>：针对 Write-Ahead Logging 设计轻量日志结构，WAF 从 RocksDB 的 <strong>≈2</strong> 降至接近 <strong>1</strong>。</li><li><strong>并行 GC 机制</strong>：通过时间窗口划分实现日志分段回收，GC 延迟降低 <strong>65%</strong>。</li></ul><h3 id=3-lavafs用户态文件系统>3. <strong>LavaFS：用户态文件系统</strong></h3><ul><li><strong>元数据优化</strong>：采用轻量级日志机制替代 Ext4 的完整元数据写入，同步写入 WAF 从 <strong>6.7</strong> 降至 <strong>1</strong>。</li><li><strong>I/O 路径缩短</strong>：绕过内核态文件系统，直接管理裸设备，fsync 延迟减少 <strong>80%</strong>。</li></ul><hr><h2 id=lavastore-生产环境表现>LavaStore 生产环境表现</h2><h3 id=1-数据库vedbbytendb>1. <strong>数据库（veDB/ByteNDB）</strong></h3><ul><li>平均写入延迟降低 <strong>61%</strong>（从 12ms 降至 4.7ms）</li><li>读取延迟降低 <strong>16%</strong>（从 3.2ms 降至 2.7ms）</li><li>总体 WAF 降低 <strong>24%</strong></li></ul><h3 id=2-缓存系统abase>2. <strong>缓存系统（ABase）</strong></h3><ul><li>写入 QPS 提升 <strong>87%</strong>（峰值达 120万 QPS）</li><li>P99 写入延迟降低 <strong>38%</strong>（从 45ms 降至 28ms）</li><li>存储成本减少 <strong>46%</strong>（通过混部资源优化）</li></ul><h3 id=3-流处理flink>3. <strong>流处理（Flink）</strong></h3><ul><li>CPU 使用率降低 <strong>67%</strong>（归因于 LavaFS 的零拷贝优化）</li><li>数据存储占用减少 <strong>15%</strong>（基于 CBT 索引压缩）</li></ul><hr><h2 id=未来方向与行业启示>未来方向与行业启示</h2><ol><li><p><strong>硬件协同优化</strong>：</p><ul><li>探索 <strong>ZNS SSDs</strong> 的 Zone 特性与 LavaKV GC 策略结合，进一步降低 WAF。</li><li>集成 <strong>SPDK</strong> 加速用户态 I/O 栈，目标将 fsync 延迟压缩至 <strong>10μs 级</strong>。</li></ul></li><li><p><strong>跨层 GC 协同</strong>：</p><ul><li>联合 SSD 控制器实现 <strong>物理块回收提示</strong>，减少 SSD 内部 GC 开销。</li></ul></li><li><p><strong>学术价值</strong>：</p><ul><li>LavaStore 的模块化设计（KV 分离、专用 WAL、用户态 FS）为工业界提供了 <strong>&ldquo;定向优化+通用兼容&rdquo;</strong> 的范式，相关论文已被 VLDB 2024 收录。</li></ul></li></ol><hr><h2 id=总结-1>总结</h2><p>LavaStore 通过 <strong>垂直解耦</strong>（GC 与压缩分离）、<strong>水平定制</strong>（WAL 专用引擎）和 <strong>底层重构</strong>（用户态 FS）的三层优化，在写入性能、存储效率和尾延迟控制上均取得突破。其设计哲学表明：<strong>在通用存储引擎无法满足极端场景需求时，针对性地改造关键子系统，能以较低成本实现显著收益</strong>。</p><dl><dt>对于从业者而言，LavaStore 的实践验证了以下公式的可行性：</dt><dt>$$ \text{系统优化收益} = \sum (\text{模块定制化增益}) - \text{兼容性代价} $$</dt><dt>未来，随着存储硬件与软件栈的深度协同，此类定向优化方案或将成为云基础设施的标配。</dt><dd><p>字节跳动基础架构团队. LavaStore: ByteDance’s Purpose-built, High-performance, Cost-effective Local Storage Engine for Cloud Services. VLDB 2024.</p></dd></dl><p>如果你对 LavaStore 或类似存储引擎的优化有更多见解，欢迎留言交流！</p></section></main><footer id=main-footer><div class=footer><a href=#></a><div class=footer-copyright><div class=dim>© 2025</div><div></div></div></div></footer></div><aside id=side-pane class=side-sticky><div class=side-details><span>2904 </span><span>8 - 10</span></div><h3></h3><nav id=TableOfContents><ul><li><a href=#引言>引言</a></li><li><a href=#lavastore-设计背景与挑战>LavaStore 设计背景与挑战</a></li><li><a href=#lavastore-关键优化点>LavaStore 关键优化点</a><ul><li><a href=#1-lavakv独立的-kv-分离方案>1. <strong>LavaKV：独立的 KV 分离方案</strong></a></li><li><a href=#2-lavalog针对-wal-工作负载的优化>2. <strong>LavaLog：针对 WAL 工作负载的优化</strong></a></li><li><a href=#3-lavafs自定义的用户态文件系统>3. <strong>LavaFS：自定义的用户态文件系统</strong></a></li></ul></li><li><a href=#lavastore-在生产环境中的应用表现>LavaStore 在生产环境中的应用表现</a></li><li><a href=#未来发展方向>未来发展方向</a></li><li><a href=#总结>总结</a></li><li><a href=#引言-1>引言</a></li><li><a href=#lavastore-设计背景与挑战-1>LavaStore 设计背景与挑战</a></li><li><a href=#lavastore-关键优化点-1>LavaStore 关键优化点</a><ul><li><a href=#1-lavakv解耦式-kv-分离方案>1. <strong>LavaKV：解耦式 KV 分离方案</strong></a></li><li><a href=#2-lavalogwal-专用引擎>2. <strong>LavaLog：WAL 专用引擎</strong></a></li><li><a href=#3-lavafs用户态文件系统>3. <strong>LavaFS：用户态文件系统</strong></a></li></ul></li><li><a href=#lavastore-生产环境表现>LavaStore 生产环境表现</a><ul><li><a href=#1-数据库vedbbytendb>1. <strong>数据库（veDB/ByteNDB）</strong></a></li><li><a href=#2-缓存系统abase>2. <strong>缓存系统（ABase）</strong></a></li><li><a href=#3-流处理flink>3. <strong>流处理（Flink）</strong></a></li></ul></li><li><a href=#未来方向与行业启示>未来方向与行业启示</a></li><li><a href=#总结-1>总结</a></li></ul></nav></aside></div></div></body></html>