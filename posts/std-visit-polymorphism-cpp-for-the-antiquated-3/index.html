<!doctype html><html lang=zh-cn dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Maerlyn's Rainbow</title>
<meta name=keywords content><meta name=description content="Date: 2025-1-4
Title: std::visit实现运行时多态 - C++ for the Antiquated（之三）
Tags: cpp, modern cpp
Slug: std-visit-polymorphism-cpp-for-the-antiquated-3
在传统的 C++ 中，运行时多态 通常依赖于 “接口 - 虚函数” 机制，通过抽象类、具体类与对象的设计来实现。这种多态方式通常被称为 子类型多态（Subtype Polymorphism）。"><meta name=author content="wizmann"><link rel=canonical href=https://wizmann.top/posts/std-visit-polymorphism-cpp-for-the-antiquated-3/><link crossorigin=anonymous href=/assets/css/stylesheet.f49d66caae9ea0fd43f21f29e71a8d3e284517ed770f2aa86fa012953ad3c9ef.css integrity="sha256-9J1myq6eoP1D8h8p5xqNPihFF+13Dyqob6ASlTrTye8=" rel="preload stylesheet" as=style><link rel=icon href=https://wizmann.top/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://wizmann.top/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://wizmann.top/favicon-32x32.png><link rel=apple-touch-icon href=https://wizmann.top/apple-touch-icon.png><link rel=mask-icon href=https://wizmann.top/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh-cn href=https://wizmann.top/posts/std-visit-polymorphism-cpp-for-the-antiquated-3/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://wizmann.top/posts/std-visit-polymorphism-cpp-for-the-antiquated-3/"><meta property="og:site_name" content="Maerlyn's Rainbow"><meta property="og:title" content="Maerlyn's Rainbow"><meta property="og:description" content="Date: 2025-1-4 Title: std::visit实现运行时多态 - C++ for the Antiquated（之三） Tags: cpp, modern cpp Slug: std-visit-polymorphism-cpp-for-the-antiquated-3
在传统的 C++ 中，运行时多态 通常依赖于 “接口 - 虚函数” 机制，通过抽象类、具体类与对象的设计来实现。这种多态方式通常被称为 子类型多态（Subtype Polymorphism）。"><meta property="og:locale" content="zh-CN"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta name=twitter:card content="summary"><meta name=twitter:title content><meta name=twitter:description content="Date: 2025-1-4
Title: std::visit实现运行时多态 - C++ for the Antiquated（之三）
Tags: cpp, modern cpp
Slug: std-visit-polymorphism-cpp-for-the-antiquated-3
在传统的 C++ 中，运行时多态 通常依赖于 “接口 - 虚函数” 机制，通过抽象类、具体类与对象的设计来实现。这种多态方式通常被称为 子类型多态（Subtype Polymorphism）。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://wizmann.top/posts/"},{"@type":"ListItem","position":2,"name":"","item":"https://wizmann.top/posts/std-visit-polymorphism-cpp-for-the-antiquated-3/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"","name":"","description":"Date: 2025-1-4 Title: std::visit实现运行时多态 - C++ for the Antiquated（之三） Tags: cpp, modern cpp Slug: std-visit-polymorphism-cpp-for-the-antiquated-3\n在传统的 C++ 中，运行时多态 通常依赖于 “接口 - 虚函数” 机制，通过抽象类、具体类与对象的设计来实现。这种多态方式通常被称为 子类型多态（Subtype Polymorphism）。\n","keywords":[],"articleBody":"Date: 2025-1-4 Title: std::visit实现运行时多态 - C++ for the Antiquated（之三） Tags: cpp, modern cpp Slug: std-visit-polymorphism-cpp-for-the-antiquated-3\n在传统的 C++ 中，运行时多态 通常依赖于 “接口 - 虚函数” 机制，通过抽象类、具体类与对象的设计来实现。这种多态方式通常被称为 子类型多态（Subtype Polymorphism）。\n在之前的文章中，我们介绍了现代 C++ 引入的 std::variant —— 一种类型安全的联合体，以及如何借助 std::visit 在类型安全的前提下，动态地访问联合体中的不同类型，并执行相应的逻辑。这种多态方式被称为 临时多态（Ad-hoc Polymorphism）。\n除此之外，还有一种被称为 参数化多态（Parametric Polymorphism），即我们熟知的 C++ 模板。它允许我们编写与类型无关的代码，提供更强的泛型编程能力。由于本篇文章的重点并不在此，我们暂且不展开。\n在本篇文章中，我们将重点对比 子类型多态 和 临时多态 的优劣，分析它们在实际场景中的应用与权衡，希望能更好地理解和选择合适的多态机制。\n临时多态的实现原理 临时多态（Ad-hoc Polymorphism）与 子类型多态（Subtype Polymorphism）在实现原理上有一定的相似性：它们都依赖于在类型中引入额外的信息来决定不同类型应执行的函数逻辑。\n子类型多态：依赖于虚表（vtable） 和 虚指针（vptr），通过运行时的动态分派来确定调用哪个派生类的成员函数。 临时多态：依赖一个 枚举值（enum） 来表示类型信息，通过显式的 switch-case 或 if-else 语句来选择不同的逻辑分支。 简单示例：模拟 std::visit 这里只使用了传统C++的实现，关于std::visit的更详细的解读，可以参考本系列的“动手实现std::visit”一文。\n#include #include #include enum EType : uint8_t { TYPE_Int = 0, TYPE_Float = 1, TYPE_String = 2, }; struct MyVariant { EType type; void* obj; }; void MyVisitor(MyVariant\u0026 var) { switch (var.type) { case TYPE_Int: std::cout \u003c\u003c \"Int: \" \u003c\u003c *(int*)var.obj \u003c\u003c std::endl; break; case TYPE_Float: std::cout \u003c\u003c \"Float: \" \u003c\u003c *(float*)var.obj \u003c\u003c std::endl; break; case TYPE_String: std::cout \u003c\u003c \"String: \" \u003c\u003c *(std::string*)var.obj \u003c\u003c std::endl; break; default: assert(false \u0026\u0026 \"Unknown type!\"); break; } } int main() { int i = 42; float f = 3.14f; std::string s = \"Hello\"; MyVariant var1 = {TYPE_Int, \u0026i}; MyVariant var2 = {TYPE_Float, \u0026f}; MyVariant var3 = {TYPE_String, \u0026s}; MyVisitor(var1); MyVisitor(var2); MyVisitor(var3); return 0; } 原理解析 EType 枚举 定义了一个枚举类型 EType，用于标识 MyVariant 当前存储的具体类型。 MyVariant 结构体 type 字段保存当前对象的类型信息。 obj 字段是一个通用指针，指向实际存储的数据对象。 MyVisitor 函数 通过 switch-case 语句，基于 type 字段选择不同的分支逻辑来访问和打印不同类型的数据。 如果遇到未知类型，程序会触发 assert 以防止未定义行为。 性能优化思考 在实际应用中，switch-case 语句可能随着类型数量的增加而导致性能开销。可以通过二分查找（Binary Search）方法进行优化，减少 switch-case 的分支深度。\n临时多态的性能分析 虚函数常因其较低的性能而受到批评。为了更好地了解这一点，我们将对比使用虚函数实现的“子类型多态”和通过 std::visit 实现的“临时多态”在性能上的差异。\n使用虚函数实现的代码 使用std::visit + std::variant 实现的代码 使用std::visit + std::variant 实现的代码 结果如下：\n# # T T # T T # T T o o o o o o 使 使 t t 使 t t 使 t t 用 用 a a 用 a a 用 a a g 虚 l l s l l s l l + 函 t t + 数 O V d O V d O V 实 b i : b i : b i 现 j s : j s : j s - e i v e i v e i s c t i c t i c t t t s t s t d T i T i T = C i t C i t C i c r m r m r m + e e + e e + e e + a : a : a : 1 t s t s t 7 i 6 t i 5 t i 6 o . d o . d o . - n 9 : n 9 : n 0 O 9 : 3 : 5 2 T v T v T 编 i m a i m a i m 译 m s r m s r m s 运 e i e i e 行 : a : a : n n 5 t 2 t 5 5 \u003c 6 \u003c 2 . o . p . 5 b 8 t 1 3 j 8 r 5 e \u003e m c m 实 m s t s 现 s \u003e 实 现 结果分析 内存管理开销： 使用虚函数的子类型多态实现通常需要动态申请和释放内存，从而引入了额外的内存管理开销。而使用基于 std::variant的临时多态可以一次性分配所有内存，虽然可能存在一定程度的内存浪费，但避免了频繁的动态内存管理。 性能接近，std::visit 略优： 虽然虚函数和 std::visit 的性能差距不大，但 std::visit 略微优于虚函数。两者都引入了额外的开销以实现多态。 通过临时多态实现Vistor模式 Visitor模式是一种行为设计模式，用于将数据结构的操作与数据结构本身分离。它通常通过“子类型多态”来实现，其中每个具体类型的对象都接受一个访问者（Visitor）并对其进行相应的处理。使用虚函数和继承是实现这一模式的一种方式，但有时我们可以用更轻量的方式来实现，比如通过临时多态结合 std::variant 和 std::visit。\n使用虚函数实现Visitor模式 我们首先来看一个传统的通过子类型多态实现Visitor模式的例子：\nstruct IVisitor; struct IResource { virtual void accept(IVisitor* visitor) = 0; }; struct IVisitor { virtual void visit(IResource* res) = 0; }; class MyResource : public IResource { public: void accept(IVisitor* visitor) override { visitor-\u003evisit(this); } }; class MyVisitor : public IVisitor { public: void visit(IResource* res) override { // 处理资源 } }; 这种实现方式虽然能很好地分离数据和操作，但它也有一些不足之处：\n每次调用 visit 都需要通过虚函数来间接调用方法，这会引入额外的性能开销。 visitor 无法在 visit 时直接获取资源对象的类型信息，通常需要额外传递类型信息或者让资源类暴露更多的接口。 使用 std::visit 实现Visitor模式 通过 std::visit 和 std::variant，我们可以显式地通过类型信息来处理每种资源类型，避免了虚函数调用的开销，同时使得代码更加简洁和类型安全。下面是一个通过临时多态实现Visitor模式的例子：\nusing ResourceUnion = std::variant\u003cResourceA, ResourceB, ResourceC\u003e; std::vector\u003cResourceUnion\u003e resources; for (auto\u0026 res : resources) { std::visit([](auto\u0026 res) { using T = std::decay_t\u003cdecltype(res)\u003e; if constexpr (std::is_same_v\u003cT, ResourceA\u003e) { // 处理类型为 ResourceA 的资源 } else if constexpr (std::is_same_v\u003cT, ResourceB\u003e) { // 处理类型为 ResourceB 的资源 } else if constexpr (std::is_same_v\u003cT, ResourceC\u003e) { // 处理类型为 ResourceC 的资源 } else { static_assert(always_false_v\u003c\u003e, \"Unhandled type!\"); } }, res); } 优点与分析 类型安全： 使用 std::visit 时，编译器可以根据类型推断并为每种类型生成不同的代码路径，从而避免了运行时错误和类型错误，提升了类型安全性。\n性能： 由于不再依赖虚函数，std::visit 能避免每次调用 visit 时的虚函数开销，从而提高了性能。\n简洁性： 通过 std::variant 和 std::visit，代码更加简洁且不需要繁琐的继承结构。每个资源类型只需关注其自身的实现，而无需处理不同访问者的逻辑。\n扩展性： 如果要新增资源类型，只需在 std::variant 中添加新类型，并在 std::visit 的 lambda 表达式中添加对应的分支，避免了修改现有代码的风险。\n临时多态的优点与缺点 优点： 类型安全：std::variant 与 std::visit 确保了类型安全，避免了许多传统多态机制中的错误。 性能优化：相较于虚函数，std::visit 通过类型折叠和编译时分支优化，通常表现出更好的性能，尤其在没有动态内存管理时。 自由组织功能函数：你可以灵活地将功能函数组织在一个地方，而无需修改每个具体类型。 缺点： 职责分散：每个类型的行为都可能分散到多个visit函数中，导致代码难以维护。 高耦合风险：当新增类型时，所有访问逻辑需要修改，可能带来较高的耦合度，尤其在类型较多时。 参考 C++20高级编程（罗能） —— 1.6 运行时多态 深入理解面向对象中的多态 C++ 访问者模式讲解和代码示例 ","wordCount":"2699","inLanguage":"zh-cn","datePublished":"0001-01-01T00:00:00Z","dateModified":"0001-01-01T00:00:00Z","author":{"@type":"Person","name":"wizmann"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://wizmann.top/posts/std-visit-polymorphism-cpp-for-the-antiquated-3/"},"publisher":{"@type":"Organization","name":"Maerlyn's Rainbow","logo":{"@type":"ImageObject","url":"https://wizmann.top/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://wizmann.top/ accesskey=h title="Maerlyn's Rainbow (Alt + H)">Maerlyn's Rainbow</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent"></h1><div class=post-meta>wizmann</div></header><div class=post-content><p>Date: 2025-1-4
Title: std::visit实现运行时多态 - C++ for the Antiquated（之三）
Tags: cpp, modern cpp
Slug: std-visit-polymorphism-cpp-for-the-antiquated-3</p><p>在传统的 <strong>C++</strong> 中，<strong>运行时多态</strong> 通常依赖于 <strong>“接口 - 虚函数”</strong> 机制，通过抽象类、具体类与对象的设计来实现。这种多态方式通常被称为 <strong>子类型多态</strong>（<em>Subtype Polymorphism</em>）。</p><p>在之前的文章中，我们介绍了现代 C++ 引入的 <code>std::variant</code> —— 一种类型安全的联合体，以及如何借助 <code>std::visit</code> 在类型安全的前提下，动态地访问联合体中的不同类型，并执行相应的逻辑。这种多态方式被称为 <strong>临时多态</strong>（<em>Ad-hoc Polymorphism</em>）。</p><p>除此之外，还有一种被称为 <strong>参数化多态</strong>（<em>Parametric Polymorphism</em>），即我们熟知的 <strong>C++ 模板</strong>。它允许我们编写与类型无关的代码，提供更强的泛型编程能力。由于本篇文章的重点并不在此，我们暂且不展开。</p><p>在本篇文章中，我们将重点对比 <strong>子类型多态</strong> 和 <strong>临时多态</strong> 的优劣，分析它们在实际场景中的应用与权衡，希望能更好地理解和选择合适的多态机制。</p><h2 id=临时多态的实现原理><strong>临时多态的实现原理</strong><a hidden class=anchor aria-hidden=true href=#临时多态的实现原理>#</a></h2><p><strong>临时多态</strong>（<em>Ad-hoc Polymorphism</em>）与 <strong>子类型多态</strong>（<em>Subtype Polymorphism</em>）在实现原理上有一定的相似性：它们都依赖于在类型中引入额外的信息来决定不同类型应执行的函数逻辑。</p><ul><li><strong>子类型多态</strong>：依赖于<strong>虚表（vtable）</strong> 和 <strong>虚指针（vptr）</strong>，通过运行时的动态分派来确定调用哪个派生类的成员函数。</li><li><strong>临时多态</strong>：依赖一个 <strong>枚举值（enum）</strong> 来表示类型信息，通过显式的 <code>switch-case</code> 或 <code>if-else</code> 语句来选择不同的逻辑分支。</li></ul><h3 id=简单示例模拟-stdvisit><strong>简单示例：模拟 std::visit</strong><a hidden class=anchor aria-hidden=true href=#简单示例模拟-stdvisit>#</a></h3><blockquote><p>这里只使用了传统C++的实现，关于<code>std::visit</code>的更详细的解读，可以参考本系列的“动手实现std::visit”一文。</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;iostream&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;string&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;cassert&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>enum</span> <span style=color:#a6e22e>EType</span> <span style=color:#f92672>:</span> <span style=color:#66d9ef>uint8_t</span> {
</span></span><span style=display:flex><span>    TYPE_Int <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>    TYPE_Float <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>    TYPE_String <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>,
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>MyVariant</span> {
</span></span><span style=display:flex><span>    EType type;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>void</span><span style=color:#f92672>*</span> obj;
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>MyVisitor</span>(MyVariant<span style=color:#f92672>&amp;</span> var) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>switch</span> (var.type) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> TYPE_Int: 
</span></span><span style=display:flex><span>            std<span style=color:#f92672>::</span>cout <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#34;Int: &#34;</span> <span style=color:#f92672>&lt;&lt;</span> <span style=color:#f92672>*</span>(<span style=color:#66d9ef>int</span><span style=color:#f92672>*</span>)var.obj <span style=color:#f92672>&lt;&lt;</span> std<span style=color:#f92672>::</span>endl;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> TYPE_Float:
</span></span><span style=display:flex><span>            std<span style=color:#f92672>::</span>cout <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#34;Float: &#34;</span> <span style=color:#f92672>&lt;&lt;</span> <span style=color:#f92672>*</span>(<span style=color:#66d9ef>float</span><span style=color:#f92672>*</span>)var.obj <span style=color:#f92672>&lt;&lt;</span> std<span style=color:#f92672>::</span>endl;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> TYPE_String:
</span></span><span style=display:flex><span>            std<span style=color:#f92672>::</span>cout <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#34;String: &#34;</span> <span style=color:#f92672>&lt;&lt;</span> <span style=color:#f92672>*</span>(std<span style=color:#f92672>::</span>string<span style=color:#f92672>*</span>)var.obj <span style=color:#f92672>&lt;&lt;</span> std<span style=color:#f92672>::</span>endl;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>            assert(false <span style=color:#f92672>&amp;&amp;</span> <span style=color:#e6db74>&#34;Unknown type!&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>42</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>float</span> f <span style=color:#f92672>=</span> <span style=color:#ae81ff>3.14f</span>;
</span></span><span style=display:flex><span>    std<span style=color:#f92672>::</span>string s <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Hello&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    MyVariant var1 <span style=color:#f92672>=</span> {TYPE_Int, <span style=color:#f92672>&amp;</span>i};
</span></span><span style=display:flex><span>    MyVariant var2 <span style=color:#f92672>=</span> {TYPE_Float, <span style=color:#f92672>&amp;</span>f};
</span></span><span style=display:flex><span>    MyVariant var3 <span style=color:#f92672>=</span> {TYPE_String, <span style=color:#f92672>&amp;</span>s};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    MyVisitor(var1);
</span></span><span style=display:flex><span>    MyVisitor(var2);
</span></span><span style=display:flex><span>    MyVisitor(var3);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=原理解析><strong>原理解析</strong><a hidden class=anchor aria-hidden=true href=#原理解析>#</a></h3><ol><li><strong>EType 枚举</strong><ul><li>定义了一个枚举类型 <code>EType</code>，用于标识 <code>MyVariant</code> 当前存储的具体类型。</li></ul></li><li><strong>MyVariant 结构体</strong><ul><li><code>type</code> 字段保存当前对象的类型信息。</li><li><code>obj</code> 字段是一个通用指针，指向实际存储的数据对象。</li></ul></li><li><strong>MyVisitor 函数</strong><ul><li>通过 <code>switch-case</code> 语句，基于 <code>type</code> 字段选择不同的分支逻辑来访问和打印不同类型的数据。</li><li>如果遇到未知类型，程序会触发 <code>assert</code> 以防止未定义行为。</li></ul></li></ol><h3 id=性能优化思考><strong>性能优化思考</strong><a hidden class=anchor aria-hidden=true href=#性能优化思考>#</a></h3><p>在实际应用中，<code>switch-case</code> 语句可能随着类型数量的增加而导致性能开销。可以通过二分查找（Binary Search）方法进行优化，减少 <code>switch-case</code> 的分支深度。</p><h2 id=临时多态的性能分析>临时多态的性能分析<a hidden class=anchor aria-hidden=true href=#临时多态的性能分析>#</a></h2><p>虚函数常因其较低的性能而受到批评。为了更好地了解这一点，我们将对比使用虚函数实现的“子类型多态”和通过 <code>std::visit</code> 实现的“临时多态”在性能上的差异。</p><ul><li>使用虚函数实现的<a href=https://gist.github.com/Wizmann/df65af6d214c3b4ae296363839477b94>代码</a></li><li>使用<code>std::visit</code> + <code>std::variant&lt;object></code> 实现的<a href=https://gist.github.com/Wizmann/f1494312a8e0cf30b97e9d8580fa9d6d>代码</a></li><li>使用<code>std::visit</code> + <code>std::variant&lt;ptr></code> 实现的<a href=https://gist.github.com/Wizmann/a25708bcd732df8f6e3d158f7105b6c9>代码</a></li></ul><p>结果如下：</p><div class="goat svg-container"><svg font-family="Menlo,Lucida Console,monospace" viewBox="0 0 320 217"><g transform="translate(8,16)"><path d="M64 0h8" fill="none" stroke="currentcolor"/><text text-anchor="middle" x="0" y="4" fill="currentcolor" style="font-size:1em">#</text><text text-anchor="middle" x="0" y="36" fill="currentcolor" style="font-size:1em">#</text><text text-anchor="middle" x="0" y="52" fill="currentcolor" style="font-size:1em">T</text><text text-anchor="middle" x="0" y="68" fill="currentcolor" style="font-size:1em">T</text><text text-anchor="middle" x="0" y="100" fill="currentcolor" style="font-size:1em">#</text><text text-anchor="middle" x="0" y="116" fill="currentcolor" style="font-size:1em">T</text><text text-anchor="middle" x="0" y="132" fill="currentcolor" style="font-size:1em">T</text><text text-anchor="middle" x="0" y="164" fill="currentcolor" style="font-size:1em">#</text><text text-anchor="middle" x="0" y="180" fill="currentcolor" style="font-size:1em">T</text><text text-anchor="middle" x="0" y="196" fill="currentcolor" style="font-size:1em">T</text><text text-anchor="middle" x="8" y="52" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="8" y="68" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="8" y="116" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="8" y="132" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="8" y="180" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="8" y="196" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="16" y="4" fill="currentcolor" style="font-size:1em">使</text><text text-anchor="middle" x="16" y="36" fill="currentcolor" style="font-size:1em">使</text><text text-anchor="middle" x="16" y="52" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="16" y="68" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="16" y="100" fill="currentcolor" style="font-size:1em">使</text><text text-anchor="middle" x="16" y="116" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="16" y="132" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="16" y="164" fill="currentcolor" style="font-size:1em">使</text><text text-anchor="middle" x="16" y="180" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="16" y="196" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="24" y="4" fill="currentcolor" style="font-size:1em">用</text><text text-anchor="middle" x="24" y="36" fill="currentcolor" style="font-size:1em">用</text><text text-anchor="middle" x="24" y="52" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="24" y="68" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="24" y="100" fill="currentcolor" style="font-size:1em">用</text><text text-anchor="middle" x="24" y="116" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="24" y="132" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="24" y="164" fill="currentcolor" style="font-size:1em">用</text><text text-anchor="middle" x="24" y="180" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="24" y="196" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="32" y="4" fill="currentcolor" style="font-size:1em">g</text><text text-anchor="middle" x="32" y="36" fill="currentcolor" style="font-size:1em">虚</text><text text-anchor="middle" x="32" y="52" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="32" y="68" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="32" y="100" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="32" y="116" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="32" y="132" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="32" y="164" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="32" y="180" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="32" y="196" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="40" y="4" fill="currentcolor" style="font-size:1em">+</text><text text-anchor="middle" x="40" y="36" fill="currentcolor" style="font-size:1em">函</text><text text-anchor="middle" x="40" y="100" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="40" y="164" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="48" y="4" fill="currentcolor" style="font-size:1em">+</text><text text-anchor="middle" x="48" y="36" fill="currentcolor" style="font-size:1em">数</text><text text-anchor="middle" x="48" y="52" fill="currentcolor" style="font-size:1em">O</text><text text-anchor="middle" x="48" y="68" fill="currentcolor" style="font-size:1em">V</text><text text-anchor="middle" x="48" y="100" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="48" y="116" fill="currentcolor" style="font-size:1em">O</text><text text-anchor="middle" x="48" y="132" fill="currentcolor" style="font-size:1em">V</text><text text-anchor="middle" x="48" y="164" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="48" y="180" fill="currentcolor" style="font-size:1em">O</text><text text-anchor="middle" x="48" y="196" fill="currentcolor" style="font-size:1em">V</text><text text-anchor="middle" x="56" y="36" fill="currentcolor" style="font-size:1em">实</text><text text-anchor="middle" x="56" y="52" fill="currentcolor" style="font-size:1em">b</text><text text-anchor="middle" x="56" y="68" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="56" y="100" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="56" y="116" fill="currentcolor" style="font-size:1em">b</text><text text-anchor="middle" x="56" y="132" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="56" y="164" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="56" y="180" fill="currentcolor" style="font-size:1em">b</text><text text-anchor="middle" x="56" y="196" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="64" y="36" fill="currentcolor" style="font-size:1em">现</text><text text-anchor="middle" x="64" y="52" fill="currentcolor" style="font-size:1em">j</text><text text-anchor="middle" x="64" y="68" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="64" y="100" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="64" y="116" fill="currentcolor" style="font-size:1em">j</text><text text-anchor="middle" x="64" y="132" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="64" y="164" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="64" y="180" fill="currentcolor" style="font-size:1em">j</text><text text-anchor="middle" x="64" y="196" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="72" y="4" fill="currentcolor" style="font-size:1em">-</text><text text-anchor="middle" x="72" y="52" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="72" y="68" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="72" y="100" fill="currentcolor" style="font-size:1em">v</text><text text-anchor="middle" x="72" y="116" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="72" y="132" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="72" y="164" fill="currentcolor" style="font-size:1em">v</text><text text-anchor="middle" x="72" y="180" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="72" y="196" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="80" y="4" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="80" y="52" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="80" y="68" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="80" y="100" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="80" y="116" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="80" y="132" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="80" y="164" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="80" y="180" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="80" y="196" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="88" y="4" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="88" y="52" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="88" y="100" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="88" y="116" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="88" y="164" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="88" y="180" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="96" y="4" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="96" y="68" fill="currentcolor" style="font-size:1em">T</text><text text-anchor="middle" x="96" y="100" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="96" y="132" fill="currentcolor" style="font-size:1em">T</text><text text-anchor="middle" x="96" y="164" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="96" y="196" fill="currentcolor" style="font-size:1em">T</text><text text-anchor="middle" x="104" y="4" fill="currentcolor" style="font-size:1em">=</text><text text-anchor="middle" x="104" y="52" fill="currentcolor" style="font-size:1em">C</text><text text-anchor="middle" x="104" y="68" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="104" y="100" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="104" y="116" fill="currentcolor" style="font-size:1em">C</text><text text-anchor="middle" x="104" y="132" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="104" y="164" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="104" y="180" fill="currentcolor" style="font-size:1em">C</text><text text-anchor="middle" x="104" y="196" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="112" y="4" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="112" y="52" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="112" y="68" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="112" y="116" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="112" y="132" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="112" y="180" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="112" y="196" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="120" y="4" fill="currentcolor" style="font-size:1em">+</text><text text-anchor="middle" x="120" y="52" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="120" y="68" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="120" y="100" fill="currentcolor" style="font-size:1em">+</text><text text-anchor="middle" x="120" y="116" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="120" y="132" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="120" y="164" fill="currentcolor" style="font-size:1em">+</text><text text-anchor="middle" x="120" y="180" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="120" y="196" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="128" y="4" fill="currentcolor" style="font-size:1em">+</text><text text-anchor="middle" x="128" y="52" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="128" y="68" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="128" y="116" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="128" y="132" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="128" y="180" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="128" y="196" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="136" y="4" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="136" y="52" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="136" y="100" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="136" y="116" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="136" y="164" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="136" y="180" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="144" y="4" fill="currentcolor" style="font-size:1em">7</text><text text-anchor="middle" x="144" y="52" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="144" y="68" fill="currentcolor" style="font-size:1em">6</text><text text-anchor="middle" x="144" y="100" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="144" y="116" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="144" y="132" fill="currentcolor" style="font-size:1em">5</text><text text-anchor="middle" x="144" y="164" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="144" y="180" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="144" y="196" fill="currentcolor" style="font-size:1em">6</text><text text-anchor="middle" x="152" y="52" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="152" y="68" fill="currentcolor" style="font-size:1em">.</text><text text-anchor="middle" x="152" y="100" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="152" y="116" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="152" y="132" fill="currentcolor" style="font-size:1em">.</text><text text-anchor="middle" x="152" y="164" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="152" y="180" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="152" y="196" fill="currentcolor" style="font-size:1em">.</text><text text-anchor="middle" x="160" y="4" fill="currentcolor" style="font-size:1em">-</text><text text-anchor="middle" x="160" y="52" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="160" y="68" fill="currentcolor" style="font-size:1em">9</text><text text-anchor="middle" x="160" y="100" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="160" y="116" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="160" y="132" fill="currentcolor" style="font-size:1em">9</text><text text-anchor="middle" x="160" y="164" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="160" y="180" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="160" y="196" fill="currentcolor" style="font-size:1em">0</text><text text-anchor="middle" x="168" y="4" fill="currentcolor" style="font-size:1em">O</text><text text-anchor="middle" x="168" y="68" fill="currentcolor" style="font-size:1em">9</text><text text-anchor="middle" x="168" y="100" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="168" y="132" fill="currentcolor" style="font-size:1em">3</text><text text-anchor="middle" x="168" y="164" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="168" y="196" fill="currentcolor" style="font-size:1em">5</text><text text-anchor="middle" x="176" y="4" fill="currentcolor" style="font-size:1em">2</text><text text-anchor="middle" x="176" y="52" fill="currentcolor" style="font-size:1em">T</text><text text-anchor="middle" x="176" y="100" fill="currentcolor" style="font-size:1em">v</text><text text-anchor="middle" x="176" y="116" fill="currentcolor" style="font-size:1em">T</text><text text-anchor="middle" x="176" y="164" fill="currentcolor" style="font-size:1em">v</text><text text-anchor="middle" x="176" y="180" fill="currentcolor" style="font-size:1em">T</text><text text-anchor="middle" x="184" y="4" fill="currentcolor" style="font-size:1em">编</text><text text-anchor="middle" x="184" y="52" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="184" y="68" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="184" y="100" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="184" y="116" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="184" y="132" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="184" y="164" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="184" y="180" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="184" y="196" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="192" y="4" fill="currentcolor" style="font-size:1em">译</text><text text-anchor="middle" x="192" y="52" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="192" y="68" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="192" y="100" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="192" y="116" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="192" y="132" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="192" y="164" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="192" y="180" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="192" y="196" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="200" y="4" fill="currentcolor" style="font-size:1em">运</text><text text-anchor="middle" x="200" y="52" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="200" y="100" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="200" y="116" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="200" y="164" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="200" y="180" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="208" y="4" fill="currentcolor" style="font-size:1em">行</text><text text-anchor="middle" x="208" y="52" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="208" y="100" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="208" y="116" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="208" y="164" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="208" y="180" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="216" y="100" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="216" y="164" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="224" y="52" fill="currentcolor" style="font-size:1em">5</text><text text-anchor="middle" x="224" y="100" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="224" y="116" fill="currentcolor" style="font-size:1em">2</text><text text-anchor="middle" x="224" y="164" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="224" y="180" fill="currentcolor" style="font-size:1em">5</text><text text-anchor="middle" x="232" y="52" fill="currentcolor" style="font-size:1em">5</text><text text-anchor="middle" x="232" y="100" fill="currentcolor" style="font-size:1em">&lt;</text><text text-anchor="middle" x="232" y="116" fill="currentcolor" style="font-size:1em">6</text><text text-anchor="middle" x="232" y="164" fill="currentcolor" style="font-size:1em">&lt;</text><text text-anchor="middle" x="232" y="180" fill="currentcolor" style="font-size:1em">2</text><text text-anchor="middle" x="240" y="52" fill="currentcolor" style="font-size:1em">.</text><text text-anchor="middle" x="240" y="100" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="240" y="116" fill="currentcolor" style="font-size:1em">.</text><text text-anchor="middle" x="240" y="164" fill="currentcolor" style="font-size:1em">p</text><text text-anchor="middle" x="240" y="180" fill="currentcolor" style="font-size:1em">.</text><text text-anchor="middle" x="248" y="52" fill="currentcolor" style="font-size:1em">5</text><text text-anchor="middle" x="248" y="100" fill="currentcolor" style="font-size:1em">b</text><text text-anchor="middle" x="248" y="116" fill="currentcolor" style="font-size:1em">8</text><text text-anchor="middle" x="248" y="164" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="248" y="180" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="256" y="52" fill="currentcolor" style="font-size:1em">3</text><text text-anchor="middle" x="256" y="100" fill="currentcolor" style="font-size:1em">j</text><text text-anchor="middle" x="256" y="116" fill="currentcolor" style="font-size:1em">8</text><text text-anchor="middle" x="256" y="164" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="256" y="180" fill="currentcolor" style="font-size:1em">5</text><text text-anchor="middle" x="264" y="100" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="264" y="164" fill="currentcolor" style="font-size:1em">></text><text text-anchor="middle" x="272" y="52" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="272" y="100" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="272" y="116" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="272" y="164" fill="currentcolor" style="font-size:1em">实</text><text text-anchor="middle" x="272" y="180" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="280" y="52" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="280" y="100" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="280" y="116" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="280" y="164" fill="currentcolor" style="font-size:1em">现</text><text text-anchor="middle" x="280" y="180" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="288" y="100" fill="currentcolor" style="font-size:1em">></text><text text-anchor="middle" x="296" y="100" fill="currentcolor" style="font-size:1em">实</text><text text-anchor="middle" x="304" y="100" fill="currentcolor" style="font-size:1em">现</text></g></svg></div><h3 id=结果分析>结果分析<a hidden class=anchor aria-hidden=true href=#结果分析>#</a></h3><ul><li>内存管理开销：
使用虚函数的子类型多态实现通常需要动态申请和释放内存，从而引入了额外的内存管理开销。而使用基于 <code>std::variant&lt;object></code>的临时多态可以一次性分配所有内存，虽然可能存在一定程度的内存浪费，但避免了频繁的动态内存管理。</li><li>性能接近，<code>std::visit</code> 略优：
虽然虚函数和 <code>std::visit</code> 的性能差距不大，但 <code>std::visit</code> 略微优于虚函数。两者都引入了额外的开销以实现多态。</li></ul><h2 id=通过临时多态实现vistor模式>通过临时多态实现Vistor模式<a hidden class=anchor aria-hidden=true href=#通过临时多态实现vistor模式>#</a></h2><p>Visitor模式是一种行为设计模式，用于将数据结构的操作与数据结构本身分离。它通常通过“子类型多态”来实现，其中每个具体类型的对象都接受一个访问者（Visitor）并对其进行相应的处理。使用虚函数和继承是实现这一模式的一种方式，但有时我们可以用更轻量的方式来实现，比如通过临时多态结合 <code>std::variant</code> 和 <code>std::visit</code>。</p><h3 id=使用虚函数实现visitor模式>使用虚函数实现Visitor模式<a hidden class=anchor aria-hidden=true href=#使用虚函数实现visitor模式>#</a></h3><p>我们首先来看一个传统的通过子类型多态实现Visitor模式的例子：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>IVisitor</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>IResource</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>virtual</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>accept</span>(IVisitor<span style=color:#f92672>*</span> visitor) <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>IVisitor</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>virtual</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>visit</span>(IResource<span style=color:#f92672>*</span> res) <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MyResource</span> <span style=color:#f92672>:</span> <span style=color:#66d9ef>public</span> IResource {
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>void</span> accept(IVisitor<span style=color:#f92672>*</span> visitor) <span style=color:#66d9ef>override</span> {
</span></span><span style=display:flex><span>        visitor<span style=color:#f92672>-&gt;</span>visit(<span style=color:#66d9ef>this</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MyVisitor</span> <span style=color:#f92672>:</span> <span style=color:#66d9ef>public</span> IVisitor {
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>void</span> visit(IResource<span style=color:#f92672>*</span> res) <span style=color:#66d9ef>override</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 处理资源
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    }
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>这种实现方式虽然能很好地分离数据和操作，但它也有一些不足之处：</p><ul><li>每次调用 <code>visit</code> 都需要通过虚函数来间接调用方法，这会引入额外的性能开销。</li><li><code>visitor</code> 无法在 <code>visit</code> 时直接获取资源对象的类型信息，通常需要额外传递类型信息或者让资源类暴露更多的接口。</li></ul><h3 id=使用-stdvisit-实现visitor模式>使用 <code>std::visit</code> 实现Visitor模式<a hidden class=anchor aria-hidden=true href=#使用-stdvisit-实现visitor模式>#</a></h3><p>通过 <code>std::visit</code> 和 <code>std::variant</code>，我们可以显式地通过类型信息来处理每种资源类型，避免了虚函数调用的开销，同时使得代码更加简洁和类型安全。下面是一个通过临时多态实现Visitor模式的例子：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>using</span> ResourceUnion <span style=color:#f92672>=</span> std<span style=color:#f92672>::</span>variant<span style=color:#f92672>&lt;</span>ResourceA, ResourceB, ResourceC<span style=color:#f92672>&gt;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>std<span style=color:#f92672>::</span>vector<span style=color:#f92672>&lt;</span>ResourceUnion<span style=color:#f92672>&gt;</span> resources;
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>auto</span><span style=color:#f92672>&amp;</span> res : resources) {
</span></span><span style=display:flex><span>    std<span style=color:#f92672>::</span>visit([](<span style=color:#66d9ef>auto</span><span style=color:#f92672>&amp;</span> res) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>using</span> T <span style=color:#f92672>=</span> std<span style=color:#f92672>::</span>decay_t<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>decltype</span>(res)<span style=color:#f92672>&gt;</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>constexpr</span> (std<span style=color:#f92672>::</span>is_same_v<span style=color:#f92672>&lt;</span>T, ResourceA<span style=color:#f92672>&gt;</span>) {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 处理类型为 ResourceA 的资源
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>constexpr</span> (std<span style=color:#f92672>::</span>is_same_v<span style=color:#f92672>&lt;</span>T, ResourceB<span style=color:#f92672>&gt;</span>) {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 处理类型为 ResourceB 的资源
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>constexpr</span> (std<span style=color:#f92672>::</span>is_same_v<span style=color:#f92672>&lt;</span>T, ResourceC<span style=color:#f92672>&gt;</span>) {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 处理类型为 ResourceC 的资源
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>static_assert</span>(always_false_v<span style=color:#f92672>&lt;&gt;</span>, <span style=color:#e6db74>&#34;Unhandled type!&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }, res);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=优点与分析>优点与分析<a hidden class=anchor aria-hidden=true href=#优点与分析>#</a></h3><ol><li><p><strong>类型安全</strong>：
使用 <code>std::visit</code> 时，编译器可以根据类型推断并为每种类型生成不同的代码路径，从而避免了运行时错误和类型错误，提升了类型安全性。</p></li><li><p><strong>性能</strong>：
由于不再依赖虚函数，<code>std::visit</code> 能避免每次调用 <code>visit</code> 时的虚函数开销，从而提高了性能。</p></li><li><p><strong>简洁性</strong>：
通过 <code>std::variant</code> 和 <code>std::visit</code>，代码更加简洁且不需要繁琐的继承结构。每个资源类型只需关注其自身的实现，而无需处理不同访问者的逻辑。</p></li><li><p><strong>扩展性</strong>：
如果要新增资源类型，只需在 <code>std::variant</code> 中添加新类型，并在 <code>std::visit</code> 的 lambda 表达式中添加对应的分支，避免了修改现有代码的风险。</p></li></ol><h2 id=临时多态的优点与缺点>临时多态的优点与缺点<a hidden class=anchor aria-hidden=true href=#临时多态的优点与缺点>#</a></h2><h3 id=优点>优点：<a hidden class=anchor aria-hidden=true href=#优点>#</a></h3><ol><li><strong>类型安全</strong>：<code>std::variant</code> 与 <code>std::visit</code> 确保了类型安全，避免了许多传统多态机制中的错误。</li><li><strong>性能优化</strong>：相较于虚函数，<code>std::visit</code> 通过类型折叠和编译时分支优化，通常表现出更好的性能，尤其在没有动态内存管理时。</li><li><strong>自由组织功能函数</strong>：你可以灵活地将功能函数组织在一个地方，而无需修改每个具体类型。</li></ol><h3 id=缺点>缺点：<a hidden class=anchor aria-hidden=true href=#缺点>#</a></h3><ol><li><strong>职责分散</strong>：每个类型的行为都可能分散到多个<code>visit</code>函数中，导致代码难以维护。</li><li><strong>高耦合风险</strong>：当新增类型时，所有访问逻辑需要修改，可能带来较高的耦合度，尤其在类型较多时。</li></ol><h2 id=参考>参考<a hidden class=anchor aria-hidden=true href=#参考>#</a></h2><ul><li>C++20高级编程（罗能） —— 1.6 运行时多态</li><li><a href=https://wiyi.org/polymorphism-in-java.html>深入理解面向对象中的多态</a></li><li><a href=https://refactoringguru.cn/design-patterns/visitor/cpp/example>C++ 访问者模式讲解和代码示例</a></li></ul></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=prev href=https://wizmann.top/posts/std-visit-cpp-for-the-antiquated-2/><span class=title>«</span><br><span></span>
</a><a class=next href=https://wizmann.top/posts/steve-yegge-interview-checklist/><span class=title>»</span><br><span></span></a></nav></footer><div id=disqus_thread></div><script>(function(){var e=document,t=e.createElement("script");t.src="https://wizmann.disqus.com/embed.js",t.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(t)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript></article></main><footer class=footer><span>&copy; 2025 <a href=https://wizmann.top/>Maerlyn's Rainbow</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>