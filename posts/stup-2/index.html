<!doctype html><html lang=zh-cn dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>STUP - Packet Structure and State Machine (2) | Maerlyn's Rainbow</title>
<meta name=keywords content="STUP,TCP,UDP,networking,protocol"><meta name=description content="STUP Packet Structure
Brief Introduction of TCP & UDP Packet Structure

STUP pretend itself as a protocol at the Transmission Layer, but actually it&rsquo;s absolutely an Application Layer protocol. So before we start, I&rsquo;d like to recall some knowledge of two important Transmission Layer protocol: TCP & UDP.
It is well known that TCP is a &ldquo;connection-oriented&rdquo;, &ldquo;reliable&rdquo;, &ldquo;ordered&rdquo;. To make an analogy (a little bit inappropriate), TCP is like a phone call (good cell signal strength):"><meta name=author content="wizmann"><link rel=canonical href=https://wizmann.top/posts/stup-2/><link crossorigin=anonymous href=/assets/css/stylesheet.f49d66caae9ea0fd43f21f29e71a8d3e284517ed770f2aa86fa012953ad3c9ef.css integrity="sha256-9J1myq6eoP1D8h8p5xqNPihFF+13Dyqob6ASlTrTye8=" rel="preload stylesheet" as=style><link rel=icon href=https://wizmann.top/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://wizmann.top/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://wizmann.top/favicon-32x32.png><link rel=apple-touch-icon href=https://wizmann.top/apple-touch-icon.png><link rel=mask-icon href=https://wizmann.top/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh-cn href=https://wizmann.top/posts/stup-2/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-2X5NE9PX0B"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-2X5NE9PX0B")</script><meta property="og:url" content="https://wizmann.top/posts/stup-2/"><meta property="og:site_name" content="Maerlyn's Rainbow"><meta property="og:title" content="STUP - Packet Structure and State Machine (2)"><meta property="og:description" content="STUP Packet Structure Brief Introduction of TCP & UDP Packet Structure STUP pretend itself as a protocol at the Transmission Layer, but actually it’s absolutely an Application Layer protocol. So before we start, I’d like to recall some knowledge of two important Transmission Layer protocol: TCP & UDP.
It is well known that TCP is a “connection-oriented”, “reliable”, “ordered”. To make an analogy (a little bit inappropriate), TCP is like a phone call (good cell signal strength):"><meta property="og:locale" content="zh-CN"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2017-05-04T00:53:03+00:00"><meta property="article:modified_time" content="2017-05-04T00:53:03+00:00"><meta property="article:tag" content="STUP"><meta property="article:tag" content="TCP"><meta property="article:tag" content="UDP"><meta property="article:tag" content="Networking"><meta property="article:tag" content="Protocol"><meta name=twitter:card content="summary"><meta name=twitter:title content="STUP - Packet Structure and State Machine (2)"><meta name=twitter:description content="STUP Packet Structure
Brief Introduction of TCP & UDP Packet Structure

STUP pretend itself as a protocol at the Transmission Layer, but actually it&rsquo;s absolutely an Application Layer protocol. So before we start, I&rsquo;d like to recall some knowledge of two important Transmission Layer protocol: TCP & UDP.
It is well known that TCP is a &ldquo;connection-oriented&rdquo;, &ldquo;reliable&rdquo;, &ldquo;ordered&rdquo;. To make an analogy (a little bit inappropriate), TCP is like a phone call (good cell signal strength):"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://wizmann.top/posts/"},{"@type":"ListItem","position":2,"name":"STUP - Packet Structure and State Machine (2)","item":"https://wizmann.top/posts/stup-2/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"STUP - Packet Structure and State Machine (2)","name":"STUP - Packet Structure and State Machine (2)","description":"STUP Packet Structure Brief Introduction of TCP \u0026amp; UDP Packet Structure STUP pretend itself as a protocol at the Transmission Layer, but actually it\u0026rsquo;s absolutely an Application Layer protocol. So before we start, I\u0026rsquo;d like to recall some knowledge of two important Transmission Layer protocol: TCP \u0026amp; UDP.\nIt is well known that TCP is a \u0026ldquo;connection-oriented\u0026rdquo;, \u0026ldquo;reliable\u0026rdquo;, \u0026ldquo;ordered\u0026rdquo;. To make an analogy (a little bit inappropriate), TCP is like a phone call (good cell signal strength):\n","keywords":["STUP","TCP","UDP","networking","protocol"],"articleBody":"STUP Packet Structure Brief Introduction of TCP \u0026 UDP Packet Structure STUP pretend itself as a protocol at the Transmission Layer, but actually it’s absolutely an Application Layer protocol. So before we start, I’d like to recall some knowledge of two important Transmission Layer protocol: TCP \u0026 UDP.\nIt is well known that TCP is a “connection-oriented”, “reliable”, “ordered”. To make an analogy (a little bit inappropriate), TCP is like a phone call (good cell signal strength):\nyou are keeping a connection your words and sentences are well-received and well-ordered As a result, each TCP packet has a unique and ordered sequence number, and your partner has to reply an “ACK” (short of “ACKnowledgement”) when it receive a packet. And it has to keep a connection and control the flow, a lot of control header is added to the header, so as the “window size”.\nIn a word, TCP is a heavy-weight protocol which offers high reliability. But the performance is highly depend on the network condition.\nUDP is on the other way around, it’s “connectionless”, “unreliable” and “unordered”. To make another analogy, UDP is like a SMS message:\nthere is no connection there is no guarantee that your partner will receive the message there is no guarantee of the order of messages, espiecially on a bad network UDP is a lightweight protocol who doesn’t care about the connection and reliability, it just does it best to serve. And, of course, the performance is better than TCP.\nSTUP Packet Structure \u0026 Why? As I mentioned before, the only problem for me in TCP is the flow control. But that part is deep in the kernel, it is unnecessarily complicated to hack the kernel, a user application is good enough here for me.\nSo, I build STUP over UDP to make everything simple. Firstly, UDP is a commonly used and well-known protocol, we can take advantages of existing infrastructure, framwork and libs. Secondly, UDP is lightweighted protocol, the overhead to build a new protocol over it is almost nothing.\nThe chart above shows STUP packet structure. And the bits in green are plain-text and the others in red are encrypted.\nRandom IV (16bits): plain text, used to assemble the encrypt key Version (3 bits): for compatibility use, currently is “000” Nonce (6 bits): indicate the length of random trail padding data, used for data confusion URG (1 bit): urgent flag, internal use LIV (1 bit): keep-alive flag ACK (1 bit): acknowledgement flag PSH (1 bit): temporarily prohibit nagle algorithm for this packet RST (1 bit): reset flag SYN (1 bit): sync flag FIN (1 bit): finalize flag Seq number (32 bits): same as TCP Ack number (32 bits): same as TCP The structure of STUP packet is quite similar to TCP packet, because we are imitating TCP, literally.\nData obfuscation of STUP packets One of the most important part of STUP protocol is obfuscation. We try to hide our intend of the network traffic to bypass the G*W. Except obfuscate the data, we also need to hide some patterns, for example, the handshack process, ack mechanism, etc.\nThe first step is encryption, of course. It can help us the hide the feature inside data, for example, the pattern of a HTTP request can be easily detected. We use AES-ECB to encrypt the content of our packet.\nBut why AES-ECB? There are a lot of saying on the internet that AES-ECB sucks, because it leaks plaintext data patterns.\nIt is because we ecrypt the STUP packet as a whole, it means there is no way to get the sequence number to order the packets before we decrypt it. As a solution, we add a “random IV” as a plain text in the STUP header. So the key to ecrypt is a combination of 48 bits pre-defined key and 16 bits random key. It might lead to a risk of small key space, but actually it’s more than enough to keep out traffic safe as we are not VIP who worth a brute force hacking.\nAnd still, there is another problem that we can’t hide the length information of our packet with a symmetric encryption. The solution is to append random padding bytes at the tail of every packets for data obfuscation, and use the nonce field to mark the length of the paddings, then enrypt it. When receiver get the packets, firstly decrypt the packet, then drop the useless padding bytes and get the real data.\nSTUP State Machine STUP state machine is also a simplify TCP state machine. And, in essence, they behave exactly the same.\nWhat’s next? In next blog (maybe the last one for STUP series), we will talk about some details about the implementation, and future plan for this protocol.\n","wordCount":"792","inLanguage":"zh-cn","datePublished":"2017-05-04T00:53:03Z","dateModified":"2017-05-04T00:53:03Z","author":{"@type":"Person","name":"wizmann"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://wizmann.top/posts/stup-2/"},"publisher":{"@type":"Organization","name":"Maerlyn's Rainbow","logo":{"@type":"ImageObject","url":"https://wizmann.top/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://wizmann.top/ accesskey=h title="Maerlyn's Rainbow (Alt + H)">Maerlyn's Rainbow</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">STUP - Packet Structure and State Machine (2)</h1><div class=post-meta><span title='2017-05-04 00:53:03 +0000 UTC'>May 4, 2017</span>&nbsp;·&nbsp;wizmann</div></header><div class=post-content><h2 id=stup-packet-structure>STUP Packet Structure<a hidden class=anchor aria-hidden=true href=#stup-packet-structure>#</a></h2><h3 id=brief-introduction-of-tcp--udp-packet-structure>Brief Introduction of TCP & UDP Packet Structure<a hidden class=anchor aria-hidden=true href=#brief-introduction-of-tcp--udp-packet-structure>#</a></h3><p><img loading=lazy src=https://github.com/Wizmann/assets/raw/master/wizmann-pic/17-4-24/73808256-file_1493006773118_a335.png></p><p>STUP pretend itself as a protocol at the Transmission Layer, but actually it&rsquo;s absolutely an Application Layer protocol. So before we start, I&rsquo;d like to recall some knowledge of two important Transmission Layer protocol: TCP & UDP.</p><p>It is well known that TCP is a &ldquo;connection-oriented&rdquo;, &ldquo;reliable&rdquo;, &ldquo;ordered&rdquo;. To make an analogy (a little bit inappropriate), TCP is like a phone call (good cell signal strength):</p><ol><li>you are keeping a connection</li><li>your words and sentences are well-received and well-ordered</li></ol><p>As a result, each TCP packet has a unique and ordered sequence number, and your partner has to reply an &ldquo;ACK&rdquo; (short of &ldquo;ACKnowledgement&rdquo;) when it receive a packet. And it has to keep a connection and control the flow, a lot of control header is added to the header, so as the &ldquo;window size&rdquo;.</p><p>In a word, TCP is a heavy-weight protocol which offers high reliability. But the performance is highly depend on the network condition.</p><p>UDP is on the other way around, it&rsquo;s &ldquo;connectionless&rdquo;, &ldquo;unreliable&rdquo; and &ldquo;unordered&rdquo;. To make another analogy, UDP is like a SMS message:</p><ol><li>there is no connection</li><li>there is no guarantee that your partner will receive the message</li><li>there is no guarantee of the order of messages, espiecially on a bad network</li></ol><p>UDP is a lightweight protocol who doesn&rsquo;t care about the connection and reliability, it just does it best to serve. And, of course, the performance is better than TCP.</p><h3 id=stup-packet-structure--why>STUP Packet Structure & Why?<a hidden class=anchor aria-hidden=true href=#stup-packet-structure--why>#</a></h3><p>As I mentioned before, the only problem for me in TCP is the flow control. But that part is deep in the kernel, it is unnecessarily complicated to hack the kernel, a user application is good enough here for me.</p><p>So, I build STUP over UDP to make everything simple. Firstly, UDP is a commonly used and well-known protocol, we can take advantages of existing infrastructure, framwork and libs. Secondly, UDP is lightweighted protocol, the overhead to build a new protocol over it is almost nothing.</p><p><img loading=lazy src=https://github.com/Wizmann/assets/raw/master/wizmann-pic/17-5-2/38201062-file_1493708415970_dc40.png></p><p>The chart above shows STUP packet structure. And the bits in green are plain-text and the others in red are encrypted.</p><ul><li>Random IV (16bits): plain text, used to assemble the encrypt key</li><li>Version (3 bits): for compatibility use, currently is &ldquo;000&rdquo;</li><li>Nonce (6 bits): indicate the length of random trail padding data, used for data confusion</li><li>URG (1 bit): urgent flag, internal use</li><li>LIV (1 bit): keep-alive flag</li><li>ACK (1 bit): acknowledgement flag</li><li>PSH (1 bit): temporarily prohibit nagle algorithm for this packet</li><li>RST (1 bit): reset flag</li><li>SYN (1 bit): sync flag</li><li>FIN (1 bit): finalize flag</li><li>Seq number (32 bits): same as TCP</li><li>Ack number (32 bits): same as TCP</li></ul><p>The structure of STUP packet is quite similar to TCP packet, because we are imitating TCP, literally.</p><h3 id=data-obfuscation-of-stup-packets>Data obfuscation of STUP packets<a hidden class=anchor aria-hidden=true href=#data-obfuscation-of-stup-packets>#</a></h3><p>One of the most important part of STUP protocol is obfuscation. We try to hide our intend of the network traffic to bypass the G*W. Except obfuscate the data, we also need to hide some patterns, for example, the handshack process, ack mechanism, etc.</p><p>The first step is encryption, of course. It can help us the hide the feature inside data, for example, the pattern of a HTTP request can be easily detected. We use AES-ECB to encrypt the content of our packet.</p><p>But why AES-ECB? There are a lot of saying on the internet that AES-ECB sucks, because it leaks plaintext data patterns.</p><p><img loading=lazy src=https://github.com/Wizmann/assets/raw/master/wizmann-pic/17-5-2/19737252-file_1493708926479_15add.png></p><p>It is because we ecrypt the STUP packet <strong>as a whole</strong>, it means there is no way to get the sequence number to order the packets before we decrypt it. As a solution, we add a &ldquo;random IV&rdquo; as a plain text in the STUP header. So the key to ecrypt is a combination of 48 bits pre-defined key and 16 bits random key. It might lead to a risk of small key space, but actually it&rsquo;s more than enough to keep out traffic safe as we are not VIP who worth a brute force hacking.</p><p>And still, there is another problem that we can&rsquo;t hide the length information of our packet with a symmetric encryption. The solution is to append random padding bytes at the tail of every packets for data obfuscation, and use the <code>nonce</code> field to mark the length of the paddings, then enrypt it. When receiver get the packets, firstly decrypt the packet, then drop the useless padding bytes and get the real data.</p><h2 id=stup-state-machine>STUP State Machine<a hidden class=anchor aria-hidden=true href=#stup-state-machine>#</a></h2><p><img loading=lazy src=https://github.com/Wizmann/assets/raw/master/wizmann-pic/17-4-24/70104484-file_1493025532333_338c.png></p><p>STUP state machine is also a simplify TCP state machine. And, in essence, they behave exactly the same.</p><h2 id=whats-next>What&rsquo;s next?<a hidden class=anchor aria-hidden=true href=#whats-next>#</a></h2><p>In next blog (maybe the last one for STUP series), we will talk about some details about the implementation, and future plan for this protocol.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://wizmann.top/tags/stup/>STUP</a></li><li><a href=https://wizmann.top/tags/tcp/>TCP</a></li><li><a href=https://wizmann.top/tags/udp/>UDP</a></li><li><a href=https://wizmann.top/tags/networking/>Networking</a></li><li><a href=https://wizmann.top/tags/protocol/>Protocol</a></li></ul><nav class=paginav><a class=prev href=https://wizmann.top/posts/stup-3/><span class=title>«</span><br><span>STUP - the Implementation (3)</span>
</a><a class=next href=https://wizmann.top/posts/stup-1/><span class=title>»</span><br><span>STUP - another (stupid) TCP over UDP protocol (1)</span></a></nav></footer><div id=disqus_thread></div><script>(function(){var e=document,t=e.createElement("script");t.src="https://wizmann.disqus.com/embed.js",t.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(t)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript></article></main><footer class=footer><span>&copy; 2025 <a href=https://wizmann.top/>Maerlyn's Rainbow</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>