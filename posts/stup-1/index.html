<!doctype html><html lang=zh-CN dir=ltr><head><script>window.MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"],["\\[","\\]"]]},svg:{fontCache:"global"}}</script><script defer src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script></head><body class=notransition><div id=container><header id=main-header><div role=navigation aria-label=Main><div class=nav-left><a href=https://wizmann.top/ style=color:inherit>Maerlyn's Rainbow</a></div><div class=nav-right><div style=position:absolute;width:0;height:0><div id=nav-dropdown-menu class=hidden href=#><div class=nav-item><a aria-current=true class=ancestor href=/posts/>Posts</a></div></div></div><a id=nav-dropdown-button href=#><svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M4 6H20M4 12H20M4 18H20" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></a><div id=nav-menu><div class=nav-item><a aria-current=true class=ancestor href=/posts/>Posts</a></div></div><a id=theme-switcher href=#><svg class="light-icon" viewBox="0 0 24 24" fill="none"><path d="M12 3V4m0 16v1M4 12H3M6.31412 6.31412 5.5 5.5m12.1859.81412L18.5 5.5M6.31412 17.69 5.5 18.5001M17.6859 17.69 18.5 18.5001M21 12H20m-4 0c0 2.2091-1.7909 4-4 4-2.20914.0-4-1.7909-4-4 0-2.20914 1.79086-4 4-4 2.2091.0 4 1.79086 4 4z" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg><svg class="dark-icon" viewBox="0 0 24 24" fill="none"><path d="M3.32031 11.6835c0 4.9706 4.02944 9 8.99999 9 3.7872.0 7.028-2.3392 8.3565-5.6515C19.6402 15.4486 18.5059 15.6834 17.3203 15.6834c-4.9706.0-8.99999-4.0294-8.99999-8.99998C8.32031 5.50338 8.55165 4.36259 8.96453 3.32996 5.65605 4.66028 3.32031 7.89912 3.32031 11.6835z" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></a></div></div></header><div class="flex grow"><div id=main-pane><main id=main-content><div class=single-header><ol class=breadcrumbs itemscope itemtype=https://schema.org/BreadcrumbList><li itemprop=itemListElement itemscope itemtype=https://schema.org/ListItem><a itemprop=item href=https://wizmann.top/><span itemprop=name></span>
</a><meta itemprop=position content='1'></li><span>&nbsp»&nbsp</span><li itemprop=itemListElement itemscope itemtype=https://schema.org/ListItem><a itemprop=item href=https://wizmann.top/posts/><span itemprop=name>Posts</span>
</a><meta itemprop=position content='2'></li><span>&nbsp»&nbsp</span></ol><h1>STUP - another (stupid) TCP over UDP protocol (1)</h1><time class=dim datetime=2017-04-20T23:17:45+00:00>April 20, 2017</time><div class=term-container><div class=tag><a href=https://wizmann.top/tags/stup/>#STUP</a></div><div class=tag><a href=https://wizmann.top/tags/tcp/>#tcp</a></div><div class=tag><a href=https://wizmann.top/tags/udp/>#UDP</a></div><div class=tag><a href=https://wizmann.top/tags/networking/>#networking</a></div><div class=tag><a href=https://wizmann.top/tags/protocol/>#protocol</a></div></ol></div><section class=page-section><h2 id=what-is-stup>What is STUP?</h2><p>STUP is the abbreviation of &ldquo;Speeded/Secure Tcp-like Udp Protocol&rdquo;, which means that it&rsquo;s another TCP over UDP protocol.</p><p>Why TCP over UDP?</p><p>TCP is a network protocol for general purpose, and it&rsquo;s one of the most commonly used internet protocol on this planet. It is reliable, ordered and well optimized with decades of efforts.</p><p>But, there&rsquo;s plenty of reasons to replace that protocol for my scenario.</p><ul><li><p><del>Firstly, create my own network protocol is something geeky-nerdy, yep, suits me perfectly.</del></p></li><li><p>Firstly, TCP is not &ldquo;secure&rdquo; (enough to bypass G*W).<br>Of course, it&rsquo;s not TCP&rsquo;s fault, because the security job is for the application layer. But &ldquo;大清自有国情在&rdquo;, we are in urgent need for a secure network protocol to obfuscate our network packet to bypass the firewall to get access to the &ldquo;free internet&rdquo;.<br>Shado*socks is one of the commonly used &ldquo;secure&rdquo; network protocol which based on socks5 proxy protocol and TCP. But still, it has its own problem.</p></li><li><p>Secondly, TCP performs badly on harsh transmission condition.<br>Because of the flow control and congestion control, the sliding window of TCP will be cut into half when packet is lost or timeout, which is very common on a harsh network connection as the jitter is inevitable.<br>It&rsquo;s understandble that TCP has to negotiate the sliding window size with zero knowledge to achieve intra- and inter- protocol fairness, and make a stable network. But for us, we may have enough knowledge for our network, and we may not have too many connections at the same time, so here we don&rsquo;t need control, we need speed. We come up with our own control mechanism - no control is best the control.</p></li></ul><h2 id=how-it-works>How it works?</h2><p><img src=https://github.com/Wizmann/assets/raw/master/wizmann-pic/17-4-20/98249887-file_1492687602713_f658.png alt></p><p>Our local application behavess like a socks5 proxy client, and send its data to a local adapter which will translate socks5 packet into STUP packet. The adapter doesn&rsquo;t need to understand the &ldquo;meaning&rdquo; of socks5 packets, it just take it as a byte-flow, then encapsulate the data into the STUP packet.</p><p>The local STUP client will encrypt the outgoing UDP packet. More precisely, the job of the encryption is to obfuscate the packet to bypass the detector of the G*W. We will talk about this later.</p><p>Then the remote STUP protocol server received the encrypted packet, then it unpack the data and translate it back into the same byte-flow. After that, the socks5 server will get the message and retrieve what we want from the free internet.</p><p>In a word, STUP procotol is a secure tunnel between the socks5 client and socks5 server. This design reduces the complexity of the whole system, and make it easy to implement.</p><h2 id=how-we-implement-it-big-picture>How we implement it? (Big picture)</h2><p>We use Twisted framework to implement our protocol. The good parts of twisted is it hides the details of network programming and turn everything into events. But twisted is aptly named and it is really &ldquo;twisted&rdquo;, especially for the new comers.</p><p>We implemented our simplfied &ldquo;TCP stack&rdquo; with fixed-size sliding window, nagle algorithm, retry mechanism, encrypting, etc. But with the help of Python, one of my favorite programming language &mldr; it&rsquo;s still a complex task to do. And it takes me a year to make it work.</p><p>I say thankya.</p><p><img src=https://github.com/Wizmann/assets/raw/master/wizmann-pic/17-4-20/89638264-file_1492701304939_10484.png alt></p></section></main><footer id=main-footer><div class=footer><a href=#></a><div class=footer-copyright><div class=dim>© 2025</div><div></div></div></div></footer></div><aside id=side-pane class=side-sticky><div class=side-details><span>556 </span><span>3 - 3</span></div><h3></h3><nav id=TableOfContents><ul><li><a href=#what-is-stup>What is STUP?</a></li><li><a href=#how-it-works>How it works?</a></li><li><a href=#how-we-implement-it-big-picture>How we implement it? (Big picture)</a></li></ul></nav><h3></h3><ul><li><a href=/posts/tlv-protocol/>类型-长度-值（TLV）协议</a></li></ul></aside></div></div></body></html>