<!doctype html><html lang=zh-cn dir=auto><head><script>window.MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"],["\\[","\\]"]]},svg:{fontCache:"global"}}</script><script defer src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://wizmann.top/ accesskey=h title="Maerlyn's Rainbow (Alt + H)">Maerlyn's Rainbow</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">STUP - another (stupid) TCP over UDP protocol (1)</h1><div class=post-meta><span title='2017-04-20 23:17:45 +0000 UTC'>April 20, 2017</span>&nbsp;·&nbsp;wizmann</div></header><div class=post-content><h2 id=what-is-stup>What is STUP?<a hidden class=anchor aria-hidden=true href=#what-is-stup>#</a></h2><p>STUP is the abbreviation of &ldquo;Speeded/Secure Tcp-like Udp Protocol&rdquo;, which means that it&rsquo;s another TCP over UDP protocol.</p><p>Why TCP over UDP?</p><p>TCP is a network protocol for general purpose, and it&rsquo;s one of the most commonly used internet protocol on this planet. It is reliable, ordered and well optimized with decades of efforts.</p><p>But, there&rsquo;s plenty of reasons to replace that protocol for my scenario.</p><ul><li><p><del>Firstly, create my own network protocol is something geeky-nerdy, yep, suits me perfectly.</del></p></li><li><p>Firstly, TCP is not &ldquo;secure&rdquo; (enough to bypass G*W).<br>Of course, it&rsquo;s not TCP&rsquo;s fault, because the security job is for the application layer. But &ldquo;大清自有国情在&rdquo;, we are in urgent need for a secure network protocol to obfuscate our network packet to bypass the firewall to get access to the &ldquo;free internet&rdquo;.<br>Shado*socks is one of the commonly used &ldquo;secure&rdquo; network protocol which based on socks5 proxy protocol and TCP. But still, it has its own problem.</p></li><li><p>Secondly, TCP performs badly on harsh transmission condition.<br>Because of the flow control and congestion control, the sliding window of TCP will be cut into half when packet is lost or timeout, which is very common on a harsh network connection as the jitter is inevitable.<br>It&rsquo;s understandble that TCP has to negotiate the sliding window size with zero knowledge to achieve intra- and inter- protocol fairness, and make a stable network. But for us, we may have enough knowledge for our network, and we may not have too many connections at the same time, so here we don&rsquo;t need control, we need speed. We come up with our own control mechanism - no control is best the control.</p></li></ul><h2 id=how-it-works>How it works?<a hidden class=anchor aria-hidden=true href=#how-it-works>#</a></h2><p><img loading=lazy src=https://github.com/Wizmann/assets/raw/master/wizmann-pic/17-4-20/98249887-file_1492687602713_f658.png></p><p>Our local application behavess like a socks5 proxy client, and send its data to a local adapter which will translate socks5 packet into STUP packet. The adapter doesn&rsquo;t need to understand the &ldquo;meaning&rdquo; of socks5 packets, it just take it as a byte-flow, then encapsulate the data into the STUP packet.</p><p>The local STUP client will encrypt the outgoing UDP packet. More precisely, the job of the encryption is to obfuscate the packet to bypass the detector of the G*W. We will talk about this later.</p><p>Then the remote STUP protocol server received the encrypted packet, then it unpack the data and translate it back into the same byte-flow. After that, the socks5 server will get the message and retrieve what we want from the free internet.</p><p>In a word, STUP procotol is a secure tunnel between the socks5 client and socks5 server. This design reduces the complexity of the whole system, and make it easy to implement.</p><h2 id=how-we-implement-it-big-picture>How we implement it? (Big picture)<a hidden class=anchor aria-hidden=true href=#how-we-implement-it-big-picture>#</a></h2><p>We use Twisted framework to implement our protocol. The good parts of twisted is it hides the details of network programming and turn everything into events. But twisted is aptly named and it is really &ldquo;twisted&rdquo;, especially for the new comers.</p><p>We implemented our simplfied &ldquo;TCP stack&rdquo; with fixed-size sliding window, nagle algorithm, retry mechanism, encrypting, etc. But with the help of Python, one of my favorite programming language &mldr; it&rsquo;s still a complex task to do. And it takes me a year to make it work.</p><p>I say thankya.</p><p><img loading=lazy src=https://github.com/Wizmann/assets/raw/master/wizmann-pic/17-4-20/89638264-file_1492701304939_10484.png></p></div><footer class=post-footer><ul class=post-tags><li><a href=https://wizmann.top/tags/stup/>STUP</a></li><li><a href=https://wizmann.top/tags/tcp/>TCP</a></li><li><a href=https://wizmann.top/tags/udp/>UDP</a></li><li><a href=https://wizmann.top/tags/networking/>Networking</a></li><li><a href=https://wizmann.top/tags/protocol/>Protocol</a></li></ul><nav class=paginav><a class=prev href=https://wizmann.top/posts/stup-2/><span class=title>«</span><br><span>STUP - Packet Structure and State Machine (2)</span>
</a><a class=next href=https://wizmann.top/posts/workflowymd/><span class=title>»</span><br><span>WorkflowyMd Release Note</span></a></nav></footer><div id=disqus_thread></div><script>(function(){var e=document,t=e.createElement("script");t.src="https://wizmann.disqus.com/embed.js",t.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(t)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript></article></main><footer class=footer><span>&copy; 2025 <a href=https://wizmann.top/>Maerlyn's Rainbow</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>