<!doctype html><html lang=zh-cn dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Maerlyn's Rainbow</title>
<meta name=keywords content><meta name=description content="Date: 2019-05-02 21:33:00
Title: 6.824 Lab 2: Raft协议实现指南 （无剧透版）
Tags: raft, 分布式系统
Slug: raft-lab-mit-6.824
背景
MIT6.824是一个用来学习分布式系统的非常好的资源。其中第二个课程作业就是关于Raft算法。"><meta name=author content="wizmann"><link rel=canonical href=https://wizmann.top/posts/raft-lab-mit-6/><link crossorigin=anonymous href=/assets/css/stylesheet.f49d66caae9ea0fd43f21f29e71a8d3e284517ed770f2aa86fa012953ad3c9ef.css integrity="sha256-9J1myq6eoP1D8h8p5xqNPihFF+13Dyqob6ASlTrTye8=" rel="preload stylesheet" as=style><link rel=icon href=https://wizmann.top/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://wizmann.top/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://wizmann.top/favicon-32x32.png><link rel=apple-touch-icon href=https://wizmann.top/apple-touch-icon.png><link rel=mask-icon href=https://wizmann.top/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh-cn href=https://wizmann.top/posts/raft-lab-mit-6/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://wizmann.top/posts/raft-lab-mit-6/"><meta property="og:site_name" content="Maerlyn's Rainbow"><meta property="og:title" content="Maerlyn's Rainbow"><meta property="og:description" content="Date: 2019-05-02 21:33:00 Title: 6.824 Lab 2: Raft协议实现指南 （无剧透版） Tags: raft, 分布式系统 Slug: raft-lab-mit-6.824
背景 MIT6.824是一个用来学习分布式系统的非常好的资源。其中第二个课程作业就是关于Raft算法。"><meta property="og:locale" content="zh-CN"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta name=twitter:card content="summary"><meta name=twitter:title content><meta name=twitter:description content="Date: 2019-05-02 21:33:00
Title: 6.824 Lab 2: Raft协议实现指南 （无剧透版）
Tags: raft, 分布式系统
Slug: raft-lab-mit-6.824
背景
MIT6.824是一个用来学习分布式系统的非常好的资源。其中第二个课程作业就是关于Raft算法。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://wizmann.top/posts/"},{"@type":"ListItem","position":2,"name":"","item":"https://wizmann.top/posts/raft-lab-mit-6/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"","name":"","description":"Date: 2019-05-02 21:33:00 Title: 6.824 Lab 2: Raft协议实现指南 （无剧透版） Tags: raft, 分布式系统 Slug: raft-lab-mit-6.824\n背景 MIT6.824是一个用来学习分布式系统的非常好的资源。其中第二个课程作业就是关于Raft算法。\n","keywords":[],"articleBody":"Date: 2019-05-02 21:33:00 Title: 6.824 Lab 2: Raft协议实现指南 （无剧透版） Tags: raft, 分布式系统 Slug: raft-lab-mit-6.824\n背景 MIT6.824是一个用来学习分布式系统的非常好的资源。其中第二个课程作业就是关于Raft算法。\n由于在工作中涉及到分布一致性算法的调研，接触了paxos/raft算法。然后被@neutronest安利了一发，于是开始着手实现这个作业。\n本文是我对这个项目的实现总结。希望能在划出重点的同时，不涉及实现细节，避免破坏大家的写代码体验。\n本文唯一参考资料：In Search of an Understandable Consensus Algorithm\n任务分解 在官方文档里，整个项目被分成了2A、2B、2C三个部分：\n2A - 投票与选举 2B - 一致性 2C - 可持久化 实际上，2C的工作量非常少，我们可以把2B和2C合成一个。然后单独提出几个比较重要的测试用例，划分成子项目。任务分解如下：\n2A - 投票与选举 2B/2C - 一致性和可持久化 三个难度比较高的Case Test (2B): leader backs up quickly over incorrect follower logs 验证协议实现的正确性 Test (2B): RPC counts aren’t too high 测试协议是否产生了过多的RPC请求。验证协议的性能。 Test (2C): Figure 8 (unreliable) 测试在极端混乱的情况下，Raft协议是否能及时恢复正常工作。验证协议实现的正确性和性能。 所以推荐大家按顺序以上顺序进行实现。并且充分利用版本控制对代码进行开发和重构。\n需要关注的知识点 以下会介绍每一个部分需要重点关注的知识点，内容包括golang基础和论文中的知识点，无剧透，请放心食用。\n准备工作 golang是一门傲慢的语言，其标准库的缺乏实在是让人感到TMD蛋疼。但是对于一个课程作业来说，我们也没有必要引入一系列第三方库。所以我们先要扩充util.go文件，使其为我们的开发提供更多的便利。\nLog模块 项目给出的DPrintf函数非常简单，只提供了一个fmt.Printf的封装。并不能打印行号和文件名。这里提供一个扩展版本。\nfunc DPrintf(format string, a ...interface{}) { if Debug \u003e 0 { _, path, lineno, ok := runtime.Caller(1); _, file := filepath.Split(path) if (ok) { t := time.Now(); a = append([]interface{} { t.Format(\"2006-01-02 15:04:05.00\"), file, lineno }, a...); fmt.Printf(\"%s [%s:%d] \" + format + \"\\n\", a...); } } } 其输出示例如下：\n2 0 1 9 - 0 5 - 0 2 0 9 : 2 8 : 3 5 . 0 4 [ r a f t . g o : 6 5 2 ] N o d e [ 1 ] i s p r o c e s s i n g , s t a t e : [ L E A D E R ] , t e r m 1 , c o m m i t I n d e x : 1 2 , l o g C o u n t : 1 2 , l e a d e r 1 Max和Min函数 golang是没有对于int值的max和min函数的，这里省略脏话100句。\nfunc Min(a int, b int) (int) { if a \u003c b { return a; } else { return b; } } func Max(a int, b int) (int) { if a \u003e b { return a; } else { return b; } } Assert函数 是的，你没有看错，golang也没有提供assert函数。如果你嫌到处写if和panic太丑的话，可以使用这个assert函数。\nfunc Assert(flag bool, format string, a ...interface{}) { if (!flag) { _, path, lineno, ok := runtime.Caller(1); _, file := filepath.Split(path) if (ok) { t := time.Now(); a = append([]interface{} { t.Format(\"2006-01-02 15:04:05.00\"), file, lineno }, a...); reason := fmt.Sprintf(\"%s [%s:%d] \" + format + \"\\n\", a...); panic(reason); } else { panic(\"\"); } } } Log Id 为了验证日志的一致性，我们在日志中额外加入一个UUID来进行标识。\ni f } m u p n o c r b _ i } u r t C , f u e r : i t \" e = e e d u m a r r f r r a t m r r m e = n t e a t t h L k : ! . u f u / o e = = P r m u r g ( r n t i a I [ r n i . d n d ] a i n S d ( b n l t p \" ) y d l r t . { n i ( e R ( n u , e \" t u a E f i 1 d r ( d 6 ( r \" ) b o % s ) r X t : - r % i \" X n , - g % ) e X r - { r % ) X - % X \" , b [ 0 : 4 ] , b [ 4 : 6 ] , b [ 6 : 8 ] , b [ 8 : 1 0 ] , b [ 1 0 : ] ) 以上代码可以生成一个（伪）UUID对日志进行标识。推荐使用math/rand，因为这里我们使用伪随机数就够了。\n注：这里的UUID只是看起来像一个UUID，实际上UUID有其特殊的规范与格式。但是由于golang内部没有提供可用的UUID库，所以只好随手模拟了一个。\n文件组织 默认的实现是把所有的东西都写到了raft.go文件里。一个非常大的文件可能会给我们的开发带来负担，所以我的做法是把所有的类声明放到models.go文件里。以避免文件的膨胀。\n锁与defer 在raft实现中，锁可以用来保证在多线程环境下数据的正确性。所以只要在涉及到raft内部状态的变化时，都需要加锁。一个常见的加锁pattern是：\nrf.mu.Lock() // 加锁 defer rf.mu.Lock() // 在函数执行完成后解锁 这里推荐使用defer，因为手动控制锁实现是过于容易出错。但是defer也是有坑的！\n不同于C++的大括号作用域，defer的触发时间是在函数执行完成之后，而并不是退出当前大括号时。这点非常需要注意，否则极易出现死锁。\n如果我们想实现C++中do { ... } while (0);类似的lock guard pattern，可以使用以下实现：\nfunc() { rf.mu.Lock() defer rf.mu.Unlock() // do something here }() 这样一来，在执行完当前lambda之后，就会自动解锁。\n刷新定时器 由于raft算法里面使用了定时器，这里提供一个刷新定时器的golang代码。这样实现是为了每次在刷新的时候，清空定时器中原有的超时时间，以避免混乱。\nfunc (rf *Raft) renewTimer(timeout time.Duration) { if (rf.timer == nil) { rf.timer = time.NewTimer(timeout) } else { if (!rf.timer.Stop()) { select { case \u003c- rf.timer.C: // pass default: // pass } } rf.timer.Reset(timeout) } } 以及，在定时器超时之后，不要忘了更新定时器。\n2A - 投票与选举 所需要类的声明 论文中的Figure2包含了算法中所有的类以及基本算法。在2A中，所有的类都会被用到。由于2A中只包括投票与选举，所以和日志相关的字段可以先忽略掉。\nChecklist for 2A 实现raft状态机的三个状态：leader，follower和candidate 实现RPC函数：sendRequestVote（发送端）和RequestVote（接收端的回调函数） 实现RPC函数：sendAppendEntries（发送端）和AppendEntries（接收端的回调函数） 保证raft状态机的任期号（currentTerm）是单调递增的 一个Follower对于某一个Term只能投出一票 实现Leader心跳，维护当前任期（Term）。 实现Follower选举超时（election timeout） 实现Candidate选举的三种场景 获得多数选票，赢得选举。状态切换为Leader 其它的节点已经被选为Leader。状态切换为Follower 在选举中并未获得多数选票，状态切换为Follower 实现Candidate随机选举超时（randomized election timeout） 2B/2C - 日志复制与持久化 基本工作流 日志复制的基本工作流如下：\nLeader接受用户请求，将状态变化写入本机的日志流中，并且把日志复制到Followers。如果本条日志合法，Followers会将这条日志标记为“提交”（committed），然后再将这条日志“应用”（apply）到Raft协议之外的状态机。Follower在提交日志之后，就可以向Leader回报这条日志已经被提交。在本条日志被多数节点提交之后，Leader再将这条日志标记为提交。此时，用户的请求就可以被确认（ACK）了。\nRaft的论文中，Leader需要维护commitIndex和lastApplied这两个状态。为了简单起见，我们可以忽略“应用”（apply）这个过程。这两个状态我们只需要维护commitIndex即可。\nRaft协议不是2PC，千万不要搞混了哦～\n回滚与滚回来 从上面的工作流我们可以看到，对于已经committed的日志，仍然有可能是不可靠的。\n例如，在Term1时，节点1作业Leader提交到了日志(1, 2)，而Follower节点Node2和Node3分别提交到了日志(1, 2)和(1, 3)。此时Leader短暂断线，出发选举超时，就会进行下一轮的选举。如果节点Node2被选为Leader，那么节点Node3就会被Leader多出一条日志，这是不被允许的。如果节点Node3被选为Leader，那么Node2就比Leader在Term1少一条日志，需要补齐。\n这里有人可能会怀疑，节点2比节点3少一条日志，那么按照论文里的说法，因为节点3的日志比较节点2要多，所以只有节点3才能赢得下一轮选举。这其实是不对的，如果节点3断线，节点1和节点2仍然可以组成一个quorum，选举出Leader。\n所以我们需要考虑将已committed的日志回滚（向左滚），以及缺失的日志补齐（向右滚）。这里其实有一些优化的点，我们后文再说。\n再次注意，保证日志的一致性是Raft协议正确性的必须保证，在这一点上一定要注意。\n乱序请求 本项目中，模拟的RPC协议并不能保证可靠性（会丢包）、有序性（会乱序），也没有SLA（没有超时时间的上限），更不用想拥塞控制。我们可以理解为它在底层使用了UDP协议，而不是TCP。所以我们不能做出任何假设。\n例如，两个请求先后来到Leader端，A请求编号(1,100)，B请求编号(1,110)。然后我们依次将Log复制到Follower端（A先B后），但是在Follower端有可能收到的顺序是B先A后。甚至只收到B，没收到A。这种情况日常工程中的TCP协议下几乎不能发生，但是在测试环境中要十分小心。\nChecklist for 2B/2C 日志的状态会影响Leader选举 如果两份日志流的最后一条日志的Term不一样，那么我们认为Term号大的日志“比较新”。如果Term号一样，那么Index大的日志“比较新” 如果Leader和Follower的日志不一致，那么Follower需要拷贝Leader的日志（向左滚或向右滚的正确性） 这里推荐使用Assert加断言进行保证，如果出错可以获得实时的现场 对于小于当前Term的日志，Leader不需要等多数Follower确认就可以直接commit 一个重要特性：如果两个日志的(Term, Index)一致，那么其内容也是一致的。并且在此日志之前的所有日志都必须是一致的 另一个重要特性：RPC请求是幂等的，也就是多次重复发送一个请求并不会破坏Raft协议的状态 最后的3个Case 最后的三个Case有一个共同点，就是对协议的效率和正确性有比较高的要求。即使前面的代码里你的实现是正确的，也有可能因为各种其它的原因造成Case挂掉。\n建议首先解决正确性问题，再提升效率。\n向左滚的优化（重要！） 在论文的5.3节，介绍了一种回滚的优化。如果Leader和Follower在某个Index上的日志不一致，Leader的版本记为(Term1, Index)，Follower的版本记为(Term2, Index)。那么Follower需要回滚所有日志，直到Term小于Min(Term1, Term2)。\n这样的好处是可以加快回滚的效率。虽然论文上表示这种优化并非必要，但是在模拟出来的极端网络环境下，这样的优化可以帮助我们通过一些比较变态的Case。\n其它的非官方优化 这里还有一些论文里没的提到的优化方案，不保证一定是正确的。\n为了不剧透，放到单独的链接里了：剧透警告！\n还有一个Bonus挑战，谁比较闲可以试一下。\n测试结果 在Travis CI上面运行的测试。自我感觉实现的比较一般，所以你们的程序应该跑的比我快一点才正常。\n总结 想要完整正确的实现这个项目，首先一定要把论文读懂。并且划出实现上应该注意的重点。\n当遇到正确性问题时，一定要回归论文，大部分的问题都可以获得解答。当遇到性能问题时，可以参考作业上面的Hints，里面也有非常有用的信息。\nMIT的这个课程还有基于raft实现kv storage的项目，后续如果有时间应该还会做吧。\n","wordCount":"4535","inLanguage":"zh-cn","datePublished":"0001-01-01T00:00:00Z","dateModified":"0001-01-01T00:00:00Z","author":{"@type":"Person","name":"wizmann"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://wizmann.top/posts/raft-lab-mit-6/"},"publisher":{"@type":"Organization","name":"Maerlyn's Rainbow","logo":{"@type":"ImageObject","url":"https://wizmann.top/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://wizmann.top/ accesskey=h title="Maerlyn's Rainbow (Alt + H)">Maerlyn's Rainbow</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent"></h1><div class=post-meta>wizmann</div></header><div class=post-content><p>Date: 2019-05-02 21:33:00
Title: 6.824 Lab 2: Raft协议实现指南 （无剧透版）
Tags: raft, 分布式系统
Slug: raft-lab-mit-6.824</p><h2 id=背景>背景<a hidden class=anchor aria-hidden=true href=#背景>#</a></h2><p>MIT6.824是一个用来学习分布式系统的非常好的资源。其中第二个课程作业就是关于<a href=https://pdos.csail.mit.edu/6.824/labs/lab-raft.html>Raft算法</a>。</p><p>由于在工作中涉及到分布一致性算法的调研，接触了paxos/raft算法。然后被@neutronest安利了一发，于是开始着手实现这个作业。</p><p>本文是我对这个项目的实现总结。希望能在划出重点的同时，不涉及实现细节，避免破坏大家的写代码体验。</p><p>本文唯一参考资料：<a href=https://raft.github.io/raft.pdf>In Search of an Understandable Consensus Algorithm</a></p><h2 id=任务分解>任务分解<a hidden class=anchor aria-hidden=true href=#任务分解>#</a></h2><p>在官方文档里，整个项目被分成了2A、2B、2C三个部分：</p><ul><li>2A - 投票与选举</li><li>2B - 一致性</li><li>2C - 可持久化</li></ul><p>实际上，2C的工作量非常少，我们可以把2B和2C合成一个。然后单独提出几个比较重要的测试用例，划分成子项目。任务分解如下：</p><ul><li>2A - 投票与选举</li><li>2B/2C - 一致性和可持久化</li><li>三个难度比较高的Case<ul><li>Test (2B): leader backs up quickly over incorrect follower logs<br>验证协议实现的正确性</li><li>Test (2B): RPC counts aren&rsquo;t too high<br>测试协议是否产生了过多的RPC请求。验证协议的性能。</li><li>Test (2C): Figure 8 (unreliable)<br>测试在极端混乱的情况下，Raft协议是否能及时恢复正常工作。验证协议实现的正确性和性能。</li></ul></li></ul><p>所以推荐大家按顺序以上顺序进行实现。并且充分利用版本控制对代码进行开发和重构。</p><h2 id=需要关注的知识点>需要关注的知识点<a hidden class=anchor aria-hidden=true href=#需要关注的知识点>#</a></h2><p>以下会介绍每一个部分需要重点关注的知识点，内容包括golang基础和论文中的知识点，无剧透，请放心食用。</p><h3 id=准备工作>准备工作<a hidden class=anchor aria-hidden=true href=#准备工作>#</a></h3><p>golang是一门傲慢的语言，其标准库的缺乏实在是让人感到TMD蛋疼。但是对于一个课程作业来说，我们也没有必要引入一系列第三方库。所以我们先要扩充<code>util.go</code>文件，使其为我们的开发提供更多的便利。</p><h4 id=log模块>Log模块<a hidden class=anchor aria-hidden=true href=#log模块>#</a></h4><p>项目给出的<code>DPrintf</code>函数非常简单，只提供了一个<code>fmt.Printf</code>的封装。并不能打印行号和文件名。这里提供一个扩展版本。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>DPrintf</span>(<span style=color:#a6e22e>format</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>a</span> <span style=color:#f92672>...</span><span style=color:#66d9ef>interface</span>{}) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>Debug</span> &gt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>path</span>, <span style=color:#a6e22e>lineno</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>Caller</span>(<span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>file</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>filepath</span>.<span style=color:#a6e22e>Split</span>(<span style=color:#a6e22e>path</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>ok</span>) {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>t</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>();
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>a</span> = append([]<span style=color:#66d9ef>interface</span>{} { <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Format</span>(<span style=color:#e6db74>&#34;2006-01-02 15:04:05.00&#34;</span>), <span style=color:#a6e22e>file</span>, <span style=color:#a6e22e>lineno</span> }, <span style=color:#a6e22e>a</span><span style=color:#f92672>...</span>);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;%s [%s:%d] &#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>format</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;\n&#34;</span>, <span style=color:#a6e22e>a</span><span style=color:#f92672>...</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>其输出示例如下：</p><div class="goat svg-container"><svg font-family="Menlo,Lucida Console,monospace" viewBox="0 0 1e3 25"><g transform="translate(8,16)"><text text-anchor="middle" x="0" y="4" fill="currentcolor" style="font-size:1em">2</text><text text-anchor="middle" x="8" y="4" fill="currentcolor" style="font-size:1em">0</text><text text-anchor="middle" x="16" y="4" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="24" y="4" fill="currentcolor" style="font-size:1em">9</text><text text-anchor="middle" x="32" y="4" fill="currentcolor" style="font-size:1em">-</text><text text-anchor="middle" x="40" y="4" fill="currentcolor" style="font-size:1em">0</text><text text-anchor="middle" x="48" y="4" fill="currentcolor" style="font-size:1em">5</text><text text-anchor="middle" x="56" y="4" fill="currentcolor" style="font-size:1em">-</text><text text-anchor="middle" x="64" y="4" fill="currentcolor" style="font-size:1em">0</text><text text-anchor="middle" x="72" y="4" fill="currentcolor" style="font-size:1em">2</text><text text-anchor="middle" x="88" y="4" fill="currentcolor" style="font-size:1em">0</text><text text-anchor="middle" x="96" y="4" fill="currentcolor" style="font-size:1em">9</text><text text-anchor="middle" x="104" y="4" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="112" y="4" fill="currentcolor" style="font-size:1em">2</text><text text-anchor="middle" x="120" y="4" fill="currentcolor" style="font-size:1em">8</text><text text-anchor="middle" x="128" y="4" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="136" y="4" fill="currentcolor" style="font-size:1em">3</text><text text-anchor="middle" x="144" y="4" fill="currentcolor" style="font-size:1em">5</text><text text-anchor="middle" x="152" y="4" fill="currentcolor" style="font-size:1em">.</text><text text-anchor="middle" x="160" y="4" fill="currentcolor" style="font-size:1em">0</text><text text-anchor="middle" x="168" y="4" fill="currentcolor" style="font-size:1em">4</text><text text-anchor="middle" x="184" y="4" fill="currentcolor" style="font-size:1em">[</text><text text-anchor="middle" x="192" y="4" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="200" y="4" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="208" y="4" fill="currentcolor" style="font-size:1em">f</text><text text-anchor="middle" x="216" y="4" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="224" y="4" fill="currentcolor" style="font-size:1em">.</text><text text-anchor="middle" x="232" y="4" fill="currentcolor" style="font-size:1em">g</text><text text-anchor="middle" x="240" y="4" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="248" y="4" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="256" y="4" fill="currentcolor" style="font-size:1em">6</text><text text-anchor="middle" x="264" y="4" fill="currentcolor" style="font-size:1em">5</text><text text-anchor="middle" x="272" y="4" fill="currentcolor" style="font-size:1em">2</text><text text-anchor="middle" x="280" y="4" fill="currentcolor" style="font-size:1em">]</text><text text-anchor="middle" x="296" y="4" fill="currentcolor" style="font-size:1em">N</text><text text-anchor="middle" x="304" y="4" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="312" y="4" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="320" y="4" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="328" y="4" fill="currentcolor" style="font-size:1em">[</text><text text-anchor="middle" x="336" y="4" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="344" y="4" fill="currentcolor" style="font-size:1em">]</text><text text-anchor="middle" x="360" y="4" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="368" y="4" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="384" y="4" fill="currentcolor" style="font-size:1em">p</text><text text-anchor="middle" x="392" y="4" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="400" y="4" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="408" y="4" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="416" y="4" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="424" y="4" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="432" y="4" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="440" y="4" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="448" y="4" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="456" y="4" fill="currentcolor" style="font-size:1em">g</text><text text-anchor="middle" x="464" y="4" fill="currentcolor" style="font-size:1em">,</text><text text-anchor="middle" x="480" y="4" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="488" y="4" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="496" y="4" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="504" y="4" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="512" y="4" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="520" y="4" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="536" y="4" fill="currentcolor" style="font-size:1em">[</text><text text-anchor="middle" x="544" y="4" fill="currentcolor" style="font-size:1em">L</text><text text-anchor="middle" x="552" y="4" fill="currentcolor" style="font-size:1em">E</text><text text-anchor="middle" x="560" y="4" fill="currentcolor" style="font-size:1em">A</text><text text-anchor="middle" x="568" y="4" fill="currentcolor" style="font-size:1em">D</text><text text-anchor="middle" x="576" y="4" fill="currentcolor" style="font-size:1em">E</text><text text-anchor="middle" x="584" y="4" fill="currentcolor" style="font-size:1em">R</text><text text-anchor="middle" x="592" y="4" fill="currentcolor" style="font-size:1em">]</text><text text-anchor="middle" x="600" y="4" fill="currentcolor" style="font-size:1em">,</text><text text-anchor="middle" x="616" y="4" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="624" y="4" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="632" y="4" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="640" y="4" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="656" y="4" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="664" y="4" fill="currentcolor" style="font-size:1em">,</text><text text-anchor="middle" x="680" y="4" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="688" y="4" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="696" y="4" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="704" y="4" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="712" y="4" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="720" y="4" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="728" y="4" fill="currentcolor" style="font-size:1em">I</text><text text-anchor="middle" x="736" y="4" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="744" y="4" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="752" y="4" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="760" y="4" fill="currentcolor" style="font-size:1em">x</text><text text-anchor="middle" x="768" y="4" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="784" y="4" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="792" y="4" fill="currentcolor" style="font-size:1em">2</text><text text-anchor="middle" x="800" y="4" fill="currentcolor" style="font-size:1em">,</text><text text-anchor="middle" x="816" y="4" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="824" y="4" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="832" y="4" fill="currentcolor" style="font-size:1em">g</text><text text-anchor="middle" x="840" y="4" fill="currentcolor" style="font-size:1em">C</text><text text-anchor="middle" x="848" y="4" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="856" y="4" fill="currentcolor" style="font-size:1em">u</text><text text-anchor="middle" x="864" y="4" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="872" y="4" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="880" y="4" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="896" y="4" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="904" y="4" fill="currentcolor" style="font-size:1em">2</text><text text-anchor="middle" x="912" y="4" fill="currentcolor" style="font-size:1em">,</text><text text-anchor="middle" x="928" y="4" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="936" y="4" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="944" y="4" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="952" y="4" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="960" y="4" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="968" y="4" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="984" y="4" fill="currentcolor" style="font-size:1em">1</text></g></svg></div><h4 id=max和min函数>Max和Min函数<a hidden class=anchor aria-hidden=true href=#max和min函数>#</a></h4><p>golang是没有对于int值的<code>max</code>和<code>min</code>函数的，这里省略脏话100句。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Min</span>(<span style=color:#a6e22e>a</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>b</span> <span style=color:#66d9ef>int</span>) (<span style=color:#66d9ef>int</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>a</span> &lt; <span style=color:#a6e22e>b</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>a</span>;
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>b</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Max</span>(<span style=color:#a6e22e>a</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>b</span> <span style=color:#66d9ef>int</span>) (<span style=color:#66d9ef>int</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>a</span> &gt; <span style=color:#a6e22e>b</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>a</span>;
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>b</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=assert函数>Assert函数<a hidden class=anchor aria-hidden=true href=#assert函数>#</a></h4><p>是的，你没有看错，golang也没有提供<code>assert</code>函数。如果你嫌到处写<code>if</code>和<code>panic</code>太丑的话，可以使用这个<code>assert</code>函数。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Assert</span>(<span style=color:#a6e22e>flag</span> <span style=color:#66d9ef>bool</span>, <span style=color:#a6e22e>format</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>a</span> <span style=color:#f92672>...</span><span style=color:#66d9ef>interface</span>{}) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (!<span style=color:#a6e22e>flag</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>path</span>, <span style=color:#a6e22e>lineno</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>Caller</span>(<span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>file</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>filepath</span>.<span style=color:#a6e22e>Split</span>(<span style=color:#a6e22e>path</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>ok</span>) {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>t</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>();
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>a</span> = append([]<span style=color:#66d9ef>interface</span>{} { <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Format</span>(<span style=color:#e6db74>&#34;2006-01-02 15:04:05.00&#34;</span>), <span style=color:#a6e22e>file</span>, <span style=color:#a6e22e>lineno</span> }, <span style=color:#a6e22e>a</span><span style=color:#f92672>...</span>);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>reason</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;%s [%s:%d] &#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>format</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;\n&#34;</span>, <span style=color:#a6e22e>a</span><span style=color:#f92672>...</span>);
</span></span><span style=display:flex><span>            panic(<span style=color:#a6e22e>reason</span>);
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>            panic(<span style=color:#e6db74>&#34;&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=log-id>Log Id<a hidden class=anchor aria-hidden=true href=#log-id>#</a></h4><p>为了验证日志的一致性，我们在日志中额外加入一个UUID来进行标识。</p><div class="goat svg-container"><svg font-family="Menlo,Lucida Console,monospace" viewBox="0 0 656 233"><g transform="translate(8,16)"><text text-anchor="middle" x="0" y="4" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="0" y="36" fill="currentcolor" style="font-size:1em">f</text><text text-anchor="middle" x="0" y="212" fill="currentcolor" style="font-size:1em">}</text><text text-anchor="middle" x="8" y="4" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="8" y="36" fill="currentcolor" style="font-size:1em">u</text><text text-anchor="middle" x="16" y="4" fill="currentcolor" style="font-size:1em">p</text><text text-anchor="middle" x="16" y="36" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="24" y="4" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="24" y="36" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="32" y="4" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="32" y="52" fill="currentcolor" style="font-size:1em">b</text><text text-anchor="middle" x="32" y="68" fill="currentcolor" style="font-size:1em">_</text><text text-anchor="middle" x="32" y="84" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="32" y="132" fill="currentcolor" style="font-size:1em">}</text><text text-anchor="middle" x="32" y="164" fill="currentcolor" style="font-size:1em">u</text><text text-anchor="middle" x="32" y="196" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="40" y="4" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="40" y="36" fill="currentcolor" style="font-size:1em">C</text><text text-anchor="middle" x="40" y="68" fill="currentcolor" style="font-size:1em">,</text><text text-anchor="middle" x="40" y="84" fill="currentcolor" style="font-size:1em">f</text><text text-anchor="middle" x="40" y="164" fill="currentcolor" style="font-size:1em">u</text><text text-anchor="middle" x="40" y="196" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="48" y="36" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="48" y="52" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="48" y="164" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="48" y="196" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="56" y="4" fill="currentcolor" style="font-size:1em">"</text><text text-anchor="middle" x="56" y="36" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="56" y="52" fill="currentcolor" style="font-size:1em">=</text><text text-anchor="middle" x="56" y="68" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="56" y="84" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="56" y="164" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="56" y="196" fill="currentcolor" style="font-size:1em">u</text><text text-anchor="middle" x="64" y="4" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="64" y="36" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="64" y="68" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="64" y="84" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="64" y="100" fill="currentcolor" style="font-size:1em">f</text><text text-anchor="middle" x="64" y="116" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="64" y="196" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="72" y="4" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="72" y="36" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="72" y="52" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="72" y="68" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="72" y="84" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="72" y="100" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="72" y="116" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="72" y="164" fill="currentcolor" style="font-size:1em">=</text><text text-anchor="middle" x="72" y="196" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="80" y="4" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="80" y="36" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="80" y="52" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="80" y="100" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="80" y="116" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="88" y="4" fill="currentcolor" style="font-size:1em">h</text><text text-anchor="middle" x="88" y="36" fill="currentcolor" style="font-size:1em">L</text><text text-anchor="middle" x="88" y="52" fill="currentcolor" style="font-size:1em">k</text><text text-anchor="middle" x="88" y="68" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="88" y="84" fill="currentcolor" style="font-size:1em">!</text><text text-anchor="middle" x="88" y="100" fill="currentcolor" style="font-size:1em">.</text><text text-anchor="middle" x="88" y="116" fill="currentcolor" style="font-size:1em">u</text><text text-anchor="middle" x="88" y="164" fill="currentcolor" style="font-size:1em">f</text><text text-anchor="middle" x="88" y="196" fill="currentcolor" style="font-size:1em">u</text><text text-anchor="middle" x="96" y="4" fill="currentcolor" style="font-size:1em">/</text><text text-anchor="middle" x="96" y="36" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="96" y="52" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="96" y="68" fill="currentcolor" style="font-size:1em">=</text><text text-anchor="middle" x="96" y="84" fill="currentcolor" style="font-size:1em">=</text><text text-anchor="middle" x="96" y="100" fill="currentcolor" style="font-size:1em">P</text><text text-anchor="middle" x="96" y="116" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="96" y="164" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="96" y="196" fill="currentcolor" style="font-size:1em">u</text><text text-anchor="middle" x="104" y="4" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="104" y="36" fill="currentcolor" style="font-size:1em">g</text><text text-anchor="middle" x="104" y="52" fill="currentcolor" style="font-size:1em">(</text><text text-anchor="middle" x="104" y="100" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="104" y="116" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="104" y="164" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="104" y="196" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="112" y="4" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="112" y="36" fill="currentcolor" style="font-size:1em">I</text><text text-anchor="middle" x="112" y="52" fill="currentcolor" style="font-size:1em">[</text><text text-anchor="middle" x="112" y="68" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="112" y="84" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="112" y="100" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="112" y="164" fill="currentcolor" style="font-size:1em">.</text><text text-anchor="middle" x="112" y="196" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="120" y="4" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="120" y="36" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="120" y="52" fill="currentcolor" style="font-size:1em">]</text><text text-anchor="middle" x="120" y="68" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="120" y="84" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="120" y="100" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="120" y="164" fill="currentcolor" style="font-size:1em">S</text><text text-anchor="middle" x="128" y="4" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="128" y="36" fill="currentcolor" style="font-size:1em">(</text><text text-anchor="middle" x="128" y="52" fill="currentcolor" style="font-size:1em">b</text><text text-anchor="middle" x="128" y="68" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="128" y="84" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="128" y="100" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="128" y="164" fill="currentcolor" style="font-size:1em">p</text><text text-anchor="middle" x="136" y="4" fill="currentcolor" style="font-size:1em">"</text><text text-anchor="middle" x="136" y="36" fill="currentcolor" style="font-size:1em">)</text><text text-anchor="middle" x="136" y="52" fill="currentcolor" style="font-size:1em">y</text><text text-anchor="middle" x="136" y="68" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="136" y="100" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="136" y="164" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="144" y="52" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="144" y="68" fill="currentcolor" style="font-size:1em">.</text><text text-anchor="middle" x="144" y="84" fill="currentcolor" style="font-size:1em">{</text><text text-anchor="middle" x="144" y="100" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="144" y="164" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="152" y="36" fill="currentcolor" style="font-size:1em">(</text><text text-anchor="middle" x="152" y="52" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="152" y="68" fill="currentcolor" style="font-size:1em">R</text><text text-anchor="middle" x="152" y="100" fill="currentcolor" style="font-size:1em">(</text><text text-anchor="middle" x="152" y="164" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="160" y="36" fill="currentcolor" style="font-size:1em">u</text><text text-anchor="middle" x="160" y="52" fill="currentcolor" style="font-size:1em">,</text><text text-anchor="middle" x="160" y="68" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="160" y="100" fill="currentcolor" style="font-size:1em">"</text><text text-anchor="middle" x="160" y="164" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="168" y="36" fill="currentcolor" style="font-size:1em">u</text><text text-anchor="middle" x="168" y="68" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="168" y="100" fill="currentcolor" style="font-size:1em">E</text><text text-anchor="middle" x="168" y="164" fill="currentcolor" style="font-size:1em">f</text><text text-anchor="middle" x="176" y="36" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="176" y="52" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="176" y="68" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="176" y="100" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="176" y="164" fill="currentcolor" style="font-size:1em">(</text><text text-anchor="middle" x="184" y="36" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="184" y="52" fill="currentcolor" style="font-size:1em">6</text><text text-anchor="middle" x="184" y="68" fill="currentcolor" style="font-size:1em">(</text><text text-anchor="middle" x="184" y="100" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="184" y="164" fill="currentcolor" style="font-size:1em">"</text><text text-anchor="middle" x="192" y="52" fill="currentcolor" style="font-size:1em">)</text><text text-anchor="middle" x="192" y="68" fill="currentcolor" style="font-size:1em">b</text><text text-anchor="middle" x="192" y="100" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="192" y="164" fill="currentcolor" style="font-size:1em">%</text><text text-anchor="middle" x="200" y="36" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="200" y="68" fill="currentcolor" style="font-size:1em">)</text><text text-anchor="middle" x="200" y="100" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="200" y="164" fill="currentcolor" style="font-size:1em">X</text><text text-anchor="middle" x="208" y="36" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="208" y="100" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="208" y="164" fill="currentcolor" style="font-size:1em">-</text><text text-anchor="middle" x="216" y="36" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="216" y="164" fill="currentcolor" style="font-size:1em">%</text><text text-anchor="middle" x="224" y="36" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="224" y="100" fill="currentcolor" style="font-size:1em">"</text><text text-anchor="middle" x="224" y="164" fill="currentcolor" style="font-size:1em">X</text><text text-anchor="middle" x="232" y="36" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="232" y="100" fill="currentcolor" style="font-size:1em">,</text><text text-anchor="middle" x="232" y="164" fill="currentcolor" style="font-size:1em">-</text><text text-anchor="middle" x="240" y="36" fill="currentcolor" style="font-size:1em">g</text><text text-anchor="middle" x="240" y="164" fill="currentcolor" style="font-size:1em">%</text><text text-anchor="middle" x="248" y="36" fill="currentcolor" style="font-size:1em">)</text><text text-anchor="middle" x="248" y="100" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="248" y="164" fill="currentcolor" style="font-size:1em">X</text><text text-anchor="middle" x="256" y="100" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="256" y="164" fill="currentcolor" style="font-size:1em">-</text><text text-anchor="middle" x="264" y="36" fill="currentcolor" style="font-size:1em">{</text><text text-anchor="middle" x="264" y="100" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="264" y="164" fill="currentcolor" style="font-size:1em">%</text><text text-anchor="middle" x="272" y="100" fill="currentcolor" style="font-size:1em">)</text><text text-anchor="middle" x="272" y="164" fill="currentcolor" style="font-size:1em">X</text><text text-anchor="middle" x="280" y="164" fill="currentcolor" style="font-size:1em">-</text><text text-anchor="middle" x="288" y="164" fill="currentcolor" style="font-size:1em">%</text><text text-anchor="middle" x="296" y="164" fill="currentcolor" style="font-size:1em">X</text><text text-anchor="middle" x="304" y="164" fill="currentcolor" style="font-size:1em">"</text><text text-anchor="middle" x="312" y="164" fill="currentcolor" style="font-size:1em">,</text><text text-anchor="middle" x="328" y="164" fill="currentcolor" style="font-size:1em">b</text><text text-anchor="middle" x="336" y="164" fill="currentcolor" style="font-size:1em">[</text><text text-anchor="middle" x="344" y="164" fill="currentcolor" style="font-size:1em">0</text><text text-anchor="middle" x="352" y="164" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="360" y="164" fill="currentcolor" style="font-size:1em">4</text><text text-anchor="middle" x="368" y="164" fill="currentcolor" style="font-size:1em">]</text><text text-anchor="middle" x="376" y="164" fill="currentcolor" style="font-size:1em">,</text><text text-anchor="middle" x="392" y="164" fill="currentcolor" style="font-size:1em">b</text><text text-anchor="middle" x="400" y="164" fill="currentcolor" style="font-size:1em">[</text><text text-anchor="middle" x="408" y="164" fill="currentcolor" style="font-size:1em">4</text><text text-anchor="middle" x="416" y="164" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="424" y="164" fill="currentcolor" style="font-size:1em">6</text><text text-anchor="middle" x="432" y="164" fill="currentcolor" style="font-size:1em">]</text><text text-anchor="middle" x="440" y="164" fill="currentcolor" style="font-size:1em">,</text><text text-anchor="middle" x="456" y="164" fill="currentcolor" style="font-size:1em">b</text><text text-anchor="middle" x="464" y="164" fill="currentcolor" style="font-size:1em">[</text><text text-anchor="middle" x="472" y="164" fill="currentcolor" style="font-size:1em">6</text><text text-anchor="middle" x="480" y="164" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="488" y="164" fill="currentcolor" style="font-size:1em">8</text><text text-anchor="middle" x="496" y="164" fill="currentcolor" style="font-size:1em">]</text><text text-anchor="middle" x="504" y="164" fill="currentcolor" style="font-size:1em">,</text><text text-anchor="middle" x="520" y="164" fill="currentcolor" style="font-size:1em">b</text><text text-anchor="middle" x="528" y="164" fill="currentcolor" style="font-size:1em">[</text><text text-anchor="middle" x="536" y="164" fill="currentcolor" style="font-size:1em">8</text><text text-anchor="middle" x="544" y="164" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="552" y="164" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="560" y="164" fill="currentcolor" style="font-size:1em">0</text><text text-anchor="middle" x="568" y="164" fill="currentcolor" style="font-size:1em">]</text><text text-anchor="middle" x="576" y="164" fill="currentcolor" style="font-size:1em">,</text><text text-anchor="middle" x="592" y="164" fill="currentcolor" style="font-size:1em">b</text><text text-anchor="middle" x="600" y="164" fill="currentcolor" style="font-size:1em">[</text><text text-anchor="middle" x="608" y="164" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="616" y="164" fill="currentcolor" style="font-size:1em">0</text><text text-anchor="middle" x="624" y="164" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="632" y="164" fill="currentcolor" style="font-size:1em">]</text><text text-anchor="middle" x="640" y="164" fill="currentcolor" style="font-size:1em">)</text></g></svg></div><p>以上代码可以生成一个（伪）UUID对日志进行标识。推荐使用<code>math/rand</code>，因为这里我们使用伪随机数就够了。</p><blockquote><p>注：这里的UUID只是看起来像一个UUID，实际上UUID有其特殊的规范与格式。但是由于golang内部没有提供可用的UUID库，所以只好随手模拟了一个。</p></blockquote><h4 id=文件组织>文件组织<a hidden class=anchor aria-hidden=true href=#文件组织>#</a></h4><p>默认的实现是把所有的东西都写到了<code>raft.go</code>文件里。一个非常大的文件可能会给我们的开发带来负担，所以我的做法是把所有的类声明放到<code>models.go</code>文件里。以避免文件的膨胀。</p><h4 id=锁与defer>锁与defer<a hidden class=anchor aria-hidden=true href=#锁与defer>#</a></h4><p>在raft实现中，锁可以用来保证在多线程环境下数据的正确性。所以只要在涉及到raft内部状态的变化时，都需要加锁。一个常见的加锁pattern是：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>() <span style=color:#75715e>// 加锁</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>() <span style=color:#75715e>// 在函数执行完成后解锁</span>
</span></span></code></pre></div><p>这里推荐使用defer，因为手动控制锁实现是过于容易出错。但是defer也是有坑的！</p><p>不同于C++的大括号作用域，defer的触发时间是在函数执行完成之后，而并不是退出当前大括号时。这点非常需要注意，否则极易出现死锁。</p><p>如果我们想实现C++中<code>do { ... } while (0);</code>类似的lock guard pattern，可以使用以下实现：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>    <span style=color:#75715e>// do something here</span>
</span></span><span style=display:flex><span>}()
</span></span></code></pre></div><p>这样一来，在执行完当前lambda之后，就会自动解锁。</p><h4 id=刷新定时器>刷新定时器<a hidden class=anchor aria-hidden=true href=#刷新定时器>#</a></h4><p>由于raft算法里面使用了定时器，这里提供一个刷新定时器的golang代码。这样实现是为了每次在刷新的时候，清空定时器中原有的超时时间，以避免混乱。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>renewTimer</span>(<span style=color:#a6e22e>timeout</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>timer</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>timer</span> = <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>NewTimer</span>(<span style=color:#a6e22e>timeout</span>)
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (!<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>timer</span>.<span style=color:#a6e22e>Stop</span>()) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>select</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>timer</span>.<span style=color:#a6e22e>C</span>:
</span></span><span style=display:flex><span>                <span style=color:#75715e>// pass</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>default</span>:
</span></span><span style=display:flex><span>                <span style=color:#75715e>// pass</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>timer</span>.<span style=color:#a6e22e>Reset</span>(<span style=color:#a6e22e>timeout</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>以及，在定时器超时之后，不要忘了更新定时器。</p><h3 id=2a---投票与选举>2A - 投票与选举<a hidden class=anchor aria-hidden=true href=#2a---投票与选举>#</a></h3><h4 id=所需要类的声明>所需要类的声明<a hidden class=anchor aria-hidden=true href=#所需要类的声明>#</a></h4><p>论文中的<code>Figure2</code>包含了算法中所有的类以及基本算法。在2A中，所有的类都会被用到。由于2A中只包括投票与选举，所以和日志相关的字段可以先忽略掉。</p><h4 id=checklist-for-2a>Checklist for 2A<a hidden class=anchor aria-hidden=true href=#checklist-for-2a>#</a></h4><ul><li>实现raft状态机的三个状态：leader，follower和candidate</li><li>实现RPC函数：<code>sendRequestVote</code>（发送端）和<code>RequestVote</code>（接收端的回调函数）</li><li>实现RPC函数：<code>sendAppendEntries</code>（发送端）和<code>AppendEntries</code>（接收端的回调函数）</li><li>保证raft状态机的任期号（<code>currentTerm</code>）是单调递增的</li><li>一个Follower对于某一个Term只能投出一票</li><li>实现Leader心跳，维护当前任期（Term）。</li><li>实现Follower选举超时（election timeout）</li><li>实现Candidate选举的三种场景<ul><li>获得多数选票，赢得选举。状态切换为Leader</li><li>其它的节点已经被选为Leader。状态切换为Follower</li><li>在选举中并未获得多数选票，状态切换为Follower</li></ul></li><li>实现Candidate随机选举超时（randomized election timeout）</li></ul><h3 id=2b2c---日志复制与持久化>2B/2C - 日志复制与持久化<a hidden class=anchor aria-hidden=true href=#2b2c---日志复制与持久化>#</a></h3><h4 id=基本工作流>基本工作流<a hidden class=anchor aria-hidden=true href=#基本工作流>#</a></h4><p>日志复制的基本工作流如下：</p><p>Leader接受用户请求，将状态变化写入本机的日志流中，并且把日志复制到Followers。如果本条日志合法，Followers会将这条日志标记为“提交”（committed），然后再将这条日志“应用”（apply）到Raft协议之外的状态机。Follower在提交日志之后，就可以向Leader回报这条日志已经被提交。在本条日志被多数节点提交之后，Leader再将这条日志标记为提交。此时，用户的请求就可以被确认（ACK）了。</p><p>Raft的论文中，Leader需要维护<code>commitIndex</code>和<code>lastApplied</code>这两个状态。为了简单起见，我们可以忽略“应用”（apply）这个过程。这两个状态我们只需要维护<code>commitIndex</code>即可。</p><blockquote><p>Raft协议不是2PC，千万不要搞混了哦～</p></blockquote><h4 id=回滚与滚回来>回滚与滚回来<a hidden class=anchor aria-hidden=true href=#回滚与滚回来>#</a></h4><p><img alt=rollback loading=lazy src=https://raw.githubusercontent.com/Wizmann/assets/3f1056d6f142755204092fb89a474dc964608bab/wizmann-pic/2019-05-02_14-40-52.png></p><p>从上面的工作流我们可以看到，对于已经committed的日志，仍然有可能是不可靠的。</p><p>例如，在Term1时，节点1作业Leader提交到了日志(1, 2)，而Follower节点Node2和Node3分别提交到了日志(1, 2)和(1, 3)。此时Leader短暂断线，出发选举超时，就会进行下一轮的选举。如果节点Node2被选为Leader，那么节点Node3就会被Leader多出一条日志，这是不被允许的。如果节点Node3被选为Leader，那么Node2就比Leader在Term1少一条日志，需要补齐。</p><blockquote><p>这里有人可能会怀疑，节点2比节点3少一条日志，那么按照论文里的说法，因为节点3的日志比较节点2要多，所以只有节点3才能赢得下一轮选举。这其实是不对的，如果节点3断线，节点1和节点2仍然可以组成一个quorum，选举出Leader。</p></blockquote><p>所以我们需要考虑将已committed的日志回滚（向左滚），以及缺失的日志补齐（向右滚）。这里其实有一些优化的点，我们后文再说。</p><p>再次注意，保证日志的一致性是Raft协议正确性的必须保证，在这一点上一定要注意。</p><h4 id=乱序请求>乱序请求<a hidden class=anchor aria-hidden=true href=#乱序请求>#</a></h4><p>本项目中，模拟的RPC协议并不能保证可靠性（会丢包）、有序性（会乱序），也没有SLA（没有超时时间的上限），更不用想拥塞控制。我们可以理解为它在底层使用了UDP协议，而不是TCP。所以我们不能做出任何假设。</p><p>例如，两个请求先后来到Leader端，A请求编号(1,100)，B请求编号(1,110)。然后我们依次将Log复制到Follower端（A先B后），但是在Follower端有可能收到的顺序是B先A后。甚至只收到B，没收到A。这种情况日常工程中的TCP协议下几乎不能发生，但是在测试环境中要十分小心。</p><h4 id=checklist-for-2b2c>Checklist for 2B/2C<a hidden class=anchor aria-hidden=true href=#checklist-for-2b2c>#</a></h4><ul><li>日志的状态会影响Leader选举<br>如果两份日志流的最后一条日志的Term不一样，那么我们认为Term号大的日志“比较新”。如果Term号一样，那么Index大的日志“比较新”</li><li>如果Leader和Follower的日志不一致，那么Follower需要拷贝Leader的日志（向左滚或向右滚的正确性）<br>这里推荐使用Assert加断言进行保证，如果出错可以获得实时的现场</li><li>对于小于当前Term的日志，Leader不需要等多数Follower确认就可以直接commit</li><li>一个重要特性：如果两个日志的(Term, Index)一致，那么其内容也是一致的。并且在此日志之前的所有日志都必须是一致的</li><li>另一个重要特性：RPC请求是幂等的，也就是多次重复发送一个请求并不会破坏Raft协议的状态</li></ul><h3 id=最后的3个case>最后的3个Case<a hidden class=anchor aria-hidden=true href=#最后的3个case>#</a></h3><p>最后的三个Case有一个共同点，就是对协议的效率和正确性有比较高的要求。即使前面的代码里你的实现是正确的，也有可能因为各种其它的原因造成Case挂掉。</p><p>建议首先解决正确性问题，再提升效率。</p><h4 id=向左滚的优化重要>向左滚的优化（重要！）<a hidden class=anchor aria-hidden=true href=#向左滚的优化重要>#</a></h4><p>在论文的5.3节，介绍了一种回滚的优化。如果Leader和Follower在某个Index上的日志不一致，Leader的版本记为(Term1, Index)，Follower的版本记为(Term2, Index)。那么Follower需要回滚所有日志，直到Term小于<code>Min(Term1, Term2)</code>。</p><p>这样的好处是可以加快回滚的效率。虽然论文上表示这种优化并非必要，但是在模拟出来的极端网络环境下，这样的优化可以帮助我们通过一些比较变态的Case。</p><h4 id=其它的非官方优化>其它的非官方优化<a hidden class=anchor aria-hidden=true href=#其它的非官方优化>#</a></h4><p>这里还有一些论文里没的提到的优化方案，不保证一定是正确的。</p><p>为了不剧透，放到单独的链接里了：<a href=https://github.com/Wizmann/assets/blob/master/wizmann-pic/19-05-02/raft-hints.md>剧透警告！</a></p><blockquote><p>还有一个Bonus挑战，谁比较闲可以试一下。</p></blockquote><h2 id=测试结果>测试结果<a hidden class=anchor aria-hidden=true href=#测试结果>#</a></h2><p><img alt=tests loading=lazy src=https://raw.githubusercontent.com/Wizmann/assets/e35dd59aa533ddd19065f070dcb85a3734cc035d/wizmann-pic/19-05-02/2019-05-02_21-37-14.png></p><p>在Travis CI上面运行的测试。自我感觉实现的比较一般，所以你们的程序应该跑的比我快一点才正常。</p><h2 id=总结>总结<a hidden class=anchor aria-hidden=true href=#总结>#</a></h2><p>想要完整正确的实现这个项目，首先一定要把论文读懂。并且划出实现上应该注意的重点。</p><p>当遇到正确性问题时，一定要回归论文，大部分的问题都可以获得解答。当遇到性能问题时，可以参考作业上面的Hints，里面也有非常有用的信息。</p><p>MIT的这个课程还有基于raft实现kv storage的项目，后续如果有时间应该还会做吧。</p></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=prev href=https://wizmann.top/posts/quartile-and-normal-distribution/><span class=title>«</span><br><span></span>
</a><a class=next href=https://wizmann.top/posts/range-problem/><span class=title>»</span><br><span></span></a></nav></footer><div id=disqus_thread></div><script>(function(){var e=document,t=e.createElement("script");t.src="https://wizmann.disqus.com/embed.js",t.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(t)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript></article></main><footer class=footer><span>&copy; 2025 <a href=https://wizmann.top/>Maerlyn's Rainbow</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>