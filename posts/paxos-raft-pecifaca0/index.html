<!doctype html><html lang=zh-cn dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>白话一致性协议 - Paxos、Raft和PacificA[0] | Maerlyn's Rainbow</title>
<meta name=keywords content="paxos,basic paxos,数据库,分布式系统,一致性"><meta name=description content="一致性协议 - Paxos
在分布式系统当中，我们往往需要保持节点之间的一致性。在绝大多数情况下，我们需要让系统中的节点相互协调通力合作，有可能的让系统正确的工作。但是，由于分布式系统本身的特性，需要我们在不可靠的硬件上尽可能的构建可靠的系统。所以，看似简单的一致性问题成为了分布式系统领域的一个重要的课题。"><meta name=author content="wizmann"><link rel=canonical href=https://wizmann.top/posts/paxos-raft-pecifaca0/><link crossorigin=anonymous href=/assets/css/stylesheet.f49d66caae9ea0fd43f21f29e71a8d3e284517ed770f2aa86fa012953ad3c9ef.css integrity="sha256-9J1myq6eoP1D8h8p5xqNPihFF+13Dyqob6ASlTrTye8=" rel="preload stylesheet" as=style><link rel=icon href=https://wizmann.top/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://wizmann.top/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://wizmann.top/favicon-32x32.png><link rel=apple-touch-icon href=https://wizmann.top/apple-touch-icon.png><link rel=mask-icon href=https://wizmann.top/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh-cn href=https://wizmann.top/posts/paxos-raft-pecifaca0/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-2X5NE9PX0B"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-2X5NE9PX0B")</script><meta property="og:url" content="https://wizmann.top/posts/paxos-raft-pecifaca0/"><meta property="og:site_name" content="Maerlyn's Rainbow"><meta property="og:title" content="白话一致性协议 - Paxos、Raft和PacificA[0]"><meta property="og:description" content="一致性协议 - Paxos 在分布式系统当中，我们往往需要保持节点之间的一致性。在绝大多数情况下，我们需要让系统中的节点相互协调通力合作，有可能的让系统正确的工作。但是，由于分布式系统本身的特性，需要我们在不可靠的硬件上尽可能的构建可靠的系统。所以，看似简单的一致性问题成为了分布式系统领域的一个重要的课题。"><meta property="og:locale" content="zh-CN"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2018-11-25T00:00:00+00:00"><meta property="article:modified_time" content="2018-11-25T00:00:00+00:00"><meta property="article:tag" content="Paxos"><meta property="article:tag" content="Basic Paxos"><meta property="article:tag" content="数据库"><meta property="article:tag" content="分布式系统"><meta property="article:tag" content="一致性"><meta name=twitter:card content="summary"><meta name=twitter:title content="白话一致性协议 - Paxos、Raft和PacificA[0]"><meta name=twitter:description content="一致性协议 - Paxos
在分布式系统当中，我们往往需要保持节点之间的一致性。在绝大多数情况下，我们需要让系统中的节点相互协调通力合作，有可能的让系统正确的工作。但是，由于分布式系统本身的特性，需要我们在不可靠的硬件上尽可能的构建可靠的系统。所以，看似简单的一致性问题成为了分布式系统领域的一个重要的课题。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://wizmann.top/posts/"},{"@type":"ListItem","position":2,"name":"白话一致性协议 - Paxos、Raft和PacificA[0]","item":"https://wizmann.top/posts/paxos-raft-pecifaca0/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"白话一致性协议 - Paxos、Raft和PacificA[0]","name":"白话一致性协议 - Paxos、Raft和PacificA[0]","description":"一致性协议 - Paxos 在分布式系统当中，我们往往需要保持节点之间的一致性。在绝大多数情况下，我们需要让系统中的节点相互协调通力合作，有可能的让系统正确的工作。但是，由于分布式系统本身的特性，需要我们在不可靠的硬件上尽可能的构建可靠的系统。所以，看似简单的一致性问题成为了分布式系统领域的一个重要的课题。\n","keywords":["paxos","basic paxos","数据库","分布式系统","一致性"],"articleBody":"一致性协议 - Paxos 在分布式系统当中，我们往往需要保持节点之间的一致性。在绝大多数情况下，我们需要让系统中的节点相互协调通力合作，有可能的让系统正确的工作。但是，由于分布式系统本身的特性，需要我们在不可靠的硬件上尽可能的构建可靠的系统。所以，看似简单的一致性问题成为了分布式系统领域的一个重要的课题。\nPaxos算法是Leslie Lamport于1990年提出的一种一致性算法。也是目前公认解决分布式一致性问题最有效的算法之一。\nPaxos算法的目标是在一个不可靠的分布式系统内，只通过网络通信，能够快速且正确地在集群内部对某个数据的值达成一致。并且保证不论发生任何异常，都不会破坏系统的一致性。\nPaxos算法 另一种（简化了的）形象的问题描述 - 买车位 某小区的一些居民在抢车位，而车位只有一个。居民们达成协议，只要一个报价获得半数以上居民认可，那么提出这个出价的居民则获得了车位的所有权。\n居民之间非常友善，如果知道了车位已经有了买家，就不会继续出价购买，并且会帮忙传播这个信息。\n居民们都是遵纪守法的好公民，在整个过程中都只会如实的与其它用户分享信息。信息的分享是在网上，通过一对一的私密聊天进行。但是小区的手机信号非常差，我们不能保证通信的质量，一些信息可能会丢失。但是居民不会掉线。也不会失去记忆，并且通信的内容是完整的，不会被篡改的。\n划重点：\n需要半数以上居民的认可，才能声称拥有车位。这个居民被称为车位的“公认拥有者” 车位有且只有一个，所以一个车位不能同时有两个“公认拥有者” 车位可以暂时没有拥有者，但是需要尽快选出一个 通信是不可靠的(not-reliable)，但是正确性(integrity)和可持久性（durability）是可以保证的 整个流程的目标是确定车位的拥有者。流程的参与者不会以自己拥有车位为最终目标 如何选出最终的买家 由于通信是一对一的，对于所有参与者来说，他们对整个系统的了解都是片面的、过时的。但是参与者会通过与其它参与者进行通信，不断获得更及时的信息，从而最终达成一致。\n对于普通居民，会记录“已知最高报价”和“已确认报价”两个状态。会处理两种请求：\n询价：如果居民已确认了某个报价，则返回这个报价。否则会尝试更新已知最高报价，并报告买家当前的最高报价 报价：居民会将请求中的报价与自己已知的最高报价进行比较，如果高于或等于本地已经报价，无论是否已经有已确认报价，都会确认这个报价 而对于买家，会发出两种不同的信息：\n询价：以某一个报价问询多数居民，如果有已确认的报价，则放弃自己的报价。如果这个报价低于居民已知的报价，则提高报价。 报价：如果询价过程中收到了已确认的报价，则帮忙转发这个报价。否则发送自己的报价，如果报价获得了多数居民的认可，即可以认为所有权已经更新 一致性的直观证明 报价阶段，除了保证正确性之外，对于居民和买家并没有任何约束。其本质参与者之间同步信息的过程。\n而一致性在报价阶段可以被很好的保证\n如果车位还没有主人，那么大家就拼一拼运气和手速，直到有一个买家获得了半数居民的认可。 如果用户A已经声明以价格P买入车位（记为(P, A)），此时必有多数居民已经认可(P, A)。如果用户B想要声明以价格Q(Q \u003e= P)买入车位，首先需要向多数居民询价，在询价的过程中，一定会收到用户A已经拥有车位的信息，此时B只会帮A扩散信息，而不会去争夺拥有权。系统最终会达到一个稳定的状态。 失忆 - 放松可持久性要求 如果我们放松可持久性的限制。即居民可以掉线，或者清空自己的记忆。那此时最差情况是多数已经确认报价的居民不再承认报价，那么系统就有可能退化到“仍没有人拥有车位”的状态。此时我们只需要再进行一轮选举，选出车位新的主人即可。这并不会破坏整个系统的一致性。\n旁观者视角 假如我们做为旁观者，想要观察是谁最终拥有了车位。可以有以下两种方法：\n“推”模型 当新的买家被选举出来时，新买家会通知所有旁观者车位的拥有者发生了变化。这样观察者们可以实时的获得状态的变化，但是由于通信是不可靠的，旁观者可能会错过状态变化的信息。如果这种情况出现，观察者只能等待下次状态变化，才能更新自己的状态。\n“拉”模型 旁观者可以假装自己是一个买家，向多数居民进行询价。如果最终买家已经确定，那么询价的响应中一定包含着最新的拥有者信息。\nPaxos如何解决活锁问题 假设居民里有买家A、B，同时向其它居民提出询价/报价。如果他们的询价/报价顺序排列如下，会出现什么状况呢？\nA 众 B 众 （ A 众 A （ B 众 B A B A 众 : 居 ： 居 此 ： 居 ： B ： 居 ： ： ： ： 居 民 加 民 时 最 民 （ 对 最 民 我 我 我 我 民 询 ： 钱 ： A 终 ： 内 A 终 ： 加 再 加 再 ： 价 好 ， 收 仍 报 不 心 提 报 滚 钱 加 钱 加 。 ， 的 2 到 旧 价 行 m 高 价 粗 。 1 ， 块 ， 认 ， 不 m 了 ， ， 。 块 最 最 为 1 行 p 报 2 A （ 高 高 1 块 ， ） 价 块 已 你 价 价 块 B 询 也 经 们 为 为 是 已 价 毫 报 玩 1 2 最 经 ， 无 价 个 块 块 高 加 3 准 3 球 报 到 块 备 块 啊 价 两 ） 了 ） ） 块 钱 了 震惊，这帮无聊的人居然为了这几块钱可以玩一天！\n以这样的流程进行下去，系统会陷入活锁，几乎不能达成一致了。想要解决这个问题，可以将A和B的询价重试时间加入随机化因子，这样可以帮助更快的让居民们达成一致。\nPaxos如何解决投票分裂问题 如图所示，居民们的投票可能会发生分裂，即没有一个值达到了半数。这里的解决方案是让买家重新进行询价，同时加入随机化因子，使得投票达成半数以上的概率更大。\n说正经的 对于Paxos算法的官方描述和正确性的详细证明可以参考原论文。这里就不搬运了，只是把我的例子和官方通用术语进行一下讲解，避免把大家带跑偏了。\n在上面的例子中，“车位”的通用术语被称为“共识”，整个系统中最多有一个共识。而“询价请求”被称为“prepare请求”，“报价请求”被称为“accept请求”。\n每个请求的价格被称为“编号”，编号大的请求可以覆盖编号小的请求，和“价高者得”是一个道理。请求中所带的信息被称为“value”，在我们的例子中，代表着购买者的身份信息。\nBasic Paxos和Multi Paxos 上面我们描述的Paxos算法又被称为Basic Paxos，因为每一轮流程执行完，所有的参与者都会（且只会）达成一个共识。而在实际的应用中，我们需要连续不断的对多个值达成共识。这时Basic Paxos算法就力不能及了，一来每一个值的共识都至少需要两次广播网络请求，性能太低，二来同时存在的多个提案会互相竞争，使得通信的效率下降。\n所以为了解决这个问题，Multi Paxos算法应运而生，即一种可以高效的、连续不断的对多个值达成共识的算法。\n下一篇文章中，我们会介绍一种被普遍认可，以及已经被工业界应用的Multi Paxos的实现 —— Raft算法。\n参考链接 Paxos Made Simple 从Paxos到Zookeeper 知乎：Paxos算法详解 ","wordCount":"2731","inLanguage":"zh-cn","datePublished":"2018-11-25T00:00:00Z","dateModified":"2018-11-25T00:00:00Z","author":{"@type":"Person","name":"wizmann"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://wizmann.top/posts/paxos-raft-pecifaca0/"},"publisher":{"@type":"Organization","name":"Maerlyn's Rainbow","logo":{"@type":"ImageObject","url":"https://wizmann.top/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://wizmann.top/ accesskey=h title="Maerlyn's Rainbow (Alt + H)">Maerlyn's Rainbow</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">白话一致性协议 - Paxos、Raft和PacificA[0]</h1><div class=post-meta><span title='2018-11-25 00:00:00 +0000 UTC'>November 25, 2018</span>&nbsp;·&nbsp;wizmann</div></header><div class=post-content><h2 id=一致性协议---paxos>一致性协议 - Paxos<a hidden class=anchor aria-hidden=true href=#一致性协议---paxos>#</a></h2><p>在分布式系统当中，我们往往需要保持节点之间的一致性。在绝大多数情况下，我们需要让系统中的节点相互协调通力合作，有可能的让系统正确的工作。但是，由于分布式系统本身的特性，需要我们在不可靠的硬件上尽可能的构建可靠的系统。所以，看似简单的一致性问题成为了分布式系统领域的一个重要的课题。</p><p>Paxos算法是Leslie Lamport于1990年提出的一种一致性算法。也是目前公认解决分布式一致性问题最有效的算法之一。</p><p>Paxos算法的目标是在一个不可靠的分布式系统内，只通过网络通信，能够快速且正确地在集群内部对某个数据的值达成一致。并且保证不论发生任何异常，都不会破坏系统的一致性。</p><h2 id=paxos算法>Paxos算法<a hidden class=anchor aria-hidden=true href=#paxos算法>#</a></h2><h3 id=另一种简化了的形象的问题描述---买车位>另一种（简化了的）形象的问题描述 - 买车位<a hidden class=anchor aria-hidden=true href=#另一种简化了的形象的问题描述---买车位>#</a></h3><p>某小区的一些居民在抢车位，而车位只有一个。居民们达成协议，只要一个报价获得半数以上居民认可，那么提出这个出价的居民则获得了车位的所有权。</p><p>居民之间非常友善，如果知道了车位已经有了买家，就不会继续出价购买，并且会帮忙传播这个信息。</p><p>居民们都是遵纪守法的好公民，在整个过程中都只会如实的与其它用户分享信息。信息的分享是在网上，通过一对一的私密聊天进行。但是小区的手机信号非常差，我们不能保证通信的质量，一些信息可能会丢失。但是居民不会掉线。也不会失去记忆，并且通信的内容是完整的，不会被篡改的。</p><p>划重点：</p><ol><li>需要半数以上居民的认可，才能声称拥有车位。这个居民被称为车位的“公认拥有者”</li><li>车位有且只有一个，所以一个车位不能同时有两个“公认拥有者”</li><li>车位可以暂时没有拥有者，但是需要尽快选出一个</li><li>通信是不可靠的(not-reliable)，但是正确性(integrity)和可持久性（durability）是可以保证的</li><li>整个流程的目标是确定车位的拥有者。流程的参与者不会以自己拥有车位为最终目标</li></ol><h3 id=如何选出最终的买家>如何选出最终的买家<a hidden class=anchor aria-hidden=true href=#如何选出最终的买家>#</a></h3><p>由于通信是一对一的，对于所有参与者来说，他们对整个系统的了解都是片面的、过时的。但是参与者会通过与其它参与者进行通信，不断获得更及时的信息，从而最终达成一致。</p><p>对于普通居民，会记录“已知最高报价”和“已确认报价”两个状态。会处理两种请求：</p><ol><li>询价：如果居民已确认了某个报价，则返回这个报价。否则会尝试更新已知最高报价，并报告买家当前的最高报价</li><li>报价：居民会将请求中的报价与自己已知的最高报价进行比较，如果高于或等于本地已经报价，无论是否已经有已确认报价，都会确认这个报价</li></ol><p>而对于买家，会发出两种不同的信息：</p><ol><li>询价：以某一个报价问询多数居民，如果有已确认的报价，则放弃自己的报价。如果这个报价低于居民已知的报价，则提高报价。</li><li>报价：如果询价过程中收到了已确认的报价，则帮忙转发这个报价。否则发送自己的报价，如果报价获得了多数居民的认可，即可以认为所有权已经更新</li></ol><h3 id=一致性的直观证明>一致性的直观证明<a hidden class=anchor aria-hidden=true href=#一致性的直观证明>#</a></h3><p>报价阶段，除了保证正确性之外，对于居民和买家并没有任何约束。其本质参与者之间同步信息的过程。</p><p>而一致性在报价阶段可以被很好的保证</p><ul><li>如果车位还没有主人，那么大家就拼一拼运气和手速，直到有一个买家获得了半数居民的认可。</li><li>如果用户A已经声明以价格P买入车位（记为<code>(P, A)</code>），此时必有多数居民已经认可<code>(P, A)</code>。如果用户B想要声明以价格Q(Q >= P)买入车位，首先需要向多数居民询价，在询价的过程中，一定会收到用户A已经拥有车位的信息，此时B只会帮A扩散信息，而不会去争夺拥有权。系统最终会达到一个稳定的状态。</li></ul><h3 id=失忆---放松可持久性要求>失忆 - 放松可持久性要求<a hidden class=anchor aria-hidden=true href=#失忆---放松可持久性要求>#</a></h3><p>如果我们放松可持久性的限制。即居民可以掉线，或者清空自己的记忆。那此时最差情况是多数已经确认报价的居民不再承认报价，那么系统就有可能退化到“仍没有人拥有车位”的状态。此时我们只需要再进行一轮选举，选出车位新的主人即可。这并不会破坏整个系统的一致性。</p><h3 id=旁观者视角>旁观者视角<a hidden class=anchor aria-hidden=true href=#旁观者视角>#</a></h3><p>假如我们做为旁观者，想要观察是谁最终拥有了车位。可以有以下两种方法：</p><ol><li>“推”模型</li></ol><p>当新的买家被选举出来时，新买家会通知所有旁观者车位的拥有者发生了变化。这样观察者们可以实时的获得状态的变化，但是由于通信是不可靠的，旁观者可能会错过状态变化的信息。如果这种情况出现，观察者只能等待下次状态变化，才能更新自己的状态。</p><ol start=2><li>“拉”模型</li></ol><p>旁观者可以假装自己是一个买家，向多数居民进行询价。如果最终买家已经确定，那么询价的响应中一定包含着最新的拥有者信息。</p><h3 id=paxos如何解决活锁问题>Paxos如何解决活锁问题<a hidden class=anchor aria-hidden=true href=#paxos如何解决活锁问题>#</a></h3><p>假设居民里有买家A、B，同时向其它居民提出询价/报价。如果他们的询价/报价顺序排列如下，会出现什么状况呢？</p><div class="goat svg-container"><svg font-family="Menlo,Lucida Console,monospace" viewBox="0 0 152 265"><g transform="translate(8,16)"><text text-anchor="middle" x="0" y="4" fill="currentcolor" style="font-size:1em">A</text><text text-anchor="middle" x="0" y="20" fill="currentcolor" style="font-size:1em">众</text><text text-anchor="middle" x="0" y="36" fill="currentcolor" style="font-size:1em">B</text><text text-anchor="middle" x="0" y="52" fill="currentcolor" style="font-size:1em">众</text><text text-anchor="middle" x="0" y="68" fill="currentcolor" style="font-size:1em">（</text><text text-anchor="middle" x="0" y="84" fill="currentcolor" style="font-size:1em">A</text><text text-anchor="middle" x="0" y="100" fill="currentcolor" style="font-size:1em">众</text><text text-anchor="middle" x="0" y="116" fill="currentcolor" style="font-size:1em">A</text><text text-anchor="middle" x="0" y="132" fill="currentcolor" style="font-size:1em">（</text><text text-anchor="middle" x="0" y="148" fill="currentcolor" style="font-size:1em">B</text><text text-anchor="middle" x="0" y="164" fill="currentcolor" style="font-size:1em">众</text><text text-anchor="middle" x="0" y="180" fill="currentcolor" style="font-size:1em">B</text><text text-anchor="middle" x="0" y="196" fill="currentcolor" style="font-size:1em">A</text><text text-anchor="middle" x="0" y="212" fill="currentcolor" style="font-size:1em">B</text><text text-anchor="middle" x="0" y="228" fill="currentcolor" style="font-size:1em">A</text><text text-anchor="middle" x="0" y="244" fill="currentcolor" style="font-size:1em">众</text><text text-anchor="middle" x="8" y="4" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="8" y="20" fill="currentcolor" style="font-size:1em">居</text><text text-anchor="middle" x="8" y="36" fill="currentcolor" style="font-size:1em">：</text><text text-anchor="middle" x="8" y="52" fill="currentcolor" style="font-size:1em">居</text><text text-anchor="middle" x="8" y="68" fill="currentcolor" style="font-size:1em">此</text><text text-anchor="middle" x="8" y="84" fill="currentcolor" style="font-size:1em">：</text><text text-anchor="middle" x="8" y="100" fill="currentcolor" style="font-size:1em">居</text><text text-anchor="middle" x="8" y="116" fill="currentcolor" style="font-size:1em">：</text><text text-anchor="middle" x="8" y="132" fill="currentcolor" style="font-size:1em">B</text><text text-anchor="middle" x="8" y="148" fill="currentcolor" style="font-size:1em">：</text><text text-anchor="middle" x="8" y="164" fill="currentcolor" style="font-size:1em">居</text><text text-anchor="middle" x="8" y="180" fill="currentcolor" style="font-size:1em">：</text><text text-anchor="middle" x="8" y="196" fill="currentcolor" style="font-size:1em">：</text><text text-anchor="middle" x="8" y="212" fill="currentcolor" style="font-size:1em">：</text><text text-anchor="middle" x="8" y="228" fill="currentcolor" style="font-size:1em">：</text><text text-anchor="middle" x="8" y="244" fill="currentcolor" style="font-size:1em">居</text><text text-anchor="middle" x="16" y="20" fill="currentcolor" style="font-size:1em">民</text><text text-anchor="middle" x="16" y="36" fill="currentcolor" style="font-size:1em">加</text><text text-anchor="middle" x="16" y="52" fill="currentcolor" style="font-size:1em">民</text><text text-anchor="middle" x="16" y="68" fill="currentcolor" style="font-size:1em">时</text><text text-anchor="middle" x="16" y="84" fill="currentcolor" style="font-size:1em">最</text><text text-anchor="middle" x="16" y="100" fill="currentcolor" style="font-size:1em">民</text><text text-anchor="middle" x="16" y="116" fill="currentcolor" style="font-size:1em">（</text><text text-anchor="middle" x="16" y="132" fill="currentcolor" style="font-size:1em">对</text><text text-anchor="middle" x="16" y="148" fill="currentcolor" style="font-size:1em">最</text><text text-anchor="middle" x="16" y="164" fill="currentcolor" style="font-size:1em">民</text><text text-anchor="middle" x="16" y="180" fill="currentcolor" style="font-size:1em">我</text><text text-anchor="middle" x="16" y="196" fill="currentcolor" style="font-size:1em">我</text><text text-anchor="middle" x="16" y="212" fill="currentcolor" style="font-size:1em">我</text><text text-anchor="middle" x="16" y="228" fill="currentcolor" style="font-size:1em">我</text><text text-anchor="middle" x="16" y="244" fill="currentcolor" style="font-size:1em">民</text><text text-anchor="middle" x="24" y="4" fill="currentcolor" style="font-size:1em">询</text><text text-anchor="middle" x="24" y="20" fill="currentcolor" style="font-size:1em">：</text><text text-anchor="middle" x="24" y="36" fill="currentcolor" style="font-size:1em">钱</text><text text-anchor="middle" x="24" y="52" fill="currentcolor" style="font-size:1em">：</text><text text-anchor="middle" x="24" y="68" fill="currentcolor" style="font-size:1em">A</text><text text-anchor="middle" x="24" y="84" fill="currentcolor" style="font-size:1em">终</text><text text-anchor="middle" x="24" y="100" fill="currentcolor" style="font-size:1em">：</text><text text-anchor="middle" x="24" y="116" fill="currentcolor" style="font-size:1em">内</text><text text-anchor="middle" x="24" y="132" fill="currentcolor" style="font-size:1em">A</text><text text-anchor="middle" x="24" y="148" fill="currentcolor" style="font-size:1em">终</text><text text-anchor="middle" x="24" y="164" fill="currentcolor" style="font-size:1em">：</text><text text-anchor="middle" x="24" y="180" fill="currentcolor" style="font-size:1em">加</text><text text-anchor="middle" x="24" y="196" fill="currentcolor" style="font-size:1em">再</text><text text-anchor="middle" x="24" y="212" fill="currentcolor" style="font-size:1em">加</text><text text-anchor="middle" x="24" y="228" fill="currentcolor" style="font-size:1em">再</text><text text-anchor="middle" x="24" y="244" fill="currentcolor" style="font-size:1em">：</text><text text-anchor="middle" x="32" y="4" fill="currentcolor" style="font-size:1em">价</text><text text-anchor="middle" x="32" y="20" fill="currentcolor" style="font-size:1em">好</text><text text-anchor="middle" x="32" y="36" fill="currentcolor" style="font-size:1em">，</text><text text-anchor="middle" x="32" y="52" fill="currentcolor" style="font-size:1em">收</text><text text-anchor="middle" x="32" y="68" fill="currentcolor" style="font-size:1em">仍</text><text text-anchor="middle" x="32" y="84" fill="currentcolor" style="font-size:1em">报</text><text text-anchor="middle" x="32" y="100" fill="currentcolor" style="font-size:1em">不</text><text text-anchor="middle" x="32" y="116" fill="currentcolor" style="font-size:1em">心</text><text text-anchor="middle" x="32" y="132" fill="currentcolor" style="font-size:1em">提</text><text text-anchor="middle" x="32" y="148" fill="currentcolor" style="font-size:1em">报</text><text text-anchor="middle" x="32" y="164" fill="currentcolor" style="font-size:1em">滚</text><text text-anchor="middle" x="32" y="180" fill="currentcolor" style="font-size:1em">钱</text><text text-anchor="middle" x="32" y="196" fill="currentcolor" style="font-size:1em">加</text><text text-anchor="middle" x="32" y="212" fill="currentcolor" style="font-size:1em">钱</text><text text-anchor="middle" x="32" y="228" fill="currentcolor" style="font-size:1em">加</text><text text-anchor="middle" x="32" y="244" fill="currentcolor" style="font-size:1em">。</text><text text-anchor="middle" x="40" y="4" fill="currentcolor" style="font-size:1em">，</text><text text-anchor="middle" x="40" y="20" fill="currentcolor" style="font-size:1em">的</text><text text-anchor="middle" x="40" y="36" fill="currentcolor" style="font-size:1em">2</text><text text-anchor="middle" x="40" y="52" fill="currentcolor" style="font-size:1em">到</text><text text-anchor="middle" x="40" y="68" fill="currentcolor" style="font-size:1em">旧</text><text text-anchor="middle" x="40" y="84" fill="currentcolor" style="font-size:1em">价</text><text text-anchor="middle" x="40" y="100" fill="currentcolor" style="font-size:1em">行</text><text text-anchor="middle" x="40" y="116" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="40" y="132" fill="currentcolor" style="font-size:1em">高</text><text text-anchor="middle" x="40" y="148" fill="currentcolor" style="font-size:1em">价</text><text text-anchor="middle" x="40" y="164" fill="currentcolor" style="font-size:1em">粗</text><text text-anchor="middle" x="40" y="244" fill="currentcolor" style="font-size:1em">。</text><text text-anchor="middle" x="48" y="4" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="48" y="20" fill="currentcolor" style="font-size:1em">，</text><text text-anchor="middle" x="48" y="36" fill="currentcolor" style="font-size:1em">块</text><text text-anchor="middle" x="48" y="52" fill="currentcolor" style="font-size:1em">，</text><text text-anchor="middle" x="48" y="68" fill="currentcolor" style="font-size:1em">认</text><text text-anchor="middle" x="48" y="84" fill="currentcolor" style="font-size:1em">，</text><text text-anchor="middle" x="48" y="100" fill="currentcolor" style="font-size:1em">不</text><text text-anchor="middle" x="48" y="116" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="48" y="132" fill="currentcolor" style="font-size:1em">了</text><text text-anchor="middle" x="48" y="148" fill="currentcolor" style="font-size:1em">，</text><text text-anchor="middle" x="48" y="164" fill="currentcolor" style="font-size:1em">，</text><text text-anchor="middle" x="48" y="244" fill="currentcolor" style="font-size:1em">。</text><text text-anchor="middle" x="56" y="4" fill="currentcolor" style="font-size:1em">块</text><text text-anchor="middle" x="56" y="20" fill="currentcolor" style="font-size:1em">最</text><text text-anchor="middle" x="56" y="52" fill="currentcolor" style="font-size:1em">最</text><text text-anchor="middle" x="56" y="68" fill="currentcolor" style="font-size:1em">为</text><text text-anchor="middle" x="56" y="84" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="56" y="100" fill="currentcolor" style="font-size:1em">行</text><text text-anchor="middle" x="56" y="116" fill="currentcolor" style="font-size:1em">p</text><text text-anchor="middle" x="56" y="132" fill="currentcolor" style="font-size:1em">报</text><text text-anchor="middle" x="56" y="148" fill="currentcolor" style="font-size:1em">2</text><text text-anchor="middle" x="56" y="164" fill="currentcolor" style="font-size:1em">A</text><text text-anchor="middle" x="56" y="244" fill="currentcolor" style="font-size:1em">（</text><text text-anchor="middle" x="64" y="20" fill="currentcolor" style="font-size:1em">高</text><text text-anchor="middle" x="64" y="52" fill="currentcolor" style="font-size:1em">高</text><text text-anchor="middle" x="64" y="68" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="64" y="84" fill="currentcolor" style="font-size:1em">块</text><text text-anchor="middle" x="64" y="100" fill="currentcolor" style="font-size:1em">，</text><text text-anchor="middle" x="64" y="116" fill="currentcolor" style="font-size:1em">）</text><text text-anchor="middle" x="64" y="132" fill="currentcolor" style="font-size:1em">价</text><text text-anchor="middle" x="64" y="148" fill="currentcolor" style="font-size:1em">块</text><text text-anchor="middle" x="64" y="164" fill="currentcolor" style="font-size:1em">已</text><text text-anchor="middle" x="64" y="244" fill="currentcolor" style="font-size:1em">你</text><text text-anchor="middle" x="72" y="20" fill="currentcolor" style="font-size:1em">价</text><text text-anchor="middle" x="72" y="52" fill="currentcolor" style="font-size:1em">价</text><text text-anchor="middle" x="72" y="68" fill="currentcolor" style="font-size:1em">块</text><text text-anchor="middle" x="72" y="100" fill="currentcolor" style="font-size:1em">B</text><text text-anchor="middle" x="72" y="116" fill="currentcolor" style="font-size:1em">询</text><text text-anchor="middle" x="72" y="132" fill="currentcolor" style="font-size:1em">也</text><text text-anchor="middle" x="72" y="164" fill="currentcolor" style="font-size:1em">经</text><text text-anchor="middle" x="72" y="244" fill="currentcolor" style="font-size:1em">们</text><text text-anchor="middle" x="80" y="20" fill="currentcolor" style="font-size:1em">为</text><text text-anchor="middle" x="80" y="52" fill="currentcolor" style="font-size:1em">为</text><text text-anchor="middle" x="80" y="68" fill="currentcolor" style="font-size:1em">是</text><text text-anchor="middle" x="80" y="100" fill="currentcolor" style="font-size:1em">已</text><text text-anchor="middle" x="80" y="116" fill="currentcolor" style="font-size:1em">价</text><text text-anchor="middle" x="80" y="132" fill="currentcolor" style="font-size:1em">毫</text><text text-anchor="middle" x="80" y="164" fill="currentcolor" style="font-size:1em">报</text><text text-anchor="middle" x="80" y="244" fill="currentcolor" style="font-size:1em">玩</text><text text-anchor="middle" x="88" y="20" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="88" y="52" fill="currentcolor" style="font-size:1em">2</text><text text-anchor="middle" x="88" y="68" fill="currentcolor" style="font-size:1em">最</text><text text-anchor="middle" x="88" y="100" fill="currentcolor" style="font-size:1em">经</text><text text-anchor="middle" x="88" y="116" fill="currentcolor" style="font-size:1em">，</text><text text-anchor="middle" x="88" y="132" fill="currentcolor" style="font-size:1em">无</text><text text-anchor="middle" x="88" y="164" fill="currentcolor" style="font-size:1em">价</text><text text-anchor="middle" x="88" y="244" fill="currentcolor" style="font-size:1em">个</text><text text-anchor="middle" x="96" y="20" fill="currentcolor" style="font-size:1em">块</text><text text-anchor="middle" x="96" y="52" fill="currentcolor" style="font-size:1em">块</text><text text-anchor="middle" x="96" y="68" fill="currentcolor" style="font-size:1em">高</text><text text-anchor="middle" x="96" y="100" fill="currentcolor" style="font-size:1em">加</text><text text-anchor="middle" x="96" y="116" fill="currentcolor" style="font-size:1em">3</text><text text-anchor="middle" x="96" y="132" fill="currentcolor" style="font-size:1em">准</text><text text-anchor="middle" x="96" y="164" fill="currentcolor" style="font-size:1em">3</text><text text-anchor="middle" x="96" y="244" fill="currentcolor" style="font-size:1em">球</text><text text-anchor="middle" x="104" y="68" fill="currentcolor" style="font-size:1em">报</text><text text-anchor="middle" x="104" y="100" fill="currentcolor" style="font-size:1em">到</text><text text-anchor="middle" x="104" y="116" fill="currentcolor" style="font-size:1em">块</text><text text-anchor="middle" x="104" y="132" fill="currentcolor" style="font-size:1em">备</text><text text-anchor="middle" x="104" y="164" fill="currentcolor" style="font-size:1em">块</text><text text-anchor="middle" x="104" y="244" fill="currentcolor" style="font-size:1em">啊</text><text text-anchor="middle" x="112" y="68" fill="currentcolor" style="font-size:1em">价</text><text text-anchor="middle" x="112" y="100" fill="currentcolor" style="font-size:1em">两</text><text text-anchor="middle" x="112" y="132" fill="currentcolor" style="font-size:1em">）</text><text text-anchor="middle" x="112" y="164" fill="currentcolor" style="font-size:1em">了</text><text text-anchor="middle" x="112" y="244" fill="currentcolor" style="font-size:1em">）</text><text text-anchor="middle" x="120" y="68" fill="currentcolor" style="font-size:1em">）</text><text text-anchor="middle" x="120" y="100" fill="currentcolor" style="font-size:1em">块</text><text text-anchor="middle" x="128" y="100" fill="currentcolor" style="font-size:1em">钱</text><text text-anchor="middle" x="136" y="100" fill="currentcolor" style="font-size:1em">了</text></g></svg></div><p>震惊，这帮无聊的人居然为了这几块钱可以玩一天！</p><p>以这样的流程进行下去，系统会陷入活锁，几乎不能达成一致了。想要解决这个问题，可以将A和B的询价重试时间加入随机化因子，这样可以帮助更快的让居民们达成一致。</p><h3 id=paxos如何解决投票分裂问题>Paxos如何解决投票分裂问题<a hidden class=anchor aria-hidden=true href=#paxos如何解决投票分裂问题>#</a></h3><p><img loading=lazy src=https://raw.githubusercontent.com/Wizmann/assets/master/wizmann-pic/18-11-25/split-vots.png></p><p>如图所示，居民们的投票可能会发生分裂，即没有一个值达到了半数。这里的解决方案是让买家重新进行询价，同时加入随机化因子，使得投票达成半数以上的概率更大。</p><h2 id=说正经的>说正经的<a hidden class=anchor aria-hidden=true href=#说正经的>#</a></h2><p>对于Paxos算法的官方描述和正确性的详细证明可以参考<a href=https://lamport.azurewebsites.net/pubs/paxos-simple.pdf>原论文</a>。这里就不搬运了，只是把我的例子和官方通用术语进行一下讲解，避免把大家带跑偏了。</p><p>在上面的例子中，“车位”的通用术语被称为“共识”，整个系统中最多有一个共识。而“询价请求”被称为“prepare请求”，“报价请求”被称为“accept请求”。</p><p>每个请求的价格被称为“编号”，编号大的请求可以覆盖编号小的请求，和“价高者得”是一个道理。请求中所带的信息被称为“value”，在我们的例子中，代表着购买者的身份信息。</p><h2 id=basic-paxos和multi-paxos>Basic Paxos和Multi Paxos<a hidden class=anchor aria-hidden=true href=#basic-paxos和multi-paxos>#</a></h2><p>上面我们描述的Paxos算法又被称为Basic Paxos，因为每一轮流程执行完，所有的参与者都会（且只会）达成一个共识。而在实际的应用中，我们需要连续不断的对多个值达成共识。这时Basic Paxos算法就力不能及了，一来每一个值的共识都至少需要两次广播网络请求，性能太低，二来同时存在的多个提案会互相竞争，使得通信的效率下降。</p><p>所以为了解决这个问题，Multi Paxos算法应运而生，即一种可以高效的、连续不断的对多个值达成共识的算法。</p><p>下一篇文章中，我们会介绍一种被普遍认可，以及已经被工业界应用的Multi Paxos的实现 —— Raft算法。</p><h2 id=参考链接>参考链接<a hidden class=anchor aria-hidden=true href=#参考链接>#</a></h2><ul><li><a href=https://lamport.azurewebsites.net/pubs/paxos-simple.pdf>Paxos Made Simple</a></li><li><a href=https://book.douban.com/subject/26292004/>从Paxos到Zookeeper</a></li><li><a href=https://zhuanlan.zhihu.com/p/31780743>知乎：Paxos算法详解</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://wizmann.top/tags/paxos/>Paxos</a></li><li><a href=https://wizmann.top/tags/basic-paxos/>Basic Paxos</a></li><li><a href=https://wizmann.top/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/>数据库</a></li><li><a href=https://wizmann.top/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/>分布式系统</a></li><li><a href=https://wizmann.top/tags/%E4%B8%80%E8%87%B4%E6%80%A7/>一致性</a></li></ul><nav class=paginav><a class=prev href=https://wizmann.top/posts/paxos-raft-pecifaca1/><span class=title>«</span><br><span>白话一致性协议 - Paxos、Raft和PacificA[1]</span>
</a><a class=next href=https://wizmann.top/posts/qnsaver/><span class=title>»</span><br><span>七牛云图床自救指南（附github图床小工具）</span></a></nav></footer><div id=disqus_thread></div><script>(function(){var e=document,t=e.createElement("script");t.src="https://wizmann.disqus.com/embed.js",t.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(t)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript></article></main><footer class=footer><span>&copy; 2025 <a href=https://wizmann.top/>Maerlyn's Rainbow</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>