<!doctype html><html lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=Content-Security-Policy content="script-src 'self'; style-src 'self' 'unsafe-inline'; object-src 'none'; base-uri 'none'"><link rel=stylesheet href=/css/style.feedcd92d05c2cf19ee7487656b358ee4805f831b7b39711851199d0a6f8934cf9ba379d02425d485c5b65ae299bdffda3770739545d595074076bf3ead284ab.css media=screen integrity="sha512-/u3NktBcLPGe50h2VrNY7kgF+DG3s5cRhRGZ0Kb4k0z5ujedAkJdSFxbZa4pm9/9o3cHOVRdWVB0B2vz6tKEqw==" crossorigin=anonymous><title>6.824 Lab 2: Raft协议实现指南 （无剧透版）</title>
<meta name=description content="背景 MIT6.824是一个用来学习分布式系统的非常好的资源。其中第二个课程作业就是关于Raft算法。
由于在工作中涉及到分布一致性算法的调研，接触了paxos/raft算法。然后被@neutronest安利了一发，于是开始着手实现这个作业。
"><link rel=canonical href=https://wizmann.top/posts/raft-lab-mit-6.824/><link rel=alternate hreflang=zh-CN href=https://wizmann.top/posts/raft-lab-mit-6.824/><link rel=alternate hreflang=x-default href=https://wizmann.top/posts/raft-lab-mit-6.824/><meta property="og:title" content="6.824 Lab 2: Raft协议实现指南 （无剧透版）"><meta property="og:description" content="背景
MIT6.824是一个用来学习分布式系统的非常好的资源。其中第二个课程作业就是关于Raft算法。
由于在工作中涉及到分布一致性算法的调研，接触了paxos/raft算法。然后被@neutronest安利了一发，于是开始着手实现这个作业。"><meta property="og:type" content="article"><meta property="og:url" content="https://wizmann.top/posts/raft-lab-mit-6.824/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-05-02T21:33:00+00:00"><meta property="article:modified_time" content="2019-05-02T21:33:00+00:00"><meta property="og:site_name" content="Maerlyn's Rainbow"><meta name=twitter:card content="summary"><meta name=twitter:title content="6.824 Lab 2: Raft协议实现指南 （无剧透版）"><meta name=twitter:description content="背景
MIT6.824是一个用来学习分布式系统的非常好的资源。其中第二个课程作业就是关于Raft算法。
由于在工作中涉及到分布一致性算法的调研，接触了paxos/raft算法。然后被@neutronest安利了一发，于是开始着手实现这个作业。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","headline":"6.824 Lab 2: Raft协议实现指南 （无剧透版）","datePublished":"2019-05-02T21:33:00+00:00","dateModified":"2019-05-02T21:33:00+00:00","mainEntityOfPage":"https://wizmann.top/","publisher":{"@type":"Organization","name":"Maerlyn's Rainbow"},"wordcount":4503,"description":"背景 MIT6.824是一个用来学习分布式系统的非常好的资源。其中第二个课程作业就是关于Raft算法。\n由于在工作中涉及到分布一致性算法的调研，接触了paxos/raft算法。然后被@neutronest安利了一发，于是开始着手实现这个作业。\n","keywords":null}</script></head><body class="posts single d-flex flex-column min-vh-100"><header class=main-header><nav class="navbar navbar-expand-lg"><div class=container><a class=navbar-brand href=/>Maerlyn's Rainbow
</a><button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#navbarSupportedContent aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarSupportedContent><ul class="menu-main navbar-nav me-auto mb-2 mb-lg-0"></ul></div></div></nav></header><div id=content><div class="container py-3"><h2 id=背景>背景</h2><p>MIT6.824是一个用来学习分布式系统的非常好的资源。其中第二个课程作业就是关于<a href=https://pdos.csail.mit.edu/6.824/labs/lab-raft.html target=_blank rel=noopener>Raft算法</a>。</p><p>由于在工作中涉及到分布一致性算法的调研，接触了paxos/raft算法。然后被@neutronest安利了一发，于是开始着手实现这个作业。</p><p>本文是我对这个项目的实现总结。希望能在划出重点的同时，不涉及实现细节，避免破坏大家的写代码体验。</p><p>本文唯一参考资料：<a href=https://raft.github.io/raft.pdf target=_blank rel=noopener>In Search of an Understandable Consensus Algorithm</a></p><h2 id=任务分解>任务分解</h2><p>在官方文档里，整个项目被分成了2A、2B、2C三个部分：</p><ul><li>2A - 投票与选举</li><li>2B - 一致性</li><li>2C - 可持久化</li></ul><p>实际上，2C的工作量非常少，我们可以把2B和2C合成一个。然后单独提出几个比较重要的测试用例，划分成子项目。任务分解如下：</p><ul><li>2A - 投票与选举</li><li>2B/2C - 一致性和可持久化</li><li>三个难度比较高的Case<ul><li>Test (2B): leader backs up quickly over incorrect follower logs<br>验证协议实现的正确性</li><li>Test (2B): RPC counts aren&rsquo;t too high<br>测试协议是否产生了过多的RPC请求。验证协议的性能。</li><li>Test (2C): Figure 8 (unreliable)<br>测试在极端混乱的情况下，Raft协议是否能及时恢复正常工作。验证协议实现的正确性和性能。</li></ul></li></ul><p>所以推荐大家按顺序以上顺序进行实现。并且充分利用版本控制对代码进行开发和重构。</p><h2 id=需要关注的知识点>需要关注的知识点</h2><p>以下会介绍每一个部分需要重点关注的知识点，内容包括golang基础和论文中的知识点，无剧透，请放心食用。</p><h3 id=准备工作>准备工作</h3><p>golang是一门傲慢的语言，其标准库的缺乏实在是让人感到TMD蛋疼。但是对于一个课程作业来说，我们也没有必要引入一系列第三方库。所以我们先要扩充<code>util.go</code>文件，使其为我们的开发提供更多的便利。</p><h4 id=log模块>Log模块</h4><p>项目给出的<code>DPrintf</code>函数非常简单，只提供了一个<code>fmt.Printf</code>的封装。并不能打印行号和文件名。这里提供一个扩展版本。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>DPrintf</span>(<span style=color:#a6e22e>format</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>a</span> <span style=color:#f92672>...</span><span style=color:#66d9ef>interface</span>{}) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>Debug</span> &gt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>path</span>, <span style=color:#a6e22e>lineno</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>Caller</span>(<span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>file</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>filepath</span>.<span style=color:#a6e22e>Split</span>(<span style=color:#a6e22e>path</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>ok</span>) {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>t</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>();
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>a</span> = append([]<span style=color:#66d9ef>interface</span>{} { <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Format</span>(<span style=color:#e6db74>&#34;2006-01-02 15:04:05.00&#34;</span>), <span style=color:#a6e22e>file</span>, <span style=color:#a6e22e>lineno</span> }, <span style=color:#a6e22e>a</span><span style=color:#f92672>...</span>);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;%s [%s:%d] &#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>format</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;\n&#34;</span>, <span style=color:#a6e22e>a</span><span style=color:#f92672>...</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>其输出示例如下：</p><div class="goat svg-container"><svg font-family="Menlo,Lucida Console,monospace" viewBox="0 0 1e3 25"><g transform="translate(8,16)"><text text-anchor="middle" x="0" y="4" fill="currentcolor" style="font-size:1em">2</text><text text-anchor="middle" x="8" y="4" fill="currentcolor" style="font-size:1em">0</text><text text-anchor="middle" x="16" y="4" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="24" y="4" fill="currentcolor" style="font-size:1em">9</text><text text-anchor="middle" x="32" y="4" fill="currentcolor" style="font-size:1em">-</text><text text-anchor="middle" x="40" y="4" fill="currentcolor" style="font-size:1em">0</text><text text-anchor="middle" x="48" y="4" fill="currentcolor" style="font-size:1em">5</text><text text-anchor="middle" x="56" y="4" fill="currentcolor" style="font-size:1em">-</text><text text-anchor="middle" x="64" y="4" fill="currentcolor" style="font-size:1em">0</text><text text-anchor="middle" x="72" y="4" fill="currentcolor" style="font-size:1em">2</text><text text-anchor="middle" x="88" y="4" fill="currentcolor" style="font-size:1em">0</text><text text-anchor="middle" x="96" y="4" fill="currentcolor" style="font-size:1em">9</text><text text-anchor="middle" x="104" y="4" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="112" y="4" fill="currentcolor" style="font-size:1em">2</text><text text-anchor="middle" x="120" y="4" fill="currentcolor" style="font-size:1em">8</text><text text-anchor="middle" x="128" y="4" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="136" y="4" fill="currentcolor" style="font-size:1em">3</text><text text-anchor="middle" x="144" y="4" fill="currentcolor" style="font-size:1em">5</text><text text-anchor="middle" x="152" y="4" fill="currentcolor" style="font-size:1em">.</text><text text-anchor="middle" x="160" y="4" fill="currentcolor" style="font-size:1em">0</text><text text-anchor="middle" x="168" y="4" fill="currentcolor" style="font-size:1em">4</text><text text-anchor="middle" x="184" y="4" fill="currentcolor" style="font-size:1em">[</text><text text-anchor="middle" x="192" y="4" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="200" y="4" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="208" y="4" fill="currentcolor" style="font-size:1em">f</text><text text-anchor="middle" x="216" y="4" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="224" y="4" fill="currentcolor" style="font-size:1em">.</text><text text-anchor="middle" x="232" y="4" fill="currentcolor" style="font-size:1em">g</text><text text-anchor="middle" x="240" y="4" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="248" y="4" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="256" y="4" fill="currentcolor" style="font-size:1em">6</text><text text-anchor="middle" x="264" y="4" fill="currentcolor" style="font-size:1em">5</text><text text-anchor="middle" x="272" y="4" fill="currentcolor" style="font-size:1em">2</text><text text-anchor="middle" x="280" y="4" fill="currentcolor" style="font-size:1em">]</text><text text-anchor="middle" x="296" y="4" fill="currentcolor" style="font-size:1em">N</text><text text-anchor="middle" x="304" y="4" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="312" y="4" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="320" y="4" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="328" y="4" fill="currentcolor" style="font-size:1em">[</text><text text-anchor="middle" x="336" y="4" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="344" y="4" fill="currentcolor" style="font-size:1em">]</text><text text-anchor="middle" x="360" y="4" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="368" y="4" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="384" y="4" fill="currentcolor" style="font-size:1em">p</text><text text-anchor="middle" x="392" y="4" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="400" y="4" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="408" y="4" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="416" y="4" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="424" y="4" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="432" y="4" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="440" y="4" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="448" y="4" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="456" y="4" fill="currentcolor" style="font-size:1em">g</text><text text-anchor="middle" x="464" y="4" fill="currentcolor" style="font-size:1em">,</text><text text-anchor="middle" x="480" y="4" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="488" y="4" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="496" y="4" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="504" y="4" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="512" y="4" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="520" y="4" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="536" y="4" fill="currentcolor" style="font-size:1em">[</text><text text-anchor="middle" x="544" y="4" fill="currentcolor" style="font-size:1em">L</text><text text-anchor="middle" x="552" y="4" fill="currentcolor" style="font-size:1em">E</text><text text-anchor="middle" x="560" y="4" fill="currentcolor" style="font-size:1em">A</text><text text-anchor="middle" x="568" y="4" fill="currentcolor" style="font-size:1em">D</text><text text-anchor="middle" x="576" y="4" fill="currentcolor" style="font-size:1em">E</text><text text-anchor="middle" x="584" y="4" fill="currentcolor" style="font-size:1em">R</text><text text-anchor="middle" x="592" y="4" fill="currentcolor" style="font-size:1em">]</text><text text-anchor="middle" x="600" y="4" fill="currentcolor" style="font-size:1em">,</text><text text-anchor="middle" x="616" y="4" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="624" y="4" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="632" y="4" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="640" y="4" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="656" y="4" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="664" y="4" fill="currentcolor" style="font-size:1em">,</text><text text-anchor="middle" x="680" y="4" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="688" y="4" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="696" y="4" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="704" y="4" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="712" y="4" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="720" y="4" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="728" y="4" fill="currentcolor" style="font-size:1em">I</text><text text-anchor="middle" x="736" y="4" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="744" y="4" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="752" y="4" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="760" y="4" fill="currentcolor" style="font-size:1em">x</text><text text-anchor="middle" x="768" y="4" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="784" y="4" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="792" y="4" fill="currentcolor" style="font-size:1em">2</text><text text-anchor="middle" x="800" y="4" fill="currentcolor" style="font-size:1em">,</text><text text-anchor="middle" x="816" y="4" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="824" y="4" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="832" y="4" fill="currentcolor" style="font-size:1em">g</text><text text-anchor="middle" x="840" y="4" fill="currentcolor" style="font-size:1em">C</text><text text-anchor="middle" x="848" y="4" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="856" y="4" fill="currentcolor" style="font-size:1em">u</text><text text-anchor="middle" x="864" y="4" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="872" y="4" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="880" y="4" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="896" y="4" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="904" y="4" fill="currentcolor" style="font-size:1em">2</text><text text-anchor="middle" x="912" y="4" fill="currentcolor" style="font-size:1em">,</text><text text-anchor="middle" x="928" y="4" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="936" y="4" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="944" y="4" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="952" y="4" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="960" y="4" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="968" y="4" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="984" y="4" fill="currentcolor" style="font-size:1em">1</text></g></svg></div><h4 id=max和min函数>Max和Min函数</h4><p>golang是没有对于int值的<code>max</code>和<code>min</code>函数的，这里省略脏话100句。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Min</span>(<span style=color:#a6e22e>a</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>b</span> <span style=color:#66d9ef>int</span>) (<span style=color:#66d9ef>int</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>a</span> &lt; <span style=color:#a6e22e>b</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>a</span>;
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>b</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Max</span>(<span style=color:#a6e22e>a</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>b</span> <span style=color:#66d9ef>int</span>) (<span style=color:#66d9ef>int</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>a</span> &gt; <span style=color:#a6e22e>b</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>a</span>;
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>b</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=assert函数>Assert函数</h4><p>是的，你没有看错，golang也没有提供<code>assert</code>函数。如果你嫌到处写<code>if</code>和<code>panic</code>太丑的话，可以使用这个<code>assert</code>函数。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Assert</span>(<span style=color:#a6e22e>flag</span> <span style=color:#66d9ef>bool</span>, <span style=color:#a6e22e>format</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>a</span> <span style=color:#f92672>...</span><span style=color:#66d9ef>interface</span>{}) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (!<span style=color:#a6e22e>flag</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>path</span>, <span style=color:#a6e22e>lineno</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>Caller</span>(<span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>file</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>filepath</span>.<span style=color:#a6e22e>Split</span>(<span style=color:#a6e22e>path</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>ok</span>) {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>t</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>();
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>a</span> = append([]<span style=color:#66d9ef>interface</span>{} { <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Format</span>(<span style=color:#e6db74>&#34;2006-01-02 15:04:05.00&#34;</span>), <span style=color:#a6e22e>file</span>, <span style=color:#a6e22e>lineno</span> }, <span style=color:#a6e22e>a</span><span style=color:#f92672>...</span>);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>reason</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;%s [%s:%d] &#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>format</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;\n&#34;</span>, <span style=color:#a6e22e>a</span><span style=color:#f92672>...</span>);
</span></span><span style=display:flex><span>            panic(<span style=color:#a6e22e>reason</span>);
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>            panic(<span style=color:#e6db74>&#34;&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=log-id>Log Id</h4><p>为了验证日志的一致性，我们在日志中额外加入一个UUID来进行标识。</p><div class="goat svg-container"><svg font-family="Menlo,Lucida Console,monospace" viewBox="0 0 656 233"><g transform="translate(8,16)"><text text-anchor="middle" x="0" y="4" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="0" y="36" fill="currentcolor" style="font-size:1em">f</text><text text-anchor="middle" x="0" y="212" fill="currentcolor" style="font-size:1em">}</text><text text-anchor="middle" x="8" y="4" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="8" y="36" fill="currentcolor" style="font-size:1em">u</text><text text-anchor="middle" x="16" y="4" fill="currentcolor" style="font-size:1em">p</text><text text-anchor="middle" x="16" y="36" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="24" y="4" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="24" y="36" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="32" y="4" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="32" y="52" fill="currentcolor" style="font-size:1em">b</text><text text-anchor="middle" x="32" y="68" fill="currentcolor" style="font-size:1em">_</text><text text-anchor="middle" x="32" y="84" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="32" y="132" fill="currentcolor" style="font-size:1em">}</text><text text-anchor="middle" x="32" y="164" fill="currentcolor" style="font-size:1em">u</text><text text-anchor="middle" x="32" y="196" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="40" y="4" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="40" y="36" fill="currentcolor" style="font-size:1em">C</text><text text-anchor="middle" x="40" y="68" fill="currentcolor" style="font-size:1em">,</text><text text-anchor="middle" x="40" y="84" fill="currentcolor" style="font-size:1em">f</text><text text-anchor="middle" x="40" y="164" fill="currentcolor" style="font-size:1em">u</text><text text-anchor="middle" x="40" y="196" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="48" y="36" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="48" y="52" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="48" y="164" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="48" y="196" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="56" y="4" fill="currentcolor" style="font-size:1em">"</text><text text-anchor="middle" x="56" y="36" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="56" y="52" fill="currentcolor" style="font-size:1em">=</text><text text-anchor="middle" x="56" y="68" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="56" y="84" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="56" y="164" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="56" y="196" fill="currentcolor" style="font-size:1em">u</text><text text-anchor="middle" x="64" y="4" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="64" y="36" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="64" y="68" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="64" y="84" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="64" y="100" fill="currentcolor" style="font-size:1em">f</text><text text-anchor="middle" x="64" y="116" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="64" y="196" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="72" y="4" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="72" y="36" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="72" y="52" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="72" y="68" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="72" y="84" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="72" y="100" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="72" y="116" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="72" y="164" fill="currentcolor" style="font-size:1em">=</text><text text-anchor="middle" x="72" y="196" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="80" y="4" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="80" y="36" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="80" y="52" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="80" y="100" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="80" y="116" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="88" y="4" fill="currentcolor" style="font-size:1em">h</text><text text-anchor="middle" x="88" y="36" fill="currentcolor" style="font-size:1em">L</text><text text-anchor="middle" x="88" y="52" fill="currentcolor" style="font-size:1em">k</text><text text-anchor="middle" x="88" y="68" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="88" y="84" fill="currentcolor" style="font-size:1em">!</text><text text-anchor="middle" x="88" y="100" fill="currentcolor" style="font-size:1em">.</text><text text-anchor="middle" x="88" y="116" fill="currentcolor" style="font-size:1em">u</text><text text-anchor="middle" x="88" y="164" fill="currentcolor" style="font-size:1em">f</text><text text-anchor="middle" x="88" y="196" fill="currentcolor" style="font-size:1em">u</text><text text-anchor="middle" x="96" y="4" fill="currentcolor" style="font-size:1em">/</text><text text-anchor="middle" x="96" y="36" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="96" y="52" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="96" y="68" fill="currentcolor" style="font-size:1em">=</text><text text-anchor="middle" x="96" y="84" fill="currentcolor" style="font-size:1em">=</text><text text-anchor="middle" x="96" y="100" fill="currentcolor" style="font-size:1em">P</text><text text-anchor="middle" x="96" y="116" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="96" y="164" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="96" y="196" fill="currentcolor" style="font-size:1em">u</text><text text-anchor="middle" x="104" y="4" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="104" y="36" fill="currentcolor" style="font-size:1em">g</text><text text-anchor="middle" x="104" y="52" fill="currentcolor" style="font-size:1em">(</text><text text-anchor="middle" x="104" y="100" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="104" y="116" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="104" y="164" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="104" y="196" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="112" y="4" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="112" y="36" fill="currentcolor" style="font-size:1em">I</text><text text-anchor="middle" x="112" y="52" fill="currentcolor" style="font-size:1em">[</text><text text-anchor="middle" x="112" y="68" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="112" y="84" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="112" y="100" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="112" y="164" fill="currentcolor" style="font-size:1em">.</text><text text-anchor="middle" x="112" y="196" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="120" y="4" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="120" y="36" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="120" y="52" fill="currentcolor" style="font-size:1em">]</text><text text-anchor="middle" x="120" y="68" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="120" y="84" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="120" y="100" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="120" y="164" fill="currentcolor" style="font-size:1em">S</text><text text-anchor="middle" x="128" y="4" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="128" y="36" fill="currentcolor" style="font-size:1em">(</text><text text-anchor="middle" x="128" y="52" fill="currentcolor" style="font-size:1em">b</text><text text-anchor="middle" x="128" y="68" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="128" y="84" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="128" y="100" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="128" y="164" fill="currentcolor" style="font-size:1em">p</text><text text-anchor="middle" x="136" y="4" fill="currentcolor" style="font-size:1em">"</text><text text-anchor="middle" x="136" y="36" fill="currentcolor" style="font-size:1em">)</text><text text-anchor="middle" x="136" y="52" fill="currentcolor" style="font-size:1em">y</text><text text-anchor="middle" x="136" y="68" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="136" y="100" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="136" y="164" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="144" y="52" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="144" y="68" fill="currentcolor" style="font-size:1em">.</text><text text-anchor="middle" x="144" y="84" fill="currentcolor" style="font-size:1em">{</text><text text-anchor="middle" x="144" y="100" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="144" y="164" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="152" y="36" fill="currentcolor" style="font-size:1em">(</text><text text-anchor="middle" x="152" y="52" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="152" y="68" fill="currentcolor" style="font-size:1em">R</text><text text-anchor="middle" x="152" y="100" fill="currentcolor" style="font-size:1em">(</text><text text-anchor="middle" x="152" y="164" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="160" y="36" fill="currentcolor" style="font-size:1em">u</text><text text-anchor="middle" x="160" y="52" fill="currentcolor" style="font-size:1em">,</text><text text-anchor="middle" x="160" y="68" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="160" y="100" fill="currentcolor" style="font-size:1em">"</text><text text-anchor="middle" x="160" y="164" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="168" y="36" fill="currentcolor" style="font-size:1em">u</text><text text-anchor="middle" x="168" y="68" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="168" y="100" fill="currentcolor" style="font-size:1em">E</text><text text-anchor="middle" x="168" y="164" fill="currentcolor" style="font-size:1em">f</text><text text-anchor="middle" x="176" y="36" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="176" y="52" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="176" y="68" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="176" y="100" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="176" y="164" fill="currentcolor" style="font-size:1em">(</text><text text-anchor="middle" x="184" y="36" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="184" y="52" fill="currentcolor" style="font-size:1em">6</text><text text-anchor="middle" x="184" y="68" fill="currentcolor" style="font-size:1em">(</text><text text-anchor="middle" x="184" y="100" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="184" y="164" fill="currentcolor" style="font-size:1em">"</text><text text-anchor="middle" x="192" y="52" fill="currentcolor" style="font-size:1em">)</text><text text-anchor="middle" x="192" y="68" fill="currentcolor" style="font-size:1em">b</text><text text-anchor="middle" x="192" y="100" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="192" y="164" fill="currentcolor" style="font-size:1em">%</text><text text-anchor="middle" x="200" y="36" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="200" y="68" fill="currentcolor" style="font-size:1em">)</text><text text-anchor="middle" x="200" y="100" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="200" y="164" fill="currentcolor" style="font-size:1em">X</text><text text-anchor="middle" x="208" y="36" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="208" y="100" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="208" y="164" fill="currentcolor" style="font-size:1em">-</text><text text-anchor="middle" x="216" y="36" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="216" y="164" fill="currentcolor" style="font-size:1em">%</text><text text-anchor="middle" x="224" y="36" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="224" y="100" fill="currentcolor" style="font-size:1em">"</text><text text-anchor="middle" x="224" y="164" fill="currentcolor" style="font-size:1em">X</text><text text-anchor="middle" x="232" y="36" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="232" y="100" fill="currentcolor" style="font-size:1em">,</text><text text-anchor="middle" x="232" y="164" fill="currentcolor" style="font-size:1em">-</text><text text-anchor="middle" x="240" y="36" fill="currentcolor" style="font-size:1em">g</text><text text-anchor="middle" x="240" y="164" fill="currentcolor" style="font-size:1em">%</text><text text-anchor="middle" x="248" y="36" fill="currentcolor" style="font-size:1em">)</text><text text-anchor="middle" x="248" y="100" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="248" y="164" fill="currentcolor" style="font-size:1em">X</text><text text-anchor="middle" x="256" y="100" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="256" y="164" fill="currentcolor" style="font-size:1em">-</text><text text-anchor="middle" x="264" y="36" fill="currentcolor" style="font-size:1em">{</text><text text-anchor="middle" x="264" y="100" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="264" y="164" fill="currentcolor" style="font-size:1em">%</text><text text-anchor="middle" x="272" y="100" fill="currentcolor" style="font-size:1em">)</text><text text-anchor="middle" x="272" y="164" fill="currentcolor" style="font-size:1em">X</text><text text-anchor="middle" x="280" y="164" fill="currentcolor" style="font-size:1em">-</text><text text-anchor="middle" x="288" y="164" fill="currentcolor" style="font-size:1em">%</text><text text-anchor="middle" x="296" y="164" fill="currentcolor" style="font-size:1em">X</text><text text-anchor="middle" x="304" y="164" fill="currentcolor" style="font-size:1em">"</text><text text-anchor="middle" x="312" y="164" fill="currentcolor" style="font-size:1em">,</text><text text-anchor="middle" x="328" y="164" fill="currentcolor" style="font-size:1em">b</text><text text-anchor="middle" x="336" y="164" fill="currentcolor" style="font-size:1em">[</text><text text-anchor="middle" x="344" y="164" fill="currentcolor" style="font-size:1em">0</text><text text-anchor="middle" x="352" y="164" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="360" y="164" fill="currentcolor" style="font-size:1em">4</text><text text-anchor="middle" x="368" y="164" fill="currentcolor" style="font-size:1em">]</text><text text-anchor="middle" x="376" y="164" fill="currentcolor" style="font-size:1em">,</text><text text-anchor="middle" x="392" y="164" fill="currentcolor" style="font-size:1em">b</text><text text-anchor="middle" x="400" y="164" fill="currentcolor" style="font-size:1em">[</text><text text-anchor="middle" x="408" y="164" fill="currentcolor" style="font-size:1em">4</text><text text-anchor="middle" x="416" y="164" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="424" y="164" fill="currentcolor" style="font-size:1em">6</text><text text-anchor="middle" x="432" y="164" fill="currentcolor" style="font-size:1em">]</text><text text-anchor="middle" x="440" y="164" fill="currentcolor" style="font-size:1em">,</text><text text-anchor="middle" x="456" y="164" fill="currentcolor" style="font-size:1em">b</text><text text-anchor="middle" x="464" y="164" fill="currentcolor" style="font-size:1em">[</text><text text-anchor="middle" x="472" y="164" fill="currentcolor" style="font-size:1em">6</text><text text-anchor="middle" x="480" y="164" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="488" y="164" fill="currentcolor" style="font-size:1em">8</text><text text-anchor="middle" x="496" y="164" fill="currentcolor" style="font-size:1em">]</text><text text-anchor="middle" x="504" y="164" fill="currentcolor" style="font-size:1em">,</text><text text-anchor="middle" x="520" y="164" fill="currentcolor" style="font-size:1em">b</text><text text-anchor="middle" x="528" y="164" fill="currentcolor" style="font-size:1em">[</text><text text-anchor="middle" x="536" y="164" fill="currentcolor" style="font-size:1em">8</text><text text-anchor="middle" x="544" y="164" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="552" y="164" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="560" y="164" fill="currentcolor" style="font-size:1em">0</text><text text-anchor="middle" x="568" y="164" fill="currentcolor" style="font-size:1em">]</text><text text-anchor="middle" x="576" y="164" fill="currentcolor" style="font-size:1em">,</text><text text-anchor="middle" x="592" y="164" fill="currentcolor" style="font-size:1em">b</text><text text-anchor="middle" x="600" y="164" fill="currentcolor" style="font-size:1em">[</text><text text-anchor="middle" x="608" y="164" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="616" y="164" fill="currentcolor" style="font-size:1em">0</text><text text-anchor="middle" x="624" y="164" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="632" y="164" fill="currentcolor" style="font-size:1em">]</text><text text-anchor="middle" x="640" y="164" fill="currentcolor" style="font-size:1em">)</text></g></svg></div><p>以上代码可以生成一个（伪）UUID对日志进行标识。推荐使用<code>math/rand</code>，因为这里我们使用伪随机数就够了。</p><blockquote><p>注：这里的UUID只是看起来像一个UUID，实际上UUID有其特殊的规范与格式。但是由于golang内部没有提供可用的UUID库，所以只好随手模拟了一个。</p></blockquote><h4 id=文件组织>文件组织</h4><p>默认的实现是把所有的东西都写到了<code>raft.go</code>文件里。一个非常大的文件可能会给我们的开发带来负担，所以我的做法是把所有的类声明放到<code>models.go</code>文件里。以避免文件的膨胀。</p><h4 id=锁与defer>锁与defer</h4><p>在raft实现中，锁可以用来保证在多线程环境下数据的正确性。所以只要在涉及到raft内部状态的变化时，都需要加锁。一个常见的加锁pattern是：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>() <span style=color:#75715e>// 加锁</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>() <span style=color:#75715e>// 在函数执行完成后解锁</span>
</span></span></code></pre></div><p>这里推荐使用defer，因为手动控制锁实现是过于容易出错。但是defer也是有坑的！</p><p>不同于C++的大括号作用域，defer的触发时间是在函数执行完成之后，而并不是退出当前大括号时。这点非常需要注意，否则极易出现死锁。</p><p>如果我们想实现C++中<code>do { ... } while (0);</code>类似的lock guard pattern，可以使用以下实现：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>    <span style=color:#75715e>// do something here</span>
</span></span><span style=display:flex><span>}()
</span></span></code></pre></div><p>这样一来，在执行完当前lambda之后，就会自动解锁。</p><h4 id=刷新定时器>刷新定时器</h4><p>由于raft算法里面使用了定时器，这里提供一个刷新定时器的golang代码。这样实现是为了每次在刷新的时候，清空定时器中原有的超时时间，以避免混乱。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>renewTimer</span>(<span style=color:#a6e22e>timeout</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>timer</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>timer</span> = <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>NewTimer</span>(<span style=color:#a6e22e>timeout</span>)
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (!<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>timer</span>.<span style=color:#a6e22e>Stop</span>()) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>select</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>timer</span>.<span style=color:#a6e22e>C</span>:
</span></span><span style=display:flex><span>                <span style=color:#75715e>// pass</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>default</span>:
</span></span><span style=display:flex><span>                <span style=color:#75715e>// pass</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>timer</span>.<span style=color:#a6e22e>Reset</span>(<span style=color:#a6e22e>timeout</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>以及，在定时器超时之后，不要忘了更新定时器。</p><h3 id=2a---投票与选举>2A - 投票与选举</h3><h4 id=所需要类的声明>所需要类的声明</h4><p>论文中的<code>Figure2</code>包含了算法中所有的类以及基本算法。在2A中，所有的类都会被用到。由于2A中只包括投票与选举，所以和日志相关的字段可以先忽略掉。</p><h4 id=checklist-for-2a>Checklist for 2A</h4><ul><li>实现raft状态机的三个状态：leader，follower和candidate</li><li>实现RPC函数：<code>sendRequestVote</code>（发送端）和<code>RequestVote</code>（接收端的回调函数）</li><li>实现RPC函数：<code>sendAppendEntries</code>（发送端）和<code>AppendEntries</code>（接收端的回调函数）</li><li>保证raft状态机的任期号（<code>currentTerm</code>）是单调递增的</li><li>一个Follower对于某一个Term只能投出一票</li><li>实现Leader心跳，维护当前任期（Term）。</li><li>实现Follower选举超时（election timeout）</li><li>实现Candidate选举的三种场景<ul><li>获得多数选票，赢得选举。状态切换为Leader</li><li>其它的节点已经被选为Leader。状态切换为Follower</li><li>在选举中并未获得多数选票，状态切换为Follower</li></ul></li><li>实现Candidate随机选举超时（randomized election timeout）</li></ul><h3 id=2b2c---日志复制与持久化>2B/2C - 日志复制与持久化</h3><h4 id=基本工作流>基本工作流</h4><p>日志复制的基本工作流如下：</p><p>Leader接受用户请求，将状态变化写入本机的日志流中，并且把日志复制到Followers。如果本条日志合法，Followers会将这条日志标记为“提交”（committed），然后再将这条日志“应用”（apply）到Raft协议之外的状态机。Follower在提交日志之后，就可以向Leader回报这条日志已经被提交。在本条日志被多数节点提交之后，Leader再将这条日志标记为提交。此时，用户的请求就可以被确认（ACK）了。</p><p>Raft的论文中，Leader需要维护<code>commitIndex</code>和<code>lastApplied</code>这两个状态。为了简单起见，我们可以忽略“应用”（apply）这个过程。这两个状态我们只需要维护<code>commitIndex</code>即可。</p><blockquote><p>Raft协议不是2PC，千万不要搞混了哦～</p></blockquote><h4 id=回滚与滚回来>回滚与滚回来</h4><p><img src=https://raw.githubusercontent.com/Wizmann/assets/3f1056d6f142755204092fb89a474dc964608bab/wizmann-pic/2019-05-02_14-40-52.png alt=rollback></p><p>从上面的工作流我们可以看到，对于已经committed的日志，仍然有可能是不可靠的。</p><p>例如，在Term1时，节点1作业Leader提交到了日志(1, 2)，而Follower节点Node2和Node3分别提交到了日志(1, 2)和(1, 3)。此时Leader短暂断线，出发选举超时，就会进行下一轮的选举。如果节点Node2被选为Leader，那么节点Node3就会被Leader多出一条日志，这是不被允许的。如果节点Node3被选为Leader，那么Node2就比Leader在Term1少一条日志，需要补齐。</p><blockquote><p>这里有人可能会怀疑，节点2比节点3少一条日志，那么按照论文里的说法，因为节点3的日志比较节点2要多，所以只有节点3才能赢得下一轮选举。这其实是不对的，如果节点3断线，节点1和节点2仍然可以组成一个quorum，选举出Leader。</p></blockquote><p>所以我们需要考虑将已committed的日志回滚（向左滚），以及缺失的日志补齐（向右滚）。这里其实有一些优化的点，我们后文再说。</p><p>再次注意，保证日志的一致性是Raft协议正确性的必须保证，在这一点上一定要注意。</p><h4 id=乱序请求>乱序请求</h4><p>本项目中，模拟的RPC协议并不能保证可靠性（会丢包）、有序性（会乱序），也没有SLA（没有超时时间的上限），更不用想拥塞控制。我们可以理解为它在底层使用了UDP协议，而不是TCP。所以我们不能做出任何假设。</p><p>例如，两个请求先后来到Leader端，A请求编号(1,100)，B请求编号(1,110)。然后我们依次将Log复制到Follower端（A先B后），但是在Follower端有可能收到的顺序是B先A后。甚至只收到B，没收到A。这种情况日常工程中的TCP协议下几乎不能发生，但是在测试环境中要十分小心。</p><h4 id=checklist-for-2b2c>Checklist for 2B/2C</h4><ul><li>日志的状态会影响Leader选举<br>如果两份日志流的最后一条日志的Term不一样，那么我们认为Term号大的日志“比较新”。如果Term号一样，那么Index大的日志“比较新”</li><li>如果Leader和Follower的日志不一致，那么Follower需要拷贝Leader的日志（向左滚或向右滚的正确性）<br>这里推荐使用Assert加断言进行保证，如果出错可以获得实时的现场</li><li>对于小于当前Term的日志，Leader不需要等多数Follower确认就可以直接commit</li><li>一个重要特性：如果两个日志的(Term, Index)一致，那么其内容也是一致的。并且在此日志之前的所有日志都必须是一致的</li><li>另一个重要特性：RPC请求是幂等的，也就是多次重复发送一个请求并不会破坏Raft协议的状态</li></ul><h3 id=最后的3个case>最后的3个Case</h3><p>最后的三个Case有一个共同点，就是对协议的效率和正确性有比较高的要求。即使前面的代码里你的实现是正确的，也有可能因为各种其它的原因造成Case挂掉。</p><p>建议首先解决正确性问题，再提升效率。</p><h4 id=向左滚的优化重要>向左滚的优化（重要！）</h4><p>在论文的5.3节，介绍了一种回滚的优化。如果Leader和Follower在某个Index上的日志不一致，Leader的版本记为(Term1, Index)，Follower的版本记为(Term2, Index)。那么Follower需要回滚所有日志，直到Term小于<code>Min(Term1, Term2)</code>。</p><p>这样的好处是可以加快回滚的效率。虽然论文上表示这种优化并非必要，但是在模拟出来的极端网络环境下，这样的优化可以帮助我们通过一些比较变态的Case。</p><h4 id=其它的非官方优化>其它的非官方优化</h4><p>这里还有一些论文里没的提到的优化方案，不保证一定是正确的。</p><p>为了不剧透，放到单独的链接里了：<a href=https://github.com/Wizmann/assets/blob/master/wizmann-pic/19-05-02/raft-hints.md target=_blank rel=noopener>剧透警告！</a></p><blockquote><p>还有一个Bonus挑战，谁比较闲可以试一下。</p></blockquote><h2 id=测试结果>测试结果</h2><p><img src=https://raw.githubusercontent.com/Wizmann/assets/e35dd59aa533ddd19065f070dcb85a3734cc035d/wizmann-pic/19-05-02/2019-05-02_21-37-14.png alt=tests></p><p>在Travis CI上面运行的测试。自我感觉实现的比较一般，所以你们的程序应该跑的比我快一点才正常。</p><h2 id=总结>总结</h2><p>想要完整正确的实现这个项目，首先一定要把论文读懂。并且划出实现上应该注意的重点。</p><p>当遇到正确性问题时，一定要回归论文，大部分的问题都可以获得解答。当遇到性能问题时，可以参考作业上面的Hints，里面也有非常有用的信息。</p><p>MIT的这个课程还有基于raft实现kv storage的项目，后续如果有时间应该还会做吧。</p></div></div><footer class="py-3 mt-auto bg-light"><div class="container py-1 my-1"><div class="d-flex flex-wrap justify-content-between align-items-center"><p class="col-md mb-0 text-muted"></p><ul class="nav col-md-auto justify-content-end"></ul></div></div></footer><script src=/js/main.min.e8d88c82c0438b527f1aca4115652ba1e2877bf805b75593b23ac0e3fe2b3fe95a467d1feef275355132ba061da6404b0d24d55afabc209b294b1db043be014d.js integrity="sha512-6NiMgsBDi1J/GspBFWUroeKHe/gFt1WTsjrA4/4rP+laRn0f7vJ1NVEyugYdpkBLDSTVWvq8IJspSx2wQ74BTQ==" crossorigin=anonymous defer></script></body></html>