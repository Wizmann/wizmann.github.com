<!doctype html><html lang=zh-CN dir=ltr><head><script>window.MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"],["\\[","\\]"]]},svg:{fontCache:"global"}}</script><script defer src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script></head><body class=notransition><div id=container><header id=main-header><div role=navigation aria-label=Main><div class=nav-left><a href=https://wizmann.top/ style=color:inherit>Maerlyn's Rainbow</a></div><div class=nav-right><div style=position:absolute;width:0;height:0><div id=nav-dropdown-menu class=hidden href=#><div class=nav-item><a aria-current=true class=ancestor href=/posts/>Posts</a></div></div></div><a id=nav-dropdown-button href=#><svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M4 6H20M4 12H20M4 18H20" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></a><div id=nav-menu><div class=nav-item><a aria-current=true class=ancestor href=/posts/>Posts</a></div></div><a id=theme-switcher href=#><svg class="light-icon" viewBox="0 0 24 24" fill="none"><path d="M12 3V4m0 16v1M4 12H3M6.31412 6.31412 5.5 5.5m12.1859.81412L18.5 5.5M6.31412 17.69 5.5 18.5001M17.6859 17.69 18.5 18.5001M21 12H20m-4 0c0 2.2091-1.7909 4-4 4-2.20914.0-4-1.7909-4-4 0-2.20914 1.79086-4 4-4 2.2091.0 4 1.79086 4 4z" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg><svg class="dark-icon" viewBox="0 0 24 24" fill="none"><path d="M3.32031 11.6835c0 4.9706 4.02944 9 8.99999 9 3.7872.0 7.028-2.3392 8.3565-5.6515C19.6402 15.4486 18.5059 15.6834 17.3203 15.6834c-4.9706.0-8.99999-4.0294-8.99999-8.99998C8.32031 5.50338 8.55165 4.36259 8.96453 3.32996 5.65605 4.66028 3.32031 7.89912 3.32031 11.6835z" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></a></div></div></header><div class="flex grow"><div id=main-pane><main id=main-content><div class=single-header><ol class=breadcrumbs itemscope itemtype=https://schema.org/BreadcrumbList><li itemprop=itemListElement itemscope itemtype=https://schema.org/ListItem><a itemprop=item href=https://wizmann.top/><span itemprop=name></span>
</a><meta itemprop=position content='1'></li><span>&nbsp»&nbsp</span><li itemprop=itemListElement itemscope itemtype=https://schema.org/ListItem><a itemprop=item href=https://wizmann.top/posts/><span itemprop=name>Posts</span>
</a><meta itemprop=position content='2'></li><span>&nbsp»&nbsp</span></ol><h1>自己动手搭建第三方的Codeforces CDN</h1><time class=dim datetime=2013-12-14T00:00:00+00:00>December 14, 2013</time><div class=term-container><div class=tag><a href=https://wizmann.top/tags/codeforces/>#codeforces</a></div><div class=tag><a href=https://wizmann.top/tags/chrome-extension/>#chrome-extension</a></div><div class=tag><a href=https://wizmann.top/tags/useless/>#useless</a></div></ol></div><section class=page-section><h2 id=啥>啥？</h2><p>校园网上CF那叫一个卡。</p><p>原因是什么呢？ 因为codeforces大量的使用了ajax技术，所以引用了很多js/css文件，并且引用的位置位于页面之前。</p><p>这就造成了，我们在上CF的时候，其实页面内容已经读取出来了。但是因为js/css文件没有加载完成，所以页面还是一片空白。</p><h2 id=解决方案>解决方案</h2><p>由于js/css/img文件都是所谓的<code>静态</code>文件，那么我们可以缓存这些文件到一个访问速度快的网络上来。</p><p>这就是CDN技术。</p><blockquote><p>CDN的全称是Content Delivery Network，即内容分发网络。其目的是通过在现有的Internet中增加一层新的网络架构，将网站的内容发布到最接近用户的网络“边缘”，使用户可以就近取得所需的内容，提高用户访问网站的响应速度</p></blockquote><p>但是俄罗斯人那边没有做CDN，或者他们的CDN距离天朝实在是太远了。</p><p>所以我们只好手动缓存这些静态文件到七牛云上，使用七牛的CDN技术来加速我们的访问了。</p><p><a href=http://www.qiniu.com/>七牛云</a>为个人用户提供了10G存储空间和每月10G流量，这对于我们缓存一个网站的静态文件来说，已经足富裕了。根据我现在的使用状况，所有静态文件加在一起大概在3M左右，搭建这样一个免费CDN可以供十几个人使用。</p><h2 id=设计架构>设计架构</h2><p>我们使用<code>CS模式</code>来完成这个网站加速的任务。</p><p>Server端当然就是七牛云啦。复杂的任务都交给了工程师们完成，我们只需要声明需要缓存<code>codeforces.com</code>的静态文件就可以了。</p><p>Client端使用的是Chrome-extension。Chrome-extension使用<code>webRequest</code>来“劫持”我们的流量，将其指向我们的七牛云缓存。</p><h2 id=server端配置>Server端配置</h2><p>非常简单的操作。设置一个镜像存储就可以了。</p><p><img src=https://github.com/Wizmann/assets/raw/master/wizmann-tk-pic/blog-codeforces-cdn-qiniu-settings.png alt=七牛云设置></p><p>然后我们记下七牛云为我们分配的域名，以备后用。</p><h2 id=client端配置>Client端配置</h2><p>这个稍微复杂一点，不过也是很轻松的。</p><p>我们新建一个开发版的chrome-extension。（由于我没有开发者账号，所以一般都是线下开发，放到github上让大家搞的。</p><p>写<code>manifest.json</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;Codeforce CDN加速&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;version&#34;</span>: <span style=color:#e6db74>&#34;0.1&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;description&#34;</span>: <span style=color:#e6db74>&#34;个人性趣所致，不承担任何可能的风险&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;permissions&#34;</span>: [
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;tabs&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;http://*.codeforces.com/*&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;http://*.codeforces.ru/*&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;webRequestBlocking&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;webRequest&#34;</span>
</span></span><span style=display:flex><span>    ],
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;background&#34;</span>:  { <span style=color:#f92672>&#34;scripts&#34;</span>: [<span style=color:#e6db74>&#34;codeforces_cdn.js&#34;</span>] },
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;browser_action&#34;</span>:{
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;default_title&#34;</span>: <span style=color:#e6db74>&#34;Codeforce CDN加速&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;default_icon&#34;</span>: <span style=color:#e6db74>&#34;icon.png&#34;</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;icons&#34;</span>:{
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;16&#34;</span>: <span style=color:#e6db74>&#34;icon.png&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;48&#34;</span>: <span style=color:#e6db74>&#34;icon.png&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;128&#34;</span>:<span style=color:#e6db74>&#34;icon.png&#34;</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;manifest_version&#34;</span>: <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>然后写<code>background.js</code>，“劫持”发往<code>work.codeforces.ru</code>的流量。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>chrome</span>.<span style=color:#a6e22e>webRequest</span>.<span style=color:#a6e22e>onBeforeRequest</span>.<span style=color:#a6e22e>addListener</span>(
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>details</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>details</span>.<span style=color:#a6e22e>url</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>details</span>.<span style=color:#a6e22e>url</span>.<span style=color:#a6e22e>match</span>(<span style=color:#e6db74>&#34;http://worker.codeforces.ru&#34;</span>)) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>url</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>details</span>.<span style=color:#a6e22e>url</span>.<span style=color:#a6e22e>replace</span>(
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#34;http://worker.codeforces.ru&#34;</span>,
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#34;http://你的七牛云域名.com&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> {<span style=color:#a6e22e>redirectUrl</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>url</span>};
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    {<span style=color:#a6e22e>urls</span><span style=color:#f92672>:</span>[<span style=color:#e6db74>&#34;http://worker.codeforces.ru/*&#34;</span>]},
</span></span><span style=display:flex><span>    [<span style=color:#e6db74>&#34;blocking&#34;</span>]
</span></span><span style=display:flex><span>);
</span></span></code></pre></div><p>然后安装插件，就可以完美使用了。</p><p>根据我的实验，在清空浏览器缓存的情况下。加速前需要3min的页面大概现在只需要不到10s。</p><h2 id=潜在问题以及不完美的解决方案>潜在问题以及不完美的解决方案</h2><p>由于我们是第三方的山寨CDN，所以当codeforces.com更新它的静态文件时，我们是不知道的。</p><p>所以我们需要一个刷新静态文件的机制。但是我们又不能监控文件改变。</p><p>最终，我想到的一个不完美的解决方案是定时刷新。</p><p>详细来说，就是每周找一个时间，清空我们的缓存。在下一次访问的时候，七牛云会自动替我们刷新所有的静态文件。</p><p>七牛云的python-sdk提供了遍历/删除文件的方案（我在里面还找到了一个小小的Bug）。我们只需要定时执行它就可以了。</p><p>于是我使用了BAE + bottle.py + niqiu-python-sdk的组合。在BAE上部署了一个bottle.py应用，然后使用<code>cron</code>定时执行刷新任务。</p><h2 id=代码>代码</h2><p>Github: <a href=https://github.com/Wizmann/codeforces-cdn>戳我</a></p></section></main><footer id=main-footer><div class=footer><a href=#></a><div class=footer-copyright><div class=dim>© 2025</div><div></div></div></div></footer></div><aside id=side-pane class=side-sticky><div class=side-details><span>1369 </span><span>4 - 5</span></div><h3></h3><nav id=TableOfContents><ul><li><a href=#啥>啥？</a></li><li><a href=#解决方案>解决方案</a></li><li><a href=#设计架构>设计架构</a></li><li><a href=#server端配置>Server端配置</a></li><li><a href=#client端配置>Client端配置</a></li><li><a href=#潜在问题以及不完美的解决方案>潜在问题以及不完美的解决方案</a></li><li><a href=#代码>代码</a></li></ul></nav><h3></h3><ul><li><a href=/posts/cf-218-div-2/>Codeforces Round #218 (Div. 2)不完全不正确题解</a></li><li><a href=/posts/cf-215-div-2/>Codeforces Round #215 (Div. 2)不完全不正确题解</a></li></ul></aside></div></div></body></html>