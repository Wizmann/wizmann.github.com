<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Epoll on Maerlyn's Rainbow</title><link>https://wizmann.top/tags/epoll/</link><description>Recent content in Epoll on Maerlyn's Rainbow</description><generator>Hugo -- gohugo.io</generator><language>zh-CN</language><lastBuildDate>Mon, 17 Oct 2016 01:28:40 +0000</lastBuildDate><atom:link href="https://wizmann.top/tags/epoll/index.xml" rel="self" type="application/rss+xml"/><item><title>ä½¿ç”¨epollé©±åŠ¨ucontext - phxrpcä»£ç é˜…è¯»(5)</title><link>https://wizmann.top/posts/phxrpc-5/</link><pubDate>Mon, 17 Oct 2016 01:28:40 +0000</pubDate><guid>https://wizmann.top/posts/phxrpc-5/</guid><description>&lt;h2 id="ç”¨pipeå«é†’ä½ --epollnotifier">ç”¨pipeå«é†’ä½  â€” EpollNotifier &lt;a href="#%e7%94%a8pipe%e5%8f%ab%e9%86%92%e4%bd%a0--epollnotifier" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>&lt;code>class EpollNotifier&lt;/code>ç±»å‹å°è£…äº†ä¸€ä¸ªä½¿ç”¨pipeä¼ é€’ä¿¡å·çš„Notifierç±»ã€‚&lt;/p>
&lt;p>&lt;code>Run()&lt;/code>å‡½æ•°ï¼ˆå…¶å®æˆ‘è§‰å¾—å«Registeræˆ–Activateä¼šæ›´å¥½ï¼‰é¦–å…ˆå£°æ˜äº†ä¸¤ä¸ªå•å‘çš„pipeï¼š&lt;code>pipe_fds_&lt;/code>ï¼Œä»&lt;a href="http://man7.org/linux/man-pages/man2fpipe.2.html">æ–‡æ¡£&lt;/a>ä¸­æˆ‘ä»¬å¯ä»¥çŸ¥é“&lt;code>pipe_fds_[0]&lt;/code>æ˜¯è¯»ç®¡é“ï¼Œè€Œ&lt;code>pipe_fds_[1]&lt;/code>æ˜¯å†™ç®¡é“ã€‚è¿™é‡Œæœ‰ä¸€ä¸ç‚¹åç›´è§‰ï¼Œå°±æ˜¯pipeæ‹¿äº†ä¸¤ä¸ªfdï¼Œä½†æ˜¯ä»æ—§æ˜¯å•å·¥çš„ã€‚&lt;/p>
&lt;p>&lt;img src="https://github.com/Wizmann/assets/raw/master/wizmann-pic/16-10-16/2335602.jpg" alt="">&lt;/p>
&lt;p>ç„¶åå°†è¯»fdè®¾ä¸º&lt;code>O_NONBLOCK&lt;/code>ä»¥ä¾›epollè°ƒåº¦ï¼Œæœ€åå°†&lt;code>Func()&lt;/code>å‡½æ•°ä¼ å…¥&lt;code>scheduler_&lt;/code>ä¸­ã€‚&lt;/p>
&lt;blockquote>
&lt;p>è¿™é‡Œè·‘ä¸ªé¢˜ï¼Œæƒ³èµ·äº†å½“å¹´æˆ‘å¤§ä¸€çš„æ—¶å€™ä¸Šè¿‡çš„é€šä¿¡å¯¼è®ºçš„é€‰ä¿®è¯¾ã€‚é‚£ä¼šæˆ‘è¿˜æ²¡æœ‰æ²‰è¿·ä»£ç ï¼Œè¿˜æ˜¯ä¸€ä¸ªç§¯æä¹è§‚å¥½å¥½å­¦ä¹ çš„æ–°æ—¶ä»£å¤§å­¦ç”Ÿã€‚è‡ªä»å¼€å§‹å†™äº†ä»£ç ï¼Œäººå°±è¶Šæ¥è¶ŠåºŸç‰©äº†ï¼Œè¿å¥³æœ‹å‹éƒ½æ‰¾ä¸åˆ°äº†ã€‚ &lt;br>
å¹´è½»äººä»¬å•Šï¼Œæœ‰é¥­è¾™å¹²ç‚¹å•¥éƒ½è¡Œï¼Œåƒä¸‡åˆ«å†™ç å•Šã€‚&lt;/p>&lt;/blockquote>
&lt;p>&lt;code>Func()&lt;/code>å‡½æ•°åšçš„äº‹æƒ…å¾ˆç®€å•ï¼Œå°±æ˜¯ä»ç®¡é“é‡Œå°è¯•pollä¸€æ®µæ•°æ®ï¼Œæ‹¿åˆ°æ•°æ®åç›´æ¥æ‰”æ‰ã€‚å› ä¸ºç®¡é“é‡Œä¼ æ¥çš„æ•°æ®å¹¶æ²¡æœ‰å®é™…æ„ä¹‰ï¼Œè¿™æ ·è®¾è®¡çš„ä¸»è¦æ„ä¹‰åœ¨äºå”¤é†’epollã€‚&lt;/p>
&lt;p>æˆ‘ä»¬å¯ä»¥ä»&lt;code>Notify()&lt;/code>å‡½æ•°ä¸­çœ‹å‡ºï¼Œä¼ å…¥ç®¡é“çš„æ˜¯ä¸€ä¸ªå­—ç¬¦&amp;quot;a&amp;quot;ã€‚&lt;/p>
&lt;h2 id="è°ƒåº¦å™¨ç±»--uthreadepollscheduler">è°ƒåº¦å™¨ç±» â€” UThreadEpollScheduler &lt;a href="#%e8%b0%83%e5%ba%a6%e5%99%a8%e7%b1%bb--uthreadepollscheduler" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>è°ƒè¯•å™¨ç±»åœ¨åˆå§‹åŒ–æ—¶ï¼Œå£°æ˜äº†åç¨‹æ ˆçš„å¤§å°ä»¥åŠè°ƒè¯•å™¨æ‰€è°ƒåº¦çš„æœ€å¤§ä»»åŠ¡æ•°ã€‚ä¸è¿‡è¿™ä¸ªæœ€å¤§ä»»åŠ¡æ•°æ˜¯ä¸€ä¸ªâ€œè½¯çº¿â€ï¼Œå› ä¸ºåœ¨æœ€æ–°çš„Linuxå†…æ ¸ä¸­ï¼Œepollä½¿ç”¨åŠ¨æ€å†…å­˜ç®¡ç†fdï¼Œ&lt;code>epoll_create&lt;/code>ä¸­çš„&lt;code>size&lt;/code>å‚æ•°å·²ç»å¤±å»äº†ä½œç”¨ã€‚è€Œåé¢&lt;code>epoll_wait&lt;/code>ä¸­çš„&lt;code>max_event&lt;/code>å‚æ•°åªæ˜¯æ¯æ¬¡è¿”å›çš„æœ€å¤ševentæ•°ï¼Œä¹Ÿå°±æ˜¯å¦‚æœæˆ‘ä»¬å‘è°ƒåº¦å™¨ä¸­åŠ å…¥äº†è¶…è¿‡é™åˆ¶çš„fdï¼Œä¹Ÿä¸ä¼šæœ‰ä»€ä¹ˆæ¶åŠ£çš„åæœã€‚ï¼ˆå‚è€ƒ&lt;a href="http://man7.org/linux/man-pages/man2/epoll_create.2.html">epollæ–‡æ¡£&lt;/a>å’Œ&lt;a href="http://man7.org/linux/man-pages/man2/epoll_wait.2.html">epoll_waitæ–‡æ¡£&lt;/a>ï¼‰&lt;/p>
&lt;h3 id="è®©äººæä¸æ‡‚çš„instanceå‡½æ•°">è®©äººæä¸æ‡‚çš„Instanceå‡½æ•° &lt;a href="#%e8%ae%a9%e4%ba%ba%e6%90%9e%e4%b8%8d%e6%87%82%e7%9a%84instance%e5%87%bd%e6%95%b0" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;p>è¿™ä¸ªå‡½æ•°çœ‹èµ·æ¥åƒä¸€ä¸ªSingletonçš„å®ç°ï¼Œä½†æ˜¯æ˜æ˜&lt;code>UThreadEpollScheduler&lt;/code>ç±»çš„æ„é€ å‡½æ•°æ˜¯publicçš„ã€‚ä¹Ÿå°±æ˜¯è¿™ä¸ªå‡½æ•°åƒæ˜¯ä¸€ä¸ªå•ä¾‹ï¼Œä½†å®ƒåˆä¸æ˜¯ä¸€ä¸ªå•ä¾‹ã€‚&lt;/p>
&lt;p>åœ¨å…¶å®ƒçš„ä»£ç ä¸­ï¼Œä¹Ÿæ²¡æœ‰è°ƒç”¨ä¸ªå‡½æ•°çš„åœ°æ–¹ï¼Œæˆ‘è§‰å¾—è¿™ä¸ªå‡½æ•°æ˜¯å¼€å‘è€…å¿˜è®°åˆ äº†ã€‚&lt;/p>
&lt;p>&lt;img src="https://github.com/Wizmann/assets/raw/master/wizmann-pic/16-10-16/85921046.jpg" alt="">&lt;/p>
&lt;h3 id="è¿œå¤æ™ºæ…§--createsocket">è¿œå¤æ™ºæ…§ â€” CreateSocket &lt;a href="#%e8%bf%9c%e5%8f%a4%e6%99%ba%e6%85%a7--createsocket" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;p>è¿™ä¸ªå‡½æ•°å…¶å®æ²¡å•¥å¯è¯´çš„ï¼Œç®—æ˜¯å¯¹&lt;code>UThreadSocket_t&lt;/code>æ„é€ çš„å°è£…ï¼Œä½†æ˜¯è¿™é‡Œé¢æœ‰ä¸€ä¸ªå°æŠ€å·§ï¼Œå°±æ˜¯&lt;code>calloc&lt;/code>çš„ä½¿ç”¨ã€‚&lt;/p>
&lt;p>&lt;code>calloc&lt;/code>çš„ä½œç”¨æ˜¯å‘å†…æ ¸ç”³è¯·ä¸€æ®µæ ˆç©ºé—´ï¼ˆå’Œ&lt;code>malloc&lt;/code>è¡Œä¸ºä¸€è‡´ï¼‰ï¼Œç„¶åå°†è¿™ä¸€æ®µå†…å­˜æ¸…0ã€‚&lt;/p>
&lt;p>ä¸ªäººæ„Ÿè§‰è¿™æ ·åšçš„ç›®çš„æ˜¯é˜²æ­¢æŒ‡é’ˆæ²¡æœ‰åˆå§‹åŒ–å¸¦æ¥çš„ä¸€ç³»åˆ—è¯¡å¼‚çš„é—®é¢˜ã€‚æŠŠæŒ‡é’ˆæ¸…é›¶ï¼Œå¯ä»¥è®©é—®é¢˜åœ¨ç¬¬ä¸€æ—¶é—´å‡ºç°ï¼Œæ–¹ä¾¿å‡ºé”™æ—¶çš„è°ƒè¯•ã€‚ä½†æ˜¯æˆ‘è§‰å¾—è¿˜æ˜¯ç”¨æµ‹è¯•è¦†ç›–è¿™ç§é—®é¢˜å·²ç»å¥½ï¼Œå› ä¸ºç©ºæŒ‡é’ˆåœ¨ç‰¹å®šçš„æƒ…å†µä¸‹ï¼Œä»å¯èƒ½æ˜¯å¯¼è‡´è¯¡å¼‚è¡Œä¸ºçš„æºå¤´ã€‚&lt;/p>
&lt;h3 id="è·‘--run">è·‘ â€” Run &lt;a href="#%e8%b7%91--run" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;p>&lt;code>Run()&lt;/code>å‡½æ•°æ˜¯è°ƒåº¦å™¨çš„æ ¸å¿ƒå‡½æ•°ï¼ˆå½“ç„¶å•¦ï¼‰ï¼Œç®€å•æ¥è¯´å°±æ˜¯ä¸€ä¸ªå¾ªç¯è·å–eventï¼Œç”¨é€‚å½“çš„åç¨‹å¤„ç†eventã€‚&lt;/p>
&lt;p>å‡½æ•°çš„ä¸€å¼€å§‹ï¼Œå…ˆè°ƒç”¨&lt;code>ConsumeTodoList()&lt;/code>å‡½æ•°ï¼Œå°†åˆ—è¡¨ä¸­çš„åç¨‹å…¨éƒ¨æ¿€æ´»ï¼Œå¹¶hangåœ¨epollä¸Šã€‚&lt;/p>
&lt;p>ä¹‹åè¿›å…¥ä¸€ä¸ªâ€œæ­»å¾ªç¯â€ï¼Œé€šè¿‡&lt;code>epoll_wait&lt;/code>å°†æœ‰æ•°æ®å¯è¯»çš„fdå–å‡ºï¼Œå¹¶è°ƒç”¨ç›¸åº”çš„åç¨‹è¿›è¡Œå¤„ç†ã€‚è¿™é‡Œæˆ‘ä»¬çœ‹åˆ°ï¼Œ&lt;code>epoll_wait&lt;/code>çš„è¶…æ—¶æ—¶é—´æ˜¯å†™æ­»çš„4msï¼Œå¹¶æ²¡æœ‰ä½¿ç”¨&lt;code>next_timeout&lt;/code>ç»™å‡ºçš„ä¸‹æ¬¡è¶…æ—¶æ—¶é—´ã€‚è¿™æ˜¯å› ä¸ºè¿™é‡Œæ”¯æŒäº†â€œactive socketâ€ï¼Œå³æœåŠ¡å™¨å¯¹æ´»åŠ¨è¿æ¥æ“ä½œï¼Œä¾‹å¦‚å‘é€å“åº”ç”šè‡³æ–°å»ºä¸€ä¸ªsocketã€‚&lt;/p>
&lt;p>åé¢çš„&lt;code>handler_accepted_fd_func_&lt;/code>å’Œ&lt;code>active socket&lt;/code>æ˜¯ç±»ä¼¼çš„ï¼Œä¸è¿‡è¿™ä¸ªå‡½æ•°æ˜¯ç”¨æ¥å¤„ç†å·²ç»å»ºç«‹å¥½çš„è¿æ¥ï¼Œä¸ºå…¶åˆ†é…ç›¸åº”çš„åç¨‹ã€‚&lt;/p>
&lt;p>æ‰€ä»¥ï¼Œç”±æ­¤å¯è§ï¼Œè¿™ä¸ªå¾ªç¯å³æ˜¯äº‹ä»¶é©±åŠ¨çš„ï¼Œåˆæ˜¯è½®è¯¢çš„ã€‚ç„¶è€Œè¿™ä¸¤ç§æ¨¡å‹ï¼Œå±…ç„¶èƒ½å†™åœ¨ä¸€ä¸ªå‡½æ•°é‡Œï¼ŒçœŸæ˜¯ä»¤äººå°è±¡æ·±åˆ»ã€‚&lt;/p>
&lt;p>&lt;img src="https://github.com/Wizmann/assets/raw/master/wizmann-pic/16-10-16/4157866.jpg" alt="">&lt;/p>
&lt;p>ä¸‹é¢çš„&lt;code>DealwithTimeout&lt;/code>å‡½æ•°å¤„ç†äº†ä¸€ä¸‹è¶…æ—¶çš„åç¨‹ï¼Œå¹¶ä¸”æ›´æ–°äº†&lt;code>next_timeout&lt;/code>å˜é‡ã€‚ç„¶è€Œè¿™ä¸ªå˜é‡å› ä¸ºä¼—æ‰€å‘¨çŸ¥çš„åŸå› ï¼Œå¹¶æ²¡æœ‰ä»€ä¹ˆåµç”¨ã€‚&lt;/p>
&lt;p>&lt;img src="https://github.com/Wizmann/assets/raw/master/wizmann-pic/16-10-16/4157866.jpg" alt="">&lt;/p>
&lt;h2 id="pollæ¥pollå»--ä¸€å †epollå‡½æ•°çš„å°è£…">Pollæ¥Pollå» â€” ä¸€å †epollå‡½æ•°çš„å°è£… &lt;a href="#poll%e6%9d%a5poll%e5%8e%bb--%e4%b8%80%e5%a0%86epoll%e5%87%bd%e6%95%b0%e7%9a%84%e5%b0%81%e8%a3%85" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;h3 id="uthreadpoll1">UThreadPoll(1) &lt;a href="#uthreadpoll1" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;p>&lt;code>UThreadPoll&lt;/code>å‡½æ•°æœ‰ä¸¤ä¸ªç‰ˆæœ¬ï¼Œä¸€ä¸ªæ˜¯pollå•ä¸ªsocketï¼Œå¦å¤–ä¸€ä¸ªæ˜¯pollä¸€å †socketã€‚æˆ‘ä»¬å…ˆä»å•ä¸ªsocketçš„çœ‹èµ·ã€‚&lt;/p>
&lt;p>ç¬¬ä¸€æ­¥æ˜¯æ³¨å†Œä¸€ä¸ªè¶…æ—¶æ—¶é—´ï¼Œç¬¬äºŒæ­¥å°†è¿™ä¸ªsocketæ”¾åˆ°epollçš„ç›‘å¬åˆ—è¡¨ä¸Šã€‚ä¹‹åè°ƒç”¨yieldï¼ŒæŠŠæ§åˆ¶æƒäº¤è¿˜ç»™ä¸»æ§åˆ¶æµã€‚&lt;/p>
&lt;p>å½“epollæ”¶åˆ°ç›¸åº”çš„äº‹ä»¶æ—¶ï¼Œä¸»æ§åˆ¶æµä¼šå°†æ§åˆ¶æƒäº¤è¿˜ç»™åç¨‹ï¼Œåç¨‹å°†socketä»epollç›‘å¬åˆ—è¡¨ä¸­ç§»é™¤ï¼Œä¹‹åè¿›è¡Œåé¢çš„æ“ä½œã€‚&lt;/p>
&lt;p>æ•´ä½“çš„å·¥ä½œæµå¯ä»¥å‚è€ƒä¸‹å›¾ã€‚&lt;/p>
&lt;p>&lt;img src="http://7lrx26.com1.z0.glb.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202016-10-16%2021.33.48.png" alt="image">&lt;/p>
&lt;h3 id="uthreadpoll2---è¾¹ç¼˜è§¦å‘å’Œæ°´å¹³è§¦å‘">UThreadPoll(2) - è¾¹ç¼˜è§¦å‘å’Œæ°´å¹³è§¦å‘ &lt;a href="#uthreadpoll2---%e8%be%b9%e7%bc%98%e8%a7%a6%e5%8f%91%e5%92%8c%e6%b0%b4%e5%b9%b3%e8%a7%a6%e5%8f%91" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;p>epollæœ‰ä¸¤ç§è§¦å‘æ¨¡å¼ï¼Œè¾¹ç¼˜è§¦å‘(edge-trigger, ET)å’Œæ°´å¹³è§¦å‘(level-trigger, LT)ã€‚&lt;/p>
&lt;p>ç®€å•è§£é‡Šä¸€ä¸‹epollçš„è¿™ä¸¤ç§è§¦å‘æ¨¡å¼ã€‚ETæ„å‘³ç€åªè¦æœ‰fdå¯è¯»æˆ–å¯å†™ï¼Œ&lt;code>epoll_wait&lt;/code>å°±è¿”å›è¿™ä¸ªfdï¼Œè€ŒLTæ„å‘³ç€å½“ä¸”ä»…å½“fdç”±â€œä¸å¯è¯»å˜ä¸ºå¯è¯»â€æˆ–ç”±â€œä¸å¯å†™å˜ä¸ºå¯å†™â€æ—¶ï¼Œ&lt;code>epoll_wait&lt;/code>æ‰ä¼šè¿”å›ã€‚ï¼ˆè¿™æœ‰å¯èƒ½å‡ºç°æ‰€è°“çš„â€œç²˜åŒ…â€ç°è±¡ï¼Œè¯¦è§&lt;a href="http://man7.org/linux/man-pages/man7/epoll.7.html">è¿™é‡Œ&lt;/a>ï¼‰&lt;/p>
&lt;blockquote>
&lt;p>ç¬¬ä¸€æ¬¡å¬åˆ°â€œç²˜åŒ…â€è¿™ä¸ªè¯ï¼Œæˆ‘ä¸€ç›´ä»¥ä¸ºè¿™æ˜¯å•¥å¥½åƒçš„ã€‚ã€‚ã€‚&lt;/p>&lt;/blockquote>
&lt;p>è¿™æ„å‘³ç€ï¼Œå½“æˆ‘ä»¬ä½¿ç”¨LTæ—¶ï¼Œæˆ‘ä»¬å¿…é¡»æ¸…ç†å¹²å‡€fdä¸­çš„æ•°æ®ï¼Œå³åªè¦å¯è¯»ï¼Œå°±ä¸€ç›´è¯»ï¼›åªè¦å¯å†™ï¼Œå°±ä¸€ç›´å†™ã€‚å¦åˆ™å°±ä¼šå‡ºç°é—®é¢˜ã€‚&lt;/p>
&lt;p>åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯æ¯”è¾ƒå¸¸ç”¨çš„ETæ¨¡å¼ã€‚å¹¶ä¸”æˆ‘ä»¬åˆ©ç”¨äº†ETçš„ç‰¹æ€§å®ç°äº†â€œç›‘å¬å¤šä¸ªfdï¼Œè¿”å›æœ€æ—©å“åº”çš„é‚£ä¸€ä¸ªâ€ã€‚&lt;/p>
&lt;p>é¦–å…ˆï¼Œæˆ‘ä»¬æ–°å»ºäº†ä¸€ä¸ªepoll fdï¼ˆç®€ç§°å†…éƒ¨epollï¼‰ï¼Œå°†åˆ—è¡¨ä¸­çš„æ‰€æœ‰socketæ”¾åˆ°é‡Œé¢ç›‘å¬ã€‚ä¹‹åå°†è¿™ä¸ªsocket fdæ”¾åˆ°&lt;code>list[0]-&amp;gt;epollfd&lt;/code>æ‰€å¯¹åº”çš„epollï¼ˆç®€ç§°å¤–éƒ¨epollï¼Œé€šå¸¸æ˜¯ä¸»å·¥ä½œå¾ªç¯çš„é‚£ä¸ªepollï¼‰ç›‘å¬åˆ—è¡¨ä¸­ã€‚&lt;/p>
&lt;p>å½“åˆ—è¡¨ä¸­çš„socketæœ‰è¿”å›æ—¶ï¼Œå†…éƒ¨çš„epollä¼šè¿”å›ä¸€ä¸ª&lt;code>EPOLLIN&lt;/code>äº‹ä»¶ï¼Œå¤–éƒ¨çš„epollæ¥æ”¶åˆ°è¿™ä¸ªäº‹ä»¶åï¼Œè¿›è¡Œåç¨‹åˆ‡æ¢ï¼Œå›åˆ°å½“å‰å‡½æ•°ä¸­ã€‚&lt;/p>
&lt;p>ä¸‹ä¸€æ­¥æˆ‘ä»¬&lt;code>epoll_wait&lt;/code>å†…éƒ¨çš„epoll fdï¼Œå› ä¸ºæˆ‘ä»¬ç¡®å®šæ­¤æ—¶ä¸€å®šæœ‰å¯æ“ä½œçš„fdï¼Œæ‰€ä»¥æˆ‘ä»¬å°†&lt;code>epoll_wait&lt;/code>çš„timeoutå‚æ•°è®¾ä¸º0ã€‚ä¹‹åæˆ‘ä»¬å°†è¿”å›çš„fdçš„&lt;code>waited_events&lt;/code>å‚æ•°å¡«å¥½ï¼Œæœ€åè¿”å›æ“ä½œæˆåŠŸçš„fdçš„æ•°ç›®ã€‚&lt;/p>
&lt;p>è¿™ä¸ªå‡½æ•°æ¯”è¾ƒç»•ï¼Œä¸è¿‡æœ‰ä¸€ä¸ªå¥½æ¶ˆæ¯ â€”â€” è¿™ä¸ªå‡½æ•°ä¹Ÿæ²¡æœ‰è¢«å…¶å®ƒåœ°æ–¹è°ƒç”¨è¿‡ã€‚ä¸è¿‡è¿™ç§&lt;code>cascaded epoll&lt;/code>çš„æŠ€å·§ç¡®å®æ˜¯è®©äººè€³ç›®ä¸€æ–°ã€‚&lt;/p>
&lt;p>&lt;img src="https://github.com/Wizmann/assets/raw/master/wizmann-pic/16-10-16/4157866.jpg" alt="">&lt;/p>
&lt;h3 id="å»¶æ—¶æ‰§è¡Œ---uthreadwait">å»¶æ—¶æ‰§è¡Œ - UThreadWait &lt;a href="#%e5%bb%b6%e6%97%b6%e6%89%a7%e8%a1%8c---uthreadwait" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;p>å‰©ä¸‹çš„å‡ ä¸ªå‡½æ•°åŸºæœ¬éƒ½æ˜¯æ— è„‘å°è£…ï¼Œé¡ºç€çœ‹ä¸€éä»£ç åŸºæœ¬å°±çŸ¥é“æ˜¯å•¥æ„æ€äº†ã€‚ä¸è¿‡&lt;code>UThreadWait&lt;/code>è¿™ä¸ªå‡½æ•°æ¯”è¾ƒæœ‰æ„æ€ï¼Œå¯ä»¥ç”¨æ¥å¤ä¹ ä¸€ä¸‹&lt;code>uthread + epoll&lt;/code>çš„å·¥ä½œæµç¨‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">UThreadWait&lt;/span>(UThreadSocket_t &lt;span style="color:#f92672">&amp;amp;&lt;/span> socket, &lt;span style="color:#66d9ef">int&lt;/span> timeout_ms) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> socket.uthread_id &lt;span style="color:#f92672">=&lt;/span> socket.scheduler&lt;span style="color:#f92672">-&amp;gt;&lt;/span>GetCurrUThread();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> socket.scheduler&lt;span style="color:#f92672">-&amp;gt;&lt;/span>AddTimer(&lt;span style="color:#f92672">&amp;amp;&lt;/span>socket, timeout_ms);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> socket.scheduler&lt;span style="color:#f92672">-&amp;gt;&lt;/span>YieldTask();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> socket.scheduler&lt;span style="color:#f92672">-&amp;gt;&lt;/span>RemoveTimer(socket.timer_id);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>é¦–å…ˆï¼Œè·å–å½“å‰uthreadçš„IDï¼Œå½“æˆ‘ä»¬è°ƒç”¨&lt;code>Resume()&lt;/code>å‡½æ•°æ—¶ï¼Œè®©ä»£ç çŸ¥é“æˆ‘ä»¬è¦è¿”å›åˆ°å“ªä¸ªåç¨‹ä¸Šé¢ã€‚&lt;/p>
&lt;p>ç„¶åæˆ‘ä»¬å‘è°ƒåº¦å™¨ä¸­æ·»åŠ ä¸€ä¸ªå®šæ—¶å™¨ã€‚ä¹‹å&lt;code>Yield()&lt;/code>ï¼Œç¦»å¼€å½“å‰åç¨‹ã€‚&lt;/p>
&lt;p>ä¸»å·¥ä½œå¾ªç¯è¿è¡Œåˆ°è¶…æ—¶æ—¶é—´åï¼Œä¼šåœ¨è¿™ä¸ªåç¨‹æ‰“ä¸Šä¸€ä¸ªâ€œè¶…æ—¶â€æ ‡ç­¾ï¼Œç„¶å&lt;code>Resume()&lt;/code>åˆ‡æ¢å›è¿™ä¸ªåç¨‹ä¸Šæ¥ã€‚&lt;/p>
&lt;p>å‰©ä¸‹çš„å·¥ä½œï¼Œå°±äº¤ç”±åç¨‹å†…éƒ¨ç»‘å®šçš„å‡½æ•°æ¥è¿›è¡Œå¤„ç†ã€‚&lt;/p>
&lt;h2 id="å†™åœ¨æœ€å">å†™åœ¨æœ€å &lt;a href="#%e5%86%99%e5%9c%a8%e6%9c%80%e5%90%8e" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>åœ¨ç½‘ç»œç¼–ç¨‹æ–¹é¢ï¼ŒçœŸå¿ƒæ˜¯ä¸€ä¸ªåˆå­¦è€…ã€‚å¾ˆå¤šç”¨è¯å¯èƒ½ä¸æ°å½“ï¼Œä¹Ÿæœ‰ä¸€äº›æ˜¯è‡ªå·±ç”Ÿé€ çš„ã€‚å¤§å®¶é˜…è¯»çš„æ—¶å€™ï¼Œå°½é‡ä»¥ä»£ç å’Œæ›´ä¸“ä¸šçš„æœ¯è¯­ä¸ºå‡†ã€‚&lt;/p>
&lt;p>ç„¶åå› ä¸ºåœ¨è¡Œæ–‡ä¸­ï¼Œå¯èƒ½è¿½æ±‚äº†è¿‡å¤šçš„é€—æ¯”æ„Ÿï¼Œå¯¹åŸä»£ç è°ƒä¾ƒäº†å‡ å¥ã€‚å¹¶æ²¡æœ‰ä»€ä¹ˆæ¶æ„ï¼Œå¦‚æœå“ªé‡Œè¯´çš„ä¸å¯¹ï¼Œæ¬¢è¿æ‹ç –ã€‚&lt;/p>
&lt;p>&lt;img src="http://7lrx26.com1.z0.glb.clouddn.com/IMG_20161017_012107.jpg" alt="image">&lt;/p>
&lt;p>ä½›ç¥–ä¿ä½‘ï¼Œæ°¸æ— Bugã€‚&lt;/p></description></item></channel></rss>