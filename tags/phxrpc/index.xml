<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Phxrpc on Maerlyn's Rainbow</title><link>https://wizmann.top/tags/phxrpc/</link><description>Recent content in Phxrpc on Maerlyn's Rainbow</description><generator>Hugo -- gohugo.io</generator><language>zh-CN</language><lastBuildDate>Sun, 23 Oct 2016 15:50:44 +0000</lastBuildDate><atom:link href="https://wizmann.top/tags/phxrpc/index.xml" rel="self" type="application/rss+xml"/><item><title>æ€»ç»“ - phxrpcä»£ç é˜…è¯»(8)</title><link>https://wizmann.top/posts/phxrpc-8/</link><pubDate>Sun, 23 Oct 2016 15:50:44 +0000</pubDate><guid>https://wizmann.top/posts/phxrpc-8/</guid><description>&lt;h2 id="å†™åœ¨å‰é¢">å†™åœ¨å‰é¢ &lt;a href="#%e5%86%99%e5%9c%a8%e5%89%8d%e9%9d%a2" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>è¿™åº”è¯¥æ˜¯phxrpcä»£ç é˜…è¯»ç³»åˆ—æ­£æ–‡çš„æœ€åä¸€ç¯‡ã€‚é€šè¿‡é˜…è¯»ä»£ç ï¼Œå‘ç°äº†è‡ªå·±åœ¨çŸ¥è¯†ä¸Šçš„è‹¥å¹²ä¸è¶³ã€‚&lt;/p>
&lt;p>ä¸´æ¸Šç¾¡é±¼ï¼Œä¸å¦‚é€€è€Œç»“ç½‘ã€‚æ¥ä¸‹æ¥å¯èƒ½ä¼šåœ¨ç½‘ç»œç¼–ç¨‹æ–¹é¢å†ä¸‹ä¸€ç‚¹å·¥å¤«ã€‚è¯·å¤§å®¶æœŸå¾…ä¸‹ä¸€ä¸ªç³»åˆ—å§ã€‚&lt;/p>
&lt;blockquote>
&lt;p>å…¶å®çœŸæ²¡äººè¯»ï¼Œæˆ‘å°±æ˜¯åœ¨éª—è‡ªå·±ã€‚&lt;/p>&lt;/blockquote>
&lt;h2 id="å…ˆè¡¥å……ä¸€ç‚¹---ä»£ç ç”Ÿæˆ">å…ˆè¡¥å……ä¸€ç‚¹ - ä»£ç ç”Ÿæˆ &lt;a href="#%e5%85%88%e8%a1%a5%e5%85%85%e4%b8%80%e7%82%b9---%e4%bb%a3%e7%a0%81%e7%94%9f%e6%88%90" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>protobufå¹¶ä¸åŒ…å«RPCçš„å®ç°ï¼Œä½†æ˜¯å®ƒå¯ä»¥å£°æ˜rpcã€‚å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯éœ€è¦å®ç°RPCæ¥å£ï¼Œæ¥å®ç°é€šä¿¡ã€‚&lt;/p>
&lt;p>phxrpcä½¿ç”¨protoæ–‡ä»¶æ¥å®šä¹‰æ¥å£ï¼Œç„¶åè§£æå¹¶ä½¿ç”¨ä»£ç æ¨¡æ¿è¿›è¡Œç”Ÿæˆã€‚&lt;/p>
&lt;p>è¿™é‡Œæˆ‘ä»¬ä¸è®¨è®ºä»£ç ç”Ÿæˆçš„ç»†èŠ‚ï¼Œå› ä¸ºpbå®åœ¨å¤ªè¿‡æµè¡Œï¼Œä»£ç ç”Ÿæˆçš„æ–¹æ³•ä¹Ÿæœ‰ä¸å°‘çš„æµæ´¾ã€‚å¹¶ä¸”ç”¨C++æ¥åšä»£ç ç”Ÿæˆï¼ŒçœŸå¿ƒä¸æ˜¯æˆ‘çš„èœã€‚&lt;/p>
&lt;p>æƒ³äº†è§£æ›´å¤šï¼Œå¯ä»¥å‚è€ƒ&lt;a href="http://codemacro.com/2014/08/31/protobuf-rpc/">è¿™ç¯‡åšå®¢&lt;/a>ã€‚&lt;/p>
&lt;h2 id="å·¥ä½œæµç¨‹---å®¢æˆ·ç«¯">å·¥ä½œæµç¨‹ - å®¢æˆ·ç«¯ &lt;a href="#%e5%b7%a5%e4%bd%9c%e6%b5%81%e7%a8%8b---%e5%ae%a2%e6%88%b7%e7%ab%af" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨çš„é€šä¿¡æœ‰å¦‚ä¸‹çš„ç‰¹ç‚¹ï¼š&lt;/p>
&lt;ol>
&lt;li>è¿æ¥å°‘&lt;/li>
&lt;li>è´Ÿè½½å°‘&lt;/li>
&lt;li>é€šä¿¡çš„ä¸»åŠ¨æ–¹&lt;/li>
&lt;/ol>
&lt;p>æ‰€ä»¥ï¼Œæ‰€æœ‰çš„ç½‘ç»œäº¤äº’ç›¸å…³çš„å†…å®¹å¯ä»¥æ‰˜ç®¡ç»™ç½‘ç»œåº“ä¸­çš„åç¨‹ã€‚æ¯ä¸ªåç¨‹ä¸»åŠ¨è¿è¡Œä¸€æ®µæ—¶é—´åï¼Œä¸»åŠ¨æ”¾å¼ƒCPUæ—¶é—´ï¼Œå°†æ§åˆ¶æƒäº¤è¿˜ç»™ä¸»æ§åˆ¶æµçš„epollã€‚&lt;/p>
&lt;p>æ‰€ä»¥åç¨‹ä¸­ä¸èƒ½æœ‰CPUå¯†é›†çš„è¿ç®—ï¼Œå¹¸å¥½é¢å¯¹å¼€å‘è€…ï¼Œphxrpcå¹¶ä¸æš´éœ²å†…éƒ¨å‡½æ•°ï¼Œè€Œæ˜¯å°†CPUå¯†é›†çš„è¿ç®—åˆ†é…ç»™å·¥ä½œçº¿ç¨‹æ¥å®Œæˆã€‚&lt;/p>
&lt;h2 id="å·¥ä½œæµç¨‹---æœåŠ¡ç«¯">å·¥ä½œæµç¨‹ - æœåŠ¡ç«¯ &lt;a href="#%e5%b7%a5%e4%bd%9c%e6%b5%81%e7%a8%8b---%e6%9c%8d%e5%8a%a1%e7%ab%af" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>æœåŠ¡å™¨çš„é€šä¿¡æœ‰ä»¥ä¸‹çš„ç‰¹ç‚¹ï¼š&lt;/p>
&lt;ol>
&lt;li>è¿æ¥å¤š&lt;/li>
&lt;li>è´Ÿè½½å¤š&lt;/li>
&lt;li>é€šä¿¡çš„è¢«åŠ¨æ–¹&lt;/li>
&lt;li>å“åº”æ—¶é—´æ•æ„Ÿ&lt;/li>
&lt;/ol>
&lt;p>è¿™é‡Œè¯´ä¸€ä¸‹å“åº”æ—¶é—´çš„é—®é¢˜ï¼Œå“åº”æ—¶é—´æ˜¯å’Œè´Ÿè½½å¤šå¯¹åº”çš„ã€‚å®¢æˆ·ç«¯ä¸€èˆ¬åªè´Ÿè´£å‘è¯·æ±‚ï¼Œå…¶å“åº”æ—¶é—´å¹¶ä¸åœ¨æ•´ä¸ªç³»ç»Ÿä¸­å ä¸»å¯¼åœ°ä½ï¼Œæ¢å¥è¯è¯´ï¼Œå®¢æˆ·ç«¯å‘è¯·æ±‚æ˜¯å®Œå…¨æœ‰ä¸»åŠ¨æƒçš„ã€‚è€ŒæœåŠ¡ç«¯è´Ÿè´£å“åº”è¯·æ±‚ï¼Œéœ€è¦ç»è¿‡CPUè¿ç®—ï¼Œæˆ–è€…æœ‰ä¸€äº›æœåŠ¡çš„çº§è”æˆ–æ‰‡å‡ºæ“ä½œï¼Œæ‰€ä»¥å“åº”æ—¶é—´æ˜¯ä¸å¯æ§çš„ã€‚&lt;/p>
&lt;p>ç”±ä¸Šé¢æˆ‘ä»¬å¯ä»¥äº†è§£åˆ°ï¼ŒæœåŠ¡å™¨ç«¯è‚¯å®šéœ€è¦ä¸å®¢æˆ·ç«¯ä¸åŒçš„ç­–ç•¥æ¥å¤„ç†è¿æ¥ä¸å“åº”ã€‚&lt;/p>
&lt;p>é¦–å…ˆï¼Œä¸€ä¸ªç‹¬ç«‹çš„çº¿ç¨‹æ¥&lt;strong>åŒæ­¥&lt;/strong>acceptè¯·æ±‚ï¼Œè¿™ä¸ªçº¿ç¨‹å¤§éƒ¨åˆ†çš„æ—¶é—´éƒ½blockåœ¨&lt;code>accept()&lt;/code>é‡Œï¼Œè´Ÿè½½æ¯”è¾ƒä½ã€‚&lt;/p>
&lt;p>åœ¨acceptåˆ°fdåï¼Œå°†å…¶å‹å…¥åˆ°è°ƒåº¦å™¨ä¸­ã€‚ä¹‹åfdä¼šhangåœ¨IOå¾ªç¯ä¸Šï¼Œç›´åˆ°æœ‰è¯·æ±‚åˆ°æ¥ã€‚ä¸æ­¤åŒæ—¶ï¼Œåç¨‹ä¼šè°ƒåº¦å…¶å®ƒçš„fdã€‚&lt;/p>
&lt;p>è¯·æ±‚åˆ°æ¥åï¼ŒIOçº¿ç¨‹ä¼šæŠŠè¯·æ±‚åŠ å…¥é˜Ÿåˆ—ä¸­ï¼ŒæŠŠè‡ªå·±ä»epollè°ƒåº¦ä¸­åˆ é™¤ã€‚ä¹‹åå°±å¼€å§‹ç¡è§‰è§‰ã€‚ç¡é†’äº†ä¹‹åï¼Œå‘ç°å“åº”æ²¡åˆ°ç¢—é‡Œæ¥ï¼Œå°±shutdownè¿æ¥ã€‚(æˆ‘è§‰å¾—è¿™é‡Œåº”è¯¥åŠ å…¥é‡è¯•ï¼Œä¾‹å¦‚ä¸‰æ¬¡å¤±è´¥å†æ–­çº¿)&lt;/p>
&lt;p>å¦‚æœå“åº”æ¥äº†ï¼Œå…ˆä¼šè°ƒç”¨ä¸€ä¸ªæ¿€æ´»fdçš„æ“ä½œï¼Œå°†å“åº”æ”¾åˆ°å°è£…fdçš„ç»“æ„ä½“ä¸­ï¼Œå†å°†è‡ªå·±æ”¾å›åˆ°epollè°ƒåº¦ï¼Œæœ€åé¡ºæ‰‹ç»™epollå‘ä¸€ä¸ªä¿¡å·ã€‚å½“fdå¯å†™æ—¶ï¼Œå†æŠŠå“åº”è¿”å›ç»™å®¢æˆ·ç«¯ã€‚&lt;/p>
&lt;p>ç”±äºphxrpcä½¿ç”¨çš„é€šä¿¡åè®®æ˜¯HTTPï¼Œæ‰€ä»¥ä¸éœ€è¦è€ƒè™‘åˆ†åŒ…çš„é—®é¢˜ã€‚&lt;/p>
&lt;h2 id="å¯èƒ½çš„æ”¹è¿›">å¯èƒ½çš„æ”¹è¿› &lt;a href="#%e5%8f%af%e8%83%bd%e7%9a%84%e6%94%b9%e8%bf%9b" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;h3 id="è°ƒåº¦å™¨çš„è¶…æ—¶">è°ƒåº¦å™¨çš„è¶…æ—¶ &lt;a href="#%e8%b0%83%e5%ba%a6%e5%99%a8%e7%9a%84%e8%b6%85%e6%97%b6" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">int&lt;/span> nfds &lt;span style="color:#f92672">=&lt;/span> epoll_wait(epoll_fd_, events, max_task_, &lt;span style="color:#ae81ff">4&lt;/span>);
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™æ®µè°ƒåº¦å™¨ä¸­çš„ä»£ç ï¼Œç”Ÿç”Ÿçš„æŠŠIOå¤ç”¨æ¨¡å‹æ”¹æˆäº†è½®è¯¢ã€‚çŒœæµ‹è¿™æ˜¯ä¸ºäº†ç…§é¡¾è¶…æ—¶å®šæ—¶å™¨ï¼Œä½†å®é™…ä¸Šè¿™ä¸ªå¹¶æ— å¿…è¦ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨&lt;code>timerfd&lt;/code>å’Œ&lt;code>eventfd&lt;/code>æ¥å–ä»£å®šæ—¶å™¨ã€‚ä½†æ˜¯è¿™åªæ˜¯ä¸€ç§çŒœæµ‹ï¼Œè¿™ç§å†™æ³•å¯èƒ½ä¹Ÿæ˜¯æœ‰æ€§èƒ½ä¸Šçš„è€ƒè™‘å§ã€‚&lt;/p>
&lt;h3 id="ä»£ç é£æ ¼">ä»£ç é£æ ¼ &lt;a href="#%e4%bb%a3%e7%a0%81%e9%a3%8e%e6%a0%bc" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;p>ä»£ç é£æ ¼å¯èƒ½æ˜¯ä¸€ä¸ªæ¯”è¾ƒæ³›çš„é—®é¢˜ï¼Œä½†æ˜¯phxrpcçš„ä»£ç æˆ‘èƒ½æ˜æ˜¾çš„æ„Ÿè§‰åˆ°ç¼–ç é£æ ¼çš„ä¸åŒã€‚ä»¥åŠå…ƒç´ å±‚æ¬¡ä¸æ˜æœ—ï¼Œä¸Šä¸‹çº§æ¨¡å—ç›¸äº’è€¦åˆçš„æƒ…å†µã€‚&lt;/p>
&lt;h3 id="æ²¡æœ‰æµ‹è¯•æ²¡æœ‰æµ‹è¯•æ²¡æœ‰æµ‹è¯•">æ²¡æœ‰æµ‹è¯•ï¼æ²¡æœ‰æµ‹è¯•ï¼æ²¡æœ‰æµ‹è¯•ï¼ &lt;a href="#%e6%b2%a1%e6%9c%89%e6%b5%8b%e8%af%95%e6%b2%a1%e6%9c%89%e6%b5%8b%e8%af%95%e6%b2%a1%e6%9c%89%e6%b5%8b%e8%af%95" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;p>å› ä¸ºphxrpcæ²¡æœ‰æµ‹è¯•ä»£ç ï¼Œæ‰€ä»¥æˆ‘ä¸¥é‡æ€€ç–‘è¿™å°±æ˜¯ä¸€ä¸ªç©ç¥¨çš„é¡¹ç›®ï¼Œæ²¡æœ‰ï¼ˆæˆ–æš‚æ—¶æ²¡æœ‰ï¼‰åœ¨ç”Ÿäº§ç¯å¢ƒä¸Šè¿è¡Œã€‚&lt;/p>
&lt;p>å¦‚æœæœ‰å¯èƒ½çš„è¯ï¼Œè¯·åŠ ä¸Šæ€§èƒ½æµ‹è¯•ï¼è¯·åŠ ä¸ŠåŠŸèƒ½æµ‹è¯•ï¼è¯·åŠ ä¸Šæ€§åŠŸèƒ½æµ‹è¯•ï¼&lt;/p>
&lt;h2 id="å†™åœ¨åé¢">å†™åœ¨åé¢ &lt;a href="#%e5%86%99%e5%9c%a8%e5%90%8e%e9%9d%a2" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>æ—¶é—´ä»“ä¿ƒï¼Œæ°´å¹³æœ‰é™ã€‚å†™ç‚¹ä¸œè¥¿ï¼Œæ–¹ä¾¿å¤§å®¶å­¦ä¹ äº¤æµã€‚&lt;/p>
&lt;p>å¦‚æœæˆ‘å†™çš„å“ªé‡Œä¸å¯¹ï¼Œ99%çš„é”…å½’æˆ‘å‚»é€¼ï¼Œ1%çš„é”…å½’phxrpcä»£ç æ²¡å†™æµ‹è¯•ã€‚æ¬¢è¿å¤§å®¶å¤šåšè‡ªæˆ‘æ‰¹è¯„ã€‚&lt;/p>
&lt;p>å¥½å•¦å¥½å•¦ï¼Œå°±åˆ°è¿™é‡Œå§ã€‚&lt;/p>
&lt;p>&lt;img src="https://github.com/Wizmann/assets/raw/master/wizmann-pic/16-10-23/91802175.jpg" alt="">&lt;/p></description></item><item><title>RPC - phxrpcä»£ç é˜…è¯»(7)</title><link>https://wizmann.top/posts/phxrpc-7/</link><pubDate>Sat, 22 Oct 2016 23:03:36 +0000</pubDate><guid>https://wizmann.top/posts/phxrpc-7/</guid><description>&lt;h2 id="å‰è¨€">å‰è¨€ &lt;a href="#%e5%89%8d%e8%a8%80" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>çœ‹äº†è¿™ä¹ˆä¹…ä»£ç ï¼Œç»ˆäºæˆ‘ä»¬è¦æ¥è¿‘phxrpcçš„æ ¸å¿ƒéƒ¨åˆ†äº†ã€‚&lt;/p>
&lt;p>ä½†æ˜¯å‡ºäººæ„æ–™çš„æ˜¯ï¼Œrpcéƒ¨åˆ†å¹¶æ²¡æœ‰è¿‡å¤šçš„æ¦‚å¿µå’Œmagic trickã€‚è€Œä¸”å› ä¸ºucontextå·²ç»è¢«å°è£…å¥½äº†ï¼Œæ‰€ä»¥åœ¨rpcé‡Œçš„æ“ä½œï¼Œå¯ä»¥å®Œå…¨æŒ‰ç…§åŒæ­¥çš„å†™æ³•æ¥æï¼Œå¼€å‘è€…ä»¬ä¸éœ€è¦åˆ‡æ¢åŒæ­¥å¼‚æ­¥çš„æ€ç»´æ¨¡å¼ï¼Œå°±å¯ä»¥åœ¨åº•å±‚çš„å°è£…ä¹‹ä¸Šï¼Œåšè‡ªå·±æƒ³åšçš„äº‹äº†ã€‚&lt;/p>
&lt;h2 id="çº¿ç¨‹å®‰å…¨çš„é˜Ÿåˆ—---threadqueue">çº¿ç¨‹å®‰å…¨(?)çš„é˜Ÿåˆ— - ThreadQueue &lt;a href="#%e7%ba%bf%e7%a8%8b%e5%ae%89%e5%85%a8%e7%9a%84%e9%98%9f%e5%88%97---threadqueue" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>æˆ‘ä¸çŸ¥é“å¼€å‘è€…ä¸ºå•¥è¦èµ·&lt;code>ThdQueue&lt;/code>è¿™æ ·ä»¤äººè¿·æƒ‘çš„åå­—ï¼Œè¿™ç§è¯¡å¼‚çš„å‘½åé£æ ¼è´¯ç©¿äº†æ•´ä¸ªä»£ç ã€‚å’‹ä¸€çœ‹è¿™ä¸ªç±»æ˜¯maintainä¸€å †çº¿ç¨‹çš„ï¼Œç±»ä¼¼äºçº¿ç¨‹æ± ï¼Œä½†å…¶å®è¿™ä¸ªç±»å°±æ˜¯ä¸€ä¸ª&lt;code>BlockingQueue&lt;/code>çš„å®ç°ã€‚&lt;/p>
&lt;p>ä¹‹åï¼Œè¿™ä¸ªé˜Ÿåˆ—æœ‰ä¸‰ç§æ“ä½œï¼Œ&lt;code>push&lt;/code>ã€&lt;code>pluck&lt;/code>å’Œ&lt;code>break_out&lt;/code>ã€‚pushæ“ä½œä¸ç”¨å¤šè¯´ï¼Œpluckå¯¹åº”çš„æˆ‘ä»¬æ‰€ç†è§£çš„popæ“ä½œï¼Œå³ä»é˜Ÿåˆ—ä¸­å¼¹å‡ºå…ƒç´ ï¼ˆpluckè¿™ä¸ªè¯è²Œä¼¼æ˜¯ä»grpcé‡Œé¢æ¥çš„ï¼Œé‚£æˆ‘å°±ä¸åæ§½äº†ï¼Œæ¯•ç«ŸGoogleçˆ¸çˆ¸ï¼‰ã€‚&lt;/p>
&lt;p>æ›´ä»¤äººç–‘æƒ‘çš„æ˜¯&lt;code>break_out&lt;/code>è¿™ä¸ªæ“ä½œã€‚ä»ä»£ç æ¥çœ‹ï¼Œåƒæ˜¯æ¸…ç©ºé˜Ÿåˆ—ï¼Œå¹¶ä¸”åœ¨dtorä¸­ä¹Ÿæ˜¾å¼çš„è°ƒç”¨äº†è¿™ä¸ªå‡½æ•°ã€‚&lt;/p>
&lt;p>ä½†æ˜¯æœ‰ä»¥ä¸‹çš„å‡ ä¸ªé—®é¢˜ã€‚&lt;/p>
&lt;p>ä¸€ï¼Œ&lt;code>break_out_&lt;/code>æ˜¯ä¸€ä¸ªboolå˜é‡ï¼Œä¸”åœ¨ä¸åŒçº¿ç¨‹é—´å…±äº«ï¼Œé—®é¢˜åœ¨äºè¿™ä¸ªå˜é‡å¯èƒ½è¢«cacheä½ï¼Œç›´æ¥è®¿é—®å¯èƒ½ä¼šé€ æˆéé¢„æœŸçš„ç»“æœï¼Œå¯èƒ½éœ€è¦&lt;code>volitaile&lt;/code>ï¼Œæˆ–è€…åœ¨&lt;code>pluck&lt;/code>å‡½æ•°é‡ŒåŠ ä¸€ä¸ªmem barrierã€‚&lt;/p>
&lt;p>äºŒæ¥ï¼Œåœ¨ææ„å‡½æ•°ä¸­è°ƒç”¨&lt;code>break_out_&lt;/code>ï¼Œæœ‰å¯èƒ½çš„ä¸€ç§æƒ…å†µæ˜¯æœ‰å…¶å®ƒçº¿ç¨‹è¿˜åœ¨&lt;code>pluck&lt;/code>å‡½æ•°ä¸­ï¼Œè€Œ&lt;code>ThdQueue&lt;/code>å¯¹è±¡å·²ç»è¢«ææ„äº†ï¼Œæˆ‘ä»¬å°±éœ€è¦æ‰¿æ‹…è¿™ç§ä¸å®‰å…¨è¡Œä¸ºçš„åæœï¼ˆæ­¤å¤„æœ‰å¹¿å‘Šï¼šå¤§é“æ£å­åŒ»é™¢æ…ä¸»ä»»ï¼Œå¼ å§å»äº†éƒ½è¯´å¥½ï¼‰ã€‚&lt;/p>
&lt;p>å½“ç„¶ï¼Œå¦‚æœè¿™ä¸ªå‡½æ•°åªåœ¨ç»“æŸè¿›ç¨‹æ—¶ä½¿ç”¨ï¼Œå…¶å®å†™çš„ç³™ä¸€ç‚¹ä¹Ÿæ— æ‰€è°“ï¼Œå› ä¸ºæ¯•ç«Ÿçº¿ä¸ŠæœåŠ¡æ˜¯æ²¡æœ‰â€œé€€å‡ºâ€è¿™ç§çŠ¶æ€çš„ã€‚å½“æˆ‘ä»¬è¦æ¸…ç©ºé˜Ÿåˆ—æ—¶ï¼Œå·²ç»ä¸éœ€è¦å¯¹å¤–æä¾›æœåŠ¡ï¼Œä¹‹åç›´æ¥&lt;code>kill -9&lt;/code>å°±å¥½ï¼Œä¸ä¼šè§¦å‘å¤šçº¿ç¨‹çš„å‘ã€‚ä¸è¿‡ï¼Œè¿™é‡Œæˆ‘è§‰å¾—åº”è¯¥è¿˜æ˜¯è¦åŠ å°å¿ƒã€‚&lt;/p>
&lt;h2 id="uthreadcaller">UThreadCaller &lt;a href="#uthreadcaller" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>è¿™ä¸ªç ´ç±»è®©æˆ‘çœ‹äº†ä¸€å°æ—¶ï¼Œåˆ†æå®ƒçš„keepaliveæ˜¯æ€ä¹ˆå®ç°çš„ã€‚ç»“æœå‘ç°è¿™ä¸ªç±»è¢«æ²¡æœ‰è¢«è°ƒç”¨ã€‚&lt;/p>
&lt;p>GGã€‚&lt;/p>
&lt;p>&lt;img src="https://github.com/Wizmann/assets/raw/master/wizmann-pic/16-10-22/54117736.jpg" alt="">&lt;/p>
&lt;h2 id="ä¸€ä¸ªè¶…çº§æ–‡ä»¶---hshaserver">ä¸€ä¸ªè¶…çº§æ–‡ä»¶ - HshaServer &lt;a href="#%e4%b8%80%e4%b8%aa%e8%b6%85%e7%ba%a7%e6%96%87%e4%bb%b6---hshaserver" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;blockquote>
&lt;p>ä¸çŸ¥é“ä¸ºå•¥å¼€å‘è€…è¦æŠŠè¿™ä¹ˆå¤šæ–‡ä»¶å†™ä¸€å—ï¼Œæ‹†å¼€ä¸å¥½å—ï¼Ÿ&lt;/p>&lt;/blockquote>
&lt;h3 id="dataflow">DataFlow &lt;a href="#dataflow" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;p>DataFlowåŒ…å«äº†Requestå’ŒResponseä¸¤ä¸ªQueueï¼Œè¿˜é™„åŠ äº†å…¥é˜Ÿçš„æ—¶é—´æˆ³å’Œä¸€ä¸ªargså‚æ•°æŒ‡é’ˆã€‚&lt;/p>
&lt;h3 id="hshaserverstat">HshaServerStat &lt;a href="#hshaserverstat" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;p>ä¸€ä¸ªç»Ÿè®¡ç±»ã€‚ä¼šåœ¨åå°æ–°å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œçº¦æ¯ä¸€ç§’æ‰“å°ä¸€æ¬¡ç»Ÿè®¡æ—¥å¿—ã€‚&lt;/p>
&lt;p>è¿™ä¸ªç±»é‡Œæœ‰ä¸€ä¸ªæŠ€å·§ï¼Œåœ¨&lt;code>CallFunc()&lt;/code>å‡½æ•°ä¸­ï¼Œæ¯ä¸€ç§’å¾ªç¯ä¸€æ¬¡å¹¶æ²¡æœ‰ä½¿ç”¨sleepå®¶æ—çš„å‡½æ•°ï¼Œä¹Ÿæ²¡æœ‰ä½¿ç”¨selectçš„è¶…æ—¶ã€‚è€Œæ˜¯ä½¿ç”¨äº†&lt;code>condtional variable&lt;/code>ã€‚&lt;/p>
&lt;p>&lt;code>std::condition_variable::wait_for&lt;/code>å‡½æ•°ï¼Œå®è´¨æ˜¯å°±æ˜¯å¸¦è¶…æ—¶çš„ç­‰å¾…ã€‚è€Œè¿™é‡Œï¼Œåœ¨ä¸€èˆ¬çŠ¶æ€ä¸‹ï¼Œæ˜¯æ²¡æœ‰çº¿ç¨‹ä¼šnotifyçš„ï¼Œæ‰€ä»¥wait_forå‡½æ•°ä¼šç¡æ»¡1sã€‚ä½†æ˜¯åœ¨é€€å‡ºæ—¶ï¼Œä¼šæ˜¾å¼çš„notifyç»Ÿè®¡çº¿ç¨‹ï¼Œç ´åç­‰å¾…çŠ¶æ€ï¼Œä½¿ç»Ÿè®¡çº¿ç¨‹é€€å‡ºã€‚&lt;/p>
&lt;p>&lt;code>wait_for&lt;/code>å‡½æ•°çš„å…·ä½“ç”¨æ³•ï¼Œå¯ä»¥å‚è€ƒ&lt;a href="http://en.cppreference.com/w/cpp/thread/condition_variable/wait_for">æ–‡æ¡£&lt;/a>ã€‚&lt;/p>
&lt;p>ä¸‹é¢çš„&lt;code>HshaServerQos&lt;/code>ä¹Ÿæ˜¯ä¸€æ ·çš„æ€è·¯ï¼ŒQoså³â€œQuality of serviceâ€ã€‚&lt;/p>
&lt;h3 id="workerå’Œworkerpool">Workerå’ŒWorkerPool &lt;a href="#worker%e5%92%8cworkerpool" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;p>è¿™ä¸¤ä¸ªç±»å…¶å®æ˜¯ä¸€ä¸ªå’Œä¸€å †çš„å…³ç³»ï¼Œä¸è¿‡ç”±äºè¿™é‡Œçš„è¯¡å¼‚çš„å†™æ³•ï¼Œå¯¼è‡´ä¸€ä¸ªä¾èµ–ä¸€å †ï¼Œä¸€å †è°ƒç”¨ä¸€ä¸ªã€‚&lt;/p>
&lt;p>WorkerPoolæ˜¯ä¸€ä¸ªå…¨å±€çš„çº¿ç¨‹æ± ï¼Œé‡Œé¢æœ‰çº¿ç¨‹ï¼ˆåºŸè¯ï¼‰ï¼Œè¾“å…¥è¾“å‡ºé˜Ÿåˆ—ï¼ŒDisipatcherå’Œè°ƒåº¦å™¨ã€‚æ‰€ä»¥Workerè¦åè¿‡æ¥ä¾èµ–WorkerPoolé‡Œé¢çš„æ•°æ®ã€‚é€ æˆäº†å¾ˆå¤§çš„è€¦åˆæ€§ã€‚&lt;/p>
&lt;p>Workerä»è¾“å…¥é˜Ÿåˆ—ä¸­è·å–ä¿¡æ¯ï¼Œå¹¶ä¸”ä½¿ç”¨&lt;code>dispatcher&lt;/code>è¿›è¡ŒCPUå¯†é›†çš„å¤„ç†ï¼ˆæˆ‘è§‰å¾—&lt;code>dispatcher&lt;/code>è¿™ä¸ªåå­—èµ·çš„ä¹Ÿæœ‰é—®é¢˜ï¼‰ã€‚ä¹‹åå°†ç»“æœæ”¾å…¥è¾“å‡ºé˜Ÿåˆ—ï¼Œç”±åé¢çš„&lt;code>HshaServerIO::ActiveSocketFunc&lt;/code>é©±åŠ¨åç¨‹åº“è¿›è¡Œä¹‹åçš„IOæ“ä½œã€‚&lt;/p>
&lt;h3 id="å®Œæˆè°ƒåº¦å™¨---hshaserverio">å®Œæˆè°ƒåº¦å™¨ - HshaServerIO &lt;a href="#%e5%ae%8c%e6%88%90%e8%b0%83%e5%ba%a6%e5%99%a8---hshaserverio" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;p>è¿™ä¸ªç±»çš„ä¸»è¦ä½œç”¨å°±æ˜¯è¡¥å…¨è°ƒåº¦å™¨ç¼ºå°‘çš„å‡½æ•°ï¼Œå¹¶æä¾›äº†ä¸€ä¸ªIOçš„å·¥ä½œå‡½æ•°&lt;code>HshaServerIO::IOFunc&lt;/code>ã€‚&lt;/p>
&lt;p>è°ƒåº¦å™¨çš„å·¥ä½œæµç¨‹å‰é¢å·²ç»è¯´è¿‡äº†ï¼Œæˆ‘ä»¬ç°åœ¨å°±ä»æ›´å…·ä½“åŒ–çš„å®ç°ä¸Šæ¥é˜…è¯»ä¸€ä¸‹ã€‚&lt;/p>
&lt;p>&lt;code>HshaServerIO :: AddAcceptedFd&lt;/code>ï¼Œè¿™ä¸ªå‡½æ•°ç”±å¤–éƒ¨è°ƒç”¨ï¼Œä¼ å…¥å·²ç»acceptçš„fdï¼Œä¹‹å&lt;code>HshaServerIO::HandlerAcceptedFd&lt;/code>å°†è¿™ä¸ªfdï¼Œå’ŒIOå·¥ä½œå‡½æ•°&lt;code>IOFunc&lt;/code>ä¸€èµ·æ”¾å…¥è°ƒåº¦å™¨ä¸­è¿›è¡Œè°ƒåº¦ã€‚&lt;/p>
&lt;p>å·¥ä½œå‡½æ•°&lt;code>IOFunc&lt;/code>åªè´Ÿè´£å°†è¯·æ±‚æ”¾å…¥é˜Ÿåˆ—ï¼Œè€Œå¹¶ä¸è´Ÿè´£ä»è¾“å‡ºé˜Ÿåˆ—ä¸­å–å‡ºå“åº”ã€‚è¿™ä¸ªäº‹æƒ…ç”±&lt;code>HshaServerIO::ActiveSocketFunc&lt;/code>è´Ÿè´£ã€‚&lt;/p>
&lt;p>æ¢å¥è¯è¯´ï¼Œåœ¨è°ƒåº¦å™¨çš„å·¥ä½œå¾ªç¯ä¸­ï¼Œ&lt;code>epoll_wait&lt;/code>ä¸­ç­‰å¾…çš„åªæœ‰åœ¨è¿›è¡ŒIOçš„ä¸¤ç§fdï¼Œä¸€æ˜¯è¯»è¿˜æ²¡è¯»å®Œçš„ï¼ŒäºŒæ˜¯å†™è¿˜æ²¡å†™å®Œçš„ã€‚&lt;/p>
&lt;p>è¿›è¡Œå®ŒCPUæ“ä½œçš„fdï¼Œç”±&lt;code>active_socket_func_&lt;/code>å‡½æ•°é‡æ–°æ¿€æ´»ï¼Œå‘å®¢æˆ·ç«¯å†™å›å“åº”ã€‚æ‰€ä»¥è¿™ä¸ªå‡½æ•°åº”è¯¥å«&lt;code>activate_socket_with_resp_func_&lt;/code>æ›´åˆé€‚ä¸€äº›ã€‚ï¼ˆè‡³å°‘ç¬¬ä¸€ä¸ªå•è¯å¾—æ˜¯ä¸ªåŠ¨è¯å¥½ä¸ã€‚ï¼‰&lt;/p>
&lt;p>åé¢çš„keepaliveçš„å¤„ç†ä¹Ÿæ˜¯éå¸¸æµ…æ˜¾çš„ï¼Œè¿™é‡Œå°±ä¸å¤šè¯´äº†ã€‚&lt;/p>
&lt;h3 id="å¤šçº¿ç¨‹io---hshaserverunitå’Œhshaserver">å¤šçº¿ç¨‹IO - HshaServerUnitå’ŒHshaServer &lt;a href="#%e5%a4%9a%e7%ba%bf%e7%a8%8bio---hshaserverunit%e5%92%8chshaserver" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;p>å‰é¢æˆ‘ä»¬è¯´äº†ä¸å°‘åç¨‹çš„äº‹ï¼Œä½†è¿™å¹¶ä¸ä»£è¡¨æˆ‘ä»¬ä¸ä½¿ç”¨å¤šçº¿ç¨‹å¸¦æ¥çš„çº¢åˆ©ã€‚æˆ–è€…è‡³å°‘åœ¨æ€§èƒ½ä¸ç¬¦åˆé¢„æœŸçš„æ—¶å€™ï¼Œç”¨å¤šçº¿ç¨‹æ¥tuningä¸€ä¸‹ã€‚&lt;/p>
&lt;p>HashServerUnitåŒ…è£…äº†ä¸€ç»„çº¿ç¨‹ï¼Œå…¶ä¸­åŒ…æ‹¬ä¸€ä¸ªIOçº¿ç¨‹å’Œè‹¥å¹²CPUçº¿ç¨‹ã€‚æˆ‘ä»¬åœ¨HshaServerä¸­ï¼Œè¿˜å¯ä»¥é…ç½®å¤šä¸ªUnitï¼Œä½¿å¾—æˆ‘ä»¬æœ‰å¤šä¸ªIOçº¿ç¨‹ï¼Œå……åˆ†æ¦¨å¹²CPUå’ŒIOçš„æ¯ä¸€æ»´æ±—æ°´ã€‚&lt;/p>
&lt;p>ç”±äºæ‰‹é‡Œä¹Ÿæ²¡æœ‰æµ‹è¯•æ•°æ®ï¼Œä¹Ÿå°±ä¸èƒ½æ›´è¯¦ç»†çš„æ¥è¯´é…ç½®æœåŠ¡å‚æ•°çš„ç­–ç•¥ã€‚ä½†æ˜¯æ— è´£ä»»çŒœæµ‹ï¼ŒIOçº¿ç¨‹åº”è¯¥ä¸è¶…è¿‡3ä¸ªã€‚CPUçº¿ç¨‹æ•°ç›®åº”è¯¥ç•¥å¤šäºCPUæ ¸æ•°ã€‚&lt;/p>
&lt;h3 id="ä¸€ä¸ªç‹¬ç«‹çš„acceptor">ä¸€ä¸ªç‹¬ç«‹çš„Acceptor &lt;a href="#%e4%b8%80%e4%b8%aa%e7%8b%ac%e7%ab%8b%e7%9a%84acceptor" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;p>&lt;code>HshaServerAcceptor&lt;/code>ç±»ç›¸å¯¹æ¯”è¾ƒç‹¬ç«‹ï¼Œå®ƒæ˜¯ç”¨æ¥æ¥å—è®¿é—®è¯·æ±‚ã€‚æ˜¯ä¸»çº¿ç¨‹çš„å·¥ä½œå¾ªç¯ã€‚&lt;/p>
&lt;p>è¿™é‡Œæ¯”è¾ƒå¥‡æ€ªçš„æ˜¯ï¼Œ&lt;code>LoopAccept&lt;/code>å‡½æ•°è®¾ç½®äº†CPUäº²å’Œæ€§ã€‚ä½¿å¾—æ§åˆ¶çº¿ç¨‹åªåœ¨CPU0ä¸Šè¿è¡Œã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span> cpu_set_t mask;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> CPU_ZERO(&lt;span style="color:#f92672">&amp;amp;&lt;/span>mask);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> CPU_SET(&lt;span style="color:#ae81ff">0&lt;/span>, &lt;span style="color:#f92672">&amp;amp;&lt;/span>mask);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> pid_t thread_id &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">int&lt;/span> ret &lt;span style="color:#f92672">=&lt;/span> sched_setaffinity(thread_id, &lt;span style="color:#66d9ef">sizeof&lt;/span>(mask), &lt;span style="color:#f92672">&amp;amp;&lt;/span>mask);
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å…·ä½“åŸå› æœ‰å¾…æ¢è®¨ï¼Œå¯èƒ½æ˜¯å’Œä¸­æ–­äº²å’Œæ€§æœ‰å…³ã€‚&lt;/p>
&lt;h2 id="å†™åœ¨åé¢">å†™åœ¨åé¢ &lt;a href="#%e5%86%99%e5%9c%a8%e5%90%8e%e9%9d%a2" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>æ€»ç®—å›«å›µåæ£çš„æŠŠè¿™RPCè¯»å®Œäº†ï¼Œå…¶å®è¿™é‡Œè¿˜æ˜¯æœ‰å¥½å¤šç–‘é—®çš„ã€‚ä½†æ˜¯ç”±äºphxrpcçš„æ–‡æ¡£å®åœ¨æ˜¯ã€‚ã€‚ã€‚åŸºæœ¬ç®—æ˜¯æ²¡æœ‰å§ã€‚æ‰€ä»¥å¯èƒ½è¿˜è¦å»Githubä¸Šæä¸€æ³¢Issueã€‚&lt;/p>
&lt;p>åœ¨å­¦ä¹ è¿‡ç¨‹ä¸­ï¼ŒçœŸçš„æ„Ÿè§‰è‡ªå·±æ‡‚çš„è¿˜æ˜¯å¤ªå°‘ã€‚ç®€ç›´è¯ä¸¸ã€‚&lt;/p>
&lt;p>è¿˜éœ€è¦æ›´åŠ åŠªåŠ›æ‰å¥½ã€‚&lt;/p></description></item><item><title>éé˜»å¡TCPæµå’ŒHttpClient - phxrpcä»£ç é˜…è¯»(6)</title><link>https://wizmann.top/posts/phxrpc-6/</link><pubDate>Wed, 19 Oct 2016 00:03:12 +0000</pubDate><guid>https://wizmann.top/posts/phxrpc-6/</guid><description>&lt;h2 id="å†™åœ¨å‰é¢">å†™åœ¨å‰é¢ &lt;a href="#%e5%86%99%e5%9c%a8%e5%89%8d%e9%9d%a2" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>å…¶å®è¿™ç‚¹ä¸œè¥¿æœ‰ç‚¹é¸¡è‚‹ã€‚å› ä¸ºTCPæµåœ¨å‰é¢å·²ç»è®²è¿‡ï¼Œéš¾ç‚¹åœ¨äºâ€œæµâ€å’Œâ€œæµç¼“å†²åŒºâ€éƒ¨åˆ†ã€‚è€ŒHttpClientåªæ˜¯TCPæµçš„ä¸€ä¸ªåº”ç”¨ï¼Œä»£ç ä¸å¤šï¼Œä¸”é‡ç‚¹åœ¨äºHTTPåè®®çš„è°ƒæ•™ä¸Šé¢ã€‚&lt;/p>
&lt;p>ä¸è¿‡å› ä¸ºå‰é¢æœ‰å†™é˜»å¡TCPæµï¼Œè¿˜æ˜¯å‰åå‘¼åº”ï¼ŒæŠŠéé˜»å¡TCPæµä¹Ÿå°å°çš„è®²è§£ä¸€ä¸‹ã€‚é¡ºä¾¿é¥¶ä¸€æ®µHttpClientçš„è®²è§£ï¼Œç®—æ˜¯å……å®ä¸€ä¸‹å†…å®¹å§ã€‚&lt;/p>
&lt;h2 id="éé˜»å¡tcpæµç¼“å†²åŒº---uthreadtcpstreambuf">éé˜»å¡TCPæµç¼“å†²åŒº - &lt;code>UThreadTcpStreamBuf&lt;/code> &lt;a href="#%e9%9d%9e%e9%98%bb%e5%a1%9etcp%e6%b5%81%e7%bc%93%e5%86%b2%e5%8c%ba---uthreadtcpstreambuf" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>è¿™ä¸ªå…¶å®æ²¡å•¥å¯è®²çš„ï¼Œä¼ å…¥ä¸€ä¸ª&lt;code>socket&lt;/code>ï¼Œç„¶åè¯»å†™åˆ†åˆ«è°ƒç”¨&lt;code>UThreadRecv&lt;/code>å’Œ&lt;code>UThreadSend&lt;/code>ï¼ŒIOå¤ç”¨å’Œåç¨‹åˆ‡æ¢çš„å¤æ‚æ“ä½œéƒ½è¢«å°è£…åœ¨é‡Œé¢äº†ã€‚å‰©ä¸‹çš„æ“ä½œéƒ½ç”±åŸºç±»å‡½æ•°æ¥è§£å†³ã€‚&lt;/p>
&lt;h2 id="éé˜»å¡tcpæµ---uthreadtcpstream">éé˜»å¡TCPæµ - &lt;code>UThreadTcpStream&lt;/code> &lt;a href="#%e9%9d%9e%e9%98%bb%e5%a1%9etcp%e6%b5%81---uthreadtcpstream" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;blockquote>
&lt;p>ç¡®å®æ²¡å•¥å¯è¯´çš„ï¼Œä½ ä»¬è‡ªå·±å»è¯»ä»£ç å§ã€‚ã€‚ã€‚&lt;/p>&lt;/blockquote>
&lt;p>éé˜»å¡TCPæµå’Œé˜»å¡TCPæµçš„åŒºåˆ«æ˜¯&lt;del>å®ƒä¸é˜»å¡&lt;/del>ï¼Œåœ¨é˜»å¡TCPæµä¸­ï¼Œæˆ‘ä»¬ä¼ å…¥çš„æ˜¯ä¸€ä¸ªTCPæµï¼Œè€Œéé˜»å¡TCPæµä¼ å…¥çš„æ˜¯ä¸€ä¸ªåç¨‹è°ƒåº¦å™¨å’Œä¸€ä¸ªTCPæµã€‚&lt;/p>
&lt;p>è¿™ä¸ªå¾ˆå¥½ç†è§£ï¼Œä¸€ä¸ªé˜»å¡æµè‡ªç„¶ä¼šå æ»¡ä¸€ä¸ªçº¿ç¨‹çš„IOå’ŒCPU â€”â€” åœ¨é˜»å¡æµIOè¯»å†™æ—¶ï¼ŒCPUç©ºé—²ï¼›åœ¨CPUå¿™æ—¶ï¼ŒIOç©ºé—²ã€‚&lt;/p>
&lt;p>è€Œéé˜»å¡æµä¼šå°†è‡ªå·±IO waitçš„æ—¶é—´æ‰˜ç®¡ç»™epollï¼ŒæŠŠå‰©ä¸‹çš„æ—¶é—´ç”¨äºCPUè®¡ç®—ï¼ˆå’Œä¸€äº›overheadä¸Šï¼‰ã€‚æ‰€ä»¥ä¸€ä¸ªçº¿ç¨‹å¯ä»¥handleå¤šä¸ªsocketï¼Œåç¨‹è°ƒåº¦å™¨å°±æ˜¯å¿…é¡»çš„äº†ã€‚ä¹‹åçš„è¯»å†™æ“ä½œå°±äº¤ç”±æˆ‘ä»¬å‰é¢è®¨è®ºè¿‡çš„epollå’Œucontextåç¨‹æ¥å…±åŒå®Œæˆäº†ã€‚&lt;/p>
&lt;h2 id="httpclient">HttpClient &lt;a href="#httpclient" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>å…¶å®è¿™é‡Œåˆ†æHttpClientçš„æ„ä¹‰ä¸æ˜¯å¾ˆå¤§ï¼Œå› ä¸ºHttpæ¯•ç«Ÿæ˜¯ä¸€ä¸ªæˆç†Ÿçš„åè®®ï¼Œç„¶åç›¸åº”çš„è®¾ç½®å«ä¹‰è™½ç„¶æ˜ç¡®ï¼Œä½†æ˜¯æ”¾åˆ°ç›¸åº”çš„ä¸Šä¸‹æ–‡ä¸­åˆ†ææ¯”è¾ƒå¥½ã€‚&lt;/p>
&lt;p>è¿™ç¯‡åšæ–‡&lt;a href="https://www.byvoid.com/blog/http-keep-alive-header">ã€ŠHTTPåè®®å¤´éƒ¨ä¸Keep-Aliveæ¨¡å¼è¯¦è§£ã€‹&lt;/a>ä¸­æœ‰ä¸€éƒ¨åˆ†èƒŒæ™¯çŸ¥è¯†ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥ç®€å•äº†è§£ä¸€ä¸‹ã€‚&lt;/p>
&lt;h3 id="åœ¨httpdispatcherä¸­ä½¿ç”¨çš„ä¸€ä¸ªå°æŠ€å·§">åœ¨HttpDispatcherä¸­ä½¿ç”¨çš„ä¸€ä¸ªå°æŠ€å·§ &lt;a href="#%e5%9c%a8httpdispatcher%e4%b8%ad%e4%bd%bf%e7%94%a8%e7%9a%84%e4%b8%80%e4%b8%aa%e5%b0%8f%e6%8a%80%e5%b7%a7" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;p>åœ¨&lt;code>http_dispatcher.h&lt;/code>æ–‡ä»¶ä¸­ï¼Œä½œè€…ä½¿ç”¨äº†ä¸€ä¸ªæ¯”è¾ƒæ–°å¥‡çš„æŠ€å·§ï¼šâ€œ&lt;a href="http://tipsandtricks.runicsoft.com/Cpp/MemberFunctionPointers.html">Function Pointers to Member Functions&lt;/a>â€ã€‚&lt;/p>
&lt;p>æˆ‘ä»¬æ¥çœ‹ä»£ç ï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code>typedef int (Dispatcher::*URIFunc_t)(const HttpRequest &amp;amp; request, HttpResponse * response);
&lt;/code>&lt;/pre>&lt;p>è¿™è¡Œä»£ç çš„æ„æ€æ˜¯ï¼Œä¸ºä¸€ä¸ªå‚æ•°ä¸º&lt;code>(const HttpRequest&amp;amp;, HttpResponse*)&lt;/code>ä¸”è¿”å›å€¼ä¸º&lt;code>int&lt;/code>çš„å‡½æ•°å£°æ˜ä¸€ä¸ªåˆ«å&lt;code>URIFunc_t&lt;/code>ï¼Œå¹¶ä¸”è¿™ä¸ªå‡½æ•°ï¼Œä¸€å®šæ˜¯&lt;code>Dispatcher&lt;/code>ç±»çš„æˆå‘˜å‡½æ•°ã€‚&lt;/p>
&lt;p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œä¸€åˆ‡éƒ½è¿˜æ˜¯æ­£å¸¸çš„æ ·å­ï¼Œè¯­æ³•ä¹Ÿæ˜¯æˆ‘ä»¬å¸¸è§çš„ç±»å‹ã€‚ä½†æ˜¯ä¸‹é¢è¿™ç§å†™æ³•ï¼Œç¡®å®æ˜¯æˆ‘ç¬¬ä¸€æ¬¡è§ã€‚&lt;/p>
&lt;pre tabindex="0">&lt;code>if (uri_func_map_.end() != iter) {
ret = (dispatcher_.*iter-&amp;gt;second)(request, response);
}
&lt;/code>&lt;/pre>&lt;p>è¿™é‡Œçš„&lt;code>(dispatcher_.*iter-&amp;gt;second)&lt;/code>ï¼Œ&lt;code>iter-&amp;gt;second&lt;/code>æ˜¯ä»mapä¸­æ‹¿å‡ºæ¥çš„ï¼Œåœ¨&lt;code>dispatcher_&lt;/code>å¯¹è±¡ä¸­çš„æˆå‘˜å‡½æ•°çš„æŒ‡é’ˆã€‚æˆ‘ä»¬ä½¿ç”¨æ˜Ÿå·è§£å¼•ç”¨ï¼Œå†æŠŠå®ƒå’Œ&lt;code>dispatcher_&lt;/code>å¯¹è±¡æ‹¼æ¥åœ¨ä¸€èµ·ï¼Œåƒæ­£å¸¸è°ƒç”¨æˆå‘˜å‡½æ•°ä¸€æ ·è°ƒç”¨å°±å¯ä»¥äº†ã€‚&lt;/p>
&lt;h2 id="è²Œä¼¼å†™çš„æœ‰ç‚¹å°‘å†é¥¶ä¸€æ®µå§---epollæµ‹è¯•æœåŠ¡ç«¯å®¢æˆ·ç«¯">è²Œä¼¼å†™çš„æœ‰ç‚¹å°‘ï¼Œå†é¥¶ä¸€æ®µå§ - epollæµ‹è¯•æœåŠ¡ç«¯/å®¢æˆ·ç«¯ &lt;a href="#%e8%b2%8c%e4%bc%bc%e5%86%99%e7%9a%84%e6%9c%89%e7%82%b9%e5%b0%91%e5%86%8d%e9%a5%b6%e4%b8%80%e6%ae%b5%e5%90%a7---epoll%e6%b5%8b%e8%af%95%e6%9c%8d%e5%8a%a1%e7%ab%af%e5%ae%a2%e6%88%b7%e7%ab%af" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>æˆ‘ä»¬ç¿»ç¯‡å›åˆ°&lt;code>network&lt;/code>æ–‡ä»¶å¤¹ä¸‹é¢ï¼Œçœ‹ä¸€ä¸‹&lt;code>test_epoll_[server|client].[h|cpp]&lt;/code>æ–‡ä»¶ã€‚&lt;/p>
&lt;h3 id="epollæµ‹è¯•å®¢æˆ·ç«¯">epollæµ‹è¯•å®¢æˆ·ç«¯ &lt;a href="#epoll%e6%b5%8b%e8%af%95%e5%ae%a2%e6%88%b7%e7%ab%af" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;p>é¦–å…ˆï¼Œæˆ‘ä»¬è¯»å–å‘½ä»¤è¡Œå‚æ•°ï¼Œæ–°å»ºä¸€ä¸ªè°ƒåº¦å™¨ï¼Œç”±å‚æ•°å†³å®šè°ƒåº¦å™¨çš„wokeråç¨‹æ•°é‡ã€‚ä¹‹åæ–°å»º&lt;code>UThreadEpollArgs_t&lt;/code>ï¼ŒæŠŠè°ƒåº¦å™¨æŒ‡é’ˆå¡è¿›å»ã€‚å†ä¹‹åæŠŠ&lt;code>echoclient&lt;/code>å·¥ä½œå‡½æ•°å’Œ&lt;code>args&lt;/code>å‚æ•°æ”¾ç”±è°ƒåº¦å™¨ä¸­è¿›è¡Œè°ƒåº¦ã€‚&lt;/p>
&lt;p>æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹å·¥ä½œå‡½æ•°&lt;code>echoclient&lt;/code>ã€‚&lt;/p>
&lt;p>å·¥ä½œå‡½æ•°çš„ç¬¬ä¸€æ­¥æ˜¯ç”³è¯·ä¸€ä¸ªsocket fdï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code>int fd = ::socket(AF_INET, SOCK_STREAM, IPPROTO_IP);
&lt;/code>&lt;/pre>&lt;p>è¿™é‡Œæˆ‘è§£é‡Šä¸€ä¸‹æœ€åä¸€ä¸ªå‚æ•°&lt;code>IPPROTO_IP&lt;/code>ï¼š&lt;/p>
&lt;blockquote>
&lt;p>In the in.h file, the comment says: Dummy protocol for TCP. &lt;br>
This constant has the value 0. It&amp;rsquo;s actually an automatic choice depending on socket type and family. &lt;br>
If you use it, and if the socket type is SOCK_STREAM and the family is AF_INET, then the protocol will automatically be TCP (exactly the same as if you&amp;rsquo;d used IPPROTO_TCP). Buf if you use IPPROTO_IP together with AF_INET and SOCK_RAW, you will have an error, because the kernel cannot choose a protocol automatically in this case.&lt;/p>&lt;/blockquote>
&lt;p>è¿™ä¸ªå‚æ•°çš„æ„ä¹‰æ˜¯å‘Šè¯‰å†…æ ¸ï¼Œå¦‚æœåªæœ‰ä¸€ä¸ªé€‰é¡¹çš„è¯ï¼Œä½ ç‰¹ä¹ˆçˆ±ç”¨å“ªä¸ªåè®®å°±ç”¨å“ªä¸ªå§ã€‚æ‰€ä»¥æœ‰ä¸€äº›æ—¶å€™ï¼Œæˆ‘ä»¬ä¼šç›´æ¥æŠŠæœ€åä¸€ä¸ªå‚æ•°å†™æˆ0ï¼Œè¿™å°±æ˜¯&lt;code>IPPROTO_IP&lt;/code>å®çš„å­—é¢å€¼ã€‚&lt;/p>
&lt;p>æ›´å¤šä¿¡æ¯ï¼Œå¯ä»¥å‚è€ƒè¿™ä¸ª&lt;a href="http://stackoverflow.com/questions/24590818/what-is-the-difference-between-ipproto-ip-and-ipproto-raw">é—®é¢˜&lt;/a>ã€‚&lt;/p>
&lt;p>åé¢çš„æµç¨‹éå¸¸ç®€å•ï¼Œå…ˆæ¥æ”¶serverå‘æ¥çš„æ¬¢è¿ä¿¡æ¯ï¼Œä¹‹åping pongåæ¬¡ï¼Œå‘é€â€œquitâ€åŒ…åç»“æŸåç¨‹ã€‚&lt;/p>
&lt;h3 id="epollæµ‹è¯•æœåŠ¡ç«¯">epollæµ‹è¯•æœåŠ¡ç«¯ &lt;a href="#epoll%e6%b5%8b%e8%af%95%e6%9c%8d%e5%8a%a1%e7%ab%af" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;p>æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯åŒºåˆ«ä¸å¤§ï¼Œä¸»è¦åŒºåˆ«åœ¨äºå®¢æˆ·ç«¯åœ¨ä¸€å¼€å§‹åªæœ‰ä¸€ä¸ªåç¨‹ã€‚ä¹‹ååœ¨acceptè¿æ¥æ—¶ï¼Œä¼šä¸»åŠ¨æ–°å»ºå·¥ä½œåç¨‹ã€‚&lt;/p>
&lt;p>è¿™é‡Œè§£é‡Šä¸€ä¸‹&lt;code>listen(fd, backlog)&lt;/code>å‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•°&lt;code>backlog&lt;/code>ï¼š&lt;/p>
&lt;p>backlogæ„ä¸ºå†…æ ¸ä¸ºç›¸åº”å¥—æ¥å­—æ’é˜Ÿçš„æœ€å¤§è¿æ¥ä¸ªæ•°ã€‚å†…æ ¸ä¸ºä»»ä½•ä¸€ä¸ªç»™å®šçš„ç›‘å¬å¥—æ¥å­—ç»´æŠ¤ä¸¤ä¸ªé˜Ÿåˆ—ï¼š&lt;/p>
&lt;ul>
&lt;li>æœªå®Œæˆè¿æ¥é˜Ÿåˆ—(incomplete connection queue) &lt;br>
å·²ç”±æŸä¸ªå®¢æˆ·å‘å‡ºå¹¶åˆ°è¾¾æœåŠ¡å™¨ï¼Œè€ŒæœåŠ¡å™¨æ­£åœ¨ç­‰å¾…å®Œæˆç›¸åº”çš„TCPä¸‰è·¯æ¡æ‰‹è¿‡ç¨‹ã€‚è¿™äº›å¥—æ¥å­—å¤„äºSYN_RCVDçŠ¶æ€&lt;/li>
&lt;li>å·²å®Œæˆè¿æ¥é˜Ÿåˆ—(completed connection queue) &lt;br>
æ¯ä¸ªå·²å®ŒæˆTCPä¸‰è·¯æ¡æ‰‹è¿‡ç¨‹çš„å®¢æˆ·å¯¹åº”å…¶ä¸­ä¸€é¡¹ã€‚è¿™äº›å¥—æ¥å­—å¤„äºESTABLISHEDçŠ¶æ€&lt;/li>
&lt;/ul>
&lt;p>å½“é˜Ÿåˆ—æ»¡æ—¶ï¼ŒTCPä¼šå¿½ç•¥æ”¹åˆ†èŠ‚ï¼Œä½†æ˜¯ä¸å‘é€RSTã€‚æœåŠ¡ç«¯ä¼šæœŸæœ›å®¢æˆ·ç«¯é‡å‘SYNï¼Œé‡‡ç”¨æ­£å¸¸çš„é‡ä¼ æœºåˆ¶æ¥å¤„ç†&lt;/p>
&lt;p>é˜Ÿåˆ—çš„çœŸå®å¤§å°å¾€å¾€æ¯”è®¾å®šbacklogå€¼è¦å¤§ä¸€äº›ï¼ˆ~1.5å€ï¼‰&lt;/p>
&lt;p>æˆ‘ä»¬ç»§ç»­çœ‹å·¥ä½œå‡½æ•°&lt;code>echoaccept&lt;/code>ã€‚ç¬¬ä¸€æ­¥æ˜¯æ–°å»ºä¸€ä¸ª&lt;code>UThreadSocket_t&lt;/code>å¯¹è±¡ï¼Œç”¨æ¥ç›‘å¬acceptäº‹ä»¶ã€‚å½“æœ‰æ–°çš„è¿æ¥è¿›å…¥æ—¶ï¼Œæˆ‘ä»¬å°±å°†æ–°çš„è¿æ¥ï¼Œä»¥åŠè¿æ¥æ‰€ç”¨çš„å·¥ä½œå‡½æ•°&lt;code>echoserver&lt;/code>åŠ å…¥åˆ°è°ƒåº¦å™¨ä¸­ã€‚&lt;/p>
&lt;p>&lt;code>echoserver&lt;/code>å‡½æ•°é¦–å…ˆå‘é€ä¸€ä¸ªæ¬¢è¿ä¿¡æ¯ï¼Œä¹‹åå°±å’Œå®¢æˆ·ç«¯æ‰“èµ·ä¹’ä¹“çƒæ¥ï¼Œç›´åˆ°å®¢æˆ·ç«¯å‘æ¥quitï¼Œå°±ç»“æŸè¿™ä¸ªå·¥ä½œåç¨‹ã€‚&lt;/p>
&lt;p>å…¶å®è¿™é‡Œæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœå‘ç”Ÿäº†ä¸€ä¸ªå­—ç¬¦ä¸²æ‹†æˆä¸¤åŠå‘çš„ç°è±¡ï¼Œæ¯”å¦‚ç¬¬ä¸€ä¸ªåŒ…æ˜¯â€œblahblahquitqâ€ï¼Œä¹‹åä¸€ä¸ªåŒ…æ˜¯â€œuitâ€ï¼Œé‚£ä¹ˆè¿™ä¸ªåç¨‹æ°¸è¿œå°±ä¸ä¼šåœæ­¢äº†ã€‚ç”±äºTCPæ˜¯ä¸€ä¸ªæµåè®®ï¼Œæˆ‘ä»¬ä¸èƒ½ä¿è¯æ¯ä¸€æ¬¡recvå›æ¥çš„ä¿¡æ¯éƒ½æ˜¯ä¸€ä¸ªå®Œæ•´çš„â€œåŒ…â€ã€‚ä¸åšä¸å¿…è¦çš„å‡è®¾ï¼Œä¸ç»™è‡ªå·±æ‰¾éº»çƒ¦ã€‚&lt;/p>
&lt;p>ä¸è¿‡å› ä¸ºè¿™é‡Œping pongçš„æ¶ˆæ¯éƒ½æ¯”è¾ƒçŸ­ï¼Œå¯ä»¥å¼ºè¡Œè®¤ä¸ºæ¯ä¸€ä¸ªåŒ…éƒ½åŒ…å«ç€ä¸€ä¸ªå®Œæ•´çš„å­—ç¬¦ä¸²ã€‚å½“ç„¶ï¼Œè¿™ç§å‡è®¾ä¹Ÿæ˜¯æ— æ„ä¹‰çš„ã€‚æ‰€ä»¥æˆ‘ä»¬è¦ç•™æ„phxrpcåœ¨çœŸæ­£çš„ç”Ÿäº§ç¯å¢ƒï¼Œæ˜¯æ€æ ·å¤„ç†è¿™ç§â€œç²˜åŒ…â€çš„é—®é¢˜çš„ã€‚&lt;/p>
&lt;h2 id="å†™åœ¨æœ€å">å†™åœ¨æœ€å &lt;a href="#%e5%86%99%e5%9c%a8%e6%9c%80%e5%90%8e" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>ä¸Šä¸€å¼ å¥³ç¥çš„å›¾ï¼š&lt;/p>
&lt;p>&lt;img src="https://github.com/Wizmann/assets/raw/master/wizmann-pic/16-10-19/89151689.jpg" alt="">&lt;/p>
&lt;p>æ²¡å•¦~&lt;/p></description></item><item><title>ä½¿ç”¨epollé©±åŠ¨ucontext - phxrpcä»£ç é˜…è¯»(5)</title><link>https://wizmann.top/posts/phxrpc-5/</link><pubDate>Mon, 17 Oct 2016 01:28:40 +0000</pubDate><guid>https://wizmann.top/posts/phxrpc-5/</guid><description>&lt;h2 id="ç”¨pipeå«é†’ä½ --epollnotifier">ç”¨pipeå«é†’ä½  â€” EpollNotifier &lt;a href="#%e7%94%a8pipe%e5%8f%ab%e9%86%92%e4%bd%a0--epollnotifier" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>&lt;code>class EpollNotifier&lt;/code>ç±»å‹å°è£…äº†ä¸€ä¸ªä½¿ç”¨pipeä¼ é€’ä¿¡å·çš„Notifierç±»ã€‚&lt;/p>
&lt;p>&lt;code>Run()&lt;/code>å‡½æ•°ï¼ˆå…¶å®æˆ‘è§‰å¾—å«Registeræˆ–Activateä¼šæ›´å¥½ï¼‰é¦–å…ˆå£°æ˜äº†ä¸¤ä¸ªå•å‘çš„pipeï¼š&lt;code>pipe_fds_&lt;/code>ï¼Œä»&lt;a href="http://man7.org/linux/man-pages/man2fpipe.2.html">æ–‡æ¡£&lt;/a>ä¸­æˆ‘ä»¬å¯ä»¥çŸ¥é“&lt;code>pipe_fds_[0]&lt;/code>æ˜¯è¯»ç®¡é“ï¼Œè€Œ&lt;code>pipe_fds_[1]&lt;/code>æ˜¯å†™ç®¡é“ã€‚è¿™é‡Œæœ‰ä¸€ä¸ç‚¹åç›´è§‰ï¼Œå°±æ˜¯pipeæ‹¿äº†ä¸¤ä¸ªfdï¼Œä½†æ˜¯ä»æ—§æ˜¯å•å·¥çš„ã€‚&lt;/p>
&lt;p>&lt;img src="https://github.com/Wizmann/assets/raw/master/wizmann-pic/16-10-16/2335602.jpg" alt="">&lt;/p>
&lt;p>ç„¶åå°†è¯»fdè®¾ä¸º&lt;code>O_NONBLOCK&lt;/code>ä»¥ä¾›epollè°ƒåº¦ï¼Œæœ€åå°†&lt;code>Func()&lt;/code>å‡½æ•°ä¼ å…¥&lt;code>scheduler_&lt;/code>ä¸­ã€‚&lt;/p>
&lt;blockquote>
&lt;p>è¿™é‡Œè·‘ä¸ªé¢˜ï¼Œæƒ³èµ·äº†å½“å¹´æˆ‘å¤§ä¸€çš„æ—¶å€™ä¸Šè¿‡çš„é€šä¿¡å¯¼è®ºçš„é€‰ä¿®è¯¾ã€‚é‚£ä¼šæˆ‘è¿˜æ²¡æœ‰æ²‰è¿·ä»£ç ï¼Œè¿˜æ˜¯ä¸€ä¸ªç§¯æä¹è§‚å¥½å¥½å­¦ä¹ çš„æ–°æ—¶ä»£å¤§å­¦ç”Ÿã€‚è‡ªä»å¼€å§‹å†™äº†ä»£ç ï¼Œäººå°±è¶Šæ¥è¶ŠåºŸç‰©äº†ï¼Œè¿å¥³æœ‹å‹éƒ½æ‰¾ä¸åˆ°äº†ã€‚ &lt;br>
å¹´è½»äººä»¬å•Šï¼Œæœ‰é¥­è¾™å¹²ç‚¹å•¥éƒ½è¡Œï¼Œåƒä¸‡åˆ«å†™ç å•Šã€‚&lt;/p>&lt;/blockquote>
&lt;p>&lt;code>Func()&lt;/code>å‡½æ•°åšçš„äº‹æƒ…å¾ˆç®€å•ï¼Œå°±æ˜¯ä»ç®¡é“é‡Œå°è¯•pollä¸€æ®µæ•°æ®ï¼Œæ‹¿åˆ°æ•°æ®åç›´æ¥æ‰”æ‰ã€‚å› ä¸ºç®¡é“é‡Œä¼ æ¥çš„æ•°æ®å¹¶æ²¡æœ‰å®é™…æ„ä¹‰ï¼Œè¿™æ ·è®¾è®¡çš„ä¸»è¦æ„ä¹‰åœ¨äºå”¤é†’epollã€‚&lt;/p>
&lt;p>æˆ‘ä»¬å¯ä»¥ä»&lt;code>Notify()&lt;/code>å‡½æ•°ä¸­çœ‹å‡ºï¼Œä¼ å…¥ç®¡é“çš„æ˜¯ä¸€ä¸ªå­—ç¬¦&amp;quot;a&amp;quot;ã€‚&lt;/p>
&lt;h2 id="è°ƒåº¦å™¨ç±»--uthreadepollscheduler">è°ƒåº¦å™¨ç±» â€” UThreadEpollScheduler &lt;a href="#%e8%b0%83%e5%ba%a6%e5%99%a8%e7%b1%bb--uthreadepollscheduler" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>è°ƒè¯•å™¨ç±»åœ¨åˆå§‹åŒ–æ—¶ï¼Œå£°æ˜äº†åç¨‹æ ˆçš„å¤§å°ä»¥åŠè°ƒè¯•å™¨æ‰€è°ƒåº¦çš„æœ€å¤§ä»»åŠ¡æ•°ã€‚ä¸è¿‡è¿™ä¸ªæœ€å¤§ä»»åŠ¡æ•°æ˜¯ä¸€ä¸ªâ€œè½¯çº¿â€ï¼Œå› ä¸ºåœ¨æœ€æ–°çš„Linuxå†…æ ¸ä¸­ï¼Œepollä½¿ç”¨åŠ¨æ€å†…å­˜ç®¡ç†fdï¼Œ&lt;code>epoll_create&lt;/code>ä¸­çš„&lt;code>size&lt;/code>å‚æ•°å·²ç»å¤±å»äº†ä½œç”¨ã€‚è€Œåé¢&lt;code>epoll_wait&lt;/code>ä¸­çš„&lt;code>max_event&lt;/code>å‚æ•°åªæ˜¯æ¯æ¬¡è¿”å›çš„æœ€å¤ševentæ•°ï¼Œä¹Ÿå°±æ˜¯å¦‚æœæˆ‘ä»¬å‘è°ƒåº¦å™¨ä¸­åŠ å…¥äº†è¶…è¿‡é™åˆ¶çš„fdï¼Œä¹Ÿä¸ä¼šæœ‰ä»€ä¹ˆæ¶åŠ£çš„åæœã€‚ï¼ˆå‚è€ƒ&lt;a href="http://man7.org/linux/man-pages/man2/epoll_create.2.html">epollæ–‡æ¡£&lt;/a>å’Œ&lt;a href="http://man7.org/linux/man-pages/man2/epoll_wait.2.html">epoll_waitæ–‡æ¡£&lt;/a>ï¼‰&lt;/p>
&lt;h3 id="è®©äººæä¸æ‡‚çš„instanceå‡½æ•°">è®©äººæä¸æ‡‚çš„Instanceå‡½æ•° &lt;a href="#%e8%ae%a9%e4%ba%ba%e6%90%9e%e4%b8%8d%e6%87%82%e7%9a%84instance%e5%87%bd%e6%95%b0" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;p>è¿™ä¸ªå‡½æ•°çœ‹èµ·æ¥åƒä¸€ä¸ªSingletonçš„å®ç°ï¼Œä½†æ˜¯æ˜æ˜&lt;code>UThreadEpollScheduler&lt;/code>ç±»çš„æ„é€ å‡½æ•°æ˜¯publicçš„ã€‚ä¹Ÿå°±æ˜¯è¿™ä¸ªå‡½æ•°åƒæ˜¯ä¸€ä¸ªå•ä¾‹ï¼Œä½†å®ƒåˆä¸æ˜¯ä¸€ä¸ªå•ä¾‹ã€‚&lt;/p>
&lt;p>åœ¨å…¶å®ƒçš„ä»£ç ä¸­ï¼Œä¹Ÿæ²¡æœ‰è°ƒç”¨ä¸ªå‡½æ•°çš„åœ°æ–¹ï¼Œæˆ‘è§‰å¾—è¿™ä¸ªå‡½æ•°æ˜¯å¼€å‘è€…å¿˜è®°åˆ äº†ã€‚&lt;/p>
&lt;p>&lt;img src="https://github.com/Wizmann/assets/raw/master/wizmann-pic/16-10-16/85921046.jpg" alt="">&lt;/p>
&lt;h3 id="è¿œå¤æ™ºæ…§--createsocket">è¿œå¤æ™ºæ…§ â€” CreateSocket &lt;a href="#%e8%bf%9c%e5%8f%a4%e6%99%ba%e6%85%a7--createsocket" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;p>è¿™ä¸ªå‡½æ•°å…¶å®æ²¡å•¥å¯è¯´çš„ï¼Œç®—æ˜¯å¯¹&lt;code>UThreadSocket_t&lt;/code>æ„é€ çš„å°è£…ï¼Œä½†æ˜¯è¿™é‡Œé¢æœ‰ä¸€ä¸ªå°æŠ€å·§ï¼Œå°±æ˜¯&lt;code>calloc&lt;/code>çš„ä½¿ç”¨ã€‚&lt;/p>
&lt;p>&lt;code>calloc&lt;/code>çš„ä½œç”¨æ˜¯å‘å†…æ ¸ç”³è¯·ä¸€æ®µæ ˆç©ºé—´ï¼ˆå’Œ&lt;code>malloc&lt;/code>è¡Œä¸ºä¸€è‡´ï¼‰ï¼Œç„¶åå°†è¿™ä¸€æ®µå†…å­˜æ¸…0ã€‚&lt;/p>
&lt;p>ä¸ªäººæ„Ÿè§‰è¿™æ ·åšçš„ç›®çš„æ˜¯é˜²æ­¢æŒ‡é’ˆæ²¡æœ‰åˆå§‹åŒ–å¸¦æ¥çš„ä¸€ç³»åˆ—è¯¡å¼‚çš„é—®é¢˜ã€‚æŠŠæŒ‡é’ˆæ¸…é›¶ï¼Œå¯ä»¥è®©é—®é¢˜åœ¨ç¬¬ä¸€æ—¶é—´å‡ºç°ï¼Œæ–¹ä¾¿å‡ºé”™æ—¶çš„è°ƒè¯•ã€‚ä½†æ˜¯æˆ‘è§‰å¾—è¿˜æ˜¯ç”¨æµ‹è¯•è¦†ç›–è¿™ç§é—®é¢˜å·²ç»å¥½ï¼Œå› ä¸ºç©ºæŒ‡é’ˆåœ¨ç‰¹å®šçš„æƒ…å†µä¸‹ï¼Œä»å¯èƒ½æ˜¯å¯¼è‡´è¯¡å¼‚è¡Œä¸ºçš„æºå¤´ã€‚&lt;/p>
&lt;h3 id="è·‘--run">è·‘ â€” Run &lt;a href="#%e8%b7%91--run" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;p>&lt;code>Run()&lt;/code>å‡½æ•°æ˜¯è°ƒåº¦å™¨çš„æ ¸å¿ƒå‡½æ•°ï¼ˆå½“ç„¶å•¦ï¼‰ï¼Œç®€å•æ¥è¯´å°±æ˜¯ä¸€ä¸ªå¾ªç¯è·å–eventï¼Œç”¨é€‚å½“çš„åç¨‹å¤„ç†eventã€‚&lt;/p>
&lt;p>å‡½æ•°çš„ä¸€å¼€å§‹ï¼Œå…ˆè°ƒç”¨&lt;code>ConsumeTodoList()&lt;/code>å‡½æ•°ï¼Œå°†åˆ—è¡¨ä¸­çš„åç¨‹å…¨éƒ¨æ¿€æ´»ï¼Œå¹¶hangåœ¨epollä¸Šã€‚&lt;/p>
&lt;p>ä¹‹åè¿›å…¥ä¸€ä¸ªâ€œæ­»å¾ªç¯â€ï¼Œé€šè¿‡&lt;code>epoll_wait&lt;/code>å°†æœ‰æ•°æ®å¯è¯»çš„fdå–å‡ºï¼Œå¹¶è°ƒç”¨ç›¸åº”çš„åç¨‹è¿›è¡Œå¤„ç†ã€‚è¿™é‡Œæˆ‘ä»¬çœ‹åˆ°ï¼Œ&lt;code>epoll_wait&lt;/code>çš„è¶…æ—¶æ—¶é—´æ˜¯å†™æ­»çš„4msï¼Œå¹¶æ²¡æœ‰ä½¿ç”¨&lt;code>next_timeout&lt;/code>ç»™å‡ºçš„ä¸‹æ¬¡è¶…æ—¶æ—¶é—´ã€‚è¿™æ˜¯å› ä¸ºè¿™é‡Œæ”¯æŒäº†â€œactive socketâ€ï¼Œå³æœåŠ¡å™¨å¯¹æ´»åŠ¨è¿æ¥æ“ä½œï¼Œä¾‹å¦‚å‘é€å“åº”ç”šè‡³æ–°å»ºä¸€ä¸ªsocketã€‚&lt;/p>
&lt;p>åé¢çš„&lt;code>handler_accepted_fd_func_&lt;/code>å’Œ&lt;code>active socket&lt;/code>æ˜¯ç±»ä¼¼çš„ï¼Œä¸è¿‡è¿™ä¸ªå‡½æ•°æ˜¯ç”¨æ¥å¤„ç†å·²ç»å»ºç«‹å¥½çš„è¿æ¥ï¼Œä¸ºå…¶åˆ†é…ç›¸åº”çš„åç¨‹ã€‚&lt;/p>
&lt;p>æ‰€ä»¥ï¼Œç”±æ­¤å¯è§ï¼Œè¿™ä¸ªå¾ªç¯å³æ˜¯äº‹ä»¶é©±åŠ¨çš„ï¼Œåˆæ˜¯è½®è¯¢çš„ã€‚ç„¶è€Œè¿™ä¸¤ç§æ¨¡å‹ï¼Œå±…ç„¶èƒ½å†™åœ¨ä¸€ä¸ªå‡½æ•°é‡Œï¼ŒçœŸæ˜¯ä»¤äººå°è±¡æ·±åˆ»ã€‚&lt;/p>
&lt;p>&lt;img src="https://github.com/Wizmann/assets/raw/master/wizmann-pic/16-10-16/4157866.jpg" alt="">&lt;/p>
&lt;p>ä¸‹é¢çš„&lt;code>DealwithTimeout&lt;/code>å‡½æ•°å¤„ç†äº†ä¸€ä¸‹è¶…æ—¶çš„åç¨‹ï¼Œå¹¶ä¸”æ›´æ–°äº†&lt;code>next_timeout&lt;/code>å˜é‡ã€‚ç„¶è€Œè¿™ä¸ªå˜é‡å› ä¸ºä¼—æ‰€å‘¨çŸ¥çš„åŸå› ï¼Œå¹¶æ²¡æœ‰ä»€ä¹ˆåµç”¨ã€‚&lt;/p>
&lt;p>&lt;img src="https://github.com/Wizmann/assets/raw/master/wizmann-pic/16-10-16/4157866.jpg" alt="">&lt;/p>
&lt;h2 id="pollæ¥pollå»--ä¸€å †epollå‡½æ•°çš„å°è£…">Pollæ¥Pollå» â€” ä¸€å †epollå‡½æ•°çš„å°è£… &lt;a href="#poll%e6%9d%a5poll%e5%8e%bb--%e4%b8%80%e5%a0%86epoll%e5%87%bd%e6%95%b0%e7%9a%84%e5%b0%81%e8%a3%85" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;h3 id="uthreadpoll1">UThreadPoll(1) &lt;a href="#uthreadpoll1" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;p>&lt;code>UThreadPoll&lt;/code>å‡½æ•°æœ‰ä¸¤ä¸ªç‰ˆæœ¬ï¼Œä¸€ä¸ªæ˜¯pollå•ä¸ªsocketï¼Œå¦å¤–ä¸€ä¸ªæ˜¯pollä¸€å †socketã€‚æˆ‘ä»¬å…ˆä»å•ä¸ªsocketçš„çœ‹èµ·ã€‚&lt;/p>
&lt;p>ç¬¬ä¸€æ­¥æ˜¯æ³¨å†Œä¸€ä¸ªè¶…æ—¶æ—¶é—´ï¼Œç¬¬äºŒæ­¥å°†è¿™ä¸ªsocketæ”¾åˆ°epollçš„ç›‘å¬åˆ—è¡¨ä¸Šã€‚ä¹‹åè°ƒç”¨yieldï¼ŒæŠŠæ§åˆ¶æƒäº¤è¿˜ç»™ä¸»æ§åˆ¶æµã€‚&lt;/p>
&lt;p>å½“epollæ”¶åˆ°ç›¸åº”çš„äº‹ä»¶æ—¶ï¼Œä¸»æ§åˆ¶æµä¼šå°†æ§åˆ¶æƒäº¤è¿˜ç»™åç¨‹ï¼Œåç¨‹å°†socketä»epollç›‘å¬åˆ—è¡¨ä¸­ç§»é™¤ï¼Œä¹‹åè¿›è¡Œåé¢çš„æ“ä½œã€‚&lt;/p>
&lt;p>æ•´ä½“çš„å·¥ä½œæµå¯ä»¥å‚è€ƒä¸‹å›¾ã€‚&lt;/p>
&lt;p>&lt;img src="http://7lrx26.com1.z0.glb.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202016-10-16%2021.33.48.png" alt="image">&lt;/p>
&lt;h3 id="uthreadpoll2---è¾¹ç¼˜è§¦å‘å’Œæ°´å¹³è§¦å‘">UThreadPoll(2) - è¾¹ç¼˜è§¦å‘å’Œæ°´å¹³è§¦å‘ &lt;a href="#uthreadpoll2---%e8%be%b9%e7%bc%98%e8%a7%a6%e5%8f%91%e5%92%8c%e6%b0%b4%e5%b9%b3%e8%a7%a6%e5%8f%91" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;p>epollæœ‰ä¸¤ç§è§¦å‘æ¨¡å¼ï¼Œè¾¹ç¼˜è§¦å‘(edge-trigger, ET)å’Œæ°´å¹³è§¦å‘(level-trigger, LT)ã€‚&lt;/p>
&lt;p>ç®€å•è§£é‡Šä¸€ä¸‹epollçš„è¿™ä¸¤ç§è§¦å‘æ¨¡å¼ã€‚ETæ„å‘³ç€åªè¦æœ‰fdå¯è¯»æˆ–å¯å†™ï¼Œ&lt;code>epoll_wait&lt;/code>å°±è¿”å›è¿™ä¸ªfdï¼Œè€ŒLTæ„å‘³ç€å½“ä¸”ä»…å½“fdç”±â€œä¸å¯è¯»å˜ä¸ºå¯è¯»â€æˆ–ç”±â€œä¸å¯å†™å˜ä¸ºå¯å†™â€æ—¶ï¼Œ&lt;code>epoll_wait&lt;/code>æ‰ä¼šè¿”å›ã€‚ï¼ˆè¿™æœ‰å¯èƒ½å‡ºç°æ‰€è°“çš„â€œç²˜åŒ…â€ç°è±¡ï¼Œè¯¦è§&lt;a href="http://man7.org/linux/man-pages/man7/epoll.7.html">è¿™é‡Œ&lt;/a>ï¼‰&lt;/p>
&lt;blockquote>
&lt;p>ç¬¬ä¸€æ¬¡å¬åˆ°â€œç²˜åŒ…â€è¿™ä¸ªè¯ï¼Œæˆ‘ä¸€ç›´ä»¥ä¸ºè¿™æ˜¯å•¥å¥½åƒçš„ã€‚ã€‚ã€‚&lt;/p>&lt;/blockquote>
&lt;p>è¿™æ„å‘³ç€ï¼Œå½“æˆ‘ä»¬ä½¿ç”¨LTæ—¶ï¼Œæˆ‘ä»¬å¿…é¡»æ¸…ç†å¹²å‡€fdä¸­çš„æ•°æ®ï¼Œå³åªè¦å¯è¯»ï¼Œå°±ä¸€ç›´è¯»ï¼›åªè¦å¯å†™ï¼Œå°±ä¸€ç›´å†™ã€‚å¦åˆ™å°±ä¼šå‡ºç°é—®é¢˜ã€‚&lt;/p>
&lt;p>åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯æ¯”è¾ƒå¸¸ç”¨çš„ETæ¨¡å¼ã€‚å¹¶ä¸”æˆ‘ä»¬åˆ©ç”¨äº†ETçš„ç‰¹æ€§å®ç°äº†â€œç›‘å¬å¤šä¸ªfdï¼Œè¿”å›æœ€æ—©å“åº”çš„é‚£ä¸€ä¸ªâ€ã€‚&lt;/p>
&lt;p>é¦–å…ˆï¼Œæˆ‘ä»¬æ–°å»ºäº†ä¸€ä¸ªepoll fdï¼ˆç®€ç§°å†…éƒ¨epollï¼‰ï¼Œå°†åˆ—è¡¨ä¸­çš„æ‰€æœ‰socketæ”¾åˆ°é‡Œé¢ç›‘å¬ã€‚ä¹‹åå°†è¿™ä¸ªsocket fdæ”¾åˆ°&lt;code>list[0]-&amp;gt;epollfd&lt;/code>æ‰€å¯¹åº”çš„epollï¼ˆç®€ç§°å¤–éƒ¨epollï¼Œé€šå¸¸æ˜¯ä¸»å·¥ä½œå¾ªç¯çš„é‚£ä¸ªepollï¼‰ç›‘å¬åˆ—è¡¨ä¸­ã€‚&lt;/p>
&lt;p>å½“åˆ—è¡¨ä¸­çš„socketæœ‰è¿”å›æ—¶ï¼Œå†…éƒ¨çš„epollä¼šè¿”å›ä¸€ä¸ª&lt;code>EPOLLIN&lt;/code>äº‹ä»¶ï¼Œå¤–éƒ¨çš„epollæ¥æ”¶åˆ°è¿™ä¸ªäº‹ä»¶åï¼Œè¿›è¡Œåç¨‹åˆ‡æ¢ï¼Œå›åˆ°å½“å‰å‡½æ•°ä¸­ã€‚&lt;/p>
&lt;p>ä¸‹ä¸€æ­¥æˆ‘ä»¬&lt;code>epoll_wait&lt;/code>å†…éƒ¨çš„epoll fdï¼Œå› ä¸ºæˆ‘ä»¬ç¡®å®šæ­¤æ—¶ä¸€å®šæœ‰å¯æ“ä½œçš„fdï¼Œæ‰€ä»¥æˆ‘ä»¬å°†&lt;code>epoll_wait&lt;/code>çš„timeoutå‚æ•°è®¾ä¸º0ã€‚ä¹‹åæˆ‘ä»¬å°†è¿”å›çš„fdçš„&lt;code>waited_events&lt;/code>å‚æ•°å¡«å¥½ï¼Œæœ€åè¿”å›æ“ä½œæˆåŠŸçš„fdçš„æ•°ç›®ã€‚&lt;/p>
&lt;p>è¿™ä¸ªå‡½æ•°æ¯”è¾ƒç»•ï¼Œä¸è¿‡æœ‰ä¸€ä¸ªå¥½æ¶ˆæ¯ â€”â€” è¿™ä¸ªå‡½æ•°ä¹Ÿæ²¡æœ‰è¢«å…¶å®ƒåœ°æ–¹è°ƒç”¨è¿‡ã€‚ä¸è¿‡è¿™ç§&lt;code>cascaded epoll&lt;/code>çš„æŠ€å·§ç¡®å®æ˜¯è®©äººè€³ç›®ä¸€æ–°ã€‚&lt;/p>
&lt;p>&lt;img src="https://github.com/Wizmann/assets/raw/master/wizmann-pic/16-10-16/4157866.jpg" alt="">&lt;/p>
&lt;h3 id="å»¶æ—¶æ‰§è¡Œ---uthreadwait">å»¶æ—¶æ‰§è¡Œ - UThreadWait &lt;a href="#%e5%bb%b6%e6%97%b6%e6%89%a7%e8%a1%8c---uthreadwait" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;p>å‰©ä¸‹çš„å‡ ä¸ªå‡½æ•°åŸºæœ¬éƒ½æ˜¯æ— è„‘å°è£…ï¼Œé¡ºç€çœ‹ä¸€éä»£ç åŸºæœ¬å°±çŸ¥é“æ˜¯å•¥æ„æ€äº†ã€‚ä¸è¿‡&lt;code>UThreadWait&lt;/code>è¿™ä¸ªå‡½æ•°æ¯”è¾ƒæœ‰æ„æ€ï¼Œå¯ä»¥ç”¨æ¥å¤ä¹ ä¸€ä¸‹&lt;code>uthread + epoll&lt;/code>çš„å·¥ä½œæµç¨‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">UThreadWait&lt;/span>(UThreadSocket_t &lt;span style="color:#f92672">&amp;amp;&lt;/span> socket, &lt;span style="color:#66d9ef">int&lt;/span> timeout_ms) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> socket.uthread_id &lt;span style="color:#f92672">=&lt;/span> socket.scheduler&lt;span style="color:#f92672">-&amp;gt;&lt;/span>GetCurrUThread();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> socket.scheduler&lt;span style="color:#f92672">-&amp;gt;&lt;/span>AddTimer(&lt;span style="color:#f92672">&amp;amp;&lt;/span>socket, timeout_ms);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> socket.scheduler&lt;span style="color:#f92672">-&amp;gt;&lt;/span>YieldTask();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> socket.scheduler&lt;span style="color:#f92672">-&amp;gt;&lt;/span>RemoveTimer(socket.timer_id);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>é¦–å…ˆï¼Œè·å–å½“å‰uthreadçš„IDï¼Œå½“æˆ‘ä»¬è°ƒç”¨&lt;code>Resume()&lt;/code>å‡½æ•°æ—¶ï¼Œè®©ä»£ç çŸ¥é“æˆ‘ä»¬è¦è¿”å›åˆ°å“ªä¸ªåç¨‹ä¸Šé¢ã€‚&lt;/p>
&lt;p>ç„¶åæˆ‘ä»¬å‘è°ƒåº¦å™¨ä¸­æ·»åŠ ä¸€ä¸ªå®šæ—¶å™¨ã€‚ä¹‹å&lt;code>Yield()&lt;/code>ï¼Œç¦»å¼€å½“å‰åç¨‹ã€‚&lt;/p>
&lt;p>ä¸»å·¥ä½œå¾ªç¯è¿è¡Œåˆ°è¶…æ—¶æ—¶é—´åï¼Œä¼šåœ¨è¿™ä¸ªåç¨‹æ‰“ä¸Šä¸€ä¸ªâ€œè¶…æ—¶â€æ ‡ç­¾ï¼Œç„¶å&lt;code>Resume()&lt;/code>åˆ‡æ¢å›è¿™ä¸ªåç¨‹ä¸Šæ¥ã€‚&lt;/p>
&lt;p>å‰©ä¸‹çš„å·¥ä½œï¼Œå°±äº¤ç”±åç¨‹å†…éƒ¨ç»‘å®šçš„å‡½æ•°æ¥è¿›è¡Œå¤„ç†ã€‚&lt;/p>
&lt;h2 id="å†™åœ¨æœ€å">å†™åœ¨æœ€å &lt;a href="#%e5%86%99%e5%9c%a8%e6%9c%80%e5%90%8e" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>åœ¨ç½‘ç»œç¼–ç¨‹æ–¹é¢ï¼ŒçœŸå¿ƒæ˜¯ä¸€ä¸ªåˆå­¦è€…ã€‚å¾ˆå¤šç”¨è¯å¯èƒ½ä¸æ°å½“ï¼Œä¹Ÿæœ‰ä¸€äº›æ˜¯è‡ªå·±ç”Ÿé€ çš„ã€‚å¤§å®¶é˜…è¯»çš„æ—¶å€™ï¼Œå°½é‡ä»¥ä»£ç å’Œæ›´ä¸“ä¸šçš„æœ¯è¯­ä¸ºå‡†ã€‚&lt;/p>
&lt;p>ç„¶åå› ä¸ºåœ¨è¡Œæ–‡ä¸­ï¼Œå¯èƒ½è¿½æ±‚äº†è¿‡å¤šçš„é€—æ¯”æ„Ÿï¼Œå¯¹åŸä»£ç è°ƒä¾ƒäº†å‡ å¥ã€‚å¹¶æ²¡æœ‰ä»€ä¹ˆæ¶æ„ï¼Œå¦‚æœå“ªé‡Œè¯´çš„ä¸å¯¹ï¼Œæ¬¢è¿æ‹ç –ã€‚&lt;/p>
&lt;p>&lt;img src="http://7lrx26.com1.z0.glb.clouddn.com/IMG_20161017_012107.jpg" alt="image">&lt;/p>
&lt;p>ä½›ç¥–ä¿ä½‘ï¼Œæ°¸æ— Bugã€‚&lt;/p></description></item><item><title>ucontext - phxrpcä»£ç é˜…è¯»(4)</title><link>https://wizmann.top/posts/phxrpc-4/</link><pubDate>Thu, 13 Oct 2016 23:45:24 +0000</pubDate><guid>https://wizmann.top/posts/phxrpc-4/</guid><description>&lt;h2 id="å†™åœ¨å‰é¢">å†™åœ¨å‰é¢ &lt;a href="#%e5%86%99%e5%9c%a8%e5%89%8d%e9%9d%a2" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>å›½åº†å‡æœŸè¿‡åŠï¼Œphxrpcçš„ä»£ç é˜…è¯»å¤§æ¦‚è¦å°å°å‘Šä¸€æ®µè½å•¦ã€‚å› ä¸ºè¿™ä¸¤å¤©è¿˜è¦è¯»å·¥ä½œç›¸å…³çš„ä»£ç ï¼Œä»¥åŠæœ€åå‡ å¤©è¿˜æœ‰ä¸€æ¬¡çŸ­é€”æ—…è¡Œã€‚&lt;/p>
&lt;p>æ‰€ä»¥éé˜»å¡TCPæµå¯èƒ½è¦ç•™åˆ°ä¸‹ä¸€ç¯‡äº†ï¼Œè¿™ä¸€ç¯‡åªæ¶‰åŠéé˜»å¡TCPæµä½¿ç”¨åˆ°çš„ucontextåç¨‹åº“ï¼ŒåŠå…¶ä½¿ç”¨çš„ä¸€äº›æ¡†æ¶ä»£ç ã€‚&lt;/p>
&lt;blockquote>
&lt;p>161013æ›´æ–°ï¼šè¿™ç‚¹ç ´ä¸œè¥¿å†™åˆ°ä»Šå¤©æ‰å†™å®Œï¼ŒGGã€‚&lt;/p>&lt;/blockquote>
&lt;h2 id="ä»€ä¹ˆæ˜¯ucontext">ä»€ä¹ˆæ˜¯ucontext &lt;a href="#%e4%bb%80%e4%b9%88%e6%98%afucontext" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;blockquote>
&lt;p>&amp;ldquo;Subroutines are special cases of &amp;hellip; coroutines.&amp;rdquo; â€“Donald Knuth.&lt;/p>&lt;/blockquote>
&lt;p>é¦–å…ˆæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ï¼Œä»€ä¹ˆæ˜¯çº¿ç¨‹ã€‚çº¿ç¨‹æ˜¯è¿›ç¨‹å†…ä¸€æ¡æ‰§è¡Œæµçš„çŠ¶æ€ï¼ŒåŒ…å«äº†ç¡¬ä»¶çŠ¶æ€ï¼ˆç¡¬ä»¶è®¡æ•°å™¨ï¼Œå¯„å­˜å™¨ï¼Œæ¡ä»¶ç ç­‰ï¼‰å’Œå †æ ˆä¸­çš„æ•°æ®ã€‚&lt;/p>
&lt;p>çº¿ç¨‹é€šå¸¸åªæœ‰ä¸€ä¸ªå…¥å£å’Œä¸€ä¸ªå‡ºå£ã€‚å½“çº¿ç¨‹è¿”å›æ—¶ï¼Œçº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸä¹Ÿç»“æŸäº†ã€‚æ‰€ä»¥ï¼Œé€šå¸¸çº¿ç¨‹çš„æ‰§è¡Œç”±å†…æ ¸è°ƒåº¦ã€‚&lt;/p>
&lt;p>åç¨‹çš„å®šä¹‰ä¸çº¿ç¨‹ç±»ä¼¼ï¼Œä¹Ÿæ˜¯ç¡¬ä»¶çŠ¶æ€+å †æ ˆçš„çŠ¶æ€ç»„åˆã€‚ä½†æ˜¯ä¸çº¿ç¨‹ä¸åŒçš„æ˜¯ï¼Œåç¨‹å¯ä»¥æœ‰å¤šä¸ªå‡ºå£ã€‚å¯ä»¥é€šè¿‡yieldæ¥æš‚åœè‡ªå·±ï¼Œè°ƒç”¨å…¶å®ƒåç¨‹ã€‚å†æ¬¡å¯åŠ¨æ—¶ï¼Œä¼šä»ä¸Šæ¬¡æŒ‚èµ·çš„åœ°æ–¹ç»§ç»­è¿è¡Œã€‚&lt;/p>
&lt;h2 id="phxrpcä¸­çš„ucontext">phxrpcä¸­çš„ucontext &lt;a href="#phxrpc%e4%b8%ad%e7%9a%84ucontext" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>phxrpcæä¾›äº†systemå’Œboostä¸¤ç§ucontextçš„å®ç°ï¼Œæ‰€ä»¥æä¾›äº†ä¸€ä¸ª&lt;code>uthread_context_base&lt;/code>çš„åŸºç±»ã€‚å…¶å®åœ¨è¿™é‡Œæˆ‘æ˜¯æœ‰ä¸€ç‚¹æ€€ç–‘è™šå‡½æ•°çš„æ€§èƒ½çš„ï¼Œä¸è¿‡å¥½åœ¨åç¨‹çš„åˆ‡æ¢ä»¥åŠç½‘ç»œIOæ“ä½œè¿˜æ˜¯æ¯”è¾ƒè€—æ€§èƒ½çš„ï¼Œæ‰€ä»¥è™šå‡½æ•°å¤šå‡ºæ¥çš„å‡ æ¬¡å†…å­˜å¯»å€ä¹Ÿå¹¶éä¸èƒ½æ¥å—ã€‚&lt;/p>
&lt;p>åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬åªçœ‹&lt;code>uthread_context_system&lt;/code>è¿™ä¸ªä½¿ç”¨ç³»ç»Ÿucontextåº“çš„å®ç°ã€‚&lt;/p>
&lt;h3 id="åç¨‹ä¸Šä¸‹æ–‡uthreadcontext">åç¨‹ä¸Šä¸‹æ–‡ï¼š&lt;code>UThreadContext&lt;/code> &lt;a href="#%e5%8d%8f%e7%a8%8b%e4%b8%8a%e4%b8%8b%e6%96%87uthreadcontext" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;p>è¿™ä¸ªç±»æ˜¯åç¨‹ä¸Šä¸‹æ–‡çš„è™šåŸºç±»ï¼Œæ‰€ä»¥ä»£ç å¾ˆå°‘ã€‚å¹¶ä¸”ä¹Ÿæ²¡æœ‰ä»€ä¹ˆå¥½è§£é‡Šçš„ã€‚&lt;/p>
&lt;p>&lt;code>void Make(UThreadFunc_t func, void * args)&lt;/code>å‡½æ•°æ˜¯&lt;code>makecontext()&lt;/code>çš„å°è£…ã€‚&lt;/p>
&lt;p>&lt;code>bool Resume()&lt;/code>å’Œ&lt;code>bool Yield()&lt;/code>æ˜¯&lt;code>swapcontext&lt;/code>çš„å°è£…ã€‚&lt;/p>
&lt;p>ä¸ªäººæ„Ÿè§‰è¿™ä¸ªç±»æ‹†åˆ†æˆä¸€ä¸ªå·¥å‚ç±»ï¼ˆä¼ å…¥ä¸€ä¸ªCreateä»¿å‡½æ•°ï¼‰å’Œä¸€ä¸ªä¸Šä¸‹æ–‡åŸºç±»ä¼šæ›´æ¸…æ¥šä¸€ç‚¹ã€‚&lt;/p>
&lt;h3 id="ä½¿ç”¨ç³»ç»Ÿucontextåº“çš„åç¨‹ä¸Šä¸‹æ–‡uthreadcontextsystem">ä½¿ç”¨ç³»ç»Ÿucontextåº“çš„åç¨‹ä¸Šä¸‹æ–‡ï¼š&lt;code>UThreadContextSystem&lt;/code> &lt;a href="#%e4%bd%bf%e7%94%a8%e7%b3%bb%e7%bb%9fucontext%e5%ba%93%e7%9a%84%e5%8d%8f%e7%a8%8b%e4%b8%8a%e4%b8%8b%e6%96%87uthreadcontextsystem" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;p>åœ¨phxrpcçš„æ–‡æ¡£ä¸­ï¼Œè¯´æ˜ä½¿ç”¨ç³»ç»ŸåŸç”Ÿçš„ucontextåº“çš„æ€§èƒ½è¦å·®äºboostç‰ˆæœ¬çš„ã€‚ä½†æ˜¯ä»æ•°æ®ä¸Šæ¥çœ‹å¾®ä¹å…¶å¾®ï¼Œæ‰€ä»¥æˆ‘ä»¬å…ˆä»è¿™ä¸ªç‰ˆæœ¬çœ‹èµ·ï¼ŒåŠ›æ±‚ä¸¾ä¸€åä¸‰ã€‚&lt;/p>
&lt;p>&lt;code>UThreadContextSystem&lt;/code>åœ¨æ„é€ å‡½æ•°ä¸­ä¼ å…¥äº†åç¨‹æ ˆå¤§å°ï¼Œåç¨‹è¦æ‰§è¡Œçš„å‡½æ•°ï¼ˆåŠå‚æ•°ï¼‰ï¼Œåç¨‹æ‰§è¡Œåçš„å›è°ƒï¼Œä»¥åŠè°ƒè¯•ç”¨çš„&lt;code>need_stack_protect&lt;/code> flagã€‚&lt;/p>
&lt;p>æ¯ä¸€ä¸ªä¸Šä¸‹æ–‡å¯¹è±¡éƒ½ç»´æŠ¤äº†ä¸¤ä¸ªcontextï¼Œ&lt;code>main_context&lt;/code>ç”¨æ¥è¡¨ç¤ºä¸»ç¨‹åºæ‰§è¡Œæµçš„ä¸Šä¸‹æ–‡ï¼Œè€Œ&lt;code>context_&lt;/code>åˆ™ç”¨æ¥è¡¨ç¤ºåç¨‹çš„ä¸Šä¸‹æ–‡ã€‚&lt;/p>
&lt;p>&lt;code>main_context&lt;/code>æ˜¯&lt;code>static thread_local&lt;/code>ä¿®é¥°çš„ï¼Œä¹Ÿå°±æ„å‘³ç€è¿™ä¸ªé™æ€å˜é‡åœ¨æ¯ä¸€ä¸ªçº¿ç¨‹ä¸­æœ‰ä¸”åªæœ‰ä¸€ä¸ªã€‚æ‰§è¡Œåœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¸Šçš„ä¸åŒåç¨‹ï¼Œéƒ½ä¼šåˆ‡æ¢/è¢«åˆ‡æ¢åˆ°è¿™ä¸ªä¸Šä¸‹æ–‡ä¸Šã€‚&lt;/p>
&lt;p>åœ¨&lt;code>Resume()&lt;/code>å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬æ¿€æ´»åç¨‹ä¸Šä¸‹æ–‡ï¼Œå¹¶å°†ä¸»ç¨‹åºæ‰§è¡Œæµçš„ä¸Šä¸‹æ–‡ä¿å­˜åœ¨&lt;code>main_context&lt;/code>ä¸Šã€‚&lt;/p>
&lt;p>åœ¨&lt;code>Yield()&lt;/code>å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬å°†ä¸»ç¨‹åºæ‰§è¡Œæµçš„ä¸Šä¸‹æ–‡æ¿€æ´»ï¼Œå°†åç¨‹ä¸Šä¸‹æ–‡ä¿å­˜å›&lt;code>context_&lt;/code>ä¸­ã€‚&lt;/p>
&lt;p>è¿™é‡Œçš„&lt;code>UThreadFuncWrapper()&lt;/code>å€¼å¾—æˆ‘ä»¬ç‰¹åˆ«å…³æ³¨ã€‚è¿™ä¸ªå‡½æ•°åŒ…è£…äº†æˆ‘ä»¬çš„å·¥ä½œå‡½æ•°&lt;code>uc-&amp;gt;func_&lt;/code>ï¼Œå¹¶ä¸”å°†&lt;code>this&lt;/code>æŒ‡é’ˆä¼ è¿›å»ã€‚&lt;/p>
&lt;p>ä¼ å…¥æŒ‡é’ˆæ—¶ï¼Œè¿™é‡Œä½¿ç”¨äº†ä¸€ä¸ªæŠ€å·§ã€‚é¦–å…ˆæˆ‘ä»¬å°†æŒ‡é’ˆå¼ºè½¬ä¸º&lt;code>uintptr_t&lt;/code>ï¼Œè¿™ä¸ªæ˜¯ç¼–è¯‘å™¨å†…ç½®çš„ä¸€ä¸ª&lt;code>typeof&lt;/code>ï¼Œæ„åœ¨å°†æŒ‡é’ˆç±»å‹æ— æŸå¤±çš„è½¬ä¸ºæ•´å‹ã€‚ä¹‹åï¼Œå°†ä¸€ä¸ª&lt;code>uintptr_t&lt;/code>æ‹†ä¸ºä¸¤ä¸ª&lt;code>uint32_t&lt;/code>ã€‚æœ€åï¼Œåœ¨wrapperå‡½æ•°ä¸­ï¼Œå°†è¿™ä¸¤ä¸ª&lt;code>uint32_t&lt;/code>æ‹¼å›æˆä¸€ä¸ªæŒ‡é’ˆç±»å‹ã€‚&lt;/p>
&lt;p>åˆçœ‹è¿™æ®µä»£ç ï¼Œæˆ‘ä»¬å°±æœ‰è¿™æ ·çš„ç–‘é—®ï¼šâ€œè¿™ç‰¹ä¹ˆä¸æ˜¯æœ‰ç—…ä¹ˆï¼Ÿâ€ ä½†æ˜¯ï¼ŒæŠ˜è…¾è‡ªç„¶æœ‰æŠ˜è…¾çš„é“ç†ã€‚&lt;/p>
&lt;blockquote>
&lt;p>When this context is later activated (using setcontext(3) or swapcontext()) the function func is called, and passed the series of integer (int) arguments that follow argc; the caller must specify the number of these arguments in argc.&lt;/p>&lt;/blockquote>
&lt;p>ä»å®˜æ–¹çš„æ–‡æ¡£ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œç”¨åœ¨&lt;code>setcontext&lt;/code>ä¸­çš„å‡½æ•°ï¼Œåªæ”¯æŒintç±»å‹çš„å‚æ•°ï¼Œå¹¶ä¸”éœ€è¦æˆ‘ä»¬æ˜¾å¼å£°æ˜å‚æ•°çš„æ•°ç›®ã€‚è¿™é‡Œä¸€å®šè¦å°å¿ƒï¼Œå› ä¸ºå˜é•¿å‚æ•°åˆ—è¡¨å¹¶ä¸èƒ½æœ‰å¾ˆå¼ºçš„ç¼–è¯‘æœŸæ£€æŸ¥æ”¯æŒï¼Œæå‡ºUBæˆ–core dumpæ¥å°±éå¸¸éš¾æŸ¥ã€‚&lt;/p>
&lt;h3 id="ucontextä¸­ä½¿ç”¨çš„æ ˆå†…å­˜uthreadstackmemory">ucontextä¸­ä½¿ç”¨çš„æ ˆå†…å­˜ï¼š&lt;code>UThreadStackMemory&lt;/code> &lt;a href="#ucontext%e4%b8%ad%e4%bd%bf%e7%94%a8%e7%9a%84%e6%a0%88%e5%86%85%e5%ad%98uthreadstackmemory" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;p>ucontextåç¨‹æ˜¯åœ¨åŒä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œå¤šä¸ªä¸Šä¸‹æ–‡ï¼Œæ‰€ä»¥å°±è¦é…å¤‡å¤šä¸ªæ ˆç©ºé—´ã€‚è¿™é‡Œçš„æ ˆå¤§å°æˆ‘ä»¬æ˜¯å¯ä»¥æ‰‹åŠ¨ç®¡ç†çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ ¹æ®ç¨‹åºçš„å®é™…æƒ…å†µæ¥è°ƒæ•´æ ˆå¤§å°ï¼Œä»¥èŠ‚çœå†…å­˜ä½¿ç”¨ã€‚&lt;/p>
&lt;p>å†…å­˜çš„ç”³è¯·å¹¶ä¸æ˜¯ä½¿ç”¨&lt;code>malloc&lt;/code>æˆ–è€…&lt;code>new&lt;/code>è¿™ç§æ¯”è¾ƒé«˜å±‚æ¬¡çš„å†…å­˜æ“ä½œå‡½æ•°ï¼Œè€Œæ˜¯ä½¿ç”¨çš„&lt;code>mmap&lt;/code>ã€‚è¿™æ ·çš„å¥½å¤„æ˜¯æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å‚æ•°æ§åˆ¶ç”³è¯·å‡ºçš„å†…å­˜çš„æƒé™ã€‚&lt;/p>
&lt;p>æ ˆå†…å­˜æœ‰ä¸¤ç§æ¨¡å¼ï¼Œä¿æŠ¤å’Œéä¿æŠ¤ã€‚ä¿æŠ¤æ¨¡å¼ç”¨äºè°ƒè¯•ï¼Œä¼šåœ¨æ­£å¸¸æ ˆå†…å­˜çš„ä¸¤ç«¯ï¼Œå„ç”³è¯·ä¸€ä¸ªé¡µå¤§å°çš„ä¿æŠ¤å†…å­˜ã€‚æ­£å¸¸æ ˆå†…å­˜çš„æƒé™æ˜¯è¯»å†™ï¼š&lt;code>PROT_READ | PROT_WRITE&lt;/code>ï¼Œè€Œä¿æŠ¤å†…å­˜çš„æƒé™æ˜¯ç¦æ­¢è®¿é—®ï¼š&lt;code>PROT_NONE&lt;/code>ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä»»ä½•è¯•å›¾è®¿é—®è¿™å—å†…å­˜çš„è¯·æ±‚ï¼Œéƒ½ä¼šè§¦å‘æ®µé”™è¯¯ã€‚&lt;/p>
&lt;p>åœ¨éä¿æŠ¤çš„è¿è¡Œæ¨¡å¼ä¸‹ï¼Œæ ˆå†…å­˜è¿˜ä¼šä½¿ç”¨&lt;code>MAP_ANONYMOUS | MAP_PRIVATE&lt;/code>è¿˜è¿›è¡Œä¿æŠ¤ã€‚&lt;code>MAP_ANONYMOUS&lt;/code>è¡¨æ˜è¿™æ®µå†…å­˜æ˜¯åŒ¿åçš„ï¼Œå³ä¸å ç”¨fdï¼Œä¹Ÿæ— éœ€è¿›è¡Œå†™å›æ“ä½œï¼Œä½¿mmapçš„è¡Œä¸ºç±»ä¼¼äºmallocã€‚&lt;code>MAP_PRIVATE&lt;/code>æ„ä¸ºè¿™æ®µå†…å­˜ä¸ä¼šè¢«å…¶å®ƒè¿›ç¨‹è®¿é—®ï¼Œå¯ä»¥ä½¿ç”¨ç§æœ‰çš„å†™æ—¶å¤åˆ¶æ˜ å°„ã€‚ï¼ˆè™½ç„¶æ²¡æ‰¾åˆ°ç›¸å…³èµ„æ–™ï¼Œä½†æ˜¯æ„Ÿè§‰è¿™ä¸¤ä¸ªé…ç½®ç‰ºç‰²äº†å¯è°ƒè¯•æ€§æ¥è·å–æ›´å¥½çš„æ€§èƒ½ï¼‰&lt;/p>
&lt;h3 id="ucontextçš„è¿è¡Œæ—¶uthreadruntime">ucontextçš„è¿è¡Œæ—¶ï¼š&lt;code>UThreadRuntime&lt;/code> &lt;a href="#ucontext%e7%9a%84%e8%bf%90%e8%a1%8c%e6%97%b6uthreadruntime" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;p>è¿™ä¸ªç±»å…¶å®å¾ˆç®€å•ï¼Œä½†æ˜¯ç”±äºä»£ç çš„å‘½åè¿‡äºæ„è¯†æµï¼Œæ‰€ä»¥å¾ˆå®¹æ˜“æŠŠäººç»•æ™•ã€‚&lt;/p>
&lt;p>ä¸€ä¸ª&lt;code>UThreadRuntime&lt;/code>ä»£è¡¨ç€ä¸€ä¸ªçº¿ç¨‹ä¸­è¿è¡Œç€çš„Nä¸ªucontextä¸Šä¸‹æ–‡ã€‚ä¸Šä¸‹æ–‡ä¿¡æ¯ä¿å­˜åœ¨&lt;code>std::vector&amp;lt;ContextSlot&amp;gt; context_list_&lt;/code>ä¸­ã€‚&lt;/p>
&lt;p>slotæ˜¯å¯ä»¥å¤ç”¨çš„ï¼Œ&lt;code>first_done_item_&lt;/code>è®°å½•ç€å·²æ‰§è¡Œå®Œçš„contextçš„ä¸‹æ ‡ï¼Œç„¶åslotä¸­çš„&lt;code>next_done_item&lt;/code>è®°å½•ç€ä¸‹ä¸€ä¸ªæ‰§è¡Œå®Œçš„contextçš„ä¸‹æ ‡ã€‚ç®€è€Œè¨€ä¹‹ï¼Œè¿™å°±æ˜¯ç±»ä¼¼ä¸€ä¸ªâ€œè„æ± â€çš„è®¾è®¡ã€‚ä¸è¿‡è¿™ä¸ªå‘½åå•Šï¼Œä¸€ç‚¹éƒ½ä¸èµ›è‰‡ã€‚&lt;/p>
&lt;p>å‰©ä¸‹çš„ä»£ç åŸºæœ¬å°±æ˜¯&lt;code>UThreadContext&lt;/code>çš„æ— è„‘å°è£…äº†ã€‚éœ€è¦å“ªä¸ªåç¨‹å¼€å§‹å·¥ä½œå°±&lt;code>Resume&lt;/code>å“ªä¸ªåç¨‹ï¼Œéœ€è¦æš‚åœå°±è°ƒç”¨&lt;code>Yield&lt;/code>ã€‚ç»“æŸåï¼Œè°ƒç”¨å›è°ƒå‡½æ•°ï¼ŒæŠŠè¿è¡Œå®Œçš„åç¨‹å¾€è„æ± ä¸€æ‰”ï¼Œå®Œæ´»ã€‚&lt;/p>
&lt;h2 id="å†™åœ¨æœ€å">å†™åœ¨æœ€å &lt;a href="#%e5%86%99%e5%9c%a8%e6%9c%80%e5%90%8e" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>ä¸Šé¢æˆ‘ä»¬åˆ†æäº†phxrpcå¯¹ucontextåç¨‹åº“çš„å°è£…ï¼Œä¸‹ä¸€ç¯‡ï¼Œæˆ‘ä»¬å°±æ¥æ­£å¼çœ‹ä¸€çœ‹ucontextæ˜¯å¦‚ä½•ä¸IOå¤šè·¯å¤ç”¨çš„æŠ€æœ¯è¿æ¥åœ¨ä¸€èµ·çš„ã€‚&lt;/p>
&lt;p>æœ€åä¸Šå‡ å¼ çš‚ç‰‡ï¼š&lt;/p>
&lt;p>&lt;img src="https://github.com/Wizmann/assets/raw/master/wizmann-pic/16-10-13/31415098.jpg" alt="">&lt;/p>
&lt;p>&lt;img src="https://github.com/Wizmann/assets/raw/master/wizmann-pic/16-10-13/1208386.jpg" alt="">&lt;/p>
&lt;p>&lt;img src="https://github.com/Wizmann/assets/raw/master/wizmann-pic/16-10-13/97556242.jpg" alt="">&lt;/p>
&lt;p>&lt;img src="https://github.com/Wizmann/assets/raw/master/wizmann-pic/16-10-13/44196833.jpg" alt="">&lt;/p>
&lt;p>&lt;img src="https://github.com/Wizmann/assets/raw/master/wizmann-pic/16-10-13/20763058.jpg" alt="">&lt;/p></description></item><item><title>é˜»å¡TCPæµ - phxrpcä»£ç é˜…è¯»(3)</title><link>https://wizmann.top/posts/phxrpc-3/</link><pubDate>Mon, 03 Oct 2016 22:22:14 +0000</pubDate><guid>https://wizmann.top/posts/phxrpc-3/</guid><description>&lt;h2 id="å†™åœ¨å‰é¢">å†™åœ¨å‰é¢ &lt;a href="#%e5%86%99%e5%9c%a8%e5%89%8d%e9%9d%a2" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>phxrpcçš„æµï¼ˆ&lt;code>stream&lt;/code>å’Œ&lt;code>streambuf&lt;/code>ï¼‰ä¸ç½‘ç»œè®¿é—®å…¶å®æ˜¯è€¦åˆåœ¨ä¸€èµ·çš„ï¼Œæ‰€ä»¥æœ¬æ–‡å¯ä»¥ç»“åˆç€ç¬¬ä¸€ç¯‡ç¬”è®°ä¸€èµ·æ¥çœ‹ã€‚è™½ç„¶æˆ‘éå¸¸æƒ³åæ§½è¿™ç§å¼ºè€¦åˆæ€§çš„è®¾è®¡ï¼Œä½†æ˜¯æˆ‘å†³å®šè¿˜æ˜¯å¥½å¥½ç†è§£phxrpcçš„è®¾è®¡ä¹‹åã€‚ã€‚ã€‚æ”’ä¸€æ³¢å¤§çš„ï¼šï¼‰&lt;/p>
&lt;h2 id="blocktcpstreambuf">BlockTcpStreamBuf &lt;a href="#blocktcpstreambuf" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>&lt;code>class BlockTcpStreamBuf&lt;/code>ç»§æ‰¿è‡ª&lt;code>BaseTcpStreamBuf&lt;/code>ã€‚å…¶ä¸­é‡å†™äº†&lt;code>precv&lt;/code>å’Œ&lt;code>psend&lt;/code>ä¸¤ä¸ªå‡½æ•°ï¼Œå¹¶ä¸”æŒæœ‰äº†ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦(file descriptor)ï¼š&lt;code>socket_&lt;/code>ã€‚&lt;/p>
&lt;p>&lt;code>precv&lt;/code>å’Œ&lt;code>psend&lt;/code>ç›´æ¥è°ƒç”¨äº†&lt;code>&amp;lt;sys/socket.h&amp;gt;&lt;/code>ä¸­çš„&lt;code>recv(2)&lt;/code>å’Œ&lt;code>send(2)&lt;/code>ï¼Œå¹¶æ²¡æœ‰å…¶å®ƒæ“ä½œã€‚&lt;/p>
&lt;p>ç½‘ç»œç›¸å…³çš„æ“ä½œï¼Œåˆ™ç”±&lt;code>class BlockTcpStream&lt;/code>æ¥è´Ÿè´£ã€‚&lt;code>BlockTcpStreamBuf&lt;/code>åªè´Ÿè´£IOéƒ¨åˆ†ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">if&lt;/span> (BaseTcpUtils&lt;span style="color:#f92672">::&lt;/span>SetNonBlock(sockfd, false)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span> BaseTcpUtils&lt;span style="color:#f92672">::&lt;/span>SetNoDelay(sockfd, true)) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> stream&lt;span style="color:#f92672">-&amp;gt;&lt;/span>Attach(sockfd);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>} &lt;span style="color:#66d9ef">else&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> phxrpc&lt;span style="color:#f92672">::&lt;/span>log(LOG_ERR, &lt;span style="color:#e6db74">&amp;#34;set nonblock fail&amp;#34;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> error &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> close(sockfd);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>åœ¨&lt;code>BlockTcpStream&lt;/code>æŠŠfdä¼ é€’ç»™&lt;code>BlockTcpStreambuf&lt;/code>ä¹‹å‰ï¼Œéœ€è¦æŠŠfdè®¾ç½®ä¸º&lt;code>block&lt;/code>çš„ã€‚è€Œè¿™æ®µä»£ç æœ€å¤§çš„æ§½ç‚¹å°±æ˜¯è¿™ä¸ª&lt;code>SetNonBlock&lt;/code>å‡½æ•°ï¼Œå’Œä¸‹é¢çš„&lt;code>set nonblock fail&lt;/code>æ—¥å¿—ï¼ˆæƒ³ä¸€æƒ³ï¼‰ã€‚å®Œå…¨è®©äººæ‘¸ä¸åˆ°å¤´è„‘ï¼Œè¾¾åˆ°ä¸€è„¸æ‡µé€¼çš„æœ€é«˜å¢ƒç•Œã€‚&lt;/p>
&lt;p>&lt;img src="https://github.com/Wizmann/assets/raw/master/wizmann-pic/16-10-3/87163832.jpg" alt="">&lt;/p>
&lt;p>ç”±äº&lt;code>recv&lt;/code>å’Œ&lt;code>send&lt;/code>å‡½æ•°æ˜¯&lt;code>block&lt;/code>çš„ï¼Œæ‰€ä»¥åœ¨è¯»å–ã€å†™å…¥ç¼“å†²åŒºæ—¶ï¼Œå¦‚æœæ²¡æœ‰è¶³å¤Ÿçš„æ•°æ®å¯è¯»æˆ–æ²¡æœ‰è¶³å¤Ÿçš„ç©ºé—´å¯å†™ï¼Œåˆ™è¯»å–å†™å…¥æ“ä½œä¼šé˜»å¡ä½ã€‚&lt;/p>
&lt;h2 id="blocktcpstream">BlockTcpStream &lt;a href="#blocktcpstream" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>åœ¨è¿™é‡Œæˆ‘åˆæƒ³åä¸ªæ§½äº†ï¼Œä¸ºå•¥åœ¨è¿™é‡ŒæŠŠTCP Serverå’ŒClientçš„å·¥ä½œæµæ··ä¸ºä¸€è°ˆã€‚æˆ‘è§‰å¾—è‡³å°‘åº”è¯¥ä»å‘½åä¸ŠåŒºåˆ†ä¸€ä¸‹ï¼Œå¦åˆ™æå®¹æ˜“è¯¯ç”¨ã€‚&lt;/p>
&lt;h3 id="tcpçš„å·¥ä½œæµç¨‹">TCPçš„å·¥ä½œæµç¨‹ &lt;a href="#tcp%e7%9a%84%e5%b7%a5%e4%bd%9c%e6%b5%81%e7%a8%8b" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;p>&lt;img src="https://github.com/Wizmann/assets/raw/master/wizmann-pic/16-10-3/92621506.jpg" alt="">&lt;/p>
&lt;blockquote>
&lt;p>å›¾ç‰‡æ¥æºï¼šUNIXç½‘ç»œç¼–ç¨‹å·ä¸€ï¼šå¥—æ¥å­—ç¼–ç¨‹ 4.2èŠ‚&lt;/p>&lt;/blockquote>
&lt;p>ä»å›¾ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒTCPçš„æœåŠ¡ç«¯ä¸å®¢æˆ·ç«¯çš„å·¥ä½œæµç¨‹æ˜¯ä¸åŒçš„ï¼Œç›¸å¯¹æ¥è¯´ï¼Œå®¢æˆ·ç«¯çš„ç¨‹åºè¦ç®€å•ä¸€äº›ã€‚&lt;/p>
&lt;p>&lt;code>BlockTcpStream&lt;/code>ä¸­ï¼Œå®¢æˆ·ç«¯åº”ç”¨çš„å‡½æ•°åªæœ‰&lt;code>BlockTcpUtils::Open&lt;/code>ï¼Œè€ŒæœåŠ¡ç«¯çš„&lt;code>BlockTCPUtils::Listen&lt;/code>å‡½æ•°åŒ…æ‹¬äº†&lt;code>bind()&lt;/code>å’Œ&lt;code>listen()&lt;/code>ä¸¤ä¸ªæ“ä½œï¼Œè€Œ&lt;code>accept()&lt;/code>åˆ™éœ€è¦å¼€å‘è€…æ‰‹åŠ¨è°ƒç”¨ã€‚&lt;/p>
&lt;h3 id="so_reuseaddr">SO_REUSEADDR &lt;a href="#so_reuseaddr" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;p>åœ¨æœåŠ¡ç«¯çš„&lt;code>Listen()&lt;/code>å‡½æ•°ä¸­ï¼Œphxrpcä½¿ç”¨äº†&lt;code>SO_REUSEADDR&lt;/code>é€‰é¡¹ï¼Œè¿™ä¸ªé€‰é¡¹çš„æ„åœ¨é€šçŸ¥å†…æ ¸ï¼šå¦‚æœç«¯å£å¿™ï¼Œä½†æ˜¯TCPçŠ¶æ€ä½äº&lt;code>TIME_WAIT&lt;/code>æ—¶ï¼Œå¯ä»¥é‡ç”¨ç«¯å£ã€‚&lt;/p>
&lt;p>ä¸€ä¸ªå¥—æ¥å­—å…¶å®æ˜¯ä¸€ä¸ª&lt;code>ï¼ˆåè®®ï¼Œæºåœ°å€ï¼Œæºç«¯å£ï¼Œç›®æ ‡åœ°å€ï¼Œç›®æ ‡ç«¯å£ï¼‰&lt;/code>äº”å…ƒç»„ã€‚&lt;code>SO_REUSEADDR&lt;/code>æ„å‘³ç€æˆ‘ä»¬å¯ä»¥é‡ç”¨æºåœ°å€å’Œæºç«¯å£ã€‚å½“ç„¶æ­¤æ—¶çš„é£é™©åœ¨äºå¦‚æœè¯¥åŸå¥—æ¥å­—å‘é€äº†ä¸€äº›é”™è¯¯çš„æ•°æ®ï¼Œæ­¤æ—¶æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºçš„TCPå·¥ä½œæµå°±ä¼šäº§ç”Ÿé”™ä¹±ã€‚ä½†æ˜¯ç”±äºTCPçš„å®ç°ä¸­ï¼Œé€šè¿‡éšæœºçš„æ¶ˆæ¯åºå·è§„é¿äº†è¿™ä¸ªé—®é¢˜ï¼Œæ‰€ä»¥è¿™é‡Œçš„é£é™©å¯ä»¥å¿½ç•¥ä¸è®¡ã€‚&lt;/p>
&lt;p>ä½¿ç”¨&lt;code>SO_REUSEADDR&lt;/code>çš„å¥½å¤„æ˜¯ï¼Œåœ¨æœåŠ¡ç«¯ç¨‹åºå´©æºƒå’Œé€€å‡ºæ—¶ï¼ˆå¯¹äºä¸€èˆ¬çš„æœåŠ¡ç«¯ç¨‹åºæ¥è¯´ï¼Œå´©æºƒå’Œé€€å‡ºæ˜¯æ²¡æœ‰åŒºåˆ«çš„ï¼‰ï¼Œå¯ä»¥ç«‹å³é‡å¯ï¼Œè€Œä¸éœ€è¦ç­‰å¾…2MSLæ—¶é—´ã€‚&lt;/p>
&lt;p>é‚£ä¹ˆæˆ‘ä»¬è¦é—®äº†ï¼Œä¸ºä»€ä¹ˆåœ¨è¿™é‡Œæˆ‘ä»¬éœ€è¦ç­‰å¾…2MSLæ—¶é—´å‘¢ã€‚&lt;/p>
&lt;p>&lt;img src="https://github.com/Wizmann/assets/raw/master/wizmann-pic/16-10-3/33186679.jpg" alt="">&lt;/p>
&lt;blockquote>
&lt;p>å›¾ç‰‡æ¥æºï¼šEffective TCP/IP 3.8èŠ‚&lt;/p>&lt;/blockquote>
&lt;p>TCPæ‹†é™¤è¿æ¥ä½¿ç”¨äº†å››æ¬¡æ¡æ‰‹çš„æœºåˆ¶ï¼Œè€Œä¸»åŠ¨å…³é—­è¿æ¥çš„ä¸€æ–¹åœ¨å‘é€å®Œæœ€åä¸€ä¸ªACKä¹‹åï¼Œéœ€è¦ç­‰å¾…2MSLçš„æ—¶é—´ã€‚è¿™å°±æ˜¯ä¸Šé¢æ‰€è¯´çš„ï¼Œå½“æœåŠ¡å™¨é‡å¯åï¼Œå‡ºç°&lt;code>Address already in use&lt;/code>çš„æŠ¥é”™ä¿¡æ¯ï¼Œéœ€è¦é¢å¤–ç­‰å¾…å¤§çº¦1~4åˆ†é’Ÿçš„åŸå› ã€‚&lt;/p>
&lt;p>ç©¶å…¶åŸå› ï¼ŒTIME-WAITçŠ¶æ€çš„æ„å›¾åœ¨äºé¿å…ä¸»åŠ¨å…³é—­è¿æ¥çš„ä¸€ç«¯æœ€åä¸€ä¸ªACKå‘é€å¤±è´¥ã€‚æ­¤æ—¶ï¼Œä¸»æœº1å·²ç»å®Œå…¨å…³é—­ï¼Œè€Œä¸»æœº2å› ä¸ºæ²¡æœ‰æ”¶åˆ°FINåŒ…çš„ACKï¼Œå¤„äºåŠå…³é—­çŠ¶æ€ã€‚æ­¤æ—¶ä¸»æœº2å‘ä¸»æœº1å‘é€çš„ä»»ä½•ä¿¡æ¯ï¼ˆå¦‚å»¶è¿Ÿçš„ACKåŒ…ç­‰ï¼‰éƒ½åªä¼šæ”¶åˆ°RSTï¼Œå¯¼è‡´è¿æ¥çš„å¼‚å¸¸å…³é—­ã€‚&lt;/p>
&lt;p>ä¸ºäº†è§„é¿è¿™ä¸ªé—®é¢˜ï¼Œä¸»åŠ¨å…³é—­ç«¯éœ€è¦ç­‰å¾…2MSLæ—¶é—´ã€‚ä¸€ä¸ªMSLæ˜¯ç»™æœ€åçš„ACKåŒ…ï¼Œè€Œå¦å¤–ä¸€ä¸ªMSLï¼Œæ˜¯ä¸ºäº†ç­‰å¾…è¢«åŠ¨å…³é—­ç«¯é‡æ–°å‘é€FINåŒ…ã€‚å¦‚æœåœ¨TIME_WAITæœŸé—´æ”¶åˆ°äº†å¯¹ç«¯çš„æ•°æ®åŒ…ï¼Œä¼šåˆ·æ–°TIME_WAITçŠ¶æ€çš„æ—¶é—´ã€‚&lt;/p>
&lt;blockquote>
&lt;p>å‚è€ƒï¼šEffective TCP/IP 3.8 3.9èŠ‚&lt;/p>&lt;/blockquote>
&lt;h3 id="ioå¤ç”¨poll">IOå¤ç”¨ï¼šPoll &lt;a href="#io%e5%a4%8d%e7%94%a8poll" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;p>&lt;img src="https://github.com/Wizmann/assets/raw/master/wizmann-pic/16-10-3/84501111.jpg" alt="">&lt;/p>
&lt;blockquote>
&lt;p>å›¾ç‰‡æ¥æºï¼šUNIXç½‘ç»œç¼–ç¨‹å·ä¸€ï¼šå¥—æ¥å­—ç¼–ç¨‹ 6.2èŠ‚&lt;/p>&lt;/blockquote>
&lt;p>IOå¤ç”¨æ˜¯æŒ‡å†…æ ¸åœ¨å‘ç°è¿›ç¨‹æŒ‡å®šçš„ä¸€ä¸ªæˆ–å¤šä¸ªIOæ¡ä»¶å°±ç»ªï¼Œå†…æ ¸å°±é€šçŸ¥è¿›ç¨‹ã€‚é€šå¸¸æ¥è®²ï¼Œå¸¸ç”¨çš„IOå¤ç”¨å‡½æ•°æœ‰&lt;code>select()&lt;/code>å’Œ&lt;code>poll()&lt;/code>ã€‚&lt;/p>
&lt;p>å½“&lt;code>poll()&lt;/code>è¿”å›åï¼Œæˆ‘ä»¬éœ€è¦éå†å…¶ä¸­çš„fdæ•°ç»„æ‰¾åˆ°å¯æ“ä½œçš„fdã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">struct&lt;/span> &lt;span style="color:#a6e22e">pollfd&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">int&lt;/span> fd; &lt;span style="color:#75715e">/* file descriptor */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">short&lt;/span> events; &lt;span style="color:#75715e">/* requested events */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">short&lt;/span> revents; &lt;span style="color:#75715e">/* returned events */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>};
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æˆ‘ä»¬å¯ä»¥ä»&lt;code>events&lt;/code>å’Œ&lt;code>revents&lt;/code>è·å¾—è¯¥fdçš„çŠ¶æ€ï¼Œä»è€Œåˆ¤åˆ«å¯è¯»ã€å¯å†™ã€è¶…æ—¶æˆ–å‡ºé”™ã€‚&lt;/p>
&lt;p>åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰ä½¿ç”¨pollå‡½æ•°çš„IOå¤ç”¨èƒ½åŠ›ï¼Œè€Œæ˜¯æŠŠå®ƒåšä¸ºå¦ä¸€ä¸ªé˜»å¡IOè°ƒç”¨æ¥ä½¿ç”¨ã€‚&lt;/p>
&lt;p>&lt;code>BlockTcpUtils::Open&lt;/code>å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†pollï¼Œç”¨æ¥ç›‘è§†ç›¸åº”çš„ï¼ˆä¸€ä¸ªï¼‰fdæ˜¯å¦å¯è¯»ã€‚è¿™æ ·ä¸€æ¥ï¼Œæˆ‘ä»¬å°±éšå¼ï¼ˆä¸ºä»€ä¹ˆè¯´éšå¼å‘¢ï¼Œå› ä¸ºä»–ä»¬ä¸€ä¸å†™æ–‡æ¡£ï¼ŒäºŒä¸å†™æ³¨é‡Šï¼Œä¸€åˆ‡éƒ½æ˜¯æ½œè§„åˆ™ï¼‰è§„å®šäº†C/Säº¤äº’çš„åŸºæœ¬å·¥ä½œæµç¨‹ï¼šå½“C/Sè¿æ¥å»ºç«‹åï¼ŒServerç«¯è¦å…ˆè¯´è¯ï¼ŒClientç«¯æ¥æ”¶åˆ°æ¶ˆæ¯ä¹‹åï¼Œæ‰å¯ä»¥è¿›è¡Œä¸‹é¢çš„æµç¨‹ã€‚&lt;/p>
&lt;blockquote>
&lt;p>Clientï¼šâ€œä¸ç®¡ä½ ä»¬ä¿¡ä¸ä¿¡ï¼Œæ˜¯Serverå…ˆåŠ¨çš„æ‰‹ã€‚â€&lt;/p>&lt;/blockquote>
&lt;p>å…·ä½“ä¸ºä»€ä¹ˆå…ˆç”¨pollï¼Œå†æŠŠfdè®¾ä¸º&lt;code>blocking&lt;/code>çš„ï¼Œæˆ‘è¡¨ç¤ºäºŒè„¸æ‡µé€¼ã€‚åœ¨æˆ‘çš„å®éªŒä¸­ï¼Œå³ä½¿æŠŠpollåˆ æ‰ï¼Œæµ‹è¯•ä»£ç ä¹Ÿæ˜¯å¯ä»¥workçš„ã€‚å¯èƒ½åœ¨åé¢çš„ä»£ç é˜…è¯»ä¸­ï¼Œè¿™ä¸ªé—®é¢˜å¯ä»¥è·å¾—è§£é‡Šå§ã€‚&lt;/p>
&lt;p>å’Œselectä¸€æ ·ï¼Œpollä¹Ÿå­˜åœ¨è¢«ä¸­æ–­çš„æƒ…å†µï¼Œåœ¨phxrpcçš„ä»£ç é‡Œï¼Œæˆ‘ä»¬ç»™äº†ä¸­æ–­â€œa second chanceâ€ã€‚å½“pollè¢«ä¸­æ–­åï¼Œä¼šé‡æ–°å†pollä¸€æ¬¡ï¼›å¦‚æœè¿™æ¬¡å†è¢«ä¸­æ–­ï¼Œåˆ™ç›´æ¥è¿”å›TIMEOUTã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// retry again for EINTR
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">for&lt;/span> (&lt;span style="color:#66d9ef">int&lt;/span> i &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>; i &lt;span style="color:#f92672">&amp;lt;&lt;/span> &lt;span style="color:#ae81ff">2&lt;/span>; i&lt;span style="color:#f92672">++&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ret &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#f92672">::&lt;/span>poll(&lt;span style="color:#f92672">&amp;amp;&lt;/span>pfd, &lt;span style="color:#ae81ff">1&lt;/span>, timeout_ms);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (&lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span> &lt;span style="color:#f92672">==&lt;/span> ret &lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span> EINTR &lt;span style="color:#f92672">==&lt;/span> errno)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">continue&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">break&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">if&lt;/span> (&lt;span style="color:#ae81ff">0&lt;/span> &lt;span style="color:#f92672">==&lt;/span> ret)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> errno &lt;span style="color:#f92672">=&lt;/span> ETIMEDOUT;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="å†™åœ¨æœ€å">å†™åœ¨æœ€å &lt;a href="#%e5%86%99%e5%9c%a8%e6%9c%80%e5%90%8e" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>ç”±äºè¿™ç¯‡æ–‡ç« ä¸­çš„çŸ¥è¯†ç‚¹æ¯”è¾ƒæ‚ï¼Œå†™ä½œçš„é¡ºåºä¹Ÿæ˜¯éšæœºçš„ã€‚æ‰€ä»¥è¿è´¯æ€§ä¸æ˜¯é‚£ä¹ˆå¼ºã€‚å¦‚æœæœ‰ä»€ä¹ˆé—®é¢˜ï¼Œå¿ç€ç‚¹å§æ‚¨å°±ã€‚&lt;/p>
&lt;p>å¿ä¸äº†çš„è¯ã€‚ã€‚ã€‚é‚£å°±ç•™è¨€äº¤æµå§~&lt;/p>
&lt;p>&lt;img src="https://github.com/Wizmann/assets/raw/master/wizmann-pic/16-10-3/42112021.jpg" alt="">&lt;/p></description></item><item><title>å®šæ—¶å™¨ä»¥åŠå…¶å®ƒ - phxrpcé˜…è¯»ç¬”è®°(2)</title><link>https://wizmann.top/posts/phxrpc-2/</link><pubDate>Thu, 29 Sep 2016 01:28:09 +0000</pubDate><guid>https://wizmann.top/posts/phxrpc-2/</guid><description>&lt;h2 id="å†™åœ¨å‰é¢">å†™åœ¨å‰é¢ &lt;a href="#%e5%86%99%e5%9c%a8%e5%89%8d%e9%9d%a2" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>phxrpcä½¿ç”¨äº†åç¨‹(ucontext)å’ŒIOå¤ç”¨æŠ€æœ¯(epoll)æ¥å®ç°ç½‘ç»œé€šä¿¡ã€‚å®šæ—¶å™¨åœ¨å…¶ä¸­èµ·åˆ°äº†éå¸¸é‡è¦çš„ä½œç”¨ã€‚ä¸‹é¢æˆ‘ä»¬å°±æ¥åˆ†æä¸€ä¸‹phxrpcçš„&lt;code>timer.[h|cpp]&lt;/code>ä¸­çš„ä»£ç ã€‚&lt;/p>
&lt;h2 id="system_clock-vs-steady_clock">system_clock vs steady_clock &lt;a href="#system_clock-vs-steady_clock" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>&lt;code>system_clock&lt;/code>å’Œ&lt;code>steadly_clock&lt;/code>éƒ½æ˜¯æ¥è‡ª&lt;code>&amp;lt;chrono&amp;gt;&lt;/code>åº“ï¼Œéƒ½æ˜¯ç”¨æ¥è·å–å½“å‰æ—¶é—´çš„ã€‚&lt;/p>
&lt;p>&lt;code>system_clock&lt;/code>ç”¨æ¥ä»ç³»ç»Ÿæ—¶é’Ÿè·å–æ—¶é’Ÿæ—¶é—´(wall clock time)ï¼Œè€Œ&lt;code>steadly_clock&lt;/code>è·å–çš„æ˜¯æ—¶é’Ÿtickï¼Œè€Œä¸”ä¿è¯éšç€æ—¶é—´çš„æ¨ç§»ï¼Œæ—¶é’Ÿtickæ•°ä¸ä¼šå˜å°ã€‚&lt;/p>
&lt;p>ç„¶è€Œå®é™…ä¸Šï¼Œåœ¨æŸäº›ç³»ç»Ÿä¸‹ï¼Œè¿™ä¸¤ä¸ªæ—¶é’Ÿçš„å®ç°æ˜¯ä¸€è‡´çš„ã€‚è¯¦ç»†ä¿¡æ¯å¯ä»¥å‚è€ƒ&lt;a href="http://stackoverflow.com/questions/13263277/difference-between-stdsystem-clock-and-stdsteady-clock">è¿™é‡Œ&lt;/a>ã€‚&lt;/p>
&lt;blockquote>
&lt;p>æ³¨ï¼šåœ¨clang++ 4.2.1, g++ 5.4 ä¸‹å®éªŒï¼Œè¿™ä¸¤ä¸ªæ—¶é’Ÿæ˜¯ä¸åŒçš„ã€‚æ‰€ä»¥ä¸ªäººè®¤ä¸ºåœ¨è¿™é‡Œæœ€å¥½ä¸è¦åšä»»ä½•æ— æ„ä¹‰çš„å‡è®¾ã€‚&lt;/p>&lt;/blockquote>
&lt;h2 id="å‡ æ¯«ç§’çš„å®‰ç¡">å‡ æ¯«ç§’çš„å®‰ç¡ &lt;a href="#%e5%87%a0%e6%af%ab%e7%a7%92%e7%9a%84%e5%ae%89%e7%9d%a1" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">void&lt;/span> Timer &lt;span style="color:#f92672">::&lt;/span> MsSleep(&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> time_ms) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> timespec t;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> t.tv_sec &lt;span style="color:#f92672">=&lt;/span> time_ms &lt;span style="color:#f92672">/&lt;/span> &lt;span style="color:#ae81ff">1000&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> t.tv_nsec &lt;span style="color:#f92672">=&lt;/span> (time_ms &lt;span style="color:#f92672">%&lt;/span> &lt;span style="color:#ae81ff">1000&lt;/span>) &lt;span style="color:#f92672">*&lt;/span> &lt;span style="color:#ae81ff">1000000&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">int&lt;/span> ret &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">do&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ret &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#f92672">::&lt;/span>nanosleep(&lt;span style="color:#f92672">&amp;amp;&lt;/span>t, &lt;span style="color:#f92672">&amp;amp;&lt;/span>t);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> } &lt;span style="color:#66d9ef">while&lt;/span> (ret &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span> &lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span> errno &lt;span style="color:#f92672">==&lt;/span> EINTR);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™é‡Œphxrpcä½¿ç”¨äº†&lt;code>nanosleep&lt;/code>å®ç°äº†é«˜ç²¾åº¦çš„sleepã€‚&lt;/p>
&lt;p>æ³¨æ„è¿™é‡Œçš„ç”¨æ³•ï¼Œç”±äº&lt;code>nanosleep&lt;/code>å¯èƒ½è¢«ä¿¡å·ä¸­æ–­ï¼Œæ­¤æ—¶errnoè¢«è®¾ä¸º&lt;code>EINTR&lt;/code>ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦è¿›è¡Œé¢å¤–çš„åˆ¤æ–­ã€‚å½“nanosleepè¢«ä¿¡å·ä¸­æ–­æ—¶ï¼Œä¼šæŠŠå‰©ä½™æ—¶é—´å†™å…¥ç¬¬äºŒä¸ªå‚æ•°æŒ‡å‘çš„&lt;code>timespec&lt;/code>å˜é‡ä¸­ï¼Œä¹‹åæˆ‘ä»¬å†æ¬¡è°ƒç”¨&lt;code>nanosleep&lt;/code>ï¼Œå°±å¯ä»¥æŠŠå‰©ä½™çš„æ—¶é—´å†ç¡ä¸€ä¸ªå›ç¬¼è§‰äº†ã€‚&lt;/p>
&lt;h2 id="å¯åˆ é™¤ä¼˜å…ˆé˜Ÿåˆ—">å¯åˆ é™¤ä¼˜å…ˆé˜Ÿåˆ— &lt;a href="#%e5%8f%af%e5%88%a0%e9%99%a4%e4%bc%98%e5%85%88%e9%98%9f%e5%88%97" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>è¿™ä¸ªè®¾è®¡ä¸€é¢—èµ›è‰‡å•Šã€‚&lt;/p>
&lt;p>å¯¹äº&lt;code>std::priority_queue&lt;/code>ä»¥åŠå¤§å¤šæ•°æ‰‹å†™çš„ä¼˜å…ˆé˜Ÿåˆ—ï¼ˆåˆç§°å †ï¼Œheapï¼‰ã€‚ä¸€èˆ¬åªæœ‰&lt;code>top()&lt;/code>, &lt;code>push()&lt;/code>, &lt;code>pop()&lt;/code>è¿™ä¸‰ä¸ªæ“ä½œæ¥å£ï¼Œå¦‚æœæƒ³å®ç°åˆ é™¤æ“ä½œï¼Œå¤§å¤šæ•°æƒ…å†µï¼ˆä¸ºäº†å·æ‡’ï¼‰ä¼šæŠŠ&lt;code>std::priority_queue&lt;/code>æ›¿æ¢ä¸º&lt;code>std::set&lt;/code>ã€‚&lt;code>std::set&lt;/code>çš„å†…éƒ¨å®ç°æ˜¯å¹³è¡¡æ ‘ï¼ˆç¡®åˆ‡çš„è¯´ï¼Œçº¢é»‘æ ‘ï¼‰ï¼Œå¯ä»¥å®ç°è·å¾—æœ€å¤§æœ€å°å€¼ï¼ŒæŸ¥æ‰¾æŸä¸ªå€¼ï¼Œä»¥åŠåˆ é™¤æŸä¸ªå€¼çš„æ“ä½œã€‚&lt;/p>
&lt;p>ä½†æ˜¯&lt;code>std::priority_queue&lt;/code>ï¼ˆæˆ–è€…ç”¨æ•°ç»„æˆ–vectorå®ç°çš„å †ï¼‰æ˜¯é¡ºåºå®¹å™¨(sequence containers)ï¼Œè€Œ&lt;code>std::set&lt;/code>æ˜¯å…³è”å®¹å™¨(associative containers)ã€‚ç›¸å¯¹æ¥è¯´ï¼Œç”±äºcacheçš„åŸå› ï¼Œé¡ºåºå®¹å™¨çš„æ€§èƒ½æ¯”å…³è”å®¹å™¨è¦å¥½ã€‚å½“ç„¶æˆ‘æ‰¯å¾—æœ‰ç‚¹è¿œäº†ã€‚å¯¹æ­¤æ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥å»å‚è€ƒã€ŠEffective STLã€‹ä¸€ä¹¦ã€‚&lt;/p>
&lt;p>åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬çš„éœ€æ±‚æ˜¯è¿™æ ·çš„ï¼š&lt;/p>
&lt;ul>
&lt;li>å †æ˜¯å°æ ¹å †ï¼ŒæŒ‰è¶…æ—¶æ—¶é—´å¢åº&lt;/li>
&lt;li>å †ä¸­çš„å…ƒç´ æ˜¯socketæè¿°ç¬¦&lt;code>UThreadSocket_t&lt;/code>&lt;/li>
&lt;li>æ ¹æ®æè¿°ç¬¦ï¼Œæˆ‘ä»¬å¯ä»¥åˆ é™¤å †ä¸­çš„ä»»æ„å…ƒç´ &lt;/li>
&lt;/ul>
&lt;p>å¦‚æœæˆ‘ä»¬æœ‰æ¸…é†’çš„å¤´è„‘ï¼Œå°±ä¼šè®¤ä¸ºè¿™ä¸ªéœ€æ±‚æ˜¯ä¸å¥½å®ç°çš„ã€‚åˆ é™¤å †ä¸­å…ƒç´ å¹¶ä¸å¤æ‚ï¼Œåªéœ€è¦å°†å †ä¸­æœ€åä¸€ä¸ªå…ƒç´ æ”¾åˆ°è¢«åˆ é™¤å…ƒç´ çš„ä½ç½®ä¸Šï¼Œç„¶åå†æ‰§è¡Œä¸€æ¬¡&lt;code>heap_down()&lt;/code>æ“ä½œå°±å¯ä»¥äº†ã€‚é—®é¢˜åœ¨äºæˆ‘ä»¬å¾ˆéš¾ç¡®å®šæŸä¸€ä¸ªå…ƒç´ çš„å…·ä½“ä½ç½®ã€‚&lt;/p>
&lt;blockquote>
&lt;p>æƒ³ä¸€æƒ³ï¼Œå †ä¸­çš„æ•°æ®æ˜¯å¦‚ä½•ç»„ç»‡çš„ã€‚å¦‚æœæƒ³æ‰¾åˆ°æŸä¸€ä¸ªç‰¹å®šçš„å€¼ï¼Œé™¤äº†éå†ä¹‹å¤–ï¼Œè¿˜æœ‰æ²¡æœ‰å…¶å®ƒçš„æ–¹æ³•ã€‚&lt;/p>&lt;/blockquote>
&lt;p>è¿™é‡Œphxrpcä½¿ç”¨äº†ä¸€ç§ä¾µå…¥å¼çš„æ‰‹æ®µï¼Œå°†ä¸‹æ ‡å†™å…¥å †ä¸­å…ƒç´ ã€‚ç„¶åå †å¤–æŒæœ‰æŒ‡é’ˆã€‚ç„¶ååœ¨ç»´æŠ¤å †æ€§è´¨çš„æ—¶å€™ï¼ŒåŒæ­¥æ›´æ–°å †ä¸­å…ƒç´ ï¼Œä½¿å…¶ä¸­ä¿å­˜çš„ä¸‹æ ‡ä¸å…¶åœ¨å †ä¸­çš„ä¸‹æ ‡ä¸€è‡´ã€‚&lt;/p>
&lt;p>è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡æŒ‡é’ˆæ‹¿åˆ°ç›¸åº”å…ƒç´ çš„ä¸‹æ ‡ï¼Œåˆ é™¤æ“ä½œä¹Ÿå˜å¾—ç®€å•äº†èµ·æ¥ã€‚&lt;/p>
&lt;p>é‚£ä¹ˆä¾µå…¥å¼å †ä¸‹æ ‡æœ‰ä»€ä¹ˆé—®é¢˜å—ï¼Ÿä¸€æ¥æˆ‘ä»¬å¯¹äºå…ƒç´ çš„æŸ¥æ‰¾åªèƒ½æ ¹æ®å®¹å™¨å¤–æŒæœ‰çš„æŒ‡é’ˆæ¥è¿›è¡Œï¼Œå¹¶ä¸èƒ½åƒ&lt;code>std::set&lt;/code>é‚£æ ·é€šè¿‡æ¯”è¾ƒå…³ç³»æ¥æŸ¥æ‰¾ã€‚äºŒæ¥ä¾µå…¥å¼ä¸‹æ ‡éœ€è¦é¢å¤–çš„å†…å­˜ç©ºé—´ï¼Œå¯¹äºå°å‹å¯¹è±¡ä¼šé€ æˆå¯è§‚æ¯”ä¾‹çš„overheadã€‚åŒæ—¶å®¹å™¨å†…åªèƒ½æŒæœ‰å…ƒç´ æŒ‡é’ˆï¼Œåœ¨æŸç§ç¨‹åº¦ä¸Šä¼šå¸¦æ¥é¢å¤–çš„å¯»å€å¼€é”€ã€‚&lt;/p>
&lt;p>ä¸è¿‡ï¼Œè¿™å¤§æ¦‚ä¹Ÿæ˜¯è®©å †æ”¯æŒåˆ é™¤çš„å”¯ä¸€æ–¹æ³•äº†ã€‚&lt;/p>
&lt;h2 id="å°å°åæ§½">å°å°åæ§½ &lt;a href="#%e5%b0%8f%e5%b0%8f%e5%90%90%e6%a7%bd" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>è¿™æ®µä»£ç å†™çš„ï¼Œè²Œä¼¼è€¦åˆçš„å¤ªç´§äº†ä¸€ç‚¹ã€‚&lt;code>class Timer&lt;/code>å†…éƒ¨æä¾›çš„åŠŸèƒ½æœ‰&lt;/p>
&lt;ol>
&lt;li>å¾—åˆ°å½“å‰æ—¶é—´&lt;/li>
&lt;li>nanosleep&lt;/li>
&lt;li>å°è£…&lt;code>TimerObj&lt;/code>ç±»&lt;/li>
&lt;li>ç»´æŠ¤ä¸€ä¸ªå®šæ—¶å™¨å †ï¼Œæä¾›&lt;code>top()&lt;/code>, &lt;code>push()&lt;/code>, &lt;code>pop()&lt;/code>, &lt;code>erase()&lt;/code>åŠŸèƒ½ï¼Œå¹¶ä¸”å¤§å¤šæ•°æ“ä½œéƒ½æ˜¯ç¡¬ç¼–ç çš„&lt;/li>
&lt;/ol>
&lt;p>è‡³å°‘åœ¨æˆ‘çœ‹æ¥ï¼Œè¿™å¹¶ä¸ç¬¦åˆâ€œé«˜å†…èšï¼Œä½è€¦åˆâ€ä»£ç é£æ ¼ã€‚&lt;/p>
&lt;p>ä½ é—®æˆ‘ä¸ºå•¥ä¸ç»™æ”¹æ”¹ï¼Ÿ&lt;/p>
&lt;p>å› ä¸ºä»–ä»¬æ²¡å†™æµ‹è¯•å•Šï¼&lt;/p>
&lt;p>&lt;img src="https://github.com/Wizmann/assets/raw/master/wizmann-pic/16-9-29/12309965.jpg" alt="">&lt;/p>
&lt;h2 id="è¡¥å……">è¡¥å…… &lt;a href="#%e8%a1%a5%e5%85%85" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>å…¶å®å¯¹äº&lt;code>class Timer&lt;/code>ï¼Œphxrpcæ˜¯æœ‰å†™æµ‹è¯•çš„(test_timer.cpp)ã€‚ä½†æ˜¯è¿™ä¸ªä»£ç å†™çš„å°±æ›´è¿·äº†ã€‚è¿™é‡Œå†åˆ†æä¸€ä¸‹ã€‚&lt;/p>
&lt;p>ä¸€å¼€å§‹ï¼Œå…ˆåˆ›å»º100ä¸ªtimerï¼Œsleepæ—¶é—´éšæœºã€‚ç„¶åå°†50ä¸ªtimeræ”¾å…¥&lt;code>need_remove&lt;/code>æ•°ç»„ä¸­ã€‚&lt;/p>
&lt;p>ä¹‹åæ¯åˆ ä¸€ä¸ªtimerï¼Œå°±é…å¥—ç¡åˆ°è¶…æ—¶æ—¶é—´popä¸€ä¸ªtimerã€‚å¼¹å‡ºè¶…æ—¶timeråï¼Œå†åˆ¤æ–­ä¸€ä¸‹æ—¶é—´è¯¯å·®æ˜¯å¦è¶…è¿‡10msï¼Œå¦‚æœæ˜¯ï¼Œå°±æŠ¥é”™ã€‚&lt;/p>
&lt;p>è¿™ã€‚ã€‚ã€‚&lt;/p>
&lt;p>&lt;img src="https://github.com/Wizmann/assets/raw/master/wizmann-pic/16-9-29/43591449.jpg" alt="">&lt;/p></description></item><item><title>è‡ªå®šä¹‰ä½ çš„stream buffer - phxrpcé˜…è¯»ç¬”è®°(1)</title><link>https://wizmann.top/posts/phxrpc-1/</link><pubDate>Wed, 28 Sep 2016 22:35:55 +0000</pubDate><guid>https://wizmann.top/posts/phxrpc-1/</guid><description>&lt;h2 id="å†™åœ¨å‰é¢">å†™åœ¨å‰é¢ &lt;a href="#%e5%86%99%e5%9c%a8%e5%89%8d%e9%9d%a2" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>&lt;a href="https://github.com/tencent-wechat/phxrpc">phxrpc&lt;/a>æ˜¯å¾®ä¿¡å›¢é˜Ÿå¼€æºçš„ä¸€ä¸ªè½»é‡çº§RPCæ¡†æ¶ã€‚&lt;/p>
&lt;p>æˆ‘å¯¹RPCè¿™äº›ä¸œè¥¿äº†è§£ä¸å¤šï¼Œçœ‹åˆ°phxrpcçš„ä»£ç ç›¸å¯¹ç®€å•ï¼Œè€Œä¸”è¿˜åœ¨åˆæ­¥å¼€å‘é˜¶æ®µï¼ˆåœ¨æœ¬æ–‡å†™ä½œæ—¶ï¼Œç‰ˆæœ¬å·æ˜¯0.8ï¼‰ã€‚æ‰€ä»¥æƒ³è¯»ä¸€è¯»ï¼Œæé«˜ä¸€ä¸‹å§¿åŠ¿æ°´å¹³ã€‚&lt;/p>
&lt;p>å°±æ˜¯è¿™æ ·ã€‚&lt;/p>
&lt;h2 id="è‡ªå®šä¹‰stream-buffer">è‡ªå®šä¹‰stream buffer &lt;a href="#%e8%87%aa%e5%ae%9a%e4%b9%89stream-buffer" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>&lt;code>network/socket_stream_base.[h|cpp]&lt;/code>ä¸­çš„&lt;code>class BaseTcpStreamBuf&lt;/code>ç»§æ‰¿äº†&lt;code>std::streambuf&lt;/code>ï¼Œè‡ªå®šä¹‰äº†ä¸€ä¸ªæµç¼“å†²åŒºï¼Œç”¨äºæ¥æ”¶/å‘é€TCPæ•°æ®åŒ…ã€‚&lt;/p>
&lt;p>è¿™ä¸ªç”¨æ³•æ¯”è¾ƒæ–°é¢–ï¼ˆæˆ–è€…æ˜¯æˆ‘è§è¯†å°‘ï¼‰ï¼Œç½‘ä¸Šçš„èµ„æ–™ä¹Ÿä¸å¤šã€‚è¿™é‡Œç¿»è¯‘ä¸€ç¯‡&lt;a href="http://www.mr-edd.co.uk/blog/beginners_guide_streambuf">ä»‹ç»æ–‡ç« &lt;/a>ï¼Œå­¦ä¹ ä¸€ä¸‹æ–°å§¿åŠ¿ã€‚&lt;/p>
&lt;h2 id="a-beginners-guide-to-writing-a-custom-stream-buffer">A beginner&amp;rsquo;s guide to writing a custom stream buffer &lt;a href="#a-beginners-guide-to-writing-a-custom-stream-buffer" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>æµ(streams)æ˜¯STLä¸­æä¾›çš„ä¸€ä¸ªé‡è¦çš„æŠ½è±¡æ¦‚å¿µã€‚è‘—åçš„â€œHello worldâ€ç¨‹åºï¼Œä¾¿æ˜¯ä½¿ç”¨äº†std::coutå°†å­—ç¬¦ä¸²å†™å…¥æ ‡å‡†è¾“å‡ºæµ(stdout)ã€‚&lt;/p>
&lt;p>æµå½“ç„¶å¯ä»¥åšæ¯”cin/coutæ›´æœ‰æ„æ€çš„äº‹ã€‚è¿™ç¯‡æ–‡ç« æˆ‘ä»¬ä¼šç ”ç©¶å¦‚ä½•æ‰©å±•C++æµï¼Œæ¥å®ç°è‡ªå®šä¹‰çš„æµç¼“å†²åŒº(stream buffer)ã€‚p.s. å»ºè®®æœ¬æ–‡çš„è¯»è€…è‡³å°‘è¦æœ‰åŸºç¡€çš„C++çŸ¥è¯†ã€‚&lt;/p>
&lt;p>C++æ ‡å‡†åº“ä¸ºç£ç›˜æ–‡ä»¶æ“ä½œæä¾›äº†åŸºç¡€çš„æ¥å£ï¼Œå¦‚&lt;code>std::fstream&lt;/code>ï¼Œ&lt;code>std::ifstream&lt;/code>å’Œ&lt;code>std::ofstream&lt;/code>ã€‚æˆ‘ä»¬è¿˜æœ‰&lt;code>stringstream&lt;/code>ï¼Œå¯ä»¥åƒæµä¸€æ ·æ“ä½œå­—ç¬¦ä¸²ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>std&lt;span style="color:#f92672">::&lt;/span>ostringstream oss;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>oss &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#e6db74">&amp;#34;Hello, world!&lt;/span>&lt;span style="color:#ae81ff">\\&lt;/span>&lt;span style="color:#e6db74">n&amp;#34;&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>oss &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#ae81ff">123&lt;/span> &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">&amp;#39;\\&lt;/span>n&lt;span style="color:#960050;background-color:#1e0010">&amp;#39;&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>std&lt;span style="color:#f92672">::&lt;/span>string s &lt;span style="color:#f92672">=&lt;/span> oss.str();
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç›¸ä¼¼çš„ï¼Œæˆ‘ä»¬å¯ä»¥ä»&lt;code>std::istringstream&lt;/code>ä¸­ä½¿ç”¨&lt;code>&amp;gt;&amp;gt;&lt;/code>æ“ä½œç¬¦è¯»å–æ•°æ®ã€‚&lt;/p>
&lt;p>Booståº“ä¸­çš„&lt;code>lexical_cast&lt;/code>æ­£æ˜¯ä½¿ç”¨äº†è¿™ç§æœºåˆ¶ï¼Œè®©ç”¨æˆ·å¯ä»¥ä½¿ç”¨ç»Ÿä¸€çš„æ–¹å¼å°†ä¸€ä¸ªå¯¹è±¡(object)è½¬æ¢ä¸ºå­—ç¬¦ä¸²è¡¨ç¤ºã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">using&lt;/span> boost&lt;span style="color:#f92672">::&lt;/span>lexical_cast;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">using&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>string;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">int&lt;/span> x &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">5&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>string s &lt;span style="color:#f92672">=&lt;/span> lexical_cast&lt;span style="color:#f92672">&amp;lt;&lt;/span>string&lt;span style="color:#f92672">&amp;gt;&lt;/span>(x);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>assert(s &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#e6db74">&amp;#34;5&amp;#34;&lt;/span>);
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æµç¼“å†²åŒºæœ‰ç€å¾ˆå¼ºçš„çµæ´»æ€§ï¼Œå¯ä»¥æ»¡è¶³ä¸åŒçš„â€œç¼“å†²å¹¶ä¼ è¾“å­—ç¬¦ï¼ˆä¸²ï¼‰â€éœ€æ±‚ï¼Œæ¯”å¦‚æ–‡ä»¶æ“ä½œã€å­—ç¬¦ä¸²æ“ä½œã€å‘½ä»¤è¡Œ(Console)æ“ä½œç­‰ã€‚æˆ‘ä»¬å¯ä»¥ä»ç½‘ç»œã€é—ªå­˜(Flash memory)ç­‰ä¸åŒè®¾å¤‡ï¼Œä½¿ç”¨åŒæ ·çš„æ¥å£è·å–æµå¼å­—ç¬¦ä¸²ã€‚â€œæµç¼“å†²åŒºâ€ä¸â€œæµâ€æ˜¯æ­£äº¤çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥è‡ªç”±çš„äº¤æ¢ã€æ›´æ”¹(swap and change)æµæ‰€ä½¿ç”¨çš„ç¼“å†²åŒºï¼Œæˆ–è€…å°†å…¶é‡å®šå‘åˆ°å…¶å®ƒåœ°æ–¹ã€‚æˆ‘è®¤ä¸ºC++ä¸­çš„æµï¼Œæ­£æ˜¯â€œç­–ç•¥æ¨¡å¼â€(strategy design pattern)çš„ä¸€ä¸ªè‰¯å¥½èŒƒä¾‹ã€‚&lt;/p>
&lt;p>æ¯”å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥é‡å®šå‘æ ‡å‡†æ—¥å¿—æµ&lt;code>std::clog&lt;/code>åˆ°ä¸€ä¸ªå­—ç¬¦ä¸²æµï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;iostream&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;iomanip&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;string&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;sstream&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">int&lt;/span> &lt;span style="color:#a6e22e">main&lt;/span>()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> std&lt;span style="color:#f92672">::&lt;/span>ostringstream oss;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// Make clog use the buffer from oss
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>streambuf &lt;span style="color:#f92672">*&lt;/span>former_buff &lt;span style="color:#f92672">=&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> std&lt;span style="color:#f92672">::&lt;/span>clog.rdbuf(oss.rdbuf());
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> std&lt;span style="color:#f92672">::&lt;/span>clog &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#e6db74">&amp;#34;This will appear in oss!&amp;#34;&lt;/span> &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>flush;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> std&lt;span style="color:#f92672">::&lt;/span>cout &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> oss.str() &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">&amp;#39;\\&lt;/span>n&lt;span style="color:#960050;background-color:#1e0010">&amp;#39;&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// Give clog back its previous buffer
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>clog.rdbuf(former_buff);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¸è¿‡ï¼Œè‡ªå®šä¹‰ä¸€ä¸ªæµç¼“å†²åŒºå´æ˜¯æœ‰ä¸€ç‚¹trickyï¼Œæˆ–è€…è¯´æœ‰ä¸€ç‚¹å“äººï¼Œå°¤å…¶æ˜¯å½“ä½ ç¬¬ä¸€æ¬¡å°è¯•çš„æ—¶å€™ã€‚æ‰€ä»¥æœ¬æ–‡æ„åœ¨æä¾›ä¸€äº›æµç¼“å†²çš„å®ç°èŒƒä¾‹ã€‚&lt;/p>
&lt;p>é¦–å…ˆæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹æµç¼“å†²åŒºçš„ä¸€äº›åŸºæœ¬æ¦‚å¿µã€‚æ‰€æœ‰çš„æµç¼“å†²åŒºç»§æ‰¿è‡ª&lt;code>std::streambuf&lt;/code>ï¼Œå¹¶ä¸”éœ€è¦è¦†ç›–ä¸€äº›è™šå‡½æ•°æ¥å®ç°è‡ªå®šä¹‰åŠŸèƒ½ã€‚&lt;code>std::streambuf&lt;/code>æ˜¯â€œé¡ºåºè¯»å–è®¾å¤‡â€çš„ä¸€ä¸ªæŠ½è±¡ï¼Œå³æˆ‘ä»¬å¯ä»¥ä»ä¸­é¡ºåºçš„è¯»å–å­—ç¬¦åºåˆ—ã€‚åœ¨ç‰¹å®šçš„åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥é‡å¡«(re-fill)ã€å†²æ´—(flush)ä»¥åŠæ¸…ç©º(empty)ä¸€ä¸ªç¼“å†²åŒºã€‚&lt;/p>
&lt;p>å½“æˆ‘ä»¬å‘ä¸€ä¸ª&lt;code>ostream&lt;/code>ä¸­æ’å…¥æ•°æ®æ—¶ï¼Œæ•°æ®å°†ä¼šè¢«å†™å…¥ç¼“å†²åŒºä¸­çš„ä¸€ä¸ªæ•°ç»„ã€‚å½“æ•°ç»„ä¸Šæº¢(overflow)æ—¶ï¼Œæ•°ç»„ä¸­çš„æ•°æ®å°†ä¼šè¢«å†²æ´—(flush)åˆ°ç›®æ ‡æ¥å—è€…ï¼Œä¹‹åè¿™ä¸ªæ•°ç»„çš„çŠ¶æ€å°†ä¼šé‡ç½®ï¼Œä»¥ä¾¿å­˜å‚¨åç»­çš„å­—ç¬¦ã€‚&lt;/p>
&lt;p>å½“æˆ‘ä»¬ä»ä¸€ä¸ª&lt;code>istream&lt;/code>ä¸­è·å–æ•°æ®æ—¶ï¼Œæ•°æ®ä»ç¼“å†²åŒºçš„æ•°ç»„ä¸­è¯»å‡ºã€‚å½“æ•°ç»„ä¸‹æº¢æ—¶(underflow)ï¼Œæ²¡æœ‰æ•°æ®å¯è¯»ï¼Œæˆ‘ä»¬ä¼šä»æ•°æ®æºé‡æ–°æ‹‰å–ä¿¡æ¯æ¥å¡«å……ç¼“å†²åŒºï¼Œä¹‹åè¿™ä¸ªæ•°ç»„çš„çŠ¶æ€ä¹Ÿå°†è¢«é‡ç½®ã€‚&lt;/p>
&lt;p>æˆ‘ä»¬ä½¿ç”¨6ä¸ªæŒ‡é’ˆï¼Œæ¥ç»´æŠ¤ç¼“å†²åŒºçš„å†…éƒ¨çŠ¶æ€ã€‚è¾“å…¥å’Œè¾“å‡ºç¼“å†²å„ä½¿ç”¨3ä¸ªæŒ‡é’ˆã€‚&lt;/p>
&lt;h3 id="ç»´æŠ¤è¾“å‡ºç¼“å†²åŒºçš„çŠ¶æ€">ç»´æŠ¤è¾“å‡ºç¼“å†²åŒºçš„çŠ¶æ€ &lt;a href="#%e7%bb%b4%e6%8a%a4%e8%be%93%e5%87%ba%e7%bc%93%e5%86%b2%e5%8c%ba%e7%9a%84%e7%8a%b6%e6%80%81" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;ul>
&lt;li>
&lt;p>put base pointer &lt;br>
è¾“å‡ºåŸºæŒ‡é’ˆï¼Œç”¨æ¥æŒ‡å®šç¼“å†²åŒºå†…éƒ¨æ•°ç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´ ã€‚å¯ä»¥ä½¿ç”¨&lt;code>std::streambuf::pbase()&lt;/code>æ¥è·å–&lt;/p>
&lt;/li>
&lt;li>
&lt;p>put pointer &lt;br>
è¾“å‡ºæŒ‡é’ˆï¼Œç”¨æ¥æŒ‡å‘å†…éƒ¨æ•°ç»„ä¸‹ä¸€ä¸ªå†™å…¥çš„åœ°å€ã€‚å¯ä»¥ä½¿ç”¨&lt;code>std::streambuf::pptr()&lt;/code>æ¥è·å–&lt;/p>
&lt;/li>
&lt;li>
&lt;p>end put pointer &lt;br>
è¾“å‡ºå“¨å…µæŒ‡é’ˆï¼ŒæŒ‡å‘å†…éƒ¨æ•°ç»„æœ€åä¸€ä¸ªå†åé¢ä¸€ä¸ª(one-past-the-last-element)çš„åœ°å€ï¼ˆè¯‘æ³¨ï¼šç±»ä¼¼&lt;code>std::vector::end()&lt;/code>ï¼‰ã€‚å¯ä»¥ä½¿ç”¨&lt;code>std::streambuf:epptr()&lt;/code>æ¥è·å–&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="http://i1.piimg.com/567571/630a89fe635e1635.png" alt="">&lt;/p>
&lt;p>ä¸€èˆ¬æ¥è¯´ï¼ŒåŸºæŒ‡é’ˆå’Œå“¨å…µæŒ‡é’ˆä¸ä¼šæ”¹å˜ï¼Œåœ¨ä½¿ç”¨æ—¶ï¼Œä»¥è¾“å‡ºæŒ‡é’ˆç»´æŠ¤å†…éƒ¨çŠ¶æ€ã€‚&lt;/p>
&lt;h3 id="ç»´æŠ¤è¾“å…¥ç¼“å†²åŒºçš„çŠ¶æ€">ç»´æŠ¤è¾“å…¥ç¼“å†²åŒºçš„çŠ¶æ€ &lt;a href="#%e7%bb%b4%e6%8a%a4%e8%be%93%e5%85%a5%e7%bc%93%e5%86%b2%e5%8c%ba%e7%9a%84%e7%8a%b6%e6%80%81" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;p>è¾“å…¥ç¼“å†²åŒºå’ŒçŠ¶æ€ç»´æŠ¤å’Œè¾“å‡ºç¼“å†²åŒºç±»ä¼¼ï¼Œæˆ‘ä»¬æœ‰ï¼š&lt;/p>
&lt;ul>
&lt;li>end back pointer &lt;br>
è¾“å…¥åŸºæŒ‡é’ˆï¼ŒæŒ‡å‘ç¼“å†²åŒºæ•°ç»„å†…çš„æœ€åä¸€ä¸ªå­—ç¬¦ã€‚å¯ä»¥ä½¿ç”¨&lt;code>std::streambuf::eback()&lt;/code>æ¥è·å–&lt;/li>
&lt;li>get pointer &lt;br>
è¾“å…¥æŒ‡é’ˆï¼ŒæŒ‡å‘ç¼“å†²åŒºä¸‹ä¸€ä¸ªè¯»å–çš„å­—ç¬¦åœ°å€ã€‚å¯ä»¥ä½¿ç”¨&lt;code>std::streambuf::gptr()&lt;/code>æ¥è·å–&lt;/li>
&lt;li>end get pointer &lt;br>
è¾“å…¥å“¨å…µæŒ‡é’ˆï¼Œæ‰¹å·å‘å†…éƒ¨æ•°ç»„æœ€åä¸€ä¸ªå†åé¢ä¸€ä¸ª(one-past-the-last-element)çš„åœ°å€ã€‚å¯ä»¥ä½¿ç”¨&lt;code>std::streambuf::egptr()&lt;/code>æ¥è·å–&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://github.com/Wizmann/assets/raw/master/wizmann-pic/16-9-27/33500590.jpg" alt="">&lt;/p>
&lt;p>åŒæ ·ï¼ŒåŸºæŒ‡é’ˆå’Œå“¨å…µæŒ‡é’ˆåœ¨æµç¼“å†²åŒºçš„ç”Ÿå‘½å‘¨æœŸä¸­ä¹Ÿä¸ä¼šæ”¹å˜ã€‚&lt;/p>
&lt;p>ç”±äºè¾“å…¥ç¼“å†²åŒºè¦æ”¯æŒ&lt;code>putback()&lt;/code>æ“ä½œï¼Œå³å°†è¯»å‡ºçš„å­—ç¬¦é‡æ–°æ”¾å›ç¼“å†²åŒºï¼Œæ‰€ä»¥è¾“å…¥ç¼“å†²åŒºæ¯”è¾“å‡ºç¼“å†²åŒºæ›´å¤æ‚ä¸€ç‚¹ã€‚é€šå¸¸æ¥è¯´ï¼Œ&lt;code>putback()&lt;/code>æ“ä½œæ”¯æŒæ”¾å›ä¸€ä¸ªå­—ç¬¦å³å¯ã€‚&lt;/p>
&lt;p>ä¸€ä¸ª&lt;code>std::streambuf&lt;/code>å¯ä»¥åŒæ—¶æ”¯æŒè¾“å…¥è¾“å‡ºä¸¤ç§æ“ä½œï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸éœ€è¦æˆ‘åˆ†åˆ«å®ç°&lt;code>std::istreambuf&lt;/code>å’Œ&lt;code>std::ostreambuf&lt;/code>ã€‚&lt;code>std::fstream&lt;/code>æ˜¯ä¸€ä¸ªè‰¯å¥½çš„ä¾‹å­ã€‚ä½†æ˜¯ï¼Œå®ç°ä¸€ä¸ªå…¨åŠŸèƒ½çš„ç¼“å†²åŒºç›¸å¯¹æ›´å¤æ‚ä¸€äº›ï¼Œæ‰€ä»¥æˆ‘å°±ä¸è¶Ÿæµ‘æ°´å•¦~ ï¼šï¼‰&lt;/p>
&lt;p>åŒæ—¶ï¼Œæµç¼“å†²åŒºä¹Ÿå¯ä»¥æ”¯æŒå®½å­—ç¬¦(wide character)ã€‚&lt;code>std::streambuf&lt;/code>æ˜¯&lt;code>std::basic_streambuf&amp;lt;char&amp;gt;&lt;/code>çš„åˆ«åï¼Œå¦‚æœä½ éœ€è¦å®½å­—ç¬¦æµç¼“å†²åŒºï¼Œå¯ä»¥ä½¿ç”¨&lt;code>std::basic_streambuf&amp;lt;wchar_t&amp;gt;&lt;/code>ã€‚&lt;/p>
&lt;h3 id="ä¾‹1æ–‡ä»¶ç¼“å†²åŒº--ä¸cä»£ç é›†æˆ">ä¾‹1ï¼šæ–‡ä»¶ç¼“å†²åŒº â€”â€” ä¸Cä»£ç é›†æˆ &lt;a href="#%e4%be%8b1%e6%96%87%e4%bb%b6%e7%bc%93%e5%86%b2%e5%8c%ba--%e4%b8%8ec%e4%bb%a3%e7%a0%81%e9%9b%86%e6%88%90" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;p>å‡è®¾æˆ‘ä»¬éœ€è¦è°ƒç”¨ä¸€ä¸ªå†å²æ‚ ä¹…çš„åº“ï¼Œä¸€ä¸ªæ–‡ä»¶æ“ä½œå‡½æ•°ä¼šè¿”å›ç»™ä¸€ä¸ª&lt;code>FILE*&lt;/code>æŒ‡é’ˆï¼Œä½†æ˜¯æˆ‘ä»¬æƒ³ç”¨C++çš„æµæ¥å£æ¥è¯»å†™æ•°æ®ã€‚æˆ‘ä»¬å…ˆä»è¯»æ–‡ä»¶å¼€å§‹ï¼Œç”¨&lt;code>std::istream&lt;/code>åŒ…è£…&lt;code>FILE*&lt;/code>çš„è¯»æ“ä½œã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;streambuf&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;vector&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;cstdlib&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;cstdio&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">FILE_buffer&lt;/span> &lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#66d9ef">public&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>streambuf
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">public&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">explicit&lt;/span> FILE_buffer(FILE &lt;span style="color:#f92672">*&lt;/span>fptr, std&lt;span style="color:#f92672">::&lt;/span>size_t buff_sz &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">256&lt;/span>, std&lt;span style="color:#f92672">::&lt;/span>size_t put_back &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">8&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">private&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// overrides base class underflow()
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> int_type underflow();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// copy ctor and assignment not implemented;
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75715e">// copying not allowed
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> FILE_buffer(&lt;span style="color:#66d9ef">const&lt;/span> FILE_buffer &lt;span style="color:#f92672">&amp;amp;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> FILE_buffer &lt;span style="color:#f92672">&amp;amp;&lt;/span>&lt;span style="color:#66d9ef">operator&lt;/span>&lt;span style="color:#f92672">=&lt;/span> (&lt;span style="color:#66d9ef">const&lt;/span> FILE_buffer &lt;span style="color:#f92672">&amp;amp;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">private&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> FILE &lt;span style="color:#f92672">*&lt;/span>fptr_;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">const&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>size_t put_back_;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> std&lt;span style="color:#f92672">::&lt;/span>vector&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">char&lt;/span>&lt;span style="color:#f92672">&amp;gt;&lt;/span> buffer_;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>};
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç”±äºåŠŸèƒ½ç®€å•ï¼Œæˆ‘ä»¬åªéœ€è¦å®ç°æ„é€ å‡½æ•°ä»¥åŠ&lt;code>underflow&lt;/code>æ¥å£å°±å¯ä»¥å®ç°æˆ‘ä»¬çš„åŠŸèƒ½ã€‚&lt;/p>
&lt;p>æ„é€ å‡½æ•°æŒ‡å®šäº†è¯»å–æ–‡ä»¶çš„&lt;code>FILE*&lt;/code>æŒ‡é’ˆï¼Œä»¥åŠå†…éƒ¨ç¼“å†²æ•°ç»„çš„å¤§å°ã€‚æ•°ç»„å¤§å°ç”±ä¸¤ä¸ªå‚æ•°å†³å®šï¼š&lt;/p>
&lt;ul>
&lt;li>put-back area size&lt;/li>
&lt;li>buffer size&lt;/li>
&lt;/ul>
&lt;p>æˆ‘ä»¬ä½¿ç”¨&lt;code>std::vector&amp;lt;char&amp;gt;&lt;/code>åšä¸ºç¼“å†²åŒºåŸŸã€‚&lt;code>put_back_&lt;/code>å˜é‡ç”¨äºå­˜å‚¨&amp;quot;put-back&amp;quot;åŒºåŸŸçš„å¤§å°ã€‚&lt;/p>
&lt;p>ä»¥ä¸‹æ˜¯æ„é€ å‡½æ•°çš„å®ç°ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">using&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>size_t;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>FILE_buffer&lt;span style="color:#f92672">::&lt;/span>FILE_buffer(FILE &lt;span style="color:#f92672">*&lt;/span>fptr, size_t buff_sz, size_t put_back) &lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> fptr_(fptr),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> put_back_(std&lt;span style="color:#f92672">::&lt;/span>max(put_back, size_t(&lt;span style="color:#ae81ff">1&lt;/span>))),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> buffer_(std&lt;span style="color:#f92672">::&lt;/span>max(buff_sz, put_back_) &lt;span style="color:#f92672">+&lt;/span> put_back_)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span>end &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#f92672">&amp;amp;&lt;/span>buffer_.front() &lt;span style="color:#f92672">+&lt;/span> buffer_.size();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> setg(end, end, end);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>åœ¨åˆå§‹åŒ–åˆ—è¡¨ä¸­ï¼Œæˆ‘ä»¬å°†ç¼“å†²åŒºçš„å¸¸é‡è¿›è¡Œèµ‹å€¼ã€‚ä¹‹åä½¿ç”¨&lt;code>std::streambuf::setg()&lt;/code>æ¥åˆå§‹åŒ–è¾“å‡ºç¼“å†²åŒºã€‚&lt;/p>
&lt;p>&lt;code>setg()&lt;/code>çš„ä¸‰ä¸ªå‚æ•°åˆ†åˆ«ä»£è¡¨&lt;code>eback()&lt;/code>ï¼Œ&lt;code>gptr()&lt;/code>ï¼Œ&lt;code>egptr()&lt;/code>ä¸‰ä¸ªå†…éƒ¨æŒ‡é’ˆçš„å€¼ã€‚ä¸€å¼€å§‹ï¼Œæˆ‘ä»¬å°†å®ƒä»¬éƒ½æŒ‡å‘åŒä¸€ä¸ªåœ°å€ã€‚è¡¨æ˜bufferæ˜¯ç©ºçš„ï¼Œåœ¨ä¸‹ä¸€æ¬¡è¯»å–æ—¶ï¼Œä¼šé‡æ–°å¡«å……ç¼“å†²åŒºã€‚&lt;/p>
&lt;p>&lt;code>underflow()&lt;/code>ä¼šè¿”å›æ•°æ®æºä¸­å½“å‰çš„å­—ç¬¦ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œä¼šè¿”å›bufferä¸­çš„ä¸‹ä¸€ä¸ªå¯ç”¨å­—ç¬¦ã€‚ç„¶åå½“bufferä¸ºç©ºæ—¶ï¼Œ&lt;code>underflow()&lt;/code>åº”è¯¥é‡æ–°å¡«å……ç¼“å†²åŒºæ•°ç»„ï¼Œåœ¨æœ¬ä¾‹ä¸­ï¼Œå³ä»&lt;code>FILE*&lt;/code>ä¸­è¯»å–å­—ç¬¦ã€‚å½“ç¼“å†²åŒºé‡å¡«åï¼Œæˆ‘ä»¬éœ€è¦å†æ¬¡è°ƒç”¨&lt;code>setg()&lt;/code>æ›´æ–°æµç¼“å†²åŒºçš„çŠ¶æ€ã€‚&lt;/p>
&lt;p>å½“æ•°æ®æºä¸­çš„æ•°æ®è¯»å®Œ(depleted)åï¼Œ&lt;code>underflow()&lt;/code>ä¼šè¿”å›ä¸€ä¸ª&lt;code>traits_type::eof()&lt;/code>ã€‚è¿™é‡Œè¦æ³¨æ„ï¼Œ&lt;code>underflow()&lt;/code>çš„è¿”å›å€¼æ˜¯&lt;code>int_type&lt;/code>ï¼Œè¿™ä¸ªå€¼è¶³å¤Ÿè£…ä¸‹&lt;code>eof()&lt;/code>ï¼ŒåŒæ—¶ä¹Ÿè¶³å¤Ÿè£…ä¸‹ä»»ä½•çš„å­—ç¬¦ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>std&lt;span style="color:#f92672">::&lt;/span>streambuf&lt;span style="color:#f92672">::&lt;/span>int_type FILE_buffer&lt;span style="color:#f92672">::&lt;/span>underflow()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (gptr() &lt;span style="color:#f92672">&amp;lt;&lt;/span> egptr()) &lt;span style="color:#75715e">// buffer not exhausted
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">return&lt;/span> traits_type&lt;span style="color:#f92672">::&lt;/span>to_int_type(&lt;span style="color:#f92672">*&lt;/span>gptr());
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span>base &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#f92672">&amp;amp;&lt;/span>buffer_.front();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span>start &lt;span style="color:#f92672">=&lt;/span> base;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (eback() &lt;span style="color:#f92672">==&lt;/span> base) &lt;span style="color:#75715e">// true when this isn&amp;#39;t the first fill
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// Make arrangements for putback characters
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>memmove(base, egptr() &lt;span style="color:#f92672">-&lt;/span> put_back_, put_back_);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> start &lt;span style="color:#f92672">+=&lt;/span> put_back_;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// start is now the start of the buffer, proper.
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75715e">// Read from fptr_ in to the provided buffer
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> size_t n &lt;span style="color:#f92672">=&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>fread(start, &lt;span style="color:#ae81ff">1&lt;/span>, buffer_.size() &lt;span style="color:#f92672">-&lt;/span> (start &lt;span style="color:#f92672">-&lt;/span> base), fptr_);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (n &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> traits_type&lt;span style="color:#f92672">::&lt;/span>eof();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// Set buffer pointers
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> setg(base, start, start &lt;span style="color:#f92672">+&lt;/span> n);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> traits_type&lt;span style="color:#f92672">::&lt;/span>to_int_type(&lt;span style="color:#f92672">*&lt;/span>gptr());
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å‡½æ•°çš„ç¬¬ä¸€è¡Œï¼Œé¦–å…ˆåˆ¤æ–­bufferæ˜¯å¦è€—å°½ã€‚å¦‚æœå¦ï¼Œåˆ™è¿”å›å½“å‰å­—ç¬¦ï¼Œå³&lt;code>*gptr()&lt;/code>ã€‚å¦‚æœæ˜¯ï¼Œåˆ™è¿›è¡Œé‡å¡«(re-fill)æ“ä½œã€‚&lt;/p>
&lt;p>å›æƒ³ä¸€ä¸‹æˆ‘ä»¬åœ¨æ„é€ å‡½æ•°ä¸­çš„å®ç°ï¼Œä¸‰ä¸ªçŠ¶æ€æŒ‡é’ˆå…¨éƒ½æŒ‡å‘ç¼“å†²åŒºçš„æœ«å°¾ã€‚å¦‚æœæˆ‘ä»¬è°ƒç”¨&lt;code>underflow()&lt;/code>æ—¶ï¼Œå‘ç°çŠ¶æ€æŒ‡é’ˆå¹¶éå¦‚æ­¤ï¼Œåˆ™è¯´æ˜ç¼“å†²åŒºå·²ç»è¢«å¡«å……äº†è‡³å°‘ä¸€æ¬¡ã€‚&lt;/p>
&lt;p>ç°åœ¨æˆ‘ä»¬è€ƒè™‘é‡å¡«æ“ä½œï¼Œæˆ‘ä»¬&lt;code>memmove&lt;/code>æœ€å&lt;code>put_back_&lt;/code>ä¸ªå­—ç¬¦åˆ°bufferçš„æœ«å°¾ï¼Œç”¨åš&amp;quot;put-back area&amp;quot;ã€‚ï¼ˆæˆ‘ä»¬ä¸ç”¨&lt;code>memcopy&lt;/code>å› ä¸ºæˆ‘ä»¬çš„bufferæ¯”è¾ƒå°ï¼Œ`memmove()çš„æ•ˆç‡ä¼šæ›´é«˜ä¸€äº›ï¼‰&lt;/p>
&lt;blockquote>
&lt;p>è¯‘æ³¨ï¼šå®é™…ä¸Šï¼Œ&lt;code>memcopy&lt;/code>ä¸&lt;code>memmove&lt;/code>å„æœ‰æ‰€é•¿ã€‚&lt;code>memcopy&lt;/code>ä¸éœ€è¦åˆ¤æ–­å†…å­˜overlapçš„æƒ…å†µï¼Œå³å¦‚æœæºåŒºé—´ä¸ç›®æ ‡åŒºé—´æœ‰é‡å ï¼Œé‚£ä¹ˆå¾—åˆ°çš„ç»“æœä¼šæ˜¯é”™çš„ã€‚è€Œ&lt;code>memmove&lt;/code>ç”±äºæ˜¯ç§»åŠ¨è¯­ä¹‰ï¼Œæ‰€ä»¥åœ¨ç§»åŠ¨æ­¥é•¿è¾ƒå°æ—¶ï¼Œå¯ä»¥åªæ“ä½œcacheã€‚æ‰€ä»¥äºŒè€…å„æœ‰æ‰€é•¿ï¼Œè¦æ ¹æ®å…·ä½“æƒ…å†µåˆ¤æ–­ä¼˜åŠ£ã€‚Stackoverflowä¸Šæœ‰æ›´è¯¦ç»†çš„&lt;a href="http://stackoverflow.com/questions/28623895/why-is-memmove-faster-than-memcpy">è®¨è®º&lt;/a>&lt;/p>&lt;/blockquote>
&lt;p>æˆ‘ä»¬å¤„ç†å®Œ&amp;quot;put-back area&amp;quot;ä¹‹åï¼Œå°±å¯ä»¥ä½¿ç”¨&lt;code>fread()&lt;/code>å‡½æ•°æ¥é‡å¡«ç¼“å†²åŒºäº†ã€‚å¦‚æœè¯»ä¸åˆ°æ•°æ®ï¼Œåˆ™æ„å‘³ç€æ–‡ä»¶å·²ç»è¯»åˆ°äº†ç»“å°¾ï¼ˆå½“ç„¶è¿™æ˜¯ä¸€ç§ç®€åŒ–æƒ…å†µï¼Œä½†åœ¨ç°å®ä¸­99.9%çš„è¯»å–å¤±è´¥éƒ½æ˜¯å› ä¸ºæ–‡ä»¶ç»“æŸï¼‰ã€‚&lt;/p>
&lt;p>åœ¨&lt;code>fread()&lt;/code>æˆåŠŸè¯»å–æ•°æ®ä¹‹åï¼Œæˆ‘ä»¬é€šçŸ¥streambufæ›´æ–°å†…éƒ¨çš„ä¸‰ä¸ªçŠ¶æ€æŒ‡é’ˆã€‚ä¹‹åè¿”å›bufferå½“å‰çš„æŒ‡é’ˆã€‚&lt;/p>
&lt;p>è¿™å°±æ˜¯æˆ‘ä»¬çš„æµç¼“å†²åŒºçš„åŸºæœ¬å®ç°ï¼Œå¸Œæœ›è¿™å¹¶ä¸æ˜¯å¤ªéš¾ã€‚å½“ç„¶æˆ‘ä»¬è¿˜å¯ä»¥æ·»åŠ æ›´å¤šçš„åŠŸèƒ½ã€‚ç‰¹åˆ«çš„æ˜¯æˆ‘ä»¬å¯ä»¥åœ¨ç¼“å†²åŒºé‡Œé¢è¿›è¡ŒæŸ¥æ‰¾ã€‚å¦‚æœä½ æƒ³å®ç°å®ƒçš„è¯ï¼Œå¯ä»¥è¯•è¯•é‡å†™&lt;code>std::streambuf::seekoff()&lt;/code>å’Œ&lt;code>std::streambuf::seekpos&lt;/code>è™šæˆå‘˜å‡½æ•°ã€‚&lt;/p>
&lt;p>æˆ‘ä»¬ä¹Ÿå¯ä»¥å®ç°å†™ç¼“å†²åŒºã€‚ä¸è¿‡ï¼Œåœ¨ä½ ä»¬è¯»å®Œç¬¬ä¸‰ä¸ªä¾‹å­ä¹‹åï¼Œä½ ä»¬å°±å¯ä»¥è½»æ¾æ„‰å¿«çš„å®ç°è‡ªå·±çš„ç‰ˆæœ¬äº†ï¼Œä¸éª—ä½ ã€‚&lt;/p>
&lt;h3 id="ä¾‹2è¯»å–å†…å­˜ä¸­çš„æ•°ç»„">ä¾‹2ï¼šè¯»å–å†…å­˜ä¸­çš„æ•°ç»„ &lt;a href="#%e4%be%8b2%e8%af%bb%e5%8f%96%e5%86%85%e5%ad%98%e4%b8%ad%e7%9a%84%e6%95%b0%e7%bb%84" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;p>æœ¬ä¾‹ä¸­ï¼Œæˆ‘ä»¬è¦ä½¿ç”¨&lt;code>std::istream&lt;/code>åŒ…è£…å†…å­˜ä¸­çš„ä¸€ä¸ªåªè¯»æ•°ç»„ï¼Œå¹¶ä¸”æ ¼å¼åŒ–çš„è¿›è¡Œè¯»å…¥ã€‚è¿™ä¸ªä¾‹å­å’Œä¸Šä¸€ä¸ªä¾‹å­æœ‰ä¸€ç‚¹ä¸åŒçš„æ˜¯ï¼Œæˆ‘ä»¬å¹¶ä¸éœ€è¦ä¸€ä¸ªçœŸæ­£çš„ç¼“å†²æ•°ç»„ï¼Œä»æºæ•°ç»„ä¸€æ¬¡æ€§è¯»å–å°±å¥½äº†ã€‚&lt;/p>
&lt;p>æƒ³è±¡ä¸­çš„å®ç°æ˜¯è¿™ä¸ªæ ·å¼å„¿çš„ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">char_array_buffer&lt;/span> &lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#66d9ef">public&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>streambuf
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">public&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> char_array_buffer(&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span>begin, &lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span>end)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> setg(begin, begin, end);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> int_type &lt;span style="color:#a6e22e">underflow&lt;/span>()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> gptr() &lt;span style="color:#f92672">==&lt;/span> egptr() &lt;span style="color:#f92672">?&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> traits_type&lt;span style="color:#f92672">::&lt;/span>eof() &lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> traits_type&lt;span style="color:#f92672">::&lt;/span>to_int_type(&lt;span style="color:#f92672">*&lt;/span>gptr());
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>};
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä½†æ˜¯ï¼Œè¿™å¹¶æ²¡æœ‰ä»€ä¹ˆåµç”¨ã€‚å› ä¸º&lt;code>setg()&lt;/code>å‡½æ•°åªæ¥å—éå¸¸é‡(non-const)æŒ‡é’ˆå‚æ•°ã€‚è¿™æ˜¾è€Œæ˜“è§ï¼Œå¦‚æœä¸€ä¸ªç¼“å†²åŒºä¸å¯å†™ï¼Œæˆ‘ä»¬å°±ä¸èƒ½æä¾›&amp;quot;put-back&amp;quot;åŠŸèƒ½ã€‚æ‰€ä»¥æˆ‘ä»¬è¦åŠ¨ä¸€åŠ¨æ‰‹è„šï¼Œé‡æ–°å®ç°ä¸€ä¸‹è¿™ä¸ªç±»ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;streambuf&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">char_array_buffer&lt;/span> &lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#66d9ef">public&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>streambuf
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">public&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> char_array_buffer(&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span>begin, &lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span>end);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">explicit&lt;/span> &lt;span style="color:#a6e22e">char_array_buffer&lt;/span>(&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span>str);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">private&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> int_type underflow();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> int_type &lt;span style="color:#a6e22e">uflow&lt;/span>();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> int_type &lt;span style="color:#a6e22e">pbackfail&lt;/span>(int_type ch);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> std&lt;span style="color:#f92672">::&lt;/span>streamsize showmanyc();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// copy ctor and assignment not implemented;
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75715e">// copying not allowed
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> char_array_buffer(&lt;span style="color:#66d9ef">const&lt;/span> char_array_buffer &lt;span style="color:#f92672">&amp;amp;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> char_array_buffer &lt;span style="color:#f92672">&amp;amp;&lt;/span>&lt;span style="color:#66d9ef">operator&lt;/span>&lt;span style="color:#f92672">=&lt;/span> (&lt;span style="color:#66d9ef">const&lt;/span> char_array_buffer &lt;span style="color:#f92672">&amp;amp;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">private&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span> &lt;span style="color:#66d9ef">const&lt;/span> begin_;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span> &lt;span style="color:#66d9ef">const&lt;/span> end_;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span> current_;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>};
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>åœ¨è¿™ä¸ªç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬é‡å†™äº†å‡ ä¸ªç§æœ‰å‡½æ•°ï¼Œè¿™äº›å‡½æ•°éƒ½æ˜¯ä»&lt;code>std::streambuf&lt;/code>ç»§æ‰¿è€Œæ¥ã€‚&lt;/p>
&lt;p>ç¬¬ä¸€ä¸ªæ„é€ å‡½æ•°éœ€è¦ç”¨æˆ·æŒ‡å®šèµ·æ­¢æŒ‡é’ˆï¼Œè€Œç¬¬äºŒä¸ªæ„é€ å‡½æ•°åªéœ€è¦æŒ‡å®šèµ·å§‹æŒ‡é’ˆï¼Œä¹‹åæˆ‘ä»¬ä¼šè°ƒç”¨&lt;code>std::strlen()&lt;/code>æ¥åˆ¤æ–­å­—ç¬¦ä¸²çš„å¤§å°ã€‚&lt;/p>
&lt;p>æˆ‘ä»¬ä½¿ç”¨&lt;code>uflow()&lt;/code>, &lt;code>pbackfail()&lt;/code>å’Œ&lt;code>showmanyc()&lt;/code>æ¥ç»´æŠ¤ç¼“å†²åŒºå†…éƒ¨çš„çŠ¶æ€ï¼Œè€Œä¸æ˜¯è°ƒç”¨&lt;code>setg()&lt;/code>ï¼Œå› ä¸ºbufferå¹¶ä¸å¯å†™ã€‚&lt;/p>
&lt;p>åœ¨è¿™ä¸ªç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬è¦æ‰‹åŠ¨ç»´æŠ¤&lt;code>eback&lt;/code>, &lt;code>gptr&lt;/code>, &lt;code>egptr&lt;/code>ä¸‰ä¸ªæŒ‡é’ˆã€‚åœ¨æ„é€ å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬å°†å¯¹å…¶è¿›è¡Œèµ‹å€¼ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;#34;char_array_buffer.hpp&amp;#34;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;functional&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;cassert&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;cstring&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>char_array_buffer&lt;span style="color:#f92672">::&lt;/span>char_array_buffer(&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span>begin, &lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span>end) &lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> begin_(begin),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> end_(end),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> current_(begin_)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> assert(std&lt;span style="color:#f92672">::&lt;/span>less_equal&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&amp;gt;&lt;/span>()(begin_, end_));
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>char_array_buffer&lt;span style="color:#f92672">::&lt;/span>char_array_buffer(&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span>str) &lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> begin_(str),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> end_(begin_ &lt;span style="color:#f92672">+&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>strlen(str)),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> current_(begin_)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¹‹å‰æˆ‘ä»¬ä½¿ç”¨&lt;code>underflow()&lt;/code>æ¥è·å–å½“å‰å­—ç¬¦ï¼Œä½†è¿™æ¬¡æˆ‘ä»¬éœ€è¦ä½¿ç”¨&lt;code>uflow()&lt;/code>ã€‚å› ä¸º&lt;code>uflow()&lt;/code>éœ€è¦åŒæ—¶æ‰§è¡Œä¸¤æ­¥æ“ä½œï¼Œä¸€æ˜¯è·å–å½“å‰å­—ç¬¦ï¼ŒäºŒæ˜¯è®©&lt;code>gptr()&lt;/code>å‰è¿›ä¸€æ­¥ã€‚ä½†æ˜¯åˆå› ä¸ºç¼“å†²åŒºç”±æˆ‘ä»¬æ‰‹åŠ¨ç®¡ç†ï¼Œ&lt;code>std::streambuf&lt;/code>å¹¶ä¸èƒ½æ­£ç¡®çš„æ‰§è¡Œç®¡ç†æ“ä½œã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦é‡å†™&lt;code>uflow()&lt;/code>è€Œä¸æ˜¯&lt;code>underflow()&lt;/code>ã€‚&lt;/p>
&lt;pre tabindex="0">&lt;code>char_array_buffer::int_type char_array_buffer::uflow()
{
if (current_ == end_)
return traits_type::eof();
return traits_type::to_int_type(*current_++);
}
&lt;/code>&lt;/pre>&lt;p>ä¸‹ä¸€æ­¥æˆ‘ä»¬è¿˜è¦å®ç°&lt;code>pbackfail()&lt;/code>ã€‚å½“æˆ‘ä»¬è°ƒç”¨&lt;code>std::istream::unget()&lt;/code>æˆ–&lt;code>std::istream::putback(ch)&lt;/code>æ—¶ï¼Œæˆ‘ä»¬ä¼šæŠŠå·²ç»è¯»å‡ºçš„æ•°æ®å†™å›æ•°ç»„ä¸­ã€‚ä½†æ˜¯ç”±äºæ•°ç»„æ˜¯åªè¯»çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬åªèƒ½æ¨¡æ‹Ÿè¿™ç§æ“ä½œã€‚&lt;/p>
&lt;p>åœ¨é»˜è®¤çš„å®ç°ä¸­&lt;code>pbackfail()&lt;/code>åªä¼šè¿”å›&lt;code>traits_type::eof()&lt;/code>ï¼Œè€Œåœ¨æˆ‘ä»¬çš„ç‰ˆæœ¬ä¸­ï¼Œå¦‚æœå†™å›æˆåŠŸï¼Œå°†ä¼šè¿”å›å†™å›çš„å­—ç¬¦ï¼Œä¸æˆåŠŸè¿”å›eofã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>char_array_buffer&lt;span style="color:#f92672">::&lt;/span>int_type char_array_buffer&lt;span style="color:#f92672">::&lt;/span>pbackfail(int_type ch)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (current_ &lt;span style="color:#f92672">==&lt;/span> begin_ &lt;span style="color:#f92672">||&lt;/span> (ch &lt;span style="color:#f92672">!=&lt;/span> traits_type&lt;span style="color:#f92672">::&lt;/span>eof() &lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span> ch &lt;span style="color:#f92672">!=&lt;/span> current_[&lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>]))
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> traits_type&lt;span style="color:#f92672">::&lt;/span>eof();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> traits_type&lt;span style="color:#f92672">::&lt;/span>to_int_type(&lt;span style="color:#f92672">*--&lt;/span>current_);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>åœ¨&lt;code>FILE_buffer&lt;/code>ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥è€ƒè™‘é‡å†™&lt;code>pbackfail()&lt;/code>ï¼Œæ¥æä¾›åå‘æŸ¥æ‰¾ä»¥åŠï¼ˆç”¨å‰é¢çš„æ•°æ®ï¼‰é‡å¡«bufferçš„åŠŸèƒ½ã€‚&lt;/p>
&lt;p>æœ€åä¸€ä¸ªé‡å†™çš„å‡½æ•°æ˜¯&lt;code>showmanyc()&lt;/code>ï¼Œè¿™ä¸ªå‡½æ•°è¢«&lt;code>std::streambuf::in_avail()&lt;/code>è°ƒç”¨ï¼Œä»¥åˆ¤æ–­å½“å‰æœ‰å¤šå°‘ä¸ªå­—ç¬¦å¯ä»¥è¿”å›ã€‚ç”±äºæˆ‘ä»¬æ¥ç®¡äº†çŠ¶æ€æŒ‡é’ˆï¼Œæ‰€ä»¥è¿™ä¸ªå‡½æ•°ä¹Ÿè¦æˆ‘ä»¬è‡ªå·±æ¥å®ç°å•Šã€‚ï¼ˆè¯‘è€…ï¼šä¸ºä»€ä¹ˆè¦ç»™è‡ªå·±æ‰¾éº»çƒ¦ã€‚ã€‚ã€‚ï¼‰&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>std&lt;span style="color:#f92672">::&lt;/span>streamsize char_array_buffer&lt;span style="color:#f92672">::&lt;/span>showmanyc()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> assert(std&lt;span style="color:#f92672">::&lt;/span>less_equal&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&amp;gt;&lt;/span>()(current_, end_));
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> end_ &lt;span style="color:#f92672">-&lt;/span> current_;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç”±æ­¤å¯è§ï¼Œæœ¬ä¾‹ä¸­çš„bufferæ¯”å‰é¢çš„è¦å¤æ‚ä¸€ç‚¹ç‚¹ã€‚è¿™æ˜¯å› ä¸ºæˆ‘ä»¬æ¥ç®¡äº†çŠ¶æ€ç»´æŠ¤çš„å·¥ä½œã€‚è¿™ä½¿å¾—æˆ‘ä»¬æ›´å¥½çš„ç†è§£äº†&lt;code>std::streambuf&lt;/code>å†…éƒ¨æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚&lt;/p>
&lt;h3 id="ä¾‹3å¥é¦–å˜å¤§å†™çš„ç¼“å†²åŒº">ä¾‹3ï¼šå¥é¦–å˜å¤§å†™çš„ç¼“å†²åŒº &lt;a href="#%e4%be%8b3%e5%8f%a5%e9%a6%96%e5%8f%98%e5%a4%a7%e5%86%99%e7%9a%84%e7%bc%93%e5%86%b2%e5%8c%ba" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;p>æœ¬ä¾‹ä¸­æˆ‘ä»¬å°†è¦å®ç°ä¸€ä¸ªå°†å¥é¦–å­—ç¬¦å˜å¤§å†™çš„bufferã€‚å½“ç„¶æˆ‘ä»¬åªè€ƒè™‘æœ€åŸºæœ¬çš„æƒ…å†µï¼Œç§»æ¤åˆ°ä¸åŒçš„åŒºåŸŸå’Œè¯­è¨€ï¼Œå…¶å®æ˜¯å¾ˆçç¢çš„äº‹æƒ…ã€‚ï¼ˆè¯‘è€…ï¼šæ–‡å­—ç¼–ç å‘çš„äº²å¦ˆéƒ½ä¸è®¤äº†ï¼‰&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;streambuf&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;iosfwd&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;cstdlib&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;vector&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">caps_buffer&lt;/span> &lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#66d9ef">public&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>streambuf
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">public&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">explicit&lt;/span> caps_buffer(std&lt;span style="color:#f92672">::&lt;/span>ostream &lt;span style="color:#f92672">&amp;amp;&lt;/span>sink, std&lt;span style="color:#f92672">::&lt;/span>size_t buff_sz &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">256&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">protected&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">bool&lt;/span> do_caps_and_flush();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">private&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> int_type overflow(int_type ch);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">int&lt;/span> &lt;span style="color:#a6e22e">sync&lt;/span>();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// copy ctor and assignment not implemented;
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75715e">// copying not allowed
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> caps_buffer(&lt;span style="color:#66d9ef">const&lt;/span> caps_buffer &lt;span style="color:#f92672">&amp;amp;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> caps_buffer &lt;span style="color:#f92672">&amp;amp;&lt;/span>&lt;span style="color:#66d9ef">operator&lt;/span>&lt;span style="color:#f92672">=&lt;/span> (&lt;span style="color:#66d9ef">const&lt;/span> caps_buffer &lt;span style="color:#f92672">&amp;amp;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">private&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">bool&lt;/span> cap_next_;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> std&lt;span style="color:#f92672">::&lt;/span>ostream &lt;span style="color:#f92672">&amp;amp;&lt;/span>sink_;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> std&lt;span style="color:#f92672">::&lt;/span>vector&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">char&lt;/span>&lt;span style="color:#f92672">&amp;gt;&lt;/span> buffer_;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>};
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™é‡Œæˆ‘ä»¬éœ€è¦é‡å†™&lt;code>overflow()&lt;/code>å’Œ&lt;code>sync()&lt;/code>å‡½æ•°ã€‚&lt;code>overflow()&lt;/code>åœ¨è¾“å…¥ç¼“å†²åŒºæ»¡çš„æ—¶å€™è¢«è°ƒç”¨ï¼Œå¹¶ä¸”åœ¨æˆåŠŸæ—¶è¿”å›ä»»æ„éeofçš„å€¼ã€‚&lt;/p>
&lt;p>&lt;code>sync()&lt;/code>çš„ä½œç”¨æ˜¯æŠŠå½“å‰çš„bufferå†™å…¥ç›®æ ‡ï¼Œå³ä½¿å½“å‰bufferå¹¶æœªå¡«æ»¡ã€‚&lt;code>std::flush()&lt;/code>ä¼šè°ƒç”¨&lt;code>sync()&lt;/code>å‡½æ•°ï¼Œå½“å¤±è´¥æ—¶è¿”å›-1ã€‚&lt;/p>
&lt;p>æˆ‘ä»¬ç¼–å†™ä¸€ä¸ªè¾…åŠ©å‡½æ•°&lt;code>do_caps_and_flush()&lt;/code>ï¼Œç”¨æ¥å°†å°å†™å˜å¤§å†™ï¼Œå¹¶å†™å…¥&lt;code>sink_&lt;/code>è¾“å‡ºæµã€‚æˆ‘ä»¬å†å£°æ˜ä¸€ä¸ªå“¨å…µå˜é‡&lt;code>cap_next_&lt;/code>æ¥æ ‡è¯†ä¸‹ä¸€ä¸ªå­—ç¬¦æ˜¯å¦éœ€è¦å°å†™å˜å¤§å†™ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;#34;caps_buffer.hpp&amp;#34;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;cctype&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;ostream&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;functional&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;cassert&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>caps_buffer&lt;span style="color:#f92672">::&lt;/span>caps_buffer(std&lt;span style="color:#f92672">::&lt;/span>ostream &lt;span style="color:#f92672">&amp;amp;&lt;/span>sink, std&lt;span style="color:#f92672">::&lt;/span>size_t buff_sz) &lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> cap_next_(true),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> sink_(sink),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> buffer_(buff_sz &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> sink_.clear();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span>base &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#f92672">&amp;amp;&lt;/span>buffer_.front();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> setp(base, base &lt;span style="color:#f92672">+&lt;/span> buffer_.size() &lt;span style="color:#f92672">-&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>); &lt;span style="color:#75715e">// -1 to make overflow() easier
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>buffer_&lt;/code>çš„æœ€å°å¯èƒ½å¤§å°æ˜¯1ï¼ŒåŒæ—¶æˆ‘ä»¬ä¹Ÿåªéœ€è¦ç»´æŠ¤ä¸¤ä¸ªæŒ‡é’ˆï¼Œå› ä¸ºè¿™é‡Œä¸éœ€è¦åƒè¾“å…¥ç¼“å†²åŒºä¸€æ ·çš„ç»´æŠ¤&amp;quot;put-back area&amp;quot;ã€‚&lt;/p>
&lt;p>æˆ‘ä»¬æŠŠ&lt;code>buffer_&lt;/code>çš„å¤§å°è®¾æˆ&lt;code>buff_sz + 1&lt;/code>ï¼Œè¿™æ ·æ˜¯ä¸ºäº†&lt;code>overflow()&lt;/code>è¢«è°ƒç”¨æ—¶ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªé¢å¤–çš„ç©ºé—´å­˜å‚¨å½“å‰çš„å­—ç¬¦ã€‚æœ€åå°†ç¼“å†²åŒºæ•°ç»„å’Œæœ€åä¸€ä¸ªå­—ç¬¦ä¸€èµ·åˆ·æ–°åˆ°&lt;code>ostream&lt;/code>ä¸­ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>caps_buffer&lt;span style="color:#f92672">::&lt;/span>int_type caps_buffer&lt;span style="color:#f92672">::&lt;/span>overflow(int_type ch)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (sink_ &lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span> ch &lt;span style="color:#f92672">!=&lt;/span> traits_type&lt;span style="color:#f92672">::&lt;/span>eof())
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> assert(std&lt;span style="color:#f92672">::&lt;/span>less_equal&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&amp;gt;&lt;/span>()(pptr(), epptr()));
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">*&lt;/span>pptr() &lt;span style="color:#f92672">=&lt;/span> ch;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> pbump(&lt;span style="color:#ae81ff">1&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (do_caps_and_flush())
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> ch;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> traits_type&lt;span style="color:#f92672">::&lt;/span>eof();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç¬¬ä¸€æ­¥æ˜¯æŠŠchå†™å…¥&lt;code>buffer_&lt;/code>ï¼Œå¹¶ä¸”ä½¿ç”¨&lt;code>pbump(1)&lt;/code>å°†&lt;code>pptr()&lt;/code>å‘å‰ç§»ä¸€ä½ã€‚ä¹‹åè°ƒç”¨&lt;code>do_caps_and_flush()&lt;/code>åšä¸€äº›è„æ´»ï¼Œä¹‹åè¿”å›ä¸€ä¸ªå­—ç¬¦å£°æ˜è°ƒç”¨æˆåŠŸã€‚&lt;/p>
&lt;p>&lt;code>sync()&lt;/code>çš„å®ç°ä¹Ÿéå¸¸ç®€å•:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">int&lt;/span> caps_buffer&lt;span style="color:#f92672">::&lt;/span>sync()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#a6e22e">do_caps_and_flush&lt;/span>() &lt;span style="color:#f92672">?&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span> &lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æˆ‘ä»¬å†çœ‹ä¸€çœ‹&lt;code>do_caps_and_flush()&lt;/code>å‡½æ•°&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">bool&lt;/span> caps_buffer&lt;span style="color:#f92672">::&lt;/span>do_caps_and_flush()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">for&lt;/span> (&lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span>p &lt;span style="color:#f92672">=&lt;/span> pbase(), &lt;span style="color:#f92672">*&lt;/span>e &lt;span style="color:#f92672">=&lt;/span> pptr(); p &lt;span style="color:#f92672">!=&lt;/span> e; &lt;span style="color:#f92672">++&lt;/span>p)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (&lt;span style="color:#f92672">*&lt;/span>p &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#e6db74">&amp;#39;.&amp;#39;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> cap_next_ &lt;span style="color:#f92672">=&lt;/span> true;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">else&lt;/span> &lt;span style="color:#a6e22e">if&lt;/span> (std&lt;span style="color:#f92672">::&lt;/span>isalpha(&lt;span style="color:#f92672">*&lt;/span>p))
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (cap_next_)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">*&lt;/span>p &lt;span style="color:#f92672">=&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>toupper(&lt;span style="color:#f92672">*&lt;/span>p);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> cap_next_ &lt;span style="color:#f92672">=&lt;/span> false;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> std&lt;span style="color:#f92672">::&lt;/span>ptrdiff_t n &lt;span style="color:#f92672">=&lt;/span> pptr() &lt;span style="color:#f92672">-&lt;/span> pbase();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> pbump(&lt;span style="color:#f92672">-&lt;/span>n);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> sink_.write(pbase(), n);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯¹äºæœ¬ä¾‹æ¥è¯´ï¼Œå†…éƒ¨çš„ç¼“å†²åŒºå¹¶éå¿…è¦ï¼Œæˆ‘ä»¬å¯ä»¥ä¸€ä¸ªå­—ç¬¦ä¸€ä¸ªå­—ç¬¦æŠŠæ•°æ®å‘åˆ°&lt;code>sink&lt;/code>ä¸­ã€‚ä½†æ˜¯æˆ‘çš„è§‚ç‚¹æ˜¯ä¸€ä¸ªå†…éƒ¨bufferä»æœ‰å…¶ç”¨å¤„ã€‚&lt;/p>
&lt;h3 id="ä»‹ç»-boost-iostreams-åº“">ä»‹ç» Boost IOStreams åº“ &lt;a href="#%e4%bb%8b%e7%bb%8d-boost-iostreams-%e5%ba%93" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;p>å¦‚æœä½ æ˜¯æµç¼“å†²åŒºçš„æ–°æ‰‹ï¼Œå¸Œæœ›ä½ å·²ç»å¯¹å®ƒæœ‰ä¸€ç‚¹ç‚¹äº†è§£äº†ã€‚æœ¬æ–‡ä¸­çš„ä¾‹å­éƒ½éå¸¸åŸºç¡€ï¼Œä½†æ˜¯ä½ å¯ä»¥ç”¨å®ƒä»¬åšæ›´å¤šæœ‰æ„æ€çš„äº‹æƒ…ã€‚ä½†æ˜¯å½“æˆ‘å®ç°æ›´å¤æ‚çš„æµç¼“å†²åŒºæ—¶ï¼Œé—®é¢˜çš„å¤æ‚åº¦å´ä¸Šå‡çš„å¾ˆå¿«ã€‚è¿™æ—¶æˆ‘å‘ç°äº†&lt;code>Boost IOStreams&lt;/code>åº“ï¼Œå®ƒä¸ºæ›´å¤æ‚çš„ç¼“å†²åŒºå’Œæµæä¾›äº†å¿…è¦çš„æ¡†æ¶æ”¯æŒã€‚&lt;/p>
&lt;p>å®ƒå…è®¸ä½ è§£è€¦æ•°æ®æºï¼Œæ•°æ®è¾“å‡ºï¼Œè¿‡æ»¤å™¨ä»¥åŠå…¶å®ƒä¸€äº›æ¦‚å¿µã€‚åœ¨æˆ‘ä»¬çš„æœ€åä¸€ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ç¡¬ç¼–ç æ•°æ®è¾“å‡ºåˆ°&lt;code>std::ostream&lt;/code>ä¸­ã€‚å¦‚æœæˆ‘ä»¬è¦è¾“å‡ºåˆ°ä¸€ä¸ªæ²¡æœ‰æµæ¥å£çš„ç±»å‘¢ï¼Ÿ&lt;code>Boost IOStreams&lt;/code>åº“æä¾›äº†æ›´å¤šçš„çµæ´»æ€§ï¼Œå°†ä¸€å¨ç´§è€¦åˆçš„ä»£ç åˆ†è§£æˆç‹¬ç«‹çš„æŠ½è±¡æ¦‚å¿µã€‚&lt;/p>
&lt;h3 id="æ‰©å±•é˜…è¯»">æ‰©å±•é˜…è¯» &lt;a href="#%e6%89%a9%e5%b1%95%e9%98%85%e8%af%bb" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;ul>
&lt;li>The C++ Standard Library by Nicolai M. Josuttis&lt;/li>
&lt;li>The C++ Standard, BS ISO/IEC 14882:2003 (Second Edition)&lt;/li>
&lt;li>&lt;a href="http://www.dinkumware.com/manuals/">Dinkum Compleat Reference online&lt;/a>&lt;/li>
&lt;/ul></description></item></channel></rss>