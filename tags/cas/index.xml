<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>CAS on Maerlyn's Rainbow</title><link>https://wizmann.top/tags/cas/</link><description>Recent content in CAS on Maerlyn's Rainbow</description><generator>Hugo -- gohugo.io</generator><language>zh-CN</language><lastBuildDate>Sun, 14 Apr 2024 00:00:00 +0000</lastBuildDate><atom:link href="https://wizmann.top/tags/cas/index.xml" rel="self" type="application/rss+xml"/><item><title>å®ç°ä¸€ä¸ªæ— é”æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆç»­ä¸å‹˜è¯¯ï¼‰</title><link>https://wizmann.top/posts/implement-non-blocking-queue-2/</link><pubDate>Sun, 14 Apr 2024 00:00:00 +0000</pubDate><guid>https://wizmann.top/posts/implement-non-blocking-queue-2/</guid><description>&lt;ul>
&lt;li>æœ¬æ–‡å†…å®¹ä¸»è¦å‚è€ƒè‡ª&lt;a href="https://people.cs.pitt.edu/~jacklange/teaching/cs2510-f17/implementing_lock_free.pdf">Implementing Lock-Free Queue&lt;/a>ä¸€æ–‡ï¼ˆä»¥ä¸‹ç®€ç§°â€œåŸè®ºæ–‡â€ï¼‰&lt;/li>
&lt;li>æ˜¯å¯¹&lt;a href="https://wizmann.top/implement-non-blocking-queue.html">å®ç°ä¸€ä¸ªæ— é”æ¶ˆæ¯é˜Ÿåˆ—&lt;/a>ä¸€æ–‡çš„å†…å®¹è¿›è¡Œè¡¥å……&lt;/li>
&lt;li>
&lt;h2 id="tldr">TLï¼›DR &lt;a href="#tldr" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;ul>
&lt;li>å°½ç®¡&lt;a href="https://wizmann.top/implement-non-blocking-queue.html">å®ç°ä¸€ä¸ªæ— é”æ¶ˆæ¯é˜Ÿåˆ—&lt;/a>ä¸€æ–‡ä¸­çš„å®ç°æ˜¯æ­£ç¡®çš„ï¼Œä½†æ˜¯å¿½ç•¥äº†â€œéé˜»å¡æ€§â€
&lt;ul>
&lt;li>ä¾‹å¦‚ï¼Œå½“ä»»ä¸€æ’å…¥æ“ä½œè¢«é˜»å¡ï¼Œåˆ™å…¶å®ƒæ’å…¥æ“ä½œå‡ä¼šé™·å…¥å¿™ç­‰å¾…&lt;/li>
&lt;li>æ­¤å®ç°ä¸&lt;a href="https://dl.acm.org/doi/pdf/10.5555/110382.110466">A simple and correct shared-queue algorithm using Compare-and-Swap&lt;/a>çš„å®ç°åŸºæœ¬ä¸€è‡´&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>å¯¹äºä¸€ä¸ªæ”¯æŒå¹¶å‘çš„æ•°æ®ç»“æ„ï¼Œç†åº”åŒæ—¶å…·å¤‡éé˜»å¡æ€§å’Œæ— ç­‰å¾…æ€§
&lt;ul>
&lt;li>éé˜»å¡æ€§ï¼ˆnon-blockingï¼‰ï¼šæ— è®ºæ˜¯ç”±äºCPUè°ƒåº¦æˆ–å…¶ä»–å¤–éƒ¨å› ç´ ï¼Œæ•°æ®ç»“æ„çš„æ“ä½œä¸èƒ½è¢«ä¸­æ–­æˆ–å»¶è¿Ÿ&lt;/li>
&lt;li>æ— ç­‰å¾…æ€§ï¼ˆwait-free)ï¼šä¿è¯æ²¡æœ‰ä»»ä½•çº¿ç¨‹ä¼šé­å—é¥¥é¥¿çŠ¶æ€&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>å‰ä¸€ç¯‡åšæ–‡å¯¹å…¶å®ƒå®ç°çš„è´¨ç–‘ï¼Œä¸»è¦åœ¨äºABAé—®é¢˜ï¼Œä½†è¿™ä¸ªé—®é¢˜æ˜¯Compare&amp;amp;Swapæ‰€ç‰¹æœ‰çš„ï¼Œéœ€è¦ç‰¹å®šçš„å®ç°æ¥è§„é¿&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;h2 id="ç†è®ºåŸºç¡€">ç†è®ºåŸºç¡€ &lt;a href="#%e7%90%86%e8%ae%ba%e5%9f%ba%e7%a1%80" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;ul>
&lt;li>æˆ‘ä»¬çš„ç›®æ ‡æ˜¯å®ç°ä¸€ä¸ªæ”¯æŒå¹¶å‘enqueue/dequeçš„é˜Ÿåˆ—&lt;/li>
&lt;li>å¯¹äºè¿™æ ·çš„æ•°æ®ç»“æ„ï¼Œæœ‰ä¸¤ä¸ªé‡è¦çš„ç‰¹æ€§
&lt;ul>
&lt;li>éé˜»å¡æ€§ï¼ˆnon-blockingï¼‰
&lt;ul>
&lt;li>å¯¹äºæ¯ä¸€ä¸ªæ‰§è¡Œçº¿ç¨‹ï¼Œæ‰€æœ‰çš„æ“ä½œå°†ä¼šåœ¨æœ‰é™çš„æ¬¡æ•°å†…å®Œæˆ&lt;/li>
&lt;li>æ— è®ºæœ¬çº¿ç¨‹æˆ–å…¶å®ƒçº¿ç¨‹åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­å› å…¶å®ƒåŸå› ï¼ˆå¦‚CPUè°ƒåº¦ï¼‰æ‰§è¡Œè¿‡ç¼“ï¼Œæˆ–è€…è¢«ä¸­æ–­&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>æ— ç­‰å¾…æ€§ï¼ˆwait-free)
&lt;ul>
&lt;li>æ²¡æœ‰çº¿ç¨‹ä¼šé¥¥é¥¿&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>åŸºäºé”çš„æ•°æ®ç»“æ„ä¸ç¬¦åˆä¸Šè¿°ç‰¹æ€§ï¼Œå› ä¸ºæŒæœ‰é”çš„çº¿ç¨‹å¯èƒ½ä¼šæ— é™æœŸåœ°é˜»å¡æ‰€æœ‰æ“ä½œ&lt;/li>
&lt;li>â€œçº¿æ€§ä¸€è‡´æ€§â€(Linearizability) â€”â€” æ›´å¼ºçš„æ­£ç¡®æ€§
&lt;ul>
&lt;li>éå¹¶å‘æ“ä½œåº”å½“æŒ‰ç…§å®ƒä»¬çš„é€»è¾‘é¡ºåºæ‰§è¡Œï¼Œä»¥ä¿è¯æ“ä½œçš„æ­£ç¡®æ€§ï¼Œè€Œå¹¶å‘æ“ä½œåˆ™å¯ä»¥æŒ‰ä»»æ„é¡ºåºè¿›è¡Œ&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&amp;ldquo;Fetch&amp;amp;Add&amp;rdquo; ä¸ &amp;ldquo;Compare&amp;amp;Swap&amp;rdquo;
&lt;ul>
&lt;li>å¸¸ç”¨çš„åŸå­æ“ä½œï¼Œè¿™é‡Œä¸åšèµ˜è¿°&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;h2 id="åŸºäºé“¾è¡¨çš„æ— é”é˜Ÿåˆ—å®ç°">åŸºäºé“¾è¡¨çš„æ— é”é˜Ÿåˆ—å®ç° &lt;a href="#%e5%9f%ba%e4%ba%8e%e9%93%be%e8%a1%a8%e7%9a%84%e6%97%a0%e9%94%81%e9%98%9f%e5%88%97%e5%ae%9e%e7%8e%b0" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;ul>
&lt;li>ç•¥ï¼Œå‚è€ƒåŸè®ºæ–‡ä¸&lt;a href="https://coolshell.cn/articles/8239.html">æ— é”é˜Ÿåˆ—çš„å®ç°&lt;/a>ä¸€æ–‡&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;h2 id="åŸºäºæ•°ç»„çš„æ— é”é˜Ÿåˆ—å®ç°">åŸºäºæ•°ç»„çš„æ— é”é˜Ÿåˆ—å®ç° &lt;a href="#%e5%9f%ba%e4%ba%8e%e6%95%b0%e7%bb%84%e7%9a%84%e6%97%a0%e9%94%81%e9%98%9f%e5%88%97%e5%ae%9e%e7%8e%b0" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;ul>
&lt;li>ç•¥ï¼Œå‚è€ƒåŸè®ºæ–‡ä¸&lt;a href="https://coolshell.cn/articles/8239.html">æ— é”é˜Ÿåˆ—çš„å®ç°&lt;/a>ä¸€æ–‡&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;h2 id="abaé—®é¢˜">ABAé—®é¢˜ &lt;a href="#aba%e9%97%ae%e9%a2%98" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;ul>
&lt;li>Compare&amp;amp;Swapæ“ä½œç¡®ä¿äº†å€¼ä¿®æ”¹çš„åŸå­æ€§ã€‚æŒ‡é’ˆä½œä¸ºå€¼çš„ä¸€ç§ï¼Œä»£è¡¨ç€æŸä¸ªå†…å­˜åœ°å€ï¼Œä½†Compare&amp;amp;Swapå¯¹æŒ‡é’ˆçš„æ“ä½œæ— æ³•ä¿è¯å…¶æŒ‡å‘çš„å†…å­˜å†…å®¹ä¸è¢«ä¿®æ”¹&lt;/li>
&lt;li>è€ƒè™‘åˆ°å¯èƒ½é‡Šæ”¾æ—§å†…å­˜åå†ç”³è¯·æ–°å†…å­˜ï¼Œè¿™ä¸¤å—å†…å­˜è™½é€»è¾‘ä¸åŒå´å¯èƒ½æ‹¥æœ‰åŒä¸€åœ°å€ï¼Œè¿™å¯¹Compare&amp;amp;Swapæ“ä½œé€ æˆäº†å›°æ‰°&lt;/li>
&lt;li>è§£å†³æ–¹æ¡ˆæ˜¯ä¸ºæŒ‡é’ˆåŠ å…¥å¼•ç”¨è®¡æ•°ï¼ˆref countï¼‰ï¼Œä»¥ç¡®ä¿å†…å­˜åœ¨å¯è®¿é—®æ—¶ä¸ä¼šè¢«é‡Šæ”¾æˆ–é‡ç”¨&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;h2 id="æ€§èƒ½å¯¹æ¯”">æ€§èƒ½å¯¹æ¯” &lt;a href="#%e6%80%a7%e8%83%bd%e5%af%b9%e6%af%94" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;ul>
&lt;li>ä¸Šé¢æˆ‘ä»¬å·²ç»æåˆ°ï¼Œ&lt;a href="https://dl.acm.org/doi/pdf/10.5555/110382.110466">A simple and correct shared-queue algorithm using Compare-and-Swap&lt;/a>ä¸€æ–‡ä¸­çš„æ–¹æ³•ç¼ºå°‘äº†â€œéé˜»å¡æ€§â€ï¼Œï¼Œä½†å…¶æ€§èƒ½ä¸åŸè®ºæ–‡ä¸­çš„å®ç°ååˆ†æ¥è¿‘&lt;/li>
&lt;li>ä½†æ˜¯åœ¨åŸç†ä¸Šï¼Œâ€œéé˜»å¡æ€§â€å®ç°å¯ä»¥é¿å…æ„å¤–çš„çº¿ç¨‹åœæ­¢æˆ–å»¶è¿Ÿ&lt;/li>
&lt;li>ç–‘é—®ï¼šæ˜¯å¦ä¼šåœ¨P99çº§åˆ«çš„Latencyä¸Šæ‰ä¼šä½“ç°å‡ºæ˜æ˜¾çš„å·®å¼‚ï¼Ÿ&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;h2 id="å‚è€ƒé“¾æ¥">å‚è€ƒé“¾æ¥ &lt;a href="#%e5%8f%82%e8%80%83%e9%93%be%e6%8e%a5" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;ul>
&lt;li>&lt;a href="https://people.cs.pitt.edu/~jacklange/teaching/cs2510-f17/implementing_lock_free.pdf">Implementing Lock-Free Queue&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://dl.acm.org/doi/pdf/10.5555/110382.110466">A simple and correct shared-queue algorithm using Compare-and-Swap&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://cs.nyu.edu/~wies/teaching/cso-fa19/class27_concurrency.pdf">Concurrency â€“ Correctness of Concurrent Objects&lt;/a>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;h2 id="åç»­">åç»­ &lt;a href="#%e5%90%8e%e7%bb%ad" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;ul>
&lt;li>&lt;a href="https://www.cs.rochester.edu/~scott/papers/1996_PODC_queues.pdf">Simple, Fast, and Practical Non-Blocking and Blocking Concurrent Queue Algorithms&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://zhuanlan.zhihu.com/p/690872647">C++ å•ç”Ÿäº§è€…&amp;amp;å•æ¶ˆè´¹è€… æ— é”é˜Ÿåˆ—&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.youtube.com/watch?v=K3P_Lmq6pw0&amp;amp;ab_channel=CppCon">Single Producer Single Consumer Lock-free FIFO From the Ground Up - Charles Frasch - CppCon 2023&lt;/a>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;div class="alert alert-info" role="alert">æœ¬æ–‡å¤§ï¼ˆåˆ’æ‰ï¼‰éƒ¨åˆ†å†…å®¹ç”±ChatGPT4ç”Ÿæˆ&lt;/div></description></item><item><title>åœ¨SPIN/Promelaä¸­æ¨¡æ‹ŸCASï¼ˆCompare-and-Swapï¼‰</title><link>https://wizmann.top/posts/simple-cas-model-in-spin-promela/</link><pubDate>Fri, 15 Dec 2023 00:00:00 +0000</pubDate><guid>https://wizmann.top/posts/simple-cas-model-in-spin-promela/</guid><description>&lt;p>CASï¼ˆCompare-And-Swapï¼‰æ˜¯ä¸€ç§åœ¨å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­å¸¸ç”¨çš„æ•°æ®åŒæ­¥æ–¹æ³•ï¼Œå®ƒé€šè¿‡æ¯”è¾ƒå’Œäº¤æ¢æ“ä½œæ¥ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ã€‚ç„¶è€Œï¼Œåœ¨SPIN/Promelaä¸­æ²¡æœ‰ç›´æ¥çš„CASå¯¹åº”å®ç°ã€‚&lt;/p>
&lt;p>è®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­ã€‚è€ƒè™‘ä»¥ä¸‹Promelaä»£ç ï¼Œå®ƒæ¨¡æ‹Ÿäº†ä¸¤ä¸ªå·¥ä½œçº¿ç¨‹ worker0 å’Œ worker1 ä½¿ç”¨CASæœºåˆ¶äº¤æ›¿ä¿®æ”¹å…±äº«å˜é‡ x çš„åœºæ™¯ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-promela" data-lang="promela">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">int&lt;/span> x &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">bool&lt;/span> running &lt;span style="color:#f92672">=&lt;/span> false;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">proctype&lt;/span> worker0() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>end:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">do&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">::&lt;/span> (true) &lt;span style="color:#f92672">-&amp;gt;&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">atomic&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">::&lt;/span> (x &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>) &lt;span style="color:#f92672">-&amp;gt;&lt;/span> { x &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>; }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">::&lt;/span> else &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">skip&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">od&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">proctype&lt;/span> worker1() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>end:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">do&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">::&lt;/span> (true) &lt;span style="color:#f92672">-&amp;gt;&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">atomic&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">::&lt;/span> (x &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>) &lt;span style="color:#f92672">-&amp;gt;&lt;/span> { x &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>; }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">::&lt;/span> else &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">skip&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">od&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">init&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">atomic&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">run&lt;/span> worker0()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">run&lt;/span> worker1();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> running &lt;span style="color:#f92672">=&lt;/span> true;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">ltl&lt;/span> not_always_0 { &lt;span style="color:#f92672">[]&lt;/span>(running &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#f92672">&amp;lt;&amp;gt;&lt;/span>(x &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>)); };
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä»ç›´è§‚ä¸Šç†è§£ï¼ŒLTLè¡¨è¾¾å¼ not_always_0 åº”è¯¥è¢«æ»¡è¶³ï¼Œå› ä¸º worker0 å’Œ worker1 åº”è¯¥ä¼šäº¤æ›¿æ‰§è¡Œï¼Œä»è€Œåœ¨æœªæ¥çš„æŸä¸ªæ—¶åˆ»ä½¿ x == 1 æˆç«‹ã€‚&lt;/p>
&lt;p>ç„¶è€Œï¼Œåœ¨SPINçš„å®é™…è¿è¡Œä¸­ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šé‡åˆ°ä¸€ä¸ªé—®é¢˜ï¼šå¦‚æœ worker0 åœ¨ä»»ä½•ç‚¹åœæ­¢æ‰§è¡Œï¼Œworker1 å°±ä¼šé™·å…¥æ­»å¾ªç¯ï¼Œè¿™ç§æƒ…å†µè¢«ç§°ä¸ºâ€œé¥¥é¥¿â€ï¼ˆstarvationï¼‰ã€‚&lt;/p>
&lt;p>ä¸ºäº†è§£å†³è¿™ä¸€é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨SPINä¸­ä½¿ç”¨ -f é€‰é¡¹æ¥ä¿è¯å¼±å…¬å¹³æ€§ï¼ˆweak fairnessï¼‰ã€‚å¼±å…¬å¹³æ€§æ„å‘³ç€ï¼Œå¦‚æœä¸€ä¸ªå¯æ‰§è¡Œçš„åŠ¨ä½œåœ¨æ— é™é•¿çš„æ‰§è¡Œåºåˆ—ä¸­æœ‰æ— é™æ¬¡çš„æ‰§è¡Œæœºä¼šï¼Œé‚£ä¹ˆå®ƒæœ€ç»ˆå¿…é¡»å¾—åˆ°æ‰§è¡Œã€‚è¿™ç¡®ä¿äº†å³ä½¿ä¸€ä¸ªåŠ¨ä½œæš‚æ—¶æ— æ³•æ‰§è¡Œï¼Œå®ƒæœ€ç»ˆä¹Ÿä¼šæœ‰æœºä¼šæ‰§è¡Œã€‚&lt;/p>
&lt;p>åœ¨è¿™ä¸ªæ¨¡å‹ä¸­ï¼Œåº”ç”¨å¼±å…¬å¹³æ€§å¯ä»¥ç¡®ä¿ worker0 å’Œ worker1 æœ€ç»ˆéƒ½æœ‰æœºä¼šäº¤æ›¿æ‰§è¡Œã€‚è¿™ä½¿å¾—æ¨¡å‹èƒ½å¤Ÿæ¨¡æ‹Ÿç°å®çš„å¤šçº¿ç¨‹CPUæ‰§è¡Œåœºæ™¯ï¼Œä»è€ŒéªŒè¯äº†LTLå±æ€§ not_always_0 çš„æ­£ç¡®æ€§ã€‚&lt;/p>
&lt;ul>
&lt;li>è¯¦ç»†å‘½ä»¤&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>spin -a simple-cas.pml
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>./pan -m10000 -a -f
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>å‚è€ƒé“¾æ¥
&lt;ul>
&lt;li>&lt;a href="https://spinroot.com/spin/Man/Quick.html">Concise Promela Reference &amp;gt; Executing a Promela system&lt;/a>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;div class="alert alert-info" role="alert">æœ¬æ–‡å¤§ï¼ˆåˆ’æ‰ï¼‰éƒ¨åˆ†å†…å®¹ç”±ChatGPT4ç”Ÿæˆ&lt;/div></description></item><item><title>å®ç°ä¸€ä¸ªæ— é”æ¶ˆæ¯é˜Ÿåˆ—</title><link>https://wizmann.top/posts/implement-non-blocking-queue/</link><pubDate>Wed, 02 May 2018 00:39:00 +0000</pubDate><guid>https://wizmann.top/posts/implement-non-blocking-queue/</guid><description>&lt;blockquote>
&lt;p>240414æ›´æ–°ï¼šåç»­è¡¥å……äº†ä¸€ç¯‡å‹˜è¯¯æ–‡ç« ï¼Œè§&lt;a href="https://wizmann.top/implement-non-blocking-queue-2.html">è¿™é‡Œ&lt;/a>&lt;/p>&lt;/blockquote>
&lt;h2 id="ç›®æ ‡">ç›®æ ‡ &lt;a href="#%e7%9b%ae%e6%a0%87" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>å®ç°ä¸€ä¸ªå¤šè¯»å¤šå†™çš„æ— é”æ¶ˆæ¯é˜Ÿåˆ—ã€‚&lt;/p>
&lt;h2 id="cmpxchg---æ¯”è¾ƒå¹¶æ›¿æ¢">cmpxchg - æ¯”è¾ƒå¹¶æ›¿æ¢ &lt;a href="#cmpxchg---%e6%af%94%e8%be%83%e5%b9%b6%e6%9b%bf%e6%8d%a2" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>æ¯”è¾ƒå¹¶æ›¿æ¢ï¼ˆcompare-and-swap, CASï¼‰æ˜¯ä¸€ä¸ªç”¨äºå¤šçº¿ç¨‹åŒæ­¥çš„åŸå­æ“ä½œã€‚&lt;/p>
&lt;p>å…¶å·¥ä½œæµç¨‹æ˜¯ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-python" data-lang="python">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">def&lt;/span> &lt;span style="color:#a6e22e">cmpxchg&lt;/span>(val, oldval, newval):
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> val &lt;span style="color:#f92672">==&lt;/span> oldval:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> val &lt;span style="color:#f92672">=&lt;/span> newval
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#66d9ef">True&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#66d9ef">False&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¹Ÿå°±æ˜¯è¯´ï¼Œåªæœ‰å½“&lt;code>val&lt;/code>ç­‰äº&lt;code>oldval&lt;/code>æ—¶ï¼Œæˆ‘ä»¬æ‰ä¼šå°†&lt;code>val&lt;/code>çš„å€¼æ›¿æ¢æˆ&lt;code>newval&lt;/code>ã€‚åœ¨å¤šçº¿ç¨‹çš„åœºæ™¯ä¸‹ï¼Œcmpxchgç”¨æ¥ä¿è¯å¤šçº¿ç¨‹å†™çš„åŸå­æ€§ã€‚&lt;/p>
&lt;p>ä¾‹å¦‚ï¼Œçº¿ç¨‹1å’Œçº¿ç¨‹2éƒ½è¦å†™å…¥&lt;code>val&lt;/code>å˜é‡ï¼Œä½†æ˜¯æˆ‘ä»¬éœ€è¦ä¿è¯åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½å†™æˆåŠŸã€‚ä½¿ç”¨cmpxchgï¼Œèƒ½ä¿è¯åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½æˆåŠŸçš„å°†&lt;code>val&lt;/code>å˜é‡æ›¿æ¢æˆæ–°å€¼ï¼Œå†™å¤±è´¥çš„çº¿ç¨‹ä¼šå¾—åˆ°&lt;code>False&lt;/code>çš„è¿”å›å€¼ã€‚&lt;/p>
&lt;h2 id="access_once---æ¶ˆé™¤ä¼˜åŒ–æ­§ä¹‰">ACCESS_ONCE - æ¶ˆé™¤ä¼˜åŒ–æ­§ä¹‰ &lt;a href="#access_once---%e6%b6%88%e9%99%a4%e4%bc%98%e5%8c%96%e6%ad%a7%e4%b9%89" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#define ACCESS_ONCE(x) (*(volatile typeof(x) *)&amp;amp;(x))ï¼›
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>ACCESS_ONCE&lt;/code>çš„ä½œç”¨æ˜¯å°†ä¸€ä¸ªæŒ‡é’ˆè½¬åŒ–æˆ&lt;code>volatile&lt;/code>æŒ‡é’ˆï¼Œä½¿å¾—è¯»å–æ“ä½œâ€œçœŸçš„â€å»è¯»å–æŒ‡é’ˆçš„å€¼è€Œä¸è¢«ç¼–è¯‘å™¨ä¼˜åŒ–æ‰ã€‚&lt;/p>
&lt;h2 id="å®ç°">å®ç° &lt;a href="#%e5%ae%9e%e7%8e%b0" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;h3 id="åŸå­æ“ä½œä¸nullable">åŸå­æ“ä½œä¸Nullable &lt;a href="#%e5%8e%9f%e5%ad%90%e6%93%8d%e4%bd%9c%e4%b8%8enullable" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;p>è¯´åˆ°å¤šçº¿ç¨‹ï¼Œæˆ‘ä»¬å°±ä¸èƒ½ä¸è°ˆåŸå­æ“ä½œã€‚å¯¹äºä¸€ä¸ªé˜Ÿåˆ—æ¥è¯´ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å…¶ä¸­å­˜å‚¨ä»»æ„å¤æ‚çš„æ•°æ®ç»“æ„ï¼Œä½†æ˜¯è¿™äº›æ•°æ®ç»“æ„å¤§éƒ¨åˆ†éƒ½ä¸æ”¯æŒåŸå­æ“ä½œã€‚&lt;/p>
&lt;p>åŒæ ·ï¼Œæˆ‘ä»¬ä¹Ÿæ²¡æœ‰ä¸€ç§æœ‰æ•ˆçš„æ‰‹æ®µæ¥æ ‡è¯†ä¸€ä¸ªå€¼æ˜¯â€œä¸å­˜åœ¨çš„â€ã€‚æ˜¯çš„ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªå·±å®ç°ä¸€ä¸ª&lt;code>Nullable&amp;lt;T&amp;gt;&lt;/code>çš„æ¨¡æ¿ï¼Œä½†æ˜¯å¸¦æ¥çš„é¢å¤–æˆæœ¬å°±æ˜¯å¯¹äºä»»æ„&lt;code>Nullable&amp;lt;T&amp;gt;&lt;/code>çš„èµ‹å€¼éƒ½è¦ç»è¿‡ä¸¤æ­¥ä»¥ä¸Šçš„ä¸­é—´æ­¥éª¤ï¼Œè¿™ç®€ç›´å°±æ˜¯ç«æ€bugäº§ç”Ÿçš„æ¸©åºŠã€‚&lt;/p>
&lt;p>ä¸è¿‡ï¼Œåœ¨C++ä¸­è‡ªå¸¦ç€ä¸€ä¸ªæœ‰ç€&amp;quot;Nullable&amp;quot;è¯­æ„çš„æ•°æ®ç»“æ„ â€”â€” æŒ‡é’ˆã€‚å½“æŒ‡é’ˆä¸ºNULLæ—¶ï¼Œæ„å‘³ç€å€¼æ˜¯ä¸å­˜åœ¨çš„ï¼Œè€ŒæŒ‡é’ˆä¸ä¸ºNULLæ—¶ï¼Œå®ƒä»£è¡¨ç€å®ƒæ‰€æŒ‡å‘çš„å€¼ã€‚æ›´é‡è¦çš„æ˜¯ï¼ŒæŒ‡é’ˆçš„èµ‹å€¼ã€è¯»å–ã€æ‹·è´éƒ½æ˜¯åŸå­çš„ï¼Œè¿™ç»™æˆ‘ä»¬çš„ä»£ç å®ç°æä¾›äº†éå¸¸å¤§çš„ä¾¿åˆ©ã€‚&lt;/p>
&lt;h3 id="æ•°æ®ç»“æ„">æ•°æ®ç»“æ„ &lt;a href="#%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;p>&lt;img src="https://github.com/Wizmann/assets/raw/master/wizmann-pic/18-5-1/40471673.jpg" alt="">&lt;/p>
&lt;p>æˆ‘ä»¬ä½¿ç”¨å•é“¾è¡¨åšä¸ºåŸºç¡€æ•°æ®ç»“æ„ï¼Œé“¾è¡¨çš„å¤´ä»£è¡¨ç€é˜Ÿåˆ—çš„å¤´ï¼Œé“¾è¡¨çš„å°¾å¯¹åº”ç€é˜Ÿåˆ—çš„å°¾ã€‚è¿™æ ·æ·»åŠ æ•°æ®æ—¶ï¼Œæˆ‘ä»¬åœ¨TAILèŠ‚ç‚¹å¤„å†™å…¥ï¼Œå¼¹å‡ºæ•°æ®æ—¶ä»HEADèŠ‚ç‚¹å¤„å¼¹å‡ºã€‚&lt;/p>
&lt;p>é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œåœ¨å•çº¿ç¨‹ä¸‹ï¼Œç»´æŠ¤å¤´å°¾èŠ‚ç‚¹æ˜¯éå¸¸å®¹æ˜“çš„æ“ä½œã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-python" data-lang="python">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">&amp;#34;&amp;#34;&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">ç»´æŠ¤å¤´èŠ‚ç‚¹
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">&amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>cur &lt;span style="color:#f92672">=&lt;/span> HEAD&lt;span style="color:#f92672">.&lt;/span>next
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>HEAD&lt;span style="color:#f92672">.&lt;/span>next &lt;span style="color:#f92672">=&lt;/span> HEAD&lt;span style="color:#f92672">.&lt;/span>next&lt;span style="color:#f92672">.&lt;/span>next &lt;span style="color:#75715e"># æ“ä½œé“¾è¡¨&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">&amp;#34;&amp;#34;&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">ç»´æŠ¤å°¾èŠ‚ç‚¹
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">&amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>newnode &lt;span style="color:#f92672">=&lt;/span> Node(value)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>TAIL&lt;span style="color:#f92672">.&lt;/span>next &lt;span style="color:#f92672">=&lt;/span> newnode &lt;span style="color:#75715e"># æ“ä½œé“¾è¡¨&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>TAIL &lt;span style="color:#f92672">=&lt;/span> TAIL&lt;span style="color:#f92672">.&lt;/span>next &lt;span style="color:#75715e"># æ“ä½œé“¾è¡¨&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä½†æ˜¯åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œç»´æŠ¤å°¾èŠ‚ç‚¹éœ€è¦å¯¹é“¾è¡¨è¿›è¡Œä¸¤æ¬¡æ“ä½œï¼Œæˆ‘ä»¬å¾ˆéš¾æŠŠå®ƒåšä¸ºåŸå­çš„ã€‚è¿™å¤§æ¦‚æ˜¯å®ç°æ— é”é˜Ÿåˆ—æœ€å¤§çš„éš¾ç‚¹ä¹‹ä¸€ã€‚&lt;/p>
&lt;h3 id="æ¡†æ¶ä»£ç ">æ¡†æ¶ä»£ç  &lt;a href="#%e6%a1%86%e6%9e%b6%e4%bb%a3%e7%a0%81" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;p>æ— é”é˜Ÿåˆ—ä¸­ï¼Œ&lt;code>push&lt;/code>å’Œ&lt;code>pop&lt;/code>ä¸¤ä¸ªå‡½æ•°æ˜¯æ ¸å¿ƒä»£ç ã€‚ä½†æ˜¯æˆ‘ä»¬éœ€è¦å…ˆæŠŠæ¡†æ¶ä»£ç å…ˆæ­å¥½ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">template&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">typename&lt;/span> T&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">NonBlockingQueue&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">public&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> NonBlockingQueue() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> head &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#f92672">&amp;amp;&lt;/span>dummy;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> tail &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> InnerNode();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> dummy.next &lt;span style="color:#f92672">=&lt;/span> tail;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">push&lt;/span>(&lt;span style="color:#66d9ef">const&lt;/span> T&lt;span style="color:#f92672">*&lt;/span> item) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// pass
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">bool&lt;/span> &lt;span style="color:#a6e22e">pop&lt;/span>(T&lt;span style="color:#f92672">*&amp;amp;&lt;/span> item) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// pass
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">private&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">struct&lt;/span> &lt;span style="color:#a6e22e">InnerNode&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> T&lt;span style="color:#f92672">*&lt;/span> value_ptr;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> InnerNode&lt;span style="color:#f92672">*&lt;/span> next;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> };
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">private&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> InnerNode dummy;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> InnerNode&lt;span style="color:#f92672">*&lt;/span> head;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> InnerNode&lt;span style="color:#f92672">*&lt;/span> tail;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>};
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™é‡Œçš„&lt;code>dummy&lt;/code>æ˜¯ä¸€ä¸ªå‡çš„å¤´èŠ‚ç‚¹ï¼Œæ˜¯ä¸ºäº†æ–¹ä¾¿èŠ‚ç‚¹çš„æ’å…¥çš„ï¼Œå¯ä»¥æ›¿æ¢æˆä¸€ä¸ªå¤´èŠ‚ç‚¹æŒ‡é’ˆã€‚&lt;code>tail&lt;/code>æ˜¯å°¾èŠ‚ç‚¹ï¼Œåœ¨æ„é€ å‡½æ•°é‡Œï¼Œæˆ‘ä»¬ä¹Ÿå°†å…¶ç½®ä¸ºä¸€ä¸ªå‡çš„å°¾èŠ‚ç‚¹ï¼Œæ³¨æ„è¿™é‡Œå°¾èŠ‚ç‚¹çš„è®¾è®¡ï¼Œåæ–‡ä¼šå†æ¬¡æåˆ°ã€‚&lt;/p>
&lt;h3 id="å‡ºé˜Ÿæ“ä½œ">å‡ºé˜Ÿæ“ä½œ &lt;a href="#%e5%87%ba%e9%98%9f%e6%93%8d%e4%bd%9c" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;p>æˆ‘ä»¬å…ˆä»æœ€ç®€å•çš„å‡ºé˜Ÿæ“ä½œå¼€å§‹&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">bool&lt;/span> &lt;span style="color:#a6e22e">pop&lt;/span>(T&lt;span style="color:#f92672">*&amp;amp;&lt;/span> item) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> InnerNode&lt;span style="color:#f92672">*&lt;/span> cur &lt;span style="color:#f92672">=&lt;/span> NULL;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">do&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> cur &lt;span style="color:#f92672">=&lt;/span> ACCESS_ONCE(head&lt;span style="color:#f92672">-&amp;gt;&lt;/span>next);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (cur &lt;span style="color:#f92672">==&lt;/span> tail) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> false;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> } &lt;span style="color:#66d9ef">while&lt;/span> (&lt;span style="color:#f92672">!&lt;/span>__sync_bool_compare_and_swap(&lt;span style="color:#f92672">&amp;amp;&lt;/span>(head&lt;span style="color:#f92672">-&amp;gt;&lt;/span>next), cur, cur&lt;span style="color:#f92672">-&amp;gt;&lt;/span>next));
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> item &lt;span style="color:#f92672">=&lt;/span> cur&lt;span style="color:#f92672">-&amp;gt;&lt;/span>value_ptr;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// delete(cur); &amp;lt;- why?
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">return&lt;/span> true;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä»£ç ä¸­çš„&lt;code>__sync_bool_compare_and_swap&lt;/code>å³ä¸Šæ–‡æ‰€è¯´çš„&lt;code>cmpxchg&lt;/code>å‡½æ•°ï¼Œä¿è¯äº†èµ‹å€¼çš„åŸå­æ€§ã€‚&lt;/p>
&lt;p>æ“ä½œè¿‡ç¨‹éå¸¸ç®€å•ï¼Œæˆ‘ä»¬å…ˆæ‰¾åˆ°ä½äºé˜Ÿåˆ—å¤´çš„å€¼ï¼ˆHEADèŠ‚ç‚¹åé¢çš„ç¬¬ä¸€ä¸ªï¼‰ã€‚ç„¶åä½¿ç”¨CASæ“ä½œå°†å…¶æ¢å‡ºé“¾è¡¨ã€‚&lt;/p>
&lt;p>ç”±äºtailèŠ‚ç‚¹æ˜¯å‡çš„å°¾èŠ‚ç‚¹ï¼Œæ‰€ä»¥åœ¨&lt;code>head-&amp;gt;next == tail&lt;/code>æ—¶ï¼Œæˆ‘ä»¬è®¤ä¸ºé˜Ÿåˆ—ä¸ºç©ºï¼Œè¿”å›falseã€‚&lt;/p>
&lt;p>è¿™é‡Œæœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„ï¼Œ&lt;code>cur&lt;/code>æŒ‡é’ˆåœ¨whileå¾ªç¯å¤–çœ‹ä¼¼å·²ç»è„±ç¦»äº†é“¾è¡¨ï¼Œå¯ä»¥æ”¾å¿ƒçš„åˆ é™¤äº†ã€‚ä½†æ˜¯ç”±äºå…¶å®ƒçº¿ç¨‹ä»æœ‰å¯èƒ½æŒæœ‰è¯¥æŒ‡é’ˆï¼Œæ‰€ä»¥æˆ‘ä»¬å¹¶ä¸èƒ½åœ¨è¿™é‡Œå¯¹å®ƒè¿›è¡Œåˆ é™¤æ“ä½œã€‚&lt;/p>
&lt;p>åœ¨å®é™…å·¥ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å°†å…¶æ”¾ç½®äºä¸€ä¸ªå›æ”¶é˜Ÿåˆ—ä¸­ï¼Œå¾…ä¸€å°æ®µæ—¶é—´åï¼ˆå¦‚500msï¼‰ï¼Œæ‰€æœ‰çš„çº¿ç¨‹éƒ½ä¸æŒæœ‰è¯¥æŒ‡é’ˆæ—¶ï¼Œå°±å¯ä»¥å®‰å…¨çš„å°†å…¶å›æ”¶äº†ã€‚è¿™é‡Œç”±äºç¯‡å¹…åŸå› ï¼ˆæ³¨é‡Šï¼šæ‡’ï¼‰ï¼Œå°±ä¸å®ç°äº†ã€‚&lt;/p>
&lt;h3 id="å…¥é˜Ÿæ“ä½œ">å…¥é˜Ÿæ“ä½œ &lt;a href="#%e5%85%a5%e9%98%9f%e6%93%8d%e4%bd%9c" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">push&lt;/span>(&lt;span style="color:#66d9ef">const&lt;/span> T&lt;span style="color:#f92672">*&lt;/span> item) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> assert (item &lt;span style="color:#f92672">!=&lt;/span> NULL);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> InnerNode&lt;span style="color:#f92672">*&lt;/span> cur &lt;span style="color:#f92672">=&lt;/span> NULL;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> InnerNode&lt;span style="color:#f92672">*&lt;/span> newNode &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> InnerNode();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">while&lt;/span> (true) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> cur &lt;span style="color:#f92672">=&lt;/span> ACCESS_ONCE(tail);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (__sync_bool_compare_and_swap(&lt;span style="color:#f92672">&amp;amp;&lt;/span>(cur&lt;span style="color:#f92672">-&amp;gt;&lt;/span>value_ptr), NULL, item)) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> cur&lt;span style="color:#f92672">-&amp;gt;&lt;/span>next &lt;span style="color:#f92672">=&lt;/span> newNode;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> tail &lt;span style="color:#f92672">=&lt;/span> tail&lt;span style="color:#f92672">-&amp;gt;&lt;/span>next;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">break&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™é‡Œçš„&lt;code>push&lt;/code>æ“ä½œæœ‰ä¸€ä¸ªtrickï¼Œæˆ‘ä»¬å°†&lt;code>tail-&amp;gt;value_ptr&lt;/code>åšä¸ºâ€œä¸€æŠŠé”â€ã€‚å½“&lt;code>value_ptr&lt;/code>ä¸ºç©ºæ—¶ï¼ŒtailæŒ‡é’ˆä»£è¡¨ç€ä¸€ä¸ªâ€œå‡å°¾èŠ‚ç‚¹â€ã€‚å½“æˆ‘ä»¬å‘å°¾éƒ¨è¿½åŠ æ•°æ®æ—¶ï¼Œå…ˆå°†æ•°æ®å†™å…¥&lt;code>value_ptr&lt;/code>ï¼Œä»£è¡¨è¿™ä¸ªèŠ‚ç‚¹å·²ç»è¢«â€œå é¢†â€ã€‚ç„¶åå†å‘å®ƒçš„åé¢è¿½åŠ æ–°çš„â€œå‡å°¾èŠ‚ç‚¹â€ï¼Œæœ€åå°†æŒ‡é’ˆç§»åŠ¨è¿‡å»ã€‚&lt;/p>
&lt;p>è¿™æ ·ä¸€æ¥ï¼Œè¿›å…¥&lt;code>if&lt;/code>ä»£ç å—çš„çº¿ç¨‹ä¸€å®šæ˜¯å†™å…¥&lt;code>tail-&amp;gt;value_ptr&lt;/code>æˆåŠŸçš„é‚£ä¸€ä¸ªï¼Œåé¢çš„æŒ‡é’ˆç§»åŠ¨ä¹Ÿæ˜¯å•çº¿ç¨‹çš„äº†ã€‚&lt;/p>
&lt;h2 id="æ„Ÿæ‚Ÿä¸å¯èƒ½çš„æ”¹è¿›">æ„Ÿæ‚Ÿä¸å¯èƒ½çš„æ”¹è¿› &lt;a href="#%e6%84%9f%e6%82%9f%e4%b8%8e%e5%8f%af%e8%83%bd%e7%9a%84%e6%94%b9%e8%bf%9b" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>æœ€è¿‘ç¡®å®å¥½ä¹…ä¸å†™è¿™ä¹ˆåº•å±‚çš„ä»£ç ï¼Œæ‰‹ç”Ÿçš„å‰å®³ï¼Œå¯¹äºå¤šçº¿ç¨‹çŠ¶æ€çš„åˆ†æä¹Ÿä¸æ˜¯å¾ˆçµå…‰ã€‚ç¡®å®éœ€è¦å¤šåŠªåŠ›äº†ã€‚æœ¬æ–‡ä¸­çš„ä»£ç ä¹Ÿè®¸è¿˜æœ‰ä¸€äº›é—®é¢˜ï¼Œæ‰€ä»¥æ¬¢è¿å¤§å®¶æŒ‡æ­£ã€‚&lt;/p>
&lt;p>åœ¨å†™è¿™æ®µä»£ç çš„è¿‡ç¨‹ä¸­ï¼Œæ„Ÿè§‰æœ‰å¦‚ä¸‹éœ€è¦æ³¨æ„çš„åœ°æ–¹ï¼š&lt;/p>
&lt;ul>
&lt;li>ææ„ä¸€å—å†…å­˜æ˜¯å¦æ˜¯å®‰å…¨çš„ï¼Œä¼šä¸ä¼šåˆ«çš„çº¿ç¨‹ä»åœ¨æŒæœ‰è¿™å—å†…å­˜çš„æŒ‡é’ˆ&lt;/li>
&lt;li>ç¼–è¯‘å™¨ä¼šä¸ä¼šç»™æˆ‘ä»¬æ£ä¹±ï¼Œæ¯”å¦‚é‡æ’æŒ‡ä»¤ç­‰&lt;/li>
&lt;li>åˆ©ç”¨CASçš„ç‰¹æ€§ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°ä¸€ä¸ªé”çš„ç»“æ„ï¼Œä½†æ˜¯ä»¥å“ªä¸ªå˜é‡/æŒ‡é’ˆåšä¸ºé”å¯ä»¥è·å¾—æœ€å¥½çš„æ•ˆæœ&lt;/li>
&lt;/ul>
&lt;p>é™¤äº†ç”¨é“¾è¡¨å®ç°é˜Ÿåˆ—ä¹‹å¤–ï¼Œè¿˜å¯ä»¥ä½¿ç”¨ç¯å‹æ•°ç»„ã€‚æ„Ÿè§‰ä¸Šæ¥è¯´æ¯”ä½¿ç”¨é“¾è¡¨æ›´ä¼˜é›…ä¸€ç‚¹ã€‚å…³é”®åœ¨äºç¯å‹æ•°ç»„ä¸­éšå«ç€å‰é©±æŒ‡é’ˆå’Œåç»§èŠ‚ç‚¹çš„ä¿¡æ¯ï¼Œæ‰€ä»¥ä¸éœ€è¦è¿›è¡Œå¤æ‚çš„å†…å­˜ç®¡ç†å·¥ä½œã€‚&lt;/p>
&lt;p>å®Œæ•´å®ç°è¯·å‚è€ƒ&lt;a href="https://paste.ubuntu.com/p/vYD6h5sm9n/">é“¾æ¥&lt;/a>ï¼Œäº²æµ‹åœ¨Ubuntu 16.04ä¸‹ä½¿ç”¨&lt;code>g++ main.cc -lpthread&lt;/code>ç¼–è¯‘è¿è¡ŒæˆåŠŸã€‚ï¼ˆp.s. ä¸è¦åŠ C++11æ ‡ç­¾ï¼Œç¼–ä¸è¿‡çš„ï¼‰&lt;/p>
&lt;h2 id="ç›¸å…³é“¾æ¥">ç›¸å…³é“¾æ¥ &lt;a href="#%e7%9b%b8%e5%85%b3%e9%93%be%e6%8e%a5" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;ul>
&lt;li>&lt;a href="https://coolshell.cn/articles/8239.html">æ— é”é˜Ÿåˆ—çš„å®ç° - é…·å£³&lt;/a>&lt;/li>
&lt;/ul>
&lt;blockquote>
&lt;p>å¼±å¼±æ„Ÿè§‰æ–‡ç« é‡Œè¯´çš„å®ç°æœ‰é—®é¢˜ï¼ˆ240414æ›´æ–°ï¼šå…¶å®æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œè§å‹˜è¯¯æ–‡ç« ï¼‰&lt;/p>&lt;/blockquote>
&lt;ul>
&lt;li>&lt;a href="https://cloud.tencent.com/developer/article/1006241">å…±äº«å†…å­˜æ— é”é˜Ÿåˆ—çš„å®ç°&lt;/a>&lt;/li>
&lt;/ul>
&lt;blockquote>
&lt;p>æŒ‡å‡ºäº†å®ç°ä¸Šé¢å¯èƒ½è¸©åˆ°çš„å‘&lt;/p>&lt;/blockquote>
&lt;ul>
&lt;li>&lt;a href="https://cloud.tencent.com/developer/article/1071029">ä¸€ç§é«˜æ•ˆæ— é”å†…å­˜é˜Ÿåˆ—çš„å®ç°&lt;/a>&lt;/li>
&lt;/ul>
&lt;blockquote>
&lt;p>ç¯å½¢æ•°ç»„çš„å®ç°&lt;/p>&lt;/blockquote></description></item></channel></rss>