<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Thread on Maerlyn's Rainbow</title><link>https://wizmann.top/tags/thread/</link><description>Recent content in Thread on Maerlyn's Rainbow</description><generator>Hugo -- gohugo.io</generator><language>zh-CN</language><lastBuildDate>Mon, 18 Mar 2024 23:21:35 +0000</lastBuildDate><atom:link href="https://wizmann.top/tags/thread/index.xml" rel="self" type="application/rss+xml"/><item><title>CPUç¼“å­˜ä¸€è‡´æ€§ä¸å†…å­˜ä¸€è‡´æ€§ï¼ˆç¬¬ä¸€éƒ¨åˆ†-MESIåè®®ï¼‰</title><link>https://wizmann.top/posts/cache-coherence-and-memory-order/</link><pubDate>Mon, 18 Mar 2024 23:21:35 +0000</pubDate><guid>https://wizmann.top/posts/cache-coherence-and-memory-order/</guid><description>&lt;p>åœ¨å¯¹ç§°å¤šå¤„ç†ç³»ç»Ÿï¼ˆSymmetric Multiprocessing, SMPï¼‰ä¸­ï¼Œä¸€ä¸ªå˜é‡ï¼ˆæˆ–å†…å­˜ä½ç½®ï¼‰å¯ä»¥åŒæ—¶å­˜åœ¨äºå¤šä¸ªCPUçš„ç¼“å­˜è¡Œä¸­ã€‚ä¸ºäº†æä¾›å®Œç¾çš„ç”¨æˆ·çº§æŠ½è±¡ï¼Œä»»ä½•å¯¹ä¸€ä¸ªæˆ–å¤šä¸ªå˜é‡çš„ä¿®æ”¹éƒ½åº”è¯¥è¢«å¼ºåˆ¶åŒæ­¥ï¼Œä»¥ç¡®ä¿å…¶å®ƒCPUçš„ç¼“å­˜å¾—åˆ°æ›´æ–°ã€‚
ç„¶è€Œï¼Œåœ¨å®ç°ä¸Šï¼Œç”±äºCPUä¹‹é—´é€šå¸¸é€šè¿‡æ€»çº¿äº’è”ï¼Œå®ƒä»¬ä¸èƒ½åŒæ—¶å¯¹å¤šä¸ªç¼“å­˜è¿›è¡Œå†™æ“ä½œã€‚&lt;/p>
&lt;h3 id="ç¼“å­˜ä¸€è‡´æ€§">ç¼“å­˜ä¸€è‡´æ€§ &lt;a href="#%e7%bc%93%e5%ad%98%e4%b8%80%e8%87%b4%e6%80%a7" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;p>ç¼“å­˜ä¸€è‡´æ€§æ˜¯æŒ‡åœ¨ä¸€ä¸ªå¤šå¤„ç†å™¨ç³»ç»Ÿä¸­ï¼Œç¡®ä¿å½“æŸä¸ªå¤„ç†å™¨ä¿®æ”¹äº†å­˜å‚¨åœ¨å…±äº«èµ„æºï¼ˆå¦‚ä¸»å†…å­˜æˆ–ç¼“å­˜ä¸­çš„æ•°æ®ï¼‰æ—¶ï¼Œå…¶ä»–å¤„ç†å™¨èƒ½å¤Ÿè®¿é—®åˆ°æœ€æ–°çš„æ•°æ®ç‰ˆæœ¬ï¼Œä»è€Œä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ã€‚&lt;/p>
&lt;p>ä¸ºäº†è¾¾åˆ°è¿™ä¸€ç›®æ ‡ï¼Œç¼“å­˜ä¸€è‡´æ€§æœºåˆ¶å¿…é¡»å¤„ç†ä¸¤ä¸ªä¸»è¦é—®é¢˜ï¼šå†™ä¼ æ’­ï¼ˆWrite Propagationï¼‰å’Œäº‹åŠ¡ä¸²è¡ŒåŒ–ï¼ˆTransaction Serializationï¼‰ã€‚&lt;/p>
&lt;p>å†™ä¼ æ’­ç¡®ä¿ä¸€ä¸ªå¤„ç†å™¨æ ¸å¿ƒçš„å†™æ“ä½œèƒ½è¢«ä¼ æ’­å¹¶è¢«å…¶ä»–å¤„ç†å™¨æ ¸å¿ƒæ‰€è§ã€‚è€Œäº‹åŠ¡ä¸²è¡ŒåŒ–åˆ™ç¡®ä¿æ‰€æœ‰å¤„ç†å™¨æ ¸å¿ƒçš„å†™æ“ä½œæŒ‰ç…§ä¸€å®šçš„é¡ºåºæ‰§è¡Œï¼Œå¯¹æ‰€æœ‰å¤„ç†å™¨æ ¸å¿ƒè€Œè¨€è¿™ä¸ªé¡ºåºæ˜¯ä¸€è‡´çš„ã€‚è¿™ä¸¤ä¸ªæœºåˆ¶å…±åŒå·¥ä½œï¼Œç¡®ä¿äº†å³ä½¿å¤šä¸ªCPUå¯èƒ½å¹¶å‘åœ°ä¿®æ”¹åŒä¸€ä»½æ•°æ®ï¼Œå®ƒä»¬ä¹Ÿèƒ½çœ‹åˆ°ä¸€è‡´çš„æ•°æ®è§†å›¾ã€‚&lt;/p>
&lt;h3 id="mesiåè®®">MESIåè®® &lt;a href="#mesi%e5%8d%8f%e8%ae%ae" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;p>ä¸ºäº†å®ç°ç¼“å­˜ä¸€è‡´æ€§ï¼Œå¤šç§åè®®å’Œæœºåˆ¶è¢«è®¾è®¡å‡ºæ¥ï¼Œå…¶ä¸­MESIåè®®æ˜¯æœ€å¹¿æ³›ä½¿ç”¨çš„ä¸€ç§æœºåˆ¶ã€‚&lt;/p>
&lt;blockquote>
&lt;p>å®é™…ä¸Šï¼ŒAMDå¤„ç†å™¨ä½¿ç”¨çš„æ˜¯MOESIåè®®ï¼ŒIntelå¤„ç†å™¨ä½¿ç”¨çš„æ˜¯MESIFåè®®ã€‚è¿™ä¸¤ç§åè®®éƒ½æ˜¯MESIåè®®çš„å˜ç§ã€‚è¿™é‡Œä¸å±•å¼€è®¨è®ºã€‚&lt;/p>&lt;/blockquote>
&lt;p>MESI åè®®é€šè¿‡å®šä¹‰ç¼“å­˜è¡Œçš„å››ç§çŠ¶æ€â€”â€”ä¿®æ”¹ï¼ˆModifiedï¼‰ã€ç‹¬å ï¼ˆExclusiveï¼‰ã€å…±äº«ï¼ˆSharedï¼‰å’Œæ— æ•ˆï¼ˆInvalidï¼‰ï¼Œç®¡ç†å¤šä¸ªå¤„ç†å™¨ç¼“å­˜ä¹‹é—´çš„ä¸€è‡´æ€§ã€‚çŠ¶æ€ä¹‹é—´çš„è½¬æ¢å—åˆ°ç¼“å­˜åè®®æ§åˆ¶ï¼Œä»¥ç¡®ä¿æ•°æ®çš„ä¸€è‡´æ€§å’ŒåŒæ­¥ã€‚&lt;/p>
&lt;ul>
&lt;li>ç‹¬å ï¼ˆExclusive, Eï¼‰ï¼šç¼“å­˜è¡Œä»…å­˜åœ¨äºå½“å‰ç¼“å­˜ä¸­ï¼Œå¹¶ä¸”æ˜¯å¹²å‡€çš„ï¼ˆå³ç¼“å­˜æ•°æ®ä¸ä¸»å­˜æ•°æ®ä¸€è‡´ï¼‰ã€‚å½“å…¶ä»–ç¼“å­˜å°è¯•è¯»å–è¯¥æ•°æ®æ—¶ï¼ŒçŠ¶æ€è½¬å˜ä¸ºå…±äº«ï¼›å½“å‰ç¼“å­˜å†™å…¥æ•°æ®æ—¶ï¼Œè½¬å˜ä¸ºå·²ä¿®æ”¹çŠ¶æ€&lt;/li>
&lt;li>å…±äº«ï¼ˆShared, Sï¼‰ï¼šç¼“å­˜è¡ŒåŒæ—¶å­˜åœ¨äºå…¶ä»–ç¼“å­˜ä¸­ï¼Œå¹¶ä¸”æ˜¯å¹²å‡€çš„ã€‚è¯¥ç¼“å­˜è¡Œå¯ä»¥åœ¨ä»»æ„æ—¶åˆ»è¢«æŠ›å¼ƒ&lt;/li>
&lt;li>å·²ä¿®æ”¹ï¼ˆModified, Mï¼‰ï¼šç¼“å­˜è¡Œçš„æ•°æ®æ˜¯â€œè„â€çš„ï¼ˆå³ä¸ä¸»å­˜çš„å€¼ä¸åŒï¼‰ã€‚å¦‚æœå…¶ä»– CPU æ ¸å¿ƒéœ€è¦è¯»å–è¿™å—æ•°æ®ï¼Œè¯¥ç¼“å­˜è¡Œå¿…é¡»å…ˆå›å†™åˆ°ä¸»å­˜ï¼Œç„¶åçŠ¶æ€è½¬å˜ä¸ºå…±äº«&lt;/li>
&lt;li>æ— æ•ˆï¼ˆInvalid, Iï¼‰ï¼šè¡¨ç¤ºè¯¥ç¼“å­˜è¡Œæ— æ•ˆï¼Œå³ä¸ºç©ºã€‚ä¸Šæ–‡æåˆ°çš„ç¼“å­˜ç­–ç•¥ä¼šä¼˜å…ˆå¡«å……æ— æ•ˆè¡Œ&lt;/li>
&lt;/ul>
&lt;p>ç®€å•æ¥è¯´ï¼ŒMESIçš„è®¾è®¡ç›®æ ‡åœ¨äºï¼š&lt;/p>
&lt;ol>
&lt;li>é˜²æ­¢å¤šä¸ªå¤„ç†å™¨æ ¸å¿ƒåŒæ—¶å¯¹å…±äº«æ•°æ®è¿›è¡Œä¿®æ”¹ã€‚ä»»ä½•éœ€è¦ä¿®æ”¹å…±äº«æ•°æ®çš„æ ¸å¿ƒéƒ½ä¼šå…ˆå‘å‡ºRFOï¼ˆRead For Ownershipï¼‰è¯·æ±‚æ¥è·å–è¯¥ç¼“å­˜å—çš„æ‰€æœ‰æƒï¼Œå¹¶ä½¿å…¶ä»–å¤„ç†å™¨æ ¸å¿ƒä¸­çš„ç›¸åº”ç¼“å­˜å—å˜ä¸ºæ— æ•ˆã€‚&lt;/li>
&lt;li>é€šè¿‡æ¨è¿Ÿå†™å›æ“ä½œæ¥å‡å°‘å¯¹å†…å­˜çš„é¢‘ç¹ä¿®æ”¹ï¼Œç¡®ä¿åªæœ‰åœ¨å¿…è¦æ—¶æ‰å°†ç¼“å­˜ä¸­çš„æ›´æ”¹å†™å›å†…å­˜ã€‚&lt;/li>
&lt;/ol>
&lt;h3 id="mesi-çš„çŠ¶æ€è½¬ç§»">MESI çš„çŠ¶æ€è½¬ç§» &lt;a href="#mesi-%e7%9a%84%e7%8a%b6%e6%80%81%e8%bd%ac%e7%a7%bb" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;p>MESI åè®®çš„çŠ¶æ€è½¬ç§»å¦‚ä¸‹ï¼š&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/Wizmann/assets/master/wizmann-pic/24-03-31/1711876193915_Diagrama_MESI.gif" alt="">&lt;/p>
&lt;ul>
&lt;li>ä»æ— æ•ˆï¼ˆIï¼‰åˆ°ç‹¬å ï¼ˆEï¼‰ï¼šå½“ CPU éœ€è¦å†™å…¥ä¸€ä¸ªç¼“å­˜è¡Œè€Œè¯¥è¡Œå½“å‰çŠ¶æ€ä¸ºæ— æ•ˆæ—¶ï¼Œå¦‚æœå…¶ä»– CPU ç¼“å­˜ä¸­æ²¡æœ‰è¯¥ç¼“å­˜è¡Œçš„å‰¯æœ¬ï¼Œè¯¥è¡ŒçŠ¶æ€å˜ä¸ºç‹¬å ã€‚è¿™è¡¨æ˜å½“å‰ CPU ç¼“å­˜ä¸­çš„æ•°æ®æ˜¯æœ€æ–°çš„ï¼Œä¸”æ²¡æœ‰å…¶ä»–å‰¯æœ¬å­˜åœ¨&lt;/li>
&lt;li>ä»æ— æ•ˆï¼ˆIï¼‰åˆ°å…±äº«ï¼ˆSï¼‰ï¼šå½“ CPU éœ€è¦è¯»å–ä¸€ä¸ªç¼“å­˜è¡Œè€Œè¯¥è¡Œå½“å‰çŠ¶æ€ä¸ºæ— æ•ˆæ—¶ï¼Œå¦‚æœå…¶ä»– CPU ç¼“å­˜ä¸­å­˜åœ¨è¯¥ç¼“å­˜è¡Œçš„å‰¯æœ¬ï¼Œåˆ™è¯¥è¡ŒçŠ¶æ€å˜ä¸ºå…±äº«&lt;/li>
&lt;li>ä»å…±äº«ï¼ˆSï¼‰åˆ°ç‹¬å ï¼ˆEï¼‰ï¼šå½“ä¸€ä¸ª CPU æƒ³è¦å†™å…¥ä¸€ä¸ªå¤„äºå…±äº«çŠ¶æ€çš„ç¼“å­˜è¡Œæ—¶ï¼Œå¿…é¡»é¦–å…ˆè·å–å…¶ä»–æ‰€æœ‰ CPU ä¸Šè¯¥ç¼“å­˜è¡Œçš„ç‹¬å è®¿é—®æƒï¼Œå¦‚æœæˆåŠŸï¼Œè¯¥ç¼“å­˜è¡ŒçŠ¶æ€å˜ä¸ºç‹¬å &lt;/li>
&lt;li>ä»ç‹¬å ï¼ˆEï¼‰åˆ°ä¿®æ”¹ï¼ˆMï¼‰ï¼šå½“ CPU å¯¹å¤„äºç‹¬å çŠ¶æ€çš„ç¼“å­˜è¡Œè¿›è¡Œå†™æ“ä½œæ—¶ï¼Œè¯¥ç¼“å­˜è¡ŒçŠ¶æ€å˜ä¸ºä¿®æ”¹ã€‚è¿™è¡¨ç¤ºæ•°æ®å·²è¢«å½“å‰ CPU ä¿®æ”¹ï¼Œä¸”ä¸ä¸»å­˜ä¸åŒæ­¥&lt;/li>
&lt;li>ä»ä¿®æ”¹ï¼ˆMï¼‰åˆ°å…±äº«ï¼ˆSï¼‰ï¼šå½“å…¶ä»– CPU è¯·æ±‚è¯»å–å¤„äºä¿®æ”¹çŠ¶æ€çš„ç¼“å­˜è¡Œæ—¶ï¼Œå½“å‰ CPU å¿…é¡»å°†è¯¥ç¼“å­˜è¡Œçš„æ•°æ®å†™å›ä¸»å­˜ï¼Œå¹¶å°†ç¼“å­˜è¡ŒçŠ¶æ€æ”¹ä¸ºå…±äº«ï¼Œä»¥ä¾¿å…¶ä»– CPU å¯ä»¥è¯»å–æœ€æ–°æ•°ã€‚&lt;/li>
&lt;li>ä»ä»»ä½•çŠ¶æ€åˆ°æ— æ•ˆï¼ˆIï¼‰ï¼šå½“ CPU æ¥æ”¶åˆ°å…¶ä»– CPU å‘å‡ºçš„æ— æ•ˆåŒ–è¯·æ±‚æ—¶ï¼Œå¦‚æœå½“å‰ CPU ç¼“å­˜ä¸­æœ‰è¯¥ç¼“å­˜è¡Œçš„å‰¯æœ¬ï¼Œä¸è®ºå®ƒå¤„äºä½•ç§çŠ¶æ€ï¼Œéƒ½å¿…é¡»å°†å…¶æ ‡è®°ä¸ºæ— æ•ˆã€‚è¿™é€šå¸¸å‘ç”Ÿåœ¨å…¶ä»– CPU æƒ³è¦å†™å…¥åŒä¸€ç¼“å­˜è¡Œçš„æƒ…å†µä¸‹&lt;/li>
&lt;/ul>
&lt;blockquote>
&lt;p>å¯ä»¥ä½¿ç”¨è¿™ä¸ª&lt;a href="https://www.scss.tcd.ie/Jeremy.Jones/VivioJS/caches/MESI.htm">ç®€å•çš„æ¨¡æ‹Ÿå™¨&lt;/a>æ¥æ¨¡æ‹ŸMESIåè®®çš„å·¥ä½œçŠ¶æ€&lt;/p>&lt;/blockquote>
&lt;h3 id="mesiçš„ä¼˜åŒ–">MESIçš„ä¼˜åŒ– &lt;a href="#mesi%e7%9a%84%e4%bc%98%e5%8c%96" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;p>éšç€å¤šæ ¸å¤„ç†å™¨çš„æ™®åŠå’Œç³»ç»Ÿå¤æ‚åº¦çš„å¢åŠ ï¼ŒMESIåè®®é¢ä¸´ç€æ€§èƒ½ç“¶é¢ˆå’Œæ•ˆç‡é—®é¢˜ã€‚å› æ­¤ï¼Œä¸ºäº†æé«˜ç³»ç»Ÿæ€§èƒ½å’Œç¼©çŸ­å“åº”æ—¶é—´ï¼Œå¯¹MESIåè®®çš„ä¼˜åŒ–å˜å¾—éå¸¸å¿…è¦ã€‚&lt;/p>
&lt;h4 id="å†™ç¼“å†²åŒºstore-bufferæœºåˆ¶">å†™ç¼“å†²åŒºï¼ˆStore Bufferï¼‰æœºåˆ¶ &lt;a href="#%e5%86%99%e7%bc%93%e5%86%b2%e5%8c%bastore-buffer%e6%9c%ba%e5%88%b6" class="anchor">ğŸ”—&lt;/a>&lt;/h4>&lt;p>åœ¨è¿›è¡Œå†™å…¥æ“ä½œæ—¶ï¼Œä¸€ä¸ªCPUæ ¸å¿ƒï¼ˆä¾‹å¦‚æ ¸å¿ƒ1ï¼‰é¦–å…ˆéœ€è¦å¹¿æ’­ä¸€ä¸ªè¯»å–ä¸ºäº†å†™å…¥ï¼ˆRead For Ownershipï¼ŒRFOï¼‰è¯·æ±‚ï¼Œä»¥è·å¾—å¯¹åº”æ•°æ®çš„ç‹¬å è®¿é—®æƒã€‚åœ¨ç­‰å¾…å…¶ä»–æ ¸å¿ƒå“åº”æ­¤è¯·æ±‚å¹¶å‘é€å›ç¡®è®¤ä¿¡å·ï¼ˆACKï¼‰æœŸé—´ï¼Œæ ¸å¿ƒ1åŸæœ¬éœ€è¦ç©ºé—²ç­‰å¾…ï¼Œè¿™æ— ç–‘æ˜¯å¯¹CPUèµ„æºçš„ä¸€ç§æµªè´¹ã€‚&lt;/p>
&lt;p>ä¸ºäº†æé«˜æ•ˆç‡ï¼Œç°ä»£CPUè®¾è®¡äº†â€œå†™ç¼“å†²åŒºâ€æœºåˆ¶ã€‚é€šè¿‡è¿™ç§æœºåˆ¶ï¼Œå½“æ ¸å¿ƒ1å‘å‡ºRFOè¯·æ±‚å¹¶å°†å†™å…¥æ“ä½œæ”¾å…¥å†™ç¼“å†²åŒºåï¼Œå®ƒå¯ä»¥ç«‹å³ç»§ç»­æ‰§è¡Œå…¶ä»–ä»»åŠ¡ï¼Œè€Œä¸éœ€è¦ç­‰å¾…ACKçš„åˆ°æ¥ã€‚ä¸€æ—¦æ”¶åˆ°ACKï¼ŒCPUå†ä»å†™ç¼“å†²åŒºä¸­å–å‡ºå†™å…¥æ“ä½œï¼Œå®é™…å†™å…¥åˆ°ç¼“å­˜ä¸­ã€‚è¿™æ ·ä¸ä»…ä¼˜åŒ–äº†CPUçš„å·¥ä½œæµç¨‹ï¼Œè¿˜æå‡äº†å¤„ç†å™¨çš„æ•´ä½“æ•ˆèƒ½ã€‚&lt;/p>
&lt;h4 id="å¤±æ•ˆé˜Ÿåˆ—invalidation-queue">å¤±æ•ˆé˜Ÿåˆ—ï¼ˆInvalidation Queueï¼‰ &lt;a href="#%e5%a4%b1%e6%95%88%e9%98%9f%e5%88%97invalidation-queue" class="anchor">ğŸ”—&lt;/a>&lt;/h4>&lt;p>ä¸ºäº†è§£å†³æ ¸å¿ƒåœ¨å¿™ç¢Œæ—¶æ— æ³•åŠæ—¶å“åº”RFOè¯·æ±‚çš„é—®é¢˜ï¼Œç°ä»£CPUå¼•å…¥äº†â€œå¤±æ•ˆé˜Ÿåˆ—â€æœºåˆ¶ã€‚æ”¶åˆ°çš„RFOè¯·æ±‚è¢«æ”¾å…¥å¤±æ•ˆé˜Ÿåˆ—ï¼Œå¹¶ç«‹å³å‘é€å›ACKï¼Œå¾…æ ¸å¿ƒå®Œæˆæ‰‹å¤´ä¸Šçš„ä»»åŠ¡åï¼Œå†å¤„ç†å¤±æ•ˆé˜Ÿåˆ—ä¸­çš„è¯·æ±‚ã€‚è¿™ç§è®¾è®¡æœ‰æ•ˆåœ°ç¼©çŸ­äº†ç­‰å¾…æ—¶é—´ï¼ŒåŠ é€Ÿäº†æ•°æ®åŒæ­¥è¿‡ç¨‹ã€‚&lt;/p>
&lt;h3 id="mesiçš„æ½œåœ¨é—®é¢˜">MESIçš„æ½œåœ¨é—®é¢˜ &lt;a href="#mesi%e7%9a%84%e6%bd%9c%e5%9c%a8%e9%97%ae%e9%a2%98" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;h4 id="false-sharing">False Sharing &lt;a href="#false-sharing" class="anchor">ğŸ”—&lt;/a>&lt;/h4>&lt;p>ç”±äºCPUä»¥64Bçš„Cache Lineä¸ºæœ€å°å•ä½ä»å†…å­˜ä¸­åŠ è½½æ•°æ®ï¼Œå¯èƒ½ä¼šå‡ºç°è¿™æ ·çš„é—®é¢˜ï¼š&lt;/p>
&lt;p>å‡è®¾å˜é‡aå’Œbä½äºåŒä¸€ä¸ªCache Lineä¸­ï¼Œå½“å‰CPU0å’ŒCPU1éƒ½å°†è¿™ä¸ªCache LineåŠ è½½åˆ°Cacheï¼ŒCPU0åªä¿®æ”¹å˜é‡aï¼ŒCPU1åªè¯»å–å˜é‡bã€‚å½“CPU0ä¿®æ”¹aæ—¶ï¼ŒCPU1çš„Cache Lineä¼šå˜ä¸ºInvalidçŠ¶æ€ï¼Œå³ä½¿CPU1å¹¶æ²¡æœ‰ä¿®æ”¹bï¼Œè¿™ä¼šå¯¼è‡´CPU1ä»å†…å­˜æˆ–å…¶å®ƒæ ¸å¿ƒé‡æ–°åŠ è½½Cache Lineä¸­çš„æ‰€æœ‰å˜é‡ï¼Œå½±å“æ€§èƒ½ã€‚è¿™å°±æ˜¯False Sharingã€‚&lt;/p>
&lt;p>è§£å†³False Sharingçš„å¸¸ç”¨æ–¹æ³•æ˜¯è¿›è¡Œå­—èŠ‚å¡«å……ï¼Œåœ¨aå’Œbä¹‹é—´å¡«å……æ— æ„ä¹‰çš„å˜é‡ï¼Œä½¿ä¸€ä¸ªå˜é‡å•ç‹¬å ç”¨ä¸€ä¸ªCache Lineã€‚&lt;/p>
&lt;h4 id="rmwæ“ä½œ">RMWæ“ä½œ &lt;a href="#rmw%e6%93%8d%e4%bd%9c" class="anchor">ğŸ”—&lt;/a>&lt;/h4>&lt;p>åœ¨å¹¶å‘ç¼–ç¨‹ä¸­ï¼Œè¯»-æ”¹-å†™ï¼ˆRMWï¼‰æ“ä½œï¼Œå¦‚æ¯”è¾ƒå¹¶äº¤æ¢ï¼ˆCASï¼‰å’ŒåŸå­åŠ ï¼ˆADDï¼‰ï¼Œéœ€ä½œä¸ºå•ä¸€çš„åŸå­æ“ä½œæ‰§è¡Œä»¥é¿å…æ•°æ®ç«äº‰ã€‚&lt;/p>
&lt;p>å°½ç®¡MESIç¼“å­˜ä¸€è‡´æ€§åè®®ç¡®ä¿äº†å¤„ç†å™¨æ ¸å¿ƒé—´ç¼“å­˜è¡ŒçŠ¶æ€çš„ä¸€è‡´æ€§ï¼Œå®ƒå¹¶ä¸è§£å†³æ“ä½œçš„åŸå­æ€§é—®é¢˜ã€‚åœ¨RMWæ“ä½œä¸­ï¼Œç”±äºä»è¯»å–åˆ°å†™å›çš„æ—¶é—´çª—å£å†…å¯èƒ½å‘ç”Ÿå…¶ä»–å¤„ç†å™¨çš„å¹²é¢„ä¿®æ”¹ï¼Œå¯èƒ½å¯¼è‡´æ•°æ®ç«äº‰å’ŒçŠ¶æ€ä¸ä¸€è‡´ã€‚&lt;/p>
&lt;p>åœ¨ä¸ºæ­¤ï¼Œ&lt;code>LOCK&lt;/code>æŒ‡ä»¤è¢«ç”¨æ¥ç¡®ä¿RMWæ“ä½œçš„åŸå­æ€§ï¼Œé€šè¿‡é”å®šæ“ä½œæ¶‰åŠçš„ç¼“å­˜è¡Œï¼Œé˜²æ­¢åœ¨æ“ä½œå®Œæˆå‰è¢«å…¶ä»–å¤„ç†å™¨è®¿é—®ï¼Œä»è€Œæœ‰æ•ˆåœ°è§£å†³äº†æ•°æ®ç«äº‰é—®é¢˜ï¼Œä¿éšœäº†æ“ä½œçš„å®‰å…¨æ€§å’Œæ•°æ®çš„ä¸€è‡´æ€§ã€‚&lt;/p>
&lt;h4 id="å†™ç¼“å†²åŒºstore-bufferä¼˜åŒ–å¸¦æ¥çš„æ½œåœ¨é—®é¢˜">å†™ç¼“å†²åŒºï¼ˆStore Bufferï¼‰ä¼˜åŒ–å¸¦æ¥çš„æ½œåœ¨é—®é¢˜ &lt;a href="#%e5%86%99%e7%bc%93%e5%86%b2%e5%8c%bastore-buffer%e4%bc%98%e5%8c%96%e5%b8%a6%e6%9d%a5%e7%9a%84%e6%bd%9c%e5%9c%a8%e9%97%ae%e9%a2%98" class="anchor">ğŸ”—&lt;/a>&lt;/h4>&lt;p>å†™ç¼“å†²åŒºå¸¦æ¥çš„æœ€ä¸»è¦çš„é—®é¢˜æ˜¯ä¸å…¶ä»–æ ¸å¿ƒçš„æ•°æ®ä¸€è‡´æ€§é—®é¢˜ã€‚ç”±äºå†™æ“ä½œè¢«å»¶è¿Ÿæ‰§è¡Œï¼Œå…¶ä»–æ ¸å¿ƒå¯èƒ½åœ¨è¿™æ®µæ—¶é—´å†…è¯»å–åˆ°äº†æ—§çš„æ•°æ®å€¼ï¼Œä»è€Œå¯¼è‡´æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ã€‚æ­¤å¤–ï¼Œå†™ç¼“å†²åŒºå¯èƒ½å¯¼è‡´å†…å­˜é¡ºåºçš„é—®é¢˜ï¼Œå³ç¼–å†™çš„ç¨‹åºé€»è¾‘ä¸å®é™…æ‰§è¡Œé€»è¾‘ä¸ç¬¦ã€‚&lt;/p>
&lt;h4 id="å¤±æ•ˆé˜Ÿåˆ—invalidation-queueå¸¦æ¥çš„æ½œåœ¨é—®é¢˜">å¤±æ•ˆé˜Ÿåˆ—ï¼ˆInvalidation Queueï¼‰å¸¦æ¥çš„æ½œåœ¨é—®é¢˜ &lt;a href="#%e5%a4%b1%e6%95%88%e9%98%9f%e5%88%97invalidation-queue%e5%b8%a6%e6%9d%a5%e7%9a%84%e6%bd%9c%e5%9c%a8%e9%97%ae%e9%a2%98" class="anchor">ğŸ”—&lt;/a>&lt;/h4>&lt;p>å¤±æ•ˆé˜Ÿåˆ—æé«˜äº†å“åº”é€Ÿåº¦ï¼Œä½†å®ƒä¹Ÿå¯èƒ½å¼•å…¥æ–°çš„é—®é¢˜ã€‚å¤±æ•ˆé˜Ÿåˆ—å…è®¸CPUæ ¸å¿ƒåœ¨ç¡®è®¤æ¥æ”¶åˆ°å¤±æ•ˆè¯·æ±‚åï¼Œå»¶è¿Ÿå¤„ç†è¿™äº›è¯·æ±‚ã€‚è¿™ç§å»¶è¿Ÿå¯èƒ½å¯¼è‡´æ•°æ®åœ¨ä¸åŒæ ¸å¿ƒé—´çš„ä¸€è‡´æ€§é—®é¢˜ï¼Œå³ä¸€ä¸ªæ ¸å¿ƒå¯èƒ½ä¼šåœ¨çŸ­æ—¶é—´å†…ç»§ç»­ä½¿ç”¨å·²ç»å¤±æ•ˆçš„æ•°æ®ï¼Œè€Œè¿™æ®µæ—¶é—´å†…å…¶ä»–æ ¸å¿ƒå·²ç»ä¿®æ”¹äº†è¿™éƒ¨åˆ†æ•°æ®ã€‚&lt;/p>
&lt;h2 id="å‚è€ƒé“¾æ¥">å‚è€ƒé“¾æ¥ &lt;a href="#%e5%8f%82%e8%80%83%e9%93%be%e6%8e%a5" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;ul>
&lt;li>&lt;a href="https://zh.wikipedia.org/wiki/MESI%E5%8D%8F%E8%AE%AE">MESIåè®®&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/LeoYang90/Golang-Internal-Notes/blob/master/Go%20%E5%86%85%E5%AD%98%E4%B8%80%E8%87%B4%E6%80%A7%E6%A8%A1%E5%9E%8B.md#go-%E5%86%85%E5%AD%98%E4%B8%80%E8%87%B4%E6%80%A7%E6%A8%A1%E5%9E%8B">Go å†…å­˜ä¸€è‡´æ€§æ¨¡å‹&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://juejin.cn/post/7158395475362578462">12 å¼ å›¾çœ‹æ‡‚ CPU ç¼“å­˜ä¸€è‡´æ€§ä¸ MESI åè®®ï¼ŒçœŸçš„ä¸€è‡´å—ï¼Ÿ&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://wudaijun.com/2019/04/cache-coherence-and-memory-consistency/">Cacheä¸€è‡´æ€§å’Œå†…å­˜ä¸€è‡´æ€§&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://blog.chongsheng.art/post/golang/cpu-cache-memory-barrier/">CPUç¼“å­˜æ¶æ„åˆ°å†…å­˜å±éšœ&lt;/a>&lt;/li>
&lt;/ul>
&lt;div class="alert alert-info" role="alert">æœ¬æ–‡å¤§ï¼ˆåˆ’æ‰ï¼‰éƒ¨åˆ†å†…å®¹ç”±ChatGPT4ç”Ÿæˆ&lt;/div></description></item><item><title>Parallel patterns in C#</title><link>https://wizmann.top/posts/parallel-in-csharp/</link><pubDate>Sun, 22 Jan 2017 22:52:28 +0000</pubDate><guid>https://wizmann.top/posts/parallel-in-csharp/</guid><description>&lt;h2 id="å†™åœ¨å‰é¢">å†™åœ¨å‰é¢ &lt;a href="#%e5%86%99%e5%9c%a8%e5%89%8d%e9%9d%a2" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>ä¸C/C++æ‰€ä½¿ç”¨çš„ï¼Œä¼ ç»Ÿçš„åŸºäºçº¿ç¨‹çš„å¹¶è¡Œæ¨¡å¼ä¸åŒï¼ŒC#å®ç°äº†ä¸°å¯Œçš„å¹¶å‘ç¼–ç¨‹æ¨¡å‹ï¼Œå…¶ä¸­ä»¥å¼‚æ­¥æ¨¡å‹æœ€ä¸ºæµè¡Œã€‚&lt;/p>
&lt;p>æœ¬æ–‡ä¸­æˆ‘ä»¬é‡ç‚¹è®¨è®ºC#åœ¨å‘å±•è¿‡ç¨‹ä¸­å‡ºç°çš„å‡ ç§å¼‚æ­¥ç¼–ç¨‹æ¨¡å‹ï¼š&lt;/p>
&lt;ul>
&lt;li>Async Programming Modelï¼ˆAPMï¼‰&lt;/li>
&lt;li>Event-based Async Pattern (EAP)&lt;/li>
&lt;li>Task-based Async Patternï¼ˆTAPï¼‰&lt;/li>
&lt;li>async/awaitè¯­æ³•ç³–&lt;/li>
&lt;/ul>
&lt;h2 id="å¼‚æ­¥ç¼–ç¨‹å…¥é—¨">å¼‚æ­¥ç¼–ç¨‹å…¥é—¨ &lt;a href="#%e5%bc%82%e6%ad%a5%e7%bc%96%e7%a8%8b%e5%85%a5%e9%97%a8" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>åŒæ­¥æ¨¡å¼æ˜¯æœ€å¸¸è§ï¼Œä¹Ÿæ˜¯æœ€è¢«äººç†ŸçŸ¥çš„ç¼–ç¨‹æ¨¡å‹ï¼Œæ¯ä¸€ä¸ªä»»åŠ¡æŒ‰é¡ºåºæ‰§è¡Œï¼Œå‰ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œå®Œä¹‹åæ‰ä¼šæ‰§è¡Œä¸‹ä¸€ä¸ªä»»åŠ¡ã€‚&lt;/p>
&lt;p>å¼‚æ­¥ç¼–ç¨‹å’ŒåŒæ­¥ç¼–ç¨‹ä¸åŒï¼Œç¨‹åºçš„æ‰§è¡Œæµç¨‹æ˜¯ç”±â€œäº‹ä»¶â€æ‰€é©±åŠ¨çš„ã€‚å¼‚æ­¥ç¼–ç¨‹æœ‰ä¸¤ç§å®ç°æ–¹å¼ï¼Œå›è°ƒä¸futureæ¨¡å¼ã€‚&lt;/p>
&lt;p>å›è°ƒå‡½æ•°åœ¨Javascriptä¸­è¢«å¤§é‡ä½¿ç”¨ï¼Œç›¸ä¿¡å¤§å®¶ä¹Ÿéƒ½ä¸ä¼šé™Œç”Ÿã€‚ä½†æ˜¯å¤§é‡çš„å›è°ƒå‡½æ•°ä¼šè®©ä»£ç å¤±å»å¯è¯»æ€§ï¼Œé™·å…¥â€œCallback hellâ€ã€‚&lt;/p>
&lt;p>Promiseæ¨¡å¼æ˜¯å›è°ƒå‡½æ•°çš„ä¸€ç§â€œåŒ…è£…â€ã€‚æˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªå ä½ç¬¦æ¥è¡¨ç¤ºâ€œæœªæ¥â€å°†ä¼šäº§ç”Ÿçš„ä¸€ä¸ªå¼‚æ­¥å¤„ç†ç»“æœã€‚&lt;/p>
&lt;p>è¿™ä¸ªå ä½ç¬¦åœ¨ä¸åŒçš„è¯­è¨€/æ¡†æ¶é‡Œé¢æœ‰ä¸åŒçš„åå­—ï¼Œå…¶å®šä¹‰ä¹Ÿä¸å°½ç›¸åŒï¼š&lt;/p>
&lt;ul>
&lt;li>Task - C#&lt;/li>
&lt;li>Deferred - Python Twisted&lt;/li>
&lt;li>Promise - Javascript&lt;/li>
&lt;/ul>
&lt;p>åœ¨ä»»åŠ¡ç»“æŸåï¼Œä¼šè§¦å‘ç»‘å®šåœ¨è¿™ä¸ªå ä½ç¬¦ä¸Šå®šä¹‰çš„å›è°ƒå‡½æ•°ï¼Œç»§ç»­é¢„å®šä¹‰å¥½çš„é€»è¾‘ã€‚&lt;/p>
&lt;p>ä¸¾ä¸ªä¾‹å­ï¼ŒåŒæ­¥æ¨¡å‹å°±æ˜¯ä½ ï¼š&lt;/p>
&lt;p>å®…å®¶æƒ³åƒé¥­ -&amp;gt; ä¸‹æ¥¼ä¹°é¥­ -&amp;gt; ä¸Šæ¥¼ -&amp;gt; åƒé¥­ -&amp;gt; æ‰“æ¸¸æˆçœ‹æ¼‚äº®å°å§å§ã€‚&lt;/p>
&lt;p>è€Œå¼‚æ­¥æ¨¡å‹å‘¢ï¼Œå°±æ˜¯ï¼š&lt;/p>
&lt;p>å®…å®¶æƒ³åƒé¥­ -&amp;gt; æ‰‹æœºå«å¤–å– -&amp;gt; æ‹¿åˆ°äº†å¤–å–å®šå•ï¼ˆæ‹¿åˆ°å ä½ç¬¦ æˆ– æ³¨å†Œå›è°ƒï¼‰-&amp;gt; æ‰“æ¸¸æˆçœ‹æ¼‚äº®å°å§å§ -&amp;gt; å¤–å–å°å“¥æŠŠé¥­é€ä¸Šé—¨ï¼ˆå¯åŠ¨å›è°ƒï¼‰ -&amp;gt; åƒé¥­ -&amp;gt; ç»§ç»­æ‰“æ¸¸æˆçœ‹æ¼‚äº®å°å§å§ã€‚&lt;/p>
&lt;p>è™½ç„¶ä»ä¸Šé¢çœ‹ï¼Œå¼‚æ­¥æ¨¡å‹æ¯”åŒæ­¥æ¨¡å‹è¦å¤æ‚ä¸€äº›ã€‚ä½†æ˜¯å®ƒå´èŠ‚çœäº†è€—æ—¶çš„â€œä¸Šä¸‹æ¥¼ä¹°é¥­â€çš„æ—¶é—´ï¼Œè®©ä½ å¯ä»¥åˆ†é…æ›´å¤šçš„æ—¶é—´ç”¨æ¥çœ‹æ¼‚äº®å°å§å§ã€‚è¿™å’Œæˆ‘ä»¬å†™ç¨‹åºæ—¶çš„æ€è·¯æ˜¯ä¸€è‡´çš„ï¼ŒèŠ‚çœåŠ¨è¾„åå‡ å‡ åæ¯«ç§’è€—æ—¶çš„IOæ—¶é—´ï¼Œå°†æ›´å¤šçš„æ—¶é—´ç”¨åœ¨CPUä¸Šã€‚&lt;/p>
&lt;h2 id="thread-based-parallel">Thread Based Parallel &lt;a href="#thread-based-parallel" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>åŸºäºçº¿ç¨‹çš„å¹¶å‘æ¨¡å‹æ˜¯æ¯”è¾ƒä¼ ç»Ÿçš„å¹¶å‘æ¨¡å‹äº†ï¼ŒåŸºæœ¬ä¸Šæ‰€æœ‰çš„ç°ä»£ç¼–ç¨‹è¯­è¨€éƒ½ä¼šæ”¯æŒã€‚C#ä¸­Threadçš„ç”¨æ³•ä¸Javaç±»ä¼¼ï¼Œè¿™é‡Œå°±ä¸åšå±•å¼€ã€‚&lt;/p>
&lt;p>ä¸æ­¤åŒæ—¶ï¼ŒC#è¿˜æ”¯æŒThread poolï¼Œç”¨æ¥è¿è¡Œ&amp;quot;long-running processor-bound tasks&amp;quot;ã€‚&lt;/p>
&lt;p>ç›´æ¥æ“ä½œçº¿ç¨‹ä¹Ÿè®¸æ˜¯ä¸­å¹´ç¨‹åºå‘˜çš„å¿…ä¿®è¯¾ï¼Œä½†æ˜¯æ‰‹åŠ¨ç®¡ç†çº¿ç¨‹ä¼šç»™ç¨‹åºå¸¦æ¥é¢å¤–çš„è´Ÿæ‹…ã€‚æ‰€ä»¥å„ç§æ¨¡å‹ä¸æ¡†æ¶åº”è¿è€Œç”Ÿï¼Œè¯•å›¾é™ä½å¹¶å‘ç¼–ç¨‹çš„å¤æ‚åº¦ã€‚&lt;/p>
&lt;h2 id="async-programming-model-apm">Async Programming Model (APM) &lt;a href="#async-programming-model-apm" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>åœ¨æˆ‘ä»¬ç†Ÿæ‚‰çš„async/awaitè¯­æ³•ç³–å‡ºç°ä¹‹å‰ï¼ŒC#ä¸­ä½¿ç”¨APMæ¥è¡¨ç¤ºå¼‚æ­¥æ“ä½œã€‚è™½ç„¶è¿™æ˜¯ä¸€ç§ä¸Šå¤æ—¶æœŸçš„å›è°ƒæ¨¡å¼è¯­æ³•ï¼Œä½†æ˜¯ç°åœ¨æœ‰å¾ˆå¤šåº“ä»æ—§æ”¯æŒè¿™ç§é£æ ¼ã€‚å¦‚Azure Storage SDKä¸­çš„&lt;code>CloudTable.BeginExecute&lt;/code>ç­‰ä¸€ç³»åˆ—å‡½æ•°ã€‚&lt;/p>
&lt;p>ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ä½¿ç”¨APMæ¨¡å¼çš„ä»£ç èŒƒä¾‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cs" data-lang="cs">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">using&lt;/span> System;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">using&lt;/span> System.Collections.Generic;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">using&lt;/span> System.Linq;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">using&lt;/span> System.Runtime.Remoting.Messaging;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">using&lt;/span> System.Runtime.Remoting.Proxies;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">using&lt;/span> System.Text;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">using&lt;/span> System.Threading;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">using&lt;/span> System.Threading.Tasks;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">namespace&lt;/span> ConsoleApplication6
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">Program&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">delegate&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> AsyncInvoke();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> Main(&lt;span style="color:#66d9ef">string&lt;/span>[] args)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">var&lt;/span> SI = &lt;span style="color:#66d9ef">new&lt;/span> AsyncInvoke(MyCall);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">var&lt;/span> ar = SI.BeginInvoke(MyCallback, &lt;span style="color:#66d9ef">null&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Console.WriteLine(&lt;span style="color:#e6db74">&amp;#34;Main()&amp;#34;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">while&lt;/span> (!ar.AsyncWaitHandle.WaitOne(&lt;span style="color:#ae81ff">1000&lt;/span>))
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Console.WriteLine(&lt;span style="color:#e6db74">&amp;#34;Main() waiting...&amp;#34;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Console.WriteLine(&lt;span style="color:#e6db74">&amp;#34;Main() done&amp;#34;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Console.ReadLine();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> MyCall()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">for&lt;/span> (&lt;span style="color:#66d9ef">int&lt;/span> i = &lt;span style="color:#ae81ff">0&lt;/span>; i &amp;lt; &lt;span style="color:#ae81ff">5&lt;/span>; i++)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Console.WriteLine(&lt;span style="color:#e6db74">&amp;#34;running...&amp;#34;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Thread.Sleep(&lt;span style="color:#ae81ff">500&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Console.WriteLine(&lt;span style="color:#e6db74">&amp;#34;done&amp;#34;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#ae81ff">42&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> MyCallback(IAsyncResult iResult)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">var&lt;/span> result = iResult &lt;span style="color:#66d9ef">as&lt;/span> AsyncResult;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">var&lt;/span> si = (AsyncInvoke) result.AsyncDelegate;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">int&lt;/span> ret = si.EndInvoke(result);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Console.WriteLine(ret);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿è¡Œç»“æœå¦‚ä¸‹ï¼š&lt;/p>
&lt;p>&lt;img src="https://github.com/Wizmann/assets/raw/master/wizmann-pic/17-1-19/26234044-file_1484828912411_150f3.gif" alt="">&lt;/p>
&lt;p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼š&lt;/p>
&lt;ol>
&lt;li>æˆ‘ä»¬å°†&lt;code>MyCall()&lt;/code>â€œåŒ…è£…â€åœ¨ä¸€ä¸ª&lt;code>delegate&lt;/code>ä¸­ï¼Œç„¶åè°ƒç”¨&lt;code>BeginInvoke&lt;/code>å‡½æ•°å®ç°å¼‚æ­¥æ‰§è¡Œã€‚è¿™ä¸ªdelegateçš„æ‰§è¡Œä¸ä¼šé˜»å¡main threadã€‚&lt;/li>
&lt;li>ä¸€ä¸ªå¼‚æ­¥æ‰§è¡Œçš„&lt;code>delegate&lt;/code>å¯ä»¥æœ‰ä¸€ä¸ªå›è°ƒï¼Œè¿™ä¸ªå›è°ƒåœ¨delegateæ‰§è¡Œå®Œåè¢«è§¦å‘ã€‚&lt;/li>
&lt;li>æˆ‘ä»¬å¯ä»¥&amp;quot;long-polling&amp;quot;ç­‰å¾…ä¸€ä¸ªå¼‚æ­¥è°ƒç”¨æ‰§è¡Œå®Œã€‚è¿™é‡Œçš„â€œæ‰§è¡Œå®Œâ€ä¸åŒ…æ‹¬æ¡ç›®2æåˆ°çš„å›è°ƒï¼ˆå°å¿ƒrace conditionï¼ï¼‰ã€‚&lt;/li>
&lt;li>å¼‚æ­¥æ‰§è¡Œçš„ç»“æœå¯ä»¥é€šè¿‡&lt;code>delegate.EndInvoke(IAsyncResult)&lt;/code>å‡½æ•°è·å–åˆ°å¼‚æ­¥è°ƒç”¨çš„ç»“æœã€‚&lt;/li>
&lt;li>ç”±æ¡ç›®3æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œåœ¨callbackå‡½æ•°ä¸­è·å–å¼‚æ­¥è°ƒç”¨çš„ç»“æœæ˜¯æœ€åˆé€‚çš„ã€‚&lt;/li>
&lt;/ol>
&lt;p>æ‰€ä»¥APMé£æ ¼çš„ä»£ç å†™èµ·æ¥éå¸¸åƒjavascriptä¸­çš„å›è°ƒå†™æ³•ï¼Œå¦‚æœé€»è¾‘å¤æ‚çš„è¯ï¼Œç»´æŠ¤èµ·æ¥ä¼šæ˜¯ä¸€ä¸ªå¤§å‘ã€‚&lt;/p>
&lt;h2 id="event-asynchronous-pattern-eap">Event Asynchronous Pattern (EAP) &lt;a href="#event-asynchronous-pattern-eap" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>EAPæ˜¯å›è°ƒå‡½æ•°çš„å¦ä¸€ç§å°è£…ã€‚&lt;/p>
&lt;p>æˆ‘ä»¬æ¥çœ‹ä¸‹é¢çš„ä»£ç ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cs" data-lang="cs">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">using&lt;/span> System;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">using&lt;/span> System.Collections.Generic;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">using&lt;/span> System.ComponentModel;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">using&lt;/span> System.Linq;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">using&lt;/span> System.Text;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">using&lt;/span> System.Threading;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">using&lt;/span> System.Threading.Tasks;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">namespace&lt;/span> ConsoleApplication2
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">StringEventArgs&lt;/span> : EventArgs
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">string&lt;/span> Content { &lt;span style="color:#66d9ef">get&lt;/span>; &lt;span style="color:#66d9ef">set&lt;/span>; }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">Solution&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">event&lt;/span> EventHandler&amp;lt;StringEventArgs&amp;gt; _eventHandler;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">public&lt;/span> Solution()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> _eventHandler += Handle1;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> _eventHandler += Handle2;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> Run()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> _eventHandler?.Invoke(&lt;span style="color:#66d9ef">this&lt;/span>, &lt;span style="color:#66d9ef">new&lt;/span> StringEventArgs()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Content = &lt;span style="color:#e6db74">&amp;#34;123&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> });
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">void&lt;/span> Handle1(&lt;span style="color:#66d9ef">object&lt;/span> sender, StringEventArgs args)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Console.WriteLine(&lt;span style="color:#e6db74">&amp;#34;Handle1 &amp;#34;&lt;/span> + args.Content);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Thread.Sleep(&lt;span style="color:#ae81ff">1000&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">void&lt;/span> Handle2(&lt;span style="color:#66d9ef">object&lt;/span> sender, StringEventArgs args)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Console.WriteLine(&lt;span style="color:#e6db74">&amp;#34;Handle2 &amp;#34;&lt;/span> + args.Content);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Thread.Sleep(&lt;span style="color:#ae81ff">1000&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">Program&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> Main(&lt;span style="color:#66d9ef">string&lt;/span>[] args)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Solution sol = &lt;span style="color:#66d9ef">new&lt;/span> Solution();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> sol.Run();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Console.WriteLine(&lt;span style="color:#e6db74">&amp;#34;Done&amp;#34;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Console.ReadLine();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿è¡Œç»“æœå¦‚ä¸‹ï¼š&lt;/p>
&lt;p>&lt;img src="https://github.com/Wizmann/assets/raw/master/wizmann-pic/17-1-20/46892581-file_1484911655343_68ae.gif" alt="">&lt;/p>
&lt;p>æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œæ‰€æœ‰çš„å‡½æ•°éƒ½æ‰§è¡Œåœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¸Šã€‚å¹¶ä¸”&lt;code>Handle1&lt;/code>å’Œ&lt;code>Handle2&lt;/code>é¡ºåºæ‰§è¡Œã€‚&lt;/p>
&lt;p>åœ¨å®é™…å·¥ç¨‹ä¸­ï¼Œæˆ‘ä»¬fire eventçš„ä»£ç å¯ä»¥åœ¨ä¸åŒçš„çº¿ç¨‹ï¼Œä¹‹å&lt;code>EventHandler&lt;/code>ï¼Œä¹Ÿå°±æ˜¯callbackå‡½æ•°ä¼šè¢«è°ƒç”¨ã€‚&lt;/p>
&lt;p>EventåŒæ—¶æ”¯æŒ&lt;code>BeginInvoke&lt;/code>å’Œ&lt;code>EndInvoke&lt;/code>å‡½æ•°ï¼Œä¹Ÿå°±æ„å‘³ç€æˆ‘ä»¬å¯ä»¥å¼‚æ­¥çš„fireç›¸åº”çš„å›è°ƒã€‚ä½†æ˜¯æ³¨æ„æ­¤æ—¶æˆ‘ä»¬åªèƒ½æ³¨å†Œå”¯ä¸€çš„å›è°ƒï¼Œå› ä¸º&lt;code>BeginInvoke&lt;/code>åªèƒ½æœ‰ä¸€ä¸ªç›®æ ‡å›è°ƒï¼ˆåŸç†ï¼šåœ¨åŒä¸€æ—¶é—´åŒä¸€çº¿ç¨‹åªèƒ½æœ‰ä¸€ä¸ªå‡½æ•°è°ƒç”¨ï¼‰ã€‚&lt;/p>
&lt;h2 id="task-asynchronous-pattern-tap">Task Asynchronous Pattern (TAP) &lt;a href="#task-asynchronous-pattern-tap" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>åœ¨.NET 4.0ï¼ˆç°åœ¨å·²ç»åˆ°6.0äº†å“¦ï¼‰ï¼ŒC#å¼•å…¥äº†TPLï¼ŒTask Parallel Libraryã€‚Taskçš„ç›®æ ‡æ˜¯ç»Ÿä¸€C#ä¸­çš„ä¸åŒå¼‚æ­¥ç¼–ç¨‹é£æ ¼ã€‚&lt;/p>
&lt;p>TPLä¸­çš„Taskéå¸¸åƒJSä¸­çš„promiseå’Œtwistedä¸­çš„deferredï¼Œæ˜¯â€œæœªæ¥ä¼šå®Œæˆçš„æ“ä½œçš„ç»“æœâ€çš„å ä½ç¬¦ã€‚&lt;/p>
&lt;p>æˆ‘ä»¬æ¥çœ‹ä¸€æ®µç®€å•ä»£ç ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cs" data-lang="cs">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">using&lt;/span> System;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">using&lt;/span> System.Collections.Generic;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">using&lt;/span> System.Linq;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">using&lt;/span> System.Text;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">using&lt;/span> System.Threading;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">using&lt;/span> System.Threading.Tasks;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">namespace&lt;/span> ConsoleApplication3
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">Program&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> Main(&lt;span style="color:#66d9ef">string&lt;/span>[] args)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Task t = Task.Run(() =&amp;gt;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Console.WriteLine(&lt;span style="color:#e6db74">&amp;#34;Task start&amp;#34;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Thread.Sleep(&lt;span style="color:#ae81ff">2000&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Console.WriteLine(&lt;span style="color:#e6db74">&amp;#34;Task end&amp;#34;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> });
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">while&lt;/span> (!t.IsCompleted)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Console.WriteLine(&lt;span style="color:#e6db74">&amp;#34;Main(): Task is running...&amp;#34;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Thread.Sleep(&lt;span style="color:#ae81ff">1000&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Console.WriteLine(&lt;span style="color:#e6db74">&amp;#34;Done&amp;#34;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Console.ReadLine();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™æ®µä»£ç æˆ‘ä»¬å‰é¢æåˆ°çš„APMå’ŒEAPé£æ ¼çš„ä»£ç æœ‰æ˜æ˜¾çš„ä¸åŒï¼ŒTAPæ›´æ˜“è¯»ï¼Œå¹¶ä¸”ä¿æŒäº†æ§åˆ¶æµçš„å®Œæ•´æ€§ã€‚ä¸åƒAPMéœ€è¦åœ¨&lt;code>EndInvoke&lt;/code>å‡½æ•°ä¸­è·å–è¿”å›å€¼ä»¥åŠè¿›è¡Œåç»­æ“ä½œï¼Œä¹Ÿä¸åƒEAPä¸€æ ·éœ€è¦æ ¹æ®ä¸åŒçš„eventå£°æ˜ä¸åŒçš„å›è°ƒã€‚&lt;/p>
&lt;p>Taskä¹Ÿå¯èƒ½â€œä¸²èµ·æ¥â€ï¼Œå®ç°å¤šçº§å›è°ƒçš„æœºåˆ¶ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cs" data-lang="cs">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">using&lt;/span> System;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">using&lt;/span> System.Collections.Generic;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">using&lt;/span> System.Linq;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">using&lt;/span> System.Text;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">using&lt;/span> System.Threading.Tasks;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">namespace&lt;/span> ConsoleApplication4
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">Program&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> Main(&lt;span style="color:#66d9ef">string&lt;/span>[] args)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">var&lt;/span> t0 = Task.Run(() =&amp;gt; &lt;span style="color:#ae81ff">0&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">var&lt;/span> t1 = t0.ContinueWith((antecedent) =&amp;gt;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Console.WriteLine(antecedent.Result);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> antecedent.Result + &lt;span style="color:#ae81ff">1&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> });
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">var&lt;/span> t2 = t1.ContinueWith((antecedent) =&amp;gt;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Console.WriteLine(antecedent.Result);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> antecedent.Result + &lt;span style="color:#ae81ff">1&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> });
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">var&lt;/span> t3 = t2.ContinueWith((antecedent) =&amp;gt;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Console.WriteLine(antecedent.Result);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> antecedent.Result + &lt;span style="color:#ae81ff">1&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> });
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Console.ReadLine();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å½“ç„¶æˆ‘ä»¬è¿˜å¯ä»¥æŠŠå›è°ƒå†™æˆä¸€æ£µæ ‘çŠ¶ç»“æ„ï¼Œç„¶åä¸€å±‚ä¸€å±‚çš„æ‰§è¡Œï¼Œä¸è¿‡ç”Ÿå‘½æ˜¯å¦‚æ­¤å®è´µï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰å……åˆ†çš„ç†ç”±è¦è¿™ä¹ˆåšã€‚&lt;/p>
&lt;h2 id="asyncawaitè¯­æ³•ç³–">async/awaitè¯­æ³•ç³– &lt;a href="#asyncawait%e8%af%ad%e6%b3%95%e7%b3%96" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>async/awaitè¯­æ³•ç³–åœ¨C# 5.0ä¸­è¢«å¼•å…¥ï¼Œå…¶ç›®çš„æ˜¯ä¸ºäº†é¿å…å›è°ƒå¸¦æ¥çš„ä»£ç å¤æ‚åº¦ã€‚å°±åƒTwistedä¸­çš„&lt;code>@inlineCallbacks&lt;/code>ä¸€æ ·ï¼Œçœå»äº†deferå¤æ‚çš„å›è°ƒé“¾ã€‚&lt;/p>
&lt;p>&lt;code>await&lt;/code>ä¸­æœ‰ä¸€ä¸ª&amp;quot;wait&amp;quot;ï¼Œè¯´æ˜è¿™æ˜¯ä¸€ä¸ªâ€œç­‰å¾…â€æ“ä½œã€‚å®ƒç­‰å¾…çš„æ˜¯ç›¸åº”çš„Taskæ‰§è¡Œå®Œæˆã€‚&lt;/p>
&lt;p>æˆ‘ä»¬æ¥çœ‹ä¸€æ®µä»£ç ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cs" data-lang="cs">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">async&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> DumpWebPageAsync(&lt;span style="color:#66d9ef">string&lt;/span> uri)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> WebClient webClient = &lt;span style="color:#66d9ef">new&lt;/span> WebClient();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">string&lt;/span> page = &lt;span style="color:#66d9ef">await&lt;/span> webClient.DownloadStringTaskAsync(uri);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Console.WriteLine(page);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å½“ä»£ç æ‰§è¡Œåˆ°&lt;code>await&lt;/code>ä¸€è¡Œæ—¶ï¼Œå½“å‰å‡½æ•°ä¼šä¸»åŠ¨æ”¾å¼ƒå½“å‰çš„æ§åˆ¶æµã€‚å½“ä½¿ç”¨&lt;code>await&lt;/code>ä¿®é¥°çš„Taskå®Œæˆåï¼Œå½“å‰å‡½æ•°ä¼šä»ä¹‹å‰ä¸­æ–­çš„åœ°æ–¹ç»§ç»­æ‰§è¡Œã€‚&lt;/p>
&lt;p>è¿™æ ·åšçš„å¥½å¤„æ˜¯æˆ‘ä»¬å¯ä»¥å†™å‡ºå’ŒåŒæ­¥ç‰ˆæœ¬éå¸¸ç›¸ä¼¼çš„å¼‚æ­¥ä»£ç ï¼Œåªéœ€è¦åœ¨å¿…é¡»çš„åœ°æ–¹åŠ ä¸Š&lt;code>await&lt;/code>å…³é”®å­—ï¼Œæé†’ç¼–è¯‘å™¨è¿™é‡Œæ˜¯ä¸€ä¸ªå¼‚æ­¥å‡½æ•°ï¼Œéœ€è¦é¢å¤–çš„å¤„ç†é€»è¾‘ï¼Œä½†è¿™ä¸€åˆ‡éƒ½æ˜¯å¯¹å¼€å‘è€…é€æ˜çš„ã€‚&lt;/p>
&lt;h3 id="asyncawaitå¹²äº†ä»€ä¹ˆ">async/awaitå¹²äº†ä»€ä¹ˆ &lt;a href="#asyncawait%e5%b9%b2%e4%ba%86%e4%bb%80%e4%b9%88" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;p>æƒ³å¼„æ¸…æ¥šasync/awaitåˆ°åº•å¹²äº†ä»€ä¹ˆï¼Œé¦–å…ˆæˆ‘ä»¬è¦æƒ³æ˜ç™½çº¿ç¨‹åˆ°åº•æ˜¯ä»€ä¹ˆã€å¹²äº†ä»€ä¹ˆã€‚&lt;/p>
&lt;p>çº¿ç¨‹æ˜¯è¿›ç¨‹å†…ä¸€æ¡æ‰§è¡Œæµçš„çŠ¶æ€ï¼Œå…¶ä¸­åŒ…æ‹¬äº†ç¡¬ä»¶çŠ¶æ€ï¼ˆIPã€Registersç­‰ï¼‰ä»¥åŠå †æ ˆï¼ˆæ ˆä¸Šçš„å±€éƒ¨å˜é‡å’Œå †ä¸Šçš„è¿›ç¨‹çº§å†…å­˜ï¼‰ã€‚é‚£ä¹ˆå¦‚æœæˆ‘ä»¬æƒ³å®ç°æŒ‚èµ·/å¯åŠ¨ï¼ˆHibernating and Resumingï¼‰ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±è¦æœ‰ä¸€ä¸ªæœºåˆ¶æ¥ä¿å­˜å½“å‰çº¿ç¨‹çš„è¿è¡ŒçŠ¶æ€ã€‚&lt;/p>
&lt;p>æ‰€ä»¥å½“ä½ å†™ä¸‹äº†async/awaitå…³é”®å­—åï¼Œç¼–è¯‘å™¨åœ¨åé¢å¸®åŠ©ä½ ç”Ÿæˆäº†çŠ¶æ€ä¿å­˜å’Œæ¢å¤è¿è¡Œä¸Šä¸‹æ–‡çš„ä»£ç ã€‚&lt;/p>
&lt;h3 id="asyncawaitåˆ°åº•å¹²äº†ä»€ä¹ˆ">async/awaitåˆ°åº•å¹²äº†ä»€ä¹ˆ &lt;a href="#asyncawait%e5%88%b0%e5%ba%95%e5%b9%b2%e4%ba%86%e4%bb%80%e4%b9%88" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;p>æƒ³åƒæˆ‘ä»¬æœ‰ä¸€ä¸ªå¤æ‚çš„asyncå‡½æ•°ï¼Œé‡Œé¢æœ‰å¾ˆå¤šä¸ªawaitè°ƒç”¨ï¼Œé‚£å°±æ„å‘³ç€è¿™ä¸ªå‡½æ•°ä¸­ä¼šæœ‰å¤šæ¬¡æŒ‚èµ·/ç»§ç»­æ“ä½œã€‚åŒæ—¶æˆ‘ä»¬è¿˜è¦ç»´æŠ¤è¿™ä¸ªå‡½æ•°çš„çŠ¶æ€ã€‚å¦‚æœæˆ‘ä»¬æ˜¯è¿™ä¸ªè¯­æ³•ç³–çš„è®¾è®¡è€…ï¼Œæˆ‘ä»¬ä¼šé€‰æ‹©æ€ä¹ˆæ ·çš„æ‰‹æ®µæ¥å¤„ç†è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿ&lt;/p>
&lt;p>æ˜¯çš„ï¼ŒçŠ¶æ€æœºã€‚async/awaité¿å…äº†ä»£ç çš„ç¢ç‰‡åŒ–ï¼Œå®ƒçš„è§£å†³æ–¹æ¡ˆå¹¶ä¸æ˜¯æ¶ˆç­äº†å›è°ƒå‡½æ•°å’ŒContinuation Tasksï¼Œè€Œæ˜¯ä½¿ç”¨å·¥å…·ï¼ˆç¼–è¯‘å™¨ï¼‰æ¥å¸®åŠ©äººç±»è¿›è¡Œé‡å¤åŠ³åŠ¨ã€‚å½“asyncå‡½æ•°ä»æŒ‚èµ·ä¸­æ¢å¤æ—¶ï¼Œä¼šè°ƒç”¨&lt;code>MoveNext&lt;/code>å‡½æ•°ï¼ˆç›¸ä¿¡çœ‹è¿‡asyncå‡½æ•°é‚£ä¸€é•¿ä¸²çš„tracebackçš„åŒå­¦è‚¯å®šå¯¹è¿™ä¸ªå‡½æ•°éå¸¸çœ¼ç†Ÿï¼‰ï¼Œ&lt;code>MoveNext&lt;/code>å‡½æ•°ä¼šåœ¨asyncå‡½æ•°ç¬¬ä¸€æ¬¡è¢«è°ƒç”¨ä»¥åŠä»æŒ‚èµ·ä¸­æ¢å¤æ—¶è¢«è°ƒç”¨ã€‚çŠ¶æ€æœºä¿å­˜äº†å½“å‰å‡½æ•°çš„æ‰§è¡ŒçŠ¶æ€ï¼Œå½“&lt;code>MoveNext&lt;/code>å‡½æ•°è¢«è°ƒç”¨æ—¶ï¼Œä¼šæ ¹æ®å½“å‰çŠ¶æ€æ¥åˆ¤æ–­æ¥ä¸‹æ¥æ‰§è¡Œä»€ä¹ˆä»£ç ã€‚&lt;/p>
&lt;h3 id="asycnawaitåˆ°åº•tmdå¹²äº†ä»€ä¹ˆ">asycn/awaitåˆ°åº•TMDå¹²äº†ä»€ä¹ˆ &lt;a href="#asycnawait%e5%88%b0%e5%ba%95tmd%e5%b9%b2%e4%ba%86%e4%bb%80%e4%b9%88" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;p>ç”±äºasync/awaicè¯­æ³•ç³–æ˜¯åœ¨ç¼–è¯‘æœŸæ‰è¢«ç¿»è¯‘æˆç›¸åº”çš„ç¨‹åºä»£ç ï¼Œæ‰€ä»¥æˆ‘ä»¬åªèƒ½ä½¿ç”¨ILåç¼–è¯‘å™¨æ¥çª¥æ¢ç¼–è¯‘å™¨åˆ°åº•åšäº†æ€æ ·çš„å¤„ç†ä¸ä¼˜åŒ–ã€‚ä¸è¿‡åç¼–è¯‘å™¨ä½ æ‡‚å¾—ï¼Œç”Ÿæˆçš„ä»£ç åŸºæœ¬æ²¡æ³•çœ‹ï¼Œè®²è§£èµ·æ¥ä¹Ÿä¼šéå¸¸æ™¦æ¶©ã€‚&lt;/p>
&lt;p>å¹¸å¥½åœ¨99%çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¹¶ä¸éœ€è¦çŸ¥é“async/awaitæ˜¯æ€æ ·è¢«å±•å¼€çš„ã€‚å¦‚æœä½ ç¡®å®å¯¹è¿™ä¸ªé—®é¢˜æ„Ÿå…´è¶£ï¼Œå¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç« ï¼š&lt;a href="https://www.codeproject.com/Articles/535635/Async-Await-and-the-Generated-StateMachine">Async Await and the Generated StateMachine&lt;/a>ã€‚&lt;/p>
&lt;h2 id="å‡ ä¸ªå¸¸è§çš„å‘">å‡ ä¸ªå¸¸è§çš„å‘ &lt;a href="#%e5%87%a0%e4%b8%aa%e5%b8%b8%e8%a7%81%e7%9a%84%e5%9d%91" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;h3 id="await-ä¸-é”">await ä¸ é” &lt;a href="#await-%e4%b8%8e-%e9%94%81" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;p>ç”±äºawaitä¼šä¸­æ–­å½“å‰å‡½æ•°åœ¨å½“å‰çº¿ç¨‹çš„æ‰§è¡Œæµï¼Œå¹¶ä¸”å¯èƒ½åœ¨æ¢å¤æ—¶ï¼Œè¢«æŒ‡æ´¾åˆ°å¦å¤–çš„çº¿ç¨‹ã€‚æ‰€ä»¥å¯¹awaitåŠ é”æ˜æ˜¾æ˜¯å¤šæ­¤ä¸€ä¸¾çš„ã€‚å¹¶ä¸”å¦‚æœæ“ä½œä¸å½“ï¼Œè¿˜ä¼šé€ æˆæ­»é”ã€‚&lt;/p>
&lt;p>æ‰€ä»¥æˆ‘ä»¬åº”è¯¥æŠŠawaitæ”¾åˆ°åŠ é”çš„åŒºåŸŸå¤–ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cs" data-lang="cs">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">lock&lt;/span> (sync)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// Prepare for async operation&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">int&lt;/span> myNum = &lt;span style="color:#66d9ef">await&lt;/span> AlexsMethodAsync();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">lock&lt;/span> (sync)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// Use result of async operation&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="there-is-an--unfired-task-between-us">&amp;ldquo;There is an &amp;hellip; unfired Task between us&amp;rdquo; &lt;a href="#there-is-an--unfired-task-between-us" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;p>ä¸€ä¸ªasyncå‡½æ•°å¦‚æœè¿”å›çš„æ˜¯Taskï¼Œé‚£ä¹ˆå®ƒè¿”å›çš„ä¸€å®šæ˜¯ä¸€ä¸ªhot taskï¼Œå³å·²ç»è¢«å¯åŠ¨äº†çš„Taskã€‚&lt;/p>
&lt;p>å¹¶ä¸”awaitåªå¯èƒ½ç­‰å¾…ä¸€ä¸ªå¯åŠ¨äº†çš„Taskï¼Œå¦åˆ™awaitæ“ä½œå°†ä¼šhangä½ï¼Œç ´åç¨‹åºæ—¢å®šçš„æ‰§è¡Œæµã€‚&lt;/p>
&lt;h3 id="ä½¿ç”¨tpl-task-parallel-library">ä½¿ç”¨TPL (Task parallel library) &lt;a href="#%e4%bd%bf%e7%94%a8tpl-task-parallel-library" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;blockquote>
&lt;p>Async methods are synchronous util needed.&lt;/p>&lt;/blockquote>
&lt;p>å¦‚æœæˆ‘ä»¬æƒ³åŒæ—¶æ‰§è¡Œå‡ ä¸ªå¼‚æ­¥æ“ä½œï¼Œä½¿ç”¨foræ¥éå†æ‰§è¡Œå¯ä¸æ˜¯ä¸€ä¸ªå¥½ä¸»æ„ã€‚å› ä¸ºè¿™æ ·å‡½æ•°æ‰§è¡Œæµä»ç„¶æ˜¯é¡ºåºæ‰§è¡Œç›¸åº”çš„å‡½æ•°ã€‚&lt;/p>
&lt;p>TPLæä¾›äº†&lt;code>WhenAll&lt;/code>ã€&lt;code>WhenAny&lt;/code>ç­‰å‡½æ•°ï¼Œè®©æˆ‘ä»¬å¯ä»¥æœ‰å¼¹æ€§çš„å¹¶å‘æ‰§è¡ŒTaskã€‚&lt;/p>
&lt;p>å½“ç„¶æˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨PLINQï¼Œä¸è¿‡è¿™å°±æ˜¯å¦å¤–ä¸€ä¸ªè¯é¢˜äº†ã€‚&lt;/p>
&lt;h2 id="å‚è€ƒé“¾æ¥">å‚è€ƒé“¾æ¥ &lt;a href="#%e5%8f%82%e8%80%83%e9%93%be%e6%8e%a5" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;ul>
&lt;li>&lt;a href="https://www.codeproject.com/Articles/535635/Async-Await-and-the-Generated-StateMachine">Async Await and the Generated StateMachine&lt;/a>&lt;/li>
&lt;li>&lt;a href="http://blog.stephencleary.com/2012/07/async-interop-with-iasyncresult.html">Async Interop with IAsyncResult&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://msdn.microsoft.com/en-us/library/wewwczdw(v=vs.110).aspx">Event-based Asynchronous Pattern Overview&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.safaribooksonline.com/library/view/async-in-c/9781449337155/">Async in C# 5.0&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.safaribooksonline.com/library/view/essential-c-60/9780134176147/">Essential C# 6.0&lt;/a> Cpt18&lt;/li>
&lt;/ul></description></item><item><title>å†…å­˜å±éšœåˆæ¢</title><link>https://wizmann.top/posts/read-paper-barrier/</link><pubDate>Thu, 08 May 2014 19:05:26 +0000</pubDate><guid>https://wizmann.top/posts/read-paper-barrier/</guid><description>&lt;h2 id="åŸæ–‡åœ°å€">åŸæ–‡åœ°å€ &lt;a href="#%e5%8e%9f%e6%96%87%e5%9c%b0%e5%9d%80" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>&lt;a href="http://ridiculousfish.com/blog/posts/barrier.html">Barrier February 17th, 2007&lt;/a>&lt;/p>
&lt;h2 id="å‰è¨€å¤šæ ¸æ—¶ä»£çš„æŒ‘æˆ˜">å‰è¨€ï¼šå¤šæ ¸æ—¶ä»£çš„æŒ‘æˆ˜ &lt;a href="#%e5%89%8d%e8%a8%80%e5%a4%9a%e6%a0%b8%e6%97%b6%e4%bb%a3%e7%9a%84%e6%8c%91%e6%88%98" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>å°½ç®¡80æ ¸å¿ƒçš„æµ®ç‚¹è¿ç®—å·¨å…½ä»ç„¶é¥ä¸å¯åŠï¼Œå¤šæ ¸å¤„ç†å™¨çš„æ—¶ä»£å·²ç»åˆ°æ¥ã€‚å¤šæ ¸å¤„ç†å™¨çš„æ¦‚å¿µå¹¶éæ–°é²œäº‹ç‰©ï¼Œåœ¨Power Macintosh 9500ä¸­å°±å·²ç»é‡‡ç”¨äº†å¤šæ ¸å¤„ç†å™¨æŠ€æœ¯ã€‚ç°åœ¨ï¼Œè®©æˆ‘ä»¬æ·±å…¥ç†è§£å¤šæ ¸å¤„ç†å™¨çš„å†…åœ¨æœºåˆ¶ã€‚&lt;/p>
&lt;h2 id="çº¿ç¨‹æŠ€æœ¯æ¢è®¨">çº¿ç¨‹æŠ€æœ¯æ¢è®¨ &lt;a href="#%e7%ba%bf%e7%a8%8b%e6%8a%80%e6%9c%af%e6%8e%a2%e8%ae%a8" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;h3 id="åè¯è§£é‡Š">åè¯è§£é‡Š &lt;a href="#%e5%90%8d%e8%af%8d%e8%a7%a3%e9%87%8a" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;h4 id="çº¿ç¨‹">çº¿ç¨‹ &lt;a href="#%e7%ba%bf%e7%a8%8b" class="anchor">ğŸ”—&lt;/a>&lt;/h4>&lt;p>çº¿ç¨‹æ˜¯ä¸€ç§æ‹¥æœ‰å…±äº«åœ°å€ç©ºé—´çš„ã€èƒ½è¢«æŠ¢å å¼è°ƒåº¦çš„æ‰§è¡Œä¸Šä¸‹æ–‡ã€‚&lt;/p>
&lt;h4 id="å¤šçº¿ç¨‹">å¤šçº¿ç¨‹ &lt;a href="#%e5%a4%9a%e7%ba%bf%e7%a8%8b" class="anchor">ğŸ”—&lt;/a>&lt;/h4>&lt;p>å¤šçº¿ç¨‹æ˜¯ä¸€ç§ç”¨äºç®€åŒ–æ§åˆ¶æµã€ç»•è¿‡é˜»å¡ç³»ç»Ÿè°ƒç”¨çš„æ–¹æ³•ï¼Œå¹¶ä¸ä¸“é—¨ç”¨äºå®ç°ç¨‹åºçš„å¹¶è¡ŒåŒ–ã€‚&lt;/p>
&lt;h4 id="å¹¶å‘å¤šçº¿ç¨‹">å¹¶å‘å¤šçº¿ç¨‹ &lt;a href="#%e5%b9%b6%e5%8f%91%e5%a4%9a%e7%ba%bf%e7%a8%8b" class="anchor">ğŸ”—&lt;/a>&lt;/h4>&lt;p>ç‰©ç†ä¸Šå¹¶è¡Œæ‰§è¡Œçš„çº¿ç¨‹ï¼Œæ—¨åœ¨é€šè¿‡åˆ©ç”¨å¤šæ ¸å¤„ç†å™¨ä¼˜åŒ–ç³»ç»Ÿæ€§èƒ½ã€‚&lt;/p>
&lt;h3 id="å¹¶å‘å¤šçº¿ç¨‹çš„æŒ‘æˆ˜">â€œå¹¶å‘å¤šçº¿ç¨‹â€çš„æŒ‘æˆ˜ &lt;a href="#%e5%b9%b6%e5%8f%91%e5%a4%9a%e7%ba%bf%e7%a8%8b%e7%9a%84%e6%8c%91%e6%88%98" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;p>å°½ç®¡å¹¶å‘å¤šçº¿ç¨‹è¢«å¹¿æ³›è®¨è®ºï¼Œå…¶æŒ‘æˆ˜å¹¶éæºè‡ªè‡ªç„¶åŸå› ï¼Œè€Œæ˜¯æˆ‘ä»¬è‡ªå·±çš„è®¾è®¡é€‰æ‹©æ‰€é€ æˆçš„ã€‚ä¸»è¦é—®é¢˜åœ¨äºï¼Œé’ˆå¯¹å•çº¿ç¨‹ç¨‹åºçš„è¿‡åº¦ä¼˜åŒ–åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­ä¸å†é€‚ç”¨ã€‚&lt;/p>
&lt;p>å…·ä½“æ¥è¯´ï¼Œç”±äºCPUçš„æ‰§è¡Œé€Ÿåº¦è¿œè¶…å†…å­˜å“åº”é€Ÿåº¦ï¼Œæˆ‘ä»¬å¼€å§‹å¯¹å†…å­˜å†…å®¹è¿›è¡Œâ€œé¢„æµ‹â€ï¼Œä»è€Œé¿å…CPUç­‰å¾…å†…å­˜æ£€æŸ¥ã€‚è¿™é‡Œçš„â€œé¢„æµ‹â€å®é™…ä¸Šæ˜¯CPUå’Œç¼–è¯‘å™¨å¯¹å†…å­˜çŠ¶æ€åšå‡ºçš„è¶Šæ¥è¶Šæ¿€è¿›çš„å‡è®¾ã€‚&lt;/p>
&lt;h2 id="ç¤ºä¾‹åˆ†æ">ç¤ºä¾‹åˆ†æ &lt;a href="#%e7%a4%ba%e4%be%8b%e5%88%86%e6%9e%90" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;h3 id="å†™çº¿ç¨‹ç¤ºä¾‹">å†™çº¿ç¨‹ç¤ºä¾‹ &lt;a href="#%e5%86%99%e7%ba%bf%e7%a8%8b%e7%a4%ba%e4%be%8b" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// åˆå§‹æ—¶ variable1 = variable2 = 0;
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">while&lt;/span> (&lt;span style="color:#ae81ff">1&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> variable1&lt;span style="color:#f92672">++&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> variable2&lt;span style="color:#f92672">++&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="è¯»çº¿ç¨‹ç¤ºä¾‹">è¯»çº¿ç¨‹ç¤ºä¾‹ &lt;a href="#%e8%af%bb%e7%ba%bf%e7%a8%8b%e7%a4%ba%e4%be%8b" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">while&lt;/span> (&lt;span style="color:#ae81ff">1&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> local2 &lt;span style="color:#f92672">=&lt;/span> variable2;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> local1 &lt;span style="color:#f92672">=&lt;/span> variable1;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (local2 &lt;span style="color:#f92672">&amp;gt;&lt;/span> local1) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> print(&lt;span style="color:#e6db74">&amp;#34;Error!&amp;#34;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ­£å¸¸é€»è¾‘ä¸‹ï¼Œlocal2 åº”å½“å§‹ç»ˆå°äºæˆ–ç­‰äº local1ï¼Œå› ä¸º variable1 æ€»æ˜¯åœ¨ variable2 ä¹‹åå¢åŠ ã€‚&lt;/p>
&lt;p>ç„¶è€Œï¼Œç°å®æ˜¯å¦å¦‚æ­¤ï¼Ÿ&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;cstdio&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;iostream&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;ctime&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;pthread.h&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;sys/time.h&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;unistd.h&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">using&lt;/span> &lt;span style="color:#66d9ef">namespace&lt;/span> std;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">unsigned&lt;/span> variable1 &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">unsigned&lt;/span> variable2 &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#define ITERATIONS 200000000
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#a6e22e">writer&lt;/span>(&lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#f92672">*&lt;/span>unused) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">for&lt;/span> (;;) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> variable1 &lt;span style="color:#f92672">=&lt;/span> variable1 &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> variable2 &lt;span style="color:#f92672">=&lt;/span> variable2 &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> NULL;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#a6e22e">reader&lt;/span>(&lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#f92672">*&lt;/span>unused) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">struct&lt;/span> &lt;span style="color:#a6e22e">timeval&lt;/span> start, end;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> gettimeofday(&lt;span style="color:#f92672">&amp;amp;&lt;/span>start, NULL);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">unsigned&lt;/span> i, failureCount &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">for&lt;/span> (i&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>; i &lt;span style="color:#f92672">&amp;lt;&lt;/span> ITERATIONS; i&lt;span style="color:#f92672">++&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">unsigned&lt;/span> v2 &lt;span style="color:#f92672">=&lt;/span> variable2;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">unsigned&lt;/span> v1 &lt;span style="color:#f92672">=&lt;/span> variable1;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (v2 &lt;span style="color:#f92672">&amp;gt;&lt;/span> v1) failureCount&lt;span style="color:#f92672">++&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> gettimeofday(&lt;span style="color:#f92672">&amp;amp;&lt;/span>end, NULL);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">double&lt;/span> seconds &lt;span style="color:#f92672">=&lt;/span> end.tv_sec &lt;span style="color:#f92672">+&lt;/span> end.tv_usec &lt;span style="color:#f92672">/&lt;/span> &lt;span style="color:#ae81ff">1000000.&lt;/span> &lt;span style="color:#f92672">-&lt;/span> start.tv_sec &lt;span style="color:#f92672">-&lt;/span> start.tv_usec &lt;span style="color:#f92672">/&lt;/span> &lt;span style="color:#ae81ff">1000000.&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> printf(&lt;span style="color:#e6db74">&amp;#34;%u failure%s (%2.1f percent of the time) in %2.1f seconds&lt;/span>&lt;span style="color:#ae81ff">\n&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> failureCount, failureCount &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span> &lt;span style="color:#f92672">?&lt;/span> &lt;span style="color:#e6db74">&amp;#34;&amp;#34;&lt;/span> &lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#e6db74">&amp;#34;s&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> (&lt;span style="color:#ae81ff">100.&lt;/span> &lt;span style="color:#f92672">*&lt;/span> failureCount) &lt;span style="color:#f92672">/&lt;/span> ITERATIONS, seconds);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> exit(&lt;span style="color:#ae81ff">0&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> NULL;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">int&lt;/span> &lt;span style="color:#a6e22e">main&lt;/span>(&lt;span style="color:#66d9ef">void&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> pthread_t thread1, thread2;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> pthread_create(&lt;span style="color:#f92672">&amp;amp;&lt;/span>thread1, NULL, writer, NULL);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> pthread_create(&lt;span style="color:#f92672">&amp;amp;&lt;/span>thread2, NULL, reader, NULL);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">for&lt;/span> (;;) sleep(&lt;span style="color:#ae81ff">1000000&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¾“å‡ºç»“æœï¼š&lt;code>0 failures (0.0 percent of the time) in 1.2 seconds&lt;/code>&lt;/p>
&lt;h3 id="è²Œä¼¼æ˜¯æ­£ç¡®çš„">è²Œä¼¼æ˜¯æ­£ç¡®çš„ï¼Ÿ &lt;a href="#%e8%b2%8c%e4%bc%bc%e6%98%af%e6%ad%a3%e7%a1%ae%e7%9a%84" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;p>ç¨‹åºè¿è¡Œçš„æ­£å¦‚æˆ‘ä»¬é¢„æœŸçš„é‚£æ ·ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ç¡®ä¿¡ç¨‹åºæ˜¯ä¸€å®šæ­£ç¡®çš„å—ï¼Ÿ&lt;/p>
&lt;p>ä¸èƒ½ã€‚&lt;/p>
&lt;p>å› ä¸ºç¨‹åºä¸­çš„ä¸¤ä¸ªçº¿ç¨‹å¦‚æœåœ¨åŒä¸€ä¸ªCPUä¸Šè¢«è°ƒåº¦ï¼Œæˆ‘ä»¬æ°¸è¿œéƒ½ä¼šå¾—åˆ°æ­£ç¡®çš„ç»“æœã€‚&lt;/p>
&lt;h3 id="çº¿ç¨‹ä¸ä¸åŒçš„cpuè¿›è¡Œç»‘å®š">çº¿ç¨‹ä¸ä¸åŒçš„CPUè¿›è¡Œç»‘å®š &lt;a href="#%e7%ba%bf%e7%a8%8b%e4%b8%8e%e4%b8%8d%e5%90%8c%e7%9a%84cpu%e8%bf%9b%e8%a1%8c%e7%bb%91%e5%ae%9a" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#a6e22e">writer&lt;/span>(&lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#f92672">*&lt;/span>unused) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> cpu_set_t cpuset;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> CPU_ZERO(&lt;span style="color:#f92672">&amp;amp;&lt;/span>cpuset);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> CPU_SET(&lt;span style="color:#ae81ff">0&lt;/span>, &lt;span style="color:#f92672">&amp;amp;&lt;/span>cpuset);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> sched_setaffinity(&lt;span style="color:#ae81ff">0&lt;/span>, &lt;span style="color:#66d9ef">sizeof&lt;/span>(cpuset), &lt;span style="color:#f92672">&amp;amp;&lt;/span>cpuset);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#a6e22e">reader&lt;/span>(&lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#f92672">*&lt;/span>unused) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> cpu_set_t cpuset;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> CPU_ZERO(&lt;span style="color:#f92672">&amp;amp;&lt;/span>cpuset);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> CPU_SET(&lt;span style="color:#ae81ff">2&lt;/span>, &lt;span style="color:#f92672">&amp;amp;&lt;/span>cpuset);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> sched_setaffinity(&lt;span style="color:#ae81ff">0&lt;/span>, &lt;span style="color:#66d9ef">sizeof&lt;/span>(cpuset), &lt;span style="color:#f92672">&amp;amp;&lt;/span>cpuset);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// p.s. æˆ‘æœºå™¨æ˜¯i5åŒæ ¸å››çº¿ç¨‹ï¼Œæ‰€ä»¥ç»‘åœ¨äº†CPU0å’ŒCPU2ä¸Š
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç»“æœï¼š&lt;code>0 failures (0.0 percent of the time) in 1.4 seconds&lt;/code>&lt;/p>
&lt;h3 id="ä¼¼ä¹ä»ç„¶æ˜¯å‡†ç¡®çš„">ä¼¼ä¹ä»ç„¶æ˜¯å‡†ç¡®çš„ &lt;a href="#%e4%bc%bc%e4%b9%8e%e4%bb%8d%e7%84%b6%e6%98%af%e5%87%86%e7%a1%ae%e7%9a%84" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;p>å°½ç®¡å¦‚æ­¤ï¼Œæˆ‘ä»¬è€ƒè™‘åˆ°CPUå¯¹å˜é‡çš„æ“ä½œå…¶å®æ˜¯ä½œç”¨åœ¨å¯„å­˜å™¨ä¸Šï¼Œè€Œvariable1å’Œvariable2ç´§å¯†ç›¸é‚»ï¼Œè¿™å¯èƒ½å¯¼è‡´å®ƒä»¬ä½äºç¼“å­˜çš„åŒä¸€è¡Œã€‚å› æ­¤ï¼Œå®ƒä»¬æœ‰å¯èƒ½ä¼šåŒæ—¶è¢«å†™å…¥ç¼“å­˜å¹¶ä¸€èµ·å†™å›å†…å­˜ã€‚&lt;/p>
&lt;p>ä¸ºäº†è§‚å¯Ÿä¸åŒçš„æ•ˆæœï¼Œæˆ‘ä»¬å°è¯•å°†è¿™ä¸¤ä¸ªå˜é‡åˆ†åˆ«æ”¾ç½®åœ¨å †å’Œæ ˆä¸Šã€‚&lt;/p>
&lt;pre tabindex="0">&lt;code>0 failures (0.0 percent of the time) in 1.2 seconds
0 failures (0.0 percent of the time) in 1.2 seconds
2000000000 failures (100.0 percent of the time) in 1.2 seconds
&lt;/code>&lt;/pre>&lt;p>&lt;strong>å¤ªæ„Ÿäººäº†ï¼&lt;/strong>&lt;/p>
&lt;h3 id="æˆ‘ä»¬çš„æ•Œäºº--ç¼–è¯‘å™¨">æˆ‘ä»¬çš„æ•Œäºº â€”â€” ç¼–è¯‘å™¨ &lt;a href="#%e6%88%91%e4%bb%ac%e7%9a%84%e6%95%8c%e4%ba%ba--%e7%bc%96%e8%af%91%e5%99%a8" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;blockquote>
&lt;p>Multithreading bugs are very delicate.&lt;/p>&lt;/blockquote>
&lt;p>å¹¶è¡Œå¤šçº¿ç¨‹çš„é”™è¯¯æ€»æ˜¯é‚£ä¹ˆçš„å¥‡å¦™ï¼Œä¹Ÿè®¸ä½ çš„ç¨‹åºè¿è¡Œäº†å‡ å¤©å®‰ç„¶æ— æ™ï¼Œä½†æ˜¯åœ¨æŸä¸€å¤©æŸä¸€æ—¶çªç„¶å‡ºç°äº†éš¾ä»¥å¤ç°çš„ç²¾å¦™bugã€‚&lt;/p>
&lt;p>å¦‚æœå¤šä¸ªçº¿ç¨‹è°ƒåº¦åœ¨åŒä¸€ä¸ªCPUæ ¸å¿ƒä¸Šï¼ŒBugä¼šè¢«æ©ç›–ã€‚ &lt;br>
å¦‚æœå¤šä¸ªå˜é‡åœ¨CPUåŒä¸€è¡ŒCacheä¸Šï¼ŒBugä¼šè¢«æ©ç›–ã€‚ &lt;br>
å¦‚æœä½ äººå“è¶³å¤Ÿå¥½çš„è¯ï¼ŒBugåŒæ ·ä¼šè¢«æ©ç›–ã€‚&lt;/p>
&lt;p>ä½†æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬æ’é™¤äº†ä»¥ä¸Šçš„æƒ…å†µåï¼Œé—®é¢˜å°±æµ®ç°å‡ºæ¥äº†ã€‚&lt;/p>
&lt;p>æˆ‘ä»¬æ¥çœ‹ä¸€çœ‹readerçš„åæ±‡ç¼–ä»£ç ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>(gdb) disas reader
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Dump of assembler code &lt;span style="color:#66d9ef">for&lt;/span> function reader(&lt;span style="color:#66d9ef">void&lt;/span>&lt;span style="color:#f92672">*&lt;/span>)&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x0000000000400950&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> push &lt;span style="color:#f92672">%&lt;/span>rbx
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x0000000000400951&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> xor &lt;span style="color:#f92672">%&lt;/span>eax,&lt;span style="color:#f92672">%&lt;/span>eax
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x0000000000400953&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">3&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> mov &lt;span style="color:#960050;background-color:#1e0010">$&lt;/span>&lt;span style="color:#ae81ff">0x10&lt;/span>,&lt;span style="color:#f92672">%&lt;/span>ecx
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x0000000000400958&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">8&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> mov &lt;span style="color:#960050;background-color:#1e0010">$&lt;/span>&lt;span style="color:#ae81ff">0x80&lt;/span>,&lt;span style="color:#f92672">%&lt;/span>esi
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x000000000040095d&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">13&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> xor &lt;span style="color:#f92672">%&lt;/span>ebx,&lt;span style="color:#f92672">%&lt;/span>ebx
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x000000000040095f&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">15&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> sub &lt;span style="color:#960050;background-color:#1e0010">$&lt;/span>&lt;span style="color:#ae81ff">0xa0&lt;/span>,&lt;span style="color:#f92672">%&lt;/span>rsp
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x0000000000400966&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">22&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> mov &lt;span style="color:#f92672">%&lt;/span>rsp,&lt;span style="color:#f92672">%&lt;/span>rdi
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x0000000000400969&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">25&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> mov &lt;span style="color:#f92672">%&lt;/span>rsp,&lt;span style="color:#f92672">%&lt;/span>rdx
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x000000000040096c&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">28&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> rep stos &lt;span style="color:#f92672">%&lt;/span>rax,&lt;span style="color:#f92672">%&lt;/span>es:(&lt;span style="color:#f92672">%&lt;/span>rdi)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x000000000040096f&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">31&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> xor &lt;span style="color:#f92672">%&lt;/span>edi,&lt;span style="color:#f92672">%&lt;/span>edi
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x0000000000400971&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">33&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> movq &lt;span style="color:#960050;background-color:#1e0010">$&lt;/span>&lt;span style="color:#ae81ff">0x4&lt;/span>,(&lt;span style="color:#f92672">%&lt;/span>rsp)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x0000000000400979&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">41&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> callq &lt;span style="color:#ae81ff">0x400790&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span>sched_setaffinity&lt;span style="color:#960050;background-color:#1e0010">@&lt;/span>plt&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x000000000040097e&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">46&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> lea &lt;span style="color:#ae81ff">0x80&lt;/span>(&lt;span style="color:#f92672">%&lt;/span>rsp),&lt;span style="color:#f92672">%&lt;/span>rdi
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x0000000000400986&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">54&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> xor &lt;span style="color:#f92672">%&lt;/span>esi,&lt;span style="color:#f92672">%&lt;/span>esi
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x0000000000400988&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">56&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> callq &lt;span style="color:#ae81ff">0x400710&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span>gettimeofday&lt;span style="color:#960050;background-color:#1e0010">@&lt;/span>plt&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x000000000040098d&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">61&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> mov &lt;span style="color:#ae81ff">0x2006e4&lt;/span>(&lt;span style="color:#f92672">%&lt;/span>rip),&lt;span style="color:#f92672">%&lt;/span>rax &lt;span style="color:#960050;background-color:#1e0010">#&lt;/span> &lt;span style="color:#ae81ff">0x601078&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span>variable2_p&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x0000000000400994&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">68&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> mov &lt;span style="color:#ae81ff">0x2006e6&lt;/span>(&lt;span style="color:#f92672">%&lt;/span>rip),&lt;span style="color:#f92672">%&lt;/span>edx &lt;span style="color:#960050;background-color:#1e0010">#&lt;/span> &lt;span style="color:#ae81ff">0x601080&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span>variable1&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x000000000040099a&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">74&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> mov (&lt;span style="color:#f92672">%&lt;/span>rax),&lt;span style="color:#f92672">%&lt;/span>ecx
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x000000000040099c&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">76&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> mov &lt;span style="color:#960050;background-color:#1e0010">$&lt;/span>&lt;span style="color:#ae81ff">0x77359400&lt;/span>,&lt;span style="color:#f92672">%&lt;/span>eax
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x00000000004009a1&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">81&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> nopl &lt;span style="color:#ae81ff">0x0&lt;/span>(&lt;span style="color:#f92672">%&lt;/span>rax)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x00000000004009a8&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">88&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> cmp &lt;span style="color:#f92672">%&lt;/span>ecx,&lt;span style="color:#f92672">%&lt;/span>edx
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x00000000004009aa&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">90&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> adc &lt;span style="color:#960050;background-color:#1e0010">$&lt;/span>&lt;span style="color:#ae81ff">0x0&lt;/span>,&lt;span style="color:#f92672">%&lt;/span>ebx
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x00000000004009ad&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">93&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> sub &lt;span style="color:#960050;background-color:#1e0010">$&lt;/span>&lt;span style="color:#ae81ff">0x1&lt;/span>,&lt;span style="color:#f92672">%&lt;/span>eax
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x00000000004009b0&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">96&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> jne &lt;span style="color:#ae81ff">0x4009a8&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span>reader(&lt;span style="color:#66d9ef">void&lt;/span>&lt;span style="color:#f92672">*&lt;/span>)&lt;span style="color:#f92672">+&lt;/span>&lt;span style="color:#ae81ff">88&lt;/span>&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x00000000004009b2&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">98&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> lea &lt;span style="color:#ae81ff">0x90&lt;/span>(&lt;span style="color:#f92672">%&lt;/span>rsp),&lt;span style="color:#f92672">%&lt;/span>rdi
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x00000000004009ba&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">106&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> xor &lt;span style="color:#f92672">%&lt;/span>esi,&lt;span style="color:#f92672">%&lt;/span>esi
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x00000000004009bc&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">108&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> callq &lt;span style="color:#ae81ff">0x400710&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span>gettimeofday&lt;span style="color:#960050;background-color:#1e0010">@&lt;/span>plt&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x00000000004009c1&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">113&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> cvtsi2sdq &lt;span style="color:#ae81ff">0x98&lt;/span>(&lt;span style="color:#f92672">%&lt;/span>rsp),&lt;span style="color:#f92672">%&lt;/span>xmm0
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x00000000004009cb&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">123&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> cvtsi2sdq &lt;span style="color:#ae81ff">0x90&lt;/span>(&lt;span style="color:#f92672">%&lt;/span>rsp),&lt;span style="color:#f92672">%&lt;/span>xmm1
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x00000000004009d5&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">133&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> movsd &lt;span style="color:#ae81ff">0x1a3&lt;/span>(&lt;span style="color:#f92672">%&lt;/span>rip),&lt;span style="color:#f92672">%&lt;/span>xmm3 &lt;span style="color:#960050;background-color:#1e0010">#&lt;/span> &lt;span style="color:#ae81ff">0x400b80&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x00000000004009dd&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">141&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> mov &lt;span style="color:#f92672">%&lt;/span>ebx,&lt;span style="color:#f92672">%&lt;/span>eax
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x00000000004009df&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">143&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> cvtsi2sdq &lt;span style="color:#ae81ff">0x88&lt;/span>(&lt;span style="color:#f92672">%&lt;/span>rsp),&lt;span style="color:#f92672">%&lt;/span>xmm2
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x00000000004009e9&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">153&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> cmp &lt;span style="color:#960050;background-color:#1e0010">$&lt;/span>&lt;span style="color:#ae81ff">0x1&lt;/span>,&lt;span style="color:#f92672">%&lt;/span>ebx
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x00000000004009ec&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">156&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> mov &lt;span style="color:#960050;background-color:#1e0010">$&lt;/span>&lt;span style="color:#ae81ff">0x400b3d&lt;/span>,&lt;span style="color:#f92672">%&lt;/span>ecx
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x00000000004009f1&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">161&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> mov &lt;span style="color:#960050;background-color:#1e0010">$&lt;/span>&lt;span style="color:#ae81ff">0x1&lt;/span>,&lt;span style="color:#f92672">%&lt;/span>edi
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x00000000004009f6&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">166&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> divsd &lt;span style="color:#f92672">%&lt;/span>xmm3,&lt;span style="color:#f92672">%&lt;/span>xmm0
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x00000000004009fa&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">170&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> mov &lt;span style="color:#f92672">%&lt;/span>ebx,&lt;span style="color:#f92672">%&lt;/span>edx
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x00000000004009fc&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">172&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> mov &lt;span style="color:#960050;background-color:#1e0010">$&lt;/span>&lt;span style="color:#ae81ff">0x400b40&lt;/span>,&lt;span style="color:#f92672">%&lt;/span>esi
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x0000000000400a01&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">177&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> divsd &lt;span style="color:#f92672">%&lt;/span>xmm3,&lt;span style="color:#f92672">%&lt;/span>xmm2
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x0000000000400a05&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">181&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> addsd &lt;span style="color:#f92672">%&lt;/span>xmm0,&lt;span style="color:#f92672">%&lt;/span>xmm1
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x0000000000400a09&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">185&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> cvtsi2sdq &lt;span style="color:#ae81ff">0x80&lt;/span>(&lt;span style="color:#f92672">%&lt;/span>rsp),&lt;span style="color:#f92672">%&lt;/span>xmm0
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x0000000000400a13&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">195&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> subsd &lt;span style="color:#f92672">%&lt;/span>xmm0,&lt;span style="color:#f92672">%&lt;/span>xmm1
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x0000000000400a17&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">199&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> cvtsi2sd &lt;span style="color:#f92672">%&lt;/span>rax,&lt;span style="color:#f92672">%&lt;/span>xmm0
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x0000000000400a1c&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">204&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> mov &lt;span style="color:#960050;background-color:#1e0010">$&lt;/span>&lt;span style="color:#ae81ff">0x400b3c&lt;/span>,&lt;span style="color:#f92672">%&lt;/span>eax
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x0000000000400a21&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">209&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> cmovne &lt;span style="color:#f92672">%&lt;/span>rax,&lt;span style="color:#f92672">%&lt;/span>rcx
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x0000000000400a25&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">213&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> mov &lt;span style="color:#960050;background-color:#1e0010">$&lt;/span>&lt;span style="color:#ae81ff">0x2&lt;/span>,&lt;span style="color:#f92672">%&lt;/span>eax
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x0000000000400a2a&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">218&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> mulsd &lt;span style="color:#ae81ff">0x156&lt;/span>(&lt;span style="color:#f92672">%&lt;/span>rip),&lt;span style="color:#f92672">%&lt;/span>xmm0 &lt;span style="color:#960050;background-color:#1e0010">#&lt;/span> &lt;span style="color:#ae81ff">0x400b88&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x0000000000400a32&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">226&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> subsd &lt;span style="color:#f92672">%&lt;/span>xmm2,&lt;span style="color:#f92672">%&lt;/span>xmm1
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x0000000000400a36&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">230&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> divsd &lt;span style="color:#ae81ff">0x152&lt;/span>(&lt;span style="color:#f92672">%&lt;/span>rip),&lt;span style="color:#f92672">%&lt;/span>xmm0 &lt;span style="color:#960050;background-color:#1e0010">#&lt;/span> &lt;span style="color:#ae81ff">0x400b90&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x0000000000400a3e&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">238&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> callq &lt;span style="color:#ae81ff">0x400700&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span>__printf_chk&lt;span style="color:#960050;background-color:#1e0010">@&lt;/span>plt&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x0000000000400a43&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">243&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> xor &lt;span style="color:#f92672">%&lt;/span>edi,&lt;span style="color:#f92672">%&lt;/span>edi
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x0000000000400a45&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">245&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> callq &lt;span style="color:#ae81ff">0x4006f0&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span>exit&lt;span style="color:#960050;background-color:#1e0010">@&lt;/span>plt&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç®€è€Œè¨€ä¹‹ï¼Œå…³é”®åœ¨ä»¥ä¸‹å‡ å¥ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">0x000000000040098d&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">61&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> mov &lt;span style="color:#ae81ff">0x2006e4&lt;/span>(&lt;span style="color:#f92672">%&lt;/span>rip),&lt;span style="color:#f92672">%&lt;/span>rax &lt;span style="color:#960050;background-color:#1e0010">#&lt;/span> &lt;span style="color:#ae81ff">0x601078&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span>variable2_p&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">0x0000000000400994&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">68&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> mov &lt;span style="color:#ae81ff">0x2006e6&lt;/span>(&lt;span style="color:#f92672">%&lt;/span>rip),&lt;span style="color:#f92672">%&lt;/span>edx &lt;span style="color:#960050;background-color:#1e0010">#&lt;/span> &lt;span style="color:#ae81ff">0x601080&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span>variable1&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">0x000000000040099a&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">74&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> mov (&lt;span style="color:#f92672">%&lt;/span>rax),&lt;span style="color:#f92672">%&lt;/span>ecx
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">0x000000000040099c&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">76&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> mov &lt;span style="color:#960050;background-color:#1e0010">$&lt;/span>&lt;span style="color:#ae81ff">0x77359400&lt;/span>,&lt;span style="color:#f92672">%&lt;/span>eax
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">0x00000000004009a1&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">81&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> nopl &lt;span style="color:#ae81ff">0x0&lt;/span>(&lt;span style="color:#f92672">%&lt;/span>rax)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">0x00000000004009a8&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">88&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> cmp &lt;span style="color:#f92672">%&lt;/span>ecx,&lt;span style="color:#f92672">%&lt;/span>edx
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">0x00000000004009aa&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">90&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> adc &lt;span style="color:#960050;background-color:#1e0010">$&lt;/span>&lt;span style="color:#ae81ff">0x0&lt;/span>,&lt;span style="color:#f92672">%&lt;/span>ebx
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">0x00000000004009ad&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">93&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> sub &lt;span style="color:#960050;background-color:#1e0010">$&lt;/span>&lt;span style="color:#ae81ff">0x1&lt;/span>,&lt;span style="color:#f92672">%&lt;/span>eax
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">0x00000000004009b0&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">96&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> jne &lt;span style="color:#ae81ff">0x4009a8&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span>reader(&lt;span style="color:#66d9ef">void&lt;/span>&lt;span style="color:#f92672">*&lt;/span>)&lt;span style="color:#f92672">+&lt;/span>&lt;span style="color:#ae81ff">88&lt;/span>&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œå¾ªç¯ä½“åœ¨+88ï½+96è¡Œï¼Œè€Œå¯¹variable1ä¸variable2çš„å–å€¼éƒ½æ”¾åœ¨äº†å¾ªç¯ä»¥å¤–ã€‚&lt;/p>
&lt;blockquote>
&lt;p>æ³¨ï¼š&lt;br>
adcæ˜¯å¸¦è¿›ä½åŠ æ³•ï¼Œadc $0x0, %ebx =&amp;gt; %ebx = $0x0 + %ebx + CF &lt;br>
cmpçš„ç»“æœæ­£æ˜¯æ”¾åœ¨CFï¼ˆå¤§äºè¡¨ç¤ºä¸ºæº¢å‡ºï¼‰ï¼ŒZFï¼ˆç›¸ç­‰è¡¨ç¤ºä¸º0ï¼‰ï¼ŒPFï¼ˆå°äºè¡¨ç¤ºä¸º-1,åˆ™ä½8ä½å…¨ä¸º1,æ•…æœ‰å¶æ•°ä¸ª1ï¼‰&lt;/p>&lt;/blockquote>
&lt;p>æ­£æ˜¯è¿™ä¸ªâ€œå°æ„å¤–â€ï¼Œå¯¼è‡´äº†æˆ‘ä»¬çš„ç»“æœè¦ä¸æ˜¯100%æ­£ç¡®ï¼Œè¦ä¸æ˜¯100%é”™è¯¯ã€‚&lt;/p>
&lt;h4 id="ä½¿ç”¨volitile">ä½¿ç”¨volitileï¼ˆï¼Ÿï¼‰ &lt;a href="#%e4%bd%bf%e7%94%a8volitile" class="anchor">ğŸ”—&lt;/a>&lt;/h4>&lt;p>è®©æˆ‘ä»¬ä¿®æ”¹ä¸€ä¸‹ä»£ç ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">volatile&lt;/span> &lt;span style="color:#66d9ef">unsigned&lt;/span> variable1 &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">volatile&lt;/span> &lt;span style="color:#66d9ef">unsigned&lt;/span> &lt;span style="color:#f92672">*&lt;/span>variable2_p &lt;span style="color:#f92672">=&lt;/span> NULL;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#define ITERATIONS 500000000LL &lt;/span>&lt;span style="color:#75715e">// è°ƒå°ä¸€ä¸‹æ•°æ®è§„æ¨¡ï¼Œå› ä¸ºvolatileå¤ªæ…¢äº†_(:Ğ·ã€âˆ )_
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æˆ‘å¾—å‡ºçš„æ¥çš„ç»“æœæ˜¯ï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code>0 failures (0.0 percent of the time) in 9.6 seconds
&lt;/code>&lt;/pre>&lt;p>è€Œä½œè€…å¾—å‡ºçš„ç»“æœæ˜¯ï¼š
ï¼ˆæ—¶é—´ä¸Šçš„å·®å¼‚ä¸è®¡ï¼Œå› ä¸ºæˆ‘ä»¬çš„æ•°æ®è§„æ¨¡ä¸ä¸€æ ·ï¼Œæˆ‘å®éªŒçš„æ¬¡æ•°è¦å¤šä¸€äº›ã€‚&lt;/p>
&lt;pre tabindex="0">&lt;code>fish ) ./a.out
12462711 failures (24.9 percent of the time) in 3.7 seconds
&lt;/code>&lt;/pre>&lt;p>ä»ä½œè€…çš„ç»“æœæ¥çœ‹ï¼Œçœ‹èµ·æ¥æ•ˆæœå¥½äº†å¾ˆå¤šï¼Œè™½ç„¶æ…¢äº†30å¤šå€ï¼Œä½†æ˜¯ç»“æœå¹¶ä¸æ˜¯å…¨å¯¹å…¨é”™äº†ã€‚&lt;/p>
&lt;p>è€Œä»æˆ‘çš„ç»“æœæ¥çœ‹ï¼Œvolatileçœ‹ä¼¼ç¥ä¸¹å¦™è¯ï¼Œè§£å†³äº†æ‰€æœ‰çš„é—®é¢˜ã€‚(both g++ and clang++)&lt;/p>
&lt;p>&lt;strong>è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢?&lt;/strong>&lt;/p>
&lt;p>å…¶åŸå› åœ¨äºä½“ç³»ç»“æ„çš„å·®å¼‚ã€‚volatileåªèƒ½ä¿è¯å¦‚ä¸‹ä¸¤ç‚¹ï¼š&lt;/p>
&lt;ul>
&lt;li>volatileå˜é‡çš„è®¿é—®ä¸ä¼šä¼˜åŒ–æˆå¯„å­˜å™¨è®¿é—®ï¼Œè€Œæ˜¯æ¯æ¬¡éƒ½å»è®¿é—®â€œå†…å­˜â€ï¼ˆè¿™ä¸ªå¼•å·ä¸€ä¼šå†è§£é‡Šï¼‰&lt;/li>
&lt;li>volatileå˜é‡é—´çš„è®¿é—®é¡ºåºä¸ä¼šè¢«ç¼–è¯‘å™¨ä¹±åº&lt;/li>
&lt;/ul>
&lt;p>è€Œå…¶ä»–çš„ä¸€åˆ‡ï¼Œvolatileå’Œç¼–è¯‘å™¨éƒ½ä¸ä¼šç»™å‡ºä»»ä½•ä¿è¯ã€‚&lt;/p>
&lt;p>ä¾‹å¦‚ï¼Œä¸åŒçš„CPUéƒ½æœ‰å…¶å†…éƒ¨çš„ç§æœ‰Cacheï¼ŒCPUçš„å†…å­˜è®¿é—®ï¼Œå¦‚æœå‘½ä¸­äº†Cacheï¼Œåˆ™ä¸ä¼šçœŸæ­£çš„è®¿é—®å†…å­˜ã€‚ä½†ç”±äºå…¶ç§æœ‰Cacheå¯¹äºå…¶å®ƒçš„CPUæ˜¯ä¸å¯è§çš„ï¼Œä½¿ç”¨volatileå°±åŸ‹ä¸‹çš„Bugçš„ç§å­ã€‚&lt;/p>
&lt;p>è™½ç„¶åœ¨æˆ‘ä»¬çš„å®éªŒä¸­ï¼Œç¨‹åºè¿è¡Œçš„å¾ˆå¥½ï¼Œæ²¡æœ‰å‡ºç°Bugã€‚ä½†æ˜¯ï¼Œä¸€æ˜¯ç”±äºå¤šçº¿ç¨‹çš„Bugéƒ½æ˜¯subtleå’Œdelicateçš„ï¼Œæˆ‘ä¸èƒ½ä¿è¯åœ¨ä¸€ä¸ªéœ€è¦7x24å·¥ä½œçš„æœåŠ¡å™¨ç¨‹åºä¸­ï¼Œå®ƒä¸ä¼šå‡ºç°ä»»ä½•Bugï¼›äºŒæ˜¯è‡³å°‘æˆ‘ä»¬çš„ä»£ç æ˜¯** not portable **çš„ï¼Œå¦‚æœæœ‰ä¸€å¤©ï¼Œæˆ‘ä»¬ä»x86-64å¹³å°åˆ‡æ¢åˆ°äº†&lt;code>PowerPC&lt;/code>ï¼Ÿæˆ–æ˜¯&lt;code>IA64&lt;/code>ï¼Ÿæˆ‘ä»¬ä¸èƒ½ä¿è¯åœ¨è¿™äº›ä½“ç³»ç»“æ„ä¸Šï¼Œç¼–è¯‘å™¨å’ŒCPUèƒ½ä¸ºæˆ‘ä»¬æä¾›åŒæ ·çš„ä¿éšœã€‚&lt;/p>
&lt;p>äºæ˜¯æœ‰äººé«˜å£°ç–¾å‘¼ï¼š volatileä¸èƒ½ç”¨æ¥åšä¸ºå¤šçº¿ç¨‹çš„åŒæ­¥æœºåˆ¶ï¼&lt;/p>
&lt;blockquote>
&lt;p>è¡¥å……äº20240317ï¼šåœ¨ä¸€å°è€æ—§çš„å®‰å“æ‰‹æœºä¸Šé‡å¤äº†å®éªŒï¼Œvolatileç¡®å®æ— æ³•æä¾›ç›¸å…³çš„ä¿éšœ&lt;/p>&lt;/blockquote>
&lt;pre tabindex="0">&lt;code>~/tmp $ clang++ -O2 a.cc &amp;amp;&amp;amp; ./a.out
99880586 failures (49.9 percent of the time) in 3.0 seconds
&lt;/code>&lt;/pre>&lt;h4 id="å°å¿ƒcpuçš„è¡Œä¸º">å°å¿ƒCPUçš„è¡Œä¸º &lt;a href="#%e5%b0%8f%e5%bf%83cpu%e7%9a%84%e8%a1%8c%e4%b8%ba" class="anchor">ğŸ”—&lt;/a>&lt;/h4>&lt;p>åœ¨å…ˆå‰çš„å®éªŒä¸­ï¼Œå°½ç®¡ç¨‹åºçš„è¡¨ç°ä¸é¢„æœŸä¸€è‡´ï¼Œä½†æˆ‘ä»¬æ— æ³•ç¡®ä¿CPUå°†å§‹ç»ˆæŒ‰é¡ºåºæ‰§è¡Œä»£ç ã€‚å®é™…ä¸Šï¼ŒCPUå¯èƒ½ä¼šå¯¹æ“ä½œé¡ºåºè¿›è¡Œä¼˜åŒ–ï¼Œä¾‹å¦‚ï¼Œå°†var1++å’Œvar2++çš„æ‰§è¡Œé¡ºåºè°ƒæ¢ï¼Œè¿™åœ¨å½“å‰ä¸»æµçš„CPUä¸­æ˜¯å¸¸è§çš„åšæ³•ã€‚&lt;/p>
&lt;p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œç”±äºä¹±åºæ‰§è¡Œä¼šå¯¼è‡´åŠŸè€—å¢åŠ ï¼ŒæŸäº›å¤„ç†å™¨å¦‚ARMå’ŒIntel Atomå·²ç»å–æ¶ˆäº†è¿™ä¸€æœºåˆ¶ã€‚ç„¶è€Œï¼Œæˆ‘ä»¬æ— æ³•é¢„çŸ¥æœªæ¥ä»£ç å¯èƒ½ä¼šåœ¨å“ªç§ç¡¬ä»¶æ¶æ„ä¸Šè¿è¡Œï¼Œä¾‹å¦‚ARMé›†ç¾¤ï¼Œè¿™éœ€è¦æˆ‘ä»¬ä¿æŒè­¦æƒ•ã€‚&lt;/p>
&lt;h4 id="é¿å…ä½¿ç”¨é”">é¿å…ä½¿ç”¨é” &lt;a href="#%e9%81%bf%e5%85%8d%e4%bd%bf%e7%94%a8%e9%94%81" class="anchor">ğŸ”—&lt;/a>&lt;/h4>&lt;p>é€šå¸¸æƒ…å†µä¸‹ï¼Œé€šè¿‡å¼•å…¥äº’æ–¥é”ï¼ˆmutexï¼‰ä¼¼ä¹èƒ½å¤Ÿè§£å†³å¹¶å‘é—®é¢˜ã€‚ç„¶è€Œï¼Œæ ¹æ®ä½œè€…çš„æµ‹è¯•ï¼Œå¼•å…¥äº’æ–¥é”å¯èƒ½ä¼šå¯¼è‡´ç¨‹åºé€Ÿåº¦é™ä½è‡³åŸæ¥çš„1/130ï¼Œè€Œè‡ªæ—‹é”ï¼ˆspinlockï¼‰ä¹Ÿå¯èƒ½ä½¿å¾—é€Ÿåº¦é™ä½è‡³åŸæ¥çš„1/4ã€‚&lt;/p>
&lt;p>å› æ­¤ï¼Œæˆ‘ä»¬åº”è¯¥æš‚ç¼“ï¼Œä»”ç»†è€ƒè™‘ä½œè€…æ¥ä¸‹æ¥çš„å»ºè®®ã€‚&lt;/p>
&lt;h3 id="å†…å­˜å±éšœçš„åº”ç”¨">å†…å­˜å±éšœçš„åº”ç”¨ &lt;a href="#%e5%86%85%e5%ad%98%e5%b1%8f%e9%9a%9c%e7%9a%84%e5%ba%94%e7%94%a8" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;p>åœ¨å¤šCPUç¯å¢ƒä¸­ï¼Œå¤„ç†å™¨å¾€å¾€ç‹¬ç«‹è¿è¡Œï¼Œä¸ä¼šåè°ƒå½¼æ­¤çš„æ“ä½œã€‚&lt;/p>
&lt;p>ç›®å‰ï¼Œæˆ‘ä»¬é¢ä¸´ä¸¤ä¸ªå¹¶ä¸ç†æƒ³çš„è§£å†³æ–¹æ¡ˆï¼šä¸€æ˜¯å°†æ‰€æœ‰çº¿ç¨‹é™åˆ¶åœ¨å•ä¸ªCPUä¸Šè¿è¡Œï¼ŒäºŒæ˜¯é€šè¿‡å¼•å…¥é‡é‡çº§é”æ¥åŒæ­¥æ“ä½œã€‚è¿™äº›æ–¹æ³•éƒ½ä¸å°½äººæ„ï¼Œä¸”æ•ˆç‡ä½ä¸‹ã€‚&lt;/p>
&lt;p>å®é™…ä¸Šï¼Œæˆ‘ä»¬éœ€è¦åšçš„æ˜¯ï¼Œé€šè¿‡å†…å­˜å±éšœæŠ€æœ¯ï¼Œæš‚æ—¶é˜»æ­¢ç¼–è¯‘å™¨æˆ–CPUå¯¹ç¨‹åºä¸­çš„æ•°æ®è¯»å†™æ“ä½œè¿›è¡Œé‡æ’åºã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">for&lt;/span> (;;) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> variable1 &lt;span style="color:#f92672">=&lt;/span> variable1 &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> barrier();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">*&lt;/span>variable2 &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#f92672">*&lt;/span>variable2 &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™æ ·æˆ‘ä»¬ä¿è¯äº†ï¼Œåœ¨var1++å¿…ç„¶æ—©äºvar2++ã€‚var2++åé¢ä¹Ÿå¯ä»¥åŠ ä¸€é“barrierï¼Œåªä¸è¿‡åœ¨æˆ‘ä»¬çš„åœºæ™¯ä¸‹ï¼Œæä¾›è¿™ç§ä¿è¯æ˜¯ä¸å¿…é¡»çš„ã€‚&lt;/p>
&lt;p>ä½œè€…åˆåšäº†ä¸€æ¬¡è¯•éªŒã€‚&lt;/p>
&lt;pre tabindex="0">&lt;code>fish ) ./a.out
260 failures (0.0 percent of the time) in 0.9 seconds
&lt;/code>&lt;/pre>&lt;p>è¿™æ¬¡ä¸”é”™è¯¯å‡å°‘äº†è®¸å¤šã€‚&lt;/p>
&lt;p>æˆ‘ä»¬å†æŠŠè¯»çº¿ç¨‹å†™åŠ ä¸Šmemory barrier.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">for&lt;/span> (i&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>; i &lt;span style="color:#f92672">&amp;lt;&lt;/span> ITERATIONS; i&lt;span style="color:#f92672">++&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">unsigned&lt;/span> v2 &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#f92672">*&lt;/span>variable2;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> barrier();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">unsigned&lt;/span> v1 &lt;span style="color:#f92672">=&lt;/span> variable1;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (v2 &lt;span style="color:#f92672">&amp;gt;&lt;/span> v1) failureCount&lt;span style="color:#f92672">++&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>çœ‹çœ‹ç»“æœï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code>fish ) ./a.out
0 failures (0.0 percent of the time) in 4.2 seconds
&lt;/code>&lt;/pre>&lt;p>ç¨‹åºè¡¨ç°å‡ºäº†æ­£ç¡®çš„ç»“æœã€‚&lt;/p>
&lt;p>æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œå¦‚æœä½ å¯¹çº¿ç¨‹Açš„è¯»å†™é¡ºåºåšå‡ºè¦æ±‚ï¼Œå¿…ç„¶çš„ï¼Œä½ ä¹Ÿè¦å¯¹çº¿ç¨‹Bçš„é¡ºåºåšè¦æ±‚ï¼Œä»¥æ­¤ç±»æ¨ï¼Œçº¿ç¨‹Cï¼Œçº¿ç¨‹Dâ€¦â€¦&lt;/p>
&lt;p>æ‰€ä»¥ï¼Œ&lt;strong>Memory barriers always come in pairs, or triplets or more.&lt;/strong>&lt;/p>
&lt;p>åŒæ ·çš„ï¼Œçº¿ç¨‹é”ä¹Ÿæ˜¯è¿™æ ·çš„ï¼Œè‡ªå·±é”è‡ªå·±æ€»ä¸æ˜¯ä¸€ç§æ„‰å¿«çš„ä½“éªŒï¼ˆç¬‘&lt;/p>
&lt;h3 id="cpuçš„ä¹±åºæ‰§è¡Œ">CPUçš„ä¹±åºæ‰§è¡Œ &lt;a href="#cpu%e7%9a%84%e4%b9%b1%e5%ba%8f%e6%89%a7%e8%a1%8c" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°PowerPCæœ‰ä¸‰ç§å†…å­˜å±éšœï¼Œè€ŒDEC Alphaå¹³å°æœ‰æ›´å¤šã€‚è¿™æ„å‘³ç€ï¼ŒCPUä½¿ç”¨æ›´æ¿€è¿›çš„ç­–ç•¥æ¥é‡æ’æŒ‡ä»¤ï¼Œè€Œå¼ºåˆ¶é™åˆ¶å…¶é‡æ’çš„ä»£ä»·æ˜¯éå¸¸é«˜çš„ã€‚&lt;/p>
&lt;p>è€Œx86å¹³å°åˆ™éå¸¸å®ˆåºï¼Œä½œè€…çŒœæµ‹å…¶åŸå› æ˜¯ç”±äºæ—©æœŸx86çš„æŒ‡ä»¤æŠ€æœ¯å¹¶éå®Œå–„ï¼Œè€Œåœ¨é‚£æ—¶å†…å­˜ä¸CPUçš„é€Ÿåº¦ä¸åƒç°åœ¨è¿™æ ·æ‚¬æ®Šï¼Œæ‰€ä»¥x86ä½¿ç”¨äº†&lt;code>strongly ordered memory&lt;/code>è€Œéåƒä¸Šé¢å‡ æ¬¾CPUä¸€æ ·çš„é‡‡ç”¨è¿‡å¤šçš„æŒ‡ä»¤é‡æ’åºã€‚å¦‚ä»Šï¼Œç”±äºx86èƒŒä¸Šäº†å‘å‰å…¼å®¹æ€§çš„åŒ…è¢±ï¼Œçœ‹ä¼¼æˆ‘ä»¬çš„&amp;quot;å¥½æ—¥å­&amp;quot;ä¸€ç›´ä¸ä¼šç»“æŸã€‚&lt;/p>
&lt;p>x86-64ï¼Œåšä¸ºx86çš„64ä½å‡çº§ç‰ˆï¼ŒåŒæ ·æ²¡æœ‰å®ç°&lt;code>weakly ordered&lt;/code>ï¼Œæˆ–è€…è¯´ï¼Œä¿ç•™äº†å®ç°&lt;code>weakly ordered&lt;/code>çš„æƒåˆ©ã€‚è€Œ&lt;code>IA64&lt;/code>å¹³å°ï¼Œå¦‚&lt;code>Itanium&lt;/code>ï¼Œåˆ™å®ç°äº†&lt;code>weakly ordered&lt;/code>ã€‚&lt;/p>
&lt;p>ä½œè€…çŒœæµ‹x86_64ä¹‹æ‰€ä»¥ä¿å®ˆï¼Œæ˜¯ä¸ºäº†ä¸IA64å¹³å°å¯¹æŠ—ã€‚x86_64çš„å¯¹äºx86è‰¯å¥½çš„å…¼å®¹æ€§å¯ä»¥è®©ç¨‹åºå‘˜å¤šæ´»å‡ å¹´ï¼Œæ‰€ä»¥x86_64åœ¨å¸‚åœºçš„è¡¨ç°æ›´å¥½ã€‚&lt;/p>
&lt;p>ä½œè€…è¿˜è¡¨ç¤ºï¼Œè€Œè‹¹æœæ”¾å¼ƒIA64å¹³å°è½¬æŠ•x86-64å¤šå°‘æœ‰ä¸€äº›å¯æƒœï¼Œå› ä¸ºè‹¹æœå¹¶æ²¡æœ‰ç§»æ¤æ€§é—®é¢˜ï¼ŒPowerPCå·²ç»é€æ¸è¡°è½ï¼Œä¸ºä»€ä¹ˆä¸è¯•è¯•IA64å‘¢ã€‚&lt;/p>
&lt;p>å®é™…ä¸Šï¼Œæ ¹æ®Wikipediaï¼Œç°åœ¨æ”¯æŒIA64çš„æ“ä½œç³»ç»Ÿéå¸¸å°‘ï¼Œåªæœ‰WinNT Familyï¼ŒRed Hat Linuxï¼ŒDebian/Gentoo/Suseä»¥åŠå…¶å®ƒã€‚è€Œä»Windows Server 2008 R2ä¹‹åï¼ŒMicrosoftä¹Ÿè¡¨ç¤ºä¸å†æ”¯æŒItaniumã€‚æ‰€ä»¥ä»ç°åœ¨çœ‹æ¥ï¼ŒIA64å¹³å°ç›¸å¯¹x86/x64æ¥è¯´ï¼Œæ˜¯å¤±è´¥çš„ã€‚&lt;/p>
&lt;h3 id="åŒé‡æ£€æŸ¥é”">åŒé‡æ£€æŸ¥é” &lt;a href="#%e5%8f%8c%e9%87%8d%e6%a3%80%e6%9f%a5%e9%94%81" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;p>è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹å¦‚ä¸‹çš„Obj-Cä»£ç &lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-objc" data-lang="objc">&lt;span style="display:flex;">&lt;span>+ &lt;span style="color:#a6e22e">getSharedObject&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">id&lt;/span> sharedObject;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (&lt;span style="color:#f92672">!&lt;/span> sharedObject) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> LOCK;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (&lt;span style="color:#f92672">!&lt;/span> sharedObject) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> sharedObject &lt;span style="color:#f92672">=&lt;/span> [[self alloc] init];
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> UNLOCK;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> sharedObject;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™æ˜¯éå¸¸ç»å…¸çš„ä¸€ç§DCLP(Double Checked Lock Pattern)çš„å®ç°ã€‚&lt;/p>
&lt;p>è¿™ä¸ªçœ‹èµ·æ¥ä¸é”™ï¼Œä½†æ˜¯ä½ å·²ç»çŸ¥é“è¿™å¹¶ä¸é è°±äº†ã€‚å½“æˆ‘ä»¬åˆå§‹åŒ–æˆ‘ä»¬çš„å…±äº«å•ä¾‹ï¼Œå…ˆè¦å†ä¿®æ”¹ç±»å†…çš„æŒ‡é’ˆï¼Œä½¿å…¶æŒ‡å‘ä¸€å—å£°æ˜å¥½çš„å†…å­˜ï¼Œå†åˆå§‹åŒ–ä¸€ä¸ªsharedObjectçš„instanceã€‚&lt;/p>
&lt;p>ä¸è¿‡ï¼Œä½ æ˜¯çŸ¥é“çš„ï¼ŒCPUå’Œç¼–è¯‘å™¨ä¼šæŠŠä¸€åˆ‡éƒ½æç ¸ï¼Œå®ƒä»¬ä¼šä»¥ä»»æ„çš„é¡ºåºæ‰§è¡Œæˆ‘ä»¬çš„å‘½ä»¤ï¼ŒåŒæ—¶å¤„ç†å™¨ä¹‹é—´äº’ç›¸ä¸é€šæ°”ï¼Œäºæ˜¯å°±ä¼šå‡ºç°å¦‚ä¸‹çš„æƒ…å†µï¼š&lt;/p>
&lt;p>çº¿ç¨‹Aä¸ºæŒ‡é’ˆå£°æ˜äº†ä¸€æ®µç©ºé—´ï¼Œä½†æ˜¯è¿˜æ²¡æ¥åŠåˆå§‹åŒ–è¿™ä¸ªinstanceï¼Œçº¿ç¨‹Aå°±è¢«æŒ‚èµ·äº†ã€‚&lt;/p>
&lt;p>ä¹‹åçº¿ç¨‹Bæ¥ç®¡ä¸€åˆ‡ï¼Œå‘ç°æŒ‡é’ˆæœ‰å€¼ï¼Œç»“æœå› ä¸ºè®¿é—®äº†é‡æŒ‡é’ˆå¯¼è‡´ç¨‹åºæŒ‚æ‰ã€‚&lt;/p>
&lt;p>ä¸è¿‡æ ¹æ®ä¸Šé¢çš„æ–‡ç« ï¼Œä½ ä»¬åº”è¯¥çŸ¥é“æ€ä¹ˆå¤„ç†è¿™ä¸ªé—®é¢˜äº† â€”â€” è¯•è¯•å†…å­˜å±éšœï¼&lt;/p>
&lt;p>p.s. å¦‚æœå¤§å®¶å¯¹obj-cä¸ç†Ÿæ‚‰çš„è¯ï¼Œå¯ä»¥çœ‹æˆ‘å¦å¤–ä¸€ç¯‡æ–‡ç« ã€‚é‚£ç¯‡æ–‡ç« æ˜¯å…³äºScott Meyerså¤§ç¥å†™çš„ä¸€ç¯‡è®ºæ–‡ï¼Œä¸“é—¨ç”¨æ¥è®¨è®ºDCLPé—®é¢˜çš„ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-objc" data-lang="objc">&lt;span style="display:flex;">&lt;span>+ &lt;span style="color:#a6e22e">getSharedObject&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">id&lt;/span> sharedObject;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (&lt;span style="color:#f92672">!&lt;/span> sharedObject) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> LOCK;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (&lt;span style="color:#f92672">!&lt;/span> sharedObject) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">id&lt;/span> temp &lt;span style="color:#f92672">=&lt;/span> [[self alloc] init];
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> OSMemoryBarrier();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> sharedObject &lt;span style="color:#f92672">=&lt;/span> temp;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> UNLOCK;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> OSMemoryBarrier();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> sharedObject;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è€Œåœ¨ã€ŠC++ and the Perils of Double-Checked Lockingã€‹ä¸€æ–‡ä¸­ï¼ŒScott Meyerså’ŒAndrei Alexandrescuç»™å‡ºçš„è§£å†³æ–¹æ¡ˆå¦‚ä¸‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>Singleton&lt;span style="color:#f92672">*&lt;/span> Singleton&lt;span style="color:#f92672">::&lt;/span>instance () {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Singleton&lt;span style="color:#f92672">*&lt;/span> tmp &lt;span style="color:#f92672">=&lt;/span> pInstance;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// insert memory barrier
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75715e">// clear the cache to flush ``pInstance``
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75715e">// prevents &amp;#34;downwards migration&amp;#34; of Singletonâ€™s construction (by another thread);
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">if&lt;/span> (tmp &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Lock lock;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> tmp &lt;span style="color:#f92672">=&lt;/span> pInstance;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (tmp &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> tmp &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> Singleton;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// insert memory barrier
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75715e">// prevent optimistic that eliminate the temporary variable ``tmp``
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75715e">// prevents &amp;#34;upwards migration&amp;#34; of pInstanceâ€™s initialization
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> pInstance &lt;span style="color:#f92672">=&lt;/span> tmp;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> tmp;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¸¤ç§è§£å†³æ–¹æ¡ˆçš„memory barrieræ’å…¥çš„ä½ç½®ä¸åŒã€‚ä½†æ˜¯éƒ½ä¸èƒ½è¯´æ˜¯é”™çš„ã€‚å› ä¸ºä¸€ä¸ªæ˜¯ä¼ static instanceï¼Œä¸€ä¸ªæ˜¯ä¼ pointerã€‚&lt;/p>
&lt;p>å…¶å®è¿˜æœ‰æ›´â€œæš´åŠ›â€çš„æ–¹æ³•ã€‚&lt;/p>
&lt;p>ç›´æ¥æ¥ä¸€æŠŠå¤§é”ï¼Œå“å½“æŠŠæ•´ä¸ªå‡½æ•°é”èµ·æ¥ï¼Œå¹¶ä¸”åœ¨æ¯ä¸€ä¸ªçº¿ç¨‹å†…ä¿ç•™ä¸€ä¸ª&lt;strong>æœ¬çº¿ç¨‹ä¸“å±&lt;/strong>æŒ‡å‘å•ä¾‹çš„æŒ‡é’ˆï¼ˆåšcacheï¼‰ã€‚è¿™æ ·Nä¸ªçº¿ç¨‹åªéœ€è¦è°ƒç”¨è¿™ä¸ªå‡½æ•°Næ¬¡ï¼Œçº¿ç¨‹ç«äº‰ä¹Ÿç›¸å¯¹å°‘å¾ˆå¤šã€‚å¹¶ä¸”æ ¹æ®Linuxä¸‹çš„futexæŠ€æœ¯ï¼Œæ— ç«äº‰ä¸‹çš„é”ç›¸å¯¹èŠ‚çœäº†ä¸å°‘èµ„æºã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>Singleton&lt;span style="color:#f92672">*&lt;/span> Singleton&lt;span style="color:#f92672">::&lt;/span>instance() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Lock lock;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span>(pInstance &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> pInstance &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> Singleton;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> pInstance;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="æˆ‘ä»¬çœŸçš„éœ€è¦è¿™ä¹ˆåšå—">æˆ‘ä»¬çœŸçš„éœ€è¦è¿™ä¹ˆåšå— &lt;a href="#%e6%88%91%e4%bb%ac%e7%9c%9f%e7%9a%84%e9%9c%80%e8%a6%81%e8%bf%99%e4%b9%88%e5%81%9a%e5%90%97" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;p>ä¸Šé¢çš„obj-cä»£ç ä¸­ï¼Œä¿è¯åŒé‡æ£€æŸ¥é”æ­£ç¡®çš„ï¼Œå…¶å®æ˜¯ç¬¬äºŒä¸ªå†…å­˜å±éšœã€‚ä½†æ˜¯ï¼Œåœ¨é‚£é‡Œï¼Œæˆ‘ä»¬éœ€è¦çš„å…¶å®æ˜¯ä¸€ä¸ª&amp;quot;data dependency barrier&amp;quot;ã€‚&lt;/p>
&lt;p>Linuxå†…æ ¸ä¸­ç»™å‡ºå¾ˆå¤šç»è¿‡ç²¾å¿ƒä¼˜åŒ–çš„å†…å­˜å±éšœï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œå¯ä»¥ä½¿ç”¨ã€‚ä¸è¿‡ï¼Œè¦åœ¨ä½¿ç”¨çš„æ—¶å€™å†™å¥½æ³¨é‡Šï¼Œä¸€æ˜¯ä¸ºäº†æœªæ¥çš„éªŒè¯ï¼ŒäºŒæ˜¯ä¸ºäº†è®°å½•è‡ªå·±å½“æ—¶çš„æ€è·¯ã€‚&lt;/p>
&lt;p>æ¯•ç«Ÿå¤šçº¿ç¨‹çš„æ“ä½œè¦å°å¿ƒå†å°å¿ƒï¼Œæˆ‘ä»¬éœ€è¦å……è¶³çš„ç†ç”±ï¼Œæ›´å¤šçš„å°å¿ƒæ¥åº”å¯¹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-obj-c" data-lang="obj-c">&lt;span style="display:flex;">&lt;span>+ &lt;span style="color:#a6e22e">getSharedObject&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">id&lt;/span> sharedObject;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (&lt;span style="color:#f92672">!&lt;/span> sharedObject) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> LOCK;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (&lt;span style="color:#f92672">!&lt;/span> sharedObject) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">id&lt;/span> temp &lt;span style="color:#f92672">=&lt;/span> [[self alloc] init];
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> OSMemoryBarrier();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> sharedObject &lt;span style="color:#f92672">=&lt;/span> temp;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> UNLOCK;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">/* data dependency memory barrier here */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> sharedObject;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="ä¸€åˆ‡éƒ½ç»“æŸäº†å—">ä¸€åˆ‡éƒ½ç»“æŸäº†å—ï¼Ÿ &lt;a href="#%e4%b8%80%e5%88%87%e9%83%bd%e7%bb%93%e6%9d%9f%e4%ba%86%e5%90%97" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;p>æ˜¯çš„ã€‚ä¸è¿‡è®©æˆ‘ä»¬æ€»ç»“ä¸€ä¸‹å§ã€‚&lt;/p>
&lt;p>&lt;img src="https://github.com/Wizmann/assets/raw/master/wizmann-tk-pic/barrier_tank.png" alt="Mutex Tank">&lt;/p>
&lt;ul>
&lt;li>å¤„ç†å™¨å’Œç¼–è¯‘å™¨å¹¶ä¸èƒ½å……åˆ†ä¿è¯ä»£ç æ‰§è¡Œçš„é¡ºåºï¼Œå®ƒä»¬ä¼šæŠŠä½ çš„ä»£ç åˆ°å¤„ç§»åŠ¨ã€‚æ‰€ä»¥&lt;strong>Be warned and wary!&lt;/strong>&lt;/li>
&lt;li>å¤šçº¿ç¨‹çš„é”™è¯¯æ˜¯éå¸¸subtleå’Œdelicateçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¾ˆéš¾è®¾è®¡æµ‹è¯•ç”¨ä¾‹&lt;/li>
&lt;li>å› æ­¤ï¼Œåˆ«æŒ‡è´£QAäº†ï¼Œä»–ä»¬ä¹Ÿä¸æ˜¯æ•…æ„çš„ã€‚RDè¦å¯¹è‡ªå·±çš„ä»£ç è´Ÿè´£&lt;/li>
&lt;li>é”å¾ˆå®‰å…¨ï¼Œä½†æ˜¯ä¹Ÿå¾ˆé‡&lt;/li>
&lt;li>å†…å­˜å±éšœæ˜¯ä¸€ç§æ›´å¿«çš„ï¼Œä¸é˜»å¡çš„ï¼Œä¸ä¼šæ­»é”çš„ä¸€ç§é”çš„æ›¿ä»£ç‰©ã€‚å®ƒä»¬æ€»è¦èŠ±è´¹æ›´å¤šçš„å¿ƒæ€ï¼Œå¹¶ä¸”ä¹Ÿä¸æ˜¯åˆ°å¤„å¯ç”¨çš„é“¶å¼¹ã€‚ä½†æ˜¯å®ƒç¡®å®å¾ˆå¿«ï¼Œæœ‰æ›´å¥½çš„ä¼¸ç¼©æ€§ã€‚&lt;/li>
&lt;li>å†…å­˜å±éšœå¾€å¾€æ˜¯æˆå¯¹å‡ºç°çš„ã€‚äº†è§£ç¬¬äºŒä¸ªå†…å­˜å±éšœè¦å‡ºç°åœ¨å“ªé‡Œï¼Œæœ‰åŠ©äºä½ ç†è§£ä½ çš„ä»£ç ï¼Œå³ä½¿ä½ æ‰€ä½¿ç”¨çš„ä½“ç³»ç»“æ„ä¸éœ€è¦ç¬¬äºŒä¸ªå†…å­˜å±éšœã€‚&lt;/li>
&lt;/ul>
&lt;h3 id="æ‰©å±•é˜…è¯»">æ‰©å±•é˜…è¯» &lt;a href="#%e6%89%a9%e5%b1%95%e9%98%85%e8%af%bb" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;p>&lt;a href="https://www.kernel.org/doc/Documentation/memory-barriers.txt">LINUX KERNEL MEMORY BARRIERS&lt;/a>&lt;/p>
&lt;p>&lt;a href="http://citeseerx.ist.psu.edu/viewdoc/summary?doi=10.1.1.17.8112">Memory Consistency and Event Ordering in Scalable Shared-Memory Multiprocessors&lt;/a>&lt;/p></description></item></channel></rss>