<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>System Design on Maerlyn's Rainbow</title><link>https://wizmann.top/tags/system-design/</link><description>Recent content in System Design on Maerlyn's Rainbow</description><generator>Hugo -- gohugo.io</generator><language>zh-CN</language><lastBuildDate>Sun, 29 Nov 2020 00:00:00 +0000</lastBuildDate><atom:link href="https://wizmann.top/tags/system-design/index.xml" rel="self" type="application/rss+xml"/><item><title>Introduction to Ceph</title><link>https://wizmann.top/posts/introduction-to-ceph/</link><pubDate>Sun, 29 Nov 2020 00:00:00 +0000</pubDate><guid>https://wizmann.top/posts/introduction-to-ceph/</guid><description>&lt;h2 id="ä»€ä¹ˆæ˜¯ceph">ä»€ä¹ˆæ˜¯Ceph &lt;a href="#%e4%bb%80%e4%b9%88%e6%98%afceph" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;p>Cephæ˜¯ä¸€ä¸ªå¯æ‰©å±•çš„ï¼Œé«˜æ€§èƒ½çš„åˆ†å¸ƒå¼å­˜å‚¨ç³»ç»Ÿã€‚æä¾›äº†ä¸‰ç§ä¸åŒç±»åž‹çš„æŽ¥å£ä»¥é€‚åº”ä¸åŒçš„åº”ç”¨åœºæ™¯ï¼š&lt;/p>
&lt;ul>
&lt;li>block-based: å—å­˜å‚¨ï¼Œå¯ä»¥ç”¨åšVMçš„è™šæ‹Ÿç£ç›˜&lt;/li>
&lt;li>object-based: å¯¹è±¡å­˜å‚¨ï¼Œä¸ŽAmazon S3ç­‰å¸¸ç”¨å¯¹è±¡å­˜å‚¨å…¼å®¹&lt;/li>
&lt;li>file system: POSIXå…¼å®¹çš„åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿï¼Œå¯ä»¥è¢«æœ¬åœ°ç³»ç»ŸæŒ‚è½½ï¼Œå¹¶ä¸”èƒ½è¢«å¤šä¸ªå®¢æˆ·ç«¯å…±äº«&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://raw.githubusercontent.com/Wizmann/assets/master/wizmann-pic/20-11-28/2020-11-28_22-04-49.png" alt="">&lt;/p>
&lt;h3 id="cephçš„ç‰¹æ€§">Cephçš„ç‰¹æ€§ &lt;a href="#ceph%e7%9a%84%e7%89%b9%e6%80%a7" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;p>ç”±äºŽé‡‡ç”¨äº†CRUSHç®—æ³•ï¼ŒCephæœ‰ç€ä¼˜å¼‚çš„å¯æ‰©å±•æ€§ï¼ˆå®£ç§°å¯ä»¥æ— é™æ‰©å±•ï¼‰ã€‚å¹¶ä¸”å€ŸåŠ©å¯æ‰©å±•æ€§ï¼Œè¿›è€Œå®žçŽ°é«˜æ€§èƒ½ã€é«˜å¯é æ€§å’Œé«˜å¯ç”¨æ€§ã€‚&lt;/p>
&lt;p>Cephæ˜¯ä¸€ä¸ªåŽ»ä¸­å¿ƒåŒ–çš„å­˜å‚¨ç³»ç»Ÿï¼Œæ— éœ€ä¸­å¿ƒèŠ‚ç‚¹è¿›è¡Œèµ„æºçš„ç®¡ç†ä¸Žè°ƒåº¦ï¼Œå…¨éƒ¨çš„ç®¡ç†åŠŸèƒ½ç”±å­˜å‚¨èŠ‚ç‚¹è‡ªæ²»å®Œæˆã€‚ä½¿å¾—æ•´ä¸ªç³»ç»Ÿå¯ä»¥è‡ªæˆ‘ç®¡ç†ä¸Žè‡ªæˆ‘æ¢å¤ï¼Œå‡å°‘è¿ç»´æˆæœ¬ä¸Žç®¡ç†æˆæœ¬ã€‚&lt;/p>
&lt;h2 id="rados---cephçš„å­˜å‚¨å¼•æ“Ž">RADOS - Cephçš„å­˜å‚¨å¼•æ“Ž &lt;a href="#rados---ceph%e7%9a%84%e5%ad%98%e5%82%a8%e5%bc%95%e6%93%8e" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;p>RADOS=Reliable Autonomic Distributed Object Storeã€‚RADOSæ˜¯Cephåº•å±‚çš„å­˜å‚¨å¼•æ“Žï¼Œæ‰€æœ‰çš„æŽ¥å£éƒ½å»ºç«‹åœ¨RADOSçš„åŠŸèƒ½ä¹‹ä¸Šã€‚&lt;/p>
&lt;h3 id="radosä¸­çš„å­˜å‚¨ç»“æž„">RADOSä¸­çš„å­˜å‚¨ç»“æž„ &lt;a href="#rados%e4%b8%ad%e7%9a%84%e5%ad%98%e5%82%a8%e7%bb%93%e6%9e%84" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;p>&lt;img src="https://raw.githubusercontent.com/Wizmann/assets/master/wizmann-pic/20-11-28/2020-11-28_22-24-56.png" alt="">&lt;/p>
&lt;ul>
&lt;li>å­˜å‚¨æ± ï¼ˆpoolï¼‰ï¼šé€»è¾‘å±‚ï¼Œæ¯ä¸€ä¸ªpoolé‡Œéƒ½åŒ…å«ä¸€äº›æ”¾ç½®ç»„&lt;/li>
&lt;li>æ”¾ç½®ç»„ï¼ˆplacement-group, PG)ï¼šé€»è¾‘å±‚ï¼Œä¸€ä»½æ•°æ®ä¼šåœ¨PGå½“ä¸­è¿›è¡Œç¾å¤‡å¤åˆ¶ã€‚æ¯ä¸€ä¸ªPGéƒ½å¯¹åº”ç€ä¸€ç³»åˆ—çš„å­˜å‚¨èŠ‚ç‚¹&lt;/li>
&lt;li>å­˜å‚¨èŠ‚ç‚¹ï¼ˆOSDï¼‰ï¼šç”¨ä»¥å­˜å‚¨æ•°æ®çš„ç‰©ç†èŠ‚ç‚¹ã€‚ä¸ŽPGä¹‹é—´å½¢æˆå¤šå¯¹å¤šçš„å…³ç³»ã€‚&lt;/li>
&lt;/ul>
&lt;p>ä¸€ä»½æ•°æ®åœ¨å†™å…¥RADOSæ—¶ï¼Œä¼šå…ˆé€‰ä¸­ä¸€ä¸ªpoolã€‚Poolä¸­å†ä½¿ç”¨ä¸€å®šçš„hashè§„åˆ™ï¼Œä¼ªéšæœºçš„é€‰ä¸­æŸä¸€ä¸ªPGã€‚PGä¼šå°†æ•°æ®å†™å…¥å¤šä¸ªOSDä¸­ã€‚è¯»å–æ•°æ®æ—¶ï¼Œä¹Ÿæ˜¯ç±»ä¼¼çš„è§„åˆ™ã€‚&lt;/p>
&lt;p>Poolæ˜¯ç”¨æˆ·å¯è§çš„ç®¡ç†æ•°æ®çš„åŸºæœ¬å•ä½ï¼Œç”¨æˆ·å¯ä»¥å¯¹Poolè¿›è¡Œä¸€ç³»åˆ—çš„é…ç½®ï¼ˆæƒé™æŽ§åˆ¶ã€ä½¿ç”¨SSD or HDDã€ä½¿ç”¨æ•°æ®æ‹·è´ or çº åˆ ç ï¼Œetc.ï¼‰ã€‚è€ŒPGä¸ŽOSDå¯¹äºŽç”¨æˆ·æ˜¯ä¸å¯è§çš„ã€‚&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/Wizmann/assets/master/wizmann-pic/20-11-28/2020-11-28_23-00-51.png" alt="">&lt;/p>
&lt;h4 id="pgçš„ç»„ç»‡">PGçš„ç»„ç»‡ &lt;a href="#pg%e7%9a%84%e7%bb%84%e7%bb%87" class="anchor">ðŸ”—&lt;/a>&lt;/h4>&lt;p>åœ¨ä¸€è‡´æ€§å“ˆå¸Œä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨èŠ‚ç‚¹æ¥åˆ’åˆ†å“ˆå¸Œå€¼åŸŸã€‚è¿™ç§æ–¹æ³•çš„é—®é¢˜æ˜¯ï¼Œå¦‚æžœäº§ç”Ÿäº†æ•°æ®ä¸å¹³è¡¡ï¼Œæˆ‘ä»¬éœ€è¦é‡æ–°è¿›è¡Œåˆ’åˆ†å€¼åŸŸæ¥è¿›è¡Œå†å¹³è¡¡ã€‚è¿™ä¼šé€ æˆå¤§é‡çš„æ•°æ®è¿ç§»ã€‚&lt;/p>
&lt;p>CRUSHé‡‡ç”¨äº†è™šæ‹ŸèŠ‚ç‚¹ï¼ˆä¹Ÿå°±æ˜¯PGï¼‰å°†å“ˆå¸Œå€¼åŸŸåˆ’åˆ†æˆäº†å›ºå®šçš„ç­‰é•¿åŒºåŸŸã€‚è¿™ç§æ–¹æ³•åœ¨å•æ¡æ•°æ®ä¸Žç‰©ç†èŠ‚ç‚¹ä¹‹é—´åŠ å…¥äº†ä¸€ä¸ªè™šæ‹Ÿå±‚ã€‚ä¹‹åŽï¼Œå†ä½¿ç”¨å“ˆå¸Œå–æ¨¡çš„ç®—æ³•ç¡®å®šæ•°æ®å±žäºŽå“ªä¸ªPGã€‚ä½¿å¾—æ•°æ®çš„è¿ç§»æ˜¯ä»¥è™šæ‹ŸèŠ‚ç‚¹ä¸ºå•ä½ï¼Œè€Œä¸æ˜¯å¯¹æ¯ä¸€æ¡æ•°æ®éƒ½é‡æ–°è®¡ç®—ã€‚Cephå®˜æ–¹çš„å»ºè®®æ˜¯ï¼Œæ¯1ä¸ªOSDå¯¹åº”ç€100ä¸ªPGã€‚&lt;/p>
&lt;p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œåœ¨è§„åˆ’çš„åˆæœŸéœ€è¦ç¡®å®šPGçš„æ•°ç›®ï¼Œå¦‚æžœåŽæœŸéœ€è¦è°ƒæ•´PGï¼Œæœ‰å¯èƒ½ä¼šå¯¼è‡´å¤§é‡çš„æ•°æ®è¿ç§»ï¼Œç”šè‡³éœ€è¦æœåŠ¡æš‚æ—¶åœæ­¢æœåŠ¡ã€‚&lt;/p>
&lt;h3 id="ç›‘æŽ§å­é›†ç¾¤monä¸Žcluster-map">ç›‘æŽ§å­é›†ç¾¤ï¼ˆMONï¼‰ä¸ŽCluster Map &lt;a href="#%e7%9b%91%e6%8e%a7%e5%ad%90%e9%9b%86%e7%be%a4mon%e4%b8%8ecluster-map" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;p>&lt;img src="https://raw.githubusercontent.com/Wizmann/assets/master/wizmann-pic/20-11-28/2020-11-28_22-48-10.png" alt="">&lt;/p>
&lt;p>RADOSé›†ç¾¤ä¸­é™¤äº†OSDå­˜å‚¨èŠ‚ç‚¹ä¹‹å¤–ï¼Œè¿˜æœ‰ç›‘æŽ§å­é›†ç¾¤ï¼ˆMONï¼‰ï¼Œç”¨äºŽå­˜å‚¨ç³»ç»Ÿçš„æ‹“æ‰‘ç»“æž„â€”â€”Cluster Mapã€‚&lt;/p>
&lt;blockquote>
&lt;p>å…ƒæ•°ç»„ç®¡ç†ï¼ˆMDSï¼‰èŠ‚ç‚¹ç”¨äºŽç®¡ç†CephFSä¸­çš„æ–‡ä»¶å…ƒä¿¡æ¯ï¼ŒåŽæ–‡ä¼šæœ‰ä»‹ç»ã€‚&lt;/p>&lt;/blockquote>
&lt;p>ä¸åŒäºŽä¼ ç»Ÿçš„ä¸­å¿ƒåŒ–ç®¡ç†èŠ‚ç‚¹ï¼ŒMONå¹¶ä¸ä¼šå¯¹èµ„æºè¿›è¡Œè°ƒé…ä¸Žè°ƒåº¦ï¼Œè€Œä»…ä»…æ˜¯ä¸€ä¸ªè§‚æµ‹è€…ï¼Œç”¨ä»¥å­˜å‚¨ç³»ç»Ÿå½“å‰çš„æ‹“æ‰‘ä¸ŽçŠ¶æ€ã€‚&lt;/p>
&lt;p>MONä¸ŽOSDã€OSDä¸ŽOSDä¹‹é—´ä¼šå®šæ—¶å‘é€å¿ƒè·³åŒ…ï¼Œæ£€æµ‹OSDæ˜¯å¦å¥åº·ã€‚å¦‚æžœæŸä¸ªèŠ‚ç‚¹å¤±æ•ˆï¼ŒMONä¼šæ›´æ–°å†…éƒ¨å­˜å‚¨çš„æ‹“æ‰‘ç»“æž„ä¿¡æ¯ï¼ˆClusterMapï¼‰ï¼Œå¹¶ä¸”é€šè¿‡P2Påè®®å¹¿æ’­å‡ºåŽ»ï¼Œä»Žè€Œä½¿å¾—æ•´ä¸ªç³»ç»Ÿéƒ½æœ‰ç€ï¼ˆæœ€ç»ˆï¼‰ä¸€è‡´çš„æ‹“æ‰‘ä¿¡æ¯ã€‚&lt;/p>
&lt;h3 id="ä¸»ä»ŽåŒæ­¥ä¸ŽèŠ‚ç‚¹è‡ªæ²»">ä¸»ä»ŽåŒæ­¥ä¸ŽèŠ‚ç‚¹è‡ªæ²» &lt;a href="#%e4%b8%bb%e4%bb%8e%e5%90%8c%e6%ad%a5%e4%b8%8e%e8%8a%82%e7%82%b9%e8%87%aa%e6%b2%bb" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;p>åœ¨ä¸€ä¸ªPGä¸­ï¼Œä¼šæœ‰ä¸€ä¸ªä¸»èŠ‚ç‚¹ï¼ˆPrimaryï¼‰å’Œä¸€ä¸ªæˆ–å¤šä¸ªä»ŽèŠ‚ç‚¹ï¼ˆSecondaryï¼‰ã€‚ä¸»èŠ‚ç‚¹è´Ÿè´£ç»´æŠ¤ä»ŽèŠ‚ç‚¹çš„çŠ¶æ€ï¼ŒåŒ…æ‹¬æ•°æ®å¤åˆ¶ï¼ˆreplicationï¼‰ã€å¤±æ•ˆæ£€æµ‹ï¼ˆfailure detectionï¼‰å’Œå¤±æ•ˆæ¢å¤ï¼ˆfailure recoveryï¼‰ã€‚&lt;/p>
&lt;h2 id="crush---cephçš‡å† ä¸Šçš„æ˜Žç ">CRUSH - Cephçš‡å† ä¸Šçš„æ˜Žç  &lt;a href="#crush---ceph%e7%9a%87%e5%86%a0%e4%b8%8a%e7%9a%84%e6%98%8e%e7%8f%a0" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;p>CRUSHæ˜¯ä¸€ä¸ªå¯æ‰©å±•çš„ï¼Œä¼ªéšæœºçš„æ•°æ®æ”¾ç½®ç®—æ³•ã€‚ä»¥åŽ»ä¸­å¿ƒåŒ–æ–¹æ³•ï¼Œå°†PGæŒ‰è§„åˆ™æ˜ å°„åˆ°ç›¸åº”çš„å­˜å‚¨è®¾å¤‡ä¸Šã€‚å¹¶ä¸”ç³»ç»Ÿçš„æ‹“æ‰‘ç»“æž„å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå°½å¯èƒ½çš„å‡å°‘æ•°æ®çš„è¿ç§»ã€‚&lt;/p>
&lt;h3 id="crushçš„ä¼˜åŠ¿">CRUSHçš„ä¼˜åŠ¿ &lt;a href="#crush%e7%9a%84%e4%bc%98%e5%8a%bf" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;p>CRUSHå¯¹äºŽæ¯ä¸€ä¸ªæ•°æ®å…ƒç´ ä½¿ç”¨ä¸€ä¸ªä¼ªéšæœºç®—æ³•ï¼Œå†³å®šå…¶æ”¾ç½®çš„ä½ç½®ã€‚æ‰€ä»¥ï¼Œåªè¦æ‰€æœ‰å‚ä¸Žè€…éƒ½æ‹¥æœ‰ç›¸åŒçš„ç³»ç»Ÿæ‹“æ‰‘ç»“æž„ä¿¡æ¯ï¼Œé‚£ä¹ˆæ•°æ®çš„ä½ç½®å°±æ˜¯ä¸€å®šçš„ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥åŽ»æŽ‰ä¸­å¿ƒèŠ‚ç‚¹ï¼Œé‡‡ç”¨P2Pçš„æ–¹æ³•æ¥è¿›è¡Œæ•°æ®çš„å­˜å‚¨ä¸Žæ£€ç´¢ã€‚&lt;/p>
&lt;p>å¹¶ä¸”ï¼Œç”±äºŽä¼ªéšæœºç®—æ³•åªä¸Žå•ä¸ªPGç›¸å…³ï¼Œå¦‚æžœæˆ‘ä»¬æ“ä½œå¾—å½“ï¼ŒèŠ‚ç‚¹æ•°é‡çš„å˜åŒ–å¹¶ä¸ä¼šå¼•èµ·å¤§é‡çš„æ•°æ®è¿ç§»ï¼Œè€Œæ˜¯ä¼šæŽ¥è¿‘ç†è®ºæœ€ä¼˜å€¼ã€‚&lt;/p>
&lt;h3 id="æ•°æ®æ”¾ç½®data-placement">æ•°æ®æ”¾ç½®ï¼ˆData Placementï¼‰ &lt;a href="#%e6%95%b0%e6%8d%ae%e6%94%be%e7%bd%aedata-placement" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;p>CRUSHçš„æ•°æ®æ”¾ç½®ç®—æ³•æœ‰å¾ˆå¤šä¸åŒçš„å®žçŽ°ï¼Œè¿™é‡Œåªä»‹ç»æœ€å¸¸ç”¨çš„strawç®—æ³•ã€‚&lt;/p>
&lt;p>Cephä¸­ï¼Œæ¯ä¸€ä¸ªOSDèŠ‚ç‚¹éƒ½æœ‰ä¸€ä¸ªæƒå€¼wï¼Œä»£è¡¨ç€æŸä¸ªèŠ‚ç‚¹èƒ½æ”¯æŒå¤šå°‘æ•°æ®çš„å­˜å‚¨ä¸Žæ£€ç´¢ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œæƒå€¼ä¸ŽèŠ‚ç‚¹çš„å®¹é‡æˆæ­£æ¯”ã€‚&lt;/p>
&lt;p>å‡è®¾ä¸€ä¸ªpoolé‡Œé¢æœ‰nä¸ªPGï¼Œåœ¨ä¸€æ¡æ–°çš„æ•°æ®å†™å…¥æ—¶ï¼Œæˆ‘ä»¬åˆ†åˆ«ä¼šè®¡ç®—è¿™nä¸ªPGçš„lengthå€¼ã€‚&lt;/p>
&lt;p>$$ length_{i} = f(w_{i}) * hash(x) $$&lt;/p>
&lt;p>$f(w_{i})$æ˜¯ä¸€ä¸ªåªäºŽå½“å‰OSDèŠ‚ç‚¹æƒå€¼æœ‰å…³çš„å‡½æ•°ã€‚$hash(x)$ä»£è¡¨å½“å‰PGçš„å“ˆå¸Œå€¼ã€‚æ‰€ä»¥ï¼ŒPGä¼šæ”¾ç½®åœ¨å“ªä¸ªOSDä¸Šï¼Œä»…ä¸Žå…¶æƒå€¼ç›¸å…³ã€‚&lt;/p>
&lt;p>å‡è®¾æŸä¸ªOSDèŠ‚ç‚¹å‘ç”Ÿå˜åŒ–æ—¶ï¼ˆæ–°åŠ ã€åˆ é™¤ã€æƒå€¼å˜åŒ–ï¼‰ï¼Œåœ¨æ­¤å—å½±å“èŠ‚ç‚¹çš„æ•°æ®ä¼šè¿ç§»åˆ°å…¶å®ƒçš„OSDèŠ‚ç‚¹ã€‚å…¶å®ƒOSDèŠ‚ç‚¹çš„åŽŸæœ‰æ•°æ®å¹¶ä¸ä¼šå—åˆ°å½±å“ã€‚&lt;/p>
&lt;blockquote>
&lt;p>Cephå½“ä¸­çš„strawç®—æ³•æœ‰&lt;code>straw1&lt;/code>å’Œ&lt;code>straw2&lt;/code>ã€‚&lt;code>straw1&lt;/code>çš„å®žçŽ°é‡‡ç”¨äº†æœ‰ç¼ºé™·f(w)å‡½æ•°ï¼Œä¼šå¯¼è‡´æ„å¤–çš„æ•°æ®è¿ç§»ã€‚&lt;code>straw2&lt;/code>è§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚
è¯¦æƒ…è¯·æˆ³&lt;a href="https://www.spinics.net/lists/ceph-devel/msg21635.html">è¿™é‡Œ&lt;/a>&lt;/p>&lt;/blockquote>
&lt;h4 id="ä¸»ä»Žæž¶æž„">ä¸»ä»Žæž¶æž„ &lt;a href="#%e4%b8%bb%e4%bb%8e%e6%9e%b6%e6%9e%84" class="anchor">ðŸ”—&lt;/a>&lt;/h4>&lt;p>æ¯ä¸ªPGæ‰€åŒ…å«çš„OSDéƒ½ç”±CRUSHç®—æ³•è®¡ç®—å¾—å‡ºï¼Œå¹¶æ ¹æ®é…ç½®é€‰å‡ºå‰rä¸ªOSDè¿›è¡Œä¸»ä»Žé…å¯¹ã€‚åˆ—è¡¨ä¸­çš„ç¬¬1ä¸ªOSDåšä¸ºä¸»èŠ‚ç‚¹ï¼ˆPrimaryï¼‰ï¼Œå…¶å®ƒçš„èŠ‚ç‚¹ä¸ºä»ŽèŠ‚ç‚¹ï¼ˆSecondaryï¼‰ã€‚&lt;/p>
&lt;p>ä¸»ä»ŽèŠ‚ç‚¹çš„åˆ†é…ä¸Žç®¡ç†ç”±PGå†…éƒ¨è¿›è¡Œè‡ªæ²»ï¼Œä¸éœ€è¦é¢å¤–çš„å¤–éƒ¨ç³»ç»Ÿè¿›è¡Œç®¡ç†ã€‚&lt;/p>
&lt;h2 id="cephfs">CephFS &lt;a href="#cephfs" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;p>CephFSæ˜¯ä¸€ä¸ªPOSIXå…¼å®¹çš„ï¼ˆå…±äº«ï¼‰æ–‡ä»¶ç³»ç»Ÿã€‚CephFSåˆ©ç”¨æ–‡ä»¶å…ƒæ•°æ®å­ç³»ç»Ÿï¼ˆMDSï¼‰æ¥ç»´æŠ¤ç›®å½•æ ‘ç»“æž„å’Œæ–‡ä»¶å’Œç›®å½•çš„å…ƒä¿¡æ¯ï¼ˆowner, timestamps, inodes, etc.)ç­‰ã€‚&lt;/p>
&lt;p>MDSå­ç³»ç»Ÿä¼šåœ¨å†…å­˜é‡Œé¢ç»´æŠ¤ä¸€ä»½Cacheï¼Œå¯¹äºŽéœ€è¦æŒä¹…åŒ–çš„ä¿¡æ¯ï¼Œä¼šä½¿ç”¨WALçš„æ–¹å¼å†™å…¥RADOSé‡Œä¸€ä¸ªä¸“ç”¨çš„Poolå½“ä¸­ã€‚&lt;/p>
&lt;h3 id="åŠ¨æ€æ ‘åˆ’åˆ†dynamic-tree-partitioningdtp">åŠ¨æ€æ ‘åˆ’åˆ†ï¼ˆDynamic Tree Partitioningï¼ŒDTPï¼‰ &lt;a href="#%e5%8a%a8%e6%80%81%e6%a0%91%e5%88%92%e5%88%86dynamic-tree-partitioningdtp" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;p>CephFSçš„æ‰©å±•æ€§çš„å…³é”®ä¹‹ä¸€ï¼Œåœ¨äºŽå…ƒä¿¡æ¯å­ç³»ç»Ÿçš„æ‰©å±•æ€§ã€‚CephFSå®žçŽ°äº†åŠ¨æ€æ ‘åˆ’åˆ†çš„ç®—æ³•ï¼Œå°†ç›®å½•æ ‘ç»“æž„æ ¹æ®å½“å‰ç³»ç»Ÿçš„è´Ÿè½½ï¼Œå°†å…¶åˆ’åˆ†åˆ°ä¸åŒçš„MDSèŠ‚ç‚¹ä¸ŠåŽ»ã€‚&lt;/p>
&lt;p>ç»´æŠ¤ç›®å½•æ ‘ç»“æž„çš„ä¼˜åŠ¿åœ¨äºŽåˆ©ç”¨äº†æ–‡ä»¶ç³»ç»Ÿçš„å±€éƒ¨æ€§ï¼ˆlocalityï¼‰ï¼Œå¯ä»¥æ–¹ä¾¿çš„è¿›è¡Œé¢„å–ï¼ˆprefetchï¼‰ã€‚åŠ¨æ€çš„æ ‘åˆ’åˆ†ï¼Œå¯ä»¥ä¿è¯å…ƒä¿¡æ¯å¯ä»¥çº¿æ€§å¢žé•¿ï¼Œä»¥ä¿æŒé«˜å¯æ‰©å±•æ€§ã€‚&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/Wizmann/assets/master/wizmann-pic/20-11-29/2020-11-29_18-53-09.png" alt="">&lt;/p>
&lt;h2 id="å†™åœ¨æœ€åŽ">å†™åœ¨æœ€åŽ &lt;a href="#%e5%86%99%e5%9c%a8%e6%9c%80%e5%90%8e" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;p>æœ¬æ–‡åŸºäºŽCephçš„ä¸‰ç¯‡è®ºæ–‡ç»¼åˆè€Œæˆï¼ˆCephFSã€RADOSã€CRUSHï¼‰ã€‚å…¶ä¸­åŠ å…¥äº†ä¸€äº›è‡ªå·±çš„çœ‹æ³•ï¼Œä½¿å…¶é€»è¾‘é€šé¡ºï¼Œå¹¶ä¸ä¿è¯ä¸Žè®ºæ–‡çš„æ€è·¯å®Œå…¨ä¸€è‡´ã€‚&lt;/p>
&lt;p>è¿™ä¸‰ç¯‡è®ºæ–‡å¹¶æ²¡æœ‰æ˜Žç¡®çš„ä¾èµ–å…³ç³»ï¼Œæ¢å¥è¯è¯´ï¼Œéœ€è¦ç»¼åˆé˜…è¯»ï¼Œæ‰èƒ½æœ‰æ¯”è¾ƒæ˜Žç¡®çš„ç†è§£ã€‚&lt;/p>
&lt;p>å»ºè®®åœ¨é€šè¯»è®ºæ–‡åŽï¼ŒåŽ»å­¦ä¹ ä¸€ä¸‹&lt;a href="https://www.youtube.com/watch?v=PmLPbrf-x9g&amp;amp;ab_channel=Ceph">è¿™ä¸ªè§†é¢‘&lt;/a>ï¼Œä¼šå¯¹ç†è§£Cephæœ‰å¾ˆå¤§çš„å¸®åŠ©ã€‚Youtubeä¸Šé¢è¿˜æœ‰å¾ˆå¤šCephçš„tech talkï¼Œå¯ä»¥ä¸€å¹¶çš„äº†è§£ä¸€ä¸‹ã€‚&lt;/p>
&lt;p>Cephç›¸å…³çš„ä¹¦ç±ä»¥å®žè·µå±…å¤šï¼ŒåªæŽ¨è&lt;a href="https://www.oreilly.com/library/view/learning-ceph-/9781787127913/">Learning Ceph&lt;/a>ã€‚&lt;/p>
&lt;h2 id="å‚è€ƒé“¾æŽ¥">å‚è€ƒé“¾æŽ¥ &lt;a href="#%e5%8f%82%e8%80%83%e9%93%be%e6%8e%a5" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;ul>
&lt;li>&lt;a href="https://crossoverjie.top/2018/01/08/Consistent-Hash/">ä¸€è‡´æ€§ Hash ç®—æ³•åˆ†æž&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://zhuanlan.zhihu.com/p/60963885">ä»Žä¸€è‡´æ€§ hash åˆ° ceph crush&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://ceph.io/publications/">Ceph Publications&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>è‡ªå®šä¹‰ä½ çš„stream buffer - phxrpcé˜…è¯»ç¬”è®°(1)</title><link>https://wizmann.top/posts/phxrpc-1/</link><pubDate>Wed, 28 Sep 2016 22:35:55 +0000</pubDate><guid>https://wizmann.top/posts/phxrpc-1/</guid><description>&lt;h2 id="å†™åœ¨å‰é¢">å†™åœ¨å‰é¢ &lt;a href="#%e5%86%99%e5%9c%a8%e5%89%8d%e9%9d%a2" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;p>&lt;a href="https://github.com/tencent-wechat/phxrpc">phxrpc&lt;/a>æ˜¯å¾®ä¿¡å›¢é˜Ÿå¼€æºçš„ä¸€ä¸ªè½»é‡çº§RPCæ¡†æž¶ã€‚&lt;/p>
&lt;p>æˆ‘å¯¹RPCè¿™äº›ä¸œè¥¿äº†è§£ä¸å¤šï¼Œçœ‹åˆ°phxrpcçš„ä»£ç ç›¸å¯¹ç®€å•ï¼Œè€Œä¸”è¿˜åœ¨åˆæ­¥å¼€å‘é˜¶æ®µï¼ˆåœ¨æœ¬æ–‡å†™ä½œæ—¶ï¼Œç‰ˆæœ¬å·æ˜¯0.8ï¼‰ã€‚æ‰€ä»¥æƒ³è¯»ä¸€è¯»ï¼Œæé«˜ä¸€ä¸‹å§¿åŠ¿æ°´å¹³ã€‚&lt;/p>
&lt;p>å°±æ˜¯è¿™æ ·ã€‚&lt;/p>
&lt;h2 id="è‡ªå®šä¹‰stream-buffer">è‡ªå®šä¹‰stream buffer &lt;a href="#%e8%87%aa%e5%ae%9a%e4%b9%89stream-buffer" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;p>&lt;code>network/socket_stream_base.[h|cpp]&lt;/code>ä¸­çš„&lt;code>class BaseTcpStreamBuf&lt;/code>ç»§æ‰¿äº†&lt;code>std::streambuf&lt;/code>ï¼Œè‡ªå®šä¹‰äº†ä¸€ä¸ªæµç¼“å†²åŒºï¼Œç”¨äºŽæŽ¥æ”¶/å‘é€TCPæ•°æ®åŒ…ã€‚&lt;/p>
&lt;p>è¿™ä¸ªç”¨æ³•æ¯”è¾ƒæ–°é¢–ï¼ˆæˆ–è€…æ˜¯æˆ‘è§è¯†å°‘ï¼‰ï¼Œç½‘ä¸Šçš„èµ„æ–™ä¹Ÿä¸å¤šã€‚è¿™é‡Œç¿»è¯‘ä¸€ç¯‡&lt;a href="http://www.mr-edd.co.uk/blog/beginners_guide_streambuf">ä»‹ç»æ–‡ç« &lt;/a>ï¼Œå­¦ä¹ ä¸€ä¸‹æ–°å§¿åŠ¿ã€‚&lt;/p>
&lt;h2 id="a-beginners-guide-to-writing-a-custom-stream-buffer">A beginner&amp;rsquo;s guide to writing a custom stream buffer &lt;a href="#a-beginners-guide-to-writing-a-custom-stream-buffer" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;p>æµ(streams)æ˜¯STLä¸­æä¾›çš„ä¸€ä¸ªé‡è¦çš„æŠ½è±¡æ¦‚å¿µã€‚è‘—åçš„â€œHello worldâ€ç¨‹åºï¼Œä¾¿æ˜¯ä½¿ç”¨äº†std::coutå°†å­—ç¬¦ä¸²å†™å…¥æ ‡å‡†è¾“å‡ºæµ(stdout)ã€‚&lt;/p>
&lt;p>æµå½“ç„¶å¯ä»¥åšæ¯”cin/coutæ›´æœ‰æ„æ€çš„äº‹ã€‚è¿™ç¯‡æ–‡ç« æˆ‘ä»¬ä¼šç ”ç©¶å¦‚ä½•æ‰©å±•C++æµï¼Œæ¥å®žçŽ°è‡ªå®šä¹‰çš„æµç¼“å†²åŒº(stream buffer)ã€‚p.s. å»ºè®®æœ¬æ–‡çš„è¯»è€…è‡³å°‘è¦æœ‰åŸºç¡€çš„C++çŸ¥è¯†ã€‚&lt;/p>
&lt;p>C++æ ‡å‡†åº“ä¸ºç£ç›˜æ–‡ä»¶æ“ä½œæä¾›äº†åŸºç¡€çš„æŽ¥å£ï¼Œå¦‚&lt;code>std::fstream&lt;/code>ï¼Œ&lt;code>std::ifstream&lt;/code>å’Œ&lt;code>std::ofstream&lt;/code>ã€‚æˆ‘ä»¬è¿˜æœ‰&lt;code>stringstream&lt;/code>ï¼Œå¯ä»¥åƒæµä¸€æ ·æ“ä½œå­—ç¬¦ä¸²ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>std&lt;span style="color:#f92672">::&lt;/span>ostringstream oss;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>oss &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#e6db74">&amp;#34;Hello, world!&lt;/span>&lt;span style="color:#ae81ff">\\&lt;/span>&lt;span style="color:#e6db74">n&amp;#34;&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>oss &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#ae81ff">123&lt;/span> &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">&amp;#39;\\&lt;/span>n&lt;span style="color:#960050;background-color:#1e0010">&amp;#39;&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>std&lt;span style="color:#f92672">::&lt;/span>string s &lt;span style="color:#f92672">=&lt;/span> oss.str();
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç›¸ä¼¼çš„ï¼Œæˆ‘ä»¬å¯ä»¥ä»Ž&lt;code>std::istringstream&lt;/code>ä¸­ä½¿ç”¨&lt;code>&amp;gt;&amp;gt;&lt;/code>æ“ä½œç¬¦è¯»å–æ•°æ®ã€‚&lt;/p>
&lt;p>Booståº“ä¸­çš„&lt;code>lexical_cast&lt;/code>æ­£æ˜¯ä½¿ç”¨äº†è¿™ç§æœºåˆ¶ï¼Œè®©ç”¨æˆ·å¯ä»¥ä½¿ç”¨ç»Ÿä¸€çš„æ–¹å¼å°†ä¸€ä¸ªå¯¹è±¡(object)è½¬æ¢ä¸ºå­—ç¬¦ä¸²è¡¨ç¤ºã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">using&lt;/span> boost&lt;span style="color:#f92672">::&lt;/span>lexical_cast;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">using&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>string;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">int&lt;/span> x &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">5&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>string s &lt;span style="color:#f92672">=&lt;/span> lexical_cast&lt;span style="color:#f92672">&amp;lt;&lt;/span>string&lt;span style="color:#f92672">&amp;gt;&lt;/span>(x);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>assert(s &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#e6db74">&amp;#34;5&amp;#34;&lt;/span>);
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æµç¼“å†²åŒºæœ‰ç€å¾ˆå¼ºçš„çµæ´»æ€§ï¼Œå¯ä»¥æ»¡è¶³ä¸åŒçš„â€œç¼“å†²å¹¶ä¼ è¾“å­—ç¬¦ï¼ˆä¸²ï¼‰â€éœ€æ±‚ï¼Œæ¯”å¦‚æ–‡ä»¶æ“ä½œã€å­—ç¬¦ä¸²æ“ä½œã€å‘½ä»¤è¡Œ(Console)æ“ä½œç­‰ã€‚æˆ‘ä»¬å¯ä»¥ä»Žç½‘ç»œã€é—ªå­˜(Flash memory)ç­‰ä¸åŒè®¾å¤‡ï¼Œä½¿ç”¨åŒæ ·çš„æŽ¥å£èŽ·å–æµå¼å­—ç¬¦ä¸²ã€‚â€œæµç¼“å†²åŒºâ€ä¸Žâ€œæµâ€æ˜¯æ­£äº¤çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥è‡ªç”±çš„äº¤æ¢ã€æ›´æ”¹(swap and change)æµæ‰€ä½¿ç”¨çš„ç¼“å†²åŒºï¼Œæˆ–è€…å°†å…¶é‡å®šå‘åˆ°å…¶å®ƒåœ°æ–¹ã€‚æˆ‘è®¤ä¸ºC++ä¸­çš„æµï¼Œæ­£æ˜¯â€œç­–ç•¥æ¨¡å¼â€(strategy design pattern)çš„ä¸€ä¸ªè‰¯å¥½èŒƒä¾‹ã€‚&lt;/p>
&lt;p>æ¯”å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥é‡å®šå‘æ ‡å‡†æ—¥å¿—æµ&lt;code>std::clog&lt;/code>åˆ°ä¸€ä¸ªå­—ç¬¦ä¸²æµï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;iostream&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;iomanip&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;string&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;sstream&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">int&lt;/span> &lt;span style="color:#a6e22e">main&lt;/span>()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> std&lt;span style="color:#f92672">::&lt;/span>ostringstream oss;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// Make clog use the buffer from oss
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>streambuf &lt;span style="color:#f92672">*&lt;/span>former_buff &lt;span style="color:#f92672">=&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> std&lt;span style="color:#f92672">::&lt;/span>clog.rdbuf(oss.rdbuf());
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> std&lt;span style="color:#f92672">::&lt;/span>clog &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#e6db74">&amp;#34;This will appear in oss!&amp;#34;&lt;/span> &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>flush;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> std&lt;span style="color:#f92672">::&lt;/span>cout &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> oss.str() &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">&amp;#39;\\&lt;/span>n&lt;span style="color:#960050;background-color:#1e0010">&amp;#39;&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// Give clog back its previous buffer
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>clog.rdbuf(former_buff);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¸è¿‡ï¼Œè‡ªå®šä¹‰ä¸€ä¸ªæµç¼“å†²åŒºå´æ˜¯æœ‰ä¸€ç‚¹trickyï¼Œæˆ–è€…è¯´æœ‰ä¸€ç‚¹å“äººï¼Œå°¤å…¶æ˜¯å½“ä½ ç¬¬ä¸€æ¬¡å°è¯•çš„æ—¶å€™ã€‚æ‰€ä»¥æœ¬æ–‡æ„åœ¨æä¾›ä¸€äº›æµç¼“å†²çš„å®žçŽ°èŒƒä¾‹ã€‚&lt;/p>
&lt;p>é¦–å…ˆæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹æµç¼“å†²åŒºçš„ä¸€äº›åŸºæœ¬æ¦‚å¿µã€‚æ‰€æœ‰çš„æµç¼“å†²åŒºç»§æ‰¿è‡ª&lt;code>std::streambuf&lt;/code>ï¼Œå¹¶ä¸”éœ€è¦è¦†ç›–ä¸€äº›è™šå‡½æ•°æ¥å®žçŽ°è‡ªå®šä¹‰åŠŸèƒ½ã€‚&lt;code>std::streambuf&lt;/code>æ˜¯â€œé¡ºåºè¯»å–è®¾å¤‡â€çš„ä¸€ä¸ªæŠ½è±¡ï¼Œå³æˆ‘ä»¬å¯ä»¥ä»Žä¸­é¡ºåºçš„è¯»å–å­—ç¬¦åºåˆ—ã€‚åœ¨ç‰¹å®šçš„åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥é‡å¡«(re-fill)ã€å†²æ´—(flush)ä»¥åŠæ¸…ç©º(empty)ä¸€ä¸ªç¼“å†²åŒºã€‚&lt;/p>
&lt;p>å½“æˆ‘ä»¬å‘ä¸€ä¸ª&lt;code>ostream&lt;/code>ä¸­æ’å…¥æ•°æ®æ—¶ï¼Œæ•°æ®å°†ä¼šè¢«å†™å…¥ç¼“å†²åŒºä¸­çš„ä¸€ä¸ªæ•°ç»„ã€‚å½“æ•°ç»„ä¸Šæº¢(overflow)æ—¶ï¼Œæ•°ç»„ä¸­çš„æ•°æ®å°†ä¼šè¢«å†²æ´—(flush)åˆ°ç›®æ ‡æŽ¥å—è€…ï¼Œä¹‹åŽè¿™ä¸ªæ•°ç»„çš„çŠ¶æ€å°†ä¼šé‡ç½®ï¼Œä»¥ä¾¿å­˜å‚¨åŽç»­çš„å­—ç¬¦ã€‚&lt;/p>
&lt;p>å½“æˆ‘ä»¬ä»Žä¸€ä¸ª&lt;code>istream&lt;/code>ä¸­èŽ·å–æ•°æ®æ—¶ï¼Œæ•°æ®ä»Žç¼“å†²åŒºçš„æ•°ç»„ä¸­è¯»å‡ºã€‚å½“æ•°ç»„ä¸‹æº¢æ—¶(underflow)ï¼Œæ²¡æœ‰æ•°æ®å¯è¯»ï¼Œæˆ‘ä»¬ä¼šä»Žæ•°æ®æºé‡æ–°æ‹‰å–ä¿¡æ¯æ¥å¡«å……ç¼“å†²åŒºï¼Œä¹‹åŽè¿™ä¸ªæ•°ç»„çš„çŠ¶æ€ä¹Ÿå°†è¢«é‡ç½®ã€‚&lt;/p>
&lt;p>æˆ‘ä»¬ä½¿ç”¨6ä¸ªæŒ‡é’ˆï¼Œæ¥ç»´æŠ¤ç¼“å†²åŒºçš„å†…éƒ¨çŠ¶æ€ã€‚è¾“å…¥å’Œè¾“å‡ºç¼“å†²å„ä½¿ç”¨3ä¸ªæŒ‡é’ˆã€‚&lt;/p>
&lt;h3 id="ç»´æŠ¤è¾“å‡ºç¼“å†²åŒºçš„çŠ¶æ€">ç»´æŠ¤è¾“å‡ºç¼“å†²åŒºçš„çŠ¶æ€ &lt;a href="#%e7%bb%b4%e6%8a%a4%e8%be%93%e5%87%ba%e7%bc%93%e5%86%b2%e5%8c%ba%e7%9a%84%e7%8a%b6%e6%80%81" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;ul>
&lt;li>
&lt;p>put base pointer &lt;br>
è¾“å‡ºåŸºæŒ‡é’ˆï¼Œç”¨æ¥æŒ‡å®šç¼“å†²åŒºå†…éƒ¨æ•°ç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´ ã€‚å¯ä»¥ä½¿ç”¨&lt;code>std::streambuf::pbase()&lt;/code>æ¥èŽ·å–&lt;/p>
&lt;/li>
&lt;li>
&lt;p>put pointer &lt;br>
è¾“å‡ºæŒ‡é’ˆï¼Œç”¨æ¥æŒ‡å‘å†…éƒ¨æ•°ç»„ä¸‹ä¸€ä¸ªå†™å…¥çš„åœ°å€ã€‚å¯ä»¥ä½¿ç”¨&lt;code>std::streambuf::pptr()&lt;/code>æ¥èŽ·å–&lt;/p>
&lt;/li>
&lt;li>
&lt;p>end put pointer &lt;br>
è¾“å‡ºå“¨å…µæŒ‡é’ˆï¼ŒæŒ‡å‘å†…éƒ¨æ•°ç»„æœ€åŽä¸€ä¸ªå†åŽé¢ä¸€ä¸ª(one-past-the-last-element)çš„åœ°å€ï¼ˆè¯‘æ³¨ï¼šç±»ä¼¼&lt;code>std::vector::end()&lt;/code>ï¼‰ã€‚å¯ä»¥ä½¿ç”¨&lt;code>std::streambuf:epptr()&lt;/code>æ¥èŽ·å–&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="http://i1.piimg.com/567571/630a89fe635e1635.png" alt="">&lt;/p>
&lt;p>ä¸€èˆ¬æ¥è¯´ï¼ŒåŸºæŒ‡é’ˆå’Œå“¨å…µæŒ‡é’ˆä¸ä¼šæ”¹å˜ï¼Œåœ¨ä½¿ç”¨æ—¶ï¼Œä»¥è¾“å‡ºæŒ‡é’ˆç»´æŠ¤å†…éƒ¨çŠ¶æ€ã€‚&lt;/p>
&lt;h3 id="ç»´æŠ¤è¾“å…¥ç¼“å†²åŒºçš„çŠ¶æ€">ç»´æŠ¤è¾“å…¥ç¼“å†²åŒºçš„çŠ¶æ€ &lt;a href="#%e7%bb%b4%e6%8a%a4%e8%be%93%e5%85%a5%e7%bc%93%e5%86%b2%e5%8c%ba%e7%9a%84%e7%8a%b6%e6%80%81" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;p>è¾“å…¥ç¼“å†²åŒºå’ŒçŠ¶æ€ç»´æŠ¤å’Œè¾“å‡ºç¼“å†²åŒºç±»ä¼¼ï¼Œæˆ‘ä»¬æœ‰ï¼š&lt;/p>
&lt;ul>
&lt;li>end back pointer &lt;br>
è¾“å…¥åŸºæŒ‡é’ˆï¼ŒæŒ‡å‘ç¼“å†²åŒºæ•°ç»„å†…çš„æœ€åŽä¸€ä¸ªå­—ç¬¦ã€‚å¯ä»¥ä½¿ç”¨&lt;code>std::streambuf::eback()&lt;/code>æ¥èŽ·å–&lt;/li>
&lt;li>get pointer &lt;br>
è¾“å…¥æŒ‡é’ˆï¼ŒæŒ‡å‘ç¼“å†²åŒºä¸‹ä¸€ä¸ªè¯»å–çš„å­—ç¬¦åœ°å€ã€‚å¯ä»¥ä½¿ç”¨&lt;code>std::streambuf::gptr()&lt;/code>æ¥èŽ·å–&lt;/li>
&lt;li>end get pointer &lt;br>
è¾“å…¥å“¨å…µæŒ‡é’ˆï¼Œæ‰¹å·å‘å†…éƒ¨æ•°ç»„æœ€åŽä¸€ä¸ªå†åŽé¢ä¸€ä¸ª(one-past-the-last-element)çš„åœ°å€ã€‚å¯ä»¥ä½¿ç”¨&lt;code>std::streambuf::egptr()&lt;/code>æ¥èŽ·å–&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://github.com/Wizmann/assets/raw/master/wizmann-pic/16-9-27/33500590.jpg" alt="">&lt;/p>
&lt;p>åŒæ ·ï¼ŒåŸºæŒ‡é’ˆå’Œå“¨å…µæŒ‡é’ˆåœ¨æµç¼“å†²åŒºçš„ç”Ÿå‘½å‘¨æœŸä¸­ä¹Ÿä¸ä¼šæ”¹å˜ã€‚&lt;/p>
&lt;p>ç”±äºŽè¾“å…¥ç¼“å†²åŒºè¦æ”¯æŒ&lt;code>putback()&lt;/code>æ“ä½œï¼Œå³å°†è¯»å‡ºçš„å­—ç¬¦é‡æ–°æ”¾å›žç¼“å†²åŒºï¼Œæ‰€ä»¥è¾“å…¥ç¼“å†²åŒºæ¯”è¾“å‡ºç¼“å†²åŒºæ›´å¤æ‚ä¸€ç‚¹ã€‚é€šå¸¸æ¥è¯´ï¼Œ&lt;code>putback()&lt;/code>æ“ä½œæ”¯æŒæ”¾å›žä¸€ä¸ªå­—ç¬¦å³å¯ã€‚&lt;/p>
&lt;p>ä¸€ä¸ª&lt;code>std::streambuf&lt;/code>å¯ä»¥åŒæ—¶æ”¯æŒè¾“å…¥è¾“å‡ºä¸¤ç§æ“ä½œï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸éœ€è¦æˆ‘åˆ†åˆ«å®žçŽ°&lt;code>std::istreambuf&lt;/code>å’Œ&lt;code>std::ostreambuf&lt;/code>ã€‚&lt;code>std::fstream&lt;/code>æ˜¯ä¸€ä¸ªè‰¯å¥½çš„ä¾‹å­ã€‚ä½†æ˜¯ï¼Œå®žçŽ°ä¸€ä¸ªå…¨åŠŸèƒ½çš„ç¼“å†²åŒºç›¸å¯¹æ›´å¤æ‚ä¸€äº›ï¼Œæ‰€ä»¥æˆ‘å°±ä¸è¶Ÿæµ‘æ°´å•¦~ ï¼šï¼‰&lt;/p>
&lt;p>åŒæ—¶ï¼Œæµç¼“å†²åŒºä¹Ÿå¯ä»¥æ”¯æŒå®½å­—ç¬¦(wide character)ã€‚&lt;code>std::streambuf&lt;/code>æ˜¯&lt;code>std::basic_streambuf&amp;lt;char&amp;gt;&lt;/code>çš„åˆ«åï¼Œå¦‚æžœä½ éœ€è¦å®½å­—ç¬¦æµç¼“å†²åŒºï¼Œå¯ä»¥ä½¿ç”¨&lt;code>std::basic_streambuf&amp;lt;wchar_t&amp;gt;&lt;/code>ã€‚&lt;/p>
&lt;h3 id="ä¾‹1æ–‡ä»¶ç¼“å†²åŒº--ä¸Žcä»£ç é›†æˆ">ä¾‹1ï¼šæ–‡ä»¶ç¼“å†²åŒº â€”â€” ä¸ŽCä»£ç é›†æˆ &lt;a href="#%e4%be%8b1%e6%96%87%e4%bb%b6%e7%bc%93%e5%86%b2%e5%8c%ba--%e4%b8%8ec%e4%bb%a3%e7%a0%81%e9%9b%86%e6%88%90" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;p>å‡è®¾æˆ‘ä»¬éœ€è¦è°ƒç”¨ä¸€ä¸ªåŽ†å²æ‚ ä¹…çš„åº“ï¼Œä¸€ä¸ªæ–‡ä»¶æ“ä½œå‡½æ•°ä¼šè¿”å›žç»™ä¸€ä¸ª&lt;code>FILE*&lt;/code>æŒ‡é’ˆï¼Œä½†æ˜¯æˆ‘ä»¬æƒ³ç”¨C++çš„æµæŽ¥å£æ¥è¯»å†™æ•°æ®ã€‚æˆ‘ä»¬å…ˆä»Žè¯»æ–‡ä»¶å¼€å§‹ï¼Œç”¨&lt;code>std::istream&lt;/code>åŒ…è£…&lt;code>FILE*&lt;/code>çš„è¯»æ“ä½œã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;streambuf&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;vector&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;cstdlib&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;cstdio&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">FILE_buffer&lt;/span> &lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#66d9ef">public&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>streambuf
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">public&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">explicit&lt;/span> FILE_buffer(FILE &lt;span style="color:#f92672">*&lt;/span>fptr, std&lt;span style="color:#f92672">::&lt;/span>size_t buff_sz &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">256&lt;/span>, std&lt;span style="color:#f92672">::&lt;/span>size_t put_back &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">8&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">private&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// overrides base class underflow()
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> int_type underflow();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// copy ctor and assignment not implemented;
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75715e">// copying not allowed
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> FILE_buffer(&lt;span style="color:#66d9ef">const&lt;/span> FILE_buffer &lt;span style="color:#f92672">&amp;amp;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> FILE_buffer &lt;span style="color:#f92672">&amp;amp;&lt;/span>&lt;span style="color:#66d9ef">operator&lt;/span>&lt;span style="color:#f92672">=&lt;/span> (&lt;span style="color:#66d9ef">const&lt;/span> FILE_buffer &lt;span style="color:#f92672">&amp;amp;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">private&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> FILE &lt;span style="color:#f92672">*&lt;/span>fptr_;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">const&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>size_t put_back_;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> std&lt;span style="color:#f92672">::&lt;/span>vector&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">char&lt;/span>&lt;span style="color:#f92672">&amp;gt;&lt;/span> buffer_;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>};
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç”±äºŽåŠŸèƒ½ç®€å•ï¼Œæˆ‘ä»¬åªéœ€è¦å®žçŽ°æž„é€ å‡½æ•°ä»¥åŠ&lt;code>underflow&lt;/code>æŽ¥å£å°±å¯ä»¥å®žçŽ°æˆ‘ä»¬çš„åŠŸèƒ½ã€‚&lt;/p>
&lt;p>æž„é€ å‡½æ•°æŒ‡å®šäº†è¯»å–æ–‡ä»¶çš„&lt;code>FILE*&lt;/code>æŒ‡é’ˆï¼Œä»¥åŠå†…éƒ¨ç¼“å†²æ•°ç»„çš„å¤§å°ã€‚æ•°ç»„å¤§å°ç”±ä¸¤ä¸ªå‚æ•°å†³å®šï¼š&lt;/p>
&lt;ul>
&lt;li>put-back area size&lt;/li>
&lt;li>buffer size&lt;/li>
&lt;/ul>
&lt;p>æˆ‘ä»¬ä½¿ç”¨&lt;code>std::vector&amp;lt;char&amp;gt;&lt;/code>åšä¸ºç¼“å†²åŒºåŸŸã€‚&lt;code>put_back_&lt;/code>å˜é‡ç”¨äºŽå­˜å‚¨&amp;quot;put-back&amp;quot;åŒºåŸŸçš„å¤§å°ã€‚&lt;/p>
&lt;p>ä»¥ä¸‹æ˜¯æž„é€ å‡½æ•°çš„å®žçŽ°ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">using&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>size_t;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>FILE_buffer&lt;span style="color:#f92672">::&lt;/span>FILE_buffer(FILE &lt;span style="color:#f92672">*&lt;/span>fptr, size_t buff_sz, size_t put_back) &lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> fptr_(fptr),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> put_back_(std&lt;span style="color:#f92672">::&lt;/span>max(put_back, size_t(&lt;span style="color:#ae81ff">1&lt;/span>))),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> buffer_(std&lt;span style="color:#f92672">::&lt;/span>max(buff_sz, put_back_) &lt;span style="color:#f92672">+&lt;/span> put_back_)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span>end &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#f92672">&amp;amp;&lt;/span>buffer_.front() &lt;span style="color:#f92672">+&lt;/span> buffer_.size();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> setg(end, end, end);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>åœ¨åˆå§‹åŒ–åˆ—è¡¨ä¸­ï¼Œæˆ‘ä»¬å°†ç¼“å†²åŒºçš„å¸¸é‡è¿›è¡Œèµ‹å€¼ã€‚ä¹‹åŽä½¿ç”¨&lt;code>std::streambuf::setg()&lt;/code>æ¥åˆå§‹åŒ–è¾“å‡ºç¼“å†²åŒºã€‚&lt;/p>
&lt;p>&lt;code>setg()&lt;/code>çš„ä¸‰ä¸ªå‚æ•°åˆ†åˆ«ä»£è¡¨&lt;code>eback()&lt;/code>ï¼Œ&lt;code>gptr()&lt;/code>ï¼Œ&lt;code>egptr()&lt;/code>ä¸‰ä¸ªå†…éƒ¨æŒ‡é’ˆçš„å€¼ã€‚ä¸€å¼€å§‹ï¼Œæˆ‘ä»¬å°†å®ƒä»¬éƒ½æŒ‡å‘åŒä¸€ä¸ªåœ°å€ã€‚è¡¨æ˜Žbufferæ˜¯ç©ºçš„ï¼Œåœ¨ä¸‹ä¸€æ¬¡è¯»å–æ—¶ï¼Œä¼šé‡æ–°å¡«å……ç¼“å†²åŒºã€‚&lt;/p>
&lt;p>&lt;code>underflow()&lt;/code>ä¼šè¿”å›žæ•°æ®æºä¸­å½“å‰çš„å­—ç¬¦ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œä¼šè¿”å›žbufferä¸­çš„ä¸‹ä¸€ä¸ªå¯ç”¨å­—ç¬¦ã€‚ç„¶åŽå½“bufferä¸ºç©ºæ—¶ï¼Œ&lt;code>underflow()&lt;/code>åº”è¯¥é‡æ–°å¡«å……ç¼“å†²åŒºæ•°ç»„ï¼Œåœ¨æœ¬ä¾‹ä¸­ï¼Œå³ä»Ž&lt;code>FILE*&lt;/code>ä¸­è¯»å–å­—ç¬¦ã€‚å½“ç¼“å†²åŒºé‡å¡«åŽï¼Œæˆ‘ä»¬éœ€è¦å†æ¬¡è°ƒç”¨&lt;code>setg()&lt;/code>æ›´æ–°æµç¼“å†²åŒºçš„çŠ¶æ€ã€‚&lt;/p>
&lt;p>å½“æ•°æ®æºä¸­çš„æ•°æ®è¯»å®Œ(depleted)åŽï¼Œ&lt;code>underflow()&lt;/code>ä¼šè¿”å›žä¸€ä¸ª&lt;code>traits_type::eof()&lt;/code>ã€‚è¿™é‡Œè¦æ³¨æ„ï¼Œ&lt;code>underflow()&lt;/code>çš„è¿”å›žå€¼æ˜¯&lt;code>int_type&lt;/code>ï¼Œè¿™ä¸ªå€¼è¶³å¤Ÿè£…ä¸‹&lt;code>eof()&lt;/code>ï¼ŒåŒæ—¶ä¹Ÿè¶³å¤Ÿè£…ä¸‹ä»»ä½•çš„å­—ç¬¦ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>std&lt;span style="color:#f92672">::&lt;/span>streambuf&lt;span style="color:#f92672">::&lt;/span>int_type FILE_buffer&lt;span style="color:#f92672">::&lt;/span>underflow()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (gptr() &lt;span style="color:#f92672">&amp;lt;&lt;/span> egptr()) &lt;span style="color:#75715e">// buffer not exhausted
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">return&lt;/span> traits_type&lt;span style="color:#f92672">::&lt;/span>to_int_type(&lt;span style="color:#f92672">*&lt;/span>gptr());
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span>base &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#f92672">&amp;amp;&lt;/span>buffer_.front();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span>start &lt;span style="color:#f92672">=&lt;/span> base;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (eback() &lt;span style="color:#f92672">==&lt;/span> base) &lt;span style="color:#75715e">// true when this isn&amp;#39;t the first fill
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// Make arrangements for putback characters
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>memmove(base, egptr() &lt;span style="color:#f92672">-&lt;/span> put_back_, put_back_);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> start &lt;span style="color:#f92672">+=&lt;/span> put_back_;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// start is now the start of the buffer, proper.
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75715e">// Read from fptr_ in to the provided buffer
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> size_t n &lt;span style="color:#f92672">=&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>fread(start, &lt;span style="color:#ae81ff">1&lt;/span>, buffer_.size() &lt;span style="color:#f92672">-&lt;/span> (start &lt;span style="color:#f92672">-&lt;/span> base), fptr_);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (n &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> traits_type&lt;span style="color:#f92672">::&lt;/span>eof();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// Set buffer pointers
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> setg(base, start, start &lt;span style="color:#f92672">+&lt;/span> n);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> traits_type&lt;span style="color:#f92672">::&lt;/span>to_int_type(&lt;span style="color:#f92672">*&lt;/span>gptr());
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å‡½æ•°çš„ç¬¬ä¸€è¡Œï¼Œé¦–å…ˆåˆ¤æ–­bufferæ˜¯å¦è€—å°½ã€‚å¦‚æžœå¦ï¼Œåˆ™è¿”å›žå½“å‰å­—ç¬¦ï¼Œå³&lt;code>*gptr()&lt;/code>ã€‚å¦‚æžœæ˜¯ï¼Œåˆ™è¿›è¡Œé‡å¡«(re-fill)æ“ä½œã€‚&lt;/p>
&lt;p>å›žæƒ³ä¸€ä¸‹æˆ‘ä»¬åœ¨æž„é€ å‡½æ•°ä¸­çš„å®žçŽ°ï¼Œä¸‰ä¸ªçŠ¶æ€æŒ‡é’ˆå…¨éƒ½æŒ‡å‘ç¼“å†²åŒºçš„æœ«å°¾ã€‚å¦‚æžœæˆ‘ä»¬è°ƒç”¨&lt;code>underflow()&lt;/code>æ—¶ï¼Œå‘çŽ°çŠ¶æ€æŒ‡é’ˆå¹¶éžå¦‚æ­¤ï¼Œåˆ™è¯´æ˜Žç¼“å†²åŒºå·²ç»è¢«å¡«å……äº†è‡³å°‘ä¸€æ¬¡ã€‚&lt;/p>
&lt;p>çŽ°åœ¨æˆ‘ä»¬è€ƒè™‘é‡å¡«æ“ä½œï¼Œæˆ‘ä»¬&lt;code>memmove&lt;/code>æœ€åŽ&lt;code>put_back_&lt;/code>ä¸ªå­—ç¬¦åˆ°bufferçš„æœ«å°¾ï¼Œç”¨åš&amp;quot;put-back area&amp;quot;ã€‚ï¼ˆæˆ‘ä»¬ä¸ç”¨&lt;code>memcopy&lt;/code>å› ä¸ºæˆ‘ä»¬çš„bufferæ¯”è¾ƒå°ï¼Œ`memmove()çš„æ•ˆçŽ‡ä¼šæ›´é«˜ä¸€äº›ï¼‰&lt;/p>
&lt;blockquote>
&lt;p>è¯‘æ³¨ï¼šå®žé™…ä¸Šï¼Œ&lt;code>memcopy&lt;/code>ä¸Ž&lt;code>memmove&lt;/code>å„æœ‰æ‰€é•¿ã€‚&lt;code>memcopy&lt;/code>ä¸éœ€è¦åˆ¤æ–­å†…å­˜overlapçš„æƒ…å†µï¼Œå³å¦‚æžœæºåŒºé—´ä¸Žç›®æ ‡åŒºé—´æœ‰é‡å ï¼Œé‚£ä¹ˆå¾—åˆ°çš„ç»“æžœä¼šæ˜¯é”™çš„ã€‚è€Œ&lt;code>memmove&lt;/code>ç”±äºŽæ˜¯ç§»åŠ¨è¯­ä¹‰ï¼Œæ‰€ä»¥åœ¨ç§»åŠ¨æ­¥é•¿è¾ƒå°æ—¶ï¼Œå¯ä»¥åªæ“ä½œcacheã€‚æ‰€ä»¥äºŒè€…å„æœ‰æ‰€é•¿ï¼Œè¦æ ¹æ®å…·ä½“æƒ…å†µåˆ¤æ–­ä¼˜åŠ£ã€‚Stackoverflowä¸Šæœ‰æ›´è¯¦ç»†çš„&lt;a href="http://stackoverflow.com/questions/28623895/why-is-memmove-faster-than-memcpy">è®¨è®º&lt;/a>&lt;/p>&lt;/blockquote>
&lt;p>æˆ‘ä»¬å¤„ç†å®Œ&amp;quot;put-back area&amp;quot;ä¹‹åŽï¼Œå°±å¯ä»¥ä½¿ç”¨&lt;code>fread()&lt;/code>å‡½æ•°æ¥é‡å¡«ç¼“å†²åŒºäº†ã€‚å¦‚æžœè¯»ä¸åˆ°æ•°æ®ï¼Œåˆ™æ„å‘³ç€æ–‡ä»¶å·²ç»è¯»åˆ°äº†ç»“å°¾ï¼ˆå½“ç„¶è¿™æ˜¯ä¸€ç§ç®€åŒ–æƒ…å†µï¼Œä½†åœ¨çŽ°å®žä¸­99.9%çš„è¯»å–å¤±è´¥éƒ½æ˜¯å› ä¸ºæ–‡ä»¶ç»“æŸï¼‰ã€‚&lt;/p>
&lt;p>åœ¨&lt;code>fread()&lt;/code>æˆåŠŸè¯»å–æ•°æ®ä¹‹åŽï¼Œæˆ‘ä»¬é€šçŸ¥streambufæ›´æ–°å†…éƒ¨çš„ä¸‰ä¸ªçŠ¶æ€æŒ‡é’ˆã€‚ä¹‹åŽè¿”å›žbufferå½“å‰çš„æŒ‡é’ˆã€‚&lt;/p>
&lt;p>è¿™å°±æ˜¯æˆ‘ä»¬çš„æµç¼“å†²åŒºçš„åŸºæœ¬å®žçŽ°ï¼Œå¸Œæœ›è¿™å¹¶ä¸æ˜¯å¤ªéš¾ã€‚å½“ç„¶æˆ‘ä»¬è¿˜å¯ä»¥æ·»åŠ æ›´å¤šçš„åŠŸèƒ½ã€‚ç‰¹åˆ«çš„æ˜¯æˆ‘ä»¬å¯ä»¥åœ¨ç¼“å†²åŒºé‡Œé¢è¿›è¡ŒæŸ¥æ‰¾ã€‚å¦‚æžœä½ æƒ³å®žçŽ°å®ƒçš„è¯ï¼Œå¯ä»¥è¯•è¯•é‡å†™&lt;code>std::streambuf::seekoff()&lt;/code>å’Œ&lt;code>std::streambuf::seekpos&lt;/code>è™šæˆå‘˜å‡½æ•°ã€‚&lt;/p>
&lt;p>æˆ‘ä»¬ä¹Ÿå¯ä»¥å®žçŽ°å†™ç¼“å†²åŒºã€‚ä¸è¿‡ï¼Œåœ¨ä½ ä»¬è¯»å®Œç¬¬ä¸‰ä¸ªä¾‹å­ä¹‹åŽï¼Œä½ ä»¬å°±å¯ä»¥è½»æ¾æ„‰å¿«çš„å®žçŽ°è‡ªå·±çš„ç‰ˆæœ¬äº†ï¼Œä¸éª—ä½ ã€‚&lt;/p>
&lt;h3 id="ä¾‹2è¯»å–å†…å­˜ä¸­çš„æ•°ç»„">ä¾‹2ï¼šè¯»å–å†…å­˜ä¸­çš„æ•°ç»„ &lt;a href="#%e4%be%8b2%e8%af%bb%e5%8f%96%e5%86%85%e5%ad%98%e4%b8%ad%e7%9a%84%e6%95%b0%e7%bb%84" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;p>æœ¬ä¾‹ä¸­ï¼Œæˆ‘ä»¬è¦ä½¿ç”¨&lt;code>std::istream&lt;/code>åŒ…è£…å†…å­˜ä¸­çš„ä¸€ä¸ªåªè¯»æ•°ç»„ï¼Œå¹¶ä¸”æ ¼å¼åŒ–çš„è¿›è¡Œè¯»å…¥ã€‚è¿™ä¸ªä¾‹å­å’Œä¸Šä¸€ä¸ªä¾‹å­æœ‰ä¸€ç‚¹ä¸åŒçš„æ˜¯ï¼Œæˆ‘ä»¬å¹¶ä¸éœ€è¦ä¸€ä¸ªçœŸæ­£çš„ç¼“å†²æ•°ç»„ï¼Œä»Žæºæ•°ç»„ä¸€æ¬¡æ€§è¯»å–å°±å¥½äº†ã€‚&lt;/p>
&lt;p>æƒ³è±¡ä¸­çš„å®žçŽ°æ˜¯è¿™ä¸ªæ ·å¼å„¿çš„ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">char_array_buffer&lt;/span> &lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#66d9ef">public&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>streambuf
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">public&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> char_array_buffer(&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span>begin, &lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span>end)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> setg(begin, begin, end);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> int_type &lt;span style="color:#a6e22e">underflow&lt;/span>()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> gptr() &lt;span style="color:#f92672">==&lt;/span> egptr() &lt;span style="color:#f92672">?&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> traits_type&lt;span style="color:#f92672">::&lt;/span>eof() &lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> traits_type&lt;span style="color:#f92672">::&lt;/span>to_int_type(&lt;span style="color:#f92672">*&lt;/span>gptr());
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>};
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä½†æ˜¯ï¼Œè¿™å¹¶æ²¡æœ‰ä»€ä¹ˆåµç”¨ã€‚å› ä¸º&lt;code>setg()&lt;/code>å‡½æ•°åªæŽ¥å—éžå¸¸é‡(non-const)æŒ‡é’ˆå‚æ•°ã€‚è¿™æ˜¾è€Œæ˜“è§ï¼Œå¦‚æžœä¸€ä¸ªç¼“å†²åŒºä¸å¯å†™ï¼Œæˆ‘ä»¬å°±ä¸èƒ½æä¾›&amp;quot;put-back&amp;quot;åŠŸèƒ½ã€‚æ‰€ä»¥æˆ‘ä»¬è¦åŠ¨ä¸€åŠ¨æ‰‹è„šï¼Œé‡æ–°å®žçŽ°ä¸€ä¸‹è¿™ä¸ªç±»ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;streambuf&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">char_array_buffer&lt;/span> &lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#66d9ef">public&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>streambuf
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">public&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> char_array_buffer(&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span>begin, &lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span>end);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">explicit&lt;/span> &lt;span style="color:#a6e22e">char_array_buffer&lt;/span>(&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span>str);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">private&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> int_type underflow();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> int_type &lt;span style="color:#a6e22e">uflow&lt;/span>();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> int_type &lt;span style="color:#a6e22e">pbackfail&lt;/span>(int_type ch);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> std&lt;span style="color:#f92672">::&lt;/span>streamsize showmanyc();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// copy ctor and assignment not implemented;
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75715e">// copying not allowed
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> char_array_buffer(&lt;span style="color:#66d9ef">const&lt;/span> char_array_buffer &lt;span style="color:#f92672">&amp;amp;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> char_array_buffer &lt;span style="color:#f92672">&amp;amp;&lt;/span>&lt;span style="color:#66d9ef">operator&lt;/span>&lt;span style="color:#f92672">=&lt;/span> (&lt;span style="color:#66d9ef">const&lt;/span> char_array_buffer &lt;span style="color:#f92672">&amp;amp;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">private&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span> &lt;span style="color:#66d9ef">const&lt;/span> begin_;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span> &lt;span style="color:#66d9ef">const&lt;/span> end_;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span> current_;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>};
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>åœ¨è¿™ä¸ªç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬é‡å†™äº†å‡ ä¸ªç§æœ‰å‡½æ•°ï¼Œè¿™äº›å‡½æ•°éƒ½æ˜¯ä»Ž&lt;code>std::streambuf&lt;/code>ç»§æ‰¿è€Œæ¥ã€‚&lt;/p>
&lt;p>ç¬¬ä¸€ä¸ªæž„é€ å‡½æ•°éœ€è¦ç”¨æˆ·æŒ‡å®šèµ·æ­¢æŒ‡é’ˆï¼Œè€Œç¬¬äºŒä¸ªæž„é€ å‡½æ•°åªéœ€è¦æŒ‡å®šèµ·å§‹æŒ‡é’ˆï¼Œä¹‹åŽæˆ‘ä»¬ä¼šè°ƒç”¨&lt;code>std::strlen()&lt;/code>æ¥åˆ¤æ–­å­—ç¬¦ä¸²çš„å¤§å°ã€‚&lt;/p>
&lt;p>æˆ‘ä»¬ä½¿ç”¨&lt;code>uflow()&lt;/code>, &lt;code>pbackfail()&lt;/code>å’Œ&lt;code>showmanyc()&lt;/code>æ¥ç»´æŠ¤ç¼“å†²åŒºå†…éƒ¨çš„çŠ¶æ€ï¼Œè€Œä¸æ˜¯è°ƒç”¨&lt;code>setg()&lt;/code>ï¼Œå› ä¸ºbufferå¹¶ä¸å¯å†™ã€‚&lt;/p>
&lt;p>åœ¨è¿™ä¸ªç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬è¦æ‰‹åŠ¨ç»´æŠ¤&lt;code>eback&lt;/code>, &lt;code>gptr&lt;/code>, &lt;code>egptr&lt;/code>ä¸‰ä¸ªæŒ‡é’ˆã€‚åœ¨æž„é€ å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬å°†å¯¹å…¶è¿›è¡Œèµ‹å€¼ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;#34;char_array_buffer.hpp&amp;#34;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;functional&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;cassert&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;cstring&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>char_array_buffer&lt;span style="color:#f92672">::&lt;/span>char_array_buffer(&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span>begin, &lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span>end) &lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> begin_(begin),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> end_(end),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> current_(begin_)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> assert(std&lt;span style="color:#f92672">::&lt;/span>less_equal&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&amp;gt;&lt;/span>()(begin_, end_));
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>char_array_buffer&lt;span style="color:#f92672">::&lt;/span>char_array_buffer(&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span>str) &lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> begin_(str),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> end_(begin_ &lt;span style="color:#f92672">+&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>strlen(str)),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> current_(begin_)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¹‹å‰æˆ‘ä»¬ä½¿ç”¨&lt;code>underflow()&lt;/code>æ¥èŽ·å–å½“å‰å­—ç¬¦ï¼Œä½†è¿™æ¬¡æˆ‘ä»¬éœ€è¦ä½¿ç”¨&lt;code>uflow()&lt;/code>ã€‚å› ä¸º&lt;code>uflow()&lt;/code>éœ€è¦åŒæ—¶æ‰§è¡Œä¸¤æ­¥æ“ä½œï¼Œä¸€æ˜¯èŽ·å–å½“å‰å­—ç¬¦ï¼ŒäºŒæ˜¯è®©&lt;code>gptr()&lt;/code>å‰è¿›ä¸€æ­¥ã€‚ä½†æ˜¯åˆå› ä¸ºç¼“å†²åŒºç”±æˆ‘ä»¬æ‰‹åŠ¨ç®¡ç†ï¼Œ&lt;code>std::streambuf&lt;/code>å¹¶ä¸èƒ½æ­£ç¡®çš„æ‰§è¡Œç®¡ç†æ“ä½œã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦é‡å†™&lt;code>uflow()&lt;/code>è€Œä¸æ˜¯&lt;code>underflow()&lt;/code>ã€‚&lt;/p>
&lt;pre tabindex="0">&lt;code>char_array_buffer::int_type char_array_buffer::uflow()
{
if (current_ == end_)
return traits_type::eof();
return traits_type::to_int_type(*current_++);
}
&lt;/code>&lt;/pre>&lt;p>ä¸‹ä¸€æ­¥æˆ‘ä»¬è¿˜è¦å®žçŽ°&lt;code>pbackfail()&lt;/code>ã€‚å½“æˆ‘ä»¬è°ƒç”¨&lt;code>std::istream::unget()&lt;/code>æˆ–&lt;code>std::istream::putback(ch)&lt;/code>æ—¶ï¼Œæˆ‘ä»¬ä¼šæŠŠå·²ç»è¯»å‡ºçš„æ•°æ®å†™å›žæ•°ç»„ä¸­ã€‚ä½†æ˜¯ç”±äºŽæ•°ç»„æ˜¯åªè¯»çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬åªèƒ½æ¨¡æ‹Ÿè¿™ç§æ“ä½œã€‚&lt;/p>
&lt;p>åœ¨é»˜è®¤çš„å®žçŽ°ä¸­&lt;code>pbackfail()&lt;/code>åªä¼šè¿”å›ž&lt;code>traits_type::eof()&lt;/code>ï¼Œè€Œåœ¨æˆ‘ä»¬çš„ç‰ˆæœ¬ä¸­ï¼Œå¦‚æžœå†™å›žæˆåŠŸï¼Œå°†ä¼šè¿”å›žå†™å›žçš„å­—ç¬¦ï¼Œä¸æˆåŠŸè¿”å›žeofã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>char_array_buffer&lt;span style="color:#f92672">::&lt;/span>int_type char_array_buffer&lt;span style="color:#f92672">::&lt;/span>pbackfail(int_type ch)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (current_ &lt;span style="color:#f92672">==&lt;/span> begin_ &lt;span style="color:#f92672">||&lt;/span> (ch &lt;span style="color:#f92672">!=&lt;/span> traits_type&lt;span style="color:#f92672">::&lt;/span>eof() &lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span> ch &lt;span style="color:#f92672">!=&lt;/span> current_[&lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>]))
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> traits_type&lt;span style="color:#f92672">::&lt;/span>eof();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> traits_type&lt;span style="color:#f92672">::&lt;/span>to_int_type(&lt;span style="color:#f92672">*--&lt;/span>current_);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>åœ¨&lt;code>FILE_buffer&lt;/code>ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥è€ƒè™‘é‡å†™&lt;code>pbackfail()&lt;/code>ï¼Œæ¥æä¾›åå‘æŸ¥æ‰¾ä»¥åŠï¼ˆç”¨å‰é¢çš„æ•°æ®ï¼‰é‡å¡«bufferçš„åŠŸèƒ½ã€‚&lt;/p>
&lt;p>æœ€åŽä¸€ä¸ªé‡å†™çš„å‡½æ•°æ˜¯&lt;code>showmanyc()&lt;/code>ï¼Œè¿™ä¸ªå‡½æ•°è¢«&lt;code>std::streambuf::in_avail()&lt;/code>è°ƒç”¨ï¼Œä»¥åˆ¤æ–­å½“å‰æœ‰å¤šå°‘ä¸ªå­—ç¬¦å¯ä»¥è¿”å›žã€‚ç”±äºŽæˆ‘ä»¬æŽ¥ç®¡äº†çŠ¶æ€æŒ‡é’ˆï¼Œæ‰€ä»¥è¿™ä¸ªå‡½æ•°ä¹Ÿè¦æˆ‘ä»¬è‡ªå·±æ¥å®žçŽ°å•Šã€‚ï¼ˆè¯‘è€…ï¼šä¸ºä»€ä¹ˆè¦ç»™è‡ªå·±æ‰¾éº»çƒ¦ã€‚ã€‚ã€‚ï¼‰&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>std&lt;span style="color:#f92672">::&lt;/span>streamsize char_array_buffer&lt;span style="color:#f92672">::&lt;/span>showmanyc()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> assert(std&lt;span style="color:#f92672">::&lt;/span>less_equal&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&amp;gt;&lt;/span>()(current_, end_));
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> end_ &lt;span style="color:#f92672">-&lt;/span> current_;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç”±æ­¤å¯è§ï¼Œæœ¬ä¾‹ä¸­çš„bufferæ¯”å‰é¢çš„è¦å¤æ‚ä¸€ç‚¹ç‚¹ã€‚è¿™æ˜¯å› ä¸ºæˆ‘ä»¬æŽ¥ç®¡äº†çŠ¶æ€ç»´æŠ¤çš„å·¥ä½œã€‚è¿™ä½¿å¾—æˆ‘ä»¬æ›´å¥½çš„ç†è§£äº†&lt;code>std::streambuf&lt;/code>å†…éƒ¨æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚&lt;/p>
&lt;h3 id="ä¾‹3å¥é¦–å˜å¤§å†™çš„ç¼“å†²åŒº">ä¾‹3ï¼šå¥é¦–å˜å¤§å†™çš„ç¼“å†²åŒº &lt;a href="#%e4%be%8b3%e5%8f%a5%e9%a6%96%e5%8f%98%e5%a4%a7%e5%86%99%e7%9a%84%e7%bc%93%e5%86%b2%e5%8c%ba" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;p>æœ¬ä¾‹ä¸­æˆ‘ä»¬å°†è¦å®žçŽ°ä¸€ä¸ªå°†å¥é¦–å­—ç¬¦å˜å¤§å†™çš„bufferã€‚å½“ç„¶æˆ‘ä»¬åªè€ƒè™‘æœ€åŸºæœ¬çš„æƒ…å†µï¼Œç§»æ¤åˆ°ä¸åŒçš„åŒºåŸŸå’Œè¯­è¨€ï¼Œå…¶å®žæ˜¯å¾ˆçç¢Žçš„äº‹æƒ…ã€‚ï¼ˆè¯‘è€…ï¼šæ–‡å­—ç¼–ç å‘çš„äº²å¦ˆéƒ½ä¸è®¤äº†ï¼‰&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;streambuf&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;iosfwd&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;cstdlib&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;vector&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">caps_buffer&lt;/span> &lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#66d9ef">public&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>streambuf
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">public&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">explicit&lt;/span> caps_buffer(std&lt;span style="color:#f92672">::&lt;/span>ostream &lt;span style="color:#f92672">&amp;amp;&lt;/span>sink, std&lt;span style="color:#f92672">::&lt;/span>size_t buff_sz &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">256&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">protected&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">bool&lt;/span> do_caps_and_flush();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">private&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> int_type overflow(int_type ch);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">int&lt;/span> &lt;span style="color:#a6e22e">sync&lt;/span>();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// copy ctor and assignment not implemented;
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75715e">// copying not allowed
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> caps_buffer(&lt;span style="color:#66d9ef">const&lt;/span> caps_buffer &lt;span style="color:#f92672">&amp;amp;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> caps_buffer &lt;span style="color:#f92672">&amp;amp;&lt;/span>&lt;span style="color:#66d9ef">operator&lt;/span>&lt;span style="color:#f92672">=&lt;/span> (&lt;span style="color:#66d9ef">const&lt;/span> caps_buffer &lt;span style="color:#f92672">&amp;amp;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">private&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">bool&lt;/span> cap_next_;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> std&lt;span style="color:#f92672">::&lt;/span>ostream &lt;span style="color:#f92672">&amp;amp;&lt;/span>sink_;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> std&lt;span style="color:#f92672">::&lt;/span>vector&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">char&lt;/span>&lt;span style="color:#f92672">&amp;gt;&lt;/span> buffer_;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>};
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™é‡Œæˆ‘ä»¬éœ€è¦é‡å†™&lt;code>overflow()&lt;/code>å’Œ&lt;code>sync()&lt;/code>å‡½æ•°ã€‚&lt;code>overflow()&lt;/code>åœ¨è¾“å…¥ç¼“å†²åŒºæ»¡çš„æ—¶å€™è¢«è°ƒç”¨ï¼Œå¹¶ä¸”åœ¨æˆåŠŸæ—¶è¿”å›žä»»æ„éžeofçš„å€¼ã€‚&lt;/p>
&lt;p>&lt;code>sync()&lt;/code>çš„ä½œç”¨æ˜¯æŠŠå½“å‰çš„bufferå†™å…¥ç›®æ ‡ï¼Œå³ä½¿å½“å‰bufferå¹¶æœªå¡«æ»¡ã€‚&lt;code>std::flush()&lt;/code>ä¼šè°ƒç”¨&lt;code>sync()&lt;/code>å‡½æ•°ï¼Œå½“å¤±è´¥æ—¶è¿”å›ž-1ã€‚&lt;/p>
&lt;p>æˆ‘ä»¬ç¼–å†™ä¸€ä¸ªè¾…åŠ©å‡½æ•°&lt;code>do_caps_and_flush()&lt;/code>ï¼Œç”¨æ¥å°†å°å†™å˜å¤§å†™ï¼Œå¹¶å†™å…¥&lt;code>sink_&lt;/code>è¾“å‡ºæµã€‚æˆ‘ä»¬å†å£°æ˜Žä¸€ä¸ªå“¨å…µå˜é‡&lt;code>cap_next_&lt;/code>æ¥æ ‡è¯†ä¸‹ä¸€ä¸ªå­—ç¬¦æ˜¯å¦éœ€è¦å°å†™å˜å¤§å†™ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;#34;caps_buffer.hpp&amp;#34;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;cctype&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;ostream&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;functional&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;cassert&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>caps_buffer&lt;span style="color:#f92672">::&lt;/span>caps_buffer(std&lt;span style="color:#f92672">::&lt;/span>ostream &lt;span style="color:#f92672">&amp;amp;&lt;/span>sink, std&lt;span style="color:#f92672">::&lt;/span>size_t buff_sz) &lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> cap_next_(true),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> sink_(sink),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> buffer_(buff_sz &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> sink_.clear();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span>base &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#f92672">&amp;amp;&lt;/span>buffer_.front();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> setp(base, base &lt;span style="color:#f92672">+&lt;/span> buffer_.size() &lt;span style="color:#f92672">-&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>); &lt;span style="color:#75715e">// -1 to make overflow() easier
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>buffer_&lt;/code>çš„æœ€å°å¯èƒ½å¤§å°æ˜¯1ï¼ŒåŒæ—¶æˆ‘ä»¬ä¹Ÿåªéœ€è¦ç»´æŠ¤ä¸¤ä¸ªæŒ‡é’ˆï¼Œå› ä¸ºè¿™é‡Œä¸éœ€è¦åƒè¾“å…¥ç¼“å†²åŒºä¸€æ ·çš„ç»´æŠ¤&amp;quot;put-back area&amp;quot;ã€‚&lt;/p>
&lt;p>æˆ‘ä»¬æŠŠ&lt;code>buffer_&lt;/code>çš„å¤§å°è®¾æˆ&lt;code>buff_sz + 1&lt;/code>ï¼Œè¿™æ ·æ˜¯ä¸ºäº†&lt;code>overflow()&lt;/code>è¢«è°ƒç”¨æ—¶ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªé¢å¤–çš„ç©ºé—´å­˜å‚¨å½“å‰çš„å­—ç¬¦ã€‚æœ€åŽå°†ç¼“å†²åŒºæ•°ç»„å’Œæœ€åŽä¸€ä¸ªå­—ç¬¦ä¸€èµ·åˆ·æ–°åˆ°&lt;code>ostream&lt;/code>ä¸­ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>caps_buffer&lt;span style="color:#f92672">::&lt;/span>int_type caps_buffer&lt;span style="color:#f92672">::&lt;/span>overflow(int_type ch)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (sink_ &lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span> ch &lt;span style="color:#f92672">!=&lt;/span> traits_type&lt;span style="color:#f92672">::&lt;/span>eof())
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> assert(std&lt;span style="color:#f92672">::&lt;/span>less_equal&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&amp;gt;&lt;/span>()(pptr(), epptr()));
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">*&lt;/span>pptr() &lt;span style="color:#f92672">=&lt;/span> ch;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> pbump(&lt;span style="color:#ae81ff">1&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (do_caps_and_flush())
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> ch;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> traits_type&lt;span style="color:#f92672">::&lt;/span>eof();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç¬¬ä¸€æ­¥æ˜¯æŠŠchå†™å…¥&lt;code>buffer_&lt;/code>ï¼Œå¹¶ä¸”ä½¿ç”¨&lt;code>pbump(1)&lt;/code>å°†&lt;code>pptr()&lt;/code>å‘å‰ç§»ä¸€ä½ã€‚ä¹‹åŽè°ƒç”¨&lt;code>do_caps_and_flush()&lt;/code>åšä¸€äº›è„æ´»ï¼Œä¹‹åŽè¿”å›žä¸€ä¸ªå­—ç¬¦å£°æ˜Žè°ƒç”¨æˆåŠŸã€‚&lt;/p>
&lt;p>&lt;code>sync()&lt;/code>çš„å®žçŽ°ä¹Ÿéžå¸¸ç®€å•:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">int&lt;/span> caps_buffer&lt;span style="color:#f92672">::&lt;/span>sync()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#a6e22e">do_caps_and_flush&lt;/span>() &lt;span style="color:#f92672">?&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span> &lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æˆ‘ä»¬å†çœ‹ä¸€çœ‹&lt;code>do_caps_and_flush()&lt;/code>å‡½æ•°&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">bool&lt;/span> caps_buffer&lt;span style="color:#f92672">::&lt;/span>do_caps_and_flush()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">for&lt;/span> (&lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span>p &lt;span style="color:#f92672">=&lt;/span> pbase(), &lt;span style="color:#f92672">*&lt;/span>e &lt;span style="color:#f92672">=&lt;/span> pptr(); p &lt;span style="color:#f92672">!=&lt;/span> e; &lt;span style="color:#f92672">++&lt;/span>p)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (&lt;span style="color:#f92672">*&lt;/span>p &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#e6db74">&amp;#39;.&amp;#39;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> cap_next_ &lt;span style="color:#f92672">=&lt;/span> true;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">else&lt;/span> &lt;span style="color:#a6e22e">if&lt;/span> (std&lt;span style="color:#f92672">::&lt;/span>isalpha(&lt;span style="color:#f92672">*&lt;/span>p))
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (cap_next_)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">*&lt;/span>p &lt;span style="color:#f92672">=&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>toupper(&lt;span style="color:#f92672">*&lt;/span>p);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> cap_next_ &lt;span style="color:#f92672">=&lt;/span> false;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> std&lt;span style="color:#f92672">::&lt;/span>ptrdiff_t n &lt;span style="color:#f92672">=&lt;/span> pptr() &lt;span style="color:#f92672">-&lt;/span> pbase();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> pbump(&lt;span style="color:#f92672">-&lt;/span>n);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> sink_.write(pbase(), n);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯¹äºŽæœ¬ä¾‹æ¥è¯´ï¼Œå†…éƒ¨çš„ç¼“å†²åŒºå¹¶éžå¿…è¦ï¼Œæˆ‘ä»¬å¯ä»¥ä¸€ä¸ªå­—ç¬¦ä¸€ä¸ªå­—ç¬¦æŠŠæ•°æ®å‘åˆ°&lt;code>sink&lt;/code>ä¸­ã€‚ä½†æ˜¯æˆ‘çš„è§‚ç‚¹æ˜¯ä¸€ä¸ªå†…éƒ¨bufferä»æœ‰å…¶ç”¨å¤„ã€‚&lt;/p>
&lt;h3 id="ä»‹ç»-boost-iostreams-åº“">ä»‹ç» Boost IOStreams åº“ &lt;a href="#%e4%bb%8b%e7%bb%8d-boost-iostreams-%e5%ba%93" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;p>å¦‚æžœä½ æ˜¯æµç¼“å†²åŒºçš„æ–°æ‰‹ï¼Œå¸Œæœ›ä½ å·²ç»å¯¹å®ƒæœ‰ä¸€ç‚¹ç‚¹äº†è§£äº†ã€‚æœ¬æ–‡ä¸­çš„ä¾‹å­éƒ½éžå¸¸åŸºç¡€ï¼Œä½†æ˜¯ä½ å¯ä»¥ç”¨å®ƒä»¬åšæ›´å¤šæœ‰æ„æ€çš„äº‹æƒ…ã€‚ä½†æ˜¯å½“æˆ‘å®žçŽ°æ›´å¤æ‚çš„æµç¼“å†²åŒºæ—¶ï¼Œé—®é¢˜çš„å¤æ‚åº¦å´ä¸Šå‡çš„å¾ˆå¿«ã€‚è¿™æ—¶æˆ‘å‘çŽ°äº†&lt;code>Boost IOStreams&lt;/code>åº“ï¼Œå®ƒä¸ºæ›´å¤æ‚çš„ç¼“å†²åŒºå’Œæµæä¾›äº†å¿…è¦çš„æ¡†æž¶æ”¯æŒã€‚&lt;/p>
&lt;p>å®ƒå…è®¸ä½ è§£è€¦æ•°æ®æºï¼Œæ•°æ®è¾“å‡ºï¼Œè¿‡æ»¤å™¨ä»¥åŠå…¶å®ƒä¸€äº›æ¦‚å¿µã€‚åœ¨æˆ‘ä»¬çš„æœ€åŽä¸€ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ç¡¬ç¼–ç æ•°æ®è¾“å‡ºåˆ°&lt;code>std::ostream&lt;/code>ä¸­ã€‚å¦‚æžœæˆ‘ä»¬è¦è¾“å‡ºåˆ°ä¸€ä¸ªæ²¡æœ‰æµæŽ¥å£çš„ç±»å‘¢ï¼Ÿ&lt;code>Boost IOStreams&lt;/code>åº“æä¾›äº†æ›´å¤šçš„çµæ´»æ€§ï¼Œå°†ä¸€å¨ç´§è€¦åˆçš„ä»£ç åˆ†è§£æˆç‹¬ç«‹çš„æŠ½è±¡æ¦‚å¿µã€‚&lt;/p>
&lt;h3 id="æ‰©å±•é˜…è¯»">æ‰©å±•é˜…è¯» &lt;a href="#%e6%89%a9%e5%b1%95%e9%98%85%e8%af%bb" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;ul>
&lt;li>The C++ Standard Library by Nicolai M. Josuttis&lt;/li>
&lt;li>The C++ Standard, BS ISO/IEC 14882:2003 (Second Edition)&lt;/li>
&lt;li>&lt;a href="http://www.dinkumware.com/manuals/">Dinkum Compleat Reference online&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>Using Set Cover to Optimize a Large-Scale Low Latency Distributed Graph</title><link>https://wizmann.top/posts/using-set-cover-algorithm-to-optimize-a-large-scale-low-latency-distributed-graph/</link><pubDate>Sun, 26 Jul 2015 22:48:33 +0000</pubDate><guid>https://wizmann.top/posts/using-set-cover-algorithm-to-optimize-a-large-scale-low-latency-distributed-graph/</guid><description>&lt;h2 id="background">Background &lt;a href="#background" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;p>Linkedin (or other social networks, such as Facebook and G+) use the &amp;ldquo;social graph information&amp;rdquo; to show the social relationship between you and other members.&lt;/p>
&lt;p>Such as, &amp;ldquo;You and Mr.Obama share 10 mutual friends&amp;rdquo; or &amp;ldquo;You have 1,000 second-degree connections&amp;rdquo;.&lt;/p>
&lt;p>This feature is very common for a social network. But where does it come from?&lt;/p>
&lt;h2 id="basic-api-for-social-graph-information">Basic API for Social Graph Information &lt;a href="#basic-api-for-social-graph-information" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;p>The information about a social relationship can be get from three basic APIs.&lt;/p>
&lt;ul>
&lt;li>Get Connections
&amp;ldquo;Who does member X know?&amp;rdquo;&lt;/li>
&lt;li>Get Shared Connections
&amp;ldquo;Who do I know in common with member Y?&amp;rdquo;&lt;/li>
&lt;li>Get Graph Distance
&amp;ldquo;What the graph distance between member Z and me?&amp;rdquo;&lt;/li>
&lt;/ul>
&lt;h2 id="main-components-for-the-system">Main Components for the System &lt;a href="#main-components-for-the-system" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;p>&lt;img src="https://github.com/Wizmann/assets/raw/master/wizmann-pic/15-7-25/59618247.jpg" alt="">&lt;/p>
&lt;ul>
&lt;li>Graph Database (Graph DB)&lt;/li>
&lt;li>Distributed Network Cache (NCS)&lt;/li>
&lt;li>Graph APIs&lt;/li>
&lt;/ul>
&lt;h2 id="basic-algorithm-for-social-graph">Basic Algorithm for Social Graph &lt;a href="#basic-algorithm-for-social-graph" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;p>Because the problems of social graph share the same essence. Here we just talk about the &amp;ldquo;Graph Distance&amp;rdquo; problem.&lt;/p>
&lt;p>&lt;img src="https://github.com/Wizmann/assets/raw/master/wizmann-pic/15-7-25/24130302.jpg" alt="">&lt;/p>
&lt;p>The &lt;em>Graph DB&lt;/em> stores all the relationship of the members. When we ask for the information of &lt;em>second degree creation&lt;/em>,&lt;/p>
&lt;ul>
&lt;li>Firstly, the web server communicate with GraphDB to get all the 1st degree connections&lt;/li>
&lt;li>Secondly, web server communicate to GraphDB again to get all the 2nd degree connections&lt;/li>
&lt;li>At last, the web server will merge all the results from the GraphDB to make it sorted and unique.&lt;/li>
&lt;/ul>
&lt;p>To make the retrieval more effectively, we add a cache level called &lt;em>NCS&lt;/em> to cache the result we get from the GraphDB.&lt;/p>
&lt;h2 id="the-disadvantages-of-the-basic-algorithm">The Disadvantages of the Basic Algorithm &lt;a href="#the-disadvantages-of-the-basic-algorithm" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;p>As we know, for a distributed system, there are shards, replica and load balancer to handle large amount of data and queries.&lt;/p>
&lt;p>Consider this scenario.&lt;/p>
&lt;p>&lt;img src="https://github.com/Wizmann/assets/raw/master/wizmann-pic/15-7-25/4544395.jpg" alt="">&lt;/p>
&lt;p>Two queries are both ask for the data from shard 1 and shard 2.&lt;/p>
&lt;p>The first query (the green one) has to communicate with the database twice, and then do the merging to get the final results.&lt;/p>
&lt;p>And the second query (the red one) only has to talk to database once. And no de-duplicate is needed, because there&amp;rsquo;s definitely no duplicate data in one single node of the database.&lt;/p>
&lt;p>We can make a conclusion that if we have a &lt;strong>wise&lt;/strong> load balancer, we can optimize our retrieval logic remarkably.&lt;/p>
&lt;h2 id="set-cover-problem">Set Cover Problem &lt;a href="#set-cover-problem" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;blockquote>
&lt;p>Given a set of elements {1,2,&amp;hellip;,m} (called the universe) and a set S of n sets whose union equals the universe, the set cover problem is to identify the smallest subset of S whose union equals the universe. (Wikipedia)&lt;/p>&lt;/blockquote>
&lt;p>This problem is similar to ours. The optimal algorithm for a load balancer is to find the minimal subsets of all sets which union equals to the ones that asked by the query input.&lt;/p>
&lt;p>It seems that we find the key to our problem. But this is NP-complete. There is no effective way to find the optimal solution.&lt;/p>
&lt;p>However, in practice, a greedy algorithm will actually do the trick. The rule of the greedy algorithm is to find the set which contains largest number uncovered elements.&lt;/p>
&lt;p>&lt;img src="https://github.com/Wizmann/assets/raw/master/wizmann-pic/15-7-26/80102455.jpg" alt="">&lt;/p>
&lt;h2 id="conclusion">Conclusion &lt;a href="#conclusion" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;p>We finally find out that the social information and the relationship graph is &lt;strong>not that difficult&lt;/strong>. The basic concepts are quite easy. And the main work for the whole system is to use the cache to reduce the amount of calculation on the fly.&lt;/p>
&lt;p>&lt;img src="https://github.com/Wizmann/assets/raw/master/wizmann-pic/15-7-26/65691084.jpg" alt="">&lt;/p>
&lt;h2 id="reference">Reference &lt;a href="#reference" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;p>This post is mainly based on this &lt;a href="https://www.usenix.org/conference/hotcloud13/workshop-program/presentations/wang">video&lt;/a>.&lt;/p>
&lt;p>&lt;a href="https://www.usenix.org/sites/default/files/conference/protected-files/wang_hotcloud13_slides.pdf">Slides&lt;/a>&lt;/p>
&lt;p>Special thanks to Linkedin for the sharing. :)&lt;/p></description></item><item><title>ZeroMQå¯ç¤ºå½•</title><link>https://wizmann.top/posts/inspiration-from-zeromq/</link><pubDate>Tue, 07 Apr 2015 10:01:34 +0000</pubDate><guid>https://wizmann.top/posts/inspiration-from-zeromq/</guid><description>&lt;h2 id="Ã¸mqæ˜¯ä¸€ä¸ªæ¶ˆæ¯ç³»ç»Ÿ">Ã˜MQæ˜¯ä¸€ä¸ªæ¶ˆæ¯ç³»ç»Ÿ &lt;a href="#%c3%b8mq%e6%98%af%e4%b8%80%e4%b8%aa%e6%b6%88%e6%81%af%e7%b3%bb%e7%bb%9f" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;p>ZeroMQæ˜¯ä¸€ä¸ªæ¶ˆæ¯ç³»ç»Ÿï¼Œä¹Ÿè¢«ç§°ä¸ºâ€œæ¶ˆæ¯ä¸­é—´ä»¶â€ã€‚å®ƒè¢«å¹¿æ³›çš„ç”¨äºŽç»æµŽã€æ¸¸æˆã€åµŒå…¥å¼ç­‰é¢†åŸŸã€‚&lt;/p>
&lt;h3 id="ä»€ä¹ˆæ˜¯æ¶ˆæ¯ç³»ç»Ÿ">ä»€ä¹ˆæ˜¯æ¶ˆæ¯ç³»ç»Ÿ &lt;a href="#%e4%bb%80%e4%b9%88%e6%98%af%e6%b6%88%e6%81%af%e7%b3%bb%e7%bb%9f" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;p>æ‰“ä¸ªæ¯”æ–¹ï¼Œæ¶ˆæ¯ç³»ç»Ÿå°±åƒæˆ‘ä»¬ä½¿ç”¨çš„IMè½¯ä»¶ä¸€æ ·ã€‚é¦–å…ˆï¼Œä¸€æ–¹å†³å®šå°†æ¶ˆæ¯å‘å¾€ä½•å¤„ï¼ˆä¸€å¯¹ä¸€æˆ–ä¸€å¯¹å¤šï¼‰ã€‚ç„¶åŽå°†ä¿¡æ¯æ‰“åŒ…ï¼Œç‚¹å‡»å‘é€æŒ‰é’®ã€‚ä¹‹åŽï¼ŒIMç³»ç»Ÿä¼šå¸®ä½ æ–™ç†å‰©ä½™çš„äº‹åŠ¡ã€‚&lt;/p>
&lt;p>ä½†æ˜¯ï¼Œå®ƒä»¬ä¹Ÿæœ‰å¾ˆå¤§çš„ä¸åŒç‚¹ã€‚IMç³»ç»Ÿå¯¹äºŽæ¶ˆæ¯ç³»ç»Ÿä¼¼ä¹Žå¤ªä½Žæ•ˆäº†ä¸€ç‚¹ã€‚å¦å¤–ï¼Œæ¶ˆæ¯ç³»ç»Ÿæ˜¯æ²¡æœ‰ç”¨æˆ·ç•Œé¢ï¼ˆGUIï¼‰çš„ã€‚åœ¨é”™è¯¯å‘ç”Ÿæ—¶ï¼Œæ¶ˆæ¯çš„å¦ä¸€ç«¯ä¹Ÿä¸ä¼šæœ‰äººæ¥æ™ºèƒ½çš„ä»‹å…¥å¤„ç†ã€‚&lt;/p>
&lt;p>æ‰€ä»¥ï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·ä¸‹å®šä¹‰ã€‚æ¶ˆæ¯ç³»ç»Ÿæ˜¯å…·æœ‰é«˜æ•ˆæ€§å’Œå®¹é”™æ€§çš„æ¶ˆæ¯ä¼ é€’è§£å†³æ–¹æ¡ˆã€‚&lt;/p>
&lt;h3 id="zeromqçš„èµ·æºå’Œå‘å±•">ZeroMQçš„èµ·æºå’Œå‘å±• &lt;a href="#zeromq%e7%9a%84%e8%b5%b7%e6%ba%90%e5%92%8c%e5%8f%91%e5%b1%95" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;p>ZeroMQæœ€å…ˆçš„è®¾æƒ³æ˜¯å®žçŽ°ä¸€ä¸ªç‚’é¸¡å¿«çš„ç”¨äºŽè¯åˆ¸äº¤æ˜“çš„æ¶ˆæ¯ç³»ç»Ÿï¼Œæ‰€ä»¥åœ¨è®¾è®¡åˆæœŸçš„å…³æ³¨ç‚¹å°±æ˜¯åœ¨æžè‡´çš„ä¼˜åŒ–ä¸Šã€‚&lt;/p>
&lt;p>ç¬¬ä¸€å¹´çš„å·¥ä½œé‡ç‚¹ï¼Œåœ¨äºŽå‘æ˜Žæ€§èƒ½æµ‹è¯•çš„æ–¹æ³•ï¼Œå’Œè®¾è®¡é«˜æ•ˆæž¶æž„ã€‚&lt;/p>
&lt;p>ä¹‹åŽï¼Œå¤§çº¦åœ¨ç¬¬äºŒå¹´ï¼Œå·¥ä½œé‡ç‚¹è½¬ç§»åˆ°å®žçŽ°ä¸€ä¸ªé€šç”¨çš„æ¶ˆæ¯ç³»ç»Ÿï¼Œä»¥åº”ç”¨äºŽåˆ†å¸ƒå¼ç³»ç»Ÿï¼Œä½¿å…¶å¯ä»¥åˆ©ç”¨&lt;strong>ä¸åŒçš„ç¼–ç¨‹è¯­è¨€&lt;/strong>ï¼Œä½¿ç”¨&lt;strong>ä¸åŒæ–¹å¼&lt;/strong>ï¼Œæ¥ä¼ é€’&lt;strong>å„ç§æ¨¡å¼&lt;/strong>çš„ä¿¡æ¯ã€‚&lt;/p>
&lt;h2 id="å¯ç¤º1ç‹¬ç«‹åº”ç”¨-vs-ç¨‹åºåº“">å¯ç¤º1ï¼šç‹¬ç«‹åº”ç”¨ vs. ç¨‹åºåº“ &lt;a href="#%e5%90%af%e7%a4%ba1%e7%8b%ac%e7%ab%8b%e5%ba%94%e7%94%a8-vs-%e7%a8%8b%e5%ba%8f%e5%ba%93" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;p>ZeroMQæ˜¯ä¸€ä¸ªç¨‹åºåº“ï¼Œä¸æ˜¯ä¸€ä¸ªæ¶ˆæ¯æœåŠ¡å™¨ã€‚è¿™æ ·è®¾è®¡çš„ä¸»è¦åŽŸå› æ˜¯ï¼šæ€§èƒ½ã€‚&lt;/p>
&lt;p>ä½¿ç”¨ä¸€ä¸ªä¸­é—´æ¶ˆæ¯æœåŠ¡å™¨ï¼ˆBrokerï¼‰ï¼Œæ¯ä¸€æ¡æ¶ˆæ¯éƒ½ä¼šè¢«åœ¨ç½‘ç»œä¸Šä¼ é€’ä¸¤æ¬¡ï¼ˆSender-&amp;gt;Broker-&amp;gt;Receiver)ã€‚è¿™æ ·çš„è®¾è®¡ä¼šå½±å“æ—¶å»¶å’Œåžåé‡ã€‚æ›´ä¸¥é‡çš„æ˜¯ï¼Œå¦‚æžœæ‰€æœ‰æ¶ˆæ¯éƒ½é€šè¿‡ä¸­é—´æœåŠ¡å™¨ï¼Œé‚£ä¹ˆè¿™ä¸ªç‚¹å°±ä¼šæˆä¸ºæ•´ä¸ªç³»ç»Ÿçš„ç“¶é¢ˆã€‚&lt;/p>
&lt;p>ä½¿ç”¨ä¸­é—´æ¶ˆæ¯æœåŠ¡å™¨çš„å¦ä¸€ä¸ªå¼Šç«¯ï¼Œæ˜¯ä¸åˆ©äºŽå¤§è§„æ¨¡éƒ¨ç½²ã€‚å¯¹äºŽè¯åˆ¸äº¤æ˜“æ¥è¯´ï¼ˆZeroMQæœ€åˆçš„åº”ç”¨åœºæ™¯ï¼‰ï¼Œè·¨ç»„ç»‡çš„æ¶ˆæ¯ä¼ è¾“æ˜¯ä¸å¯é¿å…çš„ã€‚è¿™æ ·ä¸€æ¥ï¼Œä¸­å¤®é›†æƒå¼çš„æ¶ˆæ¯ä¼ è¾“å°±ä¸åœ¨æœ‰æ•ˆäº†ã€‚&lt;/p>
&lt;p>æ‰€ä»¥ï¼Œæˆ‘ä»¬ç¼©å°æ¶ˆæ¯ç³»ç»Ÿçš„ç²’åº¦ï¼Œä½¿ä¹‹æˆä¸ºä¸€ä¸ªç¨‹åºåº“ã€‚ä½¿å…¶æ›´è½»é‡ï¼Œæ›´æ˜“äºŽéƒ¨ç½²ã€‚åŒæ ·ï¼Œæ›´è½»é‡çš„æ¶ˆæ¯ç³»ç»Ÿå¯ä»¥å®žçŽ°æ›´å¤æ‚çš„æ‹“æ‰‘ç»“æž„ã€‚&lt;/p>
&lt;p>èŽ·å¾—çš„å¯ç¤ºï¼šå¯¹äºŽä¸€ä¸ªæ–°é¡¹ç›®æ¥è¯´ï¼Œå¦‚æžœå¯èƒ½ï¼Œå°½é‡æŠŠå®ƒå®žçŽ°ä¸ºä¸€ä¸ªç¨‹åºåº“ã€‚å°†ä¸€ä¸ªæ–°åº“è”ç¼–åˆ°åŽŸæœ‰ç¨‹åºä¸­ï¼Œåªéœ€è¦å°‘é‡çš„äººåŠ›ï¼Œä¹Ÿæä¾›äº†è¶³å¤Ÿçš„çµæ´»æ€§ã€‚&lt;/p>
&lt;h2 id="å¯ç¤º2å…¨å±€çŠ¶æ€">å¯ç¤º2ï¼šå…¨å±€çŠ¶æ€ &lt;a href="#%e5%90%af%e7%a4%ba2%e5%85%a8%e5%b1%80%e7%8a%b6%e6%80%81" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;p>å¯¹äºŽç¨‹åºåº“æ¥è¯´ï¼Œå…¨å±€çŠ¶æ€å¾€å¾€ä¸èƒ½æ­£ç¡®çš„å·¥ä½œã€‚&lt;/p>
&lt;p>ç”±äºŽä¸€ä¸ªç¨‹åºåº“å¯èƒ½è¢«ä¸€ä¸ªåº”ç”¨ç¨‹åºåŠ è½½å¤šæ¬¡ï¼Œè¿™å°±ä¸èƒ½ä¿è¯åªæœ‰ç‹¬ä¸€æ— äºŒçš„å…¨å±€çŠ¶æ€ã€‚&lt;/p>
&lt;p>ZeroMQçš„è§£å†³æ–¹æ³•æ˜¯ç”±åº“çš„è°ƒç”¨è€…æ˜¾å¼çš„ç»´æŠ¤ä¸€ä¸ªâ€œçŽ¯å¢ƒâ€ï¼Œå¦‚å›¾æ‰€ç¤ºã€‚&lt;code>libA&lt;/code>å’Œ&lt;code>libB&lt;/code>éƒ½æœ‰å…¶ç‹¬æœ‰çš„â€œçŽ¯å¢ƒâ€ä¿¡æ¯ã€‚&lt;/p>
&lt;p>&lt;img src="https://github.com/Wizmann/assets/raw/master/wizmann-pic/71080471bf8bbf4d4e186c353d6b512c" alt="Alt text">&lt;/p>
&lt;p>èŽ·å¾—çš„å¯ç¤ºï¼šä¸è¦åœ¨ç¨‹åºåº“ä¸­ä½¿ç”¨å…¨å±€çŠ¶æ€ã€‚å¦‚æžœä½ è¿™ä¹ˆåšäº†ï¼Œå½“åº“æ°å¥½éœ€è¦åœ¨åŒä¸€ä¸ªè¿›ç¨‹ä¸­å®žä¾‹åŒ–ä¸¤æ¬¡æ—¶ï¼Œå®ƒå¾ˆå¯èƒ½ä¼šå´©æºƒã€‚&lt;/p>
&lt;h2 id="å¯ç¤º3æ€§èƒ½">å¯ç¤º3ï¼šæ€§èƒ½ &lt;a href="#%e5%90%af%e7%a4%ba3%e6%80%a7%e8%83%bd" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;p>&lt;img src="https://github.com/Wizmann/assets/raw/master/wizmann-pic/4ae6721a94012d877709075558562f2b" alt="Alt text">&lt;/p>
&lt;p>ZeroMQåœ¨æœ€åˆè®¾è®¡æ—¶ï¼Œæ€§èƒ½è°ƒä¼˜å°±æ˜¯é¦–è¦çš„ç›®æ ‡ã€‚åšä¸ºä¸€ä¸ªæ¶ˆæ¯ç³»ç»Ÿï¼Œå…¶æ€§èƒ½æŒ‡æ ‡ä¸»è¦æœ‰ä¸¤ä¸ªï¼šåžåé‡å’Œå»¶æ—¶ã€‚&lt;/p>
&lt;p>ä½†æ˜¯æˆ‘ä»¬æ€Žä¹ˆåº¦é‡å®ƒä»¬å‘¢ï¼Ÿ&lt;/p>
&lt;p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼ŒAå‘Bå‘é€ä¿¡æ¯ã€‚Båœ¨6ç§’å†…æŽ¥æ”¶åˆ°äº†5æ¡ä¿¡æ¯ï¼Œå› æ­¤åžåé‡ä¸º0.83æ¶ˆæ¯/ç§’ï¼Œå¹³å‡æ—¶å»¶ä¸º1.2ç§’ã€‚&lt;/p>
&lt;p>å¦‚æžœæˆ‘ä»¬æ¢ä¸€ç§è®¡é‡æ–¹å¼ï¼ŒAå‘Bå‘é€æ¶ˆæ¯ï¼Œå¯¹äºŽå•æ¡ä¿¡æ¯æ¥è¯´ï¼Œå…¶å¹³å‡æ—¶å»¶ä¸º3ç§’ã€‚AèŠ±è´¹2ç§’ï¼Œå‘é€äº†æ‰€æœ‰çš„æ¶ˆæ¯ï¼›BèŠ±è´¹äº†4ç§’ï¼ŒæŽ¥æ”¶åˆ°äº†æ‰€æœ‰çš„æ¶ˆæ¯ã€‚æ‰€ä»¥Açš„åžåé‡ä¸º2.5æ¶ˆæ¯/ç§’ï¼ŒBçš„åžåé‡ä¸º1.25æ¶ˆæ¯/ç§’ã€‚è¿™ä¸ªæ•°æ®ä¸Žæˆ‘ä»¬ä¸Šé¢å¾—å‡ºçš„æ•°æ®ç›¸å·®ç”šè¿œã€‚&lt;/p>
&lt;p>ç”±æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œä½¿ç”¨ä¸åŒçš„è®¡é‡æ ‡å‡†ï¼Œå¯¹äºŽæˆ‘ä»¬ä¼°è®¡ç³»ç»Ÿçš„æ€§èƒ½ï¼Œä¼šå¸¦æ¥å¾ˆå¤§çš„ä¸åŒã€‚&lt;/p>
&lt;p>æ—¶å»¶åªæœ‰åœ¨ä¸¤ä¸ªèŠ‚ç‚¹é€šä¿¡æ—¶ï¼Œæ‰å¯èƒ½å‘ç”Ÿã€‚æ‰€ä»¥ï¼Œå¹¶ä¸èƒ½æœ‰â€œæŸèŠ‚ç‚¹çš„æ—¶å»¶â€è¿™ç§åº¦é‡æ ‡å‡†çš„å‡ºçŽ°ã€‚åŒæ ·ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹å¤šæ¡æ¶ˆæ¯çš„æ—¶å»¶è¿›è¡Œå¹³å‡ï¼Œä½†æ˜¯å¹¶ä¸èƒ½æœ‰â€œä¸€ä¸ªæ¶ˆæ¯æµçš„å¹³å‡æ—¶å»¶â€ã€‚&lt;/p>
&lt;p>åžåé‡ï¼Œä¸Žæ—¶å»¶ä¸åŒï¼Œåªèƒ½åœ¨å•ä¸ªèŠ‚ç‚¹ä¸Šè¿›è¡Œåº¦é‡ã€‚æ‰€ä»¥ï¼Œå¹¶ä¸èƒ½æœ‰â€œèŠ‚ç‚¹é—´çš„åžåé‡â€è¿™ç§åº¦é‡æ–¹æ³•ã€‚&lt;/p>
&lt;p>èŽ·å¾—çš„å¯ç¤ºï¼šæ·±å…¥äº†è§£ä½ æ‰€è¦è§£å†³çš„é—®é¢˜ã€‚å¦åˆ™ï¼Œä½ ä¼šåœ¨è§£å†³é—®é¢˜æ—¶ä¼šå¼•å…¥ï¼ˆé”™è¯¯çš„ï¼‰å‡å®šå’ŒçŽ„å­¦ï¼Œå†™å‡ºæœ‰ç¼ºé™·çš„å¤æ‚ä»£ç ã€‚&lt;/p>
&lt;h2 id="å¯ç¤º4å…³é”®è·¯å¾„">å¯ç¤º4ï¼šå…³é”®è·¯å¾„ &lt;a href="#%e5%90%af%e7%a4%ba4%e5%85%b3%e9%94%ae%e8%b7%af%e5%be%84" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;p>ä»£ç ä¸­ç»å¸¸è¢«è°ƒç”¨çš„ä»£ç ï¼Œè¢«ç§°ä¸º&lt;strong>å…³é”®è·¯å¾„&lt;/strong>ã€‚&lt;/p>
&lt;p>å¯¹äºŽZeroMQæ¥è¯´ï¼Œå»ºç«‹é“¾æŽ¥ä¸Žå†…å­˜ç”³è¯·éƒ½ä¸æ˜¯å½±å“æ€§èƒ½çš„æœ€ä¸»è¦å› ç´ ã€‚å› ä¸ºZeroMQä½¿ç”¨é•¿é“¾æŽ¥è¿›è¡Œé€šä¿¡ï¼Œæ‰€ä»¥å»ºç«‹é“¾æŽ¥çš„å¼€é”€å‡æ‘Šåˆ°æ¯ä¸€æ¡ä¿¡æ¯å¾®ä¹Žå…¶å¾®ã€‚åŒæ ·ï¼ŒZeroMQä½¿ç”¨é«˜æ•ˆçš„å†…å­˜ç»´æŠ¤æœºåˆ¶ï¼Œå°½å¯èƒ½å°‘çš„å‘ç³»ç»Ÿç›´æŽ¥ç”³è¯·å†…å­˜ç©ºé—´ã€‚&lt;/p>
&lt;p>èŽ·å¾—çš„å¯ç¤ºï¼šåªåœ¨ç³»ç»Ÿçš„å…³é”®è·¯å¾„ä¸Šåšä¼˜åŒ–ã€‚å¦åˆ™åªæ˜¯æµªè´¹æ—¶é—´ã€‚&lt;/p>
&lt;h2 id="å¯ç¤º5å†…å­˜ç”³è¯·">å¯ç¤º5ï¼šå†…å­˜ç”³è¯· &lt;a href="#%e5%90%af%e7%a4%ba5%e5%86%85%e5%ad%98%e7%94%b3%e8%af%b7" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;p>å¯¹äºŽä¸€ä¸ªé«˜æ•ˆçš„ç³»ç»Ÿæ¥è¯´ï¼Œé«˜æ•ˆçš„å¤„ç†å†…å­˜çš„æ–¹æ³•å¾€å¾€æ˜¯åœ¨å†…å­˜ç”³è¯·ä¸Žå†…å­˜æ‹·è´ä¹‹é—´å¯»æ±‚ä¸€ä¸ªå¹³è¡¡ã€‚&lt;/p>
&lt;p>å¯¹äºŽå°åž‹æ•°æ®æ¥è¯´ï¼Œç›´æŽ¥æ‹·è´æ•°æ®ï¼Œå³â€œæ·±æ‹·è´â€ï¼Œçš„å¼€é”€æ›´å°ã€‚è€Œå¯¹äºŽå¤§åž‹æ•°æ®æ¥è¯´ï¼Œæ‰€è°“â€œæµ…æ‹·è´â€çš„å¼€é”€æ›´å°ã€‚&lt;/p>
&lt;p>&lt;img src="https://github.com/Wizmann/assets/raw/master/wizmann-pic/48deb1742653d61ba04f6e9591f71902" alt="Alt text">&lt;/p>
&lt;p>ZeroMQä½¿ç”¨é€æ˜Žçš„æ–¹å¼æ¥å¤„ç†ä¸¤ç§ä¸åŒçš„åœºæ™¯ã€‚å¹¶ä¸”ï¼Œå¯¹äºŽè§„æ¨¡è¾ƒå¤§çš„æ•°æ®ï¼Œä½¿ç”¨å¼•ç”¨è®¡æ•°çš„ç­–ç•¥ï¼Œæœ€å¤§é™åº¦çš„å¤ç”¨ä¸ŽèŠ‚çœå†…å­˜ä½¿ç”¨ã€‚&lt;/p>
&lt;p>èŽ·å¾—çš„å¯ç¤ºï¼šå½“æˆ‘ä»¬ä¼˜åŒ–æ€§èƒ½æ—¶ï¼Œä¸è¦å‡å®šåªæœ‰ä¸€ä¸ªå…¨å±€æœ€ä¼˜è§£ã€‚åœ¨ä¸åŒçš„åœºæ™¯ä¸‹ï¼Œæœ€ä¼˜è§£çš„å®šä¹‰å¯èƒ½å¤§ä¸ç›¸åŒã€‚&lt;/p>
&lt;h2 id="å¯ç¤º6æ‰¹å¤„ç†">å¯ç¤º6ï¼šæ‰¹å¤„ç† &lt;a href="#%e5%90%af%e7%a4%ba6%e6%89%b9%e5%a4%84%e7%90%86" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;p>å¯¹äºŽä¸€ä¸ªé«˜æ€§èƒ½æ¶ˆæ¯ç³»ç»Ÿæ¥è¯´ï¼Œç³»ç»Ÿè°ƒç”¨çš„ç»å¯¹æ•°é‡å°±æ˜¯ç³»ç»Ÿçš„ç“¶é¢ˆã€‚è¿™å…¶å®žæ˜¯ä¸€ä¸ªå¾ˆæ™®éçš„é—®é¢˜ï¼Œæ¶ˆæ¯åœ¨è°ƒç”¨æ ˆä¹‹é—´ä¼ é€’ï¼Œä¼šå¸¦æ¥ä¸å¯å¿½ç•¥çš„æ€§èƒ½æŸå¤±ã€‚æ‰€ä»¥ï¼Œåœ¨æž„å»ºä¸€ä¸ªé«˜æ€§èƒ½ç³»ç»Ÿæ—¶ï¼Œåº”è¯¥å°½é‡é¿å…æ¶ˆæ¯åœ¨æ ˆé—´çš„ä¼ é€’ã€‚&lt;/p>
&lt;p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå¯¹äºŽå››æ¡æ¶ˆæ¯ï¼Œæˆ‘ä»¬éœ€è¦éåŽ†æ•´ä¸ªç½‘ç»œæ ˆå››æ¬¡ã€‚&lt;/p>
&lt;p>&lt;img src="https://github.com/Wizmann/assets/raw/master/wizmann-pic/b99f65135b0f0e840131c58d2cc57896" alt="Alt text">&lt;/p>
&lt;p>ç„¶è€Œï¼Œå¦‚æžœæˆ‘ä»¬å°†è¿™äº›æ¶ˆæ¯æ‰“åŒ…æˆä¸€æ¡æ¶ˆæ¯ã€‚æˆ‘ä»¬åªéœ€è¦éåŽ†ç½‘ç»œæ ˆä¸€æ¬¡ã€‚&lt;/p>
&lt;p>&lt;img src="https://github.com/Wizmann/assets/raw/master/wizmann-pic/cd2ea1ae7a71443b3ff85ebbc7cb1c3b" alt="Alt text">&lt;/p>
&lt;p>åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬çš„ç­–ç•¥ä¸ŽTCP/IPåè®®ä¸­çš„Nagleç®—æ³•ç±»ä¼¼ã€‚Nagleç®—æ³•æ˜¯ä¸ºäº†å……åˆ†åˆ©ç”¨å¸¦å®½ï¼Œè€ŒZeroMQçš„Batchingç­–ç•¥æ˜¯ä¸ºäº†å‡æ‘Šç½‘ç»œæ ˆçš„æ—¶é—´å¼€é”€ã€‚&lt;/p>
&lt;p>å…·ä½“çš„å®žçŽ°å¦‚ä¸‹:&lt;/p>
&lt;ul>
&lt;li>å½“æ¶ˆæ¯çš„é¢‘çŽ‡æ²¡æœ‰è¶…è¿‡ç½‘ç»œæ ˆçš„å¸¦å®½æ—¶ï¼ŒZeroMQä¼šæŠŠæ‰€æœ‰batchingå…³æŽ‰ï¼Œä»¥CPUåˆ©ç”¨çŽ‡æ¥æ¢å–ä½Žæ—¶å»¶ã€‚&lt;/li>
&lt;li>å½“æ¶ˆæ¯çš„é¢‘çŽ‡è¶…è¿‡ç½‘çº¿æ ˆçš„å¸¦å®½æ—¶ï¼ŒZeroMQä¼šå¯ç”¨batchingï¼Œä»¥æ—¶å»¶ä¸ºä»£ä»·æ¥ä¼˜åŒ–åžåé‡ã€‚&lt;/li>
&lt;li>å½“æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯è¿‡å¤šæ—¶ï¼ŒZeroMQä¼šé‡‡ç”¨æ›´æ¿€è¿›çš„batchingç­–ç•¥ã€‚å› ä¸ºæ¶ˆæ¯çš„å †ç§¯é€ æˆçš„æ—¶å»¶å¢žé•¿å·²ç»ä¸å¯é¿å…ï¼Œç´¢æ€§å°†æ›´å¤šçš„ä¿¡æ¯æ‰“åŒ…ï¼Œè¿™æ ·å¯ä»¥æ›´å¿«çš„æ¸…ç©ºæ¶ˆæ¯çš„ç§¯åŽ‹ã€‚&lt;/li>
&lt;/ul>
&lt;p>å¦å¤–ï¼Œbatchingç­–ç•¥åªåº”è¯¥è¢«åº”ç”¨äºŽé¡¶å±‚ã€‚åœ¨é¡¶å±‚é‡‡ç”¨batchingä¹‹åŽï¼Œä½Žå±‚çš„batchingå°±æ²¡æœ‰æ„ä¹‰äº†ã€‚&lt;/p>
&lt;p>èŽ·å¾—çš„å¯ç¤ºï¼š&lt;/p>
&lt;ul>
&lt;li>åœ¨ä¸€ä¸ªå¼‚æ­¥ç³»ç»Ÿä¸­ï¼Œæƒ³è¦èŽ·å¾—æœ€ä½³çš„å“åº”æ—¶é—´ï¼Œåº”è¯¥æŠŠåº•å±‚çš„batchingç­–ç•¥è½¬ç§»åˆ°é¡¶å±‚ã€‚&lt;/li>
&lt;li>batchingåªåº”è¯¥åœ¨æ–°æ•°æ®åˆ°æ¥çš„é€Ÿåº¦è¶…è¿‡ç³»ç»Ÿå¸¦å®½æ—¶æ‰é‡‡ç”¨ã€‚&lt;/li>
&lt;/ul>
&lt;h2 id="å¯ç¤º7æ•´ä½“æž¶æž„">å¯ç¤º7ï¼šæ•´ä½“æž¶æž„ &lt;a href="#%e5%90%af%e7%a4%ba7%e6%95%b4%e4%bd%93%e6%9e%b6%e6%9e%84" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;p>&lt;img src="https://github.com/Wizmann/assets/raw/master/wizmann-pic/22f7b30fb17c9a128bbb6dd66ad27a13" alt="Alt text">&lt;/p>
&lt;p>ç”¨æˆ·åˆ©ç”¨â€œsocketâ€ä¸ŽZeroMQè¿›è¡Œäº¤äº’ï¼Œä¸€ä¸ªsocketå¯ä»¥åŒå¤šä¸ªpeerè¿›è¡Œäº¤äº’ã€‚&lt;/p>
&lt;p>socketå­˜åœ¨äºŽç”¨æˆ·çº¿ç¨‹ä¸­ã€‚è€Œä¸€äº›å·¥ä½œçº¿ç¨‹ä¼šå¤„ç†å¼‚æ­¥çš„äº¤äº’è¿‡ç¨‹ï¼Œå¦‚ï¼šä»Žç½‘ç»œè¯»å–æ¶ˆæ¯ï¼Œå°†æ¶ˆæ¯æ”¾å…¥é˜Ÿåˆ—ï¼ŒæŽ¥å—æ–°çš„è¿žæŽ¥è¯·æ±‚ç­‰ã€‚&lt;/p>
&lt;p>sessionè´Ÿè´£ä¸ŽZeroMQä¸­çš„socketè¿›è¡Œäº¤äº’ï¼Œengineè´Ÿè´£ç½‘ç»œäº¤äº’ã€‚sessionåªæœ‰ä¸€ç§ï¼Œè€Œengineæ ¹æ®ä½¿ç”¨çš„åè®®ä¸åŒï¼Œå¯ä»¥æœ‰å¾ˆå¤šç§ã€‚&lt;/p>
&lt;p>sessionä¸Žsocketä¹‹é—´ä½¿ç”¨pipeè¿›è¡Œé€šä¿¡ï¼Œpipeè¢«å®žçŽ°ä¸ºçº¿ç¨‹å®‰å…¨çš„åŒç«¯é˜Ÿåˆ—ï¼Œç”¨æ¥åœ¨çº¿ç¨‹é—´ä¼ é€’ä¿¡æ¯ã€‚&lt;/p>
&lt;p>èŽ·å¾—çš„å¯ç¤ºï¼šå­¦ä¹ äº†æ•´ä½“çš„è®¾è®¡æ€è·¯ï¼ˆç¬‘&lt;/p>
&lt;h2 id="å¯ç¤º8å¹¶å‘æ¨¡åž‹">å¯ç¤º8ï¼šå¹¶å‘æ¨¡åž‹ &lt;a href="#%e5%90%af%e7%a4%ba8%e5%b9%b6%e5%8f%91%e6%a8%a1%e5%9e%8b" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;p>é«˜æ•ˆçš„ZeroMQå¿…ç„¶è¦åˆ©ç”¨å¤šæ ¸çš„è®¡ç®—èµ„æºï¼Œè€Œä¼ ç»Ÿçš„å¤šçº¿ç¨‹æ¨¡åž‹ä¼šå¼•å…¥é”ã€ä¿¡å·é‡ç­‰çº¿ç¨‹åŒæ­¥æœºåˆ¶ï¼Œä¼šå½±å“ç³»ç»Ÿçš„æ•´ä½“æ€§èƒ½ã€‚è€Œä½¿ç”¨ç‹¬ç«‹çš„çº¿ç¨‹åˆä¼šå¼•å…¥ä¸Šä¸‹æ–‡åˆ‡æ¢çš„å¼€é”€ã€‚&lt;/p>
&lt;p>ZeroMQä½¿ç”¨çš„å¹¶å‘æ¨¡åž‹æ˜¯Actorï¼Œå…¶ç›®æ ‡æ˜¯å®Œå…¨é¿å…é”çš„ä½¿ç”¨ï¼Œè®©æ‰€æœ‰çš„ç»„ä»¶å…¨é€Ÿè¿è¡Œã€‚&lt;/p>
&lt;p>æ¯ä¸€ä¸ªCPUæ ¸å¿ƒåªæœ‰ä¸€ä¸ªworkerçº¿ç¨‹ï¼Œæ‰€æœ‰å†…éƒ¨å¯¹è±¡éƒ½æ˜¯çº¿ç¨‹ä¸“æœ‰çš„ï¼Œè¿™æ ·å°±å®Œå…¨é¿å…äº†é”çš„ä½¿ç”¨ã€‚&lt;/p>
&lt;p>è¿™æ ·ä¸€æ¥ï¼Œè®¸å¤šå¯¹è±¡éƒ½è¦åˆ†äº«æœ‰é™ä¸ªæ•°çš„workerã€‚æ‰€ä»¥ï¼Œç³»ç»Ÿåº”å½“æ˜¯å…¨å¼‚æ­¥çš„ã€‚å› ä¸ºæ¯ä¸€ä¸ªworkerçš„é˜»å¡žï¼Œéƒ½ä¼šé˜»å¡žå…¶å®ƒä½¿ç”¨workerçš„å¯¹è±¡ã€‚&lt;/p>
&lt;p>èŽ·å¾—çš„å¯ç¤ºï¼šActoræ¨¡åž‹æ˜¯æžè‡´è§£å†³æ€§èƒ½ä¸Žæ‰©å±•æ€§é—®é¢˜çš„æ–¹æ³•ã€‚ä½†æ˜¯ï¼Œå¦‚æžœä½ ä¸æ˜¯åœ¨ä½¿ç”¨ZeroMQæˆ–Erlangï¼Œä½ éœ€è¦æ‰‹å†™è®¸å¤šç›¸å…³çš„Test Caseæ¥æµ‹è¯•ç³»ç»Ÿçš„æ­£ç¡®æ€§å’Œç¨³å®šæ€§ã€‚å¦å¤–ï¼Œå¦‚æžœä½ æ— æ³•åº”å¯¹æ¨¡åž‹ä¸­çš„å¤æ‚æ¨¡å—ï¼ˆå¦‚ZeroMQçš„shutdownï¼‰ï¼Œè¯·ä¸è¦è½»æ˜“å°è¯•ä½¿ç”¨Actoræ¨¡åž‹ã€‚&lt;/p>
&lt;h2 id="å¯ç¤º9æ— é”ç®—æ³•">å¯ç¤º9ï¼šæ— é”ç®—æ³• &lt;a href="#%e5%90%af%e7%a4%ba9%e6%97%a0%e9%94%81%e7%ae%97%e6%b3%95" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;p>æ— é”ç®—æ³•ä½¿ç”¨ç®€å•çš„æ–¹æ³•è¿›è¡Œçº¿ç¨‹é—´çš„é€šä¿¡ï¼Œè€Œä¸ä¾èµ–å†…æ ¸çº§çš„åŒæ­¥åŽŸè¯­ã€‚æ— é”ç®—æ³•çš„å…³é”®æ˜¯CPUä¸­çš„åŽŸå­æ“ä½œï¼Œä¾‹å¦‚compare-and-swapï¼ˆCASï¼‰æ“ä½œã€‚ä½†æ˜¯ï¼Œè¦è®°ä½ï¼Œæ— é”æ“ä½œå¹¶ä¸æ˜¯çœŸæ­£çš„â€œæ— é”â€ï¼Œè€Œæ˜¯æŠŠé”æ“ä½œæ”¾åˆ°äº†è¾ƒä¸ºé«˜æ•ˆçš„ç¡¬ä»¶å±‚ã€‚&lt;/p>
&lt;p>ZeroMQä½¿ç”¨ä¸€ä¸ªæ— é”é˜Ÿåˆ—åœ¨ç”¨æˆ·çº¿ç¨‹ä¸Žå·¥ä½œçº¿ç¨‹é—´è¿›è¡Œæ¶ˆæ¯ä¼ é€’ã€‚ZeroMQä¸­çš„æ— é”é˜Ÿåˆ—æœ‰å¦‚ä¸‹ç‰¹ç‚¹ï¼š&lt;/p>
&lt;p>ç¬¬ä¸€ï¼Œæ¯ä¸€ä¸ªé˜Ÿåˆ—ä¸ºâ€œä¸€å†™ä¸€è¯»â€ã€‚å½“æœ‰ä¸€å¯¹å¤šçš„è¯»å†™éœ€æ±‚å­˜åœ¨æ—¶ï¼ŒZeroMQä¼šåˆ›å»ºå¤šæ¡é˜Ÿåˆ—ã€‚è¿™æ ·çš„è®¾è®¡ä½¿å¾—æˆ‘ä»¬ä¸ç”¨å…³å¿ƒå¤šçº¿ç¨‹è¯»å†™å¸¦æ¥çš„åŒæ­¥é—®é¢˜ï¼Œæœ‰åˆ©äºŽæˆ‘ä»¬å¯¹å…¶æ€§èƒ½çš„ä¼˜åŒ–ã€‚&lt;/p>
&lt;p>ç¬¬äºŒï¼Œå³ä½¿æ— é”ç®—æ³•æ¯”ä¼ ç»Ÿçš„é”ç®—æ³•è¦å¿«å¾ˆå¤šï¼Œä½†æ˜¯å…¶ä»£ä»·ä»ç„¶æ˜¯è¿‡é«˜çš„ï¼ˆå°¤å…¶æ˜¯åœ¨CPUæ ¸å¿ƒä¹‹é—´çš„é€šä¿¡ï¼‰ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬ä»ç„¶ä¾èµ–äºŽâ€œbatchingâ€ç®—æ³•ï¼Œå°†æ˜‚è´µçš„åŒæ­¥æ“ä½œå‡æ‘Šåˆ°å¤šæ¡æ¶ˆæ¯ä¸Šã€‚åœ¨ä»Žé˜Ÿåˆ—çœŸæ­£çš„è¯»å†™æ“ä½œä¹‹å‰ï¼ŒåŠ å…¥ä¸€æ¬¡é¢„å¤„ç†ï¼ˆpre-write / pre-readï¼‰ï¼Œå°†æ¶ˆæ¯æ‰“ä¸ªåŒ…ï¼Œå‘ç”³é€šã€‚&lt;/p>
&lt;p>&lt;img src="https://github.com/Wizmann/assets/raw/master/wizmann-pic/9d97e2979db40e413e43cf7d642d1570" alt="Alt text">&lt;/p>
&lt;p>èŽ·å¾—çš„å¯ç¤ºï¼šæ— é”ç®—æ³•æ˜¯éžå¸¸ç²¾å·§çš„ï¼Œå¦‚æžœå¯èƒ½çš„è¯ï¼Œå°½é‡ä½¿ç”¨æˆç†Ÿçš„è®¾è®¡ã€‚å¦‚æžœä½ éœ€è¦æžè‡´çš„æ€§èƒ½ï¼Œä¸è¦ä»…ä»…ä¾èµ–äºŽæ— é”ç®—æ³•ã€‚å°½ç®¡æ— é”ç®—æ³•éžå¸¸å¿«ï¼Œä½ ä»ç„¶å¯ä»¥é€šè¿‡batchingç­–ç•¥ä¼˜åŒ–å®ƒã€‚ï¼ˆå¦å¤–ï¼ŒåŠ é’±ä¸Šèˆ¹ä¹Ÿå¯ä»¥ã€‚ï¼‰&lt;/p>
&lt;h2 id="å¯ç¤º10apiè®¾è®¡">å¯ç¤º10ï¼šAPIè®¾è®¡ &lt;a href="#%e5%90%af%e7%a4%ba10api%e8%ae%be%e8%ae%a1" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;p>&lt;strong>è®¾è®¡APIï¼Œå°±åƒè®¾è®¡ä¸€æ¬¾äº§å“ã€‚&lt;/strong>&lt;/p>
&lt;p>ç”¨æˆ·å¯¹äºŽä¸€ä¸ªç¨‹åºåº“çš„ç¬¬ä¸€æ„Ÿè§‰æ¥è‡ªäºŽç”¨æˆ·æŽ¥å£ã€‚ZeroMQç®€åŒ–äº†è‡ªå·±çš„ç”¨æˆ·æŽ¥å£ï¼Œå°†å…¶ç”±åŽŸæ¥çš„â€œç‚’é¸¡å¤æ‚ä¸€ä¸å°å¿ƒå‘æ­»ä½ çš„ä¼ä¸šçº§æ¶ˆæ¯æ¡†æž¶â€å˜ä¸ºäº†â€œæƒ³å‘æ¶ˆæ¯è°ƒç”¨ä¸‹å°±OKâ€çš„æžæ˜“ä¸Šæ‰‹çš„å…¥é—¨çº§äº§å“ã€‚&lt;/p>
&lt;p>å¦å¤–ä¸€ä¸ªé‡è¦çš„æ–¹é¢ï¼ŒZeroMQä½¿ç”¨äº†å¹¿ä¸ºä½¿ç”¨çš„BSD Sockets APIã€‚è¿™æ ·åšçš„ä¼˜ç‚¹æ˜¯ï¼š&lt;/p>
&lt;ul>
&lt;li>è¿™æ˜¯ä¸€ä¸ªå¤§å®¶éƒ½ç†ŸçŸ¥çš„APIï¼Œå­¦ä¹ æ›²çº¿ç›¸å½“å¹³ç¼“&lt;/li>
&lt;li>ä½¿ZeroMQä¸ŽçŽ°æœ‰çš„æŠ€æœ¯è¿žæŽ¥èµ·æ¥ï¼Œæœ‰åˆ©äºŽå¤ç”¨å·²ç”¨çš„æ¡†æž¶ä¸Žè®¾è®¡&lt;/li>
&lt;li>æœ€é‡è¦çš„æ˜¯ï¼Œä½¿ç”¨ä¸€ä¸ªæˆç†Ÿä¸Žä¹…ç»è€ƒéªŒçš„æ¡†æž¶ï¼Œå¯ä»¥é¿å…è¸©å‰äººè¸©è¿‡çš„å‘ã€&lt;/li>
&lt;/ul>
&lt;p>èŽ·å¾—çš„å¯ç¤ºï¼šé™¤äº†ä»£ç å¤ç”¨ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ä»¥ä¸€ç§æ›´ä¸€èˆ¬çš„æ–¹æ³•ï¼Œå¤ç”¨æˆç†Ÿçš„æŠ€æœ¯ã€‚å½“ä½ è®¾è®¡ä¸€ä¸ªæ–°äº§å“æ—¶ï¼Œå€Ÿé‰´ä¸€ä¸‹ç±»ä¼¼çš„äº§å“ï¼ˆè…¾è®¯ï¼ï¼‰ã€‚ä¸è¦çŠ¯â€œåœ¨è¿™é‡Œè¿˜æ²¡æœ‰è¢«å‘æ˜Žâ€ï¼ˆNot Invented Hereï¼‰ç»¼åˆç—‡ã€‚å¤ç”¨ä¸€åˆ‡åˆé€‚çš„æƒ³æ³•ã€APIã€æ¡†æž¶æŠ½è±¡ã€‚å…è®¸ç”¨æˆ·ä½¿ç”¨å·²æœ‰çš„çŸ¥è¯†ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥è®©æˆ‘ä»¬è§„é¿æœªçŸ¥çš„é£Žé™©ã€‚&lt;/p>
&lt;h2 id="å¯ç¤º11æ¶ˆæ¯æ¨¡å¼">å¯ç¤º11ï¼šæ¶ˆæ¯æ¨¡å¼ &lt;a href="#%e5%90%af%e7%a4%ba11%e6%b6%88%e6%81%af%e6%a8%a1%e5%bc%8f" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;p>ZeroMQçš„è®¾è®¡æ€è·¯æ˜¯&lt;strong>ä¸“æ³¨äºŽä¸€ä¸ªé¢†åŸŸï¼ŒæŠŠå®ƒåšåˆ°æœ€å¥½&lt;/strong>ã€‚å› ä¸ºï¼Œå¤§è€Œå…¨çš„äº§å“åªèƒ½ç»™é¢†åŸŸä¸“å®¶æ¥ä½¿ç”¨ï¼Œè€Œå°è€Œç²¾çš„äº§å“çš„å—ä¼—åˆ™æ˜¯ä»»ä½•å—è¿‡è®­ç»ƒçš„ç¨‹åºå‘˜ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>s &lt;span style="color:#f92672">=&lt;/span> socket (REQ)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>s.connect (&lt;span style="color:#e6db74">&amp;#34;tcp://192.168.0.111:5555&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>s.send (&lt;span style="color:#e6db74">&amp;#34;Hello World!&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>reply &lt;span style="color:#f92672">=&lt;/span> s.recv ()
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å½“æˆ‘ä»¬è¦ç»™ç”¨æˆ·æä¾›æ›´ä¸€èˆ¬æ€§çš„è§£å†³æ–¹æ¡ˆæ—¶ï¼Œä¸€ä¸ªæŠ€æœ¯æ ˆï¼Œæ ˆçš„æ¯ä¸€å±‚å¯ä»¥æœ‰ä¸åŒçš„å®žçŽ°ï¼Œä»Žè€Œé€‚åº”ä¸åŒäººç¾¤çš„éœ€è¦ã€‚&lt;/p>
&lt;p>è¿™å’ŒInternetæ ˆçš„è®¾è®¡æ€è·¯éžå¸¸ç›¸ä¼¼ï¼šTCPå¯ä»¥è§£å†³åŸºäºŽé“¾æŽ¥çš„ã€å¯é çš„æ•°æ®æµä¼ è¾“ï¼ŒUDPå¯ä»¥è§£å†³ä¸å¯é çš„æ•°æ®åŒ…ä¼ è¾“ï¼ŒSCTPå¯ä»¥è§£å†³å¤šç”¨æˆ·æ•°æ®æµä¼ è¾“é—®é¢˜ç­‰ç­‰ã€‚&lt;/p>
&lt;p>è¿™æ ·ä¸€æ¥ï¼Œæ‰€æœ‰çš„è§£å†³æ–¹æ¡ˆéƒ½æ˜¯æ­£äº¤çš„ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨å…¶ä¸­å¥½çš„è®¾è®¡ï¼Œä¹Ÿå¯ä»¥æ²¡æœ‰é¢å¤–ä»£ä»·çš„æŠ›å¼ƒä¸å¥½çš„è®¾è®¡ã€‚&lt;/p>
&lt;p>èŽ·å¾—çš„å¯ç¤ºï¼šå½“è§£å†³ä¸€ä¸ªå¤æ‚ä¸”å¤šé¢åŒ–çš„é—®é¢˜æ—¶ï¼Œå•ä¸ªé€šç”¨åž‹çš„è§£å†³æ–¹æ¡ˆå¯èƒ½å¹¶ä¸æ˜¯æœ€å¥½çš„æ–¹å¼ã€‚ç›¸åï¼Œæˆ‘ä»¬å¯ä»¥æŠŠé—®é¢˜çš„é¢†åŸŸæƒ³è±¡æˆä¸€ä¸ªæŠ½è±¡å±‚ï¼Œå¹¶åŸºäºŽè¿™ä¸ªå±‚æ¬¡æä¾›å¤šä¸ªå®žçŽ°ï¼Œæ¯ç§å®žçŽ°åªè‡´åŠ›äºŽè§£å†³ä¸€ç§å®šä¹‰è‰¯å¥½çš„æƒ…å†µã€‚&lt;/p>
&lt;p>å½“æˆ‘ä»¬è¿™ä¹ˆåšæ—¶ï¼Œç¡®å®šé—®é¢˜çš„ç²’åº¦éžå¸¸é‡è¦ã€‚å¦‚æžœç²’åº¦è¿‡ç»†ï¼Œè½¯ä»¶çš„ä¸€èˆ¬æ€§å°±ä¼šå—åˆ°é™åˆ¶ã€‚å¦‚æžœç²’åº¦è¿‡ç²—ï¼Œé‚£ä¹ˆäº§å“å°±ä¼šå˜å¾—éžå¸¸å¤æ‚ï¼Œç»™ç”¨æˆ·å¸¦æ¥æ¨¡ç³Šå’Œæ··ä¹±çš„æ„Ÿè§‰ã€‚&lt;/p>
&lt;h2 id="åŽè®°">åŽè®° &lt;a href="#%e5%90%8e%e8%ae%b0" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;ul>
&lt;li>åŽŸæ–‡é“¾æŽ¥ï¼šhttp://www.aosabook.org/en/zeromq.html&lt;/li>
&lt;li>ä¸­æ–‡ç¿»è¯‘ï¼šhttp://www.ituring.com.cn/article/4669&lt;/li>
&lt;/ul>
&lt;p>æœ¬æ–‡ä¸­å€Ÿé‰´äº†ä¸­æ–‡ç¿»è¯‘çš„éƒ¨åˆ†è¯å¥ï¼Œå¯¹æ­¤è¡¨ç¤ºæ„Ÿè°¢ã€‚&lt;/p></description></item><item><title>System Design - æœ€çƒ­é—¨çš„IPåœ°å€</title><link>https://wizmann.top/posts/hottest-ip-address/</link><pubDate>Fri, 08 Aug 2014 01:25:54 +0000</pubDate><guid>https://wizmann.top/posts/hottest-ip-address/</guid><description>&lt;h2 id="å†™åœ¨å‰é¢">å†™åœ¨å‰é¢ &lt;a href="#%e5%86%99%e5%9c%a8%e5%89%8d%e9%9d%a2" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;p>é—®é¢˜æ˜¯éžå¸¸æµè¡Œçš„ï¼Œä¹Ÿç¡®å®žæµè¡Œäº†ä¸€é˜µçš„system-designé—®é¢˜ã€‚åœ¨&lt;a href="http://www.zhihu.com/question/19805967">çŸ¥ä¹Ž&lt;/a>ä¸Šå†æ¬¡è¢«äººæèµ·ã€‚ç„¶åŽæˆ‘éžå¸¸æ¬£èµ&lt;a href="http://zhi.hu/3gJb">é™ˆç¡•çš„å›žç­”&lt;/a>ã€‚æ‰€ä»¥è¦å†™ä¸€ç¯‡æ–‡ç« ï¼Œè®°ä¸‹è‡ªå·±çš„æ„Ÿæƒ³ã€‚&lt;/p>
&lt;h2 id="é—®é¢˜">é—®é¢˜ &lt;a href="#%e9%97%ae%e9%a2%98" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;p>æµ·é‡æ•°æ®ç®—æ³•:å¦‚ä½•ä»Žè¶…è¿‡10Gçš„è®°å½•IPåœ°å€çš„æ—¥å¿—ä¸­ï¼Œè¾ƒå¿«çš„æ‰¾å‡ºç™»å½•æ¬¡æ•°æœ€å¤šçš„ä¸€ä¸ªIPï¼Ÿ&lt;/p>
&lt;h2 id="é“¶å¼¹">é“¶å¼¹ï¼Ÿ &lt;a href="#%e9%93%b6%e5%bc%b9" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;p>é¢å¯¹è¿™ç§system-designé—®é¢˜ï¼Œå°¤å…¶æ˜¯è¿™ç§ï¼Œ&lt;strong>éžé«˜å¹¶å‘ã€éžå®žæ—¶&lt;/strong>çš„é—®é¢˜ï¼Œå¾ˆå¤šäººä¼šé‡‡ç”¨_map-reduce_ â€”â€” è§£å†³system-designé—®é¢˜çš„é“¶å¼¹ã€‚&lt;/p>
&lt;p>æˆ‘å¯¹map-reduceçš„ç†è§£éžå¸¸è‚¤æµ…ï¼Œä½†æ˜¯å¯ä»¥è§£é‡Šä¸€ä¸‹å¤§æ¦‚çš„æµç¨‹ã€‚&lt;/p>
&lt;ol>
&lt;li>å°†æ—¥å¿—è¿›è¡Œåˆ†ç‰‡ã€‚æŠŠhash(ip)ç›¸åŒçš„ipåœ°å€åˆ†åˆ°åŒä¸€ä¸ªç‰‡ä¸­ã€‚ï¼ˆæ³¨ï¼šè¿™é‡Œçš„hashå¹¶ä¸æ˜¯ç­¾åå‡½æ•°ï¼Œåªæ˜¯ä¸€ä¸ªåˆ†ç‰‡æ ‡ç¤ºï¼‰&lt;/li>
&lt;li>åˆ†ç‰‡åŽçš„æ—¥å¿—çš„å¤§å°ä¼šå°å¾ˆå¤šï¼Œå¯ä»¥æ–¹ä¾¿çš„è¿›è¡ŒæŽ’åºï¼Œè®°æ•°ã€‚&lt;/li>
&lt;li>ç„¶åŽå†ä»Žå„ä¸ªç‰‡ä¸­ï¼Œç»Ÿè®¡å‡ºæœ€çƒ­é—¨çš„IPåœ°å€ã€‚ï¼ˆæˆ–TopKçš„IPåœ°å€ï¼‰&lt;/li>
&lt;/ol>
&lt;p>å¦‚æžœä¸æ»¡æ„æˆ‘çš„ç­”æ¡ˆçš„è¯ï¼ŒæŽ¨è&lt;a href="http://book.douban.com/subject/19934150/">Mining of Massive Datasets&lt;/a>ä¸€ä¹¦ï¼Œå…¶ä¸­å¯¹map-reduceç®—æ³•åšä¸€ç•ªä¸é”™çš„ä»‹ç»ã€‚&lt;/p>
&lt;h2 id="æ­£ç¡®çš„åˆ†æžå§¿åŠ¿">æ­£ç¡®çš„åˆ†æžå§¿åŠ¿ &lt;a href="#%e6%ad%a3%e7%a1%ae%e7%9a%84%e5%88%86%e6%9e%90%e5%a7%bf%e5%8a%bf" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;h3 id="ä¸šåŠ¡å®žä½“">ä¸šåŠ¡å®žä½“ &lt;a href="#%e4%b8%9a%e5%8a%a1%e5%ae%9e%e4%bd%93" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;blockquote>
&lt;p>ä¸šåŠ¡å®žä½“æ‹¥æœ‰å››ç§ä¸»è¦çš„ç»„ä»¶ï¼š ä¿¡æ¯æ¨¡åž‹ã€ç”Ÿå‘½å‘¨æœŸæ¨¡åž‹ã€è®¿é—®ç­–ç•¥ä»¥åŠé€šçŸ¥ã€‚&lt;/p>&lt;/blockquote>
&lt;p>æ¢å¥è¯è¯´ï¼Œä¸šåŠ¡å®žä½“å°±æ˜¯é¢˜ç›®ä¸­æåˆ°çš„â€œåè¯â€ã€‚&lt;/p>
&lt;p>åœ¨æœ¬é¢˜ä¸­ï¼Œä¸šåŠ¡å®žä½“æœ‰ï¼š&lt;/p>
&lt;ul>
&lt;li>IPåœ°å€ï¼ˆé»˜è®¤ä¸ºipv4ï¼‰&lt;/li>
&lt;li>æœ€çƒ­é—¨IPåœ°å€&lt;/li>
&lt;/ul>
&lt;h3 id="ä¸šåŠ¡åº”ç”¨">ä¸šåŠ¡åº”ç”¨ &lt;a href="#%e4%b8%9a%e5%8a%a1%e5%ba%94%e7%94%a8" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;p>ä¸šåŠ¡åº”ç”¨æŒ‡çš„æ˜¯å½“å‰åœºæ™¯çš„&lt;strong>ç‰¹æ®Š&lt;/strong>åº”ç”¨ï¼Œä»¥åŠä¸šåŠ¡å®žä½“çš„å…³è”å…³ç³»ã€‚&lt;/p>
&lt;p>åœ¨æœ¬é—®é¢˜ä¸­ï¼Œä¸šåŠ¡åº”ç”¨æŒ‡çš„æ˜¯ï¼š&lt;/p>
&lt;ul>
&lt;li>æ‰¾åˆ°&lt;strong>æœ€çƒ­é—¨&lt;/strong>çš„IPåœ°å€&lt;/li>
&lt;li>å¤§æ•°æ®é‡ï¼Œ10Gçš„æ—¥å¿—æ–‡ä»¶ â€”â€” ä¸æ–¹ä¾¿åœ¨å†…å­˜ä¸­è¿›è¡Œæ“ä½œ
ï¼ˆåœ¨åŠ¨è¾™ä¸Šç™¾Gçš„æœåŠ¡å™¨é¢å‰ï¼Œ10Gçš„æ•°æ®é‡çœŸæ˜¯å¼±çˆ†äº†^_^)&lt;/li>
&lt;/ul>
&lt;h3 id="ç‰©ç†">ç‰©ç† &lt;a href="#%e7%89%a9%e7%90%86" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;p>ç‰©ç†æŒ‡çš„æ˜¯æ•°æ®çš„ç‰©ç†æ¨¡åž‹ï¼ŒåŒ…æ‹¬æ•°æ®ç»“æž„ã€æ•°æ®åº“è¡¨ç­‰ã€‚&lt;/p>
&lt;p>åœ¨æœ¬é¢˜ä¸­ï¼ŒæŒ‡çš„æ˜¯å¯¹IPåœ°å€å­˜å‚¨å’Œè®°æ•°çš„æ•°æ®ç»“æž„ã€‚&lt;/p>
&lt;h3 id="è®©æˆ‘ä»¬åšä¸€ä¸‹åˆ†æž">è®©æˆ‘ä»¬åšä¸€ä¸‹åˆ†æž &lt;a href="#%e8%ae%a9%e6%88%91%e4%bb%ac%e5%81%9a%e4%b8%80%e4%b8%8b%e5%88%86%e6%9e%90" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;p>æœ¬é¢˜ä¸­ï¼Œä¸šåŠ¡å®žä½“çš„ç‰¹ç‚¹æ˜¯ï¼š&lt;/p>
&lt;ul>
&lt;li>IPv4å¯ä»¥ç”±ä¸€ä¸ªuint32_tæ¥è¡¨ç¤º&lt;/li>
&lt;li>ipåœ°å€æ˜¯ç¨€ç–çš„
&lt;ul>
&lt;li>å¤§éƒ¨åˆ†ipåœ°å€çš„è®¿é—®æ¬¡æ•°éžå¸¸å°‘ï¼ˆé•¿å°¾ï¼‰&lt;/li>
&lt;li>å¾ˆå¤šipåœ°å€æ˜¯ä¿ç•™åœ°å€ï¼Œæ‰€ä»¥ä¸å¯èƒ½å‡ºçŽ°åœ¨æ—¥å¿—ä¸­&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>ä¸šåŠ¡åº”ç”¨çš„ç‰¹ç‚¹æ˜¯ï¼š&lt;/p>
&lt;ul>
&lt;li>â€œæœ€çƒ­é—¨â€è¡¨ç¤ºè¦æ±‚å¾—ç²¾ç¡®è§£ï¼Œè€Œä¸æ˜¯æ»¡æ„è§£&lt;/li>
&lt;li>å†…å­˜é™åˆ¶&lt;/li>
&lt;/ul>
&lt;p>åº”ç”¨çš„ç‰©ç†ç»“æž„çš„ç‰¹ç‚¹æ˜¯ï¼š æ”¯æŒå­˜å‚¨ä¸Žè®°æ•°&lt;/p>
&lt;h2 id="æ— ä»£ç æ— çœŸç›¸">æ— ä»£ç æ— çœŸç›¸ &lt;a href="#%e6%97%a0%e4%bb%a3%e7%a0%81%e6%97%a0%e7%9c%9f%e7%9b%b8" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;assert.h&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;stdint.h&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;stdio.h&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;vector&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">static_assert&lt;/span>(&lt;span style="color:#66d9ef">sizeof&lt;/span>(&lt;span style="color:#66d9ef">void&lt;/span>&lt;span style="color:#f92672">*&lt;/span>) &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#ae81ff">8&lt;/span>, &lt;span style="color:#e6db74">&amp;#34;64-bit only.&amp;#34;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>std&lt;span style="color:#f92672">::&lt;/span>vector&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">uint8_t&lt;/span>&lt;span style="color:#f92672">&amp;gt;&lt;/span> counts_;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">struct&lt;/span> &lt;span style="color:#a6e22e">IPcount&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">uint32_t&lt;/span> ip;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">uint32_t&lt;/span> count;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">bool&lt;/span> &lt;span style="color:#66d9ef">operator&lt;/span>&lt;span style="color:#f92672">&amp;lt;&lt;/span>(IPcount rhs) &lt;span style="color:#66d9ef">const&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> { &lt;span style="color:#66d9ef">return&lt;/span> ip &lt;span style="color:#f92672">&amp;lt;&lt;/span> rhs.ip; }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>};
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>std&lt;span style="color:#f92672">::&lt;/span>vector&lt;span style="color:#f92672">&amp;lt;&lt;/span>IPcount&lt;span style="color:#f92672">&amp;gt;&lt;/span> overflows_;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>IPcount top;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">addOverflow&lt;/span>(&lt;span style="color:#66d9ef">uint32_t&lt;/span> ip)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> IPcount newItem &lt;span style="color:#f92672">=&lt;/span> { ip, &lt;span style="color:#ae81ff">256&lt;/span> };
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">auto&lt;/span> it &lt;span style="color:#f92672">=&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>lower_bound(overflows_.begin(), overflows_.end(), newItem);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (it &lt;span style="color:#f92672">!=&lt;/span> overflows_.end() &lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span> it&lt;span style="color:#f92672">-&amp;gt;&lt;/span>ip &lt;span style="color:#f92672">==&lt;/span> ip)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> it&lt;span style="color:#f92672">-&amp;gt;&lt;/span>count&lt;span style="color:#f92672">++&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> assert(it&lt;span style="color:#f92672">-&amp;gt;&lt;/span>count &lt;span style="color:#f92672">!=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span> &lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span> &lt;span style="color:#e6db74">&amp;#34;you need larger count variable&amp;#34;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> newItem.count &lt;span style="color:#f92672">=&lt;/span> it&lt;span style="color:#f92672">-&amp;gt;&lt;/span>count;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">else&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> overflows_.insert(it, newItem);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (newItem.count &lt;span style="color:#f92672">&amp;gt;&lt;/span> top.count)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> top &lt;span style="color:#f92672">=&lt;/span> newItem;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">add&lt;/span>(&lt;span style="color:#66d9ef">uint32_t&lt;/span> ip)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (counts_[ip] &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#ae81ff">255&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> addOverflow(ip);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">else&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> counts_[ip]&lt;span style="color:#f92672">++&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (counts_[ip] &lt;span style="color:#f92672">&amp;gt;&lt;/span> top.count)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> top.ip &lt;span style="color:#f92672">=&lt;/span> ip;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> top.count &lt;span style="color:#f92672">=&lt;/span> counts_[ip];
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">uint32_t&lt;/span> &lt;span style="color:#a6e22e">getMostFrequenntIP&lt;/span>()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> top.ip;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">int&lt;/span> &lt;span style="color:#a6e22e">main&lt;/span>()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> assert(counts_.max_size() &lt;span style="color:#f92672">&amp;gt;&lt;/span> &lt;span style="color:#ae81ff">0xFFFFFFFFUL&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> counts_.resize(&lt;span style="color:#ae81ff">1L&lt;/span> &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#ae81ff">32&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> printf(&lt;span style="color:#e6db74">&amp;#34;%zd&lt;/span>&lt;span style="color:#ae81ff">\n&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span>, counts_.size());
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> add(&lt;span style="color:#ae81ff">0x1&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> add(&lt;span style="color:#ae81ff">0x2&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> add(&lt;span style="color:#ae81ff">0x2&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">for&lt;/span> (size_t i &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>; i &lt;span style="color:#f92672">&amp;lt;&lt;/span> (&lt;span style="color:#ae81ff">1L&lt;/span> &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#ae81ff">32&lt;/span>)&lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>; &lt;span style="color:#f92672">++&lt;/span>i)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> add(&lt;span style="color:#ae81ff">0x3&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> printf(&lt;span style="color:#e6db74">&amp;#34;%08x %u&lt;/span>&lt;span style="color:#ae81ff">\n&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span>, top.ip, top.count);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="ä»Žä»£ç è¯´å¼€æ¥">ä»Žä»£ç è¯´å¼€æ¥ &lt;a href="#%e4%bb%8e%e4%bb%a3%e7%a0%81%e8%af%b4%e5%bc%80%e6%9d%a5" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;p>è¿™æ®µä»£ç ä¸ç®—æœ€æ¼‚äº®ï¼Œæœ‰å‡ ä¸ªå°æ§½ç‚¹ï¼Œä½†ä¹Ÿç®—æ˜¯éžå¸¸ä¼˜é›…çš„ã€‚&lt;/p>
&lt;p>ä»Žæ€è·¯ä¸Šè¯´ï¼Œè¿™æ®µä»£ç æ³¨æ„åˆ°äº†æˆ‘ä»¬åˆšæ‰åˆ†æžåˆ°çš„ï¼Œè¿™ä¸ªé—®é¢˜çš„ä¸šåŠ¡ç‰¹ç‚¹ã€‚&lt;/p>
&lt;ol>
&lt;li>ipv4åœ°å€å¯ä»¥å­˜åœ¨uint32_tä¸­ï¼Œæ— éœ€å­˜å‚¨å­—ç¬¦ä¸²&lt;/li>
&lt;li>ipåœ°å€æ˜¯ç¨€ç–çš„ï¼Œæ‰€ä»¥ä½¿ç”¨ä¸€å±‚uint_8è¿›è¡Œå“ˆå¸Œè®°æ•°ï¼Œå¯¹äºŽå°‘æ•°çš„çƒ­é—¨ipå†è¿›è¡Œuint32_tè®¡æ•°
ï¼ˆåŒæ—¶è€ƒè™‘äº†ipåœ°å€çš„ç¨€ç–æ€§ä»¥åŠå†…å­˜çš„é™åˆ¶ï¼Œå¹¶ä¸”å¯¹å†…å­˜çš„ä¼˜é›…ä½¿ç”¨ï¼Œå¯ä»¥æé«˜ç¼“å­˜çš„å‘½ä¸­çŽ‡ï¼Œæé«˜æ•ˆçŽ‡ï¼‰&lt;/li>
&lt;li>ä½¿ç”¨ç²¾ç¡®è®¡æ•°ï¼ŒèŽ·å¾—æ­£ç¡®è§£&lt;/li>
&lt;/ol>
&lt;h3 id="ä»£ç ç•™ç»™æˆ‘ä»¬çš„æ€è€ƒé¢˜">ä»£ç ç•™ç»™æˆ‘ä»¬çš„æ€è€ƒé¢˜ &lt;a href="#%e4%bb%a3%e7%a0%81%e7%95%99%e7%bb%99%e6%88%91%e4%bb%ac%e7%9a%84%e6%80%9d%e8%80%83%e9%a2%98" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;blockquote>
&lt;p>ç»ƒä¹ ï¼šæ‰¾å‡º worse caseï¼Œè®©è¿è¡Œæ—¶é—´é•¿è¾¾å‡ åˆ†é’Ÿç”šè‡³åå‡ åˆ†é’Ÿï¼Œç„¶åŽæå‡ºå¹¶å®žæ–½æ”¹è¿›æŽªæ–½&lt;/p>&lt;/blockquote>
&lt;p>ç”±äºŽæˆ‘ä»¬æ‹¿ä¸å‡ºreal worldä¸­çš„dataï¼Œæ‰€ä»¥å¾ˆå¤šåˆ†æžéƒ½æ˜¯çº¸ä¸Šè°ˆå…µï¼Œä¸è¿‡ä¸€åˆ‡çš„å®žè·µä¹Ÿéƒ½æ˜¯ä»Žçº¸ä¸Šè°ˆå…µå¼€å§‹ã€‚&lt;/p>
&lt;ul>
&lt;li>é¢˜ç›®ä¸­çš„&lt;code>std::vector&amp;lt;IPcount&amp;gt; overflows_;&lt;/code>ä½¿ç”¨&lt;code>unordered_map&lt;/code>æ›´å¥½ï¼Œå‡å°‘æŸ¥æ‰¾çš„æ—¶é—´ï¼ˆO(logN) =&amp;gt; O(1)ï¼‰ï¼Œå¹¶ä¸”å‡å°‘æ’å…¥çš„æ—¶é—´ï¼ˆO(N) =&amp;gt; O(1)ï¼‰&lt;/li>
&lt;li>&lt;code>std::vector&amp;lt;uint8_t&amp;gt; counts_;&lt;/code>å¯ä»¥åœ¨é€‚å½“çš„æƒ…å†µè°ƒæ•´ä¸º&lt;code>uint16_t&lt;/code>ï¼Œå¯ä»¥å‡å°‘å“ˆå¸ŒèŠ‚ç‚¹ç”Ÿæˆå¯¹äºŽå†…å­˜çš„é¢‘ç¹ç”³è¯·ã€‚&lt;/li>
&lt;/ul>
&lt;h2 id="åŽè®°">åŽè®° &lt;a href="#%e5%90%8e%e8%ae%b0" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;p>é¢˜ç›®ä¸­çš„åˆ†æžæœ‰å¾ˆå¤šæ˜¯â€œæ‰§æžœç´¢å› â€çš„æˆæžœï¼Œæ¯•ç«ŸåæŽ¨æ¯”æ­£æŽ¨è¦æ›´å®¹æ˜“ä¸€ç‚¹ã€‚&lt;/p>
&lt;p>æƒ³è¦ä»ŽåæŽ¨æå‡ä¸ºæ­£æŽ¨ï¼ŒçœŸçš„éœ€è¦è‰¯å¥½çš„å‘æ•£æ€ç»´ä»¥åŠæ•é”çš„æ´žå¯ŸåŠ›ã€‚å› ä¸ºé¢è¯•æ—¶ï¼Œæ²¡äººä¼šæŠŠé¢˜ç›®å¸®ä½ å†™åœ¨çº¸ä¸Šã€‚&lt;/p>
&lt;p>è¯è¯´ï¼Œæˆ‘æ‰çŸ¥é“ipv6æ˜¯128ä½çš„ã€‚é‚£ä¹ˆå½“é¢˜ç›®ä¸­çš„ipåœ°å€ä¸ºipv6æ—¶ï¼Œåˆä¼šæœ‰ä»€ä¹ˆå¥½æ–¹æ³•å‘¢ï¼Ÿ&lt;/p>
&lt;h2 id="å‚è€ƒé“¾æŽ¥">å‚è€ƒé“¾æŽ¥ &lt;a href="#%e5%8f%82%e8%80%83%e9%93%be%e6%8e%a5" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;ul>
&lt;li>&lt;a href="http://www.infoq.com/cn/news/2010/05/BEDL">ä»‹ç»ï¼šä¸šåŠ¡å®žä½“å’Œä¸šåŠ¡å®žä½“å®šä¹‰è¯­è¨€&lt;/a>&lt;/li>
&lt;/ul></description></item></channel></rss>