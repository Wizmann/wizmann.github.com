<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Defer on Maerlyn's Rainbow</title><link>https://wizmann.top/tags/defer/</link><description>Recent content in Defer on Maerlyn's Rainbow</description><generator>Hugo -- gohugo.io</generator><language>zh-CN</language><lastBuildDate>Sat, 10 Dec 2016 11:34:38 +0000</lastBuildDate><atom:link href="https://wizmann.top/tags/defer/index.xml" rel="self" type="application/rss+xml"/><item><title>Twisted Defer and DeferredQueue</title><link>https://wizmann.top/posts/twisted-defer-and-deferredqueue/</link><pubDate>Sat, 10 Dec 2016 11:34:38 +0000</pubDate><guid>https://wizmann.top/posts/twisted-defer-and-deferredqueue/</guid><description>&lt;h2 id="å†™åœ¨æœ€å‰é¢">å†™åœ¨æœ€å‰é¢ &lt;a href="#%e5%86%99%e5%9c%a8%e6%9c%80%e5%89%8d%e9%9d%a2" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;p>è¿™ç¯‡æ–‡ç« æœ¬æ¥æ˜¯æƒ³ç”¨è‹±æ–‡å†™çš„ï¼Œä½†æ˜¯æœ€è¿‘è‹±æ–‡æ°´å¹³ä¸‹é™çš„å’Œç‹—ä¸€æ ·ã€‚è¿˜æ˜¯æ€‚ä¸€æ³¢å§ã€‚&lt;/p>
&lt;h2 id="å†™åœ¨å‰é¢">å†™åœ¨å‰é¢ &lt;a href="#%e5%86%99%e5%9c%a8%e5%89%8d%e9%9d%a2" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;p>æœ€è¿‘åœ¨ç”¨Twistedåº“å†™ä¸€ä¸ªè¯¡å¼‚çš„é¡¹ç›®ï¼Œå…·ä½“å†…å®¹æš‚ä¸”ä¸åœ¨è¿™é‡Œè®¨è®ºã€‚åœ¨å†™çš„è¿‡ç¨‹ä¸­ï¼Œè¢«Twistedé‡Œé¢çš„ä¸€ä¸ªé‡è¦æ¦‚å¿µ â€”â€” deferï¼ŒæŠ˜è…¾çš„ä¸è¡Œã€‚æœ€ç»ˆé€šè¿‡é˜…è¯»twistedçš„éƒ¨åˆ†æºç ï¼Œä»¥åŠä¸Žä»£ç åšæ–—äº‰çš„ä¸°å¯Œç»éªŒï¼Œæœ€ç»ˆç®—æ˜¯è§£å†³äº†é—®é¢˜ã€‚&lt;/p>
&lt;p>æœ¬æ–‡ç®—æ˜¯ä½¿ç”¨twistedå¼€å‘è¸©å‘çš„ä¸€ä¸ªå°å°æ€»ç»“ï¼Œå¦‚æžœä¸€åˆ‡é¡ºåˆ©ï¼ŒåŽé¢ä¼šæœ‰å¤§èœã€‚ï¼šï¼‰&lt;/p>
&lt;h2 id="twistedä»‹ç»">Twistedä»‹ç» &lt;a href="#twisted%e4%bb%8b%e7%bb%8d" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;blockquote>
&lt;p>Twisted is an event-driven networking engine written in Python.&lt;/p>&lt;/blockquote>
&lt;p>Twistedæ˜¯ä¸€ä¸ªåŸºäºŽäº‹ä»¶é©±åŠ¨çš„ç½‘ç»œæ¡†æž¶ã€‚é‚£ä¹ˆä»€ä¹ˆæ˜¯â€œäº‹ä»¶é©±åŠ¨â€å‘¢ï¼Ÿ&lt;/p>
&lt;p>äº‹ä»¶é©±åŠ¨æŒ‡çš„æ˜¯å°†äº‹ä»¶ä¸Žäº‹ä»¶å›žè°ƒç»‘å®šèµ·æ¥ï¼Œåœ¨ç¨‹åºè¿è¡Œæ—¶æ ¹æ®å®žæ—¶çš„äº‹ä»¶è§¦å‘ç›¸åº”çš„å“åº”çš„ä¸€ç§æœºåˆ¶ã€‚&lt;/p>
&lt;p>ä¾‹å¦‚select/poll/epollè¿™äº›IOå¤ç”¨å‡½æ•°ï¼Œåœ¨æ–‡ä»¶æè¿°ç¬¦ï¼ˆfdï¼‰å¯è¯»/å¯å†™/å‡ºé”™æ—¶ï¼Œä¼šç«‹å³è¿”å›žï¼Œç”±ç›¸åº”çš„å¤„ç†å‡½æ•°æ¥å¯¹æ–°äº‹ä»¶è¿›è¡Œå¤„ç†ã€‚äº‹å®žä¸Šï¼Œtwistedçš„äº‹ä»¶é©±åŠ¨åŠŸèƒ½ï¼Œæ­£æ˜¯ç”±è¿™äº›IOå¤ç”¨å‡½æ•°æä¾›çš„ã€‚&lt;/p>
&lt;p>ä½†ä¸ŽIOå¤ç”¨å‡½æ•°ä¸åŒçš„æ˜¯ï¼Œtwistedä¸­çš„äº‹ä»¶å¯ä»¥æ˜¯â€œæ›´é«˜å±‚æ¬¡çš„äº‹ä»¶â€ï¼Œå³å¯¹ç½‘ç»œçš„è¯»/å†™/é”™ç­‰åŸºç¡€äº‹ä»¶è¿›è¡Œæ›´è¿›ä¸€æ­¥çš„å°è£…ã€‚&lt;/p>
&lt;p>è¿™é‡Œæˆ‘ä»¬ä»¥&lt;code>LineReceiver&lt;/code>ä¸ºä¾‹ï¼ˆ&lt;a href="http://twistedmatrix.com/documents/current/api/twisted.protocols.basic.LineReceiver.html">APIæ–‡æ¡£&lt;/a>ï¼‰ã€‚&lt;code>LineReceiver&lt;/code>æ˜¯å¯¹ä¼ è¾“å±‚åè®®çš„äºŒæ¬¡å°è£…ï¼Œå½“æˆ‘ä»¬è¯»å®Œä¸€æ•´è¡Œä¹‹åŽï¼Œå°±è§¦å‘&lt;code>lineReceived&lt;/code>äº‹ä»¶ï¼Œå¯¹èŽ·å–çš„æ•°æ®è¿›è¡Œå¤„ç†ã€‚&lt;/p>
&lt;p>è¿™ç§å°è£…ï¼Œå°†å¼€å‘è€…ä¸Žåº•å±‚çš„ç½‘ç»œäº¤äº’éš”ç¦»å¼€æ¥ã€‚åˆ©ç”¨è¿™äº›â€œé«˜çº§äº‹ä»¶â€ï¼Œå¼€å‘è€…å¯ä»¥å°†æ›´å¤šçš„ç²¾åŠ›æ”¾åˆ°ç¨‹åºæœ¬èº«é€»è¾‘çš„å¼€å‘ä¹‹ä¸­ã€‚&lt;/p>
&lt;p>è¿˜æœ‰ä¸€ç‚¹ï¼Œæ­£å¦‚Pythonè¯­è¨€æœ¬èº«çš„ä¸€å¤§ä¼˜ç‚¹ä¸€æ ·ï¼ŒTwistedçŽ°æˆçš„åè®®å®žçŽ°çš„éžå¸¸ä¸°å¯Œï¼ŒåŒæ—¶åœ¨å·¥ä¸šç•Œä¹Ÿè¾ƒä¸ºå¹¿æ³›çš„ä½¿ç”¨ã€‚è™½ç„¶èµ¶ä¸ä¸Šgolangè¿™ç§â€œæ˜Žæ˜Ÿè¯­è¨€â€ï¼Œä½†æ˜¯ä¹Ÿè¿˜æ˜¯å¯ä»¥â€œè‡ªæˆä¸€æ´¾â€ï¼Œæžç‚¹äº‹æƒ…ã€‚&lt;/p>
&lt;h2 id="deferä¸Žå›žè°ƒ">Deferä¸Žå›žè°ƒ &lt;a href="#defer%e4%b8%8e%e5%9b%9e%e8%b0%83" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;p>Twistedä½¿ç”¨Deferæ¥ç®¡ç†callbacké“¾ï¼Œå¦‚æžœä½ å†™è¿‡jsï¼Œå°±å¯èƒ½å¯¹è¢«å›žè°ƒé“¾ï¼ˆcallback chainsï¼‰æ‰€æ”¯é…çš„ææƒ§è®°å¿†æ·±åˆ»ã€‚å½“ç„¶ï¼ŒTwistedçš„deferä¹Ÿå¹¶æ²¡æœ‰å¥½åˆ°å“ªé‡ŒåŽ»ã€‚ï¼ˆè›¤ï¼ï¼‰&lt;/p>
&lt;p>Seriouslyï¼Œdeferå…è®¸æˆ‘ä»¬ä½¿ç”¨ä¸€èˆ¬çš„é¡ºåºåž‹ç¼–ç¨‹æ¨¡åž‹æ¥ç¼–å†™å›žè°ƒä»£ç ã€‚æˆ‘ä»¬åªéœ€è¦æŠŠå‡½æ•°æŒ‰ç…§é¡ºåºæ³¨å†Œåˆ°deferå½“ä¸­ï¼Œå°±å¯ä»¥å®Œæ•´çš„å®žçŽ°ä¸€ä¸ªå›žè°ƒé“¾äº†ã€‚&lt;/p>
&lt;p>&lt;img src="https://github.com/Wizmann/assets/raw/master/wizmann-pic/public/16-12-9/90670835.jpg" alt="">&lt;/p>
&lt;p>æœ¬æ–‡ä¸ä¼šå¯¹deferè¿›è¡Œè¿‡å¤šè®²è§£ï¼Œå¦‚æžœæƒ³è¦äº†è§£æ›´å¤šçš„è¯ï¼Œå¯ä»¥å‚è€ƒtwistedçš„&lt;a href="https://twistedmatrix.com/documents/current/core/howto/defer.html">å®˜æ–¹æ–‡æ¡£&lt;/a>ã€‚&lt;/p>
&lt;p>deferåšä¸ºä¸€ä¸ªå›žè°ƒé“¾çš„æŠ½è±¡ï¼Œæœ‰ä¸€ä¸ªéžå¸¸é‡è¦çš„æ€§è´¨ï¼Œå°±æ˜¯ä½ ä¸fireå®ƒï¼Œå®ƒæ˜¯ä¸ä¼šè°ƒç”¨å®ƒçš„callbacksçš„ã€‚æ­£åƒä¿—è¯è¯´çš„ä¸€æ ·ï¼š&lt;/p>
&lt;blockquote>
&lt;p>äº‹ä¸è¯´ä¸çŸ¥ï¼Œæœ¨ä¸é’»ä¸é€ï¼Œç ‚é”…ä¸æ‰“ä¸€è¾ˆå­ä¸æ¼&lt;/p>&lt;/blockquote>
&lt;p>åˆæœ‰äººè¯´è¿‡ï¼ˆå¼‚æ­¥å‘å¡ï¼‰ï¼š&lt;/p>
&lt;blockquote>
&lt;p>A: There&amp;rsquo;s something between us. &lt;br>
B: What is it? &lt;br>
A: An unfired defer.&lt;/p>&lt;/blockquote>
&lt;p>å¦‚æžœä½ æƒ³æ¿€æ´»deferä¸­çš„callbacksï¼Œå°±éœ€è¦æ‰‹åŠ¨çš„fireå®ƒã€‚é‚£ä¹ˆä»€ä¹ˆæ—¶å€™æ¥fireå®ƒå‘¢ï¼Ÿå½“ç„¶æ˜¯åœ¨éœ€è¦çš„æ—¶å€™å•¦ã€‚&lt;/p>
&lt;h3 id="ä¸€ä¸ªå…¸åž‹çš„deferä½¿ç”¨åœºæ™¯---txmongo">ä¸€ä¸ªå…¸åž‹çš„deferä½¿ç”¨åœºæ™¯ - txmongo &lt;a href="#%e4%b8%80%e4%b8%aa%e5%85%b8%e5%9e%8b%e7%9a%84defer%e4%bd%bf%e7%94%a8%e5%9c%ba%e6%99%af---txmongo" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;p>txmongoæ˜¯ä¸€ä¸ªå¼‚æ­¥çš„mongodb python sdkã€‚è€Œæˆ‘ä»¬å¸¸ç”¨çš„pymongoåº“åˆ™æ˜¯åŒæ­¥çš„ï¼Œæ‰€æœ‰çš„è¯·æ±‚éƒ½è¦åŒæ­¥ç­‰å¾…æ•°æ®åº“è¿”å›žç»“æžœã€‚&lt;/p>
&lt;p>ç”±äºŽæ˜¯å¼‚æ­¥çš„sdkï¼Œæ‰€ä»¥åœ¨åŒä¸€æ—¶é—´ï¼Œtxmongoä¼šåŒæ—¶æŒæœ‰å¤šä¸ªmongodbè¿žæŽ¥ï¼ˆè¿žæŽ¥æ± ï¼‰ã€‚å¹¶ä¸”ç”±äºŽæˆ‘ä»¬ä¸èƒ½é¢„æµ‹mongodbçš„å“åº”æ—¶é—´ï¼Œæ‰€ä»¥éœ€è¦åœ¨æ”¶åˆ°mongodbå“åº”åŽï¼Œå¯åŠ¨ç›¸åº”çš„å›žè°ƒå‡½æ•°ï¼Œä»¥è§¦å‘æ›´é«˜çº§åˆ«çš„æ¶ˆæ¯äº‹ä»¶ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-python" data-lang="python">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># txmongo/protocol.py#L368&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">def&lt;/span> &lt;span style="color:#a6e22e">handle_REPLY&lt;/span>(self, request):
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> request&lt;span style="color:#f92672">.&lt;/span>response_to &lt;span style="color:#f92672">in&lt;/span> self&lt;span style="color:#f92672">.&lt;/span>__deferreds:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> df &lt;span style="color:#f92672">=&lt;/span> self&lt;span style="color:#f92672">.&lt;/span>__deferreds&lt;span style="color:#f92672">.&lt;/span>pop(request&lt;span style="color:#f92672">.&lt;/span>response_to)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> request&lt;span style="color:#f92672">.&lt;/span>response_flags &lt;span style="color:#f92672">&amp;amp;&lt;/span> REPLY_QUERY_FAILURE:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># some error handling code&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">else&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> df&lt;span style="color:#f92672">.&lt;/span>callback(request)
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æˆ‘ä»¬ä»Žè¿™æ®µä»£ç ä¸­çœ‹å‡ºï¼Œå½“txmongoæ”¶åˆ°å“åº”åŽï¼Œä¼šå…ˆä»Ž&lt;code>self.__deferreds&lt;/code>å­—å…¸ä¸­å–å‡ºç›¸åº”çš„deferï¼Œä¹‹åŽä½¿ç”¨&lt;code>request&lt;/code>åšä¸ºå‚æ•°ï¼Œå¯åŠ¨deferä¸­çš„callbacksï¼Œå°†æŸ¥åˆ°çš„æ•°æ®è¿”å›žç»™è°ƒç”¨è€…ã€‚&lt;/p>
&lt;h3 id="æ–°æ‰‹ä¼šé‡åˆ°çš„deferå‘--æµ‹è¯•">æ–°æ‰‹ä¼šé‡åˆ°çš„deferå‘ â€”â€” æµ‹è¯• &lt;a href="#%e6%96%b0%e6%89%8b%e4%bc%9a%e9%81%87%e5%88%b0%e7%9a%84defer%e5%9d%91--%e6%b5%8b%e8%af%95" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;p>åšä¸ºä¸€ä¸ªé©¬ä¸Šå°±è¦æ­¥å…¥ä¸­å¹´çš„ç¨‹åºå‘˜ï¼Œæˆ‘æœ€å¤§çš„ä¸€ä¸ªä¼˜ç‚¹å°±æ˜¯ä¸ç›¸ä¿¡è‡ªå·±ï¼ˆæ±—ï¼‰ã€‚æ‰€ä»¥åœ¨å¼€å‘æ—¶ä¼šåŠæ—¶å†™å•å…ƒæµ‹è¯•æ¥å°½å¯èƒ½ä¿è¯ä»£ç çš„æ­£ç¡®æ€§ã€‚äºŽæ˜¯åœ¨å¼€å‘çš„å¾ˆæ—©å°±è¸©åˆ°äº†deferçš„å‘ï¼ŒåŒ…æ‹¬ï¼š&lt;/p>
&lt;ol>
&lt;li>æµ‹è¯•hangä½&lt;/li>
&lt;li>æµ‹è¯•é€šè¿‡ï¼Œä½†æ˜¯æŠ¥é”™&amp;quot;reactor was unclean&amp;quot;&lt;/li>
&lt;li>ç”±äºŽå›žè°ƒæ²¡æœ‰æ‰§è¡Œï¼Œæµ‹è¯•æŒ‚æŽ‰&lt;/li>
&lt;/ol>
&lt;p>å‘1æ¯”è¾ƒå¥½è§£å†³ï¼Œdeferæ²¡æœ‰callbackï¼Œhangä½äº†åªèƒ½æ€ªè‡ªå·±ã€‚ä¸è¿‡æŸ¥å“ªé‡Œhangä½äº†ä¼šæ¯”è¾ƒéº»çƒ¦ï¼Œæœ€ç›´æŽ¥çš„æ–¹æ³•æ˜¯å¤šæ‰“logï¼Œä»Žlogé‡Œå¾ˆå®¹æ˜“å°±çŸ¥é“å“ªé‡Œæœ‰é—®é¢˜ã€‚&lt;/p>
&lt;p>å‘2å’Œå‘3éƒ½å±žäºŽæˆ‘ä»¬ä½¿ç”¨deferçš„å§¿åŠ¿ä¸å¯¹ã€‚deferæ˜¯â€œå»¶æ—¶â€çš„ï¼Œæˆ‘ä»¬ä¸èƒ½åƒè°ƒç”¨å‡½æ•°ä¸€æ ·çš„ç›´æŽ¥è°ƒç”¨ï¼Œæµ‹è¯•ä»£ç éœ€è¦deferæ‰§è¡Œå®Œæœ€åŽä¸€ä¸ªcallbackå‡½æ•°åŽå†ç»§ç»­æ‰§è¡Œã€‚é‚£ä¹ˆæˆ‘ä»¬éœ€è¦æŠŠæµ‹è¯•ä»£ç ä¹Ÿå†™æˆcallbacksï¼Œç„¶åŽé™„åœ¨éœ€è¦æµ‹è¯•çš„deferåŽé¢å—ï¼Ÿ&lt;/p>
&lt;p>ç­”æ¡ˆæ˜¯å¦å®šçš„ï¼Œtwistedä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ä¸ªç¥žå¥‡çš„å·¥å…·&lt;code>@defer.inlineCallbacks&lt;/code>ã€‚è¿™ä¸ªè£…é¥°å™¨å¯ä»¥ç”¨äºŽå¼€å‘çŽ¯å¢ƒä¸Žæµ‹è¯•çŽ¯å¢ƒã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨yieldç­‰å¾…deferæ‰§è¡Œå®Œæˆï¼Œå¹¶ä¸”å¯ä»¥èŽ·å¾—deferçš„è¿”å›žå€¼ã€‚è¿™ç±»ä¼¼äºŽC#çš„async/awaitè¯­æ³•ï¼Œä½¿ç”¨èµ·æ¥éžå¸¸æ–¹ä¾¿ã€‚&lt;/p>
&lt;p>æ‰€ä»¥åœ¨æˆ‘ä»¬çš„æµ‹è¯•å½“ä¸­å¦‚æžœä½¿ç”¨äº†deferï¼Œå°±éœ€è¦å°†æµ‹è¯•caseä½¿ç”¨&lt;code>inlineCallbacks&lt;/code>è£…é¥°èµ·æ¥ï¼Œåœ¨ç­‰å¾…deferæ—¶ï¼Œéœ€è¦ä½¿ç”¨yieldè¯­æ³•ï¼Œç­‰å¾…å¼‚æ­¥ä»£ç çš„æ‰§è¡Œã€‚åœ¨caseçš„æœ€åŽï¼Œå°†ä¸éœ€è¦çš„defer cancelæŽ‰å³å¯ã€‚&lt;/p>
&lt;h2 id="deferredqueueä¸Žå¾ªçŽ¯">DeferredQueueä¸Žå¾ªçŽ¯ &lt;a href="#deferredqueue%e4%b8%8e%e5%be%aa%e7%8e%af" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;p>Queueçš„ä¸€ä¸ªé‡è¦ç”¨æ³•å°±æ˜¯å¾ªçŽ¯ã€‚åŒ…æ‹¬çº¿ç¨‹/è¿›ç¨‹é€šä¿¡çš„Queueï¼ŒBFSä¸­ä½¿ç”¨çš„Queueï¼Œéƒ½æ˜¯éœ€è¦å¾ªçŽ¯è¯»å–æ•°æ®ã€‚&lt;/p>
&lt;p>DeferredQueueæ˜¯Twistedä¸­é€šä¿¡çš„ä¸€ä¸ªé‡è¦æ•°æ®ç»“æž„ï¼Œå…¶ä½¿ç”¨æ–¹æ³•å’Œä¸€èˆ¬çš„Queueä»Žé€»è¾‘ä¸Šæ˜¯ä¸€æ ·çš„ï¼ŒæŽ¥å£ä¹Ÿåªæœ‰ä¸¤ä¸ªï¼š&lt;code>put&lt;/code>å’Œ&lt;code>get&lt;/code>ã€‚&lt;/p>
&lt;p>DeferredQueueä¹‹æ‰€ä»¥æœ‰ä¸€ä¸ªDeferredå‰è¾ï¼Œæ˜¯å› ä¸ºå®ƒçš„getå‡½æ•°è¿”å›žçš„æ˜¯ä¸€ä¸ªdeferã€‚æˆ‘ä»¬å¯ä»¥åœ¨è¿™ä¸ªdeferä¸Šç»‘å®šcallbacksï¼Œå³æœ‰æ•°æ®å¯è¯»æ—¶ï¼Œè§¦å‘ç›¸åº”çš„å›žè°ƒå‡½æ•°ã€‚&lt;/p>
&lt;p>æ‰€ä»¥æˆ‘ä»¬å¾ˆå®¹æ˜“å°±æŠŠä»£ç å†™æˆäº†è¿™æ ·ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-python" data-lang="python">&lt;span style="display:flex;">&lt;span>q &lt;span style="color:#f92672">=&lt;/span> defer&lt;span style="color:#f92672">.&lt;/span>DeferredQueue()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">def&lt;/span> &lt;span style="color:#a6e22e">get_and_print&lt;/span>(item):
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> print item
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> q&lt;span style="color:#f92672">.&lt;/span>get()&lt;span style="color:#f92672">.&lt;/span>addCallback(get_and_print)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>q&lt;span style="color:#f92672">.&lt;/span>get()&lt;span style="color:#f92672">.&lt;/span>addCallback(get_and_print)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">for&lt;/span> i &lt;span style="color:#f92672">in&lt;/span> xrange(&lt;span style="color:#ae81ff">100&lt;/span>):
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> q&lt;span style="color:#f92672">.&lt;/span>put(i)
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¸€çœ¼çœ‹ä¸ŠåŽ»ï¼Œè¿™ä¸ªä»£ç æ²¡æœ‰ä»€ä¹ˆé—®é¢˜ï¼Œæˆ‘ä»¬ä¼šå¾ªçŽ¯çš„ä»Žé˜Ÿåˆ—ä¸­èŽ·å–æ•°æ®å¹¶æ‰“å°ã€‚ä½†å®žé™…ä¸Šï¼Œè¿™æ®µä»£ç æœ‰ä¸€ä¸ªç¥žå¥‡çš„å‘ã€‚&lt;/p>
&lt;p>è¯´ä¸€ä¸‹è¿™ä¸ªå‘æ˜¯æ€Žä¹ˆå‘çŽ°çš„å§ï¼Œæˆ‘æŠŠä»£ç å†™çš„å·®ä¸å¤šä¹‹åŽï¼Œå°±æƒ³è·‘benchmarkæ¥æµ‹æ€§èƒ½ã€‚ç„¶åŽå‘çŽ°CPythonçš„æ€§èƒ½ä¸€èˆ¬ï¼Œå°±æƒ³è¯•è¯•pypyã€‚ç„¶åŽå´æ€Žä¹ˆä¹Ÿå¾—ä¸åˆ°æ­£ç¡®çš„ç»“æžœï¼Œæœ€åŽå‘çŽ°æ˜¯å› ä¸ºDeferredQueueå¼•å‘äº†é€’å½’è¿‡æ·±çš„å¼‚å¸¸ã€‚ä½†æ˜¯ä¸ºä»€ä¹ˆCPythonæ²¡æœ‰è¿™ä¸ªé—®é¢˜å‘¢ã€‚åŽŸå› åœ¨äºŽCPythonçš„é€’å½’æ ˆæ˜¯æŒ‰æ·±åº¦ç®—çš„ï¼Œè€Œpypyçš„é€’å½’æ ˆæ˜¯æŒ‰å¤§å°ç®—çš„ï¼Œä½†æ˜¯è¿™ä¸¤ä¸ªå‚æ•°çš„æ ‡é‡æ˜¯ä¸€æ ·çš„ï¼Œæ‰€ä»¥pypyçš„é€’å½’æ ˆå°±è¿œå°äºŽCPythonçš„ã€‚è¿™æ‰æš´éœ²äº†è¿™ä¸ªé—®é¢˜ã€‚ä¸è¿‡å•çº¯çš„æ‰©æ ˆä¹Ÿæ˜¯ä¸åˆç†çš„ï¼Œå› ä¸ºæˆ‘ä»¬å¾ˆéš¾ä¼°è®¡æžç«¯æƒ…å†µï¼Œå¹¶ä¸”Pythonçš„é€’å½’æ€§èƒ½éžå¸¸å·®ã€‚&lt;/p>
&lt;p>æ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥åŽ»å‚è€ƒ&lt;a href="https://github.com/twisted/twisted/blob/twisted-16.5.0/src/twisted/internet/defer.py#L1600">æºç &lt;/a>ï¼Œè¿™é‡Œå°±ç›´æŽ¥è¯´ç»“è®ºäº†ã€‚å½“é˜Ÿåˆ—ä¸­æœ‰å…ƒç´ æ—¶ï¼Œ&lt;code>q.get().addCallback(get_and_print)&lt;/code>ä¼šç›´æŽ¥è°ƒç”¨&lt;code>get_and_print&lt;/code>å‡½æ•°æœ¬èº«ï¼Œå¦‚æžœé˜Ÿåˆ—ä¸­çš„å…ƒç´ éžå¸¸å¤šï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±æœ‰é€’å½’è¿‡æ·±çš„å±é™©äº†ã€‚&lt;/p>
&lt;p>è§£å†³æ–¹æ¡ˆä¹Ÿå¾ˆç®€å•ï¼Œä¸Žå…¶è®©TwistedæŠŠæˆ‘ä»¬çš„å¾ªçŽ¯å†™æˆé€’å½’ï¼Œè¿˜ä¸å¦‚æˆ‘ä»¬è‡ªå·±å®žçŽ°Queueçš„å¾ªçŽ¯ã€‚è‡³äºŽæ–¹æ³•ï¼Œçœ‹çœ‹DeferredQueueçš„å†…éƒ¨å®žçŽ°å°±æ¸…æ¥šäº†ï¼Œç„¶åŽæˆ‘ä»¬å°±å‘çŽ°äº†å¦å¤–ä¸€ä¸ªå‘ã€‚&lt;/p>
&lt;h2 id="deferredqueueä¸Žæ€§èƒ½">DeferredQueueä¸Žæ€§èƒ½ &lt;a href="#deferredqueue%e4%b8%8e%e6%80%a7%e8%83%bd" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;p>æˆ‘å•¥éƒ½ä¸è¯´ï¼Œå°±è´´ä¸€è¡Œ&lt;a href="https://github.com/twisted/twisted/blob/twisted-16.5.0/src/twisted/internet/defer.py#L1665">ä»£ç &lt;/a>ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-python" data-lang="python">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">return&lt;/span> succeed(self&lt;span style="color:#f92672">.&lt;/span>pending&lt;span style="color:#f92672">.&lt;/span>pop(&lt;span style="color:#ae81ff">0&lt;/span>))
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ‚¨è¿™å°±æ˜¯åœ¨é€—æˆ‘ã€‚&lt;/p>
&lt;p>&lt;img src="https://github.com/Wizmann/assets/raw/master/wizmann-pic/public/16-12-9/36902015.jpg" alt="">&lt;/p>
&lt;p>å†è´´ä¸ªæ€§èƒ½å¯¹æ¯”ï¼Œä½¿ç”¨&lt;code>list.pop(0)&lt;/code>å¼¹å‡º10^5ä¸ªæ•°æ®éœ€è¦2.23sï¼Œè€Œä½¿ç”¨&lt;code>deque.popleft()&lt;/code>åªéœ€è¦0.12sã€‚&lt;/p>
&lt;p>ä¸è¦åŠŸèƒ½å®žçŽ°äº†å°±ä¸ç®¡æ€§èƒ½äº†å˜›åŒå­¦ã€‚&lt;/p></description></item></channel></rss>