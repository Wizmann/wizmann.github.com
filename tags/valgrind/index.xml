<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Valgrind on Maerlyn's Rainbow</title><link>https://wizmann.top/tags/valgrind/</link><description>Recent content in Valgrind on Maerlyn's Rainbow</description><generator>Hugo -- gohugo.io</generator><language>zh-CN</language><lastBuildDate>Sun, 20 Jul 2014 00:18:00 +0000</lastBuildDate><atom:link href="https://wizmann.top/tags/valgrind/index.xml" rel="self" type="application/rss+xml"/><item><title>CPU cacheå¼•å‘çš„æ€§èƒ½è¡€æ¡ˆ</title><link>https://wizmann.top/posts/cpu-cache-miss/</link><pubDate>Sun, 20 Jul 2014 00:18:00 +0000</pubDate><guid>https://wizmann.top/posts/cpu-cache-miss/</guid><description>&lt;p>åœ¨__&lt;a href="http://evol128.is-programmer.com/posts/35453.html">ä¸ºä»€ä¹ˆè½¬ç½®ä¸€ä¸ª512x512çš„çŸ©é˜µï¼Œä¼šæ¯”513x513çš„çŸ©é˜µæ…¢å¾ˆå¤šï¼Ÿ&lt;/a>__ä¸€æ–‡ä¸­ï¼Œä½œè€…å¼•ç”¨äº†ä¸€ä¸ªçŸ©é˜µè½¬ç½®çš„ä¾‹å­ï¼Œæ¥è®²è§£ç”±äºCPU cacheçš„å¤±æ•ˆè€Œå¸¦æ¥çš„æ€§èƒ½æŸå¤±ã€‚&lt;/p>
&lt;p>ä¸Šé¢çš„æ–‡ç« å¯¹é—®é¢˜çš„è§£é‡Šä¸è®¨è®ºéƒ½éå¸¸çš„é€å½»ã€‚æˆ‘çš„è¿™ç¯‡æ–‡ç« åªæ˜¯å¯¹ä¸Šé¢æ–‡ç« çš„ä¸€ç¯‡è¯»åæ„Ÿå’Œå®éªŒæŠ¥å‘Šã€‚å°±é…±ã€‚&lt;/p>
&lt;h2 id="cpu-cache-ä¹‹-ç»„ç›¸è”">CPU cache ä¹‹ ç»„ç›¸è” &lt;a href="#cpu-cache-%e4%b9%8b-%e7%bb%84%e7%9b%b8%e8%81%94" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>&lt;img src="https://github.com/Wizmann/assets/raw/master/wizmann-tk-pic/blog-cpu-cache-2-way-set-assosiate.jpg" alt="ç»„ç›¸è”">&lt;/p>
&lt;p>ç»„ç›¸è”çš„å®ç°å’ŒåŸç†ä¸å¿…å†èµ˜è¿°äº†ã€‚æˆ‘æƒ³è®¨è®ºçš„æ˜¯ï¼Œå¦‚ä½•åœ¨ç¼–ç¨‹ä¸­ä¼˜åŒ–CPUçš„cacheæ€§èƒ½ã€‚&lt;/p>
&lt;h2 id="æŸ¥çœ‹cpuä¿¡æ¯">æŸ¥çœ‹CPUä¿¡æ¯ &lt;a href="#%e6%9f%a5%e7%9c%8bcpu%e4%bf%a1%e6%81%af" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>æˆ‘çš„ç³»ç»Ÿæ˜¯Ubuntu 12.04ï¼ŒCPUæ˜¯i5-3230Mã€‚ï¼ˆå±Œä¸æœº :D)&lt;/p>
&lt;pre tabindex="0">&lt;code>wizmann@Wichmann:~$ ls /sys/devices/system/cpu/cpu0/cache/index0/
coherency_line_size physical_line_partition size
level shared_cpu_list type
number_of_sets shared_cpu_map ways_of_associativity
&lt;/code>&lt;/pre>&lt;p>ä½¿ç”¨catå‘½ä»¤æŸ¥çœ‹æ–‡ä»¶å†…å®¹ï¼Œå¯ä»¥è·å¾—CPU L1 cacheçš„ä¸€äº›ä¿¡æ¯ã€‚&lt;/p>
&lt;table class="table table-striped-white table-bordered">
&lt;thead>
&lt;tr>
&lt;th>Key&lt;/th>
&lt;th>Value&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>&lt;tr>
&lt;td>level&lt;/td>
&lt;td>1&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>size&lt;/td>
&lt;td>32K&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>ways_of_associativity&lt;/td>
&lt;td>8&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>type&lt;/td>
&lt;td>Data&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>number_of_sets&lt;/td>
&lt;td>64&lt;/td>
&lt;/tr>
&lt;/tbody>&lt;/table>
&lt;p>ä»¥ä¸Šå¯çŸ¥ï¼ŒCPU L1 cacheæœ‰64ç»„ï¼Œæ¯ç»„æœ‰8ä¸ªcache lineã€‚æ˜¯&lt;strong>8ä½ç»„ç›¸è”&lt;/strong>çš„Cacheç±»å‹ã€‚&lt;/p>
&lt;h2 id="åˆ†æç¼“å­˜å¤±æ•ˆç‡">åˆ†æç¼“å­˜å¤±æ•ˆç‡ &lt;a href="#%e5%88%86%e6%9e%90%e7%bc%93%e5%ad%98%e5%a4%b1%e6%95%88%e7%8e%87" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>å¯¹äºä»¥ä¸Šé—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥æ‰‹å·¥è®¡ç®—ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ç¨‹åºæ¨¡æ‹ŸCacheçš„å¤±æ•ˆç‡ã€‚&lt;/p>
&lt;p>åŒæ—¶ï¼ŒValgrindä¸ºæˆ‘ä»¬æä¾›äº†cachegrindå·¥å…·æ¥åˆ†æcacheçš„å¤±æ•ˆã€‚&lt;/p>
&lt;pre tabindex="0">&lt;code>wizmann@Wichmann:/tmp$ valgrind --tool=cachegrind --D1=32768,2,16 ./test
==14282== Cachegrind, a cache and branch-prediction profiler
==14282== Copyright (C) 2002-2011, and GNU GPL&amp;#39;d, by Nicholas Nethercote et al.
==14282== Using Valgrind-3.7.0 and LibVEX; rerun with -h for copyright info
==14282== Command: ./test
==14282==
--14282-- warning: L3 cache found, using its data for the LL simulation.
Average for a matrix of 257: 1875==14282==
==14282== I refs: 18,708,198
==14282== I1 misses: 1,404
==14282== LLi misses: 1,355
==14282== I1 miss rate: 0.00%
==14282== LLi miss rate: 0.00%
==14282==
==14282== D refs: 8,936,548 (4,543,346 rd + 4,393,202 wr)
==14282== D1 misses: 1,107,687 (1,086,263 rd + 21,424 wr)
==14282== LLd misses: 10,502 ( 5,179 rd + 5,323 wr)
==14282== D1 miss rate: 12.3% ( 23.9% + 0.4% )
==14282== LLd miss rate: 0.1% ( 0.1% + 0.1% )
==14282==
==14282== LL refs: 1,109,091 (1,087,667 rd + 21,424 wr)
==14282== LL misses: 11,857 ( 6,534 rd + 5,323 wr)
==14282== LL miss rate: 0.0% ( 0.0% + 0.1% )
&lt;/code>&lt;/pre>&lt;p>å…¶ä¸­I1ä»£è¡¨æŒ‡ä»¤1çº§ç¼“å­˜ï¼ŒD1ä»£è¡¨æ•°æ®1çº§ç¼“å­˜ï¼Œè€ŒLLä»£è¡¨äºŒçº§æˆ–ä¸‰çº§ç¼“å­˜ã€‚&lt;/p>
&lt;p>ä¸Šé¢çš„è¾“å‡ºä¹Ÿè®¸è¿‡äºå¤æ‚ï¼Œæˆ‘ä»¬åœ¨ä¸‹é¢åˆ—è¡¨åˆ†æã€‚&lt;/p>
&lt;h3 id="æµ‹è¯•ç¯å¢ƒ">æµ‹è¯•ç¯å¢ƒ &lt;a href="#%e6%b5%8b%e8%af%95%e7%8e%af%e5%a2%83" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;p>åªè®¨è®ºL1çš„æƒ…å†µï¼ŒL1å¤§å°32768 Bytesï¼Œ2è·¯ç»„ç›¸è”ï¼Œæ¯ä¸ªcache lineæœ‰16 Bytesã€‚&lt;/p>
&lt;p>valgrindæµ‹è¯•å‘½ä»¤ä¸ºï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code>wizmann@Wichmann:/tmp$ valgrind --tool=cachegrind --D1=32768,2,16 ./test
&lt;/code>&lt;/pre>&lt;h3 id="æµ‹è¯•ç¨‹åº">æµ‹è¯•ç¨‹åº &lt;a href="#%e6%b5%8b%e8%af%95%e7%a8%8b%e5%ba%8f" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#define SAMPLES 64
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#define MATSIZE 256
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;time.h&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;iostream&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">int&lt;/span> mat[MATSIZE][MATSIZE];
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">transpose&lt;/span>()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">for&lt;/span> ( &lt;span style="color:#66d9ef">int&lt;/span> i &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span> ; i &lt;span style="color:#f92672">&amp;lt;&lt;/span> MATSIZE ; i&lt;span style="color:#f92672">++&lt;/span> )
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">for&lt;/span> ( &lt;span style="color:#66d9ef">int&lt;/span> j &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span> ; j &lt;span style="color:#f92672">&amp;lt;&lt;/span> i ; j&lt;span style="color:#f92672">++&lt;/span> )
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">int&lt;/span> aux &lt;span style="color:#f92672">=&lt;/span> mat[i][j];
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> mat[i][j] &lt;span style="color:#f92672">=&lt;/span> mat[j][i];
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> mat[j][i] &lt;span style="color:#f92672">=&lt;/span> aux;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">int&lt;/span> &lt;span style="color:#a6e22e">main&lt;/span>()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">//initialize matrix
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">for&lt;/span> ( &lt;span style="color:#66d9ef">int&lt;/span> i &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span> ; i &lt;span style="color:#f92672">&amp;lt;&lt;/span> MATSIZE ; i&lt;span style="color:#f92672">++&lt;/span> )
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">for&lt;/span> ( &lt;span style="color:#66d9ef">int&lt;/span> j &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span> ; j &lt;span style="color:#f92672">&amp;lt;&lt;/span> MATSIZE ; j&lt;span style="color:#f92672">++&lt;/span> )
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> mat[i][j] &lt;span style="color:#f92672">=&lt;/span> i&lt;span style="color:#f92672">+&lt;/span>j;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">int&lt;/span> t &lt;span style="color:#f92672">=&lt;/span> clock();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">for&lt;/span> ( &lt;span style="color:#66d9ef">int&lt;/span> i &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span> ; i &lt;span style="color:#f92672">&amp;lt;&lt;/span> SAMPLES ; i&lt;span style="color:#f92672">++&lt;/span> )
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> transpose();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">int&lt;/span> elapsed &lt;span style="color:#f92672">=&lt;/span> clock() &lt;span style="color:#f92672">-&lt;/span> t;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> std&lt;span style="color:#f92672">::&lt;/span>cout &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#e6db74">&amp;#34;Average for a matrix of &amp;#34;&lt;/span> &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> MATSIZE &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#e6db74">&amp;#34;: &amp;#34;&lt;/span> &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> elapsed &lt;span style="color:#f92672">/&lt;/span> SAMPLES;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="æµ‹è¯•ç»“æœ">æµ‹è¯•ç»“æœ &lt;a href="#%e6%b5%8b%e8%af%95%e7%bb%93%e6%9e%9c" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;table class="table table-striped-white table-bordered">
&lt;thead>
&lt;tr>
&lt;th>-&lt;/th>
&lt;th>MATSIZE = 256&lt;/th>
&lt;th>MATSIZE = 256 + 1&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>&lt;tr>
&lt;td>è¿è¡Œæ—¶é—´ (g++ O2) 1024æ¬¡&lt;/td>
&lt;td>78ms&lt;/td>
&lt;td>39ms&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>D1 Miss&lt;/td>
&lt;td>2,621,967&lt;/td>
&lt;td>1,107,687&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>D1 Miss Rate&lt;/td>
&lt;td>29.5%&lt;/td>
&lt;td>12.3%&lt;/td>
&lt;/tr>
&lt;/tbody>&lt;/table>
&lt;p>ç”±æ­¤å¯è§ï¼ŒCacheçš„Miss RateåŸºæœ¬å†³å®šäº†ç¨‹åºçš„è¿è¡Œé€Ÿåº¦ï¼Œè¿è¡Œæ—¶é—´æ¯”ä¾‹å’ŒD1 MISS RATEçš„æ¯”ä¾‹åŸºæœ¬ä¸€è‡´ã€‚&lt;/p>
&lt;ul>
&lt;li>æ³¨ï¼šæœ¬æœºç¯å¢ƒä¸cachegrindå‚æ•°æ˜¯ä¸ä¸€è‡´çš„ï¼Œåœ¨æœ¬æœºä¸Šç”±äºcacheè¾ƒå¤§ï¼Œä¸”é‡‡ç”¨8ä½ç»„ç›¸è”ï¼Œæ‰€ä»¥D1 cache missè¾ƒå°‘ï¼Œå·®å¼‚ä¸»è¦ä½“ç°åœ¨LLd Miss Rateä¸Šã€‚&lt;/li>
&lt;/ul>
&lt;h2 id="å®é™…æ„ä¹‰">å®é™…æ„ä¹‰ &lt;a href="#%e5%ae%9e%e9%99%85%e6%84%8f%e4%b9%89" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>å¦‚æœç¨‹åºå¯¹ä¸€æ®µå†…å­˜è¿›è¡Œé¡ºåºè¯»å–çš„æ—¶å€™ï¼Œä»¥ä¸Šçš„ç¼“å­˜å¤±æ•ˆé—®é¢˜æœ‰å¯èƒ½ä¼šæ˜¾ç°å‡ºæ¥ã€‚ä½†æ˜¯ç¼“å­˜å¤±æ•ˆåªæ˜¯ç¨‹åºæ€§èƒ½é—®é¢˜çš„ä¸€ä¸ªå¯èƒ½çš„åŸå› ï¼Œåº”è¯¥åœ¨å¯¹ç¨‹åºè¿›è¡Œprofileä¹‹åå†åšç»“è®ºã€‚&lt;/p>
&lt;h2 id="å…¶å®ƒprofileå·¥å…·">å…¶å®ƒprofileå·¥å…· &lt;a href="#%e5%85%b6%e5%ae%83profile%e5%b7%a5%e5%85%b7" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>æˆ‘çš„æé—®ï¼š__&lt;a href="http://www.zhihu.com/question/24540567/noti-answers?group_id=564624072">æœ‰æ²¡æœ‰ä»€ä¹ˆæ–¹æ³•å¯ä»¥å¯¹CPU cacheå¤±æ•ˆè¿›è¡Œè®¡æ•°ï¼Ÿ&lt;/a>__ä¸­ï¼Œå„ä½ç­”ä¸»è¿˜æä¾›äº†ä»¥ä¸‹å‡ ç§å·¥å…·ï¼š&lt;/p>
&lt;ul>
&lt;li>perf (linux)&lt;/li>
&lt;li>&lt;a href="http://tiptop.gforge.inria.fr/">Tiptop&lt;/a>&lt;/li>
&lt;li>qemu&lt;/li>
&lt;li>visual studioçš„cpu counter&lt;/li>
&lt;li>intel performance counter monitor&lt;/li>
&lt;li>vtunes&lt;/li>
&lt;/ul>
&lt;p>profileçš„æ–¹æ³•å¾ˆå¤šï¼Œé€‰ä¸€ä¸ªæ˜“ç”¨æ€§ä¸æ­£ç¡®æ€§è¾¾åˆ°å¹³è¡¡å°±å¯ä»¥ã€‚åæ­£æˆ‘æ˜¯å“ªä¸ªä¹Ÿä¸ä¼š_(:Ğ·ã€âˆ )_&lt;/p>
&lt;h2 id="å‚è€ƒé“¾æ¥">å‚è€ƒé“¾æ¥ &lt;a href="#%e5%8f%82%e8%80%83%e9%93%be%e6%8e%a5" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;ul>
&lt;li>&lt;a href="http://yoursunny.com/study/EI209/?topic=cache">cacheæ˜ å°„åŠŸèƒ½ã€å‘½ä¸­ç‡è®¡ç®—&lt;/a>&lt;/li>
&lt;li>&lt;a href="http://blog.focus-linux.net/?p=391">ä½¿ç”¨valgrindæ£€æŸ¥cacheå‘½ä¸­ç‡ï¼Œæé«˜ç¨‹åºæ€§èƒ½&lt;/a>&lt;/li>
&lt;li>&lt;a href="http://valgrind.org/docs/manual/cg-manual.html">Cachegrind: a cache and branch-prediction profiler&lt;/a> ï¼ˆå®˜æ–¹æ–‡æ¡£ï¼‰&lt;/li>
&lt;li>&lt;a href="https://access.redhat.com/documentation/zh-CN/Red_Hat_Enterprise_Linux/6/html/Performance_Tuning_Guide/ch05s03s02.html">ä½¿ç”¨ Cachegrind ç®€è¦æ¦‚è¿°ç¼“å­˜ä½¿ç”¨&lt;/a>&lt;/li>
&lt;li>&lt;a href="http://wwwcdf.pd.infn.it/valgrind/cg_main.html">Cachegrind: a cache-miss profiler&lt;/a>&lt;/li>
&lt;li>&lt;a href="http://www.ibm.com/developerworks/cn/linux/l-cn-perf">Perf &amp;ndash; Linuxä¸‹çš„ç³»ç»Ÿæ€§èƒ½è°ƒä¼˜å·¥å…·ï¼Œç¬¬ 1 éƒ¨åˆ†&lt;/a>&lt;/li>
&lt;li>&lt;a href="http://coolshell.cn/articles/10249.html">7ä¸ªç¤ºä¾‹ç§‘æ™®CPU Cacheï¼ˆæ‰©å±•é˜…è¯»ï¼‰&lt;/a>&lt;/li>
&lt;/ul></description></item></channel></rss>