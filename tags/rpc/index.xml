<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Rpc on Maerlyn's Rainbow</title><link>https://wizmann.top/tags/rpc/</link><description>Recent content in Rpc on Maerlyn's Rainbow</description><generator>Hugo -- gohugo.io</generator><language>zh-CN</language><lastBuildDate>Sun, 23 Oct 2016 15:50:44 +0000</lastBuildDate><atom:link href="https://wizmann.top/tags/rpc/index.xml" rel="self" type="application/rss+xml"/><item><title>æ€»ç»“ - phxrpcä»£ç é˜…è¯»(8)</title><link>https://wizmann.top/posts/phxrpc-8/</link><pubDate>Sun, 23 Oct 2016 15:50:44 +0000</pubDate><guid>https://wizmann.top/posts/phxrpc-8/</guid><description>&lt;h2 id="å†™åœ¨å‰é¢">å†™åœ¨å‰é¢ &lt;a href="#%e5%86%99%e5%9c%a8%e5%89%8d%e9%9d%a2" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>è¿™åº”è¯¥æ˜¯phxrpcä»£ç é˜…è¯»ç³»åˆ—æ­£æ–‡çš„æœ€åä¸€ç¯‡ã€‚é€šè¿‡é˜…è¯»ä»£ç ï¼Œå‘ç°äº†è‡ªå·±åœ¨çŸ¥è¯†ä¸Šçš„è‹¥å¹²ä¸è¶³ã€‚&lt;/p>
&lt;p>ä¸´æ¸Šç¾¡é±¼ï¼Œä¸å¦‚é€€è€Œç»“ç½‘ã€‚æ¥ä¸‹æ¥å¯èƒ½ä¼šåœ¨ç½‘ç»œç¼–ç¨‹æ–¹é¢å†ä¸‹ä¸€ç‚¹å·¥å¤«ã€‚è¯·å¤§å®¶æœŸå¾…ä¸‹ä¸€ä¸ªç³»åˆ—å§ã€‚&lt;/p>
&lt;blockquote>
&lt;p>å…¶å®çœŸæ²¡äººè¯»ï¼Œæˆ‘å°±æ˜¯åœ¨éª—è‡ªå·±ã€‚&lt;/p>&lt;/blockquote>
&lt;h2 id="å…ˆè¡¥å……ä¸€ç‚¹---ä»£ç ç”Ÿæˆ">å…ˆè¡¥å……ä¸€ç‚¹ - ä»£ç ç”Ÿæˆ &lt;a href="#%e5%85%88%e8%a1%a5%e5%85%85%e4%b8%80%e7%82%b9---%e4%bb%a3%e7%a0%81%e7%94%9f%e6%88%90" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>protobufå¹¶ä¸åŒ…å«RPCçš„å®ç°ï¼Œä½†æ˜¯å®ƒå¯ä»¥å£°æ˜rpcã€‚å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯éœ€è¦å®ç°RPCæ¥å£ï¼Œæ¥å®ç°é€šä¿¡ã€‚&lt;/p>
&lt;p>phxrpcä½¿ç”¨protoæ–‡ä»¶æ¥å®šä¹‰æ¥å£ï¼Œç„¶åè§£æå¹¶ä½¿ç”¨ä»£ç æ¨¡æ¿è¿›è¡Œç”Ÿæˆã€‚&lt;/p>
&lt;p>è¿™é‡Œæˆ‘ä»¬ä¸è®¨è®ºä»£ç ç”Ÿæˆçš„ç»†èŠ‚ï¼Œå› ä¸ºpbå®åœ¨å¤ªè¿‡æµè¡Œï¼Œä»£ç ç”Ÿæˆçš„æ–¹æ³•ä¹Ÿæœ‰ä¸å°‘çš„æµæ´¾ã€‚å¹¶ä¸”ç”¨C++æ¥åšä»£ç ç”Ÿæˆï¼ŒçœŸå¿ƒä¸æ˜¯æˆ‘çš„èœã€‚&lt;/p>
&lt;p>æƒ³äº†è§£æ›´å¤šï¼Œå¯ä»¥å‚è€ƒ&lt;a href="http://codemacro.com/2014/08/31/protobuf-rpc/">è¿™ç¯‡åšå®¢&lt;/a>ã€‚&lt;/p>
&lt;h2 id="å·¥ä½œæµç¨‹---å®¢æˆ·ç«¯">å·¥ä½œæµç¨‹ - å®¢æˆ·ç«¯ &lt;a href="#%e5%b7%a5%e4%bd%9c%e6%b5%81%e7%a8%8b---%e5%ae%a2%e6%88%b7%e7%ab%af" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨çš„é€šä¿¡æœ‰å¦‚ä¸‹çš„ç‰¹ç‚¹ï¼š&lt;/p>
&lt;ol>
&lt;li>è¿æ¥å°‘&lt;/li>
&lt;li>è´Ÿè½½å°‘&lt;/li>
&lt;li>é€šä¿¡çš„ä¸»åŠ¨æ–¹&lt;/li>
&lt;/ol>
&lt;p>æ‰€ä»¥ï¼Œæ‰€æœ‰çš„ç½‘ç»œäº¤äº’ç›¸å…³çš„å†…å®¹å¯ä»¥æ‰˜ç®¡ç»™ç½‘ç»œåº“ä¸­çš„åç¨‹ã€‚æ¯ä¸ªåç¨‹ä¸»åŠ¨è¿è¡Œä¸€æ®µæ—¶é—´åï¼Œä¸»åŠ¨æ”¾å¼ƒCPUæ—¶é—´ï¼Œå°†æ§åˆ¶æƒäº¤è¿˜ç»™ä¸»æ§åˆ¶æµçš„epollã€‚&lt;/p>
&lt;p>æ‰€ä»¥åç¨‹ä¸­ä¸èƒ½æœ‰CPUå¯†é›†çš„è¿ç®—ï¼Œå¹¸å¥½é¢å¯¹å¼€å‘è€…ï¼Œphxrpcå¹¶ä¸æš´éœ²å†…éƒ¨å‡½æ•°ï¼Œè€Œæ˜¯å°†CPUå¯†é›†çš„è¿ç®—åˆ†é…ç»™å·¥ä½œçº¿ç¨‹æ¥å®Œæˆã€‚&lt;/p>
&lt;h2 id="å·¥ä½œæµç¨‹---æœåŠ¡ç«¯">å·¥ä½œæµç¨‹ - æœåŠ¡ç«¯ &lt;a href="#%e5%b7%a5%e4%bd%9c%e6%b5%81%e7%a8%8b---%e6%9c%8d%e5%8a%a1%e7%ab%af" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>æœåŠ¡å™¨çš„é€šä¿¡æœ‰ä»¥ä¸‹çš„ç‰¹ç‚¹ï¼š&lt;/p>
&lt;ol>
&lt;li>è¿æ¥å¤š&lt;/li>
&lt;li>è´Ÿè½½å¤š&lt;/li>
&lt;li>é€šä¿¡çš„è¢«åŠ¨æ–¹&lt;/li>
&lt;li>å“åº”æ—¶é—´æ•æ„Ÿ&lt;/li>
&lt;/ol>
&lt;p>è¿™é‡Œè¯´ä¸€ä¸‹å“åº”æ—¶é—´çš„é—®é¢˜ï¼Œå“åº”æ—¶é—´æ˜¯å’Œè´Ÿè½½å¤šå¯¹åº”çš„ã€‚å®¢æˆ·ç«¯ä¸€èˆ¬åªè´Ÿè´£å‘è¯·æ±‚ï¼Œå…¶å“åº”æ—¶é—´å¹¶ä¸åœ¨æ•´ä¸ªç³»ç»Ÿä¸­å ä¸»å¯¼åœ°ä½ï¼Œæ¢å¥è¯è¯´ï¼Œå®¢æˆ·ç«¯å‘è¯·æ±‚æ˜¯å®Œå…¨æœ‰ä¸»åŠ¨æƒçš„ã€‚è€ŒæœåŠ¡ç«¯è´Ÿè´£å“åº”è¯·æ±‚ï¼Œéœ€è¦ç»è¿‡CPUè¿ç®—ï¼Œæˆ–è€…æœ‰ä¸€äº›æœåŠ¡çš„çº§è”æˆ–æ‰‡å‡ºæ“ä½œï¼Œæ‰€ä»¥å“åº”æ—¶é—´æ˜¯ä¸å¯æ§çš„ã€‚&lt;/p>
&lt;p>ç”±ä¸Šé¢æˆ‘ä»¬å¯ä»¥äº†è§£åˆ°ï¼ŒæœåŠ¡å™¨ç«¯è‚¯å®šéœ€è¦ä¸å®¢æˆ·ç«¯ä¸åŒçš„ç­–ç•¥æ¥å¤„ç†è¿æ¥ä¸å“åº”ã€‚&lt;/p>
&lt;p>é¦–å…ˆï¼Œä¸€ä¸ªç‹¬ç«‹çš„çº¿ç¨‹æ¥&lt;strong>åŒæ­¥&lt;/strong>acceptè¯·æ±‚ï¼Œè¿™ä¸ªçº¿ç¨‹å¤§éƒ¨åˆ†çš„æ—¶é—´éƒ½blockåœ¨&lt;code>accept()&lt;/code>é‡Œï¼Œè´Ÿè½½æ¯”è¾ƒä½ã€‚&lt;/p>
&lt;p>åœ¨acceptåˆ°fdåï¼Œå°†å…¶å‹å…¥åˆ°è°ƒåº¦å™¨ä¸­ã€‚ä¹‹åfdä¼šhangåœ¨IOå¾ªç¯ä¸Šï¼Œç›´åˆ°æœ‰è¯·æ±‚åˆ°æ¥ã€‚ä¸æ­¤åŒæ—¶ï¼Œåç¨‹ä¼šè°ƒåº¦å…¶å®ƒçš„fdã€‚&lt;/p>
&lt;p>è¯·æ±‚åˆ°æ¥åï¼ŒIOçº¿ç¨‹ä¼šæŠŠè¯·æ±‚åŠ å…¥é˜Ÿåˆ—ä¸­ï¼ŒæŠŠè‡ªå·±ä»epollè°ƒåº¦ä¸­åˆ é™¤ã€‚ä¹‹åå°±å¼€å§‹ç¡è§‰è§‰ã€‚ç¡é†’äº†ä¹‹åï¼Œå‘ç°å“åº”æ²¡åˆ°ç¢—é‡Œæ¥ï¼Œå°±shutdownè¿æ¥ã€‚(æˆ‘è§‰å¾—è¿™é‡Œåº”è¯¥åŠ å…¥é‡è¯•ï¼Œä¾‹å¦‚ä¸‰æ¬¡å¤±è´¥å†æ–­çº¿)&lt;/p>
&lt;p>å¦‚æœå“åº”æ¥äº†ï¼Œå…ˆä¼šè°ƒç”¨ä¸€ä¸ªæ¿€æ´»fdçš„æ“ä½œï¼Œå°†å“åº”æ”¾åˆ°å°è£…fdçš„ç»“æ„ä½“ä¸­ï¼Œå†å°†è‡ªå·±æ”¾å›åˆ°epollè°ƒåº¦ï¼Œæœ€åé¡ºæ‰‹ç»™epollå‘ä¸€ä¸ªä¿¡å·ã€‚å½“fdå¯å†™æ—¶ï¼Œå†æŠŠå“åº”è¿”å›ç»™å®¢æˆ·ç«¯ã€‚&lt;/p>
&lt;p>ç”±äºphxrpcä½¿ç”¨çš„é€šä¿¡åè®®æ˜¯HTTPï¼Œæ‰€ä»¥ä¸éœ€è¦è€ƒè™‘åˆ†åŒ…çš„é—®é¢˜ã€‚&lt;/p>
&lt;h2 id="å¯èƒ½çš„æ”¹è¿›">å¯èƒ½çš„æ”¹è¿› &lt;a href="#%e5%8f%af%e8%83%bd%e7%9a%84%e6%94%b9%e8%bf%9b" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;h3 id="è°ƒåº¦å™¨çš„è¶…æ—¶">è°ƒåº¦å™¨çš„è¶…æ—¶ &lt;a href="#%e8%b0%83%e5%ba%a6%e5%99%a8%e7%9a%84%e8%b6%85%e6%97%b6" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">int&lt;/span> nfds &lt;span style="color:#f92672">=&lt;/span> epoll_wait(epoll_fd_, events, max_task_, &lt;span style="color:#ae81ff">4&lt;/span>);
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™æ®µè°ƒåº¦å™¨ä¸­çš„ä»£ç ï¼Œç”Ÿç”Ÿçš„æŠŠIOå¤ç”¨æ¨¡å‹æ”¹æˆäº†è½®è¯¢ã€‚çŒœæµ‹è¿™æ˜¯ä¸ºäº†ç…§é¡¾è¶…æ—¶å®šæ—¶å™¨ï¼Œä½†å®é™…ä¸Šè¿™ä¸ªå¹¶æ— å¿…è¦ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨&lt;code>timerfd&lt;/code>å’Œ&lt;code>eventfd&lt;/code>æ¥å–ä»£å®šæ—¶å™¨ã€‚ä½†æ˜¯è¿™åªæ˜¯ä¸€ç§çŒœæµ‹ï¼Œè¿™ç§å†™æ³•å¯èƒ½ä¹Ÿæ˜¯æœ‰æ€§èƒ½ä¸Šçš„è€ƒè™‘å§ã€‚&lt;/p>
&lt;h3 id="ä»£ç é£æ ¼">ä»£ç é£æ ¼ &lt;a href="#%e4%bb%a3%e7%a0%81%e9%a3%8e%e6%a0%bc" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;p>ä»£ç é£æ ¼å¯èƒ½æ˜¯ä¸€ä¸ªæ¯”è¾ƒæ³›çš„é—®é¢˜ï¼Œä½†æ˜¯phxrpcçš„ä»£ç æˆ‘èƒ½æ˜æ˜¾çš„æ„Ÿè§‰åˆ°ç¼–ç é£æ ¼çš„ä¸åŒã€‚ä»¥åŠå…ƒç´ å±‚æ¬¡ä¸æ˜æœ—ï¼Œä¸Šä¸‹çº§æ¨¡å—ç›¸äº’è€¦åˆçš„æƒ…å†µã€‚&lt;/p>
&lt;h3 id="æ²¡æœ‰æµ‹è¯•æ²¡æœ‰æµ‹è¯•æ²¡æœ‰æµ‹è¯•">æ²¡æœ‰æµ‹è¯•ï¼æ²¡æœ‰æµ‹è¯•ï¼æ²¡æœ‰æµ‹è¯•ï¼ &lt;a href="#%e6%b2%a1%e6%9c%89%e6%b5%8b%e8%af%95%e6%b2%a1%e6%9c%89%e6%b5%8b%e8%af%95%e6%b2%a1%e6%9c%89%e6%b5%8b%e8%af%95" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;p>å› ä¸ºphxrpcæ²¡æœ‰æµ‹è¯•ä»£ç ï¼Œæ‰€ä»¥æˆ‘ä¸¥é‡æ€€ç–‘è¿™å°±æ˜¯ä¸€ä¸ªç©ç¥¨çš„é¡¹ç›®ï¼Œæ²¡æœ‰ï¼ˆæˆ–æš‚æ—¶æ²¡æœ‰ï¼‰åœ¨ç”Ÿäº§ç¯å¢ƒä¸Šè¿è¡Œã€‚&lt;/p>
&lt;p>å¦‚æœæœ‰å¯èƒ½çš„è¯ï¼Œè¯·åŠ ä¸Šæ€§èƒ½æµ‹è¯•ï¼è¯·åŠ ä¸ŠåŠŸèƒ½æµ‹è¯•ï¼è¯·åŠ ä¸Šæ€§åŠŸèƒ½æµ‹è¯•ï¼&lt;/p>
&lt;h2 id="å†™åœ¨åé¢">å†™åœ¨åé¢ &lt;a href="#%e5%86%99%e5%9c%a8%e5%90%8e%e9%9d%a2" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>æ—¶é—´ä»“ä¿ƒï¼Œæ°´å¹³æœ‰é™ã€‚å†™ç‚¹ä¸œè¥¿ï¼Œæ–¹ä¾¿å¤§å®¶å­¦ä¹ äº¤æµã€‚&lt;/p>
&lt;p>å¦‚æœæˆ‘å†™çš„å“ªé‡Œä¸å¯¹ï¼Œ99%çš„é”…å½’æˆ‘å‚»é€¼ï¼Œ1%çš„é”…å½’phxrpcä»£ç æ²¡å†™æµ‹è¯•ã€‚æ¬¢è¿å¤§å®¶å¤šåšè‡ªæˆ‘æ‰¹è¯„ã€‚&lt;/p>
&lt;p>å¥½å•¦å¥½å•¦ï¼Œå°±åˆ°è¿™é‡Œå§ã€‚&lt;/p>
&lt;p>&lt;img src="https://github.com/Wizmann/assets/raw/master/wizmann-pic/16-10-23/91802175.jpg" alt="">&lt;/p></description></item><item><title>RPC - phxrpcä»£ç é˜…è¯»(7)</title><link>https://wizmann.top/posts/phxrpc-7/</link><pubDate>Sat, 22 Oct 2016 23:03:36 +0000</pubDate><guid>https://wizmann.top/posts/phxrpc-7/</guid><description>&lt;h2 id="å‰è¨€">å‰è¨€ &lt;a href="#%e5%89%8d%e8%a8%80" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>çœ‹äº†è¿™ä¹ˆä¹…ä»£ç ï¼Œç»ˆäºæˆ‘ä»¬è¦æ¥è¿‘phxrpcçš„æ ¸å¿ƒéƒ¨åˆ†äº†ã€‚&lt;/p>
&lt;p>ä½†æ˜¯å‡ºäººæ„æ–™çš„æ˜¯ï¼Œrpcéƒ¨åˆ†å¹¶æ²¡æœ‰è¿‡å¤šçš„æ¦‚å¿µå’Œmagic trickã€‚è€Œä¸”å› ä¸ºucontextå·²ç»è¢«å°è£…å¥½äº†ï¼Œæ‰€ä»¥åœ¨rpcé‡Œçš„æ“ä½œï¼Œå¯ä»¥å®Œå…¨æŒ‰ç…§åŒæ­¥çš„å†™æ³•æ¥æï¼Œå¼€å‘è€…ä»¬ä¸éœ€è¦åˆ‡æ¢åŒæ­¥å¼‚æ­¥çš„æ€ç»´æ¨¡å¼ï¼Œå°±å¯ä»¥åœ¨åº•å±‚çš„å°è£…ä¹‹ä¸Šï¼Œåšè‡ªå·±æƒ³åšçš„äº‹äº†ã€‚&lt;/p>
&lt;h2 id="çº¿ç¨‹å®‰å…¨çš„é˜Ÿåˆ—---threadqueue">çº¿ç¨‹å®‰å…¨(?)çš„é˜Ÿåˆ— - ThreadQueue &lt;a href="#%e7%ba%bf%e7%a8%8b%e5%ae%89%e5%85%a8%e7%9a%84%e9%98%9f%e5%88%97---threadqueue" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>æˆ‘ä¸çŸ¥é“å¼€å‘è€…ä¸ºå•¥è¦èµ·&lt;code>ThdQueue&lt;/code>è¿™æ ·ä»¤äººè¿·æƒ‘çš„åå­—ï¼Œè¿™ç§è¯¡å¼‚çš„å‘½åé£æ ¼è´¯ç©¿äº†æ•´ä¸ªä»£ç ã€‚å’‹ä¸€çœ‹è¿™ä¸ªç±»æ˜¯maintainä¸€å †çº¿ç¨‹çš„ï¼Œç±»ä¼¼äºçº¿ç¨‹æ± ï¼Œä½†å…¶å®è¿™ä¸ªç±»å°±æ˜¯ä¸€ä¸ª&lt;code>BlockingQueue&lt;/code>çš„å®ç°ã€‚&lt;/p>
&lt;p>ä¹‹åï¼Œè¿™ä¸ªé˜Ÿåˆ—æœ‰ä¸‰ç§æ“ä½œï¼Œ&lt;code>push&lt;/code>ã€&lt;code>pluck&lt;/code>å’Œ&lt;code>break_out&lt;/code>ã€‚pushæ“ä½œä¸ç”¨å¤šè¯´ï¼Œpluckå¯¹åº”çš„æˆ‘ä»¬æ‰€ç†è§£çš„popæ“ä½œï¼Œå³ä»é˜Ÿåˆ—ä¸­å¼¹å‡ºå…ƒç´ ï¼ˆpluckè¿™ä¸ªè¯è²Œä¼¼æ˜¯ä»grpcé‡Œé¢æ¥çš„ï¼Œé‚£æˆ‘å°±ä¸åæ§½äº†ï¼Œæ¯•ç«ŸGoogleçˆ¸çˆ¸ï¼‰ã€‚&lt;/p>
&lt;p>æ›´ä»¤äººç–‘æƒ‘çš„æ˜¯&lt;code>break_out&lt;/code>è¿™ä¸ªæ“ä½œã€‚ä»ä»£ç æ¥çœ‹ï¼Œåƒæ˜¯æ¸…ç©ºé˜Ÿåˆ—ï¼Œå¹¶ä¸”åœ¨dtorä¸­ä¹Ÿæ˜¾å¼çš„è°ƒç”¨äº†è¿™ä¸ªå‡½æ•°ã€‚&lt;/p>
&lt;p>ä½†æ˜¯æœ‰ä»¥ä¸‹çš„å‡ ä¸ªé—®é¢˜ã€‚&lt;/p>
&lt;p>ä¸€ï¼Œ&lt;code>break_out_&lt;/code>æ˜¯ä¸€ä¸ªboolå˜é‡ï¼Œä¸”åœ¨ä¸åŒçº¿ç¨‹é—´å…±äº«ï¼Œé—®é¢˜åœ¨äºè¿™ä¸ªå˜é‡å¯èƒ½è¢«cacheä½ï¼Œç›´æ¥è®¿é—®å¯èƒ½ä¼šé€ æˆéé¢„æœŸçš„ç»“æœï¼Œå¯èƒ½éœ€è¦&lt;code>volitaile&lt;/code>ï¼Œæˆ–è€…åœ¨&lt;code>pluck&lt;/code>å‡½æ•°é‡ŒåŠ ä¸€ä¸ªmem barrierã€‚&lt;/p>
&lt;p>äºŒæ¥ï¼Œåœ¨ææ„å‡½æ•°ä¸­è°ƒç”¨&lt;code>break_out_&lt;/code>ï¼Œæœ‰å¯èƒ½çš„ä¸€ç§æƒ…å†µæ˜¯æœ‰å…¶å®ƒçº¿ç¨‹è¿˜åœ¨&lt;code>pluck&lt;/code>å‡½æ•°ä¸­ï¼Œè€Œ&lt;code>ThdQueue&lt;/code>å¯¹è±¡å·²ç»è¢«ææ„äº†ï¼Œæˆ‘ä»¬å°±éœ€è¦æ‰¿æ‹…è¿™ç§ä¸å®‰å…¨è¡Œä¸ºçš„åæœï¼ˆæ­¤å¤„æœ‰å¹¿å‘Šï¼šå¤§é“æ£å­åŒ»é™¢æ…ä¸»ä»»ï¼Œå¼ å§å»äº†éƒ½è¯´å¥½ï¼‰ã€‚&lt;/p>
&lt;p>å½“ç„¶ï¼Œå¦‚æœè¿™ä¸ªå‡½æ•°åªåœ¨ç»“æŸè¿›ç¨‹æ—¶ä½¿ç”¨ï¼Œå…¶å®å†™çš„ç³™ä¸€ç‚¹ä¹Ÿæ— æ‰€è°“ï¼Œå› ä¸ºæ¯•ç«Ÿçº¿ä¸ŠæœåŠ¡æ˜¯æ²¡æœ‰â€œé€€å‡ºâ€è¿™ç§çŠ¶æ€çš„ã€‚å½“æˆ‘ä»¬è¦æ¸…ç©ºé˜Ÿåˆ—æ—¶ï¼Œå·²ç»ä¸éœ€è¦å¯¹å¤–æä¾›æœåŠ¡ï¼Œä¹‹åç›´æ¥&lt;code>kill -9&lt;/code>å°±å¥½ï¼Œä¸ä¼šè§¦å‘å¤šçº¿ç¨‹çš„å‘ã€‚ä¸è¿‡ï¼Œè¿™é‡Œæˆ‘è§‰å¾—åº”è¯¥è¿˜æ˜¯è¦åŠ å°å¿ƒã€‚&lt;/p>
&lt;h2 id="uthreadcaller">UThreadCaller &lt;a href="#uthreadcaller" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>è¿™ä¸ªç ´ç±»è®©æˆ‘çœ‹äº†ä¸€å°æ—¶ï¼Œåˆ†æå®ƒçš„keepaliveæ˜¯æ€ä¹ˆå®ç°çš„ã€‚ç»“æœå‘ç°è¿™ä¸ªç±»è¢«æ²¡æœ‰è¢«è°ƒç”¨ã€‚&lt;/p>
&lt;p>GGã€‚&lt;/p>
&lt;p>&lt;img src="https://github.com/Wizmann/assets/raw/master/wizmann-pic/16-10-22/54117736.jpg" alt="">&lt;/p>
&lt;h2 id="ä¸€ä¸ªè¶…çº§æ–‡ä»¶---hshaserver">ä¸€ä¸ªè¶…çº§æ–‡ä»¶ - HshaServer &lt;a href="#%e4%b8%80%e4%b8%aa%e8%b6%85%e7%ba%a7%e6%96%87%e4%bb%b6---hshaserver" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;blockquote>
&lt;p>ä¸çŸ¥é“ä¸ºå•¥å¼€å‘è€…è¦æŠŠè¿™ä¹ˆå¤šæ–‡ä»¶å†™ä¸€å—ï¼Œæ‹†å¼€ä¸å¥½å—ï¼Ÿ&lt;/p>&lt;/blockquote>
&lt;h3 id="dataflow">DataFlow &lt;a href="#dataflow" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;p>DataFlowåŒ…å«äº†Requestå’ŒResponseä¸¤ä¸ªQueueï¼Œè¿˜é™„åŠ äº†å…¥é˜Ÿçš„æ—¶é—´æˆ³å’Œä¸€ä¸ªargså‚æ•°æŒ‡é’ˆã€‚&lt;/p>
&lt;h3 id="hshaserverstat">HshaServerStat &lt;a href="#hshaserverstat" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;p>ä¸€ä¸ªç»Ÿè®¡ç±»ã€‚ä¼šåœ¨åå°æ–°å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œçº¦æ¯ä¸€ç§’æ‰“å°ä¸€æ¬¡ç»Ÿè®¡æ—¥å¿—ã€‚&lt;/p>
&lt;p>è¿™ä¸ªç±»é‡Œæœ‰ä¸€ä¸ªæŠ€å·§ï¼Œåœ¨&lt;code>CallFunc()&lt;/code>å‡½æ•°ä¸­ï¼Œæ¯ä¸€ç§’å¾ªç¯ä¸€æ¬¡å¹¶æ²¡æœ‰ä½¿ç”¨sleepå®¶æ—çš„å‡½æ•°ï¼Œä¹Ÿæ²¡æœ‰ä½¿ç”¨selectçš„è¶…æ—¶ã€‚è€Œæ˜¯ä½¿ç”¨äº†&lt;code>condtional variable&lt;/code>ã€‚&lt;/p>
&lt;p>&lt;code>std::condition_variable::wait_for&lt;/code>å‡½æ•°ï¼Œå®è´¨æ˜¯å°±æ˜¯å¸¦è¶…æ—¶çš„ç­‰å¾…ã€‚è€Œè¿™é‡Œï¼Œåœ¨ä¸€èˆ¬çŠ¶æ€ä¸‹ï¼Œæ˜¯æ²¡æœ‰çº¿ç¨‹ä¼šnotifyçš„ï¼Œæ‰€ä»¥wait_forå‡½æ•°ä¼šç¡æ»¡1sã€‚ä½†æ˜¯åœ¨é€€å‡ºæ—¶ï¼Œä¼šæ˜¾å¼çš„notifyç»Ÿè®¡çº¿ç¨‹ï¼Œç ´åç­‰å¾…çŠ¶æ€ï¼Œä½¿ç»Ÿè®¡çº¿ç¨‹é€€å‡ºã€‚&lt;/p>
&lt;p>&lt;code>wait_for&lt;/code>å‡½æ•°çš„å…·ä½“ç”¨æ³•ï¼Œå¯ä»¥å‚è€ƒ&lt;a href="http://en.cppreference.com/w/cpp/thread/condition_variable/wait_for">æ–‡æ¡£&lt;/a>ã€‚&lt;/p>
&lt;p>ä¸‹é¢çš„&lt;code>HshaServerQos&lt;/code>ä¹Ÿæ˜¯ä¸€æ ·çš„æ€è·¯ï¼ŒQoså³â€œQuality of serviceâ€ã€‚&lt;/p>
&lt;h3 id="workerå’Œworkerpool">Workerå’ŒWorkerPool &lt;a href="#worker%e5%92%8cworkerpool" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;p>è¿™ä¸¤ä¸ªç±»å…¶å®æ˜¯ä¸€ä¸ªå’Œä¸€å †çš„å…³ç³»ï¼Œä¸è¿‡ç”±äºè¿™é‡Œçš„è¯¡å¼‚çš„å†™æ³•ï¼Œå¯¼è‡´ä¸€ä¸ªä¾èµ–ä¸€å †ï¼Œä¸€å †è°ƒç”¨ä¸€ä¸ªã€‚&lt;/p>
&lt;p>WorkerPoolæ˜¯ä¸€ä¸ªå…¨å±€çš„çº¿ç¨‹æ± ï¼Œé‡Œé¢æœ‰çº¿ç¨‹ï¼ˆåºŸè¯ï¼‰ï¼Œè¾“å…¥è¾“å‡ºé˜Ÿåˆ—ï¼ŒDisipatcherå’Œè°ƒåº¦å™¨ã€‚æ‰€ä»¥Workerè¦åè¿‡æ¥ä¾èµ–WorkerPoolé‡Œé¢çš„æ•°æ®ã€‚é€ æˆäº†å¾ˆå¤§çš„è€¦åˆæ€§ã€‚&lt;/p>
&lt;p>Workerä»è¾“å…¥é˜Ÿåˆ—ä¸­è·å–ä¿¡æ¯ï¼Œå¹¶ä¸”ä½¿ç”¨&lt;code>dispatcher&lt;/code>è¿›è¡ŒCPUå¯†é›†çš„å¤„ç†ï¼ˆæˆ‘è§‰å¾—&lt;code>dispatcher&lt;/code>è¿™ä¸ªåå­—èµ·çš„ä¹Ÿæœ‰é—®é¢˜ï¼‰ã€‚ä¹‹åå°†ç»“æœæ”¾å…¥è¾“å‡ºé˜Ÿåˆ—ï¼Œç”±åé¢çš„&lt;code>HshaServerIO::ActiveSocketFunc&lt;/code>é©±åŠ¨åç¨‹åº“è¿›è¡Œä¹‹åçš„IOæ“ä½œã€‚&lt;/p>
&lt;h3 id="å®Œæˆè°ƒåº¦å™¨---hshaserverio">å®Œæˆè°ƒåº¦å™¨ - HshaServerIO &lt;a href="#%e5%ae%8c%e6%88%90%e8%b0%83%e5%ba%a6%e5%99%a8---hshaserverio" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;p>è¿™ä¸ªç±»çš„ä¸»è¦ä½œç”¨å°±æ˜¯è¡¥å…¨è°ƒåº¦å™¨ç¼ºå°‘çš„å‡½æ•°ï¼Œå¹¶æä¾›äº†ä¸€ä¸ªIOçš„å·¥ä½œå‡½æ•°&lt;code>HshaServerIO::IOFunc&lt;/code>ã€‚&lt;/p>
&lt;p>è°ƒåº¦å™¨çš„å·¥ä½œæµç¨‹å‰é¢å·²ç»è¯´è¿‡äº†ï¼Œæˆ‘ä»¬ç°åœ¨å°±ä»æ›´å…·ä½“åŒ–çš„å®ç°ä¸Šæ¥é˜…è¯»ä¸€ä¸‹ã€‚&lt;/p>
&lt;p>&lt;code>HshaServerIO :: AddAcceptedFd&lt;/code>ï¼Œè¿™ä¸ªå‡½æ•°ç”±å¤–éƒ¨è°ƒç”¨ï¼Œä¼ å…¥å·²ç»acceptçš„fdï¼Œä¹‹å&lt;code>HshaServerIO::HandlerAcceptedFd&lt;/code>å°†è¿™ä¸ªfdï¼Œå’ŒIOå·¥ä½œå‡½æ•°&lt;code>IOFunc&lt;/code>ä¸€èµ·æ”¾å…¥è°ƒåº¦å™¨ä¸­è¿›è¡Œè°ƒåº¦ã€‚&lt;/p>
&lt;p>å·¥ä½œå‡½æ•°&lt;code>IOFunc&lt;/code>åªè´Ÿè´£å°†è¯·æ±‚æ”¾å…¥é˜Ÿåˆ—ï¼Œè€Œå¹¶ä¸è´Ÿè´£ä»è¾“å‡ºé˜Ÿåˆ—ä¸­å–å‡ºå“åº”ã€‚è¿™ä¸ªäº‹æƒ…ç”±&lt;code>HshaServerIO::ActiveSocketFunc&lt;/code>è´Ÿè´£ã€‚&lt;/p>
&lt;p>æ¢å¥è¯è¯´ï¼Œåœ¨è°ƒåº¦å™¨çš„å·¥ä½œå¾ªç¯ä¸­ï¼Œ&lt;code>epoll_wait&lt;/code>ä¸­ç­‰å¾…çš„åªæœ‰åœ¨è¿›è¡ŒIOçš„ä¸¤ç§fdï¼Œä¸€æ˜¯è¯»è¿˜æ²¡è¯»å®Œçš„ï¼ŒäºŒæ˜¯å†™è¿˜æ²¡å†™å®Œçš„ã€‚&lt;/p>
&lt;p>è¿›è¡Œå®ŒCPUæ“ä½œçš„fdï¼Œç”±&lt;code>active_socket_func_&lt;/code>å‡½æ•°é‡æ–°æ¿€æ´»ï¼Œå‘å®¢æˆ·ç«¯å†™å›å“åº”ã€‚æ‰€ä»¥è¿™ä¸ªå‡½æ•°åº”è¯¥å«&lt;code>activate_socket_with_resp_func_&lt;/code>æ›´åˆé€‚ä¸€äº›ã€‚ï¼ˆè‡³å°‘ç¬¬ä¸€ä¸ªå•è¯å¾—æ˜¯ä¸ªåŠ¨è¯å¥½ä¸ã€‚ï¼‰&lt;/p>
&lt;p>åé¢çš„keepaliveçš„å¤„ç†ä¹Ÿæ˜¯éå¸¸æµ…æ˜¾çš„ï¼Œè¿™é‡Œå°±ä¸å¤šè¯´äº†ã€‚&lt;/p>
&lt;h3 id="å¤šçº¿ç¨‹io---hshaserverunitå’Œhshaserver">å¤šçº¿ç¨‹IO - HshaServerUnitå’ŒHshaServer &lt;a href="#%e5%a4%9a%e7%ba%bf%e7%a8%8bio---hshaserverunit%e5%92%8chshaserver" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;p>å‰é¢æˆ‘ä»¬è¯´äº†ä¸å°‘åç¨‹çš„äº‹ï¼Œä½†è¿™å¹¶ä¸ä»£è¡¨æˆ‘ä»¬ä¸ä½¿ç”¨å¤šçº¿ç¨‹å¸¦æ¥çš„çº¢åˆ©ã€‚æˆ–è€…è‡³å°‘åœ¨æ€§èƒ½ä¸ç¬¦åˆé¢„æœŸçš„æ—¶å€™ï¼Œç”¨å¤šçº¿ç¨‹æ¥tuningä¸€ä¸‹ã€‚&lt;/p>
&lt;p>HashServerUnitåŒ…è£…äº†ä¸€ç»„çº¿ç¨‹ï¼Œå…¶ä¸­åŒ…æ‹¬ä¸€ä¸ªIOçº¿ç¨‹å’Œè‹¥å¹²CPUçº¿ç¨‹ã€‚æˆ‘ä»¬åœ¨HshaServerä¸­ï¼Œè¿˜å¯ä»¥é…ç½®å¤šä¸ªUnitï¼Œä½¿å¾—æˆ‘ä»¬æœ‰å¤šä¸ªIOçº¿ç¨‹ï¼Œå……åˆ†æ¦¨å¹²CPUå’ŒIOçš„æ¯ä¸€æ»´æ±—æ°´ã€‚&lt;/p>
&lt;p>ç”±äºæ‰‹é‡Œä¹Ÿæ²¡æœ‰æµ‹è¯•æ•°æ®ï¼Œä¹Ÿå°±ä¸èƒ½æ›´è¯¦ç»†çš„æ¥è¯´é…ç½®æœåŠ¡å‚æ•°çš„ç­–ç•¥ã€‚ä½†æ˜¯æ— è´£ä»»çŒœæµ‹ï¼ŒIOçº¿ç¨‹åº”è¯¥ä¸è¶…è¿‡3ä¸ªã€‚CPUçº¿ç¨‹æ•°ç›®åº”è¯¥ç•¥å¤šäºCPUæ ¸æ•°ã€‚&lt;/p>
&lt;h3 id="ä¸€ä¸ªç‹¬ç«‹çš„acceptor">ä¸€ä¸ªç‹¬ç«‹çš„Acceptor &lt;a href="#%e4%b8%80%e4%b8%aa%e7%8b%ac%e7%ab%8b%e7%9a%84acceptor" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;p>&lt;code>HshaServerAcceptor&lt;/code>ç±»ç›¸å¯¹æ¯”è¾ƒç‹¬ç«‹ï¼Œå®ƒæ˜¯ç”¨æ¥æ¥å—è®¿é—®è¯·æ±‚ã€‚æ˜¯ä¸»çº¿ç¨‹çš„å·¥ä½œå¾ªç¯ã€‚&lt;/p>
&lt;p>è¿™é‡Œæ¯”è¾ƒå¥‡æ€ªçš„æ˜¯ï¼Œ&lt;code>LoopAccept&lt;/code>å‡½æ•°è®¾ç½®äº†CPUäº²å’Œæ€§ã€‚ä½¿å¾—æ§åˆ¶çº¿ç¨‹åªåœ¨CPU0ä¸Šè¿è¡Œã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span> cpu_set_t mask;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> CPU_ZERO(&lt;span style="color:#f92672">&amp;amp;&lt;/span>mask);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> CPU_SET(&lt;span style="color:#ae81ff">0&lt;/span>, &lt;span style="color:#f92672">&amp;amp;&lt;/span>mask);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> pid_t thread_id &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">int&lt;/span> ret &lt;span style="color:#f92672">=&lt;/span> sched_setaffinity(thread_id, &lt;span style="color:#66d9ef">sizeof&lt;/span>(mask), &lt;span style="color:#f92672">&amp;amp;&lt;/span>mask);
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å…·ä½“åŸå› æœ‰å¾…æ¢è®¨ï¼Œå¯èƒ½æ˜¯å’Œä¸­æ–­äº²å’Œæ€§æœ‰å…³ã€‚&lt;/p>
&lt;h2 id="å†™åœ¨åé¢">å†™åœ¨åé¢ &lt;a href="#%e5%86%99%e5%9c%a8%e5%90%8e%e9%9d%a2" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>æ€»ç®—å›«å›µåæ£çš„æŠŠè¿™RPCè¯»å®Œäº†ï¼Œå…¶å®è¿™é‡Œè¿˜æ˜¯æœ‰å¥½å¤šç–‘é—®çš„ã€‚ä½†æ˜¯ç”±äºphxrpcçš„æ–‡æ¡£å®åœ¨æ˜¯ã€‚ã€‚ã€‚åŸºæœ¬ç®—æ˜¯æ²¡æœ‰å§ã€‚æ‰€ä»¥å¯èƒ½è¿˜è¦å»Githubä¸Šæä¸€æ³¢Issueã€‚&lt;/p>
&lt;p>åœ¨å­¦ä¹ è¿‡ç¨‹ä¸­ï¼ŒçœŸçš„æ„Ÿè§‰è‡ªå·±æ‡‚çš„è¿˜æ˜¯å¤ªå°‘ã€‚ç®€ç›´è¯ä¸¸ã€‚&lt;/p>
&lt;p>è¿˜éœ€è¦æ›´åŠ åŠªåŠ›æ‰å¥½ã€‚&lt;/p></description></item><item><title>å®šæ—¶å™¨ä»¥åŠå…¶å®ƒ - phxrpcé˜…è¯»ç¬”è®°(2)</title><link>https://wizmann.top/posts/phxrpc-2/</link><pubDate>Thu, 29 Sep 2016 01:28:09 +0000</pubDate><guid>https://wizmann.top/posts/phxrpc-2/</guid><description>&lt;h2 id="å†™åœ¨å‰é¢">å†™åœ¨å‰é¢ &lt;a href="#%e5%86%99%e5%9c%a8%e5%89%8d%e9%9d%a2" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>phxrpcä½¿ç”¨äº†åç¨‹(ucontext)å’ŒIOå¤ç”¨æŠ€æœ¯(epoll)æ¥å®ç°ç½‘ç»œé€šä¿¡ã€‚å®šæ—¶å™¨åœ¨å…¶ä¸­èµ·åˆ°äº†éå¸¸é‡è¦çš„ä½œç”¨ã€‚ä¸‹é¢æˆ‘ä»¬å°±æ¥åˆ†æä¸€ä¸‹phxrpcçš„&lt;code>timer.[h|cpp]&lt;/code>ä¸­çš„ä»£ç ã€‚&lt;/p>
&lt;h2 id="system_clock-vs-steady_clock">system_clock vs steady_clock &lt;a href="#system_clock-vs-steady_clock" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>&lt;code>system_clock&lt;/code>å’Œ&lt;code>steadly_clock&lt;/code>éƒ½æ˜¯æ¥è‡ª&lt;code>&amp;lt;chrono&amp;gt;&lt;/code>åº“ï¼Œéƒ½æ˜¯ç”¨æ¥è·å–å½“å‰æ—¶é—´çš„ã€‚&lt;/p>
&lt;p>&lt;code>system_clock&lt;/code>ç”¨æ¥ä»ç³»ç»Ÿæ—¶é’Ÿè·å–æ—¶é’Ÿæ—¶é—´(wall clock time)ï¼Œè€Œ&lt;code>steadly_clock&lt;/code>è·å–çš„æ˜¯æ—¶é’Ÿtickï¼Œè€Œä¸”ä¿è¯éšç€æ—¶é—´çš„æ¨ç§»ï¼Œæ—¶é’Ÿtickæ•°ä¸ä¼šå˜å°ã€‚&lt;/p>
&lt;p>ç„¶è€Œå®é™…ä¸Šï¼Œåœ¨æŸäº›ç³»ç»Ÿä¸‹ï¼Œè¿™ä¸¤ä¸ªæ—¶é’Ÿçš„å®ç°æ˜¯ä¸€è‡´çš„ã€‚è¯¦ç»†ä¿¡æ¯å¯ä»¥å‚è€ƒ&lt;a href="http://stackoverflow.com/questions/13263277/difference-between-stdsystem-clock-and-stdsteady-clock">è¿™é‡Œ&lt;/a>ã€‚&lt;/p>
&lt;blockquote>
&lt;p>æ³¨ï¼šåœ¨clang++ 4.2.1, g++ 5.4 ä¸‹å®éªŒï¼Œè¿™ä¸¤ä¸ªæ—¶é’Ÿæ˜¯ä¸åŒçš„ã€‚æ‰€ä»¥ä¸ªäººè®¤ä¸ºåœ¨è¿™é‡Œæœ€å¥½ä¸è¦åšä»»ä½•æ— æ„ä¹‰çš„å‡è®¾ã€‚&lt;/p>&lt;/blockquote>
&lt;h2 id="å‡ æ¯«ç§’çš„å®‰ç¡">å‡ æ¯«ç§’çš„å®‰ç¡ &lt;a href="#%e5%87%a0%e6%af%ab%e7%a7%92%e7%9a%84%e5%ae%89%e7%9d%a1" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">void&lt;/span> Timer &lt;span style="color:#f92672">::&lt;/span> MsSleep(&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> time_ms) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> timespec t;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> t.tv_sec &lt;span style="color:#f92672">=&lt;/span> time_ms &lt;span style="color:#f92672">/&lt;/span> &lt;span style="color:#ae81ff">1000&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> t.tv_nsec &lt;span style="color:#f92672">=&lt;/span> (time_ms &lt;span style="color:#f92672">%&lt;/span> &lt;span style="color:#ae81ff">1000&lt;/span>) &lt;span style="color:#f92672">*&lt;/span> &lt;span style="color:#ae81ff">1000000&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">int&lt;/span> ret &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">do&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ret &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#f92672">::&lt;/span>nanosleep(&lt;span style="color:#f92672">&amp;amp;&lt;/span>t, &lt;span style="color:#f92672">&amp;amp;&lt;/span>t);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> } &lt;span style="color:#66d9ef">while&lt;/span> (ret &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span> &lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span> errno &lt;span style="color:#f92672">==&lt;/span> EINTR);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™é‡Œphxrpcä½¿ç”¨äº†&lt;code>nanosleep&lt;/code>å®ç°äº†é«˜ç²¾åº¦çš„sleepã€‚&lt;/p>
&lt;p>æ³¨æ„è¿™é‡Œçš„ç”¨æ³•ï¼Œç”±äº&lt;code>nanosleep&lt;/code>å¯èƒ½è¢«ä¿¡å·ä¸­æ–­ï¼Œæ­¤æ—¶errnoè¢«è®¾ä¸º&lt;code>EINTR&lt;/code>ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦è¿›è¡Œé¢å¤–çš„åˆ¤æ–­ã€‚å½“nanosleepè¢«ä¿¡å·ä¸­æ–­æ—¶ï¼Œä¼šæŠŠå‰©ä½™æ—¶é—´å†™å…¥ç¬¬äºŒä¸ªå‚æ•°æŒ‡å‘çš„&lt;code>timespec&lt;/code>å˜é‡ä¸­ï¼Œä¹‹åæˆ‘ä»¬å†æ¬¡è°ƒç”¨&lt;code>nanosleep&lt;/code>ï¼Œå°±å¯ä»¥æŠŠå‰©ä½™çš„æ—¶é—´å†ç¡ä¸€ä¸ªå›ç¬¼è§‰äº†ã€‚&lt;/p>
&lt;h2 id="å¯åˆ é™¤ä¼˜å…ˆé˜Ÿåˆ—">å¯åˆ é™¤ä¼˜å…ˆé˜Ÿåˆ— &lt;a href="#%e5%8f%af%e5%88%a0%e9%99%a4%e4%bc%98%e5%85%88%e9%98%9f%e5%88%97" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>è¿™ä¸ªè®¾è®¡ä¸€é¢—èµ›è‰‡å•Šã€‚&lt;/p>
&lt;p>å¯¹äº&lt;code>std::priority_queue&lt;/code>ä»¥åŠå¤§å¤šæ•°æ‰‹å†™çš„ä¼˜å…ˆé˜Ÿåˆ—ï¼ˆåˆç§°å †ï¼Œheapï¼‰ã€‚ä¸€èˆ¬åªæœ‰&lt;code>top()&lt;/code>, &lt;code>push()&lt;/code>, &lt;code>pop()&lt;/code>è¿™ä¸‰ä¸ªæ“ä½œæ¥å£ï¼Œå¦‚æœæƒ³å®ç°åˆ é™¤æ“ä½œï¼Œå¤§å¤šæ•°æƒ…å†µï¼ˆä¸ºäº†å·æ‡’ï¼‰ä¼šæŠŠ&lt;code>std::priority_queue&lt;/code>æ›¿æ¢ä¸º&lt;code>std::set&lt;/code>ã€‚&lt;code>std::set&lt;/code>çš„å†…éƒ¨å®ç°æ˜¯å¹³è¡¡æ ‘ï¼ˆç¡®åˆ‡çš„è¯´ï¼Œçº¢é»‘æ ‘ï¼‰ï¼Œå¯ä»¥å®ç°è·å¾—æœ€å¤§æœ€å°å€¼ï¼ŒæŸ¥æ‰¾æŸä¸ªå€¼ï¼Œä»¥åŠåˆ é™¤æŸä¸ªå€¼çš„æ“ä½œã€‚&lt;/p>
&lt;p>ä½†æ˜¯&lt;code>std::priority_queue&lt;/code>ï¼ˆæˆ–è€…ç”¨æ•°ç»„æˆ–vectorå®ç°çš„å †ï¼‰æ˜¯é¡ºåºå®¹å™¨(sequence containers)ï¼Œè€Œ&lt;code>std::set&lt;/code>æ˜¯å…³è”å®¹å™¨(associative containers)ã€‚ç›¸å¯¹æ¥è¯´ï¼Œç”±äºcacheçš„åŸå› ï¼Œé¡ºåºå®¹å™¨çš„æ€§èƒ½æ¯”å…³è”å®¹å™¨è¦å¥½ã€‚å½“ç„¶æˆ‘æ‰¯å¾—æœ‰ç‚¹è¿œäº†ã€‚å¯¹æ­¤æ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥å»å‚è€ƒã€ŠEffective STLã€‹ä¸€ä¹¦ã€‚&lt;/p>
&lt;p>åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬çš„éœ€æ±‚æ˜¯è¿™æ ·çš„ï¼š&lt;/p>
&lt;ul>
&lt;li>å †æ˜¯å°æ ¹å †ï¼ŒæŒ‰è¶…æ—¶æ—¶é—´å¢åº&lt;/li>
&lt;li>å †ä¸­çš„å…ƒç´ æ˜¯socketæè¿°ç¬¦&lt;code>UThreadSocket_t&lt;/code>&lt;/li>
&lt;li>æ ¹æ®æè¿°ç¬¦ï¼Œæˆ‘ä»¬å¯ä»¥åˆ é™¤å †ä¸­çš„ä»»æ„å…ƒç´ &lt;/li>
&lt;/ul>
&lt;p>å¦‚æœæˆ‘ä»¬æœ‰æ¸…é†’çš„å¤´è„‘ï¼Œå°±ä¼šè®¤ä¸ºè¿™ä¸ªéœ€æ±‚æ˜¯ä¸å¥½å®ç°çš„ã€‚åˆ é™¤å †ä¸­å…ƒç´ å¹¶ä¸å¤æ‚ï¼Œåªéœ€è¦å°†å †ä¸­æœ€åä¸€ä¸ªå…ƒç´ æ”¾åˆ°è¢«åˆ é™¤å…ƒç´ çš„ä½ç½®ä¸Šï¼Œç„¶åå†æ‰§è¡Œä¸€æ¬¡&lt;code>heap_down()&lt;/code>æ“ä½œå°±å¯ä»¥äº†ã€‚é—®é¢˜åœ¨äºæˆ‘ä»¬å¾ˆéš¾ç¡®å®šæŸä¸€ä¸ªå…ƒç´ çš„å…·ä½“ä½ç½®ã€‚&lt;/p>
&lt;blockquote>
&lt;p>æƒ³ä¸€æƒ³ï¼Œå †ä¸­çš„æ•°æ®æ˜¯å¦‚ä½•ç»„ç»‡çš„ã€‚å¦‚æœæƒ³æ‰¾åˆ°æŸä¸€ä¸ªç‰¹å®šçš„å€¼ï¼Œé™¤äº†éå†ä¹‹å¤–ï¼Œè¿˜æœ‰æ²¡æœ‰å…¶å®ƒçš„æ–¹æ³•ã€‚&lt;/p>&lt;/blockquote>
&lt;p>è¿™é‡Œphxrpcä½¿ç”¨äº†ä¸€ç§ä¾µå…¥å¼çš„æ‰‹æ®µï¼Œå°†ä¸‹æ ‡å†™å…¥å †ä¸­å…ƒç´ ã€‚ç„¶åå †å¤–æŒæœ‰æŒ‡é’ˆã€‚ç„¶ååœ¨ç»´æŠ¤å †æ€§è´¨çš„æ—¶å€™ï¼ŒåŒæ­¥æ›´æ–°å †ä¸­å…ƒç´ ï¼Œä½¿å…¶ä¸­ä¿å­˜çš„ä¸‹æ ‡ä¸å…¶åœ¨å †ä¸­çš„ä¸‹æ ‡ä¸€è‡´ã€‚&lt;/p>
&lt;p>è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡æŒ‡é’ˆæ‹¿åˆ°ç›¸åº”å…ƒç´ çš„ä¸‹æ ‡ï¼Œåˆ é™¤æ“ä½œä¹Ÿå˜å¾—ç®€å•äº†èµ·æ¥ã€‚&lt;/p>
&lt;p>é‚£ä¹ˆä¾µå…¥å¼å †ä¸‹æ ‡æœ‰ä»€ä¹ˆé—®é¢˜å—ï¼Ÿä¸€æ¥æˆ‘ä»¬å¯¹äºå…ƒç´ çš„æŸ¥æ‰¾åªèƒ½æ ¹æ®å®¹å™¨å¤–æŒæœ‰çš„æŒ‡é’ˆæ¥è¿›è¡Œï¼Œå¹¶ä¸èƒ½åƒ&lt;code>std::set&lt;/code>é‚£æ ·é€šè¿‡æ¯”è¾ƒå…³ç³»æ¥æŸ¥æ‰¾ã€‚äºŒæ¥ä¾µå…¥å¼ä¸‹æ ‡éœ€è¦é¢å¤–çš„å†…å­˜ç©ºé—´ï¼Œå¯¹äºå°å‹å¯¹è±¡ä¼šé€ æˆå¯è§‚æ¯”ä¾‹çš„overheadã€‚åŒæ—¶å®¹å™¨å†…åªèƒ½æŒæœ‰å…ƒç´ æŒ‡é’ˆï¼Œåœ¨æŸç§ç¨‹åº¦ä¸Šä¼šå¸¦æ¥é¢å¤–çš„å¯»å€å¼€é”€ã€‚&lt;/p>
&lt;p>ä¸è¿‡ï¼Œè¿™å¤§æ¦‚ä¹Ÿæ˜¯è®©å †æ”¯æŒåˆ é™¤çš„å”¯ä¸€æ–¹æ³•äº†ã€‚&lt;/p>
&lt;h2 id="å°å°åæ§½">å°å°åæ§½ &lt;a href="#%e5%b0%8f%e5%b0%8f%e5%90%90%e6%a7%bd" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>è¿™æ®µä»£ç å†™çš„ï¼Œè²Œä¼¼è€¦åˆçš„å¤ªç´§äº†ä¸€ç‚¹ã€‚&lt;code>class Timer&lt;/code>å†…éƒ¨æä¾›çš„åŠŸèƒ½æœ‰&lt;/p>
&lt;ol>
&lt;li>å¾—åˆ°å½“å‰æ—¶é—´&lt;/li>
&lt;li>nanosleep&lt;/li>
&lt;li>å°è£…&lt;code>TimerObj&lt;/code>ç±»&lt;/li>
&lt;li>ç»´æŠ¤ä¸€ä¸ªå®šæ—¶å™¨å †ï¼Œæä¾›&lt;code>top()&lt;/code>, &lt;code>push()&lt;/code>, &lt;code>pop()&lt;/code>, &lt;code>erase()&lt;/code>åŠŸèƒ½ï¼Œå¹¶ä¸”å¤§å¤šæ•°æ“ä½œéƒ½æ˜¯ç¡¬ç¼–ç çš„&lt;/li>
&lt;/ol>
&lt;p>è‡³å°‘åœ¨æˆ‘çœ‹æ¥ï¼Œè¿™å¹¶ä¸ç¬¦åˆâ€œé«˜å†…èšï¼Œä½è€¦åˆâ€ä»£ç é£æ ¼ã€‚&lt;/p>
&lt;p>ä½ é—®æˆ‘ä¸ºå•¥ä¸ç»™æ”¹æ”¹ï¼Ÿ&lt;/p>
&lt;p>å› ä¸ºä»–ä»¬æ²¡å†™æµ‹è¯•å•Šï¼&lt;/p>
&lt;p>&lt;img src="https://github.com/Wizmann/assets/raw/master/wizmann-pic/16-9-29/12309965.jpg" alt="">&lt;/p>
&lt;h2 id="è¡¥å……">è¡¥å…… &lt;a href="#%e8%a1%a5%e5%85%85" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>å…¶å®å¯¹äº&lt;code>class Timer&lt;/code>ï¼Œphxrpcæ˜¯æœ‰å†™æµ‹è¯•çš„(test_timer.cpp)ã€‚ä½†æ˜¯è¿™ä¸ªä»£ç å†™çš„å°±æ›´è¿·äº†ã€‚è¿™é‡Œå†åˆ†æä¸€ä¸‹ã€‚&lt;/p>
&lt;p>ä¸€å¼€å§‹ï¼Œå…ˆåˆ›å»º100ä¸ªtimerï¼Œsleepæ—¶é—´éšæœºã€‚ç„¶åå°†50ä¸ªtimeræ”¾å…¥&lt;code>need_remove&lt;/code>æ•°ç»„ä¸­ã€‚&lt;/p>
&lt;p>ä¹‹åæ¯åˆ ä¸€ä¸ªtimerï¼Œå°±é…å¥—ç¡åˆ°è¶…æ—¶æ—¶é—´popä¸€ä¸ªtimerã€‚å¼¹å‡ºè¶…æ—¶timeråï¼Œå†åˆ¤æ–­ä¸€ä¸‹æ—¶é—´è¯¯å·®æ˜¯å¦è¶…è¿‡10msï¼Œå¦‚æœæ˜¯ï¼Œå°±æŠ¥é”™ã€‚&lt;/p>
&lt;p>è¿™ã€‚ã€‚ã€‚&lt;/p>
&lt;p>&lt;img src="https://github.com/Wizmann/assets/raw/master/wizmann-pic/16-9-29/43591449.jpg" alt="">&lt;/p></description></item><item><title>è‡ªå®šä¹‰ä½ çš„stream buffer - phxrpcé˜…è¯»ç¬”è®°(1)</title><link>https://wizmann.top/posts/phxrpc-1/</link><pubDate>Wed, 28 Sep 2016 22:35:55 +0000</pubDate><guid>https://wizmann.top/posts/phxrpc-1/</guid><description>&lt;h2 id="å†™åœ¨å‰é¢">å†™åœ¨å‰é¢ &lt;a href="#%e5%86%99%e5%9c%a8%e5%89%8d%e9%9d%a2" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>&lt;a href="https://github.com/tencent-wechat/phxrpc">phxrpc&lt;/a>æ˜¯å¾®ä¿¡å›¢é˜Ÿå¼€æºçš„ä¸€ä¸ªè½»é‡çº§RPCæ¡†æ¶ã€‚&lt;/p>
&lt;p>æˆ‘å¯¹RPCè¿™äº›ä¸œè¥¿äº†è§£ä¸å¤šï¼Œçœ‹åˆ°phxrpcçš„ä»£ç ç›¸å¯¹ç®€å•ï¼Œè€Œä¸”è¿˜åœ¨åˆæ­¥å¼€å‘é˜¶æ®µï¼ˆåœ¨æœ¬æ–‡å†™ä½œæ—¶ï¼Œç‰ˆæœ¬å·æ˜¯0.8ï¼‰ã€‚æ‰€ä»¥æƒ³è¯»ä¸€è¯»ï¼Œæé«˜ä¸€ä¸‹å§¿åŠ¿æ°´å¹³ã€‚&lt;/p>
&lt;p>å°±æ˜¯è¿™æ ·ã€‚&lt;/p>
&lt;h2 id="è‡ªå®šä¹‰stream-buffer">è‡ªå®šä¹‰stream buffer &lt;a href="#%e8%87%aa%e5%ae%9a%e4%b9%89stream-buffer" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>&lt;code>network/socket_stream_base.[h|cpp]&lt;/code>ä¸­çš„&lt;code>class BaseTcpStreamBuf&lt;/code>ç»§æ‰¿äº†&lt;code>std::streambuf&lt;/code>ï¼Œè‡ªå®šä¹‰äº†ä¸€ä¸ªæµç¼“å†²åŒºï¼Œç”¨äºæ¥æ”¶/å‘é€TCPæ•°æ®åŒ…ã€‚&lt;/p>
&lt;p>è¿™ä¸ªç”¨æ³•æ¯”è¾ƒæ–°é¢–ï¼ˆæˆ–è€…æ˜¯æˆ‘è§è¯†å°‘ï¼‰ï¼Œç½‘ä¸Šçš„èµ„æ–™ä¹Ÿä¸å¤šã€‚è¿™é‡Œç¿»è¯‘ä¸€ç¯‡&lt;a href="http://www.mr-edd.co.uk/blog/beginners_guide_streambuf">ä»‹ç»æ–‡ç« &lt;/a>ï¼Œå­¦ä¹ ä¸€ä¸‹æ–°å§¿åŠ¿ã€‚&lt;/p>
&lt;h2 id="a-beginners-guide-to-writing-a-custom-stream-buffer">A beginner&amp;rsquo;s guide to writing a custom stream buffer &lt;a href="#a-beginners-guide-to-writing-a-custom-stream-buffer" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>æµ(streams)æ˜¯STLä¸­æä¾›çš„ä¸€ä¸ªé‡è¦çš„æŠ½è±¡æ¦‚å¿µã€‚è‘—åçš„â€œHello worldâ€ç¨‹åºï¼Œä¾¿æ˜¯ä½¿ç”¨äº†std::coutå°†å­—ç¬¦ä¸²å†™å…¥æ ‡å‡†è¾“å‡ºæµ(stdout)ã€‚&lt;/p>
&lt;p>æµå½“ç„¶å¯ä»¥åšæ¯”cin/coutæ›´æœ‰æ„æ€çš„äº‹ã€‚è¿™ç¯‡æ–‡ç« æˆ‘ä»¬ä¼šç ”ç©¶å¦‚ä½•æ‰©å±•C++æµï¼Œæ¥å®ç°è‡ªå®šä¹‰çš„æµç¼“å†²åŒº(stream buffer)ã€‚p.s. å»ºè®®æœ¬æ–‡çš„è¯»è€…è‡³å°‘è¦æœ‰åŸºç¡€çš„C++çŸ¥è¯†ã€‚&lt;/p>
&lt;p>C++æ ‡å‡†åº“ä¸ºç£ç›˜æ–‡ä»¶æ“ä½œæä¾›äº†åŸºç¡€çš„æ¥å£ï¼Œå¦‚&lt;code>std::fstream&lt;/code>ï¼Œ&lt;code>std::ifstream&lt;/code>å’Œ&lt;code>std::ofstream&lt;/code>ã€‚æˆ‘ä»¬è¿˜æœ‰&lt;code>stringstream&lt;/code>ï¼Œå¯ä»¥åƒæµä¸€æ ·æ“ä½œå­—ç¬¦ä¸²ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>std&lt;span style="color:#f92672">::&lt;/span>ostringstream oss;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>oss &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#e6db74">&amp;#34;Hello, world!&lt;/span>&lt;span style="color:#ae81ff">\\&lt;/span>&lt;span style="color:#e6db74">n&amp;#34;&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>oss &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#ae81ff">123&lt;/span> &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">&amp;#39;\\&lt;/span>n&lt;span style="color:#960050;background-color:#1e0010">&amp;#39;&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>std&lt;span style="color:#f92672">::&lt;/span>string s &lt;span style="color:#f92672">=&lt;/span> oss.str();
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç›¸ä¼¼çš„ï¼Œæˆ‘ä»¬å¯ä»¥ä»&lt;code>std::istringstream&lt;/code>ä¸­ä½¿ç”¨&lt;code>&amp;gt;&amp;gt;&lt;/code>æ“ä½œç¬¦è¯»å–æ•°æ®ã€‚&lt;/p>
&lt;p>Booståº“ä¸­çš„&lt;code>lexical_cast&lt;/code>æ­£æ˜¯ä½¿ç”¨äº†è¿™ç§æœºåˆ¶ï¼Œè®©ç”¨æˆ·å¯ä»¥ä½¿ç”¨ç»Ÿä¸€çš„æ–¹å¼å°†ä¸€ä¸ªå¯¹è±¡(object)è½¬æ¢ä¸ºå­—ç¬¦ä¸²è¡¨ç¤ºã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">using&lt;/span> boost&lt;span style="color:#f92672">::&lt;/span>lexical_cast;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">using&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>string;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">int&lt;/span> x &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">5&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>string s &lt;span style="color:#f92672">=&lt;/span> lexical_cast&lt;span style="color:#f92672">&amp;lt;&lt;/span>string&lt;span style="color:#f92672">&amp;gt;&lt;/span>(x);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>assert(s &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#e6db74">&amp;#34;5&amp;#34;&lt;/span>);
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æµç¼“å†²åŒºæœ‰ç€å¾ˆå¼ºçš„çµæ´»æ€§ï¼Œå¯ä»¥æ»¡è¶³ä¸åŒçš„â€œç¼“å†²å¹¶ä¼ è¾“å­—ç¬¦ï¼ˆä¸²ï¼‰â€éœ€æ±‚ï¼Œæ¯”å¦‚æ–‡ä»¶æ“ä½œã€å­—ç¬¦ä¸²æ“ä½œã€å‘½ä»¤è¡Œ(Console)æ“ä½œç­‰ã€‚æˆ‘ä»¬å¯ä»¥ä»ç½‘ç»œã€é—ªå­˜(Flash memory)ç­‰ä¸åŒè®¾å¤‡ï¼Œä½¿ç”¨åŒæ ·çš„æ¥å£è·å–æµå¼å­—ç¬¦ä¸²ã€‚â€œæµç¼“å†²åŒºâ€ä¸â€œæµâ€æ˜¯æ­£äº¤çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥è‡ªç”±çš„äº¤æ¢ã€æ›´æ”¹(swap and change)æµæ‰€ä½¿ç”¨çš„ç¼“å†²åŒºï¼Œæˆ–è€…å°†å…¶é‡å®šå‘åˆ°å…¶å®ƒåœ°æ–¹ã€‚æˆ‘è®¤ä¸ºC++ä¸­çš„æµï¼Œæ­£æ˜¯â€œç­–ç•¥æ¨¡å¼â€(strategy design pattern)çš„ä¸€ä¸ªè‰¯å¥½èŒƒä¾‹ã€‚&lt;/p>
&lt;p>æ¯”å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥é‡å®šå‘æ ‡å‡†æ—¥å¿—æµ&lt;code>std::clog&lt;/code>åˆ°ä¸€ä¸ªå­—ç¬¦ä¸²æµï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;iostream&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;iomanip&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;string&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;sstream&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">int&lt;/span> &lt;span style="color:#a6e22e">main&lt;/span>()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> std&lt;span style="color:#f92672">::&lt;/span>ostringstream oss;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// Make clog use the buffer from oss
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>streambuf &lt;span style="color:#f92672">*&lt;/span>former_buff &lt;span style="color:#f92672">=&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> std&lt;span style="color:#f92672">::&lt;/span>clog.rdbuf(oss.rdbuf());
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> std&lt;span style="color:#f92672">::&lt;/span>clog &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#e6db74">&amp;#34;This will appear in oss!&amp;#34;&lt;/span> &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>flush;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> std&lt;span style="color:#f92672">::&lt;/span>cout &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> oss.str() &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">&amp;#39;\\&lt;/span>n&lt;span style="color:#960050;background-color:#1e0010">&amp;#39;&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// Give clog back its previous buffer
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>clog.rdbuf(former_buff);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¸è¿‡ï¼Œè‡ªå®šä¹‰ä¸€ä¸ªæµç¼“å†²åŒºå´æ˜¯æœ‰ä¸€ç‚¹trickyï¼Œæˆ–è€…è¯´æœ‰ä¸€ç‚¹å“äººï¼Œå°¤å…¶æ˜¯å½“ä½ ç¬¬ä¸€æ¬¡å°è¯•çš„æ—¶å€™ã€‚æ‰€ä»¥æœ¬æ–‡æ„åœ¨æä¾›ä¸€äº›æµç¼“å†²çš„å®ç°èŒƒä¾‹ã€‚&lt;/p>
&lt;p>é¦–å…ˆæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹æµç¼“å†²åŒºçš„ä¸€äº›åŸºæœ¬æ¦‚å¿µã€‚æ‰€æœ‰çš„æµç¼“å†²åŒºç»§æ‰¿è‡ª&lt;code>std::streambuf&lt;/code>ï¼Œå¹¶ä¸”éœ€è¦è¦†ç›–ä¸€äº›è™šå‡½æ•°æ¥å®ç°è‡ªå®šä¹‰åŠŸèƒ½ã€‚&lt;code>std::streambuf&lt;/code>æ˜¯â€œé¡ºåºè¯»å–è®¾å¤‡â€çš„ä¸€ä¸ªæŠ½è±¡ï¼Œå³æˆ‘ä»¬å¯ä»¥ä»ä¸­é¡ºåºçš„è¯»å–å­—ç¬¦åºåˆ—ã€‚åœ¨ç‰¹å®šçš„åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥é‡å¡«(re-fill)ã€å†²æ´—(flush)ä»¥åŠæ¸…ç©º(empty)ä¸€ä¸ªç¼“å†²åŒºã€‚&lt;/p>
&lt;p>å½“æˆ‘ä»¬å‘ä¸€ä¸ª&lt;code>ostream&lt;/code>ä¸­æ’å…¥æ•°æ®æ—¶ï¼Œæ•°æ®å°†ä¼šè¢«å†™å…¥ç¼“å†²åŒºä¸­çš„ä¸€ä¸ªæ•°ç»„ã€‚å½“æ•°ç»„ä¸Šæº¢(overflow)æ—¶ï¼Œæ•°ç»„ä¸­çš„æ•°æ®å°†ä¼šè¢«å†²æ´—(flush)åˆ°ç›®æ ‡æ¥å—è€…ï¼Œä¹‹åè¿™ä¸ªæ•°ç»„çš„çŠ¶æ€å°†ä¼šé‡ç½®ï¼Œä»¥ä¾¿å­˜å‚¨åç»­çš„å­—ç¬¦ã€‚&lt;/p>
&lt;p>å½“æˆ‘ä»¬ä»ä¸€ä¸ª&lt;code>istream&lt;/code>ä¸­è·å–æ•°æ®æ—¶ï¼Œæ•°æ®ä»ç¼“å†²åŒºçš„æ•°ç»„ä¸­è¯»å‡ºã€‚å½“æ•°ç»„ä¸‹æº¢æ—¶(underflow)ï¼Œæ²¡æœ‰æ•°æ®å¯è¯»ï¼Œæˆ‘ä»¬ä¼šä»æ•°æ®æºé‡æ–°æ‹‰å–ä¿¡æ¯æ¥å¡«å……ç¼“å†²åŒºï¼Œä¹‹åè¿™ä¸ªæ•°ç»„çš„çŠ¶æ€ä¹Ÿå°†è¢«é‡ç½®ã€‚&lt;/p>
&lt;p>æˆ‘ä»¬ä½¿ç”¨6ä¸ªæŒ‡é’ˆï¼Œæ¥ç»´æŠ¤ç¼“å†²åŒºçš„å†…éƒ¨çŠ¶æ€ã€‚è¾“å…¥å’Œè¾“å‡ºç¼“å†²å„ä½¿ç”¨3ä¸ªæŒ‡é’ˆã€‚&lt;/p>
&lt;h3 id="ç»´æŠ¤è¾“å‡ºç¼“å†²åŒºçš„çŠ¶æ€">ç»´æŠ¤è¾“å‡ºç¼“å†²åŒºçš„çŠ¶æ€ &lt;a href="#%e7%bb%b4%e6%8a%a4%e8%be%93%e5%87%ba%e7%bc%93%e5%86%b2%e5%8c%ba%e7%9a%84%e7%8a%b6%e6%80%81" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;ul>
&lt;li>
&lt;p>put base pointer &lt;br>
è¾“å‡ºåŸºæŒ‡é’ˆï¼Œç”¨æ¥æŒ‡å®šç¼“å†²åŒºå†…éƒ¨æ•°ç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´ ã€‚å¯ä»¥ä½¿ç”¨&lt;code>std::streambuf::pbase()&lt;/code>æ¥è·å–&lt;/p>
&lt;/li>
&lt;li>
&lt;p>put pointer &lt;br>
è¾“å‡ºæŒ‡é’ˆï¼Œç”¨æ¥æŒ‡å‘å†…éƒ¨æ•°ç»„ä¸‹ä¸€ä¸ªå†™å…¥çš„åœ°å€ã€‚å¯ä»¥ä½¿ç”¨&lt;code>std::streambuf::pptr()&lt;/code>æ¥è·å–&lt;/p>
&lt;/li>
&lt;li>
&lt;p>end put pointer &lt;br>
è¾“å‡ºå“¨å…µæŒ‡é’ˆï¼ŒæŒ‡å‘å†…éƒ¨æ•°ç»„æœ€åä¸€ä¸ªå†åé¢ä¸€ä¸ª(one-past-the-last-element)çš„åœ°å€ï¼ˆè¯‘æ³¨ï¼šç±»ä¼¼&lt;code>std::vector::end()&lt;/code>ï¼‰ã€‚å¯ä»¥ä½¿ç”¨&lt;code>std::streambuf:epptr()&lt;/code>æ¥è·å–&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="http://i1.piimg.com/567571/630a89fe635e1635.png" alt="">&lt;/p>
&lt;p>ä¸€èˆ¬æ¥è¯´ï¼ŒåŸºæŒ‡é’ˆå’Œå“¨å…µæŒ‡é’ˆä¸ä¼šæ”¹å˜ï¼Œåœ¨ä½¿ç”¨æ—¶ï¼Œä»¥è¾“å‡ºæŒ‡é’ˆç»´æŠ¤å†…éƒ¨çŠ¶æ€ã€‚&lt;/p>
&lt;h3 id="ç»´æŠ¤è¾“å…¥ç¼“å†²åŒºçš„çŠ¶æ€">ç»´æŠ¤è¾“å…¥ç¼“å†²åŒºçš„çŠ¶æ€ &lt;a href="#%e7%bb%b4%e6%8a%a4%e8%be%93%e5%85%a5%e7%bc%93%e5%86%b2%e5%8c%ba%e7%9a%84%e7%8a%b6%e6%80%81" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;p>è¾“å…¥ç¼“å†²åŒºå’ŒçŠ¶æ€ç»´æŠ¤å’Œè¾“å‡ºç¼“å†²åŒºç±»ä¼¼ï¼Œæˆ‘ä»¬æœ‰ï¼š&lt;/p>
&lt;ul>
&lt;li>end back pointer &lt;br>
è¾“å…¥åŸºæŒ‡é’ˆï¼ŒæŒ‡å‘ç¼“å†²åŒºæ•°ç»„å†…çš„æœ€åä¸€ä¸ªå­—ç¬¦ã€‚å¯ä»¥ä½¿ç”¨&lt;code>std::streambuf::eback()&lt;/code>æ¥è·å–&lt;/li>
&lt;li>get pointer &lt;br>
è¾“å…¥æŒ‡é’ˆï¼ŒæŒ‡å‘ç¼“å†²åŒºä¸‹ä¸€ä¸ªè¯»å–çš„å­—ç¬¦åœ°å€ã€‚å¯ä»¥ä½¿ç”¨&lt;code>std::streambuf::gptr()&lt;/code>æ¥è·å–&lt;/li>
&lt;li>end get pointer &lt;br>
è¾“å…¥å“¨å…µæŒ‡é’ˆï¼Œæ‰¹å·å‘å†…éƒ¨æ•°ç»„æœ€åä¸€ä¸ªå†åé¢ä¸€ä¸ª(one-past-the-last-element)çš„åœ°å€ã€‚å¯ä»¥ä½¿ç”¨&lt;code>std::streambuf::egptr()&lt;/code>æ¥è·å–&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://github.com/Wizmann/assets/raw/master/wizmann-pic/16-9-27/33500590.jpg" alt="">&lt;/p>
&lt;p>åŒæ ·ï¼ŒåŸºæŒ‡é’ˆå’Œå“¨å…µæŒ‡é’ˆåœ¨æµç¼“å†²åŒºçš„ç”Ÿå‘½å‘¨æœŸä¸­ä¹Ÿä¸ä¼šæ”¹å˜ã€‚&lt;/p>
&lt;p>ç”±äºè¾“å…¥ç¼“å†²åŒºè¦æ”¯æŒ&lt;code>putback()&lt;/code>æ“ä½œï¼Œå³å°†è¯»å‡ºçš„å­—ç¬¦é‡æ–°æ”¾å›ç¼“å†²åŒºï¼Œæ‰€ä»¥è¾“å…¥ç¼“å†²åŒºæ¯”è¾“å‡ºç¼“å†²åŒºæ›´å¤æ‚ä¸€ç‚¹ã€‚é€šå¸¸æ¥è¯´ï¼Œ&lt;code>putback()&lt;/code>æ“ä½œæ”¯æŒæ”¾å›ä¸€ä¸ªå­—ç¬¦å³å¯ã€‚&lt;/p>
&lt;p>ä¸€ä¸ª&lt;code>std::streambuf&lt;/code>å¯ä»¥åŒæ—¶æ”¯æŒè¾“å…¥è¾“å‡ºä¸¤ç§æ“ä½œï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸éœ€è¦æˆ‘åˆ†åˆ«å®ç°&lt;code>std::istreambuf&lt;/code>å’Œ&lt;code>std::ostreambuf&lt;/code>ã€‚&lt;code>std::fstream&lt;/code>æ˜¯ä¸€ä¸ªè‰¯å¥½çš„ä¾‹å­ã€‚ä½†æ˜¯ï¼Œå®ç°ä¸€ä¸ªå…¨åŠŸèƒ½çš„ç¼“å†²åŒºç›¸å¯¹æ›´å¤æ‚ä¸€äº›ï¼Œæ‰€ä»¥æˆ‘å°±ä¸è¶Ÿæµ‘æ°´å•¦~ ï¼šï¼‰&lt;/p>
&lt;p>åŒæ—¶ï¼Œæµç¼“å†²åŒºä¹Ÿå¯ä»¥æ”¯æŒå®½å­—ç¬¦(wide character)ã€‚&lt;code>std::streambuf&lt;/code>æ˜¯&lt;code>std::basic_streambuf&amp;lt;char&amp;gt;&lt;/code>çš„åˆ«åï¼Œå¦‚æœä½ éœ€è¦å®½å­—ç¬¦æµç¼“å†²åŒºï¼Œå¯ä»¥ä½¿ç”¨&lt;code>std::basic_streambuf&amp;lt;wchar_t&amp;gt;&lt;/code>ã€‚&lt;/p>
&lt;h3 id="ä¾‹1æ–‡ä»¶ç¼“å†²åŒº--ä¸cä»£ç é›†æˆ">ä¾‹1ï¼šæ–‡ä»¶ç¼“å†²åŒº â€”â€” ä¸Cä»£ç é›†æˆ &lt;a href="#%e4%be%8b1%e6%96%87%e4%bb%b6%e7%bc%93%e5%86%b2%e5%8c%ba--%e4%b8%8ec%e4%bb%a3%e7%a0%81%e9%9b%86%e6%88%90" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;p>å‡è®¾æˆ‘ä»¬éœ€è¦è°ƒç”¨ä¸€ä¸ªå†å²æ‚ ä¹…çš„åº“ï¼Œä¸€ä¸ªæ–‡ä»¶æ“ä½œå‡½æ•°ä¼šè¿”å›ç»™ä¸€ä¸ª&lt;code>FILE*&lt;/code>æŒ‡é’ˆï¼Œä½†æ˜¯æˆ‘ä»¬æƒ³ç”¨C++çš„æµæ¥å£æ¥è¯»å†™æ•°æ®ã€‚æˆ‘ä»¬å…ˆä»è¯»æ–‡ä»¶å¼€å§‹ï¼Œç”¨&lt;code>std::istream&lt;/code>åŒ…è£…&lt;code>FILE*&lt;/code>çš„è¯»æ“ä½œã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;streambuf&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;vector&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;cstdlib&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;cstdio&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">FILE_buffer&lt;/span> &lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#66d9ef">public&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>streambuf
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">public&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">explicit&lt;/span> FILE_buffer(FILE &lt;span style="color:#f92672">*&lt;/span>fptr, std&lt;span style="color:#f92672">::&lt;/span>size_t buff_sz &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">256&lt;/span>, std&lt;span style="color:#f92672">::&lt;/span>size_t put_back &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">8&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">private&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// overrides base class underflow()
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> int_type underflow();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// copy ctor and assignment not implemented;
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75715e">// copying not allowed
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> FILE_buffer(&lt;span style="color:#66d9ef">const&lt;/span> FILE_buffer &lt;span style="color:#f92672">&amp;amp;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> FILE_buffer &lt;span style="color:#f92672">&amp;amp;&lt;/span>&lt;span style="color:#66d9ef">operator&lt;/span>&lt;span style="color:#f92672">=&lt;/span> (&lt;span style="color:#66d9ef">const&lt;/span> FILE_buffer &lt;span style="color:#f92672">&amp;amp;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">private&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> FILE &lt;span style="color:#f92672">*&lt;/span>fptr_;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">const&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>size_t put_back_;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> std&lt;span style="color:#f92672">::&lt;/span>vector&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">char&lt;/span>&lt;span style="color:#f92672">&amp;gt;&lt;/span> buffer_;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>};
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç”±äºåŠŸèƒ½ç®€å•ï¼Œæˆ‘ä»¬åªéœ€è¦å®ç°æ„é€ å‡½æ•°ä»¥åŠ&lt;code>underflow&lt;/code>æ¥å£å°±å¯ä»¥å®ç°æˆ‘ä»¬çš„åŠŸèƒ½ã€‚&lt;/p>
&lt;p>æ„é€ å‡½æ•°æŒ‡å®šäº†è¯»å–æ–‡ä»¶çš„&lt;code>FILE*&lt;/code>æŒ‡é’ˆï¼Œä»¥åŠå†…éƒ¨ç¼“å†²æ•°ç»„çš„å¤§å°ã€‚æ•°ç»„å¤§å°ç”±ä¸¤ä¸ªå‚æ•°å†³å®šï¼š&lt;/p>
&lt;ul>
&lt;li>put-back area size&lt;/li>
&lt;li>buffer size&lt;/li>
&lt;/ul>
&lt;p>æˆ‘ä»¬ä½¿ç”¨&lt;code>std::vector&amp;lt;char&amp;gt;&lt;/code>åšä¸ºç¼“å†²åŒºåŸŸã€‚&lt;code>put_back_&lt;/code>å˜é‡ç”¨äºå­˜å‚¨&amp;quot;put-back&amp;quot;åŒºåŸŸçš„å¤§å°ã€‚&lt;/p>
&lt;p>ä»¥ä¸‹æ˜¯æ„é€ å‡½æ•°çš„å®ç°ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">using&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>size_t;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>FILE_buffer&lt;span style="color:#f92672">::&lt;/span>FILE_buffer(FILE &lt;span style="color:#f92672">*&lt;/span>fptr, size_t buff_sz, size_t put_back) &lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> fptr_(fptr),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> put_back_(std&lt;span style="color:#f92672">::&lt;/span>max(put_back, size_t(&lt;span style="color:#ae81ff">1&lt;/span>))),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> buffer_(std&lt;span style="color:#f92672">::&lt;/span>max(buff_sz, put_back_) &lt;span style="color:#f92672">+&lt;/span> put_back_)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span>end &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#f92672">&amp;amp;&lt;/span>buffer_.front() &lt;span style="color:#f92672">+&lt;/span> buffer_.size();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> setg(end, end, end);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>åœ¨åˆå§‹åŒ–åˆ—è¡¨ä¸­ï¼Œæˆ‘ä»¬å°†ç¼“å†²åŒºçš„å¸¸é‡è¿›è¡Œèµ‹å€¼ã€‚ä¹‹åä½¿ç”¨&lt;code>std::streambuf::setg()&lt;/code>æ¥åˆå§‹åŒ–è¾“å‡ºç¼“å†²åŒºã€‚&lt;/p>
&lt;p>&lt;code>setg()&lt;/code>çš„ä¸‰ä¸ªå‚æ•°åˆ†åˆ«ä»£è¡¨&lt;code>eback()&lt;/code>ï¼Œ&lt;code>gptr()&lt;/code>ï¼Œ&lt;code>egptr()&lt;/code>ä¸‰ä¸ªå†…éƒ¨æŒ‡é’ˆçš„å€¼ã€‚ä¸€å¼€å§‹ï¼Œæˆ‘ä»¬å°†å®ƒä»¬éƒ½æŒ‡å‘åŒä¸€ä¸ªåœ°å€ã€‚è¡¨æ˜bufferæ˜¯ç©ºçš„ï¼Œåœ¨ä¸‹ä¸€æ¬¡è¯»å–æ—¶ï¼Œä¼šé‡æ–°å¡«å……ç¼“å†²åŒºã€‚&lt;/p>
&lt;p>&lt;code>underflow()&lt;/code>ä¼šè¿”å›æ•°æ®æºä¸­å½“å‰çš„å­—ç¬¦ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œä¼šè¿”å›bufferä¸­çš„ä¸‹ä¸€ä¸ªå¯ç”¨å­—ç¬¦ã€‚ç„¶åå½“bufferä¸ºç©ºæ—¶ï¼Œ&lt;code>underflow()&lt;/code>åº”è¯¥é‡æ–°å¡«å……ç¼“å†²åŒºæ•°ç»„ï¼Œåœ¨æœ¬ä¾‹ä¸­ï¼Œå³ä»&lt;code>FILE*&lt;/code>ä¸­è¯»å–å­—ç¬¦ã€‚å½“ç¼“å†²åŒºé‡å¡«åï¼Œæˆ‘ä»¬éœ€è¦å†æ¬¡è°ƒç”¨&lt;code>setg()&lt;/code>æ›´æ–°æµç¼“å†²åŒºçš„çŠ¶æ€ã€‚&lt;/p>
&lt;p>å½“æ•°æ®æºä¸­çš„æ•°æ®è¯»å®Œ(depleted)åï¼Œ&lt;code>underflow()&lt;/code>ä¼šè¿”å›ä¸€ä¸ª&lt;code>traits_type::eof()&lt;/code>ã€‚è¿™é‡Œè¦æ³¨æ„ï¼Œ&lt;code>underflow()&lt;/code>çš„è¿”å›å€¼æ˜¯&lt;code>int_type&lt;/code>ï¼Œè¿™ä¸ªå€¼è¶³å¤Ÿè£…ä¸‹&lt;code>eof()&lt;/code>ï¼ŒåŒæ—¶ä¹Ÿè¶³å¤Ÿè£…ä¸‹ä»»ä½•çš„å­—ç¬¦ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>std&lt;span style="color:#f92672">::&lt;/span>streambuf&lt;span style="color:#f92672">::&lt;/span>int_type FILE_buffer&lt;span style="color:#f92672">::&lt;/span>underflow()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (gptr() &lt;span style="color:#f92672">&amp;lt;&lt;/span> egptr()) &lt;span style="color:#75715e">// buffer not exhausted
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">return&lt;/span> traits_type&lt;span style="color:#f92672">::&lt;/span>to_int_type(&lt;span style="color:#f92672">*&lt;/span>gptr());
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span>base &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#f92672">&amp;amp;&lt;/span>buffer_.front();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span>start &lt;span style="color:#f92672">=&lt;/span> base;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (eback() &lt;span style="color:#f92672">==&lt;/span> base) &lt;span style="color:#75715e">// true when this isn&amp;#39;t the first fill
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// Make arrangements for putback characters
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>memmove(base, egptr() &lt;span style="color:#f92672">-&lt;/span> put_back_, put_back_);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> start &lt;span style="color:#f92672">+=&lt;/span> put_back_;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// start is now the start of the buffer, proper.
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75715e">// Read from fptr_ in to the provided buffer
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> size_t n &lt;span style="color:#f92672">=&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>fread(start, &lt;span style="color:#ae81ff">1&lt;/span>, buffer_.size() &lt;span style="color:#f92672">-&lt;/span> (start &lt;span style="color:#f92672">-&lt;/span> base), fptr_);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (n &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> traits_type&lt;span style="color:#f92672">::&lt;/span>eof();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// Set buffer pointers
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> setg(base, start, start &lt;span style="color:#f92672">+&lt;/span> n);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> traits_type&lt;span style="color:#f92672">::&lt;/span>to_int_type(&lt;span style="color:#f92672">*&lt;/span>gptr());
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å‡½æ•°çš„ç¬¬ä¸€è¡Œï¼Œé¦–å…ˆåˆ¤æ–­bufferæ˜¯å¦è€—å°½ã€‚å¦‚æœå¦ï¼Œåˆ™è¿”å›å½“å‰å­—ç¬¦ï¼Œå³&lt;code>*gptr()&lt;/code>ã€‚å¦‚æœæ˜¯ï¼Œåˆ™è¿›è¡Œé‡å¡«(re-fill)æ“ä½œã€‚&lt;/p>
&lt;p>å›æƒ³ä¸€ä¸‹æˆ‘ä»¬åœ¨æ„é€ å‡½æ•°ä¸­çš„å®ç°ï¼Œä¸‰ä¸ªçŠ¶æ€æŒ‡é’ˆå…¨éƒ½æŒ‡å‘ç¼“å†²åŒºçš„æœ«å°¾ã€‚å¦‚æœæˆ‘ä»¬è°ƒç”¨&lt;code>underflow()&lt;/code>æ—¶ï¼Œå‘ç°çŠ¶æ€æŒ‡é’ˆå¹¶éå¦‚æ­¤ï¼Œåˆ™è¯´æ˜ç¼“å†²åŒºå·²ç»è¢«å¡«å……äº†è‡³å°‘ä¸€æ¬¡ã€‚&lt;/p>
&lt;p>ç°åœ¨æˆ‘ä»¬è€ƒè™‘é‡å¡«æ“ä½œï¼Œæˆ‘ä»¬&lt;code>memmove&lt;/code>æœ€å&lt;code>put_back_&lt;/code>ä¸ªå­—ç¬¦åˆ°bufferçš„æœ«å°¾ï¼Œç”¨åš&amp;quot;put-back area&amp;quot;ã€‚ï¼ˆæˆ‘ä»¬ä¸ç”¨&lt;code>memcopy&lt;/code>å› ä¸ºæˆ‘ä»¬çš„bufferæ¯”è¾ƒå°ï¼Œ`memmove()çš„æ•ˆç‡ä¼šæ›´é«˜ä¸€äº›ï¼‰&lt;/p>
&lt;blockquote>
&lt;p>è¯‘æ³¨ï¼šå®é™…ä¸Šï¼Œ&lt;code>memcopy&lt;/code>ä¸&lt;code>memmove&lt;/code>å„æœ‰æ‰€é•¿ã€‚&lt;code>memcopy&lt;/code>ä¸éœ€è¦åˆ¤æ–­å†…å­˜overlapçš„æƒ…å†µï¼Œå³å¦‚æœæºåŒºé—´ä¸ç›®æ ‡åŒºé—´æœ‰é‡å ï¼Œé‚£ä¹ˆå¾—åˆ°çš„ç»“æœä¼šæ˜¯é”™çš„ã€‚è€Œ&lt;code>memmove&lt;/code>ç”±äºæ˜¯ç§»åŠ¨è¯­ä¹‰ï¼Œæ‰€ä»¥åœ¨ç§»åŠ¨æ­¥é•¿è¾ƒå°æ—¶ï¼Œå¯ä»¥åªæ“ä½œcacheã€‚æ‰€ä»¥äºŒè€…å„æœ‰æ‰€é•¿ï¼Œè¦æ ¹æ®å…·ä½“æƒ…å†µåˆ¤æ–­ä¼˜åŠ£ã€‚Stackoverflowä¸Šæœ‰æ›´è¯¦ç»†çš„&lt;a href="http://stackoverflow.com/questions/28623895/why-is-memmove-faster-than-memcpy">è®¨è®º&lt;/a>&lt;/p>&lt;/blockquote>
&lt;p>æˆ‘ä»¬å¤„ç†å®Œ&amp;quot;put-back area&amp;quot;ä¹‹åï¼Œå°±å¯ä»¥ä½¿ç”¨&lt;code>fread()&lt;/code>å‡½æ•°æ¥é‡å¡«ç¼“å†²åŒºäº†ã€‚å¦‚æœè¯»ä¸åˆ°æ•°æ®ï¼Œåˆ™æ„å‘³ç€æ–‡ä»¶å·²ç»è¯»åˆ°äº†ç»“å°¾ï¼ˆå½“ç„¶è¿™æ˜¯ä¸€ç§ç®€åŒ–æƒ…å†µï¼Œä½†åœ¨ç°å®ä¸­99.9%çš„è¯»å–å¤±è´¥éƒ½æ˜¯å› ä¸ºæ–‡ä»¶ç»“æŸï¼‰ã€‚&lt;/p>
&lt;p>åœ¨&lt;code>fread()&lt;/code>æˆåŠŸè¯»å–æ•°æ®ä¹‹åï¼Œæˆ‘ä»¬é€šçŸ¥streambufæ›´æ–°å†…éƒ¨çš„ä¸‰ä¸ªçŠ¶æ€æŒ‡é’ˆã€‚ä¹‹åè¿”å›bufferå½“å‰çš„æŒ‡é’ˆã€‚&lt;/p>
&lt;p>è¿™å°±æ˜¯æˆ‘ä»¬çš„æµç¼“å†²åŒºçš„åŸºæœ¬å®ç°ï¼Œå¸Œæœ›è¿™å¹¶ä¸æ˜¯å¤ªéš¾ã€‚å½“ç„¶æˆ‘ä»¬è¿˜å¯ä»¥æ·»åŠ æ›´å¤šçš„åŠŸèƒ½ã€‚ç‰¹åˆ«çš„æ˜¯æˆ‘ä»¬å¯ä»¥åœ¨ç¼“å†²åŒºé‡Œé¢è¿›è¡ŒæŸ¥æ‰¾ã€‚å¦‚æœä½ æƒ³å®ç°å®ƒçš„è¯ï¼Œå¯ä»¥è¯•è¯•é‡å†™&lt;code>std::streambuf::seekoff()&lt;/code>å’Œ&lt;code>std::streambuf::seekpos&lt;/code>è™šæˆå‘˜å‡½æ•°ã€‚&lt;/p>
&lt;p>æˆ‘ä»¬ä¹Ÿå¯ä»¥å®ç°å†™ç¼“å†²åŒºã€‚ä¸è¿‡ï¼Œåœ¨ä½ ä»¬è¯»å®Œç¬¬ä¸‰ä¸ªä¾‹å­ä¹‹åï¼Œä½ ä»¬å°±å¯ä»¥è½»æ¾æ„‰å¿«çš„å®ç°è‡ªå·±çš„ç‰ˆæœ¬äº†ï¼Œä¸éª—ä½ ã€‚&lt;/p>
&lt;h3 id="ä¾‹2è¯»å–å†…å­˜ä¸­çš„æ•°ç»„">ä¾‹2ï¼šè¯»å–å†…å­˜ä¸­çš„æ•°ç»„ &lt;a href="#%e4%be%8b2%e8%af%bb%e5%8f%96%e5%86%85%e5%ad%98%e4%b8%ad%e7%9a%84%e6%95%b0%e7%bb%84" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;p>æœ¬ä¾‹ä¸­ï¼Œæˆ‘ä»¬è¦ä½¿ç”¨&lt;code>std::istream&lt;/code>åŒ…è£…å†…å­˜ä¸­çš„ä¸€ä¸ªåªè¯»æ•°ç»„ï¼Œå¹¶ä¸”æ ¼å¼åŒ–çš„è¿›è¡Œè¯»å…¥ã€‚è¿™ä¸ªä¾‹å­å’Œä¸Šä¸€ä¸ªä¾‹å­æœ‰ä¸€ç‚¹ä¸åŒçš„æ˜¯ï¼Œæˆ‘ä»¬å¹¶ä¸éœ€è¦ä¸€ä¸ªçœŸæ­£çš„ç¼“å†²æ•°ç»„ï¼Œä»æºæ•°ç»„ä¸€æ¬¡æ€§è¯»å–å°±å¥½äº†ã€‚&lt;/p>
&lt;p>æƒ³è±¡ä¸­çš„å®ç°æ˜¯è¿™ä¸ªæ ·å¼å„¿çš„ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">char_array_buffer&lt;/span> &lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#66d9ef">public&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>streambuf
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">public&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> char_array_buffer(&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span>begin, &lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span>end)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> setg(begin, begin, end);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> int_type &lt;span style="color:#a6e22e">underflow&lt;/span>()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> gptr() &lt;span style="color:#f92672">==&lt;/span> egptr() &lt;span style="color:#f92672">?&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> traits_type&lt;span style="color:#f92672">::&lt;/span>eof() &lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> traits_type&lt;span style="color:#f92672">::&lt;/span>to_int_type(&lt;span style="color:#f92672">*&lt;/span>gptr());
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>};
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä½†æ˜¯ï¼Œè¿™å¹¶æ²¡æœ‰ä»€ä¹ˆåµç”¨ã€‚å› ä¸º&lt;code>setg()&lt;/code>å‡½æ•°åªæ¥å—éå¸¸é‡(non-const)æŒ‡é’ˆå‚æ•°ã€‚è¿™æ˜¾è€Œæ˜“è§ï¼Œå¦‚æœä¸€ä¸ªç¼“å†²åŒºä¸å¯å†™ï¼Œæˆ‘ä»¬å°±ä¸èƒ½æä¾›&amp;quot;put-back&amp;quot;åŠŸèƒ½ã€‚æ‰€ä»¥æˆ‘ä»¬è¦åŠ¨ä¸€åŠ¨æ‰‹è„šï¼Œé‡æ–°å®ç°ä¸€ä¸‹è¿™ä¸ªç±»ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;streambuf&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">char_array_buffer&lt;/span> &lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#66d9ef">public&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>streambuf
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">public&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> char_array_buffer(&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span>begin, &lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span>end);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">explicit&lt;/span> &lt;span style="color:#a6e22e">char_array_buffer&lt;/span>(&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span>str);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">private&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> int_type underflow();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> int_type &lt;span style="color:#a6e22e">uflow&lt;/span>();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> int_type &lt;span style="color:#a6e22e">pbackfail&lt;/span>(int_type ch);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> std&lt;span style="color:#f92672">::&lt;/span>streamsize showmanyc();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// copy ctor and assignment not implemented;
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75715e">// copying not allowed
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> char_array_buffer(&lt;span style="color:#66d9ef">const&lt;/span> char_array_buffer &lt;span style="color:#f92672">&amp;amp;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> char_array_buffer &lt;span style="color:#f92672">&amp;amp;&lt;/span>&lt;span style="color:#66d9ef">operator&lt;/span>&lt;span style="color:#f92672">=&lt;/span> (&lt;span style="color:#66d9ef">const&lt;/span> char_array_buffer &lt;span style="color:#f92672">&amp;amp;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">private&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span> &lt;span style="color:#66d9ef">const&lt;/span> begin_;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span> &lt;span style="color:#66d9ef">const&lt;/span> end_;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span> current_;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>};
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>åœ¨è¿™ä¸ªç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬é‡å†™äº†å‡ ä¸ªç§æœ‰å‡½æ•°ï¼Œè¿™äº›å‡½æ•°éƒ½æ˜¯ä»&lt;code>std::streambuf&lt;/code>ç»§æ‰¿è€Œæ¥ã€‚&lt;/p>
&lt;p>ç¬¬ä¸€ä¸ªæ„é€ å‡½æ•°éœ€è¦ç”¨æˆ·æŒ‡å®šèµ·æ­¢æŒ‡é’ˆï¼Œè€Œç¬¬äºŒä¸ªæ„é€ å‡½æ•°åªéœ€è¦æŒ‡å®šèµ·å§‹æŒ‡é’ˆï¼Œä¹‹åæˆ‘ä»¬ä¼šè°ƒç”¨&lt;code>std::strlen()&lt;/code>æ¥åˆ¤æ–­å­—ç¬¦ä¸²çš„å¤§å°ã€‚&lt;/p>
&lt;p>æˆ‘ä»¬ä½¿ç”¨&lt;code>uflow()&lt;/code>, &lt;code>pbackfail()&lt;/code>å’Œ&lt;code>showmanyc()&lt;/code>æ¥ç»´æŠ¤ç¼“å†²åŒºå†…éƒ¨çš„çŠ¶æ€ï¼Œè€Œä¸æ˜¯è°ƒç”¨&lt;code>setg()&lt;/code>ï¼Œå› ä¸ºbufferå¹¶ä¸å¯å†™ã€‚&lt;/p>
&lt;p>åœ¨è¿™ä¸ªç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬è¦æ‰‹åŠ¨ç»´æŠ¤&lt;code>eback&lt;/code>, &lt;code>gptr&lt;/code>, &lt;code>egptr&lt;/code>ä¸‰ä¸ªæŒ‡é’ˆã€‚åœ¨æ„é€ å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬å°†å¯¹å…¶è¿›è¡Œèµ‹å€¼ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;#34;char_array_buffer.hpp&amp;#34;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;functional&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;cassert&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;cstring&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>char_array_buffer&lt;span style="color:#f92672">::&lt;/span>char_array_buffer(&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span>begin, &lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span>end) &lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> begin_(begin),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> end_(end),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> current_(begin_)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> assert(std&lt;span style="color:#f92672">::&lt;/span>less_equal&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&amp;gt;&lt;/span>()(begin_, end_));
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>char_array_buffer&lt;span style="color:#f92672">::&lt;/span>char_array_buffer(&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span>str) &lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> begin_(str),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> end_(begin_ &lt;span style="color:#f92672">+&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>strlen(str)),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> current_(begin_)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¹‹å‰æˆ‘ä»¬ä½¿ç”¨&lt;code>underflow()&lt;/code>æ¥è·å–å½“å‰å­—ç¬¦ï¼Œä½†è¿™æ¬¡æˆ‘ä»¬éœ€è¦ä½¿ç”¨&lt;code>uflow()&lt;/code>ã€‚å› ä¸º&lt;code>uflow()&lt;/code>éœ€è¦åŒæ—¶æ‰§è¡Œä¸¤æ­¥æ“ä½œï¼Œä¸€æ˜¯è·å–å½“å‰å­—ç¬¦ï¼ŒäºŒæ˜¯è®©&lt;code>gptr()&lt;/code>å‰è¿›ä¸€æ­¥ã€‚ä½†æ˜¯åˆå› ä¸ºç¼“å†²åŒºç”±æˆ‘ä»¬æ‰‹åŠ¨ç®¡ç†ï¼Œ&lt;code>std::streambuf&lt;/code>å¹¶ä¸èƒ½æ­£ç¡®çš„æ‰§è¡Œç®¡ç†æ“ä½œã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦é‡å†™&lt;code>uflow()&lt;/code>è€Œä¸æ˜¯&lt;code>underflow()&lt;/code>ã€‚&lt;/p>
&lt;pre tabindex="0">&lt;code>char_array_buffer::int_type char_array_buffer::uflow()
{
if (current_ == end_)
return traits_type::eof();
return traits_type::to_int_type(*current_++);
}
&lt;/code>&lt;/pre>&lt;p>ä¸‹ä¸€æ­¥æˆ‘ä»¬è¿˜è¦å®ç°&lt;code>pbackfail()&lt;/code>ã€‚å½“æˆ‘ä»¬è°ƒç”¨&lt;code>std::istream::unget()&lt;/code>æˆ–&lt;code>std::istream::putback(ch)&lt;/code>æ—¶ï¼Œæˆ‘ä»¬ä¼šæŠŠå·²ç»è¯»å‡ºçš„æ•°æ®å†™å›æ•°ç»„ä¸­ã€‚ä½†æ˜¯ç”±äºæ•°ç»„æ˜¯åªè¯»çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬åªèƒ½æ¨¡æ‹Ÿè¿™ç§æ“ä½œã€‚&lt;/p>
&lt;p>åœ¨é»˜è®¤çš„å®ç°ä¸­&lt;code>pbackfail()&lt;/code>åªä¼šè¿”å›&lt;code>traits_type::eof()&lt;/code>ï¼Œè€Œåœ¨æˆ‘ä»¬çš„ç‰ˆæœ¬ä¸­ï¼Œå¦‚æœå†™å›æˆåŠŸï¼Œå°†ä¼šè¿”å›å†™å›çš„å­—ç¬¦ï¼Œä¸æˆåŠŸè¿”å›eofã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>char_array_buffer&lt;span style="color:#f92672">::&lt;/span>int_type char_array_buffer&lt;span style="color:#f92672">::&lt;/span>pbackfail(int_type ch)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (current_ &lt;span style="color:#f92672">==&lt;/span> begin_ &lt;span style="color:#f92672">||&lt;/span> (ch &lt;span style="color:#f92672">!=&lt;/span> traits_type&lt;span style="color:#f92672">::&lt;/span>eof() &lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span> ch &lt;span style="color:#f92672">!=&lt;/span> current_[&lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>]))
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> traits_type&lt;span style="color:#f92672">::&lt;/span>eof();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> traits_type&lt;span style="color:#f92672">::&lt;/span>to_int_type(&lt;span style="color:#f92672">*--&lt;/span>current_);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>åœ¨&lt;code>FILE_buffer&lt;/code>ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥è€ƒè™‘é‡å†™&lt;code>pbackfail()&lt;/code>ï¼Œæ¥æä¾›åå‘æŸ¥æ‰¾ä»¥åŠï¼ˆç”¨å‰é¢çš„æ•°æ®ï¼‰é‡å¡«bufferçš„åŠŸèƒ½ã€‚&lt;/p>
&lt;p>æœ€åä¸€ä¸ªé‡å†™çš„å‡½æ•°æ˜¯&lt;code>showmanyc()&lt;/code>ï¼Œè¿™ä¸ªå‡½æ•°è¢«&lt;code>std::streambuf::in_avail()&lt;/code>è°ƒç”¨ï¼Œä»¥åˆ¤æ–­å½“å‰æœ‰å¤šå°‘ä¸ªå­—ç¬¦å¯ä»¥è¿”å›ã€‚ç”±äºæˆ‘ä»¬æ¥ç®¡äº†çŠ¶æ€æŒ‡é’ˆï¼Œæ‰€ä»¥è¿™ä¸ªå‡½æ•°ä¹Ÿè¦æˆ‘ä»¬è‡ªå·±æ¥å®ç°å•Šã€‚ï¼ˆè¯‘è€…ï¼šä¸ºä»€ä¹ˆè¦ç»™è‡ªå·±æ‰¾éº»çƒ¦ã€‚ã€‚ã€‚ï¼‰&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>std&lt;span style="color:#f92672">::&lt;/span>streamsize char_array_buffer&lt;span style="color:#f92672">::&lt;/span>showmanyc()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> assert(std&lt;span style="color:#f92672">::&lt;/span>less_equal&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&amp;gt;&lt;/span>()(current_, end_));
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> end_ &lt;span style="color:#f92672">-&lt;/span> current_;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç”±æ­¤å¯è§ï¼Œæœ¬ä¾‹ä¸­çš„bufferæ¯”å‰é¢çš„è¦å¤æ‚ä¸€ç‚¹ç‚¹ã€‚è¿™æ˜¯å› ä¸ºæˆ‘ä»¬æ¥ç®¡äº†çŠ¶æ€ç»´æŠ¤çš„å·¥ä½œã€‚è¿™ä½¿å¾—æˆ‘ä»¬æ›´å¥½çš„ç†è§£äº†&lt;code>std::streambuf&lt;/code>å†…éƒ¨æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚&lt;/p>
&lt;h3 id="ä¾‹3å¥é¦–å˜å¤§å†™çš„ç¼“å†²åŒº">ä¾‹3ï¼šå¥é¦–å˜å¤§å†™çš„ç¼“å†²åŒº &lt;a href="#%e4%be%8b3%e5%8f%a5%e9%a6%96%e5%8f%98%e5%a4%a7%e5%86%99%e7%9a%84%e7%bc%93%e5%86%b2%e5%8c%ba" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;p>æœ¬ä¾‹ä¸­æˆ‘ä»¬å°†è¦å®ç°ä¸€ä¸ªå°†å¥é¦–å­—ç¬¦å˜å¤§å†™çš„bufferã€‚å½“ç„¶æˆ‘ä»¬åªè€ƒè™‘æœ€åŸºæœ¬çš„æƒ…å†µï¼Œç§»æ¤åˆ°ä¸åŒçš„åŒºåŸŸå’Œè¯­è¨€ï¼Œå…¶å®æ˜¯å¾ˆçç¢çš„äº‹æƒ…ã€‚ï¼ˆè¯‘è€…ï¼šæ–‡å­—ç¼–ç å‘çš„äº²å¦ˆéƒ½ä¸è®¤äº†ï¼‰&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;streambuf&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;iosfwd&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;cstdlib&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;vector&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">caps_buffer&lt;/span> &lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#66d9ef">public&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>streambuf
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">public&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">explicit&lt;/span> caps_buffer(std&lt;span style="color:#f92672">::&lt;/span>ostream &lt;span style="color:#f92672">&amp;amp;&lt;/span>sink, std&lt;span style="color:#f92672">::&lt;/span>size_t buff_sz &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">256&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">protected&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">bool&lt;/span> do_caps_and_flush();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">private&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> int_type overflow(int_type ch);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">int&lt;/span> &lt;span style="color:#a6e22e">sync&lt;/span>();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// copy ctor and assignment not implemented;
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75715e">// copying not allowed
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> caps_buffer(&lt;span style="color:#66d9ef">const&lt;/span> caps_buffer &lt;span style="color:#f92672">&amp;amp;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> caps_buffer &lt;span style="color:#f92672">&amp;amp;&lt;/span>&lt;span style="color:#66d9ef">operator&lt;/span>&lt;span style="color:#f92672">=&lt;/span> (&lt;span style="color:#66d9ef">const&lt;/span> caps_buffer &lt;span style="color:#f92672">&amp;amp;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">private&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">bool&lt;/span> cap_next_;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> std&lt;span style="color:#f92672">::&lt;/span>ostream &lt;span style="color:#f92672">&amp;amp;&lt;/span>sink_;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> std&lt;span style="color:#f92672">::&lt;/span>vector&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">char&lt;/span>&lt;span style="color:#f92672">&amp;gt;&lt;/span> buffer_;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>};
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™é‡Œæˆ‘ä»¬éœ€è¦é‡å†™&lt;code>overflow()&lt;/code>å’Œ&lt;code>sync()&lt;/code>å‡½æ•°ã€‚&lt;code>overflow()&lt;/code>åœ¨è¾“å…¥ç¼“å†²åŒºæ»¡çš„æ—¶å€™è¢«è°ƒç”¨ï¼Œå¹¶ä¸”åœ¨æˆåŠŸæ—¶è¿”å›ä»»æ„éeofçš„å€¼ã€‚&lt;/p>
&lt;p>&lt;code>sync()&lt;/code>çš„ä½œç”¨æ˜¯æŠŠå½“å‰çš„bufferå†™å…¥ç›®æ ‡ï¼Œå³ä½¿å½“å‰bufferå¹¶æœªå¡«æ»¡ã€‚&lt;code>std::flush()&lt;/code>ä¼šè°ƒç”¨&lt;code>sync()&lt;/code>å‡½æ•°ï¼Œå½“å¤±è´¥æ—¶è¿”å›-1ã€‚&lt;/p>
&lt;p>æˆ‘ä»¬ç¼–å†™ä¸€ä¸ªè¾…åŠ©å‡½æ•°&lt;code>do_caps_and_flush()&lt;/code>ï¼Œç”¨æ¥å°†å°å†™å˜å¤§å†™ï¼Œå¹¶å†™å…¥&lt;code>sink_&lt;/code>è¾“å‡ºæµã€‚æˆ‘ä»¬å†å£°æ˜ä¸€ä¸ªå“¨å…µå˜é‡&lt;code>cap_next_&lt;/code>æ¥æ ‡è¯†ä¸‹ä¸€ä¸ªå­—ç¬¦æ˜¯å¦éœ€è¦å°å†™å˜å¤§å†™ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;#34;caps_buffer.hpp&amp;#34;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;cctype&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;ostream&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;functional&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;cassert&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>caps_buffer&lt;span style="color:#f92672">::&lt;/span>caps_buffer(std&lt;span style="color:#f92672">::&lt;/span>ostream &lt;span style="color:#f92672">&amp;amp;&lt;/span>sink, std&lt;span style="color:#f92672">::&lt;/span>size_t buff_sz) &lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> cap_next_(true),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> sink_(sink),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> buffer_(buff_sz &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> sink_.clear();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span>base &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#f92672">&amp;amp;&lt;/span>buffer_.front();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> setp(base, base &lt;span style="color:#f92672">+&lt;/span> buffer_.size() &lt;span style="color:#f92672">-&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>); &lt;span style="color:#75715e">// -1 to make overflow() easier
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>buffer_&lt;/code>çš„æœ€å°å¯èƒ½å¤§å°æ˜¯1ï¼ŒåŒæ—¶æˆ‘ä»¬ä¹Ÿåªéœ€è¦ç»´æŠ¤ä¸¤ä¸ªæŒ‡é’ˆï¼Œå› ä¸ºè¿™é‡Œä¸éœ€è¦åƒè¾“å…¥ç¼“å†²åŒºä¸€æ ·çš„ç»´æŠ¤&amp;quot;put-back area&amp;quot;ã€‚&lt;/p>
&lt;p>æˆ‘ä»¬æŠŠ&lt;code>buffer_&lt;/code>çš„å¤§å°è®¾æˆ&lt;code>buff_sz + 1&lt;/code>ï¼Œè¿™æ ·æ˜¯ä¸ºäº†&lt;code>overflow()&lt;/code>è¢«è°ƒç”¨æ—¶ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªé¢å¤–çš„ç©ºé—´å­˜å‚¨å½“å‰çš„å­—ç¬¦ã€‚æœ€åå°†ç¼“å†²åŒºæ•°ç»„å’Œæœ€åä¸€ä¸ªå­—ç¬¦ä¸€èµ·åˆ·æ–°åˆ°&lt;code>ostream&lt;/code>ä¸­ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>caps_buffer&lt;span style="color:#f92672">::&lt;/span>int_type caps_buffer&lt;span style="color:#f92672">::&lt;/span>overflow(int_type ch)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (sink_ &lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span> ch &lt;span style="color:#f92672">!=&lt;/span> traits_type&lt;span style="color:#f92672">::&lt;/span>eof())
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> assert(std&lt;span style="color:#f92672">::&lt;/span>less_equal&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&amp;gt;&lt;/span>()(pptr(), epptr()));
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">*&lt;/span>pptr() &lt;span style="color:#f92672">=&lt;/span> ch;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> pbump(&lt;span style="color:#ae81ff">1&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (do_caps_and_flush())
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> ch;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> traits_type&lt;span style="color:#f92672">::&lt;/span>eof();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç¬¬ä¸€æ­¥æ˜¯æŠŠchå†™å…¥&lt;code>buffer_&lt;/code>ï¼Œå¹¶ä¸”ä½¿ç”¨&lt;code>pbump(1)&lt;/code>å°†&lt;code>pptr()&lt;/code>å‘å‰ç§»ä¸€ä½ã€‚ä¹‹åè°ƒç”¨&lt;code>do_caps_and_flush()&lt;/code>åšä¸€äº›è„æ´»ï¼Œä¹‹åè¿”å›ä¸€ä¸ªå­—ç¬¦å£°æ˜è°ƒç”¨æˆåŠŸã€‚&lt;/p>
&lt;p>&lt;code>sync()&lt;/code>çš„å®ç°ä¹Ÿéå¸¸ç®€å•:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">int&lt;/span> caps_buffer&lt;span style="color:#f92672">::&lt;/span>sync()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#a6e22e">do_caps_and_flush&lt;/span>() &lt;span style="color:#f92672">?&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span> &lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æˆ‘ä»¬å†çœ‹ä¸€çœ‹&lt;code>do_caps_and_flush()&lt;/code>å‡½æ•°&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">bool&lt;/span> caps_buffer&lt;span style="color:#f92672">::&lt;/span>do_caps_and_flush()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">for&lt;/span> (&lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span>p &lt;span style="color:#f92672">=&lt;/span> pbase(), &lt;span style="color:#f92672">*&lt;/span>e &lt;span style="color:#f92672">=&lt;/span> pptr(); p &lt;span style="color:#f92672">!=&lt;/span> e; &lt;span style="color:#f92672">++&lt;/span>p)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (&lt;span style="color:#f92672">*&lt;/span>p &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#e6db74">&amp;#39;.&amp;#39;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> cap_next_ &lt;span style="color:#f92672">=&lt;/span> true;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">else&lt;/span> &lt;span style="color:#a6e22e">if&lt;/span> (std&lt;span style="color:#f92672">::&lt;/span>isalpha(&lt;span style="color:#f92672">*&lt;/span>p))
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (cap_next_)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">*&lt;/span>p &lt;span style="color:#f92672">=&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>toupper(&lt;span style="color:#f92672">*&lt;/span>p);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> cap_next_ &lt;span style="color:#f92672">=&lt;/span> false;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> std&lt;span style="color:#f92672">::&lt;/span>ptrdiff_t n &lt;span style="color:#f92672">=&lt;/span> pptr() &lt;span style="color:#f92672">-&lt;/span> pbase();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> pbump(&lt;span style="color:#f92672">-&lt;/span>n);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> sink_.write(pbase(), n);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯¹äºæœ¬ä¾‹æ¥è¯´ï¼Œå†…éƒ¨çš„ç¼“å†²åŒºå¹¶éå¿…è¦ï¼Œæˆ‘ä»¬å¯ä»¥ä¸€ä¸ªå­—ç¬¦ä¸€ä¸ªå­—ç¬¦æŠŠæ•°æ®å‘åˆ°&lt;code>sink&lt;/code>ä¸­ã€‚ä½†æ˜¯æˆ‘çš„è§‚ç‚¹æ˜¯ä¸€ä¸ªå†…éƒ¨bufferä»æœ‰å…¶ç”¨å¤„ã€‚&lt;/p>
&lt;h3 id="ä»‹ç»-boost-iostreams-åº“">ä»‹ç» Boost IOStreams åº“ &lt;a href="#%e4%bb%8b%e7%bb%8d-boost-iostreams-%e5%ba%93" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;p>å¦‚æœä½ æ˜¯æµç¼“å†²åŒºçš„æ–°æ‰‹ï¼Œå¸Œæœ›ä½ å·²ç»å¯¹å®ƒæœ‰ä¸€ç‚¹ç‚¹äº†è§£äº†ã€‚æœ¬æ–‡ä¸­çš„ä¾‹å­éƒ½éå¸¸åŸºç¡€ï¼Œä½†æ˜¯ä½ å¯ä»¥ç”¨å®ƒä»¬åšæ›´å¤šæœ‰æ„æ€çš„äº‹æƒ…ã€‚ä½†æ˜¯å½“æˆ‘å®ç°æ›´å¤æ‚çš„æµç¼“å†²åŒºæ—¶ï¼Œé—®é¢˜çš„å¤æ‚åº¦å´ä¸Šå‡çš„å¾ˆå¿«ã€‚è¿™æ—¶æˆ‘å‘ç°äº†&lt;code>Boost IOStreams&lt;/code>åº“ï¼Œå®ƒä¸ºæ›´å¤æ‚çš„ç¼“å†²åŒºå’Œæµæä¾›äº†å¿…è¦çš„æ¡†æ¶æ”¯æŒã€‚&lt;/p>
&lt;p>å®ƒå…è®¸ä½ è§£è€¦æ•°æ®æºï¼Œæ•°æ®è¾“å‡ºï¼Œè¿‡æ»¤å™¨ä»¥åŠå…¶å®ƒä¸€äº›æ¦‚å¿µã€‚åœ¨æˆ‘ä»¬çš„æœ€åä¸€ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ç¡¬ç¼–ç æ•°æ®è¾“å‡ºåˆ°&lt;code>std::ostream&lt;/code>ä¸­ã€‚å¦‚æœæˆ‘ä»¬è¦è¾“å‡ºåˆ°ä¸€ä¸ªæ²¡æœ‰æµæ¥å£çš„ç±»å‘¢ï¼Ÿ&lt;code>Boost IOStreams&lt;/code>åº“æä¾›äº†æ›´å¤šçš„çµæ´»æ€§ï¼Œå°†ä¸€å¨ç´§è€¦åˆçš„ä»£ç åˆ†è§£æˆç‹¬ç«‹çš„æŠ½è±¡æ¦‚å¿µã€‚&lt;/p>
&lt;h3 id="æ‰©å±•é˜…è¯»">æ‰©å±•é˜…è¯» &lt;a href="#%e6%89%a9%e5%b1%95%e9%98%85%e8%af%bb" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;ul>
&lt;li>The C++ Standard Library by Nicolai M. Josuttis&lt;/li>
&lt;li>The C++ Standard, BS ISO/IEC 14882:2003 (Second Edition)&lt;/li>
&lt;li>&lt;a href="http://www.dinkumware.com/manuals/">Dinkum Compleat Reference online&lt;/a>&lt;/li>
&lt;/ul></description></item></channel></rss>