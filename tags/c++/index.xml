<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>C++ on Maerlyn's Rainbow</title><link>https://wizmann.top/tags/c++/</link><description>Recent content in C++ on Maerlyn's Rainbow</description><generator>Hugo -- gohugo.io</generator><language>zh-CN</language><lastBuildDate>Fri, 01 Feb 2019 00:00:00 +0000</lastBuildDate><atom:link href="https://wizmann.top/tags/c++/index.xml" rel="self" type="application/rss+xml"/><item><title>C++ç±»å‹æ“¦é™¤ä¸`std::function`æ€§èƒ½æ¢ç´¢</title><link>https://wizmann.top/posts/cpp-type-erasure-and-std-function/</link><pubDate>Fri, 01 Feb 2019 00:00:00 +0000</pubDate><guid>https://wizmann.top/posts/cpp-type-erasure-and-std-function/</guid><description>&lt;h2 id="ä»€ä¹ˆæ˜¯ç±»å‹æ“¦é™¤">ä»€ä¹ˆæ˜¯ç±»å‹æ“¦é™¤ &lt;a href="#%e4%bb%80%e4%b9%88%e6%98%af%e7%b1%bb%e5%9e%8b%e6%93%a6%e9%99%a4" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>å¯¹äºPythonè¿™ç§åŠ¨æ€ç±»å‹è¯­è¨€æ¥è¯´ï¼Œæ˜¯ä¸å­˜åœ¨â€œç±»å‹æ“¦é™¤â€è¿™ä¸ªæ¦‚å¿µçš„ã€‚Pythonå¯¹è±¡çš„è¡Œä¸ºå¹¶ä¸ç”±æ¥å£å®šä¹‰ï¼Œè€Œæ˜¯ç”±â€œå½“å‰æ–¹æ³•å’Œå±æ€§çš„é›†åˆâ€å†³å®šã€‚&lt;/p>
&lt;p>æ‰€ä»¥ï¼Œä»¥ä¸‹çš„ä»£ç æ˜¯å®Œå…¨åˆæ³•çš„ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-python" data-lang="python">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">Foo&lt;/span>(object):
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">def&lt;/span> &lt;span style="color:#a6e22e">print&lt;/span>(self):
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> print &lt;span style="color:#e6db74">&amp;#39;foo&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">Bar&lt;/span>(object):
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">def&lt;/span> &lt;span style="color:#a6e22e">print&lt;/span>(self):
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> print &lt;span style="color:#e6db74">&amp;#39;bar&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">def&lt;/span> &lt;span style="color:#a6e22e">do_print&lt;/span>(obj):
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> print obj&lt;span style="color:#f92672">.&lt;/span>print()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>do_print(Foo()) &lt;span style="color:#f92672">//&lt;/span> print &lt;span style="color:#e6db74">&amp;#39;foo&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>do_print(Bar()) &lt;span style="color:#f92672">//&lt;/span> print &lt;span style="color:#e6db74">&amp;#39;bar&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä½†æ˜¯å¯¹äºC++è¿™ç§é™æ€ç±»å‹è¯­è¨€æ¥è®²ï¼Œæˆ‘ä»¬å°±ä¸èƒ½ä½¿ç”¨è¿™ç§è¯­æ³•ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">Foo&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">public&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">void&lt;/span> print() { cout &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#e6db74">&amp;#34;foo&amp;#34;&lt;/span> &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> endl; }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>};
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">Bar&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">public&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">void&lt;/span> print() { cout &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#e6db74">&amp;#34;bar&amp;#34;&lt;/span> &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> endl; }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>};
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">do_print&lt;/span>(&lt;span style="color:#f92672">???&lt;/span> obj) { &lt;span style="color:#75715e">// &amp;lt;--
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> obj.print();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>do_print(Foo());
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>do_print(Bar());
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç†Ÿæ‚‰C++çš„åŒå­¦ä»¬éƒ½çŸ¥é“ï¼Œå› ä¸º&lt;code>Foo&lt;/code>å’Œ&lt;code>Bar&lt;/code>çš„ç±»å‹ä¸åŒï¼Œæˆ‘ä»¬ä¸èƒ½ç›´æ¥å°†ä¸åŒç±»å‹çš„å®ä¾‹ä¼ å…¥&lt;code>do_print(obj)&lt;/code>å‡½æ•°ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸€ç§æ–¹æ³•æ“¦é™¤ç±»å‹ä¿¡æ¯ï¼Œæä¾›ä¸€ç§ç±»å‹çš„æŠ½è±¡ã€‚ä½¿å¾—å®ç°ä¸ä¾èµ–äºå…·ä½“ç±»å‹ï¼Œè€Œæ˜¯ä¾èµ–äºç±»å‹æŠ½è±¡ã€‚&lt;/p>
&lt;h2 id="cä¸­ç±»å‹æ“¦é™¤çš„å®ç°">C++ä¸­ç±»å‹æ“¦é™¤çš„å®ç° &lt;a href="#c%e4%b8%ad%e7%b1%bb%e5%9e%8b%e6%93%a6%e9%99%a4%e7%9a%84%e5%ae%9e%e7%8e%b0" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;h3 id="ç®€å•ç²—æš´---void">ç®€å•ç²—æš´ - &lt;code>void*&lt;/code> &lt;a href="#%e7%ae%80%e5%8d%95%e7%b2%97%e6%9a%b4---void" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;p>å†™è¿‡Cè¯­è¨€åŒå­¦ä»¬ä¸€å®šéå¸¸ç†Ÿæ‚‰&lt;code>qsort&lt;/code>å‡½æ•°çš„å†™æ³•ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// http://www.cplusplus.com/reference/cstdlib/qsort/
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">int&lt;/span> &lt;span style="color:#a6e22e">compare&lt;/span> (&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#f92672">*&lt;/span> a, &lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#f92672">*&lt;/span> b) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> ( &lt;span style="color:#f92672">*&lt;/span>(&lt;span style="color:#66d9ef">int&lt;/span>&lt;span style="color:#f92672">*&lt;/span>)a &lt;span style="color:#f92672">-&lt;/span> &lt;span style="color:#f92672">*&lt;/span>(&lt;span style="color:#66d9ef">int&lt;/span>&lt;span style="color:#f92672">*&lt;/span>)b );
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">int&lt;/span> &lt;span style="color:#a6e22e">main&lt;/span> () {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">int&lt;/span> values[] &lt;span style="color:#f92672">=&lt;/span> {&lt;span style="color:#ae81ff">1&lt;/span>, &lt;span style="color:#ae81ff">3&lt;/span>, &lt;span style="color:#ae81ff">5&lt;/span>, &lt;span style="color:#ae81ff">2&lt;/span>, &lt;span style="color:#ae81ff">4&lt;/span>, &lt;span style="color:#ae81ff">6&lt;/span>};
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">qsort&lt;/span> (values, &lt;span style="color:#ae81ff">6&lt;/span>, &lt;span style="color:#66d9ef">sizeof&lt;/span>(&lt;span style="color:#66d9ef">int&lt;/span>), compare);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">for&lt;/span> (&lt;span style="color:#66d9ef">int&lt;/span> i&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>; i&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#ae81ff">6&lt;/span>; i&lt;span style="color:#f92672">++&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">printf&lt;/span> (&lt;span style="color:#e6db74">&amp;#34;%d &amp;#34;&lt;/span>,values[n]);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™é‡Œçš„&lt;code>compare(const void*, const void*)&lt;/code>å‡½æ•°å°±æ˜¯Cè¯­è¨€é£æ ¼çš„ç±»å‹æ“¦é™¤ï¼Œå¯ä»¥æ”¯æŒä¸åŒç±»å‹çš„æŒ‡é’ˆç±»å‹ä¼ å…¥ã€‚ä½†æ˜¯ç¼ºé™·æ˜¯åœ¨å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬ä»ç„¶éœ€è¦å°†å·²æ“¦é™¤çš„ç±»å‹æ¢å¤ï¼Œä»¥è¯»å–å…¶ä¸­çš„æ•°æ®ã€‚&lt;/p>
&lt;p>è¿™ç§ç±»å‹æ“¦é™¤æ–¹æ³•ï¼Œå¹¶ä¸ä¼šå¸¦å¼€é¢å¤–çš„å¼€é”€ã€‚ä½†æ˜¯è¿™æ ·çš„å¼ºåˆ¶ç±»å‹éšå«ç€ç±»å‹ä¸åŒ¹é…çš„é£é™©ï¼Œéœ€è¦ç¨‹åºå‘˜æ ¼å¤–æ³¨æ„ã€‚&lt;/p>
&lt;h3 id="é¢å‘å¯¹è±¡çš„ç»å…¸æ–¹æ³•---è™šå‡½æ•°virtual-function">é¢å‘å¯¹è±¡çš„ç»å…¸æ–¹æ³• - è™šå‡½æ•°ï¼ˆvirtual functionï¼‰ &lt;a href="#%e9%9d%a2%e5%90%91%e5%af%b9%e8%b1%a1%e7%9a%84%e7%bb%8f%e5%85%b8%e6%96%b9%e6%b3%95---%e8%99%9a%e5%87%bd%e6%95%b0virtual-function" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;p>C++åšä¸ºCè¯­è¨€çš„è¿›åŒ–ï¼Œå¼•å…¥äº†é¢å‘å¯¹è±¡çš„ç†å¿µã€‚è€Œå¤šæ€ï¼Œåšä¸ºé¢å‘å¯¹è±¡ç¼–ç¨‹çš„ä¸€ä¸ªé‡è¦ç‰¹æ€§ï¼Œä¸ºæˆ‘ä»¬çš„ä»£ç å¸¦æ¥äº†æ›´å¤šçš„å¼¹æ€§ã€‚&lt;/p>
&lt;p>å¯¹äºä¸Šé¢çš„ä¾‹å­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»¥ä¸‹çš„ä»£ç æ¥å®ç°ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">IPrintable&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">public&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">virtual&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> print() &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>};
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">Foo&lt;/span> &lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#66d9ef">public&lt;/span> IPrintable {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">public&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">virtual&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> print() { cout &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#e6db74">&amp;#34;foo&amp;#34;&lt;/span> &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> endl; }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>};
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">Bar&lt;/span> &lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#66d9ef">public&lt;/span> IPrintable {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">public&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">virtual&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> print() { cout &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#e6db74">&amp;#34;bar&amp;#34;&lt;/span> &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> endl; }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>};
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">do_print&lt;/span>(IPrintable&lt;span style="color:#f92672">*&lt;/span> obj) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> obj&lt;span style="color:#f92672">-&amp;gt;&lt;/span>print();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">int&lt;/span> &lt;span style="color:#a6e22e">main&lt;/span>() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> do_print(&lt;span style="color:#66d9ef">new&lt;/span> Foo());
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> do_print(&lt;span style="color:#66d9ef">new&lt;/span> Bar());
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>};
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ä½¿ç”¨äº†ä¸€ä¸ª&lt;code>IPrintable&lt;/code>åŸºç±»ï¼Œæ“¦é™¤äº†å­ç±»&lt;code>Foo&lt;/code>å’Œ&lt;code>Bar&lt;/code>çš„å…·ä½“ç±»å‹ä¿¡æ¯ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåªè¦å­ç±»å®ç°äº†åŸºç±»çš„æ¥å£ï¼Œå°±å¯ä»¥åšä¸ºå‚æ•°ä¼ å…¥&lt;code>do_print(obj)&lt;/code>ä¸­ã€‚è¿™æ ·çš„å¥½å¤„æ˜¯æˆ‘ä»¬åªéœ€è¦ä¸ºç»§æ‰¿åŒæ ·æ¥å£çš„ç±»å‹å®Œæˆä¸€å¥—å®ç°ï¼Œæä¾›äº†æ›´å¥½çš„å°è£…ä¸æŠ½è±¡ã€‚&lt;/p>
&lt;p>ä½†æ˜¯ï¼Œè¿™ç§å®ç°çš„é—®é¢˜åœ¨äºè™šå‡½æ•°çš„è°ƒç”¨æ˜¯æœ‰é¢å¤–çš„å¼€é”€çš„ã€‚éœ€è¦è¿›è¡Œä¸€æ¬¡è¿è¡Œæ—¶è™šè¡¨çš„æŸ¥æ‰¾ï¼Œæ‰å¯ä»¥ç¡®å®šå¯¹è±¡éœ€è¦è°ƒç”¨å“ªä¸€ä¸ªå‡½æ•°ã€‚&lt;/p>
&lt;h3 id="ä½¿ç”¨æ¨¡æ¿template">ä½¿ç”¨æ¨¡æ¿ï¼ˆtemplateï¼‰ &lt;a href="#%e4%bd%bf%e7%94%a8%e6%a8%a1%e6%9d%bftemplate" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;p>C++æä¾›äº†æ¨¡æ¿ï¼Œæ”¯æŒå°†ç±»å‹ä»¥æ¨¡æ¿å‚æ•°å½¢å¼ä¼ å…¥å‚æ•°ã€‚ä½¿å¾—æˆ‘ä»¬å¯ä»¥ä»¥ä¸€ç§ç‹¬ç«‹äºç‰¹å®šç±»å‹çš„æ–¹å¼ç¼–å†™ä»£ç ã€‚&lt;/p>
&lt;p>æˆ‘ä»¬å¯ä»¥æ”¹å†™ä¸Šæ–‡ä¸­çš„&lt;code>do_print(obj)&lt;/code>å‡½æ•°ï¼Œä½¿å…¶å¯ä»¥æ”¯æŒä¸åŒçš„ç±»å‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">template&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">typename&lt;/span> T&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">void&lt;/span> do_print(T obj) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> obj.print();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™é‡Œï¼Œä¼ å…¥å‚æ•°çš„ç±»å‹&lt;code>T&lt;/code>æ— éœ€ç»§æ‰¿&lt;code>IPrintable&lt;/code>æ¥å£ï¼Œåªè¦å…¶å®ç°äº†&lt;code>print()&lt;/code>æˆå‘˜å‡½æ•°å³å¯åšä¸ºå¯¹è±¡ä¼ å…¥ã€‚&lt;/p>
&lt;p>C++æ¨¡æ¿çš„ç±»å‹æ“¦é™¤ä½œç”¨äºç¼–è¯‘æœŸï¼Œå¯ä»¥å°½æ—©çš„å‘ç°é£é™©ï¼ŒåŒæ—¶ï¼ˆä¸€èˆ¬æ¥è¯´ï¼‰ä¸å½±å“è¿è¡Œæ—¶çš„æ€§èƒ½ã€‚&lt;/p>
&lt;blockquote>
&lt;p>æ³¨æ„ï¼šJava/C#çš„æ³›å‹(generic)è¯­æ³•ä¸C++çš„æ¨¡æ¿éå¸¸ç±»ä¼¼ï¼Œä½†æ˜¯Java/C#çš„æ³›å‹æ˜¯ä½œç”¨äºè¿è¡Œæ—¶çš„ã€‚è¿™é‡Œæ³¨æ„åŒºåˆ†äºŒè€…çš„åŒºåˆ«ã€‚&lt;/p>&lt;/blockquote>
&lt;p>ä½†æ˜¯æ¨¡æ¿ä¹Ÿæœ‰å…¶å±€é™æ€§ã€‚æ¨¡æ¿æœ‰éšå«çš„æ¥å£è¯­ä¹‰ï¼Œä½†æ˜¯ç”±äºæ¨¡æ¿æ‰€ä½¿ç”¨çš„å¯¹è±¡å¹¶æ²¡æœ‰å…±åŒçš„åŸºç±»ï¼ˆæ¥å£ï¼‰ï¼Œæ‰€ä»¥å®ƒä¸èƒ½ä½¿ç”¨ä¸€ä¸ªç»Ÿä¸€çš„å®¹å™¨æ¥å‚¨å­˜å¯¹è±¡ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">???&lt;/span> objs[] &lt;span style="color:#f92672">=&lt;/span> { &lt;span style="color:#66d9ef">new&lt;/span> &lt;span style="color:#a6e22e">Foo&lt;/span>(), &lt;span style="color:#66d9ef">new&lt;/span> Bar() };
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="cç±»å‹æ“¦é™¤å®æˆ˜--stdfunction">C++ç±»å‹æ“¦é™¤å®æˆ˜ â€”â€” &lt;code>std::function&lt;/code> &lt;a href="#c%e7%b1%bb%e5%9e%8b%e6%93%a6%e9%99%a4%e5%ae%9e%e6%88%98--stdfunction" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>åœ¨Cè¯­è¨€ä¸­ï¼Œæˆ‘ä»¬è¦è¡¨ç¤ºä¸€ä¸ªå‡½æ•°å¯¹è±¡åªèƒ½ä½¿ç”¨å‡½æ•°æœ¬èº«ä»¥åŠå‡½æ•°æŒ‡é’ˆã€‚ä½†æ˜¯åœ¨C++ä¸­ï¼Œæˆ‘ä»¬æœ‰äº†æ›´å¤šçš„é€‰æ‹©ï¼š&lt;/p>
&lt;ul>
&lt;li>å‡½æ•°&lt;/li>
&lt;li>inline lambda&lt;/li>
&lt;li>å‡½æ•°æŒ‡é’ˆï¼ˆC-styleï¼‰&lt;/li>
&lt;li>ä»¿å‡½æ•°ï¼ˆfactor classï¼‰&lt;/li>
&lt;li>&lt;code>std::bind&lt;/code>&lt;/li>
&lt;li>&lt;code>std::function&lt;/code>&lt;/li>
&lt;/ul>
&lt;p>ä¸Šé¢çš„è¿™äº›å¯¹è±¡ï¼Œæˆ‘ä»¬å¯ä»¥ç»Ÿç§°ä¸ºå¯è°ƒç”¨ï¼ˆcallableï¼‰å¯¹è±¡ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ç±»ä¼¼&lt;code>f(obj)&lt;/code>çš„è¯­æ³•ï¼Œä»¥å‡½æ•°å½¢å¼è°ƒç”¨è¿™äº›å¯¹è±¡ã€‚&lt;/p>
&lt;p>æ€è€ƒä»¥ä¸‹çš„åœºæ™¯ï¼šæˆ‘ä»¬æƒ³è¦å®ç°ä¸€ä¸ªå›è°ƒå‡½æ•°ã€‚è¿™ä¸ªå‡½æ•°æ˜¯ç”¨æˆ·å®šä¹‰çš„ï¼Œå¯ä»¥æ˜¯ä»¥ä¸Šå¯è°ƒç”¨å¯¹è±¡çš„ä»»æ„ä¸€ç§ã€‚é‚£ä¹ˆæˆ‘ä»¬åº”è¯¥ç”¨ä»€ä¹ˆç±»å‹æ¥è¡¨ç¤ºè¿™ä¸ªå›è°ƒå‡½æ•°å¯¹è±¡å‘¢ï¼Ÿ&lt;/p>
&lt;p>æ˜¯çš„ï¼Œç­”æ¡ˆå°±æ˜¯&lt;code>std::function&lt;/code>ã€‚C++ä¸­çš„&lt;code>std::function&lt;/code>ä¸ºæˆ‘ä»¬æä¾›äº†å¯¹å¯è°ƒç”¨å¯¹è±¡çš„æŠ½è±¡ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨&lt;code>std::function&lt;/code>å°è£…å¯è°ƒç”¨å¯¹è±¡ï¼Œä»è€Œæ“¦é™¤å…¶ç±»å‹ä¿¡æ¯ï¼Œä½¿ç”¨ç»Ÿä¸€çš„æ–¹æ³•å¯¹å…¶è¿›è¡Œè°ƒç”¨ã€‚&lt;/p>
&lt;p>è¯·å‚è€ƒä»¥ä¸‹ä»£ç ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// http://www.cplusplus.com/reference/functional/function/function/
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;iostream&amp;gt;&lt;/span>&lt;span style="color:#75715e"> &lt;/span>&lt;span style="color:#75715e">// std::cout
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;functional&amp;gt;&lt;/span>&lt;span style="color:#75715e"> &lt;/span>&lt;span style="color:#75715e">// std::function, std::negate
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// a function:
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">int&lt;/span> &lt;span style="color:#a6e22e">half&lt;/span>(&lt;span style="color:#66d9ef">int&lt;/span> x) {&lt;span style="color:#66d9ef">return&lt;/span> x&lt;span style="color:#f92672">/&lt;/span>&lt;span style="color:#ae81ff">2&lt;/span>;}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// a function object class:
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">struct&lt;/span> &lt;span style="color:#a6e22e">third_t&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">int&lt;/span> &lt;span style="color:#a6e22e">operator&lt;/span>()(&lt;span style="color:#66d9ef">int&lt;/span> x) {&lt;span style="color:#66d9ef">return&lt;/span> x&lt;span style="color:#f92672">/&lt;/span>&lt;span style="color:#ae81ff">3&lt;/span>;}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>};
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// a class with data members:
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">struct&lt;/span> &lt;span style="color:#a6e22e">MyValue&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">int&lt;/span> value;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">int&lt;/span> &lt;span style="color:#a6e22e">fifth&lt;/span>() {&lt;span style="color:#66d9ef">return&lt;/span> value&lt;span style="color:#f92672">/&lt;/span>&lt;span style="color:#ae81ff">5&lt;/span>;}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>};
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">int&lt;/span> &lt;span style="color:#a6e22e">main&lt;/span> () {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> std&lt;span style="color:#f92672">::&lt;/span>function&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">int&lt;/span>(&lt;span style="color:#66d9ef">int&lt;/span>)&lt;span style="color:#f92672">&amp;gt;&lt;/span> fn1 &lt;span style="color:#f92672">=&lt;/span> half; &lt;span style="color:#75715e">// function
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>function&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">int&lt;/span>(&lt;span style="color:#66d9ef">int&lt;/span>)&lt;span style="color:#f92672">&amp;gt;&lt;/span> fn2 &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#f92672">&amp;amp;&lt;/span>half; &lt;span style="color:#75715e">// function pointer
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>function&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">int&lt;/span>(&lt;span style="color:#66d9ef">int&lt;/span>)&lt;span style="color:#f92672">&amp;gt;&lt;/span> fn3 &lt;span style="color:#f92672">=&lt;/span> third_t(); &lt;span style="color:#75715e">// function object
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>function&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">int&lt;/span>(&lt;span style="color:#66d9ef">int&lt;/span>)&lt;span style="color:#f92672">&amp;gt;&lt;/span> fn4 &lt;span style="color:#f92672">=&lt;/span> [](&lt;span style="color:#66d9ef">int&lt;/span> x){&lt;span style="color:#66d9ef">return&lt;/span> x&lt;span style="color:#f92672">/&lt;/span>&lt;span style="color:#ae81ff">4&lt;/span>;}; &lt;span style="color:#75715e">// lambda expression
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>function&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">int&lt;/span>(&lt;span style="color:#66d9ef">int&lt;/span>)&lt;span style="color:#f92672">&amp;gt;&lt;/span> fn5 &lt;span style="color:#f92672">=&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>negate&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">int&lt;/span>&lt;span style="color:#f92672">&amp;gt;&lt;/span>(); &lt;span style="color:#75715e">// standard function object
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> std&lt;span style="color:#f92672">::&lt;/span>cout &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#e6db74">&amp;#34;fn1(60): &amp;#34;&lt;/span> &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> fn1(&lt;span style="color:#ae81ff">60&lt;/span>) &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#e6db74">&amp;#39;\n&amp;#39;&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> std&lt;span style="color:#f92672">::&lt;/span>cout &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#e6db74">&amp;#34;fn2(60): &amp;#34;&lt;/span> &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> fn2(&lt;span style="color:#ae81ff">60&lt;/span>) &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#e6db74">&amp;#39;\n&amp;#39;&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> std&lt;span style="color:#f92672">::&lt;/span>cout &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#e6db74">&amp;#34;fn3(60): &amp;#34;&lt;/span> &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> fn3(&lt;span style="color:#ae81ff">60&lt;/span>) &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#e6db74">&amp;#39;\n&amp;#39;&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> std&lt;span style="color:#f92672">::&lt;/span>cout &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#e6db74">&amp;#34;fn4(60): &amp;#34;&lt;/span> &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> fn4(&lt;span style="color:#ae81ff">60&lt;/span>) &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#e6db74">&amp;#39;\n&amp;#39;&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> std&lt;span style="color:#f92672">::&lt;/span>cout &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#e6db74">&amp;#34;fn5(60): &amp;#34;&lt;/span> &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> fn5(&lt;span style="color:#ae81ff">60&lt;/span>) &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#e6db74">&amp;#39;\n&amp;#39;&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// stuff with members:
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>function&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">int&lt;/span>(MyValue&lt;span style="color:#f92672">&amp;amp;&lt;/span>)&lt;span style="color:#f92672">&amp;gt;&lt;/span> value &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#f92672">&amp;amp;&lt;/span>MyValue&lt;span style="color:#f92672">::&lt;/span>value; &lt;span style="color:#75715e">// pointer to data member
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>function&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">int&lt;/span>(MyValue&lt;span style="color:#f92672">&amp;amp;&lt;/span>)&lt;span style="color:#f92672">&amp;gt;&lt;/span> fifth &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#f92672">&amp;amp;&lt;/span>MyValue&lt;span style="color:#f92672">::&lt;/span>fifth; &lt;span style="color:#75715e">// pointer to member function
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> MyValue sixty {&lt;span style="color:#ae81ff">60&lt;/span>};
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> std&lt;span style="color:#f92672">::&lt;/span>cout &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#e6db74">&amp;#34;value(sixty): &amp;#34;&lt;/span> &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> value(sixty) &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#e6db74">&amp;#39;\n&amp;#39;&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> std&lt;span style="color:#f92672">::&lt;/span>cout &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#e6db74">&amp;#34;fifth(sixty): &amp;#34;&lt;/span> &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> fifth(sixty) &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#e6db74">&amp;#39;\n&amp;#39;&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="stdfunctionçš„ç¼ºé™·">&lt;code>std::function&lt;/code>çš„ç¼ºé™· &lt;a href="#stdfunction%e7%9a%84%e7%bc%ba%e9%99%b7" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;p>&lt;code>std::function&lt;/code>çš„ç±»å‹æ“¦é™¤åŠŸèƒ½å¼‚å¸¸å¼ºå¤§ï¼Œå‡ ä¹å¯ä»¥å°è£…æ‰€æœ‰çš„å¯è°ƒç”¨ç±»å‹ã€‚ä½†æ˜¯ï¼Œè¯­æ³•ä¸Šé¢çš„ä¾¿åˆ©å´ä¼šå¸¦æ¥äº†æ€§èƒ½ä¸Šçš„æŸå¤±ã€‚&lt;/p>
&lt;p>ä»&lt;a href="https://gist.github.com/Wizmann/30073037f31d796efd6f42798dd85aee">benchmark&lt;/a>ç»“æœä¸Šæˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œåœ¨&lt;code>O2&lt;/code>çš„ä¼˜åŒ–å‚æ•°ä¸‹ï¼Œå‡½æ•°è°ƒç”¨ï¼ˆåŒ…æ‹¬å‡½æ•°ã€å‡½æ•°æ¨¡æ¿å’Œä»¿å‡½æ•°ï¼‰ã€å‡½æ•°æŒ‡é’ˆå’Œlambdaçš„æ€§èƒ½ç›¸ä»¿ã€‚è€Œè™šå‡½æ•°å¤§æ¦‚éœ€è¦èŠ±è´¹5å€å·¦å³çš„æ—¶é—´ï¼Œè€Œ&lt;code>std::function&lt;/code>åˆ™éœ€è¦èŠ±è´¹6å€ä»¥ä¸Šçš„æ—¶é—´ã€‚å¯¹äºä¸€ä¸ªä¼šè¢«ç»å¸¸è°ƒç”¨åˆ°çš„å‡½æ•°ï¼Œå¸¦æ¥çš„é¢å¤–çš„æ€§èƒ½å¼€é”€æ˜¯ä¸å¯ä»¥å¿½ç•¥çš„ã€‚&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>method&lt;/th>
&lt;th style="text-align: right">Linux (Azure VM, E5-2673 v3, -O0)&lt;/th>
&lt;th style="text-align: right">Linux (Azure VM, E5-2673 v3, -O2)&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>Function&lt;/td>
&lt;td style="text-align: right">12.4s&lt;/td>
&lt;td style="text-align: right">1.2s&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Function Ptr&lt;/td>
&lt;td style="text-align: right">13.5s&lt;/td>
&lt;td style="text-align: right">1.2s&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Inline Lambda&lt;/td>
&lt;td style="text-align: right">12.7s&lt;/td>
&lt;td style="text-align: right">1.2s&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Virtual Function&lt;/td>
&lt;td style="text-align: right">14.1s&lt;/td>
&lt;td style="text-align: right">6.3s&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>std::function&lt;/td>
&lt;td style="text-align: right">77.3s&lt;/td>
&lt;td style="text-align: right">7.2s&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>ç©¶å…¶åŸå› ï¼Œæ˜¯ç”±äº&lt;code>std::function&lt;/code>çš„æ¨¡æ¿å‚æ•°ä¸­åªæä¾›äº†å‚æ•°ç±»å‹å’Œè¿”å›å€¼ç±»å‹ï¼Œæ‰€ä»¥ä¸ºäº†è¿›è¡Œç±»å‹æ“¦é™¤ï¼Œå…¶ä¸­å†…ç½®äº†ä¸€ä¸ªè™šå‡½æ•°ã€‚æ‰€ä»¥ä¸€æ¬¡&lt;code>std::function&lt;/code>è°ƒç”¨ä¼šå¼•å‘éšå¼çš„å¤šæ¬¡å‡½æ•°è°ƒç”¨ï¼Œå…¶ä¸­è¿˜åŒ…å«ç€ä¸€æ¬¡è™šå‡½æ•°çš„è°ƒç”¨ã€‚æ‰€ä»¥æ€§èƒ½ä¸‹é™ä¹Ÿå°±ä¸éš¾è§£é‡Šäº†ã€‚&lt;/p>
&lt;h3 id="è§£å†³æ–¹æ¡ˆ">è§£å†³æ–¹æ¡ˆ &lt;a href="#%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;p>å¯ä»¥ç¡®å®šçš„æ˜¯ï¼Œé™¤éå¿…è¦ï¼Œä¸è¦ä½¿ç”¨&lt;code>std::function&lt;/code>ã€‚&lt;/p>
&lt;p>ä¾‹å¦‚ï¼Œåœ¨&lt;code>std::sort&lt;/code>ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨æ¨¡æ¿ä¼ å…¥å¯è°ƒç”¨ç±»å‹ï¼Œè¿™æ ·å°±å¯ä»¥é¿å…&lt;code>std::function&lt;/code>çš„é¢å¤–å¼€é”€ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">template&lt;/span>&lt;span style="color:#f92672">&amp;lt;&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">RandomIt&lt;/span>, &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">Compare&lt;/span> &lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">void&lt;/span> sort( RandomIt first, RandomIt last, Compare comp );
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>åˆä¾‹å¦‚æˆ‘ä»¬å¯ä»¥é¿å…ä½¿ç”¨ä¸åŒçš„å¯è°ƒç”¨ç±»å‹æ¥è§„é¿ç±»å‹æ“¦é™¤ï¼Œå¦‚ç»Ÿä¸€ä½¿ç”¨å‡½æ•°æŒ‡é’ˆã€‚åœ¨C++14ä¹‹åï¼Œinline lambdaä¹Ÿå¯ä»¥è¡¨ç¤ºä¸ºå‡½æ•°æŒ‡é’ˆï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡é—­åŒ…æ¥å°è£…å…¶å®ƒçš„å¯è°ƒç”¨å¯¹è±¡äº†ã€‚&lt;/p>
&lt;p>å½“ç„¶ï¼Œä¹Ÿå¯ä»¥è‡ªå·±é€ ä¸ª&lt;a href="https://codereview.stackexchange.com/questions/14730/impossibly-fast-delegate-in-c11">è½®å­&lt;/a>ï¼Œè¿™å°±åˆæ˜¯å¦ä¸€ä¸ªæ•…äº‹äº†ã€‚&lt;/p>
&lt;h2 id="å†™åœ¨æœ€å">å†™åœ¨æœ€å &lt;a href="#%e5%86%99%e5%9c%a8%e6%9c%80%e5%90%8e" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>æ–°çš„C++è§„èŒƒç»™æˆ‘ä»¬å¸¦æ¥äº†å¾ˆå¤šçš„è¯­æ³•ç³–ã€‚å¯¹äºä¼ ç»ŸC++ç¨‹åºå‘˜æ¥è¯´ï¼Œå¥½å¤„åœ¨äºæˆ‘ä»¬å¯ä»¥å†™å‡ºæ›´èˆ’æœçš„ï¼Œæ›´ç¬¦åˆç›´è§‰çš„ä»£ç ï¼Œä½†ç¼ºç‚¹æ˜¯æˆ‘ä»¬éœ€è¦äº†è§£æ›´å¤šè¯­è¨€èƒŒåçš„ä¸œè¥¿ã€‚æ‰€ä»¥å¯¹äºè‡ªå·±ä¸ç†Ÿæ‚‰çš„æ–°å¼è¯­æ³•ï¼Œæ— è®ºçœ‹èµ·æ¥å¤šä¹ˆè¯±äººï¼Œä¹Ÿéœ€è¦å¤šåŠ è°¨æ…ã€‚&lt;/p>
&lt;h2 id="å‚è€ƒé“¾æ¥">å‚è€ƒé“¾æ¥ &lt;a href="#%e5%8f%82%e8%80%83%e9%93%be%e6%8e%a5" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;ul>
&lt;li>&lt;a href="https://gist.github.com/Wizmann/30073037f31d796efd6f42798dd85aee">Benchmark for &amp;ldquo;function pointer&amp;rdquo;, &amp;ldquo;virtual function&amp;rdquo; and &amp;ldquo;std::function&amp;rdquo;&lt;/a>&lt;/li>
&lt;li>&lt;a href="http://www.modernescpp.com/index.php/c-core-guidelines-type-erasure">C++ Core Guidelines: Type Erasure&lt;/a>&lt;/li>
&lt;li>&lt;a href="http://davekilian.com/cpp-type-erasure.html">C++ &amp;lsquo;Type Erasure&amp;rsquo; Explained&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>ä¸€ç§åŒºé—´äº¤é—®é¢˜çš„å¥‡æ€ªå§¿åŠ¿</title><link>https://wizmann.top/posts/range-problem/</link><pubDate>Tue, 20 Feb 2018 22:59:47 +0000</pubDate><guid>https://wizmann.top/posts/range-problem/</guid><description>&lt;blockquote>
&lt;p>Update[220504]: åŸæ¥è¿™ç§æ•°æ®ç»“æ„å«&lt;a href="https://oi-wiki.org/ds/odt/">ç‚æœµè‰æ ‘&lt;/a>å•Šï¼ŒçœŸç¥å¥‡ã€‚ã€‚ã€‚&lt;/p>&lt;/blockquote>
&lt;h2 id="æˆ‘ä»¬è¦è§£å†³ä»€ä¹ˆé—®é¢˜">æˆ‘ä»¬è¦è§£å†³ä»€ä¹ˆé—®é¢˜ &lt;a href="#%e6%88%91%e4%bb%ac%e8%a6%81%e8%a7%a3%e5%86%b3%e4%bb%80%e4%b9%88%e9%97%ae%e9%a2%98" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>åŒºé—´äº¤é—®é¢˜ï¼Œæ˜¯æˆ‘ä»¬åœ¨åšé¢˜ä¸­ç»å¸¸é‡åˆ°çš„é—®é¢˜ã€‚&lt;/p>
&lt;p>ä¾‹å¦‚ï¼Œ&lt;a href="https://leetcode.com/problems/insert-interval/description/">Insert Interval&lt;/a>ä¸€é¢˜ï¼Œå°±æ˜¯æ¯”è¾ƒç›´ç™½çš„åŒºé—´äº¤é—®é¢˜ï¼š&lt;/p>
&lt;blockquote>
&lt;p>ç»™å®šä¸€ç³»åˆ—çš„æ•´æ•°åŒºé—´ï¼Œå†æ’å…¥ä¸€ä¸ªæ–°çš„åŒºé—´ï¼Œé—®åˆå¹¶åçš„æ•´æ•°åŒºé—´æ˜¯ä»€ä¹ˆ&lt;/p>&lt;/blockquote>
&lt;p>ç±»ä¼¼çš„è¿˜æœ‰&lt;a href="https://leetcode.com/problems/merge-intervals/description/">Merge Intervals&lt;/a>ï¼š&lt;/p>
&lt;blockquote>
&lt;p>ç»™å®šä¸€ç³»åˆ—å¯èƒ½æœ‰é‡å çš„æ•´æ•°åŒºé—´ï¼Œæ±‚åˆå¹¶åçš„æ•´æ•°åŒºé—´&lt;/p>&lt;/blockquote>
&lt;p>å¦ä¸€ç§åŒºé—´äº¤é—®é¢˜çš„æè¿°æ˜¯æ—¶é—´åŒºé—´ç›¸å…³çš„é—®é¢˜ï¼Œå¦‚&lt;a href="http://lintcode.com/en/problem/time-intersection/">Time Intersection&lt;/a>:&lt;/p>
&lt;blockquote>
&lt;p>ç»™å®šç”¨æˆ·Aå’Œç”¨æˆ·Bçš„åœ¨çº¿æ—¶é—´åŒºé—´ï¼Œé—®ä¸¤äººåŒæ—¶åœ¨çº¿çš„æ—¶é—´åŒºé—´&lt;/p>&lt;/blockquote>
&lt;p>åˆå¦‚ç»å…¸çš„ä¼šè®®å®¤å®‰æ’é—®é¢˜&lt;a href="https://segmentfault.com/a/1190000003894670">Meeting Rooms&lt;/a>å’Œ&lt;a href="http://www.cnblogs.com/grandyang/p/5244720.html">Meeting Rooms II&lt;/a>:&lt;/p>
&lt;blockquote>
&lt;p>ç»™å®šNä¸ªä¼šè®®çš„æ—¶é—´åŒºé—´ï¼Œé—®ä¸€ä¸ªäººèƒ½å¦å‚åŠ æ‰€æœ‰çš„ä¼šè®®&lt;/p>&lt;/blockquote>
&lt;p>ä»¥åŠ&lt;/p>
&lt;blockquote>
&lt;p>ç»™å®šNä¸ªä¼šè®®çš„æ—¶é—´åŒºé—´ï¼Œé—®æœ€å°‘éœ€è¦å¤šå°‘ä¸ªä¼šè®®å®¤&lt;/p>&lt;/blockquote>
&lt;p>è¿˜æœ‰ç³»ç»Ÿè®¾è®¡ä¸APIè®¾è®¡åŒ…è£…åçš„ç®—æ³•é¢˜&lt;a href="https://leetcode.com/problems/range-module/description/">Range Module&lt;/a>ã€‚å½’æ ¹ç»“åº•ï¼Œéƒ½æ˜¯æ•´æ•°åŒºé—´é—®é¢˜çš„å˜å½¢æˆ–è€…åŒ…è£…ã€‚&lt;/p>
&lt;h2 id="ä¼ ç»Ÿè§£æ³•">ä¼ ç»Ÿè§£æ³• &lt;a href="#%e4%bc%a0%e7%bb%9f%e8%a7%a3%e6%b3%95" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>å¯¹äºè¿™ç±»åŒºé—´é—®é¢˜ï¼Œä¼ ç»Ÿçš„è§£æ³•æ˜¯å°†åŒºé—´ä½¿ç”¨é¡ºåºå®¹å™¨ï¼ˆå¦‚&lt;code>vector&lt;/code>ï¼‰ä¿å­˜ï¼Œåœ¨æŸ¥è¯¢å’Œä¿®æ”¹æ—¶ï¼Œä½¿ç”¨â€œæ’åº+éå†â€æˆ–è€…â€œæ’åº+äºŒåˆ†â€ã€‚&lt;/p>
&lt;p>è¿™ç§è§£å†³åœ¨ä¸€å®šç¨‹åº¦ä¸Šæ˜¯åŒºé—´é—®é¢˜çš„é€šè§£ï¼Œä½†æ˜¯è¿™æ ·åšä¹Ÿæœ‰å®ƒçš„é—®é¢˜ã€‚&lt;/p>
&lt;p>ä¸€æ¥åŒºé—´é—®é¢˜æœ‰å¾ˆå¤šå¯¹åŒºé—´åºåˆ—è¿›è¡Œéšæœºå¢åŠ ã€åˆ é™¤ï¼Œè¿™æ ·çš„æ“ä½œå¯¹äºé¡ºåºå®¹å™¨æ˜¯éå¸¸ä¸å‹å¥½çš„ã€‚&lt;/p>
&lt;p>äºŒæ¥å¯¹äºä½¿ç”¨â€œèµ·ç‚¹â€æˆ–â€œç»ˆç‚¹â€æ’åºçš„åŒºé—´ï¼ŒäºŒåˆ†æŸ¥æ‰¾éœ€è¦å¤„ç†å¾ˆå¤šé‡å¤å€¼ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ä¼šå‘ç”Ÿå¤æ‚åº¦çš„é€€åŒ–ã€‚&lt;/p>
&lt;p>é‚£ä¹ˆæˆ‘ä»¬å¦‚ä½•ä¼˜åŒ–æˆ‘ä»¬çš„å®ç°æ¥è§£å†³ä»¥ä¸Šçš„é—®é¢˜å‘¢ï¼Ÿ&lt;/p>
&lt;h2 id="ä½¿ç”¨stdsetinterval">ä½¿ç”¨&lt;code>std::set&amp;lt;Interval&amp;gt;&lt;/code> &lt;a href="#%e4%bd%bf%e7%94%a8stdsetinterval" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>æˆ‘ä»¬ä»¥&lt;a href="https://leetcode.com/problems/merge-intervals/description/">Merge Intervals&lt;/a>ä¸€é¢˜ä¸ºä¾‹ã€‚åªè¦ä¸¤ä¸ªåŒºé—´æœ‰äº¤é›†ï¼Œæ— è®ºæ˜¯å“ªä¸€ç§å½¢å¼çš„ç›¸äº¤ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦æŠŠè¿™ä¸¤ä¸ªåŒºé—´åˆå¹¶ã€‚&lt;/p>
&lt;p>&lt;img src="https://github.com/Wizmann/assets/raw/master/wizmann-pic/18-2-20/85403056.jpg" alt="">&lt;/p>
&lt;p>æ‰€ä»¥ï¼Œæˆ‘ä»¬åªéœ€è¦èƒ½é«˜æ•ˆçš„åˆ¤æ–­ä¸¤ä¸ªåŒºé—´&lt;strong>æ˜¯å¦ç›¸äº¤&lt;/strong>ï¼Œå°±å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜äº†ã€‚&lt;/p>
&lt;p>ä½†æ˜¯åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬åå…¶é“è€Œè¡Œä¹‹ï¼Œå…ˆæ¥è®¨è®ºä¸€ä¸‹&lt;strong>ä¸ç›¸äº¤&lt;/strong>çš„æƒ…å†µã€‚å¯¹äºä¸¤ä¸ªä¸ç›¸äº¤çš„åŒºé—´&lt;code>A&lt;/code>å’Œ&lt;code>B&lt;/code>ï¼Œåªå­˜åœ¨ä¸¤ç§æƒ…å†µï¼Œä¸€æ˜¯&lt;code>A&lt;/code>åœ¨&lt;code>B&lt;/code>å·¦é¢ï¼ŒäºŒæ˜¯&lt;code>A&lt;/code>åœ¨&lt;code>B&lt;/code>å³é¢ã€‚&lt;/p>
&lt;p>&lt;img src="https://github.com/Wizmann/assets/raw/master/wizmann-pic/18-2-20/87075632.jpg" alt="">&lt;/p>
&lt;p>æˆ‘ä»¬å¯ä»¥æŠŠåŒºé—´çš„å·¦å³å…³ç³»çœ‹æˆä¸ç›¸äº¤åŒºé—´çš„é¡ºåºå…³ç³»ï¼Œå³ï¼š&lt;/p>
&lt;ul>
&lt;li>å¦‚æœåŒºé—´&lt;code>A&lt;/code>åœ¨åŒºé—´&lt;code>B&lt;/code>çš„â€œå·¦è¾¹â€ï¼Œæˆ‘ä»¬è¯´&lt;code>A &amp;lt; B&lt;/code>&lt;/li>
&lt;li>å¦‚æœåŒºé—´&lt;code>A&lt;/code>åœ¨åŒºé—´&lt;code>B&lt;/code>çš„â€œå³è¾¹â€ï¼Œæˆ‘ä»¬è¯´&lt;code>A &amp;gt; B&lt;/code>&lt;/li>
&lt;/ul>
&lt;p>æ‰€ä»¥ï¼Œæ ¹æ®ä¸ç›¸äº¤åŒºé—´çš„æ€§è´¨ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆè‡ªç„¶çš„å°†å®ƒä»¬å­˜å‚¨åœ¨&lt;code>std::set&amp;lt;Interval&amp;gt;&lt;/code>å½“ä¸­ã€‚è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åœ¨&lt;code>O(logN)&lt;/code>æ—¶é—´è¿›è¡ŒæŸ¥æ‰¾ã€éšæœºæ’å…¥ä¸éšæœºåˆ é™¤ã€‚&lt;/p>
&lt;p>é‚£ä¹ˆï¼Œå›åˆ°æœ€å¼€å§‹åˆ¤æ–­åŒºé—´&lt;strong>æ˜¯å¦ç›¸äº¤&lt;/strong>çš„é—®é¢˜ã€‚å¯¹äºç›¸äº¤çš„åŒºé—´&lt;code>A&lt;/code>å’Œ&lt;code>B&lt;/code>ï¼Œéå¸¸æ˜æ˜¾ï¼Œ&lt;code>A &amp;lt; B&lt;/code>ä¸&lt;code>A &amp;gt; B&lt;/code>éƒ½æ˜¯ä¸æˆç«‹çš„ã€‚åœ¨&lt;code>std::set&amp;lt;Interval&amp;gt;&lt;/code>ä¸­ï¼Œè¿™ç§å…³ç³»è¢«åˆ¤å®šä¸º&lt;strong>ç›¸ç­‰&lt;/strong>ã€‚&lt;/p>
&lt;p>è™½ç„¶è¿™ç§&lt;strong>ç›¸ç­‰&lt;/strong>å…³ç³»æ˜¯ä¸ç¬¦åˆå¸¸è§„é€»è¾‘çš„ï¼Œä½†æ˜¯å´éå¸¸å®ç”¨ã€‚å¦‚æœä¸¤ä¸ªåŒºé—´æœ‰â€œå¤§å°â€å…³ç³»ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“åŒºé—´çš„ç›¸å¯¹ä½ç½®ã€‚è€Œå¦‚æœä¸¤ä¸ªåŒºé—´â€œç›¸ç­‰â€ï¼Œåˆ™æˆ‘ä»¬å¯ä»¥çŸ¥é“ä¸¤ä¸ªåŒºé—´ä¸€å®šç›¸äº¤ã€‚æ›´é‡è¦çš„æ˜¯ï¼Œåœ¨è¿™ç±»é¢˜ç›®ä¸­ï¼Œä¸¤ä¸ªç›¸äº¤çš„åŒºé—´æ˜¯ä¸èƒ½åŒæ—¶å­˜åœ¨çš„ã€‚è¿™ä¸&lt;code>std::set&amp;lt;Interval&amp;gt;&lt;/code>ä¸­å…ƒç´ çš„å”¯ä¸€æ€§ç›¸å‘¼åº”ã€‚&lt;/p>
&lt;p>æ‰€ä»¥ï¼Œåœ¨ä½¿ç”¨&lt;code>std::set&amp;lt;Interval&amp;gt;&lt;/code>æ¥å­˜å‚¨åŒºé—´æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¦‚ä¸‹çš„æ€§è´¨ï¼š&lt;/p>
&lt;ul>
&lt;li>ä½¿ç”¨&lt;code>find()&lt;/code>å‡½æ•°æ¥æŸ¥æ‰¾ç›¸äº¤åŒºé—´ã€‚è¿™é‡Œè¦æ³¨æ„ï¼Œç›¸äº¤çš„åŒºé—´å¯èƒ½æœ‰å¤šä¸ª&lt;/li>
&lt;li>ä½¿ç”¨&lt;code>insert()&lt;/code>æ¥æ’å…¥åŒºé—´ã€‚è¿™é‡Œè¦æ³¨æ„ï¼Œå…ˆè¦åˆ¤æ–­æ˜¯å¦æœ‰åŒºé—´ä¸æ–°æ’å…¥çš„åŒºé—´ç›¸äº¤&lt;/li>
&lt;li>ä½¿ç”¨&lt;code>erase()&lt;/code>æ¥åˆ é™¤åŒºé—´ã€‚&lt;/li>
&lt;/ul>
&lt;h2 id="å®æˆ˜---merge-intervals">å®æˆ˜ - Merge Intervals &lt;a href="#%e5%ae%9e%e6%88%98---merge-intervals" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;blockquote>
&lt;p>åœ¨Merge Intervalsä¸€é¢˜ä¸­ä½¿ç”¨std::set&lt;Interval>å¹¶ä¸æ˜¯æœ€ä¼˜çš„è§£æ³•ã€‚è¿™é‡Œåªåšä¸¾ä¾‹ã€‚&lt;/p>&lt;/blockquote>
&lt;p>é¢˜ç›®é“¾æ¥ï¼š&lt;a href="https://leetcode.com/problems/merge-intervals/description/">Merge Intervals&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">/**
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * Definition for an interval.
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * struct Interval {
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * int start;
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * int end;
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * Interval() : start(0), end(0) {}
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * Interval(int s, int e) : start(s), end(e) {}
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * };
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// overload the comparator for std::set
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">bool&lt;/span> &lt;span style="color:#66d9ef">operator&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span> (&lt;span style="color:#66d9ef">const&lt;/span> Interval&lt;span style="color:#f92672">&amp;amp;&lt;/span> i1, &lt;span style="color:#66d9ef">const&lt;/span> Interval&lt;span style="color:#f92672">&amp;amp;&lt;/span> i2) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> i1.end &lt;span style="color:#f92672">&amp;lt;&lt;/span> i2.start;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">Solution&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">public&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> vector&lt;span style="color:#f92672">&amp;lt;&lt;/span>Interval&lt;span style="color:#f92672">&amp;gt;&lt;/span> merge(vector&lt;span style="color:#f92672">&amp;lt;&lt;/span>Interval&lt;span style="color:#f92672">&amp;gt;&amp;amp;&lt;/span> intervals) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> set&lt;span style="color:#f92672">&amp;lt;&lt;/span>Interval&lt;span style="color:#f92672">&amp;gt;&lt;/span> st;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">for&lt;/span> (&lt;span style="color:#66d9ef">auto&lt;/span> interval: intervals) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// merge intervals which are overlaped
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">while&lt;/span> (true) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">auto&lt;/span> iter &lt;span style="color:#f92672">=&lt;/span> st.find(interval);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (iter &lt;span style="color:#f92672">==&lt;/span> st.end()) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">break&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> };
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> interval &lt;span style="color:#f92672">=&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> min(interval.start, iter&lt;span style="color:#f92672">-&amp;gt;&lt;/span>start),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> max(interval.end, iter&lt;span style="color:#f92672">-&amp;gt;&lt;/span>end)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> };
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> st.erase(iter);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// add the new interval to std::set
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> st.insert(interval);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// copy the intervals to a vector
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> vector&lt;span style="color:#f92672">&amp;lt;&lt;/span>Interval&lt;span style="color:#f92672">&amp;gt;&lt;/span> result;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> copy(st.begin(), st.end(), back_inserter(result));
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> result;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>};
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¸Šé¢çš„ä»£ç ä¸­ï¼Œ&lt;code>std::set&amp;lt;Interval&amp;gt;&lt;/code>ä¸­å­˜å‚¨äº†å·²ç»åˆå¹¶å¥½çš„åŒºé—´ã€‚å½“åŠ å…¥æ–°çš„åŒºé—´æ—¶ï¼Œæˆ‘ä»¬ä¼šå…ˆåˆ¤æ–­æ–°åŒºé—´æ˜¯å¦ä¸å·²æœ‰åŒºé—´ç›¸å…³ï¼Œå¦‚æœç›¸äº¤ï¼Œåˆ™è¿›è¡Œåˆå¹¶ã€‚&lt;/p>
&lt;h2 id="å®æˆ˜---range-module">å®æˆ˜ - Range Module &lt;a href="#%e5%ae%9e%e6%88%98---range-module" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>é¢˜ç›®é“¾æ¥ï¼š&lt;a href="https://leetcode.com/problems/range-module/description/">Range Module&lt;/a>&lt;/p>
&lt;blockquote>
&lt;p>é¢˜æ„ï¼š &lt;br>
è®¾è®¡ä¸€ä¸ªç±»ï¼Œæä¾›ä¸‰ä¸ªæ¥å£ï¼š &lt;br>&lt;br>
æ¥å£1ï¼š&lt;code>void addRange(int left, int right)&lt;/code> &lt;br>
å°†åŒºé—´&lt;code>[left, right - 1]&lt;/code>åŠ å…¥åŒºé—´é›†åˆ &lt;br>&lt;br>
æ¥å£2ï¼š&lt;code>bool queryRange(int left, int right)&lt;/code> &lt;br>
æŸ¥è¯¢æ˜¯å¦å·²æœ‰åŒºé—´ä¸åŒºé—´&lt;code>[left, right - 1]&lt;/code>ç›¸äº¤ &lt;br>&lt;br>
æ¥å£3ï¼š&lt;code>void removeRange(int left, int right)&lt;/code>
ç§»é™¤å·²æœ‰åŒºé—´å†…ï¼Œä½äº&lt;code>[left, right - 1]&lt;/code>èŒƒå›´å†…çš„æ‰€æœ‰æ•°&lt;/p>&lt;/blockquote>
&lt;p>è¿™ä¸ªé¢˜ç›®çœ‹ä¼¼å¯ä»¥å®Œå…¨å¥—ç”¨æˆ‘ä»¬ä¸Šé¢è®²åˆ°çš„&lt;code>std::set&amp;lt;Interval&amp;gt;&lt;/code>çš„å®ç°ï¼Œä½†æ˜¯è¿™é‡Œæœ‰å‡ ä¸ªæš—å‘éœ€è¦æ³¨æ„ã€‚&lt;/p>
&lt;p>é¦–å…ˆæˆ‘ä»¬æ¥çœ‹æ¥å£3ï¼Œè¿™é‡Œçš„åˆ é™¤å¹¶ä¸æ˜¯åˆ é™¤åŒºé—´ï¼Œè€Œæ˜¯åˆ é™¤æ•´æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä½¿ç”¨&lt;code>find()&lt;/code>å‡½æ•°ï¼Œä½†æ˜¯ä¸ä¹‹å‰çš„åˆå¹¶æ“ä½œä¸åŒï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œè¦åˆ é™¤åŒºé—´ä¸­çš„ä¸€éƒ¨åˆ†ã€‚&lt;/p>
&lt;p>åœ¨åˆ é™¤æ•´æ•°æ“ä½œè¿›è¡Œå®Œä¹‹åï¼Œä¼šå¼•å…¥ä¸€ä¸ªæ–°é—®é¢˜ï¼Œè¿™å°±æ˜¯ä¸€äº›è¿ç»­çš„æ•´æ•°åŒºé—´ï¼Œä¼šåœ¨&lt;code>std::set&amp;lt;Interval&amp;gt;&lt;/code>ä¸­è¡¨ç°ä¸ºç‹¬ç«‹çš„å¤šä¸ªåŒºé—´ã€‚ä¾‹å¦‚ï¼ŒåŒºé—´&lt;code>[1, 5]&lt;/code>ï¼Œåœ¨åˆ é™¤äº†&lt;code>[2, 3]&lt;/code>ä¹‹åï¼Œä¼šå½¢æˆä¸¤ä¸ªåŒºé—´&lt;code>[1, 1]&lt;/code> å’Œ &lt;code>[4, 5]&lt;/code>ã€‚æˆ‘ä»¬å†æŠŠåŒºé—´&lt;code>[2, 3]&lt;/code>åŠ å›æ¥ï¼Œå¦‚æœä¸è¿›è¡Œç‰¹æ®Šæ“ä½œï¼Œå°±ä¼šäº§ç”Ÿä¸‰ä¸ªä¸ç›¸äº¤ä½†è¿ç»­çš„åŒºé—´&lt;code>[1, 1]&lt;/code>ã€&lt;code>[2, 3]&lt;/code>å’Œ&lt;code>[4, 5]&lt;/code>ã€‚æ‰€ä»¥æˆ‘ä»¬åœ¨æ’å…¥åŒºé—´æ—¶ï¼Œè¦å¤šåšä¸€æ­¥åŒºé—´åˆå¹¶çš„æ“ä½œã€‚&lt;/p>
&lt;p>å…·ä½“çš„å®ç°ä¸ºï¼š&lt;/p>
&lt;ol>
&lt;li>åœ¨æ’å…¥åŒºé—´&lt;code>[l, r]&lt;/code>ä¹‹å‰ï¼Œå…ˆæŸ¥æ‰¾æ˜¯ä¸å­˜åœ¨åŒºé—´åŒ…å«&lt;code>[l - 1, l - 1]&lt;/code>æˆ–&lt;code>[r + 1, r + 1]&lt;/code>ã€‚å¦‚æœæœ‰ï¼Œåˆ™å…ˆå°†å·²æœ‰çš„ç›¸é‚»åŒºé—´åˆå¹¶çš„æ–°åŒºé—´é‡Œ&lt;/li>
&lt;li>å°†æ–°çš„åŒºé—´è¿›è¡Œåˆå¹¶æ“ä½œï¼Œæ’å…¥&lt;code>std::set&amp;lt;Interval&amp;gt;&lt;/code>&lt;/li>
&lt;/ol>
&lt;p>æ­£ç¡®æ€§è¯æ˜ï¼š&lt;/p>
&lt;ul>
&lt;li>å·²çŸ¥1ï¼šç©ºåŒºé—´é›†åˆä¸åŒ…å«&lt;strong>ä¸ç›¸äº¤ä½†è¿ç»­çš„åŒºé—´&lt;/strong>&lt;/li>
&lt;li>å·²çŸ¥2ï¼šåªæœ‰æ’å…¥æ“ä½œä¼šäº§ç”Ÿ&lt;strong>ä¸ç›¸äº¤ä½†è¿ç»­çš„åŒºé—´&lt;/strong>&lt;/li>
&lt;li>å½’çº³å‡è®¾ï¼šæˆ‘ä»¬ä¿è¯åœ¨ä»»ä½•æ’å…¥æ–°åŒºé—´çš„æ“ä½œä¹‹å‰ï¼Œ&lt;code>std::set&amp;lt;Interval&amp;gt;&lt;/code>ä¸­å‡ä¸åŒ…å«&lt;strong>ä¸ç›¸äº¤ä½†è¿ç»­çš„åŒºé—´&lt;/strong>ã€‚&lt;/li>
&lt;li>è¯æ˜ï¼š&lt;br>
å¦‚æœåŒºé—´é›†åˆå†…ä¸åŒ…å«&lt;strong>ä¸ç›¸äº¤ä½†è¿ç»­çš„åŒºé—´&lt;/strong>ï¼Œé‚£ä¹ˆå¯¹äºæ–°åŠ åŒºé—´ï¼Œæˆ‘ä»¬åªéœ€è¦å°è¯•åˆå¹¶å…¶è¿‘é‚»åŒºé—´&lt;code>[l - 1, l - 1]&lt;/code>å’Œ&lt;code>[r + 1, r + 1]&lt;/code>ï¼Œå°±ä¸ä¼šäº§ç”Ÿ&lt;strong>ä¸ç›¸äº¤ä½†è¿ç»­çš„åŒºé—´&lt;/strong>ã€‚&lt;/li>
&lt;/ul>
&lt;p>ä»£ç å®ç°å¦‚ä¸‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">struct&lt;/span> &lt;span style="color:#a6e22e">MyInterval&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">int&lt;/span> left, right;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">bool&lt;/span> &lt;span style="color:#66d9ef">operator&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span> (&lt;span style="color:#66d9ef">const&lt;/span> MyInterval&lt;span style="color:#f92672">&amp;amp;&lt;/span> other) &lt;span style="color:#66d9ef">const&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>right &lt;span style="color:#f92672">&amp;lt;&lt;/span> other.left;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>};
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">RangeModule&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">public&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> RangeModule() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// pass
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">addRange&lt;/span>(&lt;span style="color:#66d9ef">int&lt;/span> left, &lt;span style="color:#66d9ef">int&lt;/span> right) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> right &lt;span style="color:#f92672">-=&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> MyInterval ll &lt;span style="color:#f92672">=&lt;/span> {left &lt;span style="color:#f92672">-&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>, left &lt;span style="color:#f92672">-&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>};
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">auto&lt;/span> liter &lt;span style="color:#f92672">=&lt;/span> st.find(ll);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (liter &lt;span style="color:#f92672">!=&lt;/span> st.end()) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> left &lt;span style="color:#f92672">=&lt;/span> liter&lt;span style="color:#f92672">-&amp;gt;&lt;/span>left;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> MyInterval rr &lt;span style="color:#f92672">=&lt;/span> {right &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>, right &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>};
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">auto&lt;/span> riter &lt;span style="color:#f92672">=&lt;/span> st.find(rr);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (riter &lt;span style="color:#f92672">!=&lt;/span> st.end()) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> right &lt;span style="color:#f92672">=&lt;/span> riter&lt;span style="color:#f92672">-&amp;gt;&lt;/span>right;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> doAddRange(left, right);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">doAddRange&lt;/span>(&lt;span style="color:#66d9ef">int&lt;/span> left, &lt;span style="color:#66d9ef">int&lt;/span> right) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> MyInterval newInterval &lt;span style="color:#f92672">=&lt;/span> {left, right};
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">while&lt;/span> (true) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">auto&lt;/span> iter &lt;span style="color:#f92672">=&lt;/span> st.find(newInterval);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (iter &lt;span style="color:#f92672">==&lt;/span> st.end()) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">break&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> newInterval.left &lt;span style="color:#f92672">=&lt;/span> min(newInterval.left, iter&lt;span style="color:#f92672">-&amp;gt;&lt;/span>left);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> newInterval.right &lt;span style="color:#f92672">=&lt;/span> max(newInterval.right, iter&lt;span style="color:#f92672">-&amp;gt;&lt;/span>right);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> st.erase(iter);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> st.insert(newInterval);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">bool&lt;/span> &lt;span style="color:#a6e22e">queryRange&lt;/span>(&lt;span style="color:#66d9ef">int&lt;/span> left, &lt;span style="color:#66d9ef">int&lt;/span> right) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> right &lt;span style="color:#f92672">-=&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> MyInterval interval &lt;span style="color:#f92672">=&lt;/span> {left, right};
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">auto&lt;/span> iter &lt;span style="color:#f92672">=&lt;/span> st.find(interval);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (iter &lt;span style="color:#f92672">==&lt;/span> st.end()) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> false;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> iter&lt;span style="color:#f92672">-&amp;gt;&lt;/span>left &lt;span style="color:#f92672">&amp;lt;=&lt;/span> left &lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span> right &lt;span style="color:#f92672">&amp;lt;=&lt;/span> iter&lt;span style="color:#f92672">-&amp;gt;&lt;/span>right;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">removeRange&lt;/span>(&lt;span style="color:#66d9ef">int&lt;/span> left, &lt;span style="color:#66d9ef">int&lt;/span> right) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> right &lt;span style="color:#f92672">-=&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> MyInterval newInterval &lt;span style="color:#f92672">=&lt;/span> {left, right};
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">while&lt;/span> (true) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">auto&lt;/span> iter &lt;span style="color:#f92672">=&lt;/span> st.find(newInterval);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (iter &lt;span style="color:#f92672">==&lt;/span> st.end()) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">break&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">auto&lt;/span> cur &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#f92672">*&lt;/span>iter;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> st.erase(iter);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (cur.left &lt;span style="color:#f92672">&amp;lt;&lt;/span> newInterval.left) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> st.insert({cur.left, newInterval.left &lt;span style="color:#f92672">-&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>});
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (cur.right &lt;span style="color:#f92672">&amp;gt;&lt;/span> newInterval.right) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> st.insert({newInterval.right &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>, cur.right});
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">private&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> set&lt;span style="color:#f92672">&amp;lt;&lt;/span>MyInterval&lt;span style="color:#f92672">&amp;gt;&lt;/span> st;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>};
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>å®šæ—¶å™¨ä»¥åŠå…¶å®ƒ - phxrpcé˜…è¯»ç¬”è®°(2)</title><link>https://wizmann.top/posts/phxrpc-2/</link><pubDate>Thu, 29 Sep 2016 01:28:09 +0000</pubDate><guid>https://wizmann.top/posts/phxrpc-2/</guid><description>&lt;h2 id="å†™åœ¨å‰é¢">å†™åœ¨å‰é¢ &lt;a href="#%e5%86%99%e5%9c%a8%e5%89%8d%e9%9d%a2" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>phxrpcä½¿ç”¨äº†åç¨‹(ucontext)å’ŒIOå¤ç”¨æŠ€æœ¯(epoll)æ¥å®ç°ç½‘ç»œé€šä¿¡ã€‚å®šæ—¶å™¨åœ¨å…¶ä¸­èµ·åˆ°äº†éå¸¸é‡è¦çš„ä½œç”¨ã€‚ä¸‹é¢æˆ‘ä»¬å°±æ¥åˆ†æä¸€ä¸‹phxrpcçš„&lt;code>timer.[h|cpp]&lt;/code>ä¸­çš„ä»£ç ã€‚&lt;/p>
&lt;h2 id="system_clock-vs-steady_clock">system_clock vs steady_clock &lt;a href="#system_clock-vs-steady_clock" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>&lt;code>system_clock&lt;/code>å’Œ&lt;code>steadly_clock&lt;/code>éƒ½æ˜¯æ¥è‡ª&lt;code>&amp;lt;chrono&amp;gt;&lt;/code>åº“ï¼Œéƒ½æ˜¯ç”¨æ¥è·å–å½“å‰æ—¶é—´çš„ã€‚&lt;/p>
&lt;p>&lt;code>system_clock&lt;/code>ç”¨æ¥ä»ç³»ç»Ÿæ—¶é’Ÿè·å–æ—¶é’Ÿæ—¶é—´(wall clock time)ï¼Œè€Œ&lt;code>steadly_clock&lt;/code>è·å–çš„æ˜¯æ—¶é’Ÿtickï¼Œè€Œä¸”ä¿è¯éšç€æ—¶é—´çš„æ¨ç§»ï¼Œæ—¶é’Ÿtickæ•°ä¸ä¼šå˜å°ã€‚&lt;/p>
&lt;p>ç„¶è€Œå®é™…ä¸Šï¼Œåœ¨æŸäº›ç³»ç»Ÿä¸‹ï¼Œè¿™ä¸¤ä¸ªæ—¶é’Ÿçš„å®ç°æ˜¯ä¸€è‡´çš„ã€‚è¯¦ç»†ä¿¡æ¯å¯ä»¥å‚è€ƒ&lt;a href="http://stackoverflow.com/questions/13263277/difference-between-stdsystem-clock-and-stdsteady-clock">è¿™é‡Œ&lt;/a>ã€‚&lt;/p>
&lt;blockquote>
&lt;p>æ³¨ï¼šåœ¨clang++ 4.2.1, g++ 5.4 ä¸‹å®éªŒï¼Œè¿™ä¸¤ä¸ªæ—¶é’Ÿæ˜¯ä¸åŒçš„ã€‚æ‰€ä»¥ä¸ªäººè®¤ä¸ºåœ¨è¿™é‡Œæœ€å¥½ä¸è¦åšä»»ä½•æ— æ„ä¹‰çš„å‡è®¾ã€‚&lt;/p>&lt;/blockquote>
&lt;h2 id="å‡ æ¯«ç§’çš„å®‰ç¡">å‡ æ¯«ç§’çš„å®‰ç¡ &lt;a href="#%e5%87%a0%e6%af%ab%e7%a7%92%e7%9a%84%e5%ae%89%e7%9d%a1" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">void&lt;/span> Timer &lt;span style="color:#f92672">::&lt;/span> MsSleep(&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> time_ms) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> timespec t;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> t.tv_sec &lt;span style="color:#f92672">=&lt;/span> time_ms &lt;span style="color:#f92672">/&lt;/span> &lt;span style="color:#ae81ff">1000&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> t.tv_nsec &lt;span style="color:#f92672">=&lt;/span> (time_ms &lt;span style="color:#f92672">%&lt;/span> &lt;span style="color:#ae81ff">1000&lt;/span>) &lt;span style="color:#f92672">*&lt;/span> &lt;span style="color:#ae81ff">1000000&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">int&lt;/span> ret &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">do&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ret &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#f92672">::&lt;/span>nanosleep(&lt;span style="color:#f92672">&amp;amp;&lt;/span>t, &lt;span style="color:#f92672">&amp;amp;&lt;/span>t);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> } &lt;span style="color:#66d9ef">while&lt;/span> (ret &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span> &lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span> errno &lt;span style="color:#f92672">==&lt;/span> EINTR);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™é‡Œphxrpcä½¿ç”¨äº†&lt;code>nanosleep&lt;/code>å®ç°äº†é«˜ç²¾åº¦çš„sleepã€‚&lt;/p>
&lt;p>æ³¨æ„è¿™é‡Œçš„ç”¨æ³•ï¼Œç”±äº&lt;code>nanosleep&lt;/code>å¯èƒ½è¢«ä¿¡å·ä¸­æ–­ï¼Œæ­¤æ—¶errnoè¢«è®¾ä¸º&lt;code>EINTR&lt;/code>ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦è¿›è¡Œé¢å¤–çš„åˆ¤æ–­ã€‚å½“nanosleepè¢«ä¿¡å·ä¸­æ–­æ—¶ï¼Œä¼šæŠŠå‰©ä½™æ—¶é—´å†™å…¥ç¬¬äºŒä¸ªå‚æ•°æŒ‡å‘çš„&lt;code>timespec&lt;/code>å˜é‡ä¸­ï¼Œä¹‹åæˆ‘ä»¬å†æ¬¡è°ƒç”¨&lt;code>nanosleep&lt;/code>ï¼Œå°±å¯ä»¥æŠŠå‰©ä½™çš„æ—¶é—´å†ç¡ä¸€ä¸ªå›ç¬¼è§‰äº†ã€‚&lt;/p>
&lt;h2 id="å¯åˆ é™¤ä¼˜å…ˆé˜Ÿåˆ—">å¯åˆ é™¤ä¼˜å…ˆé˜Ÿåˆ— &lt;a href="#%e5%8f%af%e5%88%a0%e9%99%a4%e4%bc%98%e5%85%88%e9%98%9f%e5%88%97" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>è¿™ä¸ªè®¾è®¡ä¸€é¢—èµ›è‰‡å•Šã€‚&lt;/p>
&lt;p>å¯¹äº&lt;code>std::priority_queue&lt;/code>ä»¥åŠå¤§å¤šæ•°æ‰‹å†™çš„ä¼˜å…ˆé˜Ÿåˆ—ï¼ˆåˆç§°å †ï¼Œheapï¼‰ã€‚ä¸€èˆ¬åªæœ‰&lt;code>top()&lt;/code>, &lt;code>push()&lt;/code>, &lt;code>pop()&lt;/code>è¿™ä¸‰ä¸ªæ“ä½œæ¥å£ï¼Œå¦‚æœæƒ³å®ç°åˆ é™¤æ“ä½œï¼Œå¤§å¤šæ•°æƒ…å†µï¼ˆä¸ºäº†å·æ‡’ï¼‰ä¼šæŠŠ&lt;code>std::priority_queue&lt;/code>æ›¿æ¢ä¸º&lt;code>std::set&lt;/code>ã€‚&lt;code>std::set&lt;/code>çš„å†…éƒ¨å®ç°æ˜¯å¹³è¡¡æ ‘ï¼ˆç¡®åˆ‡çš„è¯´ï¼Œçº¢é»‘æ ‘ï¼‰ï¼Œå¯ä»¥å®ç°è·å¾—æœ€å¤§æœ€å°å€¼ï¼ŒæŸ¥æ‰¾æŸä¸ªå€¼ï¼Œä»¥åŠåˆ é™¤æŸä¸ªå€¼çš„æ“ä½œã€‚&lt;/p>
&lt;p>ä½†æ˜¯&lt;code>std::priority_queue&lt;/code>ï¼ˆæˆ–è€…ç”¨æ•°ç»„æˆ–vectorå®ç°çš„å †ï¼‰æ˜¯é¡ºåºå®¹å™¨(sequence containers)ï¼Œè€Œ&lt;code>std::set&lt;/code>æ˜¯å…³è”å®¹å™¨(associative containers)ã€‚ç›¸å¯¹æ¥è¯´ï¼Œç”±äºcacheçš„åŸå› ï¼Œé¡ºåºå®¹å™¨çš„æ€§èƒ½æ¯”å…³è”å®¹å™¨è¦å¥½ã€‚å½“ç„¶æˆ‘æ‰¯å¾—æœ‰ç‚¹è¿œäº†ã€‚å¯¹æ­¤æ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥å»å‚è€ƒã€ŠEffective STLã€‹ä¸€ä¹¦ã€‚&lt;/p>
&lt;p>åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬çš„éœ€æ±‚æ˜¯è¿™æ ·çš„ï¼š&lt;/p>
&lt;ul>
&lt;li>å †æ˜¯å°æ ¹å †ï¼ŒæŒ‰è¶…æ—¶æ—¶é—´å¢åº&lt;/li>
&lt;li>å †ä¸­çš„å…ƒç´ æ˜¯socketæè¿°ç¬¦&lt;code>UThreadSocket_t&lt;/code>&lt;/li>
&lt;li>æ ¹æ®æè¿°ç¬¦ï¼Œæˆ‘ä»¬å¯ä»¥åˆ é™¤å †ä¸­çš„ä»»æ„å…ƒç´ &lt;/li>
&lt;/ul>
&lt;p>å¦‚æœæˆ‘ä»¬æœ‰æ¸…é†’çš„å¤´è„‘ï¼Œå°±ä¼šè®¤ä¸ºè¿™ä¸ªéœ€æ±‚æ˜¯ä¸å¥½å®ç°çš„ã€‚åˆ é™¤å †ä¸­å…ƒç´ å¹¶ä¸å¤æ‚ï¼Œåªéœ€è¦å°†å †ä¸­æœ€åä¸€ä¸ªå…ƒç´ æ”¾åˆ°è¢«åˆ é™¤å…ƒç´ çš„ä½ç½®ä¸Šï¼Œç„¶åå†æ‰§è¡Œä¸€æ¬¡&lt;code>heap_down()&lt;/code>æ“ä½œå°±å¯ä»¥äº†ã€‚é—®é¢˜åœ¨äºæˆ‘ä»¬å¾ˆéš¾ç¡®å®šæŸä¸€ä¸ªå…ƒç´ çš„å…·ä½“ä½ç½®ã€‚&lt;/p>
&lt;blockquote>
&lt;p>æƒ³ä¸€æƒ³ï¼Œå †ä¸­çš„æ•°æ®æ˜¯å¦‚ä½•ç»„ç»‡çš„ã€‚å¦‚æœæƒ³æ‰¾åˆ°æŸä¸€ä¸ªç‰¹å®šçš„å€¼ï¼Œé™¤äº†éå†ä¹‹å¤–ï¼Œè¿˜æœ‰æ²¡æœ‰å…¶å®ƒçš„æ–¹æ³•ã€‚&lt;/p>&lt;/blockquote>
&lt;p>è¿™é‡Œphxrpcä½¿ç”¨äº†ä¸€ç§ä¾µå…¥å¼çš„æ‰‹æ®µï¼Œå°†ä¸‹æ ‡å†™å…¥å †ä¸­å…ƒç´ ã€‚ç„¶åå †å¤–æŒæœ‰æŒ‡é’ˆã€‚ç„¶ååœ¨ç»´æŠ¤å †æ€§è´¨çš„æ—¶å€™ï¼ŒåŒæ­¥æ›´æ–°å †ä¸­å…ƒç´ ï¼Œä½¿å…¶ä¸­ä¿å­˜çš„ä¸‹æ ‡ä¸å…¶åœ¨å †ä¸­çš„ä¸‹æ ‡ä¸€è‡´ã€‚&lt;/p>
&lt;p>è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡æŒ‡é’ˆæ‹¿åˆ°ç›¸åº”å…ƒç´ çš„ä¸‹æ ‡ï¼Œåˆ é™¤æ“ä½œä¹Ÿå˜å¾—ç®€å•äº†èµ·æ¥ã€‚&lt;/p>
&lt;p>é‚£ä¹ˆä¾µå…¥å¼å †ä¸‹æ ‡æœ‰ä»€ä¹ˆé—®é¢˜å—ï¼Ÿä¸€æ¥æˆ‘ä»¬å¯¹äºå…ƒç´ çš„æŸ¥æ‰¾åªèƒ½æ ¹æ®å®¹å™¨å¤–æŒæœ‰çš„æŒ‡é’ˆæ¥è¿›è¡Œï¼Œå¹¶ä¸èƒ½åƒ&lt;code>std::set&lt;/code>é‚£æ ·é€šè¿‡æ¯”è¾ƒå…³ç³»æ¥æŸ¥æ‰¾ã€‚äºŒæ¥ä¾µå…¥å¼ä¸‹æ ‡éœ€è¦é¢å¤–çš„å†…å­˜ç©ºé—´ï¼Œå¯¹äºå°å‹å¯¹è±¡ä¼šé€ æˆå¯è§‚æ¯”ä¾‹çš„overheadã€‚åŒæ—¶å®¹å™¨å†…åªèƒ½æŒæœ‰å…ƒç´ æŒ‡é’ˆï¼Œåœ¨æŸç§ç¨‹åº¦ä¸Šä¼šå¸¦æ¥é¢å¤–çš„å¯»å€å¼€é”€ã€‚&lt;/p>
&lt;p>ä¸è¿‡ï¼Œè¿™å¤§æ¦‚ä¹Ÿæ˜¯è®©å †æ”¯æŒåˆ é™¤çš„å”¯ä¸€æ–¹æ³•äº†ã€‚&lt;/p>
&lt;h2 id="å°å°åæ§½">å°å°åæ§½ &lt;a href="#%e5%b0%8f%e5%b0%8f%e5%90%90%e6%a7%bd" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>è¿™æ®µä»£ç å†™çš„ï¼Œè²Œä¼¼è€¦åˆçš„å¤ªç´§äº†ä¸€ç‚¹ã€‚&lt;code>class Timer&lt;/code>å†…éƒ¨æä¾›çš„åŠŸèƒ½æœ‰&lt;/p>
&lt;ol>
&lt;li>å¾—åˆ°å½“å‰æ—¶é—´&lt;/li>
&lt;li>nanosleep&lt;/li>
&lt;li>å°è£…&lt;code>TimerObj&lt;/code>ç±»&lt;/li>
&lt;li>ç»´æŠ¤ä¸€ä¸ªå®šæ—¶å™¨å †ï¼Œæä¾›&lt;code>top()&lt;/code>, &lt;code>push()&lt;/code>, &lt;code>pop()&lt;/code>, &lt;code>erase()&lt;/code>åŠŸèƒ½ï¼Œå¹¶ä¸”å¤§å¤šæ•°æ“ä½œéƒ½æ˜¯ç¡¬ç¼–ç çš„&lt;/li>
&lt;/ol>
&lt;p>è‡³å°‘åœ¨æˆ‘çœ‹æ¥ï¼Œè¿™å¹¶ä¸ç¬¦åˆâ€œé«˜å†…èšï¼Œä½è€¦åˆâ€ä»£ç é£æ ¼ã€‚&lt;/p>
&lt;p>ä½ é—®æˆ‘ä¸ºå•¥ä¸ç»™æ”¹æ”¹ï¼Ÿ&lt;/p>
&lt;p>å› ä¸ºä»–ä»¬æ²¡å†™æµ‹è¯•å•Šï¼&lt;/p>
&lt;p>&lt;img src="https://github.com/Wizmann/assets/raw/master/wizmann-pic/16-9-29/12309965.jpg" alt="">&lt;/p>
&lt;h2 id="è¡¥å……">è¡¥å…… &lt;a href="#%e8%a1%a5%e5%85%85" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>å…¶å®å¯¹äº&lt;code>class Timer&lt;/code>ï¼Œphxrpcæ˜¯æœ‰å†™æµ‹è¯•çš„(test_timer.cpp)ã€‚ä½†æ˜¯è¿™ä¸ªä»£ç å†™çš„å°±æ›´è¿·äº†ã€‚è¿™é‡Œå†åˆ†æä¸€ä¸‹ã€‚&lt;/p>
&lt;p>ä¸€å¼€å§‹ï¼Œå…ˆåˆ›å»º100ä¸ªtimerï¼Œsleepæ—¶é—´éšæœºã€‚ç„¶åå°†50ä¸ªtimeræ”¾å…¥&lt;code>need_remove&lt;/code>æ•°ç»„ä¸­ã€‚&lt;/p>
&lt;p>ä¹‹åæ¯åˆ ä¸€ä¸ªtimerï¼Œå°±é…å¥—ç¡åˆ°è¶…æ—¶æ—¶é—´popä¸€ä¸ªtimerã€‚å¼¹å‡ºè¶…æ—¶timeråï¼Œå†åˆ¤æ–­ä¸€ä¸‹æ—¶é—´è¯¯å·®æ˜¯å¦è¶…è¿‡10msï¼Œå¦‚æœæ˜¯ï¼Œå°±æŠ¥é”™ã€‚&lt;/p>
&lt;p>è¿™ã€‚ã€‚ã€‚&lt;/p>
&lt;p>&lt;img src="https://github.com/Wizmann/assets/raw/master/wizmann-pic/16-9-29/43591449.jpg" alt="">&lt;/p></description></item><item><title>è‡ªå®šä¹‰ä½ çš„stream buffer - phxrpcé˜…è¯»ç¬”è®°(1)</title><link>https://wizmann.top/posts/phxrpc-1/</link><pubDate>Wed, 28 Sep 2016 22:35:55 +0000</pubDate><guid>https://wizmann.top/posts/phxrpc-1/</guid><description>&lt;h2 id="å†™åœ¨å‰é¢">å†™åœ¨å‰é¢ &lt;a href="#%e5%86%99%e5%9c%a8%e5%89%8d%e9%9d%a2" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>&lt;a href="https://github.com/tencent-wechat/phxrpc">phxrpc&lt;/a>æ˜¯å¾®ä¿¡å›¢é˜Ÿå¼€æºçš„ä¸€ä¸ªè½»é‡çº§RPCæ¡†æ¶ã€‚&lt;/p>
&lt;p>æˆ‘å¯¹RPCè¿™äº›ä¸œè¥¿äº†è§£ä¸å¤šï¼Œçœ‹åˆ°phxrpcçš„ä»£ç ç›¸å¯¹ç®€å•ï¼Œè€Œä¸”è¿˜åœ¨åˆæ­¥å¼€å‘é˜¶æ®µï¼ˆåœ¨æœ¬æ–‡å†™ä½œæ—¶ï¼Œç‰ˆæœ¬å·æ˜¯0.8ï¼‰ã€‚æ‰€ä»¥æƒ³è¯»ä¸€è¯»ï¼Œæé«˜ä¸€ä¸‹å§¿åŠ¿æ°´å¹³ã€‚&lt;/p>
&lt;p>å°±æ˜¯è¿™æ ·ã€‚&lt;/p>
&lt;h2 id="è‡ªå®šä¹‰stream-buffer">è‡ªå®šä¹‰stream buffer &lt;a href="#%e8%87%aa%e5%ae%9a%e4%b9%89stream-buffer" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>&lt;code>network/socket_stream_base.[h|cpp]&lt;/code>ä¸­çš„&lt;code>class BaseTcpStreamBuf&lt;/code>ç»§æ‰¿äº†&lt;code>std::streambuf&lt;/code>ï¼Œè‡ªå®šä¹‰äº†ä¸€ä¸ªæµç¼“å†²åŒºï¼Œç”¨äºæ¥æ”¶/å‘é€TCPæ•°æ®åŒ…ã€‚&lt;/p>
&lt;p>è¿™ä¸ªç”¨æ³•æ¯”è¾ƒæ–°é¢–ï¼ˆæˆ–è€…æ˜¯æˆ‘è§è¯†å°‘ï¼‰ï¼Œç½‘ä¸Šçš„èµ„æ–™ä¹Ÿä¸å¤šã€‚è¿™é‡Œç¿»è¯‘ä¸€ç¯‡&lt;a href="http://www.mr-edd.co.uk/blog/beginners_guide_streambuf">ä»‹ç»æ–‡ç« &lt;/a>ï¼Œå­¦ä¹ ä¸€ä¸‹æ–°å§¿åŠ¿ã€‚&lt;/p>
&lt;h2 id="a-beginners-guide-to-writing-a-custom-stream-buffer">A beginner&amp;rsquo;s guide to writing a custom stream buffer &lt;a href="#a-beginners-guide-to-writing-a-custom-stream-buffer" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>æµ(streams)æ˜¯STLä¸­æä¾›çš„ä¸€ä¸ªé‡è¦çš„æŠ½è±¡æ¦‚å¿µã€‚è‘—åçš„â€œHello worldâ€ç¨‹åºï¼Œä¾¿æ˜¯ä½¿ç”¨äº†std::coutå°†å­—ç¬¦ä¸²å†™å…¥æ ‡å‡†è¾“å‡ºæµ(stdout)ã€‚&lt;/p>
&lt;p>æµå½“ç„¶å¯ä»¥åšæ¯”cin/coutæ›´æœ‰æ„æ€çš„äº‹ã€‚è¿™ç¯‡æ–‡ç« æˆ‘ä»¬ä¼šç ”ç©¶å¦‚ä½•æ‰©å±•C++æµï¼Œæ¥å®ç°è‡ªå®šä¹‰çš„æµç¼“å†²åŒº(stream buffer)ã€‚p.s. å»ºè®®æœ¬æ–‡çš„è¯»è€…è‡³å°‘è¦æœ‰åŸºç¡€çš„C++çŸ¥è¯†ã€‚&lt;/p>
&lt;p>C++æ ‡å‡†åº“ä¸ºç£ç›˜æ–‡ä»¶æ“ä½œæä¾›äº†åŸºç¡€çš„æ¥å£ï¼Œå¦‚&lt;code>std::fstream&lt;/code>ï¼Œ&lt;code>std::ifstream&lt;/code>å’Œ&lt;code>std::ofstream&lt;/code>ã€‚æˆ‘ä»¬è¿˜æœ‰&lt;code>stringstream&lt;/code>ï¼Œå¯ä»¥åƒæµä¸€æ ·æ“ä½œå­—ç¬¦ä¸²ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>std&lt;span style="color:#f92672">::&lt;/span>ostringstream oss;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>oss &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#e6db74">&amp;#34;Hello, world!&lt;/span>&lt;span style="color:#ae81ff">\\&lt;/span>&lt;span style="color:#e6db74">n&amp;#34;&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>oss &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#ae81ff">123&lt;/span> &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">&amp;#39;\\&lt;/span>n&lt;span style="color:#960050;background-color:#1e0010">&amp;#39;&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>std&lt;span style="color:#f92672">::&lt;/span>string s &lt;span style="color:#f92672">=&lt;/span> oss.str();
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç›¸ä¼¼çš„ï¼Œæˆ‘ä»¬å¯ä»¥ä»&lt;code>std::istringstream&lt;/code>ä¸­ä½¿ç”¨&lt;code>&amp;gt;&amp;gt;&lt;/code>æ“ä½œç¬¦è¯»å–æ•°æ®ã€‚&lt;/p>
&lt;p>Booståº“ä¸­çš„&lt;code>lexical_cast&lt;/code>æ­£æ˜¯ä½¿ç”¨äº†è¿™ç§æœºåˆ¶ï¼Œè®©ç”¨æˆ·å¯ä»¥ä½¿ç”¨ç»Ÿä¸€çš„æ–¹å¼å°†ä¸€ä¸ªå¯¹è±¡(object)è½¬æ¢ä¸ºå­—ç¬¦ä¸²è¡¨ç¤ºã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">using&lt;/span> boost&lt;span style="color:#f92672">::&lt;/span>lexical_cast;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">using&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>string;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">int&lt;/span> x &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">5&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>string s &lt;span style="color:#f92672">=&lt;/span> lexical_cast&lt;span style="color:#f92672">&amp;lt;&lt;/span>string&lt;span style="color:#f92672">&amp;gt;&lt;/span>(x);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>assert(s &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#e6db74">&amp;#34;5&amp;#34;&lt;/span>);
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æµç¼“å†²åŒºæœ‰ç€å¾ˆå¼ºçš„çµæ´»æ€§ï¼Œå¯ä»¥æ»¡è¶³ä¸åŒçš„â€œç¼“å†²å¹¶ä¼ è¾“å­—ç¬¦ï¼ˆä¸²ï¼‰â€éœ€æ±‚ï¼Œæ¯”å¦‚æ–‡ä»¶æ“ä½œã€å­—ç¬¦ä¸²æ“ä½œã€å‘½ä»¤è¡Œ(Console)æ“ä½œç­‰ã€‚æˆ‘ä»¬å¯ä»¥ä»ç½‘ç»œã€é—ªå­˜(Flash memory)ç­‰ä¸åŒè®¾å¤‡ï¼Œä½¿ç”¨åŒæ ·çš„æ¥å£è·å–æµå¼å­—ç¬¦ä¸²ã€‚â€œæµç¼“å†²åŒºâ€ä¸â€œæµâ€æ˜¯æ­£äº¤çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥è‡ªç”±çš„äº¤æ¢ã€æ›´æ”¹(swap and change)æµæ‰€ä½¿ç”¨çš„ç¼“å†²åŒºï¼Œæˆ–è€…å°†å…¶é‡å®šå‘åˆ°å…¶å®ƒåœ°æ–¹ã€‚æˆ‘è®¤ä¸ºC++ä¸­çš„æµï¼Œæ­£æ˜¯â€œç­–ç•¥æ¨¡å¼â€(strategy design pattern)çš„ä¸€ä¸ªè‰¯å¥½èŒƒä¾‹ã€‚&lt;/p>
&lt;p>æ¯”å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥é‡å®šå‘æ ‡å‡†æ—¥å¿—æµ&lt;code>std::clog&lt;/code>åˆ°ä¸€ä¸ªå­—ç¬¦ä¸²æµï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;iostream&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;iomanip&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;string&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;sstream&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">int&lt;/span> &lt;span style="color:#a6e22e">main&lt;/span>()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> std&lt;span style="color:#f92672">::&lt;/span>ostringstream oss;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// Make clog use the buffer from oss
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>streambuf &lt;span style="color:#f92672">*&lt;/span>former_buff &lt;span style="color:#f92672">=&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> std&lt;span style="color:#f92672">::&lt;/span>clog.rdbuf(oss.rdbuf());
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> std&lt;span style="color:#f92672">::&lt;/span>clog &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#e6db74">&amp;#34;This will appear in oss!&amp;#34;&lt;/span> &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>flush;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> std&lt;span style="color:#f92672">::&lt;/span>cout &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> oss.str() &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">&amp;#39;\\&lt;/span>n&lt;span style="color:#960050;background-color:#1e0010">&amp;#39;&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// Give clog back its previous buffer
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>clog.rdbuf(former_buff);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¸è¿‡ï¼Œè‡ªå®šä¹‰ä¸€ä¸ªæµç¼“å†²åŒºå´æ˜¯æœ‰ä¸€ç‚¹trickyï¼Œæˆ–è€…è¯´æœ‰ä¸€ç‚¹å“äººï¼Œå°¤å…¶æ˜¯å½“ä½ ç¬¬ä¸€æ¬¡å°è¯•çš„æ—¶å€™ã€‚æ‰€ä»¥æœ¬æ–‡æ„åœ¨æä¾›ä¸€äº›æµç¼“å†²çš„å®ç°èŒƒä¾‹ã€‚&lt;/p>
&lt;p>é¦–å…ˆæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹æµç¼“å†²åŒºçš„ä¸€äº›åŸºæœ¬æ¦‚å¿µã€‚æ‰€æœ‰çš„æµç¼“å†²åŒºç»§æ‰¿è‡ª&lt;code>std::streambuf&lt;/code>ï¼Œå¹¶ä¸”éœ€è¦è¦†ç›–ä¸€äº›è™šå‡½æ•°æ¥å®ç°è‡ªå®šä¹‰åŠŸèƒ½ã€‚&lt;code>std::streambuf&lt;/code>æ˜¯â€œé¡ºåºè¯»å–è®¾å¤‡â€çš„ä¸€ä¸ªæŠ½è±¡ï¼Œå³æˆ‘ä»¬å¯ä»¥ä»ä¸­é¡ºåºçš„è¯»å–å­—ç¬¦åºåˆ—ã€‚åœ¨ç‰¹å®šçš„åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥é‡å¡«(re-fill)ã€å†²æ´—(flush)ä»¥åŠæ¸…ç©º(empty)ä¸€ä¸ªç¼“å†²åŒºã€‚&lt;/p>
&lt;p>å½“æˆ‘ä»¬å‘ä¸€ä¸ª&lt;code>ostream&lt;/code>ä¸­æ’å…¥æ•°æ®æ—¶ï¼Œæ•°æ®å°†ä¼šè¢«å†™å…¥ç¼“å†²åŒºä¸­çš„ä¸€ä¸ªæ•°ç»„ã€‚å½“æ•°ç»„ä¸Šæº¢(overflow)æ—¶ï¼Œæ•°ç»„ä¸­çš„æ•°æ®å°†ä¼šè¢«å†²æ´—(flush)åˆ°ç›®æ ‡æ¥å—è€…ï¼Œä¹‹åè¿™ä¸ªæ•°ç»„çš„çŠ¶æ€å°†ä¼šé‡ç½®ï¼Œä»¥ä¾¿å­˜å‚¨åç»­çš„å­—ç¬¦ã€‚&lt;/p>
&lt;p>å½“æˆ‘ä»¬ä»ä¸€ä¸ª&lt;code>istream&lt;/code>ä¸­è·å–æ•°æ®æ—¶ï¼Œæ•°æ®ä»ç¼“å†²åŒºçš„æ•°ç»„ä¸­è¯»å‡ºã€‚å½“æ•°ç»„ä¸‹æº¢æ—¶(underflow)ï¼Œæ²¡æœ‰æ•°æ®å¯è¯»ï¼Œæˆ‘ä»¬ä¼šä»æ•°æ®æºé‡æ–°æ‹‰å–ä¿¡æ¯æ¥å¡«å……ç¼“å†²åŒºï¼Œä¹‹åè¿™ä¸ªæ•°ç»„çš„çŠ¶æ€ä¹Ÿå°†è¢«é‡ç½®ã€‚&lt;/p>
&lt;p>æˆ‘ä»¬ä½¿ç”¨6ä¸ªæŒ‡é’ˆï¼Œæ¥ç»´æŠ¤ç¼“å†²åŒºçš„å†…éƒ¨çŠ¶æ€ã€‚è¾“å…¥å’Œè¾“å‡ºç¼“å†²å„ä½¿ç”¨3ä¸ªæŒ‡é’ˆã€‚&lt;/p>
&lt;h3 id="ç»´æŠ¤è¾“å‡ºç¼“å†²åŒºçš„çŠ¶æ€">ç»´æŠ¤è¾“å‡ºç¼“å†²åŒºçš„çŠ¶æ€ &lt;a href="#%e7%bb%b4%e6%8a%a4%e8%be%93%e5%87%ba%e7%bc%93%e5%86%b2%e5%8c%ba%e7%9a%84%e7%8a%b6%e6%80%81" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;ul>
&lt;li>
&lt;p>put base pointer &lt;br>
è¾“å‡ºåŸºæŒ‡é’ˆï¼Œç”¨æ¥æŒ‡å®šç¼“å†²åŒºå†…éƒ¨æ•°ç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´ ã€‚å¯ä»¥ä½¿ç”¨&lt;code>std::streambuf::pbase()&lt;/code>æ¥è·å–&lt;/p>
&lt;/li>
&lt;li>
&lt;p>put pointer &lt;br>
è¾“å‡ºæŒ‡é’ˆï¼Œç”¨æ¥æŒ‡å‘å†…éƒ¨æ•°ç»„ä¸‹ä¸€ä¸ªå†™å…¥çš„åœ°å€ã€‚å¯ä»¥ä½¿ç”¨&lt;code>std::streambuf::pptr()&lt;/code>æ¥è·å–&lt;/p>
&lt;/li>
&lt;li>
&lt;p>end put pointer &lt;br>
è¾“å‡ºå“¨å…µæŒ‡é’ˆï¼ŒæŒ‡å‘å†…éƒ¨æ•°ç»„æœ€åä¸€ä¸ªå†åé¢ä¸€ä¸ª(one-past-the-last-element)çš„åœ°å€ï¼ˆè¯‘æ³¨ï¼šç±»ä¼¼&lt;code>std::vector::end()&lt;/code>ï¼‰ã€‚å¯ä»¥ä½¿ç”¨&lt;code>std::streambuf:epptr()&lt;/code>æ¥è·å–&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="http://i1.piimg.com/567571/630a89fe635e1635.png" alt="">&lt;/p>
&lt;p>ä¸€èˆ¬æ¥è¯´ï¼ŒåŸºæŒ‡é’ˆå’Œå“¨å…µæŒ‡é’ˆä¸ä¼šæ”¹å˜ï¼Œåœ¨ä½¿ç”¨æ—¶ï¼Œä»¥è¾“å‡ºæŒ‡é’ˆç»´æŠ¤å†…éƒ¨çŠ¶æ€ã€‚&lt;/p>
&lt;h3 id="ç»´æŠ¤è¾“å…¥ç¼“å†²åŒºçš„çŠ¶æ€">ç»´æŠ¤è¾“å…¥ç¼“å†²åŒºçš„çŠ¶æ€ &lt;a href="#%e7%bb%b4%e6%8a%a4%e8%be%93%e5%85%a5%e7%bc%93%e5%86%b2%e5%8c%ba%e7%9a%84%e7%8a%b6%e6%80%81" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;p>è¾“å…¥ç¼“å†²åŒºå’ŒçŠ¶æ€ç»´æŠ¤å’Œè¾“å‡ºç¼“å†²åŒºç±»ä¼¼ï¼Œæˆ‘ä»¬æœ‰ï¼š&lt;/p>
&lt;ul>
&lt;li>end back pointer &lt;br>
è¾“å…¥åŸºæŒ‡é’ˆï¼ŒæŒ‡å‘ç¼“å†²åŒºæ•°ç»„å†…çš„æœ€åä¸€ä¸ªå­—ç¬¦ã€‚å¯ä»¥ä½¿ç”¨&lt;code>std::streambuf::eback()&lt;/code>æ¥è·å–&lt;/li>
&lt;li>get pointer &lt;br>
è¾“å…¥æŒ‡é’ˆï¼ŒæŒ‡å‘ç¼“å†²åŒºä¸‹ä¸€ä¸ªè¯»å–çš„å­—ç¬¦åœ°å€ã€‚å¯ä»¥ä½¿ç”¨&lt;code>std::streambuf::gptr()&lt;/code>æ¥è·å–&lt;/li>
&lt;li>end get pointer &lt;br>
è¾“å…¥å“¨å…µæŒ‡é’ˆï¼Œæ‰¹å·å‘å†…éƒ¨æ•°ç»„æœ€åä¸€ä¸ªå†åé¢ä¸€ä¸ª(one-past-the-last-element)çš„åœ°å€ã€‚å¯ä»¥ä½¿ç”¨&lt;code>std::streambuf::egptr()&lt;/code>æ¥è·å–&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://github.com/Wizmann/assets/raw/master/wizmann-pic/16-9-27/33500590.jpg" alt="">&lt;/p>
&lt;p>åŒæ ·ï¼ŒåŸºæŒ‡é’ˆå’Œå“¨å…µæŒ‡é’ˆåœ¨æµç¼“å†²åŒºçš„ç”Ÿå‘½å‘¨æœŸä¸­ä¹Ÿä¸ä¼šæ”¹å˜ã€‚&lt;/p>
&lt;p>ç”±äºè¾“å…¥ç¼“å†²åŒºè¦æ”¯æŒ&lt;code>putback()&lt;/code>æ“ä½œï¼Œå³å°†è¯»å‡ºçš„å­—ç¬¦é‡æ–°æ”¾å›ç¼“å†²åŒºï¼Œæ‰€ä»¥è¾“å…¥ç¼“å†²åŒºæ¯”è¾“å‡ºç¼“å†²åŒºæ›´å¤æ‚ä¸€ç‚¹ã€‚é€šå¸¸æ¥è¯´ï¼Œ&lt;code>putback()&lt;/code>æ“ä½œæ”¯æŒæ”¾å›ä¸€ä¸ªå­—ç¬¦å³å¯ã€‚&lt;/p>
&lt;p>ä¸€ä¸ª&lt;code>std::streambuf&lt;/code>å¯ä»¥åŒæ—¶æ”¯æŒè¾“å…¥è¾“å‡ºä¸¤ç§æ“ä½œï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸éœ€è¦æˆ‘åˆ†åˆ«å®ç°&lt;code>std::istreambuf&lt;/code>å’Œ&lt;code>std::ostreambuf&lt;/code>ã€‚&lt;code>std::fstream&lt;/code>æ˜¯ä¸€ä¸ªè‰¯å¥½çš„ä¾‹å­ã€‚ä½†æ˜¯ï¼Œå®ç°ä¸€ä¸ªå…¨åŠŸèƒ½çš„ç¼“å†²åŒºç›¸å¯¹æ›´å¤æ‚ä¸€äº›ï¼Œæ‰€ä»¥æˆ‘å°±ä¸è¶Ÿæµ‘æ°´å•¦~ ï¼šï¼‰&lt;/p>
&lt;p>åŒæ—¶ï¼Œæµç¼“å†²åŒºä¹Ÿå¯ä»¥æ”¯æŒå®½å­—ç¬¦(wide character)ã€‚&lt;code>std::streambuf&lt;/code>æ˜¯&lt;code>std::basic_streambuf&amp;lt;char&amp;gt;&lt;/code>çš„åˆ«åï¼Œå¦‚æœä½ éœ€è¦å®½å­—ç¬¦æµç¼“å†²åŒºï¼Œå¯ä»¥ä½¿ç”¨&lt;code>std::basic_streambuf&amp;lt;wchar_t&amp;gt;&lt;/code>ã€‚&lt;/p>
&lt;h3 id="ä¾‹1æ–‡ä»¶ç¼“å†²åŒº--ä¸cä»£ç é›†æˆ">ä¾‹1ï¼šæ–‡ä»¶ç¼“å†²åŒº â€”â€” ä¸Cä»£ç é›†æˆ &lt;a href="#%e4%be%8b1%e6%96%87%e4%bb%b6%e7%bc%93%e5%86%b2%e5%8c%ba--%e4%b8%8ec%e4%bb%a3%e7%a0%81%e9%9b%86%e6%88%90" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;p>å‡è®¾æˆ‘ä»¬éœ€è¦è°ƒç”¨ä¸€ä¸ªå†å²æ‚ ä¹…çš„åº“ï¼Œä¸€ä¸ªæ–‡ä»¶æ“ä½œå‡½æ•°ä¼šè¿”å›ç»™ä¸€ä¸ª&lt;code>FILE*&lt;/code>æŒ‡é’ˆï¼Œä½†æ˜¯æˆ‘ä»¬æƒ³ç”¨C++çš„æµæ¥å£æ¥è¯»å†™æ•°æ®ã€‚æˆ‘ä»¬å…ˆä»è¯»æ–‡ä»¶å¼€å§‹ï¼Œç”¨&lt;code>std::istream&lt;/code>åŒ…è£…&lt;code>FILE*&lt;/code>çš„è¯»æ“ä½œã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;streambuf&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;vector&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;cstdlib&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;cstdio&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">FILE_buffer&lt;/span> &lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#66d9ef">public&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>streambuf
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">public&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">explicit&lt;/span> FILE_buffer(FILE &lt;span style="color:#f92672">*&lt;/span>fptr, std&lt;span style="color:#f92672">::&lt;/span>size_t buff_sz &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">256&lt;/span>, std&lt;span style="color:#f92672">::&lt;/span>size_t put_back &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">8&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">private&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// overrides base class underflow()
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> int_type underflow();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// copy ctor and assignment not implemented;
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75715e">// copying not allowed
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> FILE_buffer(&lt;span style="color:#66d9ef">const&lt;/span> FILE_buffer &lt;span style="color:#f92672">&amp;amp;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> FILE_buffer &lt;span style="color:#f92672">&amp;amp;&lt;/span>&lt;span style="color:#66d9ef">operator&lt;/span>&lt;span style="color:#f92672">=&lt;/span> (&lt;span style="color:#66d9ef">const&lt;/span> FILE_buffer &lt;span style="color:#f92672">&amp;amp;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">private&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> FILE &lt;span style="color:#f92672">*&lt;/span>fptr_;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">const&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>size_t put_back_;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> std&lt;span style="color:#f92672">::&lt;/span>vector&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">char&lt;/span>&lt;span style="color:#f92672">&amp;gt;&lt;/span> buffer_;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>};
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç”±äºåŠŸèƒ½ç®€å•ï¼Œæˆ‘ä»¬åªéœ€è¦å®ç°æ„é€ å‡½æ•°ä»¥åŠ&lt;code>underflow&lt;/code>æ¥å£å°±å¯ä»¥å®ç°æˆ‘ä»¬çš„åŠŸèƒ½ã€‚&lt;/p>
&lt;p>æ„é€ å‡½æ•°æŒ‡å®šäº†è¯»å–æ–‡ä»¶çš„&lt;code>FILE*&lt;/code>æŒ‡é’ˆï¼Œä»¥åŠå†…éƒ¨ç¼“å†²æ•°ç»„çš„å¤§å°ã€‚æ•°ç»„å¤§å°ç”±ä¸¤ä¸ªå‚æ•°å†³å®šï¼š&lt;/p>
&lt;ul>
&lt;li>put-back area size&lt;/li>
&lt;li>buffer size&lt;/li>
&lt;/ul>
&lt;p>æˆ‘ä»¬ä½¿ç”¨&lt;code>std::vector&amp;lt;char&amp;gt;&lt;/code>åšä¸ºç¼“å†²åŒºåŸŸã€‚&lt;code>put_back_&lt;/code>å˜é‡ç”¨äºå­˜å‚¨&amp;quot;put-back&amp;quot;åŒºåŸŸçš„å¤§å°ã€‚&lt;/p>
&lt;p>ä»¥ä¸‹æ˜¯æ„é€ å‡½æ•°çš„å®ç°ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">using&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>size_t;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>FILE_buffer&lt;span style="color:#f92672">::&lt;/span>FILE_buffer(FILE &lt;span style="color:#f92672">*&lt;/span>fptr, size_t buff_sz, size_t put_back) &lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> fptr_(fptr),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> put_back_(std&lt;span style="color:#f92672">::&lt;/span>max(put_back, size_t(&lt;span style="color:#ae81ff">1&lt;/span>))),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> buffer_(std&lt;span style="color:#f92672">::&lt;/span>max(buff_sz, put_back_) &lt;span style="color:#f92672">+&lt;/span> put_back_)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span>end &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#f92672">&amp;amp;&lt;/span>buffer_.front() &lt;span style="color:#f92672">+&lt;/span> buffer_.size();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> setg(end, end, end);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>åœ¨åˆå§‹åŒ–åˆ—è¡¨ä¸­ï¼Œæˆ‘ä»¬å°†ç¼“å†²åŒºçš„å¸¸é‡è¿›è¡Œèµ‹å€¼ã€‚ä¹‹åä½¿ç”¨&lt;code>std::streambuf::setg()&lt;/code>æ¥åˆå§‹åŒ–è¾“å‡ºç¼“å†²åŒºã€‚&lt;/p>
&lt;p>&lt;code>setg()&lt;/code>çš„ä¸‰ä¸ªå‚æ•°åˆ†åˆ«ä»£è¡¨&lt;code>eback()&lt;/code>ï¼Œ&lt;code>gptr()&lt;/code>ï¼Œ&lt;code>egptr()&lt;/code>ä¸‰ä¸ªå†…éƒ¨æŒ‡é’ˆçš„å€¼ã€‚ä¸€å¼€å§‹ï¼Œæˆ‘ä»¬å°†å®ƒä»¬éƒ½æŒ‡å‘åŒä¸€ä¸ªåœ°å€ã€‚è¡¨æ˜bufferæ˜¯ç©ºçš„ï¼Œåœ¨ä¸‹ä¸€æ¬¡è¯»å–æ—¶ï¼Œä¼šé‡æ–°å¡«å……ç¼“å†²åŒºã€‚&lt;/p>
&lt;p>&lt;code>underflow()&lt;/code>ä¼šè¿”å›æ•°æ®æºä¸­å½“å‰çš„å­—ç¬¦ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œä¼šè¿”å›bufferä¸­çš„ä¸‹ä¸€ä¸ªå¯ç”¨å­—ç¬¦ã€‚ç„¶åå½“bufferä¸ºç©ºæ—¶ï¼Œ&lt;code>underflow()&lt;/code>åº”è¯¥é‡æ–°å¡«å……ç¼“å†²åŒºæ•°ç»„ï¼Œåœ¨æœ¬ä¾‹ä¸­ï¼Œå³ä»&lt;code>FILE*&lt;/code>ä¸­è¯»å–å­—ç¬¦ã€‚å½“ç¼“å†²åŒºé‡å¡«åï¼Œæˆ‘ä»¬éœ€è¦å†æ¬¡è°ƒç”¨&lt;code>setg()&lt;/code>æ›´æ–°æµç¼“å†²åŒºçš„çŠ¶æ€ã€‚&lt;/p>
&lt;p>å½“æ•°æ®æºä¸­çš„æ•°æ®è¯»å®Œ(depleted)åï¼Œ&lt;code>underflow()&lt;/code>ä¼šè¿”å›ä¸€ä¸ª&lt;code>traits_type::eof()&lt;/code>ã€‚è¿™é‡Œè¦æ³¨æ„ï¼Œ&lt;code>underflow()&lt;/code>çš„è¿”å›å€¼æ˜¯&lt;code>int_type&lt;/code>ï¼Œè¿™ä¸ªå€¼è¶³å¤Ÿè£…ä¸‹&lt;code>eof()&lt;/code>ï¼ŒåŒæ—¶ä¹Ÿè¶³å¤Ÿè£…ä¸‹ä»»ä½•çš„å­—ç¬¦ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>std&lt;span style="color:#f92672">::&lt;/span>streambuf&lt;span style="color:#f92672">::&lt;/span>int_type FILE_buffer&lt;span style="color:#f92672">::&lt;/span>underflow()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (gptr() &lt;span style="color:#f92672">&amp;lt;&lt;/span> egptr()) &lt;span style="color:#75715e">// buffer not exhausted
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">return&lt;/span> traits_type&lt;span style="color:#f92672">::&lt;/span>to_int_type(&lt;span style="color:#f92672">*&lt;/span>gptr());
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span>base &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#f92672">&amp;amp;&lt;/span>buffer_.front();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span>start &lt;span style="color:#f92672">=&lt;/span> base;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (eback() &lt;span style="color:#f92672">==&lt;/span> base) &lt;span style="color:#75715e">// true when this isn&amp;#39;t the first fill
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// Make arrangements for putback characters
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>memmove(base, egptr() &lt;span style="color:#f92672">-&lt;/span> put_back_, put_back_);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> start &lt;span style="color:#f92672">+=&lt;/span> put_back_;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// start is now the start of the buffer, proper.
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75715e">// Read from fptr_ in to the provided buffer
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> size_t n &lt;span style="color:#f92672">=&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>fread(start, &lt;span style="color:#ae81ff">1&lt;/span>, buffer_.size() &lt;span style="color:#f92672">-&lt;/span> (start &lt;span style="color:#f92672">-&lt;/span> base), fptr_);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (n &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> traits_type&lt;span style="color:#f92672">::&lt;/span>eof();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// Set buffer pointers
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> setg(base, start, start &lt;span style="color:#f92672">+&lt;/span> n);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> traits_type&lt;span style="color:#f92672">::&lt;/span>to_int_type(&lt;span style="color:#f92672">*&lt;/span>gptr());
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å‡½æ•°çš„ç¬¬ä¸€è¡Œï¼Œé¦–å…ˆåˆ¤æ–­bufferæ˜¯å¦è€—å°½ã€‚å¦‚æœå¦ï¼Œåˆ™è¿”å›å½“å‰å­—ç¬¦ï¼Œå³&lt;code>*gptr()&lt;/code>ã€‚å¦‚æœæ˜¯ï¼Œåˆ™è¿›è¡Œé‡å¡«(re-fill)æ“ä½œã€‚&lt;/p>
&lt;p>å›æƒ³ä¸€ä¸‹æˆ‘ä»¬åœ¨æ„é€ å‡½æ•°ä¸­çš„å®ç°ï¼Œä¸‰ä¸ªçŠ¶æ€æŒ‡é’ˆå…¨éƒ½æŒ‡å‘ç¼“å†²åŒºçš„æœ«å°¾ã€‚å¦‚æœæˆ‘ä»¬è°ƒç”¨&lt;code>underflow()&lt;/code>æ—¶ï¼Œå‘ç°çŠ¶æ€æŒ‡é’ˆå¹¶éå¦‚æ­¤ï¼Œåˆ™è¯´æ˜ç¼“å†²åŒºå·²ç»è¢«å¡«å……äº†è‡³å°‘ä¸€æ¬¡ã€‚&lt;/p>
&lt;p>ç°åœ¨æˆ‘ä»¬è€ƒè™‘é‡å¡«æ“ä½œï¼Œæˆ‘ä»¬&lt;code>memmove&lt;/code>æœ€å&lt;code>put_back_&lt;/code>ä¸ªå­—ç¬¦åˆ°bufferçš„æœ«å°¾ï¼Œç”¨åš&amp;quot;put-back area&amp;quot;ã€‚ï¼ˆæˆ‘ä»¬ä¸ç”¨&lt;code>memcopy&lt;/code>å› ä¸ºæˆ‘ä»¬çš„bufferæ¯”è¾ƒå°ï¼Œ`memmove()çš„æ•ˆç‡ä¼šæ›´é«˜ä¸€äº›ï¼‰&lt;/p>
&lt;blockquote>
&lt;p>è¯‘æ³¨ï¼šå®é™…ä¸Šï¼Œ&lt;code>memcopy&lt;/code>ä¸&lt;code>memmove&lt;/code>å„æœ‰æ‰€é•¿ã€‚&lt;code>memcopy&lt;/code>ä¸éœ€è¦åˆ¤æ–­å†…å­˜overlapçš„æƒ…å†µï¼Œå³å¦‚æœæºåŒºé—´ä¸ç›®æ ‡åŒºé—´æœ‰é‡å ï¼Œé‚£ä¹ˆå¾—åˆ°çš„ç»“æœä¼šæ˜¯é”™çš„ã€‚è€Œ&lt;code>memmove&lt;/code>ç”±äºæ˜¯ç§»åŠ¨è¯­ä¹‰ï¼Œæ‰€ä»¥åœ¨ç§»åŠ¨æ­¥é•¿è¾ƒå°æ—¶ï¼Œå¯ä»¥åªæ“ä½œcacheã€‚æ‰€ä»¥äºŒè€…å„æœ‰æ‰€é•¿ï¼Œè¦æ ¹æ®å…·ä½“æƒ…å†µåˆ¤æ–­ä¼˜åŠ£ã€‚Stackoverflowä¸Šæœ‰æ›´è¯¦ç»†çš„&lt;a href="http://stackoverflow.com/questions/28623895/why-is-memmove-faster-than-memcpy">è®¨è®º&lt;/a>&lt;/p>&lt;/blockquote>
&lt;p>æˆ‘ä»¬å¤„ç†å®Œ&amp;quot;put-back area&amp;quot;ä¹‹åï¼Œå°±å¯ä»¥ä½¿ç”¨&lt;code>fread()&lt;/code>å‡½æ•°æ¥é‡å¡«ç¼“å†²åŒºäº†ã€‚å¦‚æœè¯»ä¸åˆ°æ•°æ®ï¼Œåˆ™æ„å‘³ç€æ–‡ä»¶å·²ç»è¯»åˆ°äº†ç»“å°¾ï¼ˆå½“ç„¶è¿™æ˜¯ä¸€ç§ç®€åŒ–æƒ…å†µï¼Œä½†åœ¨ç°å®ä¸­99.9%çš„è¯»å–å¤±è´¥éƒ½æ˜¯å› ä¸ºæ–‡ä»¶ç»“æŸï¼‰ã€‚&lt;/p>
&lt;p>åœ¨&lt;code>fread()&lt;/code>æˆåŠŸè¯»å–æ•°æ®ä¹‹åï¼Œæˆ‘ä»¬é€šçŸ¥streambufæ›´æ–°å†…éƒ¨çš„ä¸‰ä¸ªçŠ¶æ€æŒ‡é’ˆã€‚ä¹‹åè¿”å›bufferå½“å‰çš„æŒ‡é’ˆã€‚&lt;/p>
&lt;p>è¿™å°±æ˜¯æˆ‘ä»¬çš„æµç¼“å†²åŒºçš„åŸºæœ¬å®ç°ï¼Œå¸Œæœ›è¿™å¹¶ä¸æ˜¯å¤ªéš¾ã€‚å½“ç„¶æˆ‘ä»¬è¿˜å¯ä»¥æ·»åŠ æ›´å¤šçš„åŠŸèƒ½ã€‚ç‰¹åˆ«çš„æ˜¯æˆ‘ä»¬å¯ä»¥åœ¨ç¼“å†²åŒºé‡Œé¢è¿›è¡ŒæŸ¥æ‰¾ã€‚å¦‚æœä½ æƒ³å®ç°å®ƒçš„è¯ï¼Œå¯ä»¥è¯•è¯•é‡å†™&lt;code>std::streambuf::seekoff()&lt;/code>å’Œ&lt;code>std::streambuf::seekpos&lt;/code>è™šæˆå‘˜å‡½æ•°ã€‚&lt;/p>
&lt;p>æˆ‘ä»¬ä¹Ÿå¯ä»¥å®ç°å†™ç¼“å†²åŒºã€‚ä¸è¿‡ï¼Œåœ¨ä½ ä»¬è¯»å®Œç¬¬ä¸‰ä¸ªä¾‹å­ä¹‹åï¼Œä½ ä»¬å°±å¯ä»¥è½»æ¾æ„‰å¿«çš„å®ç°è‡ªå·±çš„ç‰ˆæœ¬äº†ï¼Œä¸éª—ä½ ã€‚&lt;/p>
&lt;h3 id="ä¾‹2è¯»å–å†…å­˜ä¸­çš„æ•°ç»„">ä¾‹2ï¼šè¯»å–å†…å­˜ä¸­çš„æ•°ç»„ &lt;a href="#%e4%be%8b2%e8%af%bb%e5%8f%96%e5%86%85%e5%ad%98%e4%b8%ad%e7%9a%84%e6%95%b0%e7%bb%84" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;p>æœ¬ä¾‹ä¸­ï¼Œæˆ‘ä»¬è¦ä½¿ç”¨&lt;code>std::istream&lt;/code>åŒ…è£…å†…å­˜ä¸­çš„ä¸€ä¸ªåªè¯»æ•°ç»„ï¼Œå¹¶ä¸”æ ¼å¼åŒ–çš„è¿›è¡Œè¯»å…¥ã€‚è¿™ä¸ªä¾‹å­å’Œä¸Šä¸€ä¸ªä¾‹å­æœ‰ä¸€ç‚¹ä¸åŒçš„æ˜¯ï¼Œæˆ‘ä»¬å¹¶ä¸éœ€è¦ä¸€ä¸ªçœŸæ­£çš„ç¼“å†²æ•°ç»„ï¼Œä»æºæ•°ç»„ä¸€æ¬¡æ€§è¯»å–å°±å¥½äº†ã€‚&lt;/p>
&lt;p>æƒ³è±¡ä¸­çš„å®ç°æ˜¯è¿™ä¸ªæ ·å¼å„¿çš„ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">char_array_buffer&lt;/span> &lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#66d9ef">public&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>streambuf
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">public&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> char_array_buffer(&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span>begin, &lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span>end)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> setg(begin, begin, end);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> int_type &lt;span style="color:#a6e22e">underflow&lt;/span>()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> gptr() &lt;span style="color:#f92672">==&lt;/span> egptr() &lt;span style="color:#f92672">?&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> traits_type&lt;span style="color:#f92672">::&lt;/span>eof() &lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> traits_type&lt;span style="color:#f92672">::&lt;/span>to_int_type(&lt;span style="color:#f92672">*&lt;/span>gptr());
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>};
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä½†æ˜¯ï¼Œè¿™å¹¶æ²¡æœ‰ä»€ä¹ˆåµç”¨ã€‚å› ä¸º&lt;code>setg()&lt;/code>å‡½æ•°åªæ¥å—éå¸¸é‡(non-const)æŒ‡é’ˆå‚æ•°ã€‚è¿™æ˜¾è€Œæ˜“è§ï¼Œå¦‚æœä¸€ä¸ªç¼“å†²åŒºä¸å¯å†™ï¼Œæˆ‘ä»¬å°±ä¸èƒ½æä¾›&amp;quot;put-back&amp;quot;åŠŸèƒ½ã€‚æ‰€ä»¥æˆ‘ä»¬è¦åŠ¨ä¸€åŠ¨æ‰‹è„šï¼Œé‡æ–°å®ç°ä¸€ä¸‹è¿™ä¸ªç±»ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;streambuf&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">char_array_buffer&lt;/span> &lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#66d9ef">public&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>streambuf
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">public&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> char_array_buffer(&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span>begin, &lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span>end);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">explicit&lt;/span> &lt;span style="color:#a6e22e">char_array_buffer&lt;/span>(&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span>str);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">private&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> int_type underflow();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> int_type &lt;span style="color:#a6e22e">uflow&lt;/span>();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> int_type &lt;span style="color:#a6e22e">pbackfail&lt;/span>(int_type ch);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> std&lt;span style="color:#f92672">::&lt;/span>streamsize showmanyc();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// copy ctor and assignment not implemented;
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75715e">// copying not allowed
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> char_array_buffer(&lt;span style="color:#66d9ef">const&lt;/span> char_array_buffer &lt;span style="color:#f92672">&amp;amp;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> char_array_buffer &lt;span style="color:#f92672">&amp;amp;&lt;/span>&lt;span style="color:#66d9ef">operator&lt;/span>&lt;span style="color:#f92672">=&lt;/span> (&lt;span style="color:#66d9ef">const&lt;/span> char_array_buffer &lt;span style="color:#f92672">&amp;amp;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">private&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span> &lt;span style="color:#66d9ef">const&lt;/span> begin_;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span> &lt;span style="color:#66d9ef">const&lt;/span> end_;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span> current_;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>};
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>åœ¨è¿™ä¸ªç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬é‡å†™äº†å‡ ä¸ªç§æœ‰å‡½æ•°ï¼Œè¿™äº›å‡½æ•°éƒ½æ˜¯ä»&lt;code>std::streambuf&lt;/code>ç»§æ‰¿è€Œæ¥ã€‚&lt;/p>
&lt;p>ç¬¬ä¸€ä¸ªæ„é€ å‡½æ•°éœ€è¦ç”¨æˆ·æŒ‡å®šèµ·æ­¢æŒ‡é’ˆï¼Œè€Œç¬¬äºŒä¸ªæ„é€ å‡½æ•°åªéœ€è¦æŒ‡å®šèµ·å§‹æŒ‡é’ˆï¼Œä¹‹åæˆ‘ä»¬ä¼šè°ƒç”¨&lt;code>std::strlen()&lt;/code>æ¥åˆ¤æ–­å­—ç¬¦ä¸²çš„å¤§å°ã€‚&lt;/p>
&lt;p>æˆ‘ä»¬ä½¿ç”¨&lt;code>uflow()&lt;/code>, &lt;code>pbackfail()&lt;/code>å’Œ&lt;code>showmanyc()&lt;/code>æ¥ç»´æŠ¤ç¼“å†²åŒºå†…éƒ¨çš„çŠ¶æ€ï¼Œè€Œä¸æ˜¯è°ƒç”¨&lt;code>setg()&lt;/code>ï¼Œå› ä¸ºbufferå¹¶ä¸å¯å†™ã€‚&lt;/p>
&lt;p>åœ¨è¿™ä¸ªç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬è¦æ‰‹åŠ¨ç»´æŠ¤&lt;code>eback&lt;/code>, &lt;code>gptr&lt;/code>, &lt;code>egptr&lt;/code>ä¸‰ä¸ªæŒ‡é’ˆã€‚åœ¨æ„é€ å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬å°†å¯¹å…¶è¿›è¡Œèµ‹å€¼ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;#34;char_array_buffer.hpp&amp;#34;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;functional&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;cassert&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;cstring&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>char_array_buffer&lt;span style="color:#f92672">::&lt;/span>char_array_buffer(&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span>begin, &lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span>end) &lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> begin_(begin),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> end_(end),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> current_(begin_)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> assert(std&lt;span style="color:#f92672">::&lt;/span>less_equal&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&amp;gt;&lt;/span>()(begin_, end_));
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>char_array_buffer&lt;span style="color:#f92672">::&lt;/span>char_array_buffer(&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span>str) &lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> begin_(str),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> end_(begin_ &lt;span style="color:#f92672">+&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>strlen(str)),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> current_(begin_)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¹‹å‰æˆ‘ä»¬ä½¿ç”¨&lt;code>underflow()&lt;/code>æ¥è·å–å½“å‰å­—ç¬¦ï¼Œä½†è¿™æ¬¡æˆ‘ä»¬éœ€è¦ä½¿ç”¨&lt;code>uflow()&lt;/code>ã€‚å› ä¸º&lt;code>uflow()&lt;/code>éœ€è¦åŒæ—¶æ‰§è¡Œä¸¤æ­¥æ“ä½œï¼Œä¸€æ˜¯è·å–å½“å‰å­—ç¬¦ï¼ŒäºŒæ˜¯è®©&lt;code>gptr()&lt;/code>å‰è¿›ä¸€æ­¥ã€‚ä½†æ˜¯åˆå› ä¸ºç¼“å†²åŒºç”±æˆ‘ä»¬æ‰‹åŠ¨ç®¡ç†ï¼Œ&lt;code>std::streambuf&lt;/code>å¹¶ä¸èƒ½æ­£ç¡®çš„æ‰§è¡Œç®¡ç†æ“ä½œã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦é‡å†™&lt;code>uflow()&lt;/code>è€Œä¸æ˜¯&lt;code>underflow()&lt;/code>ã€‚&lt;/p>
&lt;pre tabindex="0">&lt;code>char_array_buffer::int_type char_array_buffer::uflow()
{
if (current_ == end_)
return traits_type::eof();
return traits_type::to_int_type(*current_++);
}
&lt;/code>&lt;/pre>&lt;p>ä¸‹ä¸€æ­¥æˆ‘ä»¬è¿˜è¦å®ç°&lt;code>pbackfail()&lt;/code>ã€‚å½“æˆ‘ä»¬è°ƒç”¨&lt;code>std::istream::unget()&lt;/code>æˆ–&lt;code>std::istream::putback(ch)&lt;/code>æ—¶ï¼Œæˆ‘ä»¬ä¼šæŠŠå·²ç»è¯»å‡ºçš„æ•°æ®å†™å›æ•°ç»„ä¸­ã€‚ä½†æ˜¯ç”±äºæ•°ç»„æ˜¯åªè¯»çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬åªèƒ½æ¨¡æ‹Ÿè¿™ç§æ“ä½œã€‚&lt;/p>
&lt;p>åœ¨é»˜è®¤çš„å®ç°ä¸­&lt;code>pbackfail()&lt;/code>åªä¼šè¿”å›&lt;code>traits_type::eof()&lt;/code>ï¼Œè€Œåœ¨æˆ‘ä»¬çš„ç‰ˆæœ¬ä¸­ï¼Œå¦‚æœå†™å›æˆåŠŸï¼Œå°†ä¼šè¿”å›å†™å›çš„å­—ç¬¦ï¼Œä¸æˆåŠŸè¿”å›eofã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>char_array_buffer&lt;span style="color:#f92672">::&lt;/span>int_type char_array_buffer&lt;span style="color:#f92672">::&lt;/span>pbackfail(int_type ch)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (current_ &lt;span style="color:#f92672">==&lt;/span> begin_ &lt;span style="color:#f92672">||&lt;/span> (ch &lt;span style="color:#f92672">!=&lt;/span> traits_type&lt;span style="color:#f92672">::&lt;/span>eof() &lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span> ch &lt;span style="color:#f92672">!=&lt;/span> current_[&lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>]))
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> traits_type&lt;span style="color:#f92672">::&lt;/span>eof();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> traits_type&lt;span style="color:#f92672">::&lt;/span>to_int_type(&lt;span style="color:#f92672">*--&lt;/span>current_);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>åœ¨&lt;code>FILE_buffer&lt;/code>ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥è€ƒè™‘é‡å†™&lt;code>pbackfail()&lt;/code>ï¼Œæ¥æä¾›åå‘æŸ¥æ‰¾ä»¥åŠï¼ˆç”¨å‰é¢çš„æ•°æ®ï¼‰é‡å¡«bufferçš„åŠŸèƒ½ã€‚&lt;/p>
&lt;p>æœ€åä¸€ä¸ªé‡å†™çš„å‡½æ•°æ˜¯&lt;code>showmanyc()&lt;/code>ï¼Œè¿™ä¸ªå‡½æ•°è¢«&lt;code>std::streambuf::in_avail()&lt;/code>è°ƒç”¨ï¼Œä»¥åˆ¤æ–­å½“å‰æœ‰å¤šå°‘ä¸ªå­—ç¬¦å¯ä»¥è¿”å›ã€‚ç”±äºæˆ‘ä»¬æ¥ç®¡äº†çŠ¶æ€æŒ‡é’ˆï¼Œæ‰€ä»¥è¿™ä¸ªå‡½æ•°ä¹Ÿè¦æˆ‘ä»¬è‡ªå·±æ¥å®ç°å•Šã€‚ï¼ˆè¯‘è€…ï¼šä¸ºä»€ä¹ˆè¦ç»™è‡ªå·±æ‰¾éº»çƒ¦ã€‚ã€‚ã€‚ï¼‰&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>std&lt;span style="color:#f92672">::&lt;/span>streamsize char_array_buffer&lt;span style="color:#f92672">::&lt;/span>showmanyc()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> assert(std&lt;span style="color:#f92672">::&lt;/span>less_equal&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&amp;gt;&lt;/span>()(current_, end_));
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> end_ &lt;span style="color:#f92672">-&lt;/span> current_;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç”±æ­¤å¯è§ï¼Œæœ¬ä¾‹ä¸­çš„bufferæ¯”å‰é¢çš„è¦å¤æ‚ä¸€ç‚¹ç‚¹ã€‚è¿™æ˜¯å› ä¸ºæˆ‘ä»¬æ¥ç®¡äº†çŠ¶æ€ç»´æŠ¤çš„å·¥ä½œã€‚è¿™ä½¿å¾—æˆ‘ä»¬æ›´å¥½çš„ç†è§£äº†&lt;code>std::streambuf&lt;/code>å†…éƒ¨æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚&lt;/p>
&lt;h3 id="ä¾‹3å¥é¦–å˜å¤§å†™çš„ç¼“å†²åŒº">ä¾‹3ï¼šå¥é¦–å˜å¤§å†™çš„ç¼“å†²åŒº &lt;a href="#%e4%be%8b3%e5%8f%a5%e9%a6%96%e5%8f%98%e5%a4%a7%e5%86%99%e7%9a%84%e7%bc%93%e5%86%b2%e5%8c%ba" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;p>æœ¬ä¾‹ä¸­æˆ‘ä»¬å°†è¦å®ç°ä¸€ä¸ªå°†å¥é¦–å­—ç¬¦å˜å¤§å†™çš„bufferã€‚å½“ç„¶æˆ‘ä»¬åªè€ƒè™‘æœ€åŸºæœ¬çš„æƒ…å†µï¼Œç§»æ¤åˆ°ä¸åŒçš„åŒºåŸŸå’Œè¯­è¨€ï¼Œå…¶å®æ˜¯å¾ˆçç¢çš„äº‹æƒ…ã€‚ï¼ˆè¯‘è€…ï¼šæ–‡å­—ç¼–ç å‘çš„äº²å¦ˆéƒ½ä¸è®¤äº†ï¼‰&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;streambuf&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;iosfwd&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;cstdlib&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;vector&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">caps_buffer&lt;/span> &lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#66d9ef">public&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>streambuf
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">public&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">explicit&lt;/span> caps_buffer(std&lt;span style="color:#f92672">::&lt;/span>ostream &lt;span style="color:#f92672">&amp;amp;&lt;/span>sink, std&lt;span style="color:#f92672">::&lt;/span>size_t buff_sz &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">256&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">protected&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">bool&lt;/span> do_caps_and_flush();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">private&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> int_type overflow(int_type ch);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">int&lt;/span> &lt;span style="color:#a6e22e">sync&lt;/span>();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// copy ctor and assignment not implemented;
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75715e">// copying not allowed
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> caps_buffer(&lt;span style="color:#66d9ef">const&lt;/span> caps_buffer &lt;span style="color:#f92672">&amp;amp;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> caps_buffer &lt;span style="color:#f92672">&amp;amp;&lt;/span>&lt;span style="color:#66d9ef">operator&lt;/span>&lt;span style="color:#f92672">=&lt;/span> (&lt;span style="color:#66d9ef">const&lt;/span> caps_buffer &lt;span style="color:#f92672">&amp;amp;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">private&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">bool&lt;/span> cap_next_;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> std&lt;span style="color:#f92672">::&lt;/span>ostream &lt;span style="color:#f92672">&amp;amp;&lt;/span>sink_;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> std&lt;span style="color:#f92672">::&lt;/span>vector&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">char&lt;/span>&lt;span style="color:#f92672">&amp;gt;&lt;/span> buffer_;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>};
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™é‡Œæˆ‘ä»¬éœ€è¦é‡å†™&lt;code>overflow()&lt;/code>å’Œ&lt;code>sync()&lt;/code>å‡½æ•°ã€‚&lt;code>overflow()&lt;/code>åœ¨è¾“å…¥ç¼“å†²åŒºæ»¡çš„æ—¶å€™è¢«è°ƒç”¨ï¼Œå¹¶ä¸”åœ¨æˆåŠŸæ—¶è¿”å›ä»»æ„éeofçš„å€¼ã€‚&lt;/p>
&lt;p>&lt;code>sync()&lt;/code>çš„ä½œç”¨æ˜¯æŠŠå½“å‰çš„bufferå†™å…¥ç›®æ ‡ï¼Œå³ä½¿å½“å‰bufferå¹¶æœªå¡«æ»¡ã€‚&lt;code>std::flush()&lt;/code>ä¼šè°ƒç”¨&lt;code>sync()&lt;/code>å‡½æ•°ï¼Œå½“å¤±è´¥æ—¶è¿”å›-1ã€‚&lt;/p>
&lt;p>æˆ‘ä»¬ç¼–å†™ä¸€ä¸ªè¾…åŠ©å‡½æ•°&lt;code>do_caps_and_flush()&lt;/code>ï¼Œç”¨æ¥å°†å°å†™å˜å¤§å†™ï¼Œå¹¶å†™å…¥&lt;code>sink_&lt;/code>è¾“å‡ºæµã€‚æˆ‘ä»¬å†å£°æ˜ä¸€ä¸ªå“¨å…µå˜é‡&lt;code>cap_next_&lt;/code>æ¥æ ‡è¯†ä¸‹ä¸€ä¸ªå­—ç¬¦æ˜¯å¦éœ€è¦å°å†™å˜å¤§å†™ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;#34;caps_buffer.hpp&amp;#34;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;cctype&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;ostream&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;functional&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;cassert&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>caps_buffer&lt;span style="color:#f92672">::&lt;/span>caps_buffer(std&lt;span style="color:#f92672">::&lt;/span>ostream &lt;span style="color:#f92672">&amp;amp;&lt;/span>sink, std&lt;span style="color:#f92672">::&lt;/span>size_t buff_sz) &lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> cap_next_(true),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> sink_(sink),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> buffer_(buff_sz &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> sink_.clear();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span>base &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#f92672">&amp;amp;&lt;/span>buffer_.front();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> setp(base, base &lt;span style="color:#f92672">+&lt;/span> buffer_.size() &lt;span style="color:#f92672">-&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>); &lt;span style="color:#75715e">// -1 to make overflow() easier
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>buffer_&lt;/code>çš„æœ€å°å¯èƒ½å¤§å°æ˜¯1ï¼ŒåŒæ—¶æˆ‘ä»¬ä¹Ÿåªéœ€è¦ç»´æŠ¤ä¸¤ä¸ªæŒ‡é’ˆï¼Œå› ä¸ºè¿™é‡Œä¸éœ€è¦åƒè¾“å…¥ç¼“å†²åŒºä¸€æ ·çš„ç»´æŠ¤&amp;quot;put-back area&amp;quot;ã€‚&lt;/p>
&lt;p>æˆ‘ä»¬æŠŠ&lt;code>buffer_&lt;/code>çš„å¤§å°è®¾æˆ&lt;code>buff_sz + 1&lt;/code>ï¼Œè¿™æ ·æ˜¯ä¸ºäº†&lt;code>overflow()&lt;/code>è¢«è°ƒç”¨æ—¶ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªé¢å¤–çš„ç©ºé—´å­˜å‚¨å½“å‰çš„å­—ç¬¦ã€‚æœ€åå°†ç¼“å†²åŒºæ•°ç»„å’Œæœ€åä¸€ä¸ªå­—ç¬¦ä¸€èµ·åˆ·æ–°åˆ°&lt;code>ostream&lt;/code>ä¸­ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>caps_buffer&lt;span style="color:#f92672">::&lt;/span>int_type caps_buffer&lt;span style="color:#f92672">::&lt;/span>overflow(int_type ch)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (sink_ &lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span> ch &lt;span style="color:#f92672">!=&lt;/span> traits_type&lt;span style="color:#f92672">::&lt;/span>eof())
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> assert(std&lt;span style="color:#f92672">::&lt;/span>less_equal&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&amp;gt;&lt;/span>()(pptr(), epptr()));
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">*&lt;/span>pptr() &lt;span style="color:#f92672">=&lt;/span> ch;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> pbump(&lt;span style="color:#ae81ff">1&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (do_caps_and_flush())
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> ch;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> traits_type&lt;span style="color:#f92672">::&lt;/span>eof();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç¬¬ä¸€æ­¥æ˜¯æŠŠchå†™å…¥&lt;code>buffer_&lt;/code>ï¼Œå¹¶ä¸”ä½¿ç”¨&lt;code>pbump(1)&lt;/code>å°†&lt;code>pptr()&lt;/code>å‘å‰ç§»ä¸€ä½ã€‚ä¹‹åè°ƒç”¨&lt;code>do_caps_and_flush()&lt;/code>åšä¸€äº›è„æ´»ï¼Œä¹‹åè¿”å›ä¸€ä¸ªå­—ç¬¦å£°æ˜è°ƒç”¨æˆåŠŸã€‚&lt;/p>
&lt;p>&lt;code>sync()&lt;/code>çš„å®ç°ä¹Ÿéå¸¸ç®€å•:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">int&lt;/span> caps_buffer&lt;span style="color:#f92672">::&lt;/span>sync()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#a6e22e">do_caps_and_flush&lt;/span>() &lt;span style="color:#f92672">?&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span> &lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æˆ‘ä»¬å†çœ‹ä¸€çœ‹&lt;code>do_caps_and_flush()&lt;/code>å‡½æ•°&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">bool&lt;/span> caps_buffer&lt;span style="color:#f92672">::&lt;/span>do_caps_and_flush()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">for&lt;/span> (&lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span>p &lt;span style="color:#f92672">=&lt;/span> pbase(), &lt;span style="color:#f92672">*&lt;/span>e &lt;span style="color:#f92672">=&lt;/span> pptr(); p &lt;span style="color:#f92672">!=&lt;/span> e; &lt;span style="color:#f92672">++&lt;/span>p)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (&lt;span style="color:#f92672">*&lt;/span>p &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#e6db74">&amp;#39;.&amp;#39;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> cap_next_ &lt;span style="color:#f92672">=&lt;/span> true;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">else&lt;/span> &lt;span style="color:#a6e22e">if&lt;/span> (std&lt;span style="color:#f92672">::&lt;/span>isalpha(&lt;span style="color:#f92672">*&lt;/span>p))
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (cap_next_)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">*&lt;/span>p &lt;span style="color:#f92672">=&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>toupper(&lt;span style="color:#f92672">*&lt;/span>p);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> cap_next_ &lt;span style="color:#f92672">=&lt;/span> false;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> std&lt;span style="color:#f92672">::&lt;/span>ptrdiff_t n &lt;span style="color:#f92672">=&lt;/span> pptr() &lt;span style="color:#f92672">-&lt;/span> pbase();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> pbump(&lt;span style="color:#f92672">-&lt;/span>n);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> sink_.write(pbase(), n);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯¹äºæœ¬ä¾‹æ¥è¯´ï¼Œå†…éƒ¨çš„ç¼“å†²åŒºå¹¶éå¿…è¦ï¼Œæˆ‘ä»¬å¯ä»¥ä¸€ä¸ªå­—ç¬¦ä¸€ä¸ªå­—ç¬¦æŠŠæ•°æ®å‘åˆ°&lt;code>sink&lt;/code>ä¸­ã€‚ä½†æ˜¯æˆ‘çš„è§‚ç‚¹æ˜¯ä¸€ä¸ªå†…éƒ¨bufferä»æœ‰å…¶ç”¨å¤„ã€‚&lt;/p>
&lt;h3 id="ä»‹ç»-boost-iostreams-åº“">ä»‹ç» Boost IOStreams åº“ &lt;a href="#%e4%bb%8b%e7%bb%8d-boost-iostreams-%e5%ba%93" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;p>å¦‚æœä½ æ˜¯æµç¼“å†²åŒºçš„æ–°æ‰‹ï¼Œå¸Œæœ›ä½ å·²ç»å¯¹å®ƒæœ‰ä¸€ç‚¹ç‚¹äº†è§£äº†ã€‚æœ¬æ–‡ä¸­çš„ä¾‹å­éƒ½éå¸¸åŸºç¡€ï¼Œä½†æ˜¯ä½ å¯ä»¥ç”¨å®ƒä»¬åšæ›´å¤šæœ‰æ„æ€çš„äº‹æƒ…ã€‚ä½†æ˜¯å½“æˆ‘å®ç°æ›´å¤æ‚çš„æµç¼“å†²åŒºæ—¶ï¼Œé—®é¢˜çš„å¤æ‚åº¦å´ä¸Šå‡çš„å¾ˆå¿«ã€‚è¿™æ—¶æˆ‘å‘ç°äº†&lt;code>Boost IOStreams&lt;/code>åº“ï¼Œå®ƒä¸ºæ›´å¤æ‚çš„ç¼“å†²åŒºå’Œæµæä¾›äº†å¿…è¦çš„æ¡†æ¶æ”¯æŒã€‚&lt;/p>
&lt;p>å®ƒå…è®¸ä½ è§£è€¦æ•°æ®æºï¼Œæ•°æ®è¾“å‡ºï¼Œè¿‡æ»¤å™¨ä»¥åŠå…¶å®ƒä¸€äº›æ¦‚å¿µã€‚åœ¨æˆ‘ä»¬çš„æœ€åä¸€ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ç¡¬ç¼–ç æ•°æ®è¾“å‡ºåˆ°&lt;code>std::ostream&lt;/code>ä¸­ã€‚å¦‚æœæˆ‘ä»¬è¦è¾“å‡ºåˆ°ä¸€ä¸ªæ²¡æœ‰æµæ¥å£çš„ç±»å‘¢ï¼Ÿ&lt;code>Boost IOStreams&lt;/code>åº“æä¾›äº†æ›´å¤šçš„çµæ´»æ€§ï¼Œå°†ä¸€å¨ç´§è€¦åˆçš„ä»£ç åˆ†è§£æˆç‹¬ç«‹çš„æŠ½è±¡æ¦‚å¿µã€‚&lt;/p>
&lt;h3 id="æ‰©å±•é˜…è¯»">æ‰©å±•é˜…è¯» &lt;a href="#%e6%89%a9%e5%b1%95%e9%98%85%e8%af%bb" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;ul>
&lt;li>The C++ Standard Library by Nicolai M. Josuttis&lt;/li>
&lt;li>The C++ Standard, BS ISO/IEC 14882:2003 (Second Edition)&lt;/li>
&lt;li>&lt;a href="http://www.dinkumware.com/manuals/">Dinkum Compleat Reference online&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>ç”¨C++å®ç°ä¸€ä¸ªé€šç”¨çš„sortå‡½æ•°</title><link>https://wizmann.top/posts/a-common-sorting-function-with-cpp/</link><pubDate>Sat, 25 Apr 2015 11:17:01 +0000</pubDate><guid>https://wizmann.top/posts/a-common-sorting-function-with-cpp/</guid><description>&lt;h2 id="é—®é¢˜">é—®é¢˜ &lt;a href="#%e9%97%ae%e9%a2%98" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>ç”¨C++å®ç°ä¸€ä¸ªå°½å¯èƒ½é€šç”¨çš„sortå‡½æ•°&lt;/p>
&lt;h2 id="åˆ†æ">åˆ†æ &lt;a href="#%e5%88%86%e6%9e%90" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>ä¸€ä¸ªé€šç”¨çš„sortå‡½æ•°åº”è¯¥åŒ…å«ä»¥ä¸‹è¦ç‚¹ï¼š&lt;/p>
&lt;ul>
&lt;li>ç¡®å®å¯ä»¥æ’åº(LOL)&lt;/li>
&lt;li>å¯ä»¥åº”å¯¹C-style arrayå’ŒC++-style containerçš„æ’åºéœ€æ±‚&lt;/li>
&lt;li>å¯ä»¥åº”ç”¨äºä»»æ„random access container&lt;/li>
&lt;li>å¯ä»¥ä½¿ç”¨ç”¨æˆ·è‡ªå®šä¹‰çš„æ’åºå‡½æ•° / ä»¿å‡½æ•° / lambdaå‡½æ•°&lt;/li>
&lt;/ul>
&lt;h2 id="å®ç°">å®ç° &lt;a href="#%e5%ae%9e%e7%8e%b0" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>ä¸ºäº†ä¸stdä¸­çš„é€šç”¨å‡½æ•°åšåŒºåˆ«ï¼Œè¿™é‡Œçš„å‘½åè§„åˆ™ï¼ŒåŒ…æ‹¬ç±»å‹ä¸å‡½æ•°ï¼Œéƒ½åœ¨å‰é¢åŠ äº†&amp;quot;my&amp;quot;ä»¥ç¤ºåŒºåˆ«ã€‚å¯èƒ½ä¸æ ‡å‡†çš„å‘½åæ³•æœ‰å‡ºå…¥ï¼Œæ‰€ä»¥ä»…åšç¤ºä¾‹ç”¨ã€‚&lt;/p>
&lt;h3 id="æ€è·¯">æ€è·¯ &lt;a href="#%e6%80%9d%e8%b7%af" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;p>** æ‹·è´ä»£ç æ˜¯æ„šè ¢çš„è¡Œä¸ºã€‚**&lt;/p>
&lt;p>æˆ–è€…è¯´ï¼Œ&lt;/p>
&lt;p>** å¯¹äºåŒä¸€é’Ÿå®ç°ï¼Œå°½é‡ä½¿ç”¨åŒä¸€ä»½ä»£ç ã€‚ **&lt;/p>
&lt;p>æ„Ÿè°¢C++ Templatesï¼Œå¯¹äºä¸åŒç±»å‹ä¸éœ€æ±‚çš„å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥å°†ç”Ÿæˆå¤šä»½ä»£ç çš„åŠ³åŠ¨æ”¾å¿ƒçš„äº¤ç»™ç¼–è¯‘å™¨ã€‚å¹¶ä¸”ï¼ŒTemplatesçš„ä»£ç ç”Ÿæˆæ˜¯åœ¨ç¼–è¯‘æœŸå®Œæˆçš„ï¼Œå³ä¸ä¼šé€ æˆé¢å¤–çš„ä»£ç è†¨èƒ€ï¼ˆå¦‚æœä½ å§¿åŠ¿æ­£ç¡®çš„è¯ï¼‰ï¼Œä¹Ÿä¸€èˆ¬ä¸ä¼šé€ æˆé¢å¤–çš„è¿è¡Œæ—¶å¼€é”€ã€‚&lt;/p>
&lt;h3 id="å‡½æ•°åŸå‹">å‡½æ•°åŸå‹ &lt;a href="#%e5%87%bd%e6%95%b0%e5%8e%9f%e5%9e%8b" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;p>æˆ‘ä»¬æ¨¡ä»¿std::sortæ¥è¿›è¡Œå¼€å‘ã€‚&lt;/p>
&lt;pre tabindex="0">&lt;code>template&amp;lt; class It, class Compare &amp;gt;
void sort(It first, It last, Compare comp );
&lt;/code>&lt;/pre>&lt;h3 id="ä»è¿­ä»£å™¨æŒ‡é’ˆè·å¾—å…ƒç´ ç±»å‹">ä»è¿­ä»£å™¨/æŒ‡é’ˆè·å¾—å…ƒç´ ç±»å‹ &lt;a href="#%e4%bb%8e%e8%bf%ad%e4%bb%a3%e5%99%a8%e6%8c%87%e9%92%88%e8%8e%b7%e5%be%97%e5%85%83%e7%b4%a0%e7%b1%bb%e5%9e%8b" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;p>æˆ‘ä»¬è¦å¤„ç†Cé£æ ¼çš„æ•°ç»„ä¸C++ç½‘ç»œçš„å®¹å™¨ã€‚é¦–å…ˆè¦ä»è¿­ä»£å™¨/æŒ‡é’ˆ&lt;code>It&lt;/code>ä¸­è·å¾—å…ƒç´ ç±»å‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">template&lt;/span>&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">typename&lt;/span> It&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">struct&lt;/span> &lt;span style="color:#a6e22e">myiter_traits&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">typedef&lt;/span> &lt;span style="color:#66d9ef">typename&lt;/span> It&lt;span style="color:#f92672">::&lt;/span>value_type value_type;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>};
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">template&lt;/span>&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">typename&lt;/span> T&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">struct&lt;/span> &lt;span style="color:#a6e22e">myiter_traits&lt;/span>&lt;span style="color:#f92672">&amp;lt;&lt;/span>T&lt;span style="color:#f92672">*&amp;gt;&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">typedef&lt;/span> T value_type;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>};
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™ä¸ªå®ç°éå¸¸ç®€å•ï¼Œä¸åšèµ˜è¿°ã€‚&lt;/p>
&lt;h3 id="å®ç°mysortå‡½æ•°">å®ç°mysortå‡½æ•° &lt;a href="#%e5%ae%9e%e7%8e%b0mysort%e5%87%bd%e6%95%b0" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">template&lt;/span>&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">typename&lt;/span> RandomAccessor, &lt;span style="color:#66d9ef">typename&lt;/span> FUNC&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">void&lt;/span> mysort(
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">const&lt;/span> RandomAccessor&lt;span style="color:#f92672">&amp;amp;&lt;/span> head,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">const&lt;/span> RandomAccessor&lt;span style="color:#f92672">&amp;amp;&lt;/span> tail,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> FUNC cmp)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (tail &lt;span style="color:#f92672">-&lt;/span> head &lt;span style="color:#f92672">&amp;lt;=&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">const&lt;/span> RandomAccessor pivot &lt;span style="color:#f92672">=&lt;/span> mypartition(head, tail, cmp);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> mysort(head, pivot, cmp);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> mysort(pivot &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>, tail, cmp);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>mysortå‡½æ•°æœ¬ä½“å¹¶ä¸éš¾ç†è§£ï¼Œè¿™é‡Œé‡ç‚¹è®¨è®ºä¸€ä¸‹æ¨¡æ¿çš„æ€è·¯ã€‚&lt;/p>
&lt;p>ç”±äºè¿­ä»£å™¨ä¸éœ€è¦ç§»åŠ¨ï¼Œæ‰€ä»¥å£°æ˜ä¸ºconst referenceã€‚åˆç”±äºæˆ‘ä»¬éœ€è¦å…¼å®¹å„ç§ä¸åŒç±»å‹çš„æ’åºæ–¹æ³•ï¼ˆå‡½æ•°ã€ä»¿å‡½æ•°ã€lambdaã€std::functionç­‰ï¼‰ï¼Œæ‰€ä»¥ä¸å¯¹&lt;code>FUNC&lt;/code>ç±»å‹è¿›è¡Œé™åˆ¶ï¼Œå³æ‰€æœ‰å¯ä»¥è¢«callçš„ç±»å‹éƒ½å¯ä»¥åšä¸ºæ¨¡æ¿å‚æ•°ã€‚&lt;/p>
&lt;h3 id="å®ç°mypartitionå‡½æ•°">å®ç°mypartitionå‡½æ•° &lt;a href="#%e5%ae%9e%e7%8e%b0mypartition%e5%87%bd%e6%95%b0" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;p>å¿«é€Ÿæ’åºçš„çµé­‚å°±æ˜¯å¿«é€Ÿåˆ’åˆ†ã€‚å¦‚æœå¤„ç†å¾—å½“ï¼Œquick sortå¯ä»¥è§†ä½œä¸€ä¸ªç¨³å®šçš„æ’åºå‡½æ•°ï¼›å¦åˆ™ï¼Œä¸€ç»„æ„é€ ï¼ˆä¸å¿…è¦ç²¾å¿ƒæ„é€ ï¼‰çš„æ•°æ®å°±å¯ä»¥æŠŠquick sortå˜æˆ&amp;quot;slow sort&amp;quot;ã€‚&lt;/p>
&lt;h4 id="å¯èƒ½ä¼šä¸Šquick-sorté€€åŒ–çš„æ•°æ®">å¯èƒ½ä¼šä¸Šquick sorté€€åŒ–çš„æ•°æ® &lt;a href="#%e5%8f%af%e8%83%bd%e4%bc%9a%e4%b8%8aquick-sort%e9%80%80%e5%8c%96%e7%9a%84%e6%95%b0%e6%8d%ae" class="anchor">ğŸ”—&lt;/a>&lt;/h4>&lt;ul>
&lt;li>åŸºæœ¬ä¸€è‡´çš„æ•°æ® &lt;br>
e.g. &lt;code>1, 1, 1, 1 ... 1, 1&lt;/code> or &lt;code>1, 1, ... 2, 2, ... 3, 3&lt;/code>&lt;/li>
&lt;li>æœ‰åºæˆ–åŸºæœ¬æœ‰åºçš„æ•°æ® &lt;br>
e.g. &lt;code>1, 2, ... 5, 6&lt;/code> or &lt;code>6, 5, ... 2, 1&lt;/code>&lt;/li>
&lt;/ul>
&lt;h4 id="è§£å†³æ€è·¯">è§£å†³æ€è·¯ &lt;a href="#%e8%a7%a3%e5%86%b3%e6%80%9d%e8%b7%af" class="anchor">ğŸ”—&lt;/a>&lt;/h4>&lt;p>å¯¹äºæœ‰å¤§é‡é‡å¤çš„æ•°æ®ï¼Œæˆ‘ä»¬åœ¨å¤„ç†æ—¶è¦æ³¨æ„å¹³å‡åˆ†é…è¿™äº›é‡å¤æ•°æ®ã€‚å³ï¼Œå¯¹äºä¸pivotç›¸ç­‰çš„æ•°æ®ï¼Œå°½é‡ä¿è¯ä¸€åŠæ”¾åœ¨å·¦é¢ï¼Œä¸€åŠæ”¾åœ¨å³é¢ã€‚&lt;/p>
&lt;p>å¯¹äºæœ‰åºæˆ–åŸºæœ¬æœ‰åºçš„æ•°æ®ï¼Œæˆ‘ä»¬åœ¨pivotçš„é€‰æ‹©ä¸Šå¯ä»¥ä½¿ç”¨éšæœºã€ä¸‰å€¼æ³•ç­‰æ‰‹æ®µï¼Œä¿è¯æ•°æ®çš„å¹³å‡åˆ†é…ã€‚&lt;/p>
&lt;p>æ€»çš„è¯´æ¥ï¼Œquick sortçš„é«˜æ•ˆæ€§ï¼Œå–å†³äºpartitionå‡½æ•°çš„å¹³å‡åˆ†é…æ€§èƒ½ä¸Šã€‚&lt;/p>
&lt;h4 id="ä¸€ä¸ªå®ç°">ä¸€ä¸ªå®ç° &lt;a href="#%e4%b8%80%e4%b8%aa%e5%ae%9e%e7%8e%b0" class="anchor">ğŸ”—&lt;/a>&lt;/h4>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">template&lt;/span>&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">typename&lt;/span> RandomAccessor, &lt;span style="color:#66d9ef">typename&lt;/span> FUNC&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>RandomAccessor mypartition(
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">const&lt;/span> RandomAccessor&lt;span style="color:#f92672">&amp;amp;&lt;/span> head,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">const&lt;/span> RandomAccessor&lt;span style="color:#f92672">&amp;amp;&lt;/span> tail,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> FUNC cmp)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">auto&lt;/span> dis &lt;span style="color:#f92672">=&lt;/span> distance(head, tail);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> RandomAccessor pivot &lt;span style="color:#f92672">=&lt;/span> head &lt;span style="color:#f92672">+&lt;/span> rand() &lt;span style="color:#f92672">%&lt;/span> dis;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> iter_swap(pivot, head);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> pivot &lt;span style="color:#f92672">=&lt;/span> head;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> RandomAccessor l &lt;span style="color:#f92672">=&lt;/span> head;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> RandomAccessor r &lt;span style="color:#f92672">=&lt;/span> tail &lt;span style="color:#f92672">-&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">int&lt;/span> ptr &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">while&lt;/span> (l &lt;span style="color:#f92672">&amp;lt;=&lt;/span> r) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">while&lt;/span> (l &lt;span style="color:#f92672">&amp;lt;=&lt;/span> r) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">bool&lt;/span> lt &lt;span style="color:#f92672">=&lt;/span> cmp(&lt;span style="color:#f92672">*&lt;/span>l, &lt;span style="color:#f92672">*&lt;/span>pivot);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">bool&lt;/span> gt &lt;span style="color:#f92672">=&lt;/span> cmp(&lt;span style="color:#f92672">*&lt;/span>pivot, &lt;span style="color:#f92672">*&lt;/span>l);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">bool&lt;/span> eq &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#f92672">!&lt;/span>lt &lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span> &lt;span style="color:#f92672">!&lt;/span>gt;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (lt &lt;span style="color:#f92672">||&lt;/span> (eq &lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span> ptr &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>)) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> l&lt;span style="color:#f92672">++&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ptr &lt;span style="color:#f92672">^=&lt;/span> (eq&lt;span style="color:#f92672">?&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> } &lt;span style="color:#66d9ef">else&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">break&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">while&lt;/span> (l &lt;span style="color:#f92672">&amp;lt;=&lt;/span> r) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">bool&lt;/span> lt &lt;span style="color:#f92672">=&lt;/span> cmp(&lt;span style="color:#f92672">*&lt;/span>r, &lt;span style="color:#f92672">*&lt;/span>pivot);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">bool&lt;/span> gt &lt;span style="color:#f92672">=&lt;/span> cmp(&lt;span style="color:#f92672">*&lt;/span>pivot, &lt;span style="color:#f92672">*&lt;/span>r);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">bool&lt;/span> eq &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#f92672">!&lt;/span>lt &lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span> &lt;span style="color:#f92672">!&lt;/span>gt;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (gt &lt;span style="color:#f92672">||&lt;/span> (eq &lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span> ptr &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>)) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> r&lt;span style="color:#f92672">--&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ptr &lt;span style="color:#f92672">^=&lt;/span> (eq&lt;span style="color:#f92672">?&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> } &lt;span style="color:#66d9ef">else&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">break&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (l &lt;span style="color:#f92672">&amp;lt;=&lt;/span> r) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> swap(&lt;span style="color:#f92672">*&lt;/span>l, &lt;span style="color:#f92672">*&lt;/span>r);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> l&lt;span style="color:#f92672">++&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> r&lt;span style="color:#f92672">--&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> iter_swap(pivot, r);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> r;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="ä¸»å‡½æ•°">ä¸»å‡½æ•° &lt;a href="#%e4%b8%bb%e5%87%bd%e6%95%b0" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">int&lt;/span> &lt;span style="color:#a6e22e">main&lt;/span>() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> srand(time(NULL));
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> vector&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">int&lt;/span>&lt;span style="color:#f92672">&amp;gt;&lt;/span> vec({&lt;span style="color:#ae81ff">2&lt;/span>, &lt;span style="color:#ae81ff">1&lt;/span>, &lt;span style="color:#ae81ff">3&lt;/span>, &lt;span style="color:#ae81ff">0&lt;/span>, &lt;span style="color:#ae81ff">4&lt;/span>, &lt;span style="color:#ae81ff">1999&lt;/span>});
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> mysort(vec.begin(), vec.end(), less&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">int&lt;/span>&lt;span style="color:#f92672">&amp;gt;&lt;/span>());
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">for&lt;/span> (&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">auto&lt;/span>&lt;span style="color:#f92672">&amp;amp;&lt;/span> i: vec) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> printf(&lt;span style="color:#e6db74">&amp;#34;%d &amp;#34;&lt;/span>, i);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> puts(&lt;span style="color:#e6db74">&amp;#34;&amp;#34;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">int&lt;/span> array[] &lt;span style="color:#f92672">=&lt;/span> {&lt;span style="color:#ae81ff">99&lt;/span>, &lt;span style="color:#ae81ff">19&lt;/span>, &lt;span style="color:#ae81ff">9999&lt;/span>};
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> mysort(array &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>, array &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">3&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> [](&lt;span style="color:#66d9ef">int&lt;/span> a, &lt;span style="color:#66d9ef">int&lt;/span> b)&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#66d9ef">bool&lt;/span> { &lt;span style="color:#66d9ef">return&lt;/span> a &lt;span style="color:#f92672">&amp;gt;&lt;/span> b; });
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">for&lt;/span> (&lt;span style="color:#66d9ef">int&lt;/span> i &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>; i &lt;span style="color:#f92672">&amp;lt;&lt;/span> &lt;span style="color:#ae81ff">3&lt;/span>; i&lt;span style="color:#f92672">++&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> printf(&lt;span style="color:#e6db74">&amp;#34;%d &amp;#34;&lt;/span>, array[i]);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> puts(&lt;span style="color:#e6db74">&amp;#34;&amp;#34;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>alloca vs placement new</title><link>https://wizmann.top/posts/alloca-vs-placement-new/</link><pubDate>Mon, 07 Apr 2014 21:08:59 +0000</pubDate><guid>https://wizmann.top/posts/alloca-vs-placement-new/</guid><description>&lt;h2 id="what">WHAT?! &lt;a href="#what" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>For most time, we use &lt;code>malloc&lt;/code> or &lt;code>new&lt;/code> for memory allocation, which will get it on &lt;em>heap&lt;/em>.&lt;/p>
&lt;p>However, access memory on &lt;em>heap&lt;/em> is not as effective as the memory on &lt;em>stack&lt;/em>, because the heap is &amp;ldquo;free-floating region of memory&amp;rdquo;. To the contrary, memory on &lt;em>stack&lt;/em> is managed by CPU automacitally and tightly. As a result, the further of the &lt;em>stack&lt;/em> compared to &lt;em>heap&lt;/em> is that we can have a faster read/write speed due to the fact that &lt;em>stack&lt;/em> memory is more likely to optimized by &lt;strong>CPU cache&lt;/strong>, in addition, it only uses a single instruction to allocate or deallocate &lt;em>stack&lt;/em> memory. Just like this.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>sub esp, &lt;span style="color:#ae81ff">0x10&lt;/span>; &lt;span style="color:#f92672">=&amp;gt;&lt;/span> allocate
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>add esp, &lt;span style="color:#ae81ff">0x10&lt;/span>; &lt;span style="color:#f92672">=&amp;gt;&lt;/span> deallocate
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="alloca">alloca &lt;a href="#alloca" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>The &lt;code>alloca()&lt;/code> function allocates memory from the &lt;em>stack&lt;/em>.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">int&lt;/span> &lt;span style="color:#f92672">*&lt;/span>p &lt;span style="color:#f92672">=&lt;/span> (&lt;span style="color:#66d9ef">int&lt;/span>&lt;span style="color:#f92672">*&lt;/span>)alloca(&lt;span style="color:#66d9ef">sizeof&lt;/span>(&lt;span style="color:#66d9ef">int&lt;/span>) &lt;span style="color:#f92672">*&lt;/span> size);
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>It&amp;rsquo;s quite the same as the &lt;code>malloc&lt;/code> way. But we shouldn&amp;rsquo;t free the memory allocated on the &lt;em>stack&lt;/em>; these memory will be automatically deallocated when you leave the function(&lt;strong>not the code block&lt;/strong>).&lt;/p>
&lt;h2 id="placement-new">placement new &lt;a href="#placement-new" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>The placement new is one of the overloads of the &lt;code>new&lt;/code> functions; this new syntax can do something as the &lt;code>alloca()&lt;/code> function.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">char&lt;/span> buffer[&lt;span style="color:#ae81ff">1024&lt;/span>];
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">int&lt;/span> &lt;span style="color:#f92672">*&lt;/span>p &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span>(buffer) &lt;span style="color:#66d9ef">int&lt;/span>[&lt;span style="color:#ae81ff">64&lt;/span>];
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>The placement new can be also used in some other scenarios but won&amp;rsquo;t be mentioned here.&lt;/p>
&lt;h2 id="variable-length-array">variable-length array &lt;a href="#variable-length-array" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>C90 and C++ both support the variable-length array which will be allocated on &lt;em>stack&lt;/em>, and it will be deallocted whhen you leave the &lt;strong>clode block&lt;/strong>, such as &amp;ldquo;if&amp;rdquo;, &amp;ldquo;while&amp;rdquo;, etc.&lt;/p>
&lt;p>This is much simplified, but be ware if you use both variable-length array and &lt;code>alloca()&lt;/code> in the same function, the deallocation of the array will also free anything more recenly allocated by alloca.&lt;/p>
&lt;h2 id="defects">Defects &lt;a href="#defects" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>&lt;em>Stack&lt;/em> has its limitation. If the allocation on &lt;em>stack&lt;/em> causes &lt;strong>stack overflow&lt;/strong> error, then the behavior of the program is undefined.&lt;/p>
&lt;p>Further, the variable-length array and &lt;code>alloca()&lt;/code> are not included in &lt;em>ANSI-C&lt;/em> standard and therefore could limit portability.&lt;/p>
&lt;p>The Google C++ style guide encourage developers to use &lt;code>scoped_ptr&lt;/code> or &lt;code>scopted_array&lt;/code> instead of variable-length array and &lt;code>alloca()&lt;/code>.&lt;/p>
&lt;h2 id="some-experiment">Some experiment &lt;a href="#some-experiment" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// compile with: g++ -std=c++0x -O2 -Wall -g -o &amp;#34;foo.cc&amp;#34; &amp;#34;foo&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;cstdio&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;cstdlib&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;cstring&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;iostream&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;algorithm&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">using&lt;/span> &lt;span style="color:#66d9ef">namespace&lt;/span> std;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#define print(x) cout &amp;lt;&amp;lt; x &amp;lt;&amp;lt; endl
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#define input(x) cin &amp;gt;&amp;gt; x
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#if defined(__i386__)
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">static&lt;/span> __inline__ &lt;span style="color:#66d9ef">unsigned&lt;/span> &lt;span style="color:#66d9ef">long&lt;/span> &lt;span style="color:#66d9ef">long&lt;/span> &lt;span style="color:#a6e22e">rdtsc&lt;/span>(&lt;span style="color:#66d9ef">void&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">unsigned&lt;/span> &lt;span style="color:#66d9ef">long&lt;/span> &lt;span style="color:#66d9ef">long&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> x;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> __asm__ &lt;span style="color:#66d9ef">volatile&lt;/span> (&lt;span style="color:#e6db74">&amp;#34;.byte 0x0f, 0x31&amp;#34;&lt;/span> &lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#e6db74">&amp;#34;=A&amp;#34;&lt;/span> (x));
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> x;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#elif defined(__x86_64__)
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">static&lt;/span> __inline__ &lt;span style="color:#66d9ef">unsigned&lt;/span> &lt;span style="color:#66d9ef">long&lt;/span> &lt;span style="color:#66d9ef">long&lt;/span> &lt;span style="color:#a6e22e">rdtsc&lt;/span>(&lt;span style="color:#66d9ef">void&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">unsigned&lt;/span> hi, lo;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> __asm__ __volatile__ (&lt;span style="color:#e6db74">&amp;#34;rdtsc&amp;#34;&lt;/span> &lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#e6db74">&amp;#34;=a&amp;#34;&lt;/span>(lo), &lt;span style="color:#e6db74">&amp;#34;=d&amp;#34;&lt;/span>(hi));
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> ( (&lt;span style="color:#66d9ef">unsigned&lt;/span> &lt;span style="color:#66d9ef">long&lt;/span> &lt;span style="color:#66d9ef">long&lt;/span>)lo)&lt;span style="color:#f92672">|&lt;/span>( ((&lt;span style="color:#66d9ef">unsigned&lt;/span> &lt;span style="color:#66d9ef">long&lt;/span> &lt;span style="color:#66d9ef">long&lt;/span>)hi)&lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span>&lt;span style="color:#ae81ff">32&lt;/span> );
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#endif
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">//#define MEMORY_ON_HEAP
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">//#define MEMORY_ON_STACK
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> SIZE &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">102400&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">int&lt;/span> &lt;span style="color:#f92672">*&lt;/span>array[SIZE] &lt;span style="color:#f92672">=&lt;/span> {NULL};
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">int&lt;/span> &lt;span style="color:#a6e22e">main&lt;/span>()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">unsigned&lt;/span> &lt;span style="color:#66d9ef">long&lt;/span> &lt;span style="color:#66d9ef">long&lt;/span> start &lt;span style="color:#f92672">=&lt;/span> rdtsc();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">#ifdef MEMORY_ON_HEAP &lt;/span>&lt;span style="color:#75715e">// RDSTC: 20586280
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">for&lt;/span> (&lt;span style="color:#66d9ef">int&lt;/span> i &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>; i &lt;span style="color:#f92672">&amp;lt;&lt;/span> SIZE; i&lt;span style="color:#f92672">++&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> array[i] &lt;span style="color:#f92672">=&lt;/span> (&lt;span style="color:#66d9ef">int&lt;/span>&lt;span style="color:#f92672">*&lt;/span>)malloc(&lt;span style="color:#66d9ef">sizeof&lt;/span>(&lt;span style="color:#66d9ef">int&lt;/span>));
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">*&lt;/span>array[i] &lt;span style="color:#f92672">=&lt;/span> i;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">#endif
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">#ifdef MEMORY_ON_STACK &lt;/span>&lt;span style="color:#75715e">// RDSTC: 3660502
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">for&lt;/span> (&lt;span style="color:#66d9ef">int&lt;/span> i &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>; i &lt;span style="color:#f92672">&amp;lt;&lt;/span> SIZE; i&lt;span style="color:#f92672">++&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> array[i] &lt;span style="color:#f92672">=&lt;/span> (&lt;span style="color:#66d9ef">int&lt;/span>&lt;span style="color:#f92672">*&lt;/span>)alloca(&lt;span style="color:#66d9ef">sizeof&lt;/span>(&lt;span style="color:#66d9ef">int&lt;/span>));
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">*&lt;/span>array[i] &lt;span style="color:#f92672">=&lt;/span> i;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">#endif
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">unsigned&lt;/span> &lt;span style="color:#66d9ef">long&lt;/span> &lt;span style="color:#66d9ef">long&lt;/span> end &lt;span style="color:#f92672">=&lt;/span> rdtsc();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> print(end &lt;span style="color:#f92672">-&lt;/span> start);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>You can use &lt;code>info register esp&lt;/code> in gdb to inspect the &lt;em>stack&lt;/em> pointer before and after you call the allocation function or declare a variable-length array.&lt;/p></description></item></channel></rss>