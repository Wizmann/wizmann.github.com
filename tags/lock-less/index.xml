<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Lock-Less on Maerlyn's Rainbow</title><link>https://wizmann.top/tags/lock-less/</link><description>Recent content in Lock-Less on Maerlyn's Rainbow</description><generator>Hugo -- gohugo.io</generator><language>zh-CN</language><lastBuildDate>Thu, 28 Nov 2013 00:00:00 +0000</lastBuildDate><atom:link href="https://wizmann.top/tags/lock-less/index.xml" rel="self" type="application/rss+xml"/><item><title>Linuxå†…æ ¸ä¸­çš„å°‘é”é“¾è¡¨</title><link>https://wizmann.top/posts/linux-lockless-llist/</link><pubDate>Thu, 28 Nov 2013 00:00:00 +0000</pubDate><guid>https://wizmann.top/posts/linux-lockless-llist/</guid><description>&lt;h1 id="å‰è¨€">å‰è¨€ &lt;a href="#%e5%89%8d%e8%a8%80" class="anchor">ğŸ”—&lt;/a>&lt;/h1>&lt;p>æœ€è¿‘åœ¨stackexchangeä¸Šçœ‹åˆ°ä¸€ä¸ªé—®ç­”ï¼Œè®¨è®ºæˆ‘ä»¬å¸¸ç”¨çš„æ•°æ®ç»“æ„ä¸ç®—æ³•åœ¨å®é™…å·¥ç¨‹ä¸­çš„åº”ç”¨ã€‚(&lt;a href="http://cstheory.stackexchange.com/questions/19759/core-algorithms-deployed/19773#19773">æˆ³æˆ‘&lt;/a>)&lt;/p>
&lt;p>æˆ‘æ‰“ç®—å€ŸåŠ©è¿™ä¸ªé—®ç­”ä¸­çš„å†…å®¹ï¼Œä»¥æˆ‘æ¯”è¾ƒç†Ÿæ‚‰çš„æ•°æ®ç»“æ„ä¸ç®—æ³•ä¸ºç´¢å¼•æ¥é˜…è¯»å¼€æºä»£ç ã€‚&lt;/p>
&lt;h1 id="æ­£æ–‡">æ­£æ–‡ &lt;a href="#%e6%ad%a3%e6%96%87" class="anchor">ğŸ”—&lt;/a>&lt;/h1>&lt;h2 id="talk-is-cheap">Talk is cheap &lt;a href="#talk-is-cheap" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;blockquote>
&lt;p>Lock-less NULL terminated single linked list&lt;/p>&lt;/blockquote>
&lt;p>&lt;a href="https://github.com/mirrors/linux-2.6/blob/master/include/linux/llist.h">linux-2.6/include/linux/llist.h&lt;/a>&lt;/p>
&lt;p>&lt;a href="https://github.com/mirrors/linux-2.6/blob/master/lib/llist.c">linux-2.6/lib/llist.c&lt;/a>&lt;/p>
&lt;h2 id="çŸ¥è¯†å‡†å¤‡">çŸ¥è¯†å‡†å¤‡ &lt;a href="#%e7%9f%a5%e8%af%86%e5%87%86%e5%a4%87" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;h3 id="volatile">volatile &lt;a href="#volatile" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;blockquote>
&lt;p>volatileå…³é”®å­—å£°æ˜çš„å˜é‡æˆ–å¯¹è±¡é€šå¸¸æ‹¥æœ‰å’Œä¼˜åŒ–å’Œï¼ˆæˆ–ï¼‰å¤šçº¿ç¨‹ç›¸å…³çš„ç‰¹æ®Šå±æ€§ã€‚&lt;/p>&lt;/blockquote>
&lt;blockquote>
&lt;p>é€šå¸¸ï¼Œvolatileå…³é”®å­—ç”¨æ¥é˜»æ­¢ï¼ˆä¼ªï¼‰ç¼–è¯‘å™¨å¯¹é‚£äº›å®ƒè®¤ä¸ºå˜é‡çš„å€¼ä¸èƒ½â€œè¢«ä»£ç æœ¬èº«â€æ”¹å˜çš„ä»£ç ä¸Šæ‰§è¡Œä»»ä½•ä¼˜åŒ–ã€‚&lt;/p>&lt;/blockquote>
&lt;blockquote>
&lt;p>å¦‚æœä¸ä½¿ç”¨volatileå…³é”®å­—ï¼Œç¼–è¯‘å™¨å°†å‡è®¾å½“å‰ç¨‹åºæ˜¯ç³»ç»Ÿä¸­å”¯ä¸€èƒ½æ”¹å˜è¿™ä¸ªå€¼éƒ¨åˆ†ã€‚ ä¸ºäº†é˜»æ­¢ç¼–è¯‘å™¨åƒä¸Šé¢é‚£æ ·ä¼˜åŒ–ä»£ç ï¼Œéœ€è¦ä½¿ç”¨volatileå…³é”®å­—ã€‚&lt;/p>&lt;/blockquote>
&lt;blockquote>
&lt;p>From: &lt;a href="http://zh.wikipedia.org/wiki/Volatile%E5%8F%98%E9%87%8F">http://zh.wikipedia.org/wiki/Volatile%E5%8F%98%E9%87%8F&lt;/a>&lt;/p>&lt;/blockquote>
&lt;h3 id="typeof">typeof &lt;a href="#typeof" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;blockquote>
&lt;p>Another way to refer to the type of an expression is with typeof. The syntax of using of this keyword looks like sizeof, but the construct acts semantically like a type name defined with typedef.&lt;/p>&lt;/blockquote>
&lt;blockquote>
&lt;p>From: &lt;a href="http://gcc.gnu.org/onlinedocs/gcc/Typeof.html">http://gcc.gnu.org/onlinedocs/gcc/Typeof.html&lt;/a>&lt;/p>&lt;/blockquote>
&lt;p>&lt;code>typeof&lt;/code>å’Œ&lt;code>sizeof&lt;/code>ç±»ä¼¼ï¼Œsizeofæ±‚çš„æ˜¯å˜é‡/ç±»å‹çš„å¤§å°ï¼Œè€Œtypeofæ˜¯æ±‚å˜é‡/ç±»å‹çš„&lt;strong>æ•°æ®ç±»å‹&lt;/strong>ã€‚&lt;/p>
&lt;p>typeofåœ¨#defineä¸­çš„åº”ç”¨å¾ˆå¤šï¼Œä¾‹å¦‚ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#define max(a,b) \
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> ({ typeof (a) _a = (a); \
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> typeof (b) _b = (b); \
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> _a &amp;gt; _b ? _a : _b; })
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>typeof(a)&lt;/code>è·å¾—äº†&lt;code>a&lt;/code>çš„ç±»å‹ï¼Œå£°æ˜äº†ä¸€ä¸ªåŒç±»å‹çš„&lt;code>_a&lt;/code>å˜é‡ã€‚&lt;/p>
&lt;p>p.s. ä¸Šé¢æ˜¯ä¸€ä¸ªå®‰å…¨çš„ç”¨&lt;code>#define&lt;/code>å®ç°çš„&lt;code>max&lt;/code>å‡½æ•°ã€‚&lt;/p>
&lt;h3 id="access_once">ACCESS_ONCE &lt;a href="#access_once" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#define ACCESS_ONCE(x) (*(volatile typeof(x) *)&amp;amp;(x))ï¼›
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>ACCESS_ONCE&lt;/code>ä½¿ç”¨äº†ä¸€ä¸ªç±»å‹è½¬æ¢ï¼Œä½¿ç”¨&lt;code>volatile&lt;/code>ä¿®é¥° &lt;code>x&lt;/code>ã€‚é¿å…ç¼–è¯‘å™¨ä¼˜åŒ–å¸¦æ¥çš„æ½œåœ¨å²ä¹‰ã€‚&lt;/p>
&lt;h3 id="cmpxchg">cmpxchg &lt;a href="#cmpxchg" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;blockquote>
&lt;p>compare-and-swap (CAS) is an atomic instruction used in multithreading to achieve synchronization.&lt;/p>&lt;/blockquote>
&lt;blockquote>
&lt;p>It compares the contents of a memory location to a given value and, only if they are the same, modifies the contents of that memory location to a given new value.&lt;/p>&lt;/blockquote>
&lt;blockquote>
&lt;p>This is done as a single atomic operation. The atomicity guarantees that the new value is calculated based on up-to-date information; if the value had been updated by another thread in the meantime, the write would fail.&lt;/p>&lt;/blockquote>
&lt;blockquote>
&lt;p>The result of the operation must indicate whether it performed the substitution; this can be done either with a simple Boolean response (this variant is often called compare-and-set), or by returning the value read from the memory location (not the value written to it).&lt;/p>&lt;/blockquote>
&lt;blockquote>
&lt;p>&amp;hellip;&lt;/p>&lt;/blockquote>
&lt;blockquote>
&lt;p>In the x86 (since 80486) and Itanium architectures this is implemented as the compare and exchange (CMPXCHG) instruction, though here the LOCK prefix should be there to make it really atomic.&lt;/p>&lt;/blockquote>
&lt;blockquote>
&lt;p>From: &lt;a href="http://en.wikipedia.org/wiki/Compare-and-swap">http://en.wikipedia.org/wiki/Compare-and-swap&lt;/a>&lt;/p>&lt;/blockquote>
&lt;p>&lt;code>cmpxchg&lt;/code>æ˜¯åœ¨Intelå¹³å°ä¸Š&lt;code>atomic compare-and-swap&lt;/code>æ“ä½œçš„å®ç°ã€‚&lt;/p>
&lt;p>&lt;code>cmpxchg&lt;/code>è¿˜è¢«ç”¨æ¥å®ç°&lt;code>spinlock&lt;/code>ï¼Œ&lt;a href="http://stackoverflow.com/questions/6935442/x86-spinlock-using-cmpxchg">æˆ³æˆ‘&lt;/a>ã€‚&lt;/p>
&lt;h2 id="show-me-the-code">Show me the code &lt;a href="#show-me-the-code" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;h3 id="æ•°æ®ç±»å‹">æ•°æ®ç±»å‹ &lt;a href="#%e6%95%b0%e6%8d%ae%e7%b1%bb%e5%9e%8b" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">struct&lt;/span> llist_head {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">struct&lt;/span> llist_node &lt;span style="color:#f92672">*&lt;/span>first;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>};
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">struct&lt;/span> llist_node {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">struct&lt;/span> llist_node &lt;span style="color:#f92672">*&lt;/span>next;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>};
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¸€ä¸ªç®€å•çš„ç±»å‹åŒ…è£¹ã€‚&lt;/p>
&lt;p>&lt;code>llist_head&lt;/code>æ˜¯é“¾è¡¨å¤´ï¼Œè€Œ&lt;code>llist_node&lt;/code>æ˜¯é“¾è¡¨ä¸­&lt;strong>é“¾&lt;/strong>çš„éƒ¨åˆ†ã€‚&lt;/p>
&lt;h3 id="åˆå§‹åŒ–">åˆå§‹åŒ– &lt;a href="#%e5%88%9d%e5%a7%8b%e5%8c%96" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#define LLIST_HEAD_INIT(name) { NULL }
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#define LLIST_HEAD(name) struct llist_head name = LLIST_HEAD_INIT(name)
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">/**
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * init_llist_head - initialize lock-less list head
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * @head: the head for your lock-less list
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">inline&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">init_llist_head&lt;/span>(&lt;span style="color:#66d9ef">struct&lt;/span> llist_head &lt;span style="color:#f92672">*&lt;/span>list)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> list&lt;span style="color:#f92672">-&amp;gt;&lt;/span>first &lt;span style="color:#f92672">=&lt;/span> NULL;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="é“¾è¡¨çš„éå†">é“¾è¡¨çš„éå† &lt;a href="#%e9%93%be%e8%a1%a8%e7%9a%84%e9%81%8d%e5%8e%86" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;h4 id="llist_entry">llist_entry &lt;a href="#llist_entry" class="anchor">ğŸ”—&lt;/a>&lt;/h4>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">/**
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * llist_entry - get the struct of this entry
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * @ptr: the &amp;amp;struct llist_node pointer.
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * @type: the type of the struct this is embedded in.
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * @member: the name of the llist_node within the struct.
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#define llist_entry(ptr, type, member) \
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> container_of(ptr, type, member)
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å£°æ˜ä¸€ä¸ªé“¾è¡¨æ—¶ï¼Œæˆ‘ä»¬éœ€è¦æŠŠ&lt;code>llist_node&lt;/code>åŒ…å«åœ¨é“¾è¡¨èŠ‚ç‚¹ä¸­ï¼Œ&lt;code>llist_head&lt;/code>æ˜¯é“¾è¡¨å¤´ã€‚&lt;/p>
&lt;p>&lt;code>llist_entry&lt;/code>æ˜¯ä»é“¾è¡¨èŠ‚ç‚¹ä¸­çš„&lt;code>llist_node&lt;/code>æˆå‘˜å˜é‡è·å¾—é“¾è¡¨èŠ‚ç‚¹çš„åœ°å€ã€‚&lt;/p>
&lt;p>&lt;code>llist_entry&lt;/code>å®æ˜¯ä»&lt;code>container_of&lt;/code>å®ç»§æ‰¿è€Œæ¥çš„ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">/**
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * container_of - cast a member of a structure out to the containing structure
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * @ptr: the pointer to the member.
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * @type: the type of the container struct this is embedded in.
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * @member: the name of the member within the struct.
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> *
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#define container_of(ptr, type, member) ({ \
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> const typeof( ((type *)0)-&amp;gt;member ) *__mptr = (ptr); \
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> (type *)( (char *)__mptr - offsetof(type,member) );})
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å…·ä½“åŸç†å¯ä»¥å°å°å‚è€ƒä¸€ä¸‹&lt;a href="http://hi.baidu.com/holinux/item/af2e32c9dcbd3953ac00ef49">è¿™é‡Œ&lt;/a>ã€‚&lt;/p>
&lt;h4 id="for_each">for_each &lt;a href="#for_each" class="anchor">ğŸ”—&lt;/a>&lt;/h4>&lt;h5 id="llist_for_each">llist_for_each &lt;a href="#llist_for_each" class="anchor">ğŸ”—&lt;/a>&lt;/h5>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">/**
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * llist_for_each - iterate over some deleted entries of a lock-less list
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * @pos: the &amp;amp;struct llist_node to use as a loop cursor
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * @node: the first entry of deleted list entries
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> *
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * In general, some entries of the lock-less list can be traversed
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * safely only after being deleted from list, so start with an entry
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * instead of list head.
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> *
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * If being used on entries deleted from lock-less list directly, the
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * traverse order is from the newest to the oldest added entry. If
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * you want to traverse from the oldest to the newest, you must
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * reverse the order by yourself before traversing.
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#define llist_for_each(pos, node) \
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> for ((pos) = (node); pos; (pos) = (pos)-&amp;gt;next)
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¸€ä¸ª&lt;code>forå¾ªç¯&lt;/code>ã€‚ç®€å•çš„å®ã€‚&lt;/p>
&lt;h5 id="llist_for_each_entry">llist_for_each_entry &lt;a href="#llist_for_each_entry" class="anchor">ğŸ”—&lt;/a>&lt;/h5>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">/**
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * llist_for_each_entry - iterate over some deleted entries of lock-less list of given type
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * @pos: the type * to use as a loop cursor.
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * @node: the fist entry of deleted list entries.
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * @member: the name of the llist_node with the struct.
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> *
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * In general, some entries of the lock-less list can be traversed
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * safely only after being removed from list, so start with an entry
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * instead of list head.
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> *
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * If being used on entries deleted from lock-less list directly, the
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * traverse order is from the newest to the oldest added entry. If
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * you want to traverse from the oldest to the newest, you must
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * reverse the order by yourself before traversing.
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#define llist_for_each_entry(pos, node, member) \
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> for ((pos) = llist_entry((node), typeof(*(pos)), member); \
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> &amp;amp;(pos)-&amp;gt;member != NULL; \
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> (pos) = llist_entry((pos)-&amp;gt;member.next, typeof(*(pos)), member))
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>éå†é“¾è¡¨çš„ç±»ã€‚
ç”¨ä¼ªä»£ç æ¥è¡¨è¿°ä¸€ä¸‹å°±æ˜¯ã€‚&lt;/p>
&lt;pre tabindex="0">&lt;code>for ((pos) = é“¾è¡¨èŠ‚ç‚¹;
&amp;amp;(pos)-&amp;gt;nextæŒ‡é’ˆ != NULL;
(pos) = é“¾è¡¨ä¸‹ä¸€ä¸ªèŠ‚ç‚¹) {
// éå†æ“ä½œ
pos.foo = bar;
}
&lt;/code>&lt;/pre>&lt;h5 id="llist_for_each_entry_safe">llist_for_each_entry_safe &lt;a href="#llist_for_each_entry_safe" class="anchor">ğŸ”—&lt;/a>&lt;/h5>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">/**
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * llist_for_each_entry_safe - iterate over some deleted entries of lock-less list of given type
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * safe against removal of list entry
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * @pos: the type * to use as a loop cursor.
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * @n: another type * to use as temporary storage
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * @node: the first entry of deleted list entries.
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * @member: the name of the llist_node with the struct.
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> *
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * In general, some entries of the lock-less list can be traversed
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * safely only after being removed from list, so start with an entry
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * instead of list head.
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> *
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * If being used on entries deleted from lock-less list directly, the
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * traverse order is from the newest to the oldest added entry. If
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * you want to traverse from the oldest to the newest, you must
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * reverse the order by yourself before traversing.
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#define llist_for_each_entry_safe(pos, n, node, member) \
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> for (pos = llist_entry((node), typeof(*pos), member); \
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> &amp;amp;pos-&amp;gt;member != NULL &amp;amp;&amp;amp; \
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> (n = llist_entry(pos-&amp;gt;member.next, typeof(*n), member), true); \
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> pos = n)
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>safe&lt;/code>è¡¨ç¤ºå•é“¾è¡¨ä¸­çš„èŠ‚ç‚¹æœ‰å¯èƒ½è¢«å¢åŠ /åˆ é™¤ã€‚&lt;/p>
&lt;p>ä½¿ç”¨&lt;code>(n = llist_entry(pos-&amp;gt;member.next, typeof(*n), member), true)&lt;/code>å¯ä»¥ä¿æŒéå†çš„å®‰å…¨æ€§ã€‚&lt;/p>
&lt;h6 id="llist_next">llist_next &lt;a href="#llist_next" class="anchor">ğŸ”—&lt;/a>&lt;/h6>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">inline&lt;/span> &lt;span style="color:#66d9ef">struct&lt;/span> llist_node &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#a6e22e">llist_next&lt;/span>(&lt;span style="color:#66d9ef">struct&lt;/span> llist_node &lt;span style="color:#f92672">*&lt;/span>node)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> node&lt;span style="color:#f92672">-&amp;gt;&lt;/span>next;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="é“¾è¡¨å…ƒç´ çš„æ“ä½œ">é“¾è¡¨å…ƒç´ çš„æ“ä½œ &lt;a href="#%e9%93%be%e8%a1%a8%e5%85%83%e7%b4%a0%e7%9a%84%e6%93%8d%e4%bd%9c" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;h5 id="llist_add_batch">llist_add_batch &lt;a href="#llist_add_batch" class="anchor">ğŸ”—&lt;/a>&lt;/h5>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">/**
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * llist_add_batch - add several linked entries in batch
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * @new_first: first entry in batch to be added
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * @new_last: last entry in batch to be added
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * @head: the head for your lock-less list
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> *
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * Return whether list is empty before adding.
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">bool&lt;/span> &lt;span style="color:#a6e22e">llist_add_batch&lt;/span>(&lt;span style="color:#66d9ef">struct&lt;/span> llist_node &lt;span style="color:#f92672">*&lt;/span>new_first, &lt;span style="color:#66d9ef">struct&lt;/span> llist_node &lt;span style="color:#f92672">*&lt;/span>new_last,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">struct&lt;/span> llist_head &lt;span style="color:#f92672">*&lt;/span>head)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">struct&lt;/span> llist_node &lt;span style="color:#f92672">*&lt;/span>first;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">do&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> new_last&lt;span style="color:#f92672">-&amp;gt;&lt;/span>next &lt;span style="color:#f92672">=&lt;/span> first &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">ACCESS_ONCE&lt;/span>(head&lt;span style="color:#f92672">-&amp;gt;&lt;/span>first);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> } &lt;span style="color:#66d9ef">while&lt;/span> (&lt;span style="color:#a6e22e">cmpxchg&lt;/span>(&lt;span style="color:#f92672">&amp;amp;&lt;/span>head&lt;span style="color:#f92672">-&amp;gt;&lt;/span>first, first, new_first) &lt;span style="color:#f92672">!=&lt;/span> first);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#f92672">!&lt;/span>first;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ‰¹é‡å¢åŠ å‘½ä»¤ï¼Œä½¿ç”¨&lt;code>cmpxchg&lt;/code>ä¿æŒçº¿ç¨‹å®‰å…¨ã€‚&lt;/p>
&lt;h5 id="llist_add">llist_add &lt;a href="#llist_add" class="anchor">ğŸ”—&lt;/a>&lt;/h5>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">/**
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * llist_add - add a new entry
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * @new: new entry to be added
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * @head: the head for your lock-less list
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> *
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * Returns true if the list was empty prior to adding this entry.
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">inline&lt;/span> &lt;span style="color:#66d9ef">bool&lt;/span> &lt;span style="color:#a6e22e">llist_add&lt;/span>(&lt;span style="color:#66d9ef">struct&lt;/span> llist_node &lt;span style="color:#f92672">*&lt;/span>new, &lt;span style="color:#66d9ef">struct&lt;/span> llist_head &lt;span style="color:#f92672">*&lt;/span>head)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#a6e22e">llist_add_batch&lt;/span>(new, new, head);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="llist_empty">llist_empty &lt;a href="#llist_empty" class="anchor">ğŸ”—&lt;/a>&lt;/h5>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">/**
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * llist_empty - tests whether a lock-less list is empty
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * @head: the list to test
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> *
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * Not guaranteed to be accurate or up to date. Just a quick way to
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * test whether the list is empty without deleting something from the
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * list.
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">inline&lt;/span> &lt;span style="color:#66d9ef">bool&lt;/span> &lt;span style="color:#a6e22e">llist_empty&lt;/span>(&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">struct&lt;/span> llist_head &lt;span style="color:#f92672">*&lt;/span>head)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#a6e22e">ACCESS_ONCE&lt;/span>(head&lt;span style="color:#f92672">-&amp;gt;&lt;/span>first) &lt;span style="color:#f92672">==&lt;/span> NULL;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä½¿ç”¨&lt;code>ACCESS_ONCE&lt;/code>é¿å…ç¼–è¯‘å™¨ä¼˜åŒ–ï¼Œä¿æŒçº¿ç¨‹å®‰å…¨æ€§ã€‚&lt;/p>
&lt;h5 id="llist_del_all">llist_del_all &lt;a href="#llist_del_all" class="anchor">ğŸ”—&lt;/a>&lt;/h5>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">/**
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * llist_del_all - delete all entries from lock-less list
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * @head: the head of lock-less list to delete all entries
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> *
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * If list is empty, return NULL, otherwise, delete all entries and
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * return the pointer to the first entry. The order of entries
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * deleted is from the newest to the oldest added one.
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">inline&lt;/span> &lt;span style="color:#66d9ef">struct&lt;/span> llist_node &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#a6e22e">llist_del_all&lt;/span>(&lt;span style="color:#66d9ef">struct&lt;/span> llist_head &lt;span style="color:#f92672">*&lt;/span>head)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#a6e22e">xchg&lt;/span>(&lt;span style="color:#f92672">&amp;amp;&lt;/span>head&lt;span style="color:#f92672">-&amp;gt;&lt;/span>first, NULL);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="llist_del_first">llist_del_first &lt;a href="#llist_del_first" class="anchor">ğŸ”—&lt;/a>&lt;/h5>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">/**
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * llist_del_first - delete the first entry of lock-less list
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * @head: the head for your lock-less list
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> *
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * If list is empty, return NULL, otherwise, return the first entry
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * deleted, this is the newest added one.
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> *
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * Only one llist_del_first user can be used simultaneously with
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * multiple llist_add users without lock. Because otherwise
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * llist_del_first, llist_add, llist_add (or llist_del_all, llist_add,
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * llist_add) sequence in another user may change @head-&amp;gt;first-&amp;gt;next,
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * but keep @head-&amp;gt;first. If multiple consumers are needed, please
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * use llist_del_all or use lock between consumers.
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">struct&lt;/span> llist_node &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#a6e22e">llist_del_first&lt;/span>(&lt;span style="color:#66d9ef">struct&lt;/span> llist_head &lt;span style="color:#f92672">*&lt;/span>head)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">struct&lt;/span> llist_node &lt;span style="color:#f92672">*&lt;/span>entry, &lt;span style="color:#f92672">*&lt;/span>old_entry, &lt;span style="color:#f92672">*&lt;/span>next;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> entry &lt;span style="color:#f92672">=&lt;/span> head&lt;span style="color:#f92672">-&amp;gt;&lt;/span>first;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">for&lt;/span> (;;) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (entry &lt;span style="color:#f92672">==&lt;/span> NULL)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> NULL;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> old_entry &lt;span style="color:#f92672">=&lt;/span> entry;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> next &lt;span style="color:#f92672">=&lt;/span> entry&lt;span style="color:#f92672">-&amp;gt;&lt;/span>next;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> entry &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">cmpxchg&lt;/span>(&lt;span style="color:#f92672">&amp;amp;&lt;/span>head&lt;span style="color:#f92672">-&amp;gt;&lt;/span>first, old_entry, next);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (entry &lt;span style="color:#f92672">==&lt;/span> old_entry)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">break&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> entry;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>åˆ é™¤ç¬¬ä¸€ä¸ªå€¼ã€‚åŒæ ·çš„æ— é”æ“ä½œã€‚&lt;/p>
&lt;h5 id="llist_reverse_order">llist_reverse_order &lt;a href="#llist_reverse_order" class="anchor">ğŸ”—&lt;/a>&lt;/h5>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">/**
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * llist_reverse_order - reverse order of a llist chain
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * @head: first item of the list to be reversed
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> *
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * Reverse the order of a chain of llist entries and return the
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * new first entry.
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">struct&lt;/span> llist_node &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#a6e22e">llist_reverse_order&lt;/span>(&lt;span style="color:#66d9ef">struct&lt;/span> llist_node &lt;span style="color:#f92672">*&lt;/span>head)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">struct&lt;/span> llist_node &lt;span style="color:#f92672">*&lt;/span>new_head &lt;span style="color:#f92672">=&lt;/span> NULL;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">while&lt;/span> (head) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">struct&lt;/span> llist_node &lt;span style="color:#f92672">*&lt;/span>tmp &lt;span style="color:#f92672">=&lt;/span> head;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> head &lt;span style="color:#f92672">=&lt;/span> head&lt;span style="color:#f92672">-&amp;gt;&lt;/span>next;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> tmp&lt;span style="color:#f92672">-&amp;gt;&lt;/span>next &lt;span style="color:#f92672">=&lt;/span> new_head;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> new_head &lt;span style="color:#f92672">=&lt;/span> tmp;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> new_head;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a6e22e">EXPORT_SYMBOL_GPL&lt;/span>(llist_reverse_order);
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¦‚ä½•åè½¬ä¸€ä¸ªå•é“¾è¡¨&lt;/p>
&lt;h2 id="å°‘é”é“¾è¡¨æ˜¯å¦‚ä½•å®ç°çš„">å°‘é”é“¾è¡¨æ˜¯å¦‚ä½•å®ç°çš„ &lt;a href="#%e5%b0%91%e9%94%81%e9%93%be%e8%a1%a8%e6%98%af%e5%a6%82%e4%bd%95%e5%ae%9e%e7%8e%b0%e7%9a%84" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;h3 id="addå‡½æ•°ä¸­çš„åŸå­æ“ä½œ">addå‡½æ•°ä¸­çš„åŸå­æ“ä½œ &lt;a href="#add%e5%87%bd%e6%95%b0%e4%b8%ad%e7%9a%84%e5%8e%9f%e5%ad%90%e6%93%8d%e4%bd%9c" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">do&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> new_last&lt;span style="color:#f92672">-&amp;gt;&lt;/span>next &lt;span style="color:#f92672">=&lt;/span> first &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">ACCESS_ONCE&lt;/span>(head&lt;span style="color:#f92672">-&amp;gt;&lt;/span>first);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>} &lt;span style="color:#66d9ef">while&lt;/span> (&lt;span style="color:#a6e22e">cmpxchg&lt;/span>(&lt;span style="color:#f92672">&amp;amp;&lt;/span>head&lt;span style="color:#f92672">-&amp;gt;&lt;/span>first, first, new_first) &lt;span style="color:#f92672">!=&lt;/span> first);
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å…¶ä¸­&lt;code>cmpxchg&lt;/code>çš„æ€§è´¨ç±»ä¼¼äºé”ã€‚ä¿è¯èµ‹å€¼æ˜¯æˆåŠŸçš„ä¸”æ˜¯æ˜¯åŸå­çš„ã€‚&lt;/p>
&lt;h3 id="del_firstä¸­çš„åŸå­æ“ä½œ">del_firstä¸­çš„åŸå­æ“ä½œ &lt;a href="#del_first%e4%b8%ad%e7%9a%84%e5%8e%9f%e5%ad%90%e6%93%8d%e4%bd%9c" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>entry &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">cmpxchg&lt;/span>(&lt;span style="color:#f92672">&amp;amp;&lt;/span>head&lt;span style="color:#f92672">-&amp;gt;&lt;/span>first, old_entry, next);
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="del_allä¸­çš„åŸå­æ“ä½œ">del_allä¸­çš„åŸå­æ“ä½œ &lt;a href="#del_all%e4%b8%ad%e7%9a%84%e5%8e%9f%e5%ad%90%e6%93%8d%e4%bd%9c" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#a6e22e">xchg&lt;/span>(&lt;span style="color:#f92672">&amp;amp;&lt;/span>head&lt;span style="color:#f92672">-&amp;gt;&lt;/span>first, NULL);
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="å°‘é”é“¾è¡¨å¦‚ä½•å¤„ç†å¹¶å‘">å°‘é”é“¾è¡¨å¦‚ä½•å¤„ç†å¹¶å‘ &lt;a href="#%e5%b0%91%e9%94%81%e9%93%be%e8%a1%a8%e5%a6%82%e4%bd%95%e5%a4%84%e7%90%86%e5%b9%b6%e5%8f%91" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;p>åœ¨llist.hä¸­æœ‰å¦‚ä¸‹çš„æ³¨é‡Šè¡¨æ˜å¦‚æœä¸¤ç§æ“ä½œå¹¶å‘æ‰§è¡Œï¼Œæ˜¯å¦éœ€è¦åŠ é¢å¤–çš„é”ã€‚&lt;/p>
&lt;pre tabindex="0">&lt;code> /*
* | add | del_first | del_all
* add | - | - | -
* del_first | | L | L
* del_all | | | -
*/
&lt;/code>&lt;/pre>&lt;p>&lt;code>add&lt;/code>æ“ä½œå’Œå¤´æŒ‡é’ˆæ²¡æœ‰å…³ç³»ï¼Œæ‰€ä»¥å®ƒå¯ä»¥å’Œå…¶å®ƒæ“ä½œå¹¶è¡Œã€‚
&lt;code>del_first&lt;/code>ä¾èµ–äº&lt;code>list-&amp;gt;first-&amp;gt;next&lt;/code>åœ¨æ“ä½œæ—¶ä¸å˜åŒ–ã€‚
è€Œ&lt;code>del_all&lt;/code>åªå¯¹&lt;code>list-&amp;gt;first&lt;/code>çš„æŒ‡é’ˆè¿›è¡Œæ“ä½œã€‚æ‰€ä»¥æ˜¯å¯ä»¥å¹¶è¡Œçš„ã€‚&lt;/p>
&lt;h3 id="å°‘é”é“¾è¡¨å¦‚ä½•å¤„ç†éå†">å°‘é”é“¾è¡¨å¦‚ä½•å¤„ç†éå† &lt;a href="#%e5%b0%91%e9%94%81%e9%93%be%e8%a1%a8%e5%a6%82%e4%bd%95%e5%a4%84%e7%90%86%e9%81%8d%e5%8e%86" class="anchor">ğŸ”—&lt;/a>&lt;/h3>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">/*
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * The list entries deleted via llist_del_all can be traversed with
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * traversing function such as llist_for_each etc. But the list
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * entries can not be traversed safely before deleted from the list.
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * The order of deleted entries is from the newest to the oldest added
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * one. If you want to traverse from the oldest to the newest, you
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * must reverse the order by yourself before traversing.
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¤§æ¦‚æ„æ€æ˜¯è¯´åªæœ‰ä»åˆ—è¡¨ä¸Šåˆ é™¤ä¸‹æ¥çš„å…ƒç´ æ‰å¯ä»¥å®‰å…¨çš„éå†ã€‚ï¼ˆè¿™ç‚¹ç†è§£çš„ä¸æ·±å…¥ï¼‰&lt;/p>
&lt;h2 id="åè®°">åè®° &lt;a href="#%e5%90%8e%e8%ae%b0" class="anchor">ğŸ”—&lt;/a>&lt;/h2>&lt;p>æœ¬æ¥æ˜¯æƒ³æŠŠè¿™llistçš„ä»£ç çœ‹æ˜ç™½çš„ã€‚ä½†æ˜¯ï¼Œå¤§æ¦‚åªçœ‹æ‡‚äº†60%ã€‚ã€‚ã€‚&lt;/p>
&lt;p>ä»¥åå¦‚æœæœ‰æ–°çš„æƒ³æ³•ï¼Œçœ‹åˆ°äº†æ–°çš„ä¸œè¥¿ï¼Œä¹Ÿè®¸ä¼šæœ‰ä¸å°‘æœ‰ç”¨çš„updateå§ã€‚ã€‚&lt;/p></description></item></channel></rss>