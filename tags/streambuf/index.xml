<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Streambuf on Maerlyn's Rainbow</title><link>https://wizmann.top/tags/streambuf/</link><description>Recent content in Streambuf on Maerlyn's Rainbow</description><generator>Hugo -- gohugo.io</generator><language>zh-CN</language><lastBuildDate>Wed, 28 Sep 2016 22:35:55 +0000</lastBuildDate><atom:link href="https://wizmann.top/tags/streambuf/index.xml" rel="self" type="application/rss+xml"/><item><title>è‡ªå®šä¹‰ä½ çš„stream buffer - phxrpcé˜…è¯»ç¬”è®°(1)</title><link>https://wizmann.top/posts/phxrpc-1/</link><pubDate>Wed, 28 Sep 2016 22:35:55 +0000</pubDate><guid>https://wizmann.top/posts/phxrpc-1/</guid><description>&lt;h2 id="å†™åœ¨å‰é¢">å†™åœ¨å‰é¢ &lt;a href="#%e5%86%99%e5%9c%a8%e5%89%8d%e9%9d%a2" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;p>&lt;a href="https://github.com/tencent-wechat/phxrpc">phxrpc&lt;/a>æ˜¯å¾®ä¿¡å›¢é˜Ÿå¼€æºçš„ä¸€ä¸ªè½»é‡çº§RPCæ¡†æž¶ã€‚&lt;/p>
&lt;p>æˆ‘å¯¹RPCè¿™äº›ä¸œè¥¿äº†è§£ä¸å¤šï¼Œçœ‹åˆ°phxrpcçš„ä»£ç ç›¸å¯¹ç®€å•ï¼Œè€Œä¸”è¿˜åœ¨åˆæ­¥å¼€å‘é˜¶æ®µï¼ˆåœ¨æœ¬æ–‡å†™ä½œæ—¶ï¼Œç‰ˆæœ¬å·æ˜¯0.8ï¼‰ã€‚æ‰€ä»¥æƒ³è¯»ä¸€è¯»ï¼Œæé«˜ä¸€ä¸‹å§¿åŠ¿æ°´å¹³ã€‚&lt;/p>
&lt;p>å°±æ˜¯è¿™æ ·ã€‚&lt;/p>
&lt;h2 id="è‡ªå®šä¹‰stream-buffer">è‡ªå®šä¹‰stream buffer &lt;a href="#%e8%87%aa%e5%ae%9a%e4%b9%89stream-buffer" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;p>&lt;code>network/socket_stream_base.[h|cpp]&lt;/code>ä¸­çš„&lt;code>class BaseTcpStreamBuf&lt;/code>ç»§æ‰¿äº†&lt;code>std::streambuf&lt;/code>ï¼Œè‡ªå®šä¹‰äº†ä¸€ä¸ªæµç¼“å†²åŒºï¼Œç”¨äºŽæŽ¥æ”¶/å‘é€TCPæ•°æ®åŒ…ã€‚&lt;/p>
&lt;p>è¿™ä¸ªç”¨æ³•æ¯”è¾ƒæ–°é¢–ï¼ˆæˆ–è€…æ˜¯æˆ‘è§è¯†å°‘ï¼‰ï¼Œç½‘ä¸Šçš„èµ„æ–™ä¹Ÿä¸å¤šã€‚è¿™é‡Œç¿»è¯‘ä¸€ç¯‡&lt;a href="http://www.mr-edd.co.uk/blog/beginners_guide_streambuf">ä»‹ç»æ–‡ç« &lt;/a>ï¼Œå­¦ä¹ ä¸€ä¸‹æ–°å§¿åŠ¿ã€‚&lt;/p>
&lt;h2 id="a-beginners-guide-to-writing-a-custom-stream-buffer">A beginner&amp;rsquo;s guide to writing a custom stream buffer &lt;a href="#a-beginners-guide-to-writing-a-custom-stream-buffer" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;p>æµ(streams)æ˜¯STLä¸­æä¾›çš„ä¸€ä¸ªé‡è¦çš„æŠ½è±¡æ¦‚å¿µã€‚è‘—åçš„â€œHello worldâ€ç¨‹åºï¼Œä¾¿æ˜¯ä½¿ç”¨äº†std::coutå°†å­—ç¬¦ä¸²å†™å…¥æ ‡å‡†è¾“å‡ºæµ(stdout)ã€‚&lt;/p>
&lt;p>æµå½“ç„¶å¯ä»¥åšæ¯”cin/coutæ›´æœ‰æ„æ€çš„äº‹ã€‚è¿™ç¯‡æ–‡ç« æˆ‘ä»¬ä¼šç ”ç©¶å¦‚ä½•æ‰©å±•C++æµï¼Œæ¥å®žçŽ°è‡ªå®šä¹‰çš„æµç¼“å†²åŒº(stream buffer)ã€‚p.s. å»ºè®®æœ¬æ–‡çš„è¯»è€…è‡³å°‘è¦æœ‰åŸºç¡€çš„C++çŸ¥è¯†ã€‚&lt;/p>
&lt;p>C++æ ‡å‡†åº“ä¸ºç£ç›˜æ–‡ä»¶æ“ä½œæä¾›äº†åŸºç¡€çš„æŽ¥å£ï¼Œå¦‚&lt;code>std::fstream&lt;/code>ï¼Œ&lt;code>std::ifstream&lt;/code>å’Œ&lt;code>std::ofstream&lt;/code>ã€‚æˆ‘ä»¬è¿˜æœ‰&lt;code>stringstream&lt;/code>ï¼Œå¯ä»¥åƒæµä¸€æ ·æ“ä½œå­—ç¬¦ä¸²ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>std&lt;span style="color:#f92672">::&lt;/span>ostringstream oss;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>oss &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#e6db74">&amp;#34;Hello, world!&lt;/span>&lt;span style="color:#ae81ff">\\&lt;/span>&lt;span style="color:#e6db74">n&amp;#34;&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>oss &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#ae81ff">123&lt;/span> &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">&amp;#39;\\&lt;/span>n&lt;span style="color:#960050;background-color:#1e0010">&amp;#39;&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>std&lt;span style="color:#f92672">::&lt;/span>string s &lt;span style="color:#f92672">=&lt;/span> oss.str();
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç›¸ä¼¼çš„ï¼Œæˆ‘ä»¬å¯ä»¥ä»Ž&lt;code>std::istringstream&lt;/code>ä¸­ä½¿ç”¨&lt;code>&amp;gt;&amp;gt;&lt;/code>æ“ä½œç¬¦è¯»å–æ•°æ®ã€‚&lt;/p>
&lt;p>Booståº“ä¸­çš„&lt;code>lexical_cast&lt;/code>æ­£æ˜¯ä½¿ç”¨äº†è¿™ç§æœºåˆ¶ï¼Œè®©ç”¨æˆ·å¯ä»¥ä½¿ç”¨ç»Ÿä¸€çš„æ–¹å¼å°†ä¸€ä¸ªå¯¹è±¡(object)è½¬æ¢ä¸ºå­—ç¬¦ä¸²è¡¨ç¤ºã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">using&lt;/span> boost&lt;span style="color:#f92672">::&lt;/span>lexical_cast;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">using&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>string;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">int&lt;/span> x &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">5&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>string s &lt;span style="color:#f92672">=&lt;/span> lexical_cast&lt;span style="color:#f92672">&amp;lt;&lt;/span>string&lt;span style="color:#f92672">&amp;gt;&lt;/span>(x);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>assert(s &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#e6db74">&amp;#34;5&amp;#34;&lt;/span>);
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æµç¼“å†²åŒºæœ‰ç€å¾ˆå¼ºçš„çµæ´»æ€§ï¼Œå¯ä»¥æ»¡è¶³ä¸åŒçš„â€œç¼“å†²å¹¶ä¼ è¾“å­—ç¬¦ï¼ˆä¸²ï¼‰â€éœ€æ±‚ï¼Œæ¯”å¦‚æ–‡ä»¶æ“ä½œã€å­—ç¬¦ä¸²æ“ä½œã€å‘½ä»¤è¡Œ(Console)æ“ä½œç­‰ã€‚æˆ‘ä»¬å¯ä»¥ä»Žç½‘ç»œã€é—ªå­˜(Flash memory)ç­‰ä¸åŒè®¾å¤‡ï¼Œä½¿ç”¨åŒæ ·çš„æŽ¥å£èŽ·å–æµå¼å­—ç¬¦ä¸²ã€‚â€œæµç¼“å†²åŒºâ€ä¸Žâ€œæµâ€æ˜¯æ­£äº¤çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥è‡ªç”±çš„äº¤æ¢ã€æ›´æ”¹(swap and change)æµæ‰€ä½¿ç”¨çš„ç¼“å†²åŒºï¼Œæˆ–è€…å°†å…¶é‡å®šå‘åˆ°å…¶å®ƒåœ°æ–¹ã€‚æˆ‘è®¤ä¸ºC++ä¸­çš„æµï¼Œæ­£æ˜¯â€œç­–ç•¥æ¨¡å¼â€(strategy design pattern)çš„ä¸€ä¸ªè‰¯å¥½èŒƒä¾‹ã€‚&lt;/p>
&lt;p>æ¯”å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥é‡å®šå‘æ ‡å‡†æ—¥å¿—æµ&lt;code>std::clog&lt;/code>åˆ°ä¸€ä¸ªå­—ç¬¦ä¸²æµï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;iostream&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;iomanip&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;string&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;sstream&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">int&lt;/span> &lt;span style="color:#a6e22e">main&lt;/span>()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> std&lt;span style="color:#f92672">::&lt;/span>ostringstream oss;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// Make clog use the buffer from oss
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>streambuf &lt;span style="color:#f92672">*&lt;/span>former_buff &lt;span style="color:#f92672">=&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> std&lt;span style="color:#f92672">::&lt;/span>clog.rdbuf(oss.rdbuf());
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> std&lt;span style="color:#f92672">::&lt;/span>clog &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#e6db74">&amp;#34;This will appear in oss!&amp;#34;&lt;/span> &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>flush;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> std&lt;span style="color:#f92672">::&lt;/span>cout &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> oss.str() &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">&amp;#39;\\&lt;/span>n&lt;span style="color:#960050;background-color:#1e0010">&amp;#39;&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// Give clog back its previous buffer
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>clog.rdbuf(former_buff);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¸è¿‡ï¼Œè‡ªå®šä¹‰ä¸€ä¸ªæµç¼“å†²åŒºå´æ˜¯æœ‰ä¸€ç‚¹trickyï¼Œæˆ–è€…è¯´æœ‰ä¸€ç‚¹å“äººï¼Œå°¤å…¶æ˜¯å½“ä½ ç¬¬ä¸€æ¬¡å°è¯•çš„æ—¶å€™ã€‚æ‰€ä»¥æœ¬æ–‡æ„åœ¨æä¾›ä¸€äº›æµç¼“å†²çš„å®žçŽ°èŒƒä¾‹ã€‚&lt;/p>
&lt;p>é¦–å…ˆæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹æµç¼“å†²åŒºçš„ä¸€äº›åŸºæœ¬æ¦‚å¿µã€‚æ‰€æœ‰çš„æµç¼“å†²åŒºç»§æ‰¿è‡ª&lt;code>std::streambuf&lt;/code>ï¼Œå¹¶ä¸”éœ€è¦è¦†ç›–ä¸€äº›è™šå‡½æ•°æ¥å®žçŽ°è‡ªå®šä¹‰åŠŸèƒ½ã€‚&lt;code>std::streambuf&lt;/code>æ˜¯â€œé¡ºåºè¯»å–è®¾å¤‡â€çš„ä¸€ä¸ªæŠ½è±¡ï¼Œå³æˆ‘ä»¬å¯ä»¥ä»Žä¸­é¡ºåºçš„è¯»å–å­—ç¬¦åºåˆ—ã€‚åœ¨ç‰¹å®šçš„åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥é‡å¡«(re-fill)ã€å†²æ´—(flush)ä»¥åŠæ¸…ç©º(empty)ä¸€ä¸ªç¼“å†²åŒºã€‚&lt;/p>
&lt;p>å½“æˆ‘ä»¬å‘ä¸€ä¸ª&lt;code>ostream&lt;/code>ä¸­æ’å…¥æ•°æ®æ—¶ï¼Œæ•°æ®å°†ä¼šè¢«å†™å…¥ç¼“å†²åŒºä¸­çš„ä¸€ä¸ªæ•°ç»„ã€‚å½“æ•°ç»„ä¸Šæº¢(overflow)æ—¶ï¼Œæ•°ç»„ä¸­çš„æ•°æ®å°†ä¼šè¢«å†²æ´—(flush)åˆ°ç›®æ ‡æŽ¥å—è€…ï¼Œä¹‹åŽè¿™ä¸ªæ•°ç»„çš„çŠ¶æ€å°†ä¼šé‡ç½®ï¼Œä»¥ä¾¿å­˜å‚¨åŽç»­çš„å­—ç¬¦ã€‚&lt;/p>
&lt;p>å½“æˆ‘ä»¬ä»Žä¸€ä¸ª&lt;code>istream&lt;/code>ä¸­èŽ·å–æ•°æ®æ—¶ï¼Œæ•°æ®ä»Žç¼“å†²åŒºçš„æ•°ç»„ä¸­è¯»å‡ºã€‚å½“æ•°ç»„ä¸‹æº¢æ—¶(underflow)ï¼Œæ²¡æœ‰æ•°æ®å¯è¯»ï¼Œæˆ‘ä»¬ä¼šä»Žæ•°æ®æºé‡æ–°æ‹‰å–ä¿¡æ¯æ¥å¡«å……ç¼“å†²åŒºï¼Œä¹‹åŽè¿™ä¸ªæ•°ç»„çš„çŠ¶æ€ä¹Ÿå°†è¢«é‡ç½®ã€‚&lt;/p>
&lt;p>æˆ‘ä»¬ä½¿ç”¨6ä¸ªæŒ‡é’ˆï¼Œæ¥ç»´æŠ¤ç¼“å†²åŒºçš„å†…éƒ¨çŠ¶æ€ã€‚è¾“å…¥å’Œè¾“å‡ºç¼“å†²å„ä½¿ç”¨3ä¸ªæŒ‡é’ˆã€‚&lt;/p>
&lt;h3 id="ç»´æŠ¤è¾“å‡ºç¼“å†²åŒºçš„çŠ¶æ€">ç»´æŠ¤è¾“å‡ºç¼“å†²åŒºçš„çŠ¶æ€ &lt;a href="#%e7%bb%b4%e6%8a%a4%e8%be%93%e5%87%ba%e7%bc%93%e5%86%b2%e5%8c%ba%e7%9a%84%e7%8a%b6%e6%80%81" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;ul>
&lt;li>
&lt;p>put base pointer &lt;br>
è¾“å‡ºåŸºæŒ‡é’ˆï¼Œç”¨æ¥æŒ‡å®šç¼“å†²åŒºå†…éƒ¨æ•°ç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´ ã€‚å¯ä»¥ä½¿ç”¨&lt;code>std::streambuf::pbase()&lt;/code>æ¥èŽ·å–&lt;/p>
&lt;/li>
&lt;li>
&lt;p>put pointer &lt;br>
è¾“å‡ºæŒ‡é’ˆï¼Œç”¨æ¥æŒ‡å‘å†…éƒ¨æ•°ç»„ä¸‹ä¸€ä¸ªå†™å…¥çš„åœ°å€ã€‚å¯ä»¥ä½¿ç”¨&lt;code>std::streambuf::pptr()&lt;/code>æ¥èŽ·å–&lt;/p>
&lt;/li>
&lt;li>
&lt;p>end put pointer &lt;br>
è¾“å‡ºå“¨å…µæŒ‡é’ˆï¼ŒæŒ‡å‘å†…éƒ¨æ•°ç»„æœ€åŽä¸€ä¸ªå†åŽé¢ä¸€ä¸ª(one-past-the-last-element)çš„åœ°å€ï¼ˆè¯‘æ³¨ï¼šç±»ä¼¼&lt;code>std::vector::end()&lt;/code>ï¼‰ã€‚å¯ä»¥ä½¿ç”¨&lt;code>std::streambuf:epptr()&lt;/code>æ¥èŽ·å–&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="http://i1.piimg.com/567571/630a89fe635e1635.png" alt="">&lt;/p>
&lt;p>ä¸€èˆ¬æ¥è¯´ï¼ŒåŸºæŒ‡é’ˆå’Œå“¨å…µæŒ‡é’ˆä¸ä¼šæ”¹å˜ï¼Œåœ¨ä½¿ç”¨æ—¶ï¼Œä»¥è¾“å‡ºæŒ‡é’ˆç»´æŠ¤å†…éƒ¨çŠ¶æ€ã€‚&lt;/p>
&lt;h3 id="ç»´æŠ¤è¾“å…¥ç¼“å†²åŒºçš„çŠ¶æ€">ç»´æŠ¤è¾“å…¥ç¼“å†²åŒºçš„çŠ¶æ€ &lt;a href="#%e7%bb%b4%e6%8a%a4%e8%be%93%e5%85%a5%e7%bc%93%e5%86%b2%e5%8c%ba%e7%9a%84%e7%8a%b6%e6%80%81" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;p>è¾“å…¥ç¼“å†²åŒºå’ŒçŠ¶æ€ç»´æŠ¤å’Œè¾“å‡ºç¼“å†²åŒºç±»ä¼¼ï¼Œæˆ‘ä»¬æœ‰ï¼š&lt;/p>
&lt;ul>
&lt;li>end back pointer &lt;br>
è¾“å…¥åŸºæŒ‡é’ˆï¼ŒæŒ‡å‘ç¼“å†²åŒºæ•°ç»„å†…çš„æœ€åŽä¸€ä¸ªå­—ç¬¦ã€‚å¯ä»¥ä½¿ç”¨&lt;code>std::streambuf::eback()&lt;/code>æ¥èŽ·å–&lt;/li>
&lt;li>get pointer &lt;br>
è¾“å…¥æŒ‡é’ˆï¼ŒæŒ‡å‘ç¼“å†²åŒºä¸‹ä¸€ä¸ªè¯»å–çš„å­—ç¬¦åœ°å€ã€‚å¯ä»¥ä½¿ç”¨&lt;code>std::streambuf::gptr()&lt;/code>æ¥èŽ·å–&lt;/li>
&lt;li>end get pointer &lt;br>
è¾“å…¥å“¨å…µæŒ‡é’ˆï¼Œæ‰¹å·å‘å†…éƒ¨æ•°ç»„æœ€åŽä¸€ä¸ªå†åŽé¢ä¸€ä¸ª(one-past-the-last-element)çš„åœ°å€ã€‚å¯ä»¥ä½¿ç”¨&lt;code>std::streambuf::egptr()&lt;/code>æ¥èŽ·å–&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://github.com/Wizmann/assets/raw/master/wizmann-pic/16-9-27/33500590.jpg" alt="">&lt;/p>
&lt;p>åŒæ ·ï¼ŒåŸºæŒ‡é’ˆå’Œå“¨å…µæŒ‡é’ˆåœ¨æµç¼“å†²åŒºçš„ç”Ÿå‘½å‘¨æœŸä¸­ä¹Ÿä¸ä¼šæ”¹å˜ã€‚&lt;/p>
&lt;p>ç”±äºŽè¾“å…¥ç¼“å†²åŒºè¦æ”¯æŒ&lt;code>putback()&lt;/code>æ“ä½œï¼Œå³å°†è¯»å‡ºçš„å­—ç¬¦é‡æ–°æ”¾å›žç¼“å†²åŒºï¼Œæ‰€ä»¥è¾“å…¥ç¼“å†²åŒºæ¯”è¾“å‡ºç¼“å†²åŒºæ›´å¤æ‚ä¸€ç‚¹ã€‚é€šå¸¸æ¥è¯´ï¼Œ&lt;code>putback()&lt;/code>æ“ä½œæ”¯æŒæ”¾å›žä¸€ä¸ªå­—ç¬¦å³å¯ã€‚&lt;/p>
&lt;p>ä¸€ä¸ª&lt;code>std::streambuf&lt;/code>å¯ä»¥åŒæ—¶æ”¯æŒè¾“å…¥è¾“å‡ºä¸¤ç§æ“ä½œï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸éœ€è¦æˆ‘åˆ†åˆ«å®žçŽ°&lt;code>std::istreambuf&lt;/code>å’Œ&lt;code>std::ostreambuf&lt;/code>ã€‚&lt;code>std::fstream&lt;/code>æ˜¯ä¸€ä¸ªè‰¯å¥½çš„ä¾‹å­ã€‚ä½†æ˜¯ï¼Œå®žçŽ°ä¸€ä¸ªå…¨åŠŸèƒ½çš„ç¼“å†²åŒºç›¸å¯¹æ›´å¤æ‚ä¸€äº›ï¼Œæ‰€ä»¥æˆ‘å°±ä¸è¶Ÿæµ‘æ°´å•¦~ ï¼šï¼‰&lt;/p>
&lt;p>åŒæ—¶ï¼Œæµç¼“å†²åŒºä¹Ÿå¯ä»¥æ”¯æŒå®½å­—ç¬¦(wide character)ã€‚&lt;code>std::streambuf&lt;/code>æ˜¯&lt;code>std::basic_streambuf&amp;lt;char&amp;gt;&lt;/code>çš„åˆ«åï¼Œå¦‚æžœä½ éœ€è¦å®½å­—ç¬¦æµç¼“å†²åŒºï¼Œå¯ä»¥ä½¿ç”¨&lt;code>std::basic_streambuf&amp;lt;wchar_t&amp;gt;&lt;/code>ã€‚&lt;/p>
&lt;h3 id="ä¾‹1æ–‡ä»¶ç¼“å†²åŒº--ä¸Žcä»£ç é›†æˆ">ä¾‹1ï¼šæ–‡ä»¶ç¼“å†²åŒº â€”â€” ä¸ŽCä»£ç é›†æˆ &lt;a href="#%e4%be%8b1%e6%96%87%e4%bb%b6%e7%bc%93%e5%86%b2%e5%8c%ba--%e4%b8%8ec%e4%bb%a3%e7%a0%81%e9%9b%86%e6%88%90" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;p>å‡è®¾æˆ‘ä»¬éœ€è¦è°ƒç”¨ä¸€ä¸ªåŽ†å²æ‚ ä¹…çš„åº“ï¼Œä¸€ä¸ªæ–‡ä»¶æ“ä½œå‡½æ•°ä¼šè¿”å›žç»™ä¸€ä¸ª&lt;code>FILE*&lt;/code>æŒ‡é’ˆï¼Œä½†æ˜¯æˆ‘ä»¬æƒ³ç”¨C++çš„æµæŽ¥å£æ¥è¯»å†™æ•°æ®ã€‚æˆ‘ä»¬å…ˆä»Žè¯»æ–‡ä»¶å¼€å§‹ï¼Œç”¨&lt;code>std::istream&lt;/code>åŒ…è£…&lt;code>FILE*&lt;/code>çš„è¯»æ“ä½œã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;streambuf&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;vector&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;cstdlib&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;cstdio&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">FILE_buffer&lt;/span> &lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#66d9ef">public&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>streambuf
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">public&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">explicit&lt;/span> FILE_buffer(FILE &lt;span style="color:#f92672">*&lt;/span>fptr, std&lt;span style="color:#f92672">::&lt;/span>size_t buff_sz &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">256&lt;/span>, std&lt;span style="color:#f92672">::&lt;/span>size_t put_back &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">8&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">private&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// overrides base class underflow()
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> int_type underflow();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// copy ctor and assignment not implemented;
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75715e">// copying not allowed
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> FILE_buffer(&lt;span style="color:#66d9ef">const&lt;/span> FILE_buffer &lt;span style="color:#f92672">&amp;amp;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> FILE_buffer &lt;span style="color:#f92672">&amp;amp;&lt;/span>&lt;span style="color:#66d9ef">operator&lt;/span>&lt;span style="color:#f92672">=&lt;/span> (&lt;span style="color:#66d9ef">const&lt;/span> FILE_buffer &lt;span style="color:#f92672">&amp;amp;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">private&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> FILE &lt;span style="color:#f92672">*&lt;/span>fptr_;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">const&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>size_t put_back_;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> std&lt;span style="color:#f92672">::&lt;/span>vector&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">char&lt;/span>&lt;span style="color:#f92672">&amp;gt;&lt;/span> buffer_;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>};
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç”±äºŽåŠŸèƒ½ç®€å•ï¼Œæˆ‘ä»¬åªéœ€è¦å®žçŽ°æž„é€ å‡½æ•°ä»¥åŠ&lt;code>underflow&lt;/code>æŽ¥å£å°±å¯ä»¥å®žçŽ°æˆ‘ä»¬çš„åŠŸèƒ½ã€‚&lt;/p>
&lt;p>æž„é€ å‡½æ•°æŒ‡å®šäº†è¯»å–æ–‡ä»¶çš„&lt;code>FILE*&lt;/code>æŒ‡é’ˆï¼Œä»¥åŠå†…éƒ¨ç¼“å†²æ•°ç»„çš„å¤§å°ã€‚æ•°ç»„å¤§å°ç”±ä¸¤ä¸ªå‚æ•°å†³å®šï¼š&lt;/p>
&lt;ul>
&lt;li>put-back area size&lt;/li>
&lt;li>buffer size&lt;/li>
&lt;/ul>
&lt;p>æˆ‘ä»¬ä½¿ç”¨&lt;code>std::vector&amp;lt;char&amp;gt;&lt;/code>åšä¸ºç¼“å†²åŒºåŸŸã€‚&lt;code>put_back_&lt;/code>å˜é‡ç”¨äºŽå­˜å‚¨&amp;quot;put-back&amp;quot;åŒºåŸŸçš„å¤§å°ã€‚&lt;/p>
&lt;p>ä»¥ä¸‹æ˜¯æž„é€ å‡½æ•°çš„å®žçŽ°ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">using&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>size_t;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>FILE_buffer&lt;span style="color:#f92672">::&lt;/span>FILE_buffer(FILE &lt;span style="color:#f92672">*&lt;/span>fptr, size_t buff_sz, size_t put_back) &lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> fptr_(fptr),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> put_back_(std&lt;span style="color:#f92672">::&lt;/span>max(put_back, size_t(&lt;span style="color:#ae81ff">1&lt;/span>))),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> buffer_(std&lt;span style="color:#f92672">::&lt;/span>max(buff_sz, put_back_) &lt;span style="color:#f92672">+&lt;/span> put_back_)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span>end &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#f92672">&amp;amp;&lt;/span>buffer_.front() &lt;span style="color:#f92672">+&lt;/span> buffer_.size();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> setg(end, end, end);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>åœ¨åˆå§‹åŒ–åˆ—è¡¨ä¸­ï¼Œæˆ‘ä»¬å°†ç¼“å†²åŒºçš„å¸¸é‡è¿›è¡Œèµ‹å€¼ã€‚ä¹‹åŽä½¿ç”¨&lt;code>std::streambuf::setg()&lt;/code>æ¥åˆå§‹åŒ–è¾“å‡ºç¼“å†²åŒºã€‚&lt;/p>
&lt;p>&lt;code>setg()&lt;/code>çš„ä¸‰ä¸ªå‚æ•°åˆ†åˆ«ä»£è¡¨&lt;code>eback()&lt;/code>ï¼Œ&lt;code>gptr()&lt;/code>ï¼Œ&lt;code>egptr()&lt;/code>ä¸‰ä¸ªå†…éƒ¨æŒ‡é’ˆçš„å€¼ã€‚ä¸€å¼€å§‹ï¼Œæˆ‘ä»¬å°†å®ƒä»¬éƒ½æŒ‡å‘åŒä¸€ä¸ªåœ°å€ã€‚è¡¨æ˜Žbufferæ˜¯ç©ºçš„ï¼Œåœ¨ä¸‹ä¸€æ¬¡è¯»å–æ—¶ï¼Œä¼šé‡æ–°å¡«å……ç¼“å†²åŒºã€‚&lt;/p>
&lt;p>&lt;code>underflow()&lt;/code>ä¼šè¿”å›žæ•°æ®æºä¸­å½“å‰çš„å­—ç¬¦ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œä¼šè¿”å›žbufferä¸­çš„ä¸‹ä¸€ä¸ªå¯ç”¨å­—ç¬¦ã€‚ç„¶åŽå½“bufferä¸ºç©ºæ—¶ï¼Œ&lt;code>underflow()&lt;/code>åº”è¯¥é‡æ–°å¡«å……ç¼“å†²åŒºæ•°ç»„ï¼Œåœ¨æœ¬ä¾‹ä¸­ï¼Œå³ä»Ž&lt;code>FILE*&lt;/code>ä¸­è¯»å–å­—ç¬¦ã€‚å½“ç¼“å†²åŒºé‡å¡«åŽï¼Œæˆ‘ä»¬éœ€è¦å†æ¬¡è°ƒç”¨&lt;code>setg()&lt;/code>æ›´æ–°æµç¼“å†²åŒºçš„çŠ¶æ€ã€‚&lt;/p>
&lt;p>å½“æ•°æ®æºä¸­çš„æ•°æ®è¯»å®Œ(depleted)åŽï¼Œ&lt;code>underflow()&lt;/code>ä¼šè¿”å›žä¸€ä¸ª&lt;code>traits_type::eof()&lt;/code>ã€‚è¿™é‡Œè¦æ³¨æ„ï¼Œ&lt;code>underflow()&lt;/code>çš„è¿”å›žå€¼æ˜¯&lt;code>int_type&lt;/code>ï¼Œè¿™ä¸ªå€¼è¶³å¤Ÿè£…ä¸‹&lt;code>eof()&lt;/code>ï¼ŒåŒæ—¶ä¹Ÿè¶³å¤Ÿè£…ä¸‹ä»»ä½•çš„å­—ç¬¦ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>std&lt;span style="color:#f92672">::&lt;/span>streambuf&lt;span style="color:#f92672">::&lt;/span>int_type FILE_buffer&lt;span style="color:#f92672">::&lt;/span>underflow()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (gptr() &lt;span style="color:#f92672">&amp;lt;&lt;/span> egptr()) &lt;span style="color:#75715e">// buffer not exhausted
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">return&lt;/span> traits_type&lt;span style="color:#f92672">::&lt;/span>to_int_type(&lt;span style="color:#f92672">*&lt;/span>gptr());
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span>base &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#f92672">&amp;amp;&lt;/span>buffer_.front();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span>start &lt;span style="color:#f92672">=&lt;/span> base;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (eback() &lt;span style="color:#f92672">==&lt;/span> base) &lt;span style="color:#75715e">// true when this isn&amp;#39;t the first fill
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// Make arrangements for putback characters
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>memmove(base, egptr() &lt;span style="color:#f92672">-&lt;/span> put_back_, put_back_);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> start &lt;span style="color:#f92672">+=&lt;/span> put_back_;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// start is now the start of the buffer, proper.
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75715e">// Read from fptr_ in to the provided buffer
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> size_t n &lt;span style="color:#f92672">=&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>fread(start, &lt;span style="color:#ae81ff">1&lt;/span>, buffer_.size() &lt;span style="color:#f92672">-&lt;/span> (start &lt;span style="color:#f92672">-&lt;/span> base), fptr_);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (n &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> traits_type&lt;span style="color:#f92672">::&lt;/span>eof();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// Set buffer pointers
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> setg(base, start, start &lt;span style="color:#f92672">+&lt;/span> n);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> traits_type&lt;span style="color:#f92672">::&lt;/span>to_int_type(&lt;span style="color:#f92672">*&lt;/span>gptr());
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å‡½æ•°çš„ç¬¬ä¸€è¡Œï¼Œé¦–å…ˆåˆ¤æ–­bufferæ˜¯å¦è€—å°½ã€‚å¦‚æžœå¦ï¼Œåˆ™è¿”å›žå½“å‰å­—ç¬¦ï¼Œå³&lt;code>*gptr()&lt;/code>ã€‚å¦‚æžœæ˜¯ï¼Œåˆ™è¿›è¡Œé‡å¡«(re-fill)æ“ä½œã€‚&lt;/p>
&lt;p>å›žæƒ³ä¸€ä¸‹æˆ‘ä»¬åœ¨æž„é€ å‡½æ•°ä¸­çš„å®žçŽ°ï¼Œä¸‰ä¸ªçŠ¶æ€æŒ‡é’ˆå…¨éƒ½æŒ‡å‘ç¼“å†²åŒºçš„æœ«å°¾ã€‚å¦‚æžœæˆ‘ä»¬è°ƒç”¨&lt;code>underflow()&lt;/code>æ—¶ï¼Œå‘çŽ°çŠ¶æ€æŒ‡é’ˆå¹¶éžå¦‚æ­¤ï¼Œåˆ™è¯´æ˜Žç¼“å†²åŒºå·²ç»è¢«å¡«å……äº†è‡³å°‘ä¸€æ¬¡ã€‚&lt;/p>
&lt;p>çŽ°åœ¨æˆ‘ä»¬è€ƒè™‘é‡å¡«æ“ä½œï¼Œæˆ‘ä»¬&lt;code>memmove&lt;/code>æœ€åŽ&lt;code>put_back_&lt;/code>ä¸ªå­—ç¬¦åˆ°bufferçš„æœ«å°¾ï¼Œç”¨åš&amp;quot;put-back area&amp;quot;ã€‚ï¼ˆæˆ‘ä»¬ä¸ç”¨&lt;code>memcopy&lt;/code>å› ä¸ºæˆ‘ä»¬çš„bufferæ¯”è¾ƒå°ï¼Œ`memmove()çš„æ•ˆçŽ‡ä¼šæ›´é«˜ä¸€äº›ï¼‰&lt;/p>
&lt;blockquote>
&lt;p>è¯‘æ³¨ï¼šå®žé™…ä¸Šï¼Œ&lt;code>memcopy&lt;/code>ä¸Ž&lt;code>memmove&lt;/code>å„æœ‰æ‰€é•¿ã€‚&lt;code>memcopy&lt;/code>ä¸éœ€è¦åˆ¤æ–­å†…å­˜overlapçš„æƒ…å†µï¼Œå³å¦‚æžœæºåŒºé—´ä¸Žç›®æ ‡åŒºé—´æœ‰é‡å ï¼Œé‚£ä¹ˆå¾—åˆ°çš„ç»“æžœä¼šæ˜¯é”™çš„ã€‚è€Œ&lt;code>memmove&lt;/code>ç”±äºŽæ˜¯ç§»åŠ¨è¯­ä¹‰ï¼Œæ‰€ä»¥åœ¨ç§»åŠ¨æ­¥é•¿è¾ƒå°æ—¶ï¼Œå¯ä»¥åªæ“ä½œcacheã€‚æ‰€ä»¥äºŒè€…å„æœ‰æ‰€é•¿ï¼Œè¦æ ¹æ®å…·ä½“æƒ…å†µåˆ¤æ–­ä¼˜åŠ£ã€‚Stackoverflowä¸Šæœ‰æ›´è¯¦ç»†çš„&lt;a href="http://stackoverflow.com/questions/28623895/why-is-memmove-faster-than-memcpy">è®¨è®º&lt;/a>&lt;/p>&lt;/blockquote>
&lt;p>æˆ‘ä»¬å¤„ç†å®Œ&amp;quot;put-back area&amp;quot;ä¹‹åŽï¼Œå°±å¯ä»¥ä½¿ç”¨&lt;code>fread()&lt;/code>å‡½æ•°æ¥é‡å¡«ç¼“å†²åŒºäº†ã€‚å¦‚æžœè¯»ä¸åˆ°æ•°æ®ï¼Œåˆ™æ„å‘³ç€æ–‡ä»¶å·²ç»è¯»åˆ°äº†ç»“å°¾ï¼ˆå½“ç„¶è¿™æ˜¯ä¸€ç§ç®€åŒ–æƒ…å†µï¼Œä½†åœ¨çŽ°å®žä¸­99.9%çš„è¯»å–å¤±è´¥éƒ½æ˜¯å› ä¸ºæ–‡ä»¶ç»“æŸï¼‰ã€‚&lt;/p>
&lt;p>åœ¨&lt;code>fread()&lt;/code>æˆåŠŸè¯»å–æ•°æ®ä¹‹åŽï¼Œæˆ‘ä»¬é€šçŸ¥streambufæ›´æ–°å†…éƒ¨çš„ä¸‰ä¸ªçŠ¶æ€æŒ‡é’ˆã€‚ä¹‹åŽè¿”å›žbufferå½“å‰çš„æŒ‡é’ˆã€‚&lt;/p>
&lt;p>è¿™å°±æ˜¯æˆ‘ä»¬çš„æµç¼“å†²åŒºçš„åŸºæœ¬å®žçŽ°ï¼Œå¸Œæœ›è¿™å¹¶ä¸æ˜¯å¤ªéš¾ã€‚å½“ç„¶æˆ‘ä»¬è¿˜å¯ä»¥æ·»åŠ æ›´å¤šçš„åŠŸèƒ½ã€‚ç‰¹åˆ«çš„æ˜¯æˆ‘ä»¬å¯ä»¥åœ¨ç¼“å†²åŒºé‡Œé¢è¿›è¡ŒæŸ¥æ‰¾ã€‚å¦‚æžœä½ æƒ³å®žçŽ°å®ƒçš„è¯ï¼Œå¯ä»¥è¯•è¯•é‡å†™&lt;code>std::streambuf::seekoff()&lt;/code>å’Œ&lt;code>std::streambuf::seekpos&lt;/code>è™šæˆå‘˜å‡½æ•°ã€‚&lt;/p>
&lt;p>æˆ‘ä»¬ä¹Ÿå¯ä»¥å®žçŽ°å†™ç¼“å†²åŒºã€‚ä¸è¿‡ï¼Œåœ¨ä½ ä»¬è¯»å®Œç¬¬ä¸‰ä¸ªä¾‹å­ä¹‹åŽï¼Œä½ ä»¬å°±å¯ä»¥è½»æ¾æ„‰å¿«çš„å®žçŽ°è‡ªå·±çš„ç‰ˆæœ¬äº†ï¼Œä¸éª—ä½ ã€‚&lt;/p>
&lt;h3 id="ä¾‹2è¯»å–å†…å­˜ä¸­çš„æ•°ç»„">ä¾‹2ï¼šè¯»å–å†…å­˜ä¸­çš„æ•°ç»„ &lt;a href="#%e4%be%8b2%e8%af%bb%e5%8f%96%e5%86%85%e5%ad%98%e4%b8%ad%e7%9a%84%e6%95%b0%e7%bb%84" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;p>æœ¬ä¾‹ä¸­ï¼Œæˆ‘ä»¬è¦ä½¿ç”¨&lt;code>std::istream&lt;/code>åŒ…è£…å†…å­˜ä¸­çš„ä¸€ä¸ªåªè¯»æ•°ç»„ï¼Œå¹¶ä¸”æ ¼å¼åŒ–çš„è¿›è¡Œè¯»å…¥ã€‚è¿™ä¸ªä¾‹å­å’Œä¸Šä¸€ä¸ªä¾‹å­æœ‰ä¸€ç‚¹ä¸åŒçš„æ˜¯ï¼Œæˆ‘ä»¬å¹¶ä¸éœ€è¦ä¸€ä¸ªçœŸæ­£çš„ç¼“å†²æ•°ç»„ï¼Œä»Žæºæ•°ç»„ä¸€æ¬¡æ€§è¯»å–å°±å¥½äº†ã€‚&lt;/p>
&lt;p>æƒ³è±¡ä¸­çš„å®žçŽ°æ˜¯è¿™ä¸ªæ ·å¼å„¿çš„ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">char_array_buffer&lt;/span> &lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#66d9ef">public&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>streambuf
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">public&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> char_array_buffer(&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span>begin, &lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span>end)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> setg(begin, begin, end);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> int_type &lt;span style="color:#a6e22e">underflow&lt;/span>()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> gptr() &lt;span style="color:#f92672">==&lt;/span> egptr() &lt;span style="color:#f92672">?&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> traits_type&lt;span style="color:#f92672">::&lt;/span>eof() &lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> traits_type&lt;span style="color:#f92672">::&lt;/span>to_int_type(&lt;span style="color:#f92672">*&lt;/span>gptr());
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>};
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä½†æ˜¯ï¼Œè¿™å¹¶æ²¡æœ‰ä»€ä¹ˆåµç”¨ã€‚å› ä¸º&lt;code>setg()&lt;/code>å‡½æ•°åªæŽ¥å—éžå¸¸é‡(non-const)æŒ‡é’ˆå‚æ•°ã€‚è¿™æ˜¾è€Œæ˜“è§ï¼Œå¦‚æžœä¸€ä¸ªç¼“å†²åŒºä¸å¯å†™ï¼Œæˆ‘ä»¬å°±ä¸èƒ½æä¾›&amp;quot;put-back&amp;quot;åŠŸèƒ½ã€‚æ‰€ä»¥æˆ‘ä»¬è¦åŠ¨ä¸€åŠ¨æ‰‹è„šï¼Œé‡æ–°å®žçŽ°ä¸€ä¸‹è¿™ä¸ªç±»ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;streambuf&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">char_array_buffer&lt;/span> &lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#66d9ef">public&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>streambuf
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">public&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> char_array_buffer(&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span>begin, &lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span>end);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">explicit&lt;/span> &lt;span style="color:#a6e22e">char_array_buffer&lt;/span>(&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span>str);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">private&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> int_type underflow();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> int_type &lt;span style="color:#a6e22e">uflow&lt;/span>();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> int_type &lt;span style="color:#a6e22e">pbackfail&lt;/span>(int_type ch);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> std&lt;span style="color:#f92672">::&lt;/span>streamsize showmanyc();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// copy ctor and assignment not implemented;
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75715e">// copying not allowed
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> char_array_buffer(&lt;span style="color:#66d9ef">const&lt;/span> char_array_buffer &lt;span style="color:#f92672">&amp;amp;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> char_array_buffer &lt;span style="color:#f92672">&amp;amp;&lt;/span>&lt;span style="color:#66d9ef">operator&lt;/span>&lt;span style="color:#f92672">=&lt;/span> (&lt;span style="color:#66d9ef">const&lt;/span> char_array_buffer &lt;span style="color:#f92672">&amp;amp;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">private&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span> &lt;span style="color:#66d9ef">const&lt;/span> begin_;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span> &lt;span style="color:#66d9ef">const&lt;/span> end_;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span> current_;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>};
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>åœ¨è¿™ä¸ªç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬é‡å†™äº†å‡ ä¸ªç§æœ‰å‡½æ•°ï¼Œè¿™äº›å‡½æ•°éƒ½æ˜¯ä»Ž&lt;code>std::streambuf&lt;/code>ç»§æ‰¿è€Œæ¥ã€‚&lt;/p>
&lt;p>ç¬¬ä¸€ä¸ªæž„é€ å‡½æ•°éœ€è¦ç”¨æˆ·æŒ‡å®šèµ·æ­¢æŒ‡é’ˆï¼Œè€Œç¬¬äºŒä¸ªæž„é€ å‡½æ•°åªéœ€è¦æŒ‡å®šèµ·å§‹æŒ‡é’ˆï¼Œä¹‹åŽæˆ‘ä»¬ä¼šè°ƒç”¨&lt;code>std::strlen()&lt;/code>æ¥åˆ¤æ–­å­—ç¬¦ä¸²çš„å¤§å°ã€‚&lt;/p>
&lt;p>æˆ‘ä»¬ä½¿ç”¨&lt;code>uflow()&lt;/code>, &lt;code>pbackfail()&lt;/code>å’Œ&lt;code>showmanyc()&lt;/code>æ¥ç»´æŠ¤ç¼“å†²åŒºå†…éƒ¨çš„çŠ¶æ€ï¼Œè€Œä¸æ˜¯è°ƒç”¨&lt;code>setg()&lt;/code>ï¼Œå› ä¸ºbufferå¹¶ä¸å¯å†™ã€‚&lt;/p>
&lt;p>åœ¨è¿™ä¸ªç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬è¦æ‰‹åŠ¨ç»´æŠ¤&lt;code>eback&lt;/code>, &lt;code>gptr&lt;/code>, &lt;code>egptr&lt;/code>ä¸‰ä¸ªæŒ‡é’ˆã€‚åœ¨æž„é€ å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬å°†å¯¹å…¶è¿›è¡Œèµ‹å€¼ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;#34;char_array_buffer.hpp&amp;#34;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;functional&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;cassert&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;cstring&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>char_array_buffer&lt;span style="color:#f92672">::&lt;/span>char_array_buffer(&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span>begin, &lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span>end) &lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> begin_(begin),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> end_(end),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> current_(begin_)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> assert(std&lt;span style="color:#f92672">::&lt;/span>less_equal&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&amp;gt;&lt;/span>()(begin_, end_));
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>char_array_buffer&lt;span style="color:#f92672">::&lt;/span>char_array_buffer(&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span>str) &lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> begin_(str),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> end_(begin_ &lt;span style="color:#f92672">+&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>strlen(str)),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> current_(begin_)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¹‹å‰æˆ‘ä»¬ä½¿ç”¨&lt;code>underflow()&lt;/code>æ¥èŽ·å–å½“å‰å­—ç¬¦ï¼Œä½†è¿™æ¬¡æˆ‘ä»¬éœ€è¦ä½¿ç”¨&lt;code>uflow()&lt;/code>ã€‚å› ä¸º&lt;code>uflow()&lt;/code>éœ€è¦åŒæ—¶æ‰§è¡Œä¸¤æ­¥æ“ä½œï¼Œä¸€æ˜¯èŽ·å–å½“å‰å­—ç¬¦ï¼ŒäºŒæ˜¯è®©&lt;code>gptr()&lt;/code>å‰è¿›ä¸€æ­¥ã€‚ä½†æ˜¯åˆå› ä¸ºç¼“å†²åŒºç”±æˆ‘ä»¬æ‰‹åŠ¨ç®¡ç†ï¼Œ&lt;code>std::streambuf&lt;/code>å¹¶ä¸èƒ½æ­£ç¡®çš„æ‰§è¡Œç®¡ç†æ“ä½œã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦é‡å†™&lt;code>uflow()&lt;/code>è€Œä¸æ˜¯&lt;code>underflow()&lt;/code>ã€‚&lt;/p>
&lt;pre tabindex="0">&lt;code>char_array_buffer::int_type char_array_buffer::uflow()
{
if (current_ == end_)
return traits_type::eof();
return traits_type::to_int_type(*current_++);
}
&lt;/code>&lt;/pre>&lt;p>ä¸‹ä¸€æ­¥æˆ‘ä»¬è¿˜è¦å®žçŽ°&lt;code>pbackfail()&lt;/code>ã€‚å½“æˆ‘ä»¬è°ƒç”¨&lt;code>std::istream::unget()&lt;/code>æˆ–&lt;code>std::istream::putback(ch)&lt;/code>æ—¶ï¼Œæˆ‘ä»¬ä¼šæŠŠå·²ç»è¯»å‡ºçš„æ•°æ®å†™å›žæ•°ç»„ä¸­ã€‚ä½†æ˜¯ç”±äºŽæ•°ç»„æ˜¯åªè¯»çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬åªèƒ½æ¨¡æ‹Ÿè¿™ç§æ“ä½œã€‚&lt;/p>
&lt;p>åœ¨é»˜è®¤çš„å®žçŽ°ä¸­&lt;code>pbackfail()&lt;/code>åªä¼šè¿”å›ž&lt;code>traits_type::eof()&lt;/code>ï¼Œè€Œåœ¨æˆ‘ä»¬çš„ç‰ˆæœ¬ä¸­ï¼Œå¦‚æžœå†™å›žæˆåŠŸï¼Œå°†ä¼šè¿”å›žå†™å›žçš„å­—ç¬¦ï¼Œä¸æˆåŠŸè¿”å›žeofã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>char_array_buffer&lt;span style="color:#f92672">::&lt;/span>int_type char_array_buffer&lt;span style="color:#f92672">::&lt;/span>pbackfail(int_type ch)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (current_ &lt;span style="color:#f92672">==&lt;/span> begin_ &lt;span style="color:#f92672">||&lt;/span> (ch &lt;span style="color:#f92672">!=&lt;/span> traits_type&lt;span style="color:#f92672">::&lt;/span>eof() &lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span> ch &lt;span style="color:#f92672">!=&lt;/span> current_[&lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>]))
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> traits_type&lt;span style="color:#f92672">::&lt;/span>eof();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> traits_type&lt;span style="color:#f92672">::&lt;/span>to_int_type(&lt;span style="color:#f92672">*--&lt;/span>current_);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>åœ¨&lt;code>FILE_buffer&lt;/code>ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥è€ƒè™‘é‡å†™&lt;code>pbackfail()&lt;/code>ï¼Œæ¥æä¾›åå‘æŸ¥æ‰¾ä»¥åŠï¼ˆç”¨å‰é¢çš„æ•°æ®ï¼‰é‡å¡«bufferçš„åŠŸèƒ½ã€‚&lt;/p>
&lt;p>æœ€åŽä¸€ä¸ªé‡å†™çš„å‡½æ•°æ˜¯&lt;code>showmanyc()&lt;/code>ï¼Œè¿™ä¸ªå‡½æ•°è¢«&lt;code>std::streambuf::in_avail()&lt;/code>è°ƒç”¨ï¼Œä»¥åˆ¤æ–­å½“å‰æœ‰å¤šå°‘ä¸ªå­—ç¬¦å¯ä»¥è¿”å›žã€‚ç”±äºŽæˆ‘ä»¬æŽ¥ç®¡äº†çŠ¶æ€æŒ‡é’ˆï¼Œæ‰€ä»¥è¿™ä¸ªå‡½æ•°ä¹Ÿè¦æˆ‘ä»¬è‡ªå·±æ¥å®žçŽ°å•Šã€‚ï¼ˆè¯‘è€…ï¼šä¸ºä»€ä¹ˆè¦ç»™è‡ªå·±æ‰¾éº»çƒ¦ã€‚ã€‚ã€‚ï¼‰&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>std&lt;span style="color:#f92672">::&lt;/span>streamsize char_array_buffer&lt;span style="color:#f92672">::&lt;/span>showmanyc()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> assert(std&lt;span style="color:#f92672">::&lt;/span>less_equal&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&amp;gt;&lt;/span>()(current_, end_));
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> end_ &lt;span style="color:#f92672">-&lt;/span> current_;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç”±æ­¤å¯è§ï¼Œæœ¬ä¾‹ä¸­çš„bufferæ¯”å‰é¢çš„è¦å¤æ‚ä¸€ç‚¹ç‚¹ã€‚è¿™æ˜¯å› ä¸ºæˆ‘ä»¬æŽ¥ç®¡äº†çŠ¶æ€ç»´æŠ¤çš„å·¥ä½œã€‚è¿™ä½¿å¾—æˆ‘ä»¬æ›´å¥½çš„ç†è§£äº†&lt;code>std::streambuf&lt;/code>å†…éƒ¨æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚&lt;/p>
&lt;h3 id="ä¾‹3å¥é¦–å˜å¤§å†™çš„ç¼“å†²åŒº">ä¾‹3ï¼šå¥é¦–å˜å¤§å†™çš„ç¼“å†²åŒº &lt;a href="#%e4%be%8b3%e5%8f%a5%e9%a6%96%e5%8f%98%e5%a4%a7%e5%86%99%e7%9a%84%e7%bc%93%e5%86%b2%e5%8c%ba" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;p>æœ¬ä¾‹ä¸­æˆ‘ä»¬å°†è¦å®žçŽ°ä¸€ä¸ªå°†å¥é¦–å­—ç¬¦å˜å¤§å†™çš„bufferã€‚å½“ç„¶æˆ‘ä»¬åªè€ƒè™‘æœ€åŸºæœ¬çš„æƒ…å†µï¼Œç§»æ¤åˆ°ä¸åŒçš„åŒºåŸŸå’Œè¯­è¨€ï¼Œå…¶å®žæ˜¯å¾ˆçç¢Žçš„äº‹æƒ…ã€‚ï¼ˆè¯‘è€…ï¼šæ–‡å­—ç¼–ç å‘çš„äº²å¦ˆéƒ½ä¸è®¤äº†ï¼‰&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;streambuf&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;iosfwd&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;cstdlib&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;vector&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">caps_buffer&lt;/span> &lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#66d9ef">public&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>streambuf
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">public&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">explicit&lt;/span> caps_buffer(std&lt;span style="color:#f92672">::&lt;/span>ostream &lt;span style="color:#f92672">&amp;amp;&lt;/span>sink, std&lt;span style="color:#f92672">::&lt;/span>size_t buff_sz &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">256&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">protected&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">bool&lt;/span> do_caps_and_flush();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">private&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> int_type overflow(int_type ch);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">int&lt;/span> &lt;span style="color:#a6e22e">sync&lt;/span>();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// copy ctor and assignment not implemented;
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75715e">// copying not allowed
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> caps_buffer(&lt;span style="color:#66d9ef">const&lt;/span> caps_buffer &lt;span style="color:#f92672">&amp;amp;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> caps_buffer &lt;span style="color:#f92672">&amp;amp;&lt;/span>&lt;span style="color:#66d9ef">operator&lt;/span>&lt;span style="color:#f92672">=&lt;/span> (&lt;span style="color:#66d9ef">const&lt;/span> caps_buffer &lt;span style="color:#f92672">&amp;amp;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">private&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">bool&lt;/span> cap_next_;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> std&lt;span style="color:#f92672">::&lt;/span>ostream &lt;span style="color:#f92672">&amp;amp;&lt;/span>sink_;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> std&lt;span style="color:#f92672">::&lt;/span>vector&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">char&lt;/span>&lt;span style="color:#f92672">&amp;gt;&lt;/span> buffer_;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>};
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™é‡Œæˆ‘ä»¬éœ€è¦é‡å†™&lt;code>overflow()&lt;/code>å’Œ&lt;code>sync()&lt;/code>å‡½æ•°ã€‚&lt;code>overflow()&lt;/code>åœ¨è¾“å…¥ç¼“å†²åŒºæ»¡çš„æ—¶å€™è¢«è°ƒç”¨ï¼Œå¹¶ä¸”åœ¨æˆåŠŸæ—¶è¿”å›žä»»æ„éžeofçš„å€¼ã€‚&lt;/p>
&lt;p>&lt;code>sync()&lt;/code>çš„ä½œç”¨æ˜¯æŠŠå½“å‰çš„bufferå†™å…¥ç›®æ ‡ï¼Œå³ä½¿å½“å‰bufferå¹¶æœªå¡«æ»¡ã€‚&lt;code>std::flush()&lt;/code>ä¼šè°ƒç”¨&lt;code>sync()&lt;/code>å‡½æ•°ï¼Œå½“å¤±è´¥æ—¶è¿”å›ž-1ã€‚&lt;/p>
&lt;p>æˆ‘ä»¬ç¼–å†™ä¸€ä¸ªè¾…åŠ©å‡½æ•°&lt;code>do_caps_and_flush()&lt;/code>ï¼Œç”¨æ¥å°†å°å†™å˜å¤§å†™ï¼Œå¹¶å†™å…¥&lt;code>sink_&lt;/code>è¾“å‡ºæµã€‚æˆ‘ä»¬å†å£°æ˜Žä¸€ä¸ªå“¨å…µå˜é‡&lt;code>cap_next_&lt;/code>æ¥æ ‡è¯†ä¸‹ä¸€ä¸ªå­—ç¬¦æ˜¯å¦éœ€è¦å°å†™å˜å¤§å†™ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;#34;caps_buffer.hpp&amp;#34;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;cctype&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;ostream&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;functional&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;cassert&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>caps_buffer&lt;span style="color:#f92672">::&lt;/span>caps_buffer(std&lt;span style="color:#f92672">::&lt;/span>ostream &lt;span style="color:#f92672">&amp;amp;&lt;/span>sink, std&lt;span style="color:#f92672">::&lt;/span>size_t buff_sz) &lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> cap_next_(true),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> sink_(sink),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> buffer_(buff_sz &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> sink_.clear();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span>base &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#f92672">&amp;amp;&lt;/span>buffer_.front();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> setp(base, base &lt;span style="color:#f92672">+&lt;/span> buffer_.size() &lt;span style="color:#f92672">-&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>); &lt;span style="color:#75715e">// -1 to make overflow() easier
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>buffer_&lt;/code>çš„æœ€å°å¯èƒ½å¤§å°æ˜¯1ï¼ŒåŒæ—¶æˆ‘ä»¬ä¹Ÿåªéœ€è¦ç»´æŠ¤ä¸¤ä¸ªæŒ‡é’ˆï¼Œå› ä¸ºè¿™é‡Œä¸éœ€è¦åƒè¾“å…¥ç¼“å†²åŒºä¸€æ ·çš„ç»´æŠ¤&amp;quot;put-back area&amp;quot;ã€‚&lt;/p>
&lt;p>æˆ‘ä»¬æŠŠ&lt;code>buffer_&lt;/code>çš„å¤§å°è®¾æˆ&lt;code>buff_sz + 1&lt;/code>ï¼Œè¿™æ ·æ˜¯ä¸ºäº†&lt;code>overflow()&lt;/code>è¢«è°ƒç”¨æ—¶ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªé¢å¤–çš„ç©ºé—´å­˜å‚¨å½“å‰çš„å­—ç¬¦ã€‚æœ€åŽå°†ç¼“å†²åŒºæ•°ç»„å’Œæœ€åŽä¸€ä¸ªå­—ç¬¦ä¸€èµ·åˆ·æ–°åˆ°&lt;code>ostream&lt;/code>ä¸­ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>caps_buffer&lt;span style="color:#f92672">::&lt;/span>int_type caps_buffer&lt;span style="color:#f92672">::&lt;/span>overflow(int_type ch)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (sink_ &lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span> ch &lt;span style="color:#f92672">!=&lt;/span> traits_type&lt;span style="color:#f92672">::&lt;/span>eof())
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> assert(std&lt;span style="color:#f92672">::&lt;/span>less_equal&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&amp;gt;&lt;/span>()(pptr(), epptr()));
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">*&lt;/span>pptr() &lt;span style="color:#f92672">=&lt;/span> ch;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> pbump(&lt;span style="color:#ae81ff">1&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (do_caps_and_flush())
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> ch;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> traits_type&lt;span style="color:#f92672">::&lt;/span>eof();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç¬¬ä¸€æ­¥æ˜¯æŠŠchå†™å…¥&lt;code>buffer_&lt;/code>ï¼Œå¹¶ä¸”ä½¿ç”¨&lt;code>pbump(1)&lt;/code>å°†&lt;code>pptr()&lt;/code>å‘å‰ç§»ä¸€ä½ã€‚ä¹‹åŽè°ƒç”¨&lt;code>do_caps_and_flush()&lt;/code>åšä¸€äº›è„æ´»ï¼Œä¹‹åŽè¿”å›žä¸€ä¸ªå­—ç¬¦å£°æ˜Žè°ƒç”¨æˆåŠŸã€‚&lt;/p>
&lt;p>&lt;code>sync()&lt;/code>çš„å®žçŽ°ä¹Ÿéžå¸¸ç®€å•:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">int&lt;/span> caps_buffer&lt;span style="color:#f92672">::&lt;/span>sync()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#a6e22e">do_caps_and_flush&lt;/span>() &lt;span style="color:#f92672">?&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span> &lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æˆ‘ä»¬å†çœ‹ä¸€çœ‹&lt;code>do_caps_and_flush()&lt;/code>å‡½æ•°&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">bool&lt;/span> caps_buffer&lt;span style="color:#f92672">::&lt;/span>do_caps_and_flush()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">for&lt;/span> (&lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span>p &lt;span style="color:#f92672">=&lt;/span> pbase(), &lt;span style="color:#f92672">*&lt;/span>e &lt;span style="color:#f92672">=&lt;/span> pptr(); p &lt;span style="color:#f92672">!=&lt;/span> e; &lt;span style="color:#f92672">++&lt;/span>p)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (&lt;span style="color:#f92672">*&lt;/span>p &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#e6db74">&amp;#39;.&amp;#39;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> cap_next_ &lt;span style="color:#f92672">=&lt;/span> true;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">else&lt;/span> &lt;span style="color:#a6e22e">if&lt;/span> (std&lt;span style="color:#f92672">::&lt;/span>isalpha(&lt;span style="color:#f92672">*&lt;/span>p))
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (cap_next_)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">*&lt;/span>p &lt;span style="color:#f92672">=&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>toupper(&lt;span style="color:#f92672">*&lt;/span>p);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> cap_next_ &lt;span style="color:#f92672">=&lt;/span> false;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> std&lt;span style="color:#f92672">::&lt;/span>ptrdiff_t n &lt;span style="color:#f92672">=&lt;/span> pptr() &lt;span style="color:#f92672">-&lt;/span> pbase();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> pbump(&lt;span style="color:#f92672">-&lt;/span>n);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> sink_.write(pbase(), n);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯¹äºŽæœ¬ä¾‹æ¥è¯´ï¼Œå†…éƒ¨çš„ç¼“å†²åŒºå¹¶éžå¿…è¦ï¼Œæˆ‘ä»¬å¯ä»¥ä¸€ä¸ªå­—ç¬¦ä¸€ä¸ªå­—ç¬¦æŠŠæ•°æ®å‘åˆ°&lt;code>sink&lt;/code>ä¸­ã€‚ä½†æ˜¯æˆ‘çš„è§‚ç‚¹æ˜¯ä¸€ä¸ªå†…éƒ¨bufferä»æœ‰å…¶ç”¨å¤„ã€‚&lt;/p>
&lt;h3 id="ä»‹ç»-boost-iostreams-åº“">ä»‹ç» Boost IOStreams åº“ &lt;a href="#%e4%bb%8b%e7%bb%8d-boost-iostreams-%e5%ba%93" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;p>å¦‚æžœä½ æ˜¯æµç¼“å†²åŒºçš„æ–°æ‰‹ï¼Œå¸Œæœ›ä½ å·²ç»å¯¹å®ƒæœ‰ä¸€ç‚¹ç‚¹äº†è§£äº†ã€‚æœ¬æ–‡ä¸­çš„ä¾‹å­éƒ½éžå¸¸åŸºç¡€ï¼Œä½†æ˜¯ä½ å¯ä»¥ç”¨å®ƒä»¬åšæ›´å¤šæœ‰æ„æ€çš„äº‹æƒ…ã€‚ä½†æ˜¯å½“æˆ‘å®žçŽ°æ›´å¤æ‚çš„æµç¼“å†²åŒºæ—¶ï¼Œé—®é¢˜çš„å¤æ‚åº¦å´ä¸Šå‡çš„å¾ˆå¿«ã€‚è¿™æ—¶æˆ‘å‘çŽ°äº†&lt;code>Boost IOStreams&lt;/code>åº“ï¼Œå®ƒä¸ºæ›´å¤æ‚çš„ç¼“å†²åŒºå’Œæµæä¾›äº†å¿…è¦çš„æ¡†æž¶æ”¯æŒã€‚&lt;/p>
&lt;p>å®ƒå…è®¸ä½ è§£è€¦æ•°æ®æºï¼Œæ•°æ®è¾“å‡ºï¼Œè¿‡æ»¤å™¨ä»¥åŠå…¶å®ƒä¸€äº›æ¦‚å¿µã€‚åœ¨æˆ‘ä»¬çš„æœ€åŽä¸€ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ç¡¬ç¼–ç æ•°æ®è¾“å‡ºåˆ°&lt;code>std::ostream&lt;/code>ä¸­ã€‚å¦‚æžœæˆ‘ä»¬è¦è¾“å‡ºåˆ°ä¸€ä¸ªæ²¡æœ‰æµæŽ¥å£çš„ç±»å‘¢ï¼Ÿ&lt;code>Boost IOStreams&lt;/code>åº“æä¾›äº†æ›´å¤šçš„çµæ´»æ€§ï¼Œå°†ä¸€å¨ç´§è€¦åˆçš„ä»£ç åˆ†è§£æˆç‹¬ç«‹çš„æŠ½è±¡æ¦‚å¿µã€‚&lt;/p>
&lt;h3 id="æ‰©å±•é˜…è¯»">æ‰©å±•é˜…è¯» &lt;a href="#%e6%89%a9%e5%b1%95%e9%98%85%e8%af%bb" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;ul>
&lt;li>The C++ Standard Library by Nicolai M. Josuttis&lt;/li>
&lt;li>The C++ Standard, BS ISO/IEC 14882:2003 (Second Edition)&lt;/li>
&lt;li>&lt;a href="http://www.dinkumware.com/manuals/">Dinkum Compleat Reference online&lt;/a>&lt;/li>
&lt;/ul></description></item></channel></rss>