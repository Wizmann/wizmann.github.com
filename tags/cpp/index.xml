<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Cpp on Maerlyn's Rainbow</title><link>https://wizmann.top/tags/cpp/</link><description>Recent content in Cpp on Maerlyn's Rainbow</description><generator>Hugo -- gohugo.io</generator><language>zh-CN</language><lastBuildDate>Tue, 21 Jan 2025 00:00:00 +0000</lastBuildDate><atom:link href="https://wizmann.top/tags/cpp/index.xml" rel="self" type="application/rss+xml"/><item><title>åŠ¨æ‰‹å®žçŽ°æ™ºèƒ½æŒ‡é’ˆ ï¼ˆä¸Šç¯‡ï¼‰ - C++ for the Antiquatedï¼ˆä¹‹å››ï¼‰</title><link>https://wizmann.top/posts/std-smart-ptrs-cpp-for-the-antiquated-4/</link><pubDate>Tue, 21 Jan 2025 00:00:00 +0000</pubDate><guid>https://wizmann.top/posts/std-smart-ptrs-cpp-for-the-antiquated-4/</guid><description>&lt;p>æ™ºèƒ½æŒ‡é’ˆï¼ˆå¦‚ &lt;code>std::shared_ptr&lt;/code> å’Œ &lt;code>std::weak_ptr&lt;/code>ï¼‰å·²ç»æˆä¸ºçŽ°ä»£ C++ ç¼–ç¨‹çš„é‡è¦å·¥å…·ï¼Œå°½ç®¡å®ƒä»¬å¹¶ä¸ç®—æ˜¯â€œæ–°å…´â€çš„ç‰¹æ€§ã€‚åœ¨ C++11 æ ‡å‡†ä¹‹å‰ï¼ŒBoost åº“å°±å·²ç»å¼•å…¥äº†æ™ºèƒ½æŒ‡é’ˆçš„å®žçŽ°ï¼Œç‰¹åˆ«æ˜¯ &lt;code>boost::shared_ptr&lt;/code> å’Œ &lt;code>boost::weak_ptr&lt;/code>ï¼Œå®ƒä»¬ä¸º C++11 çš„æ™ºèƒ½æŒ‡é’ˆç‰¹æ€§å¥ å®šäº†åŸºç¡€ã€‚å› æ­¤ï¼Œå¯ä»¥è¯´æ™ºèƒ½æŒ‡é’ˆåœ¨ C++ ä¸­çš„å‘å±•åŽ†ç¨‹å·²ç»æœ‰å¾ˆé•¿æ—¶é—´ï¼Œè€Œå®ƒä»¬çš„å¼•å…¥æžå¤§åœ°ç®€åŒ–äº†å†…å­˜ç®¡ç†å’Œé¿å…äº†å¸¸è§çš„å†…å­˜æ³„æ¼å’Œæ‚¬æŒ‚æŒ‡é’ˆé—®é¢˜ã€‚&lt;/p>
&lt;p>æœ¬æ–‡å°†å›´ç»•ä»¥ä¸‹ä¸»é¢˜å±•å¼€è®¨è®ºï¼š&lt;/p>
&lt;ul>
&lt;li>C++ æ™ºèƒ½æŒ‡é’ˆçš„å®žçŽ°åŽŸç†&lt;/li>
&lt;li>éžä¾µå…¥å¼æ™ºèƒ½æŒ‡é’ˆä¸Žä¾µå…¥å¼æ™ºèƒ½æŒ‡é’ˆçš„åŒºåˆ«&lt;/li>
&lt;li>åˆ©ç”¨ &lt;code>atomic&lt;/code> é¿å…å¤šçº¿ç¨‹ç«žæ€æ¡ä»¶&lt;/li>
&lt;li>å¦‚ä½•å®žçŽ°ä¾µå…¥å¼ç‰ˆæœ¬çš„ &lt;code>shared_ptr&lt;/code> å’Œ &lt;code>weak_ptr&lt;/code>&lt;/li>
&lt;li>é‡‡ç”¨ &lt;code>concept&lt;/code> çº¦æŸæ¨¡æ¿ç±»åž‹&lt;/li>
&lt;li>æŽ¢è®¨å®Œç¾Žè½¬å‘ï¼ˆ&lt;code>std::forward&amp;lt;T&amp;gt;&lt;/code>ï¼‰åœ¨æ™ºèƒ½æŒ‡é’ˆä¸­çš„åº”ç”¨&lt;/li>
&lt;/ul>
&lt;h2 id="c-ä¸­çš„æ™ºèƒ½æŒ‡é’ˆ">C++ ä¸­çš„æ™ºèƒ½æŒ‡é’ˆ &lt;a href="#c-%e4%b8%ad%e7%9a%84%e6%99%ba%e8%83%bd%e6%8c%87%e9%92%88" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;h3 id="stdshared_ptrçš„å®žçŽ°">&lt;code>std::shared_ptr&lt;/code>çš„å®žçŽ° &lt;a href="#stdshared_ptr%e7%9a%84%e5%ae%9e%e7%8e%b0" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;p>&lt;code>std::shared_ptr&lt;/code> æ˜¯ä¸€ç§æ™ºèƒ½æŒ‡é’ˆï¼Œèƒ½å¤Ÿè‡ªåŠ¨ç®¡ç†å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸã€‚å®ƒé€šè¿‡å¼•ç”¨è®¡æ•°çš„æ–¹å¼æ¥è·Ÿè¸ªæœ‰å¤šå°‘ä¸ª &lt;code>shared_ptr&lt;/code> å®žä¾‹æŒ‡å‘åŒä¸€ä¸ªå¯¹è±¡ï¼Œç¡®ä¿å½“æœ€åŽä¸€ä¸ª &lt;code>shared_ptr&lt;/code> è¢«é”€æ¯æ—¶ï¼Œå¯¹è±¡çš„å†…å­˜èƒ½å¤Ÿè‡ªåŠ¨é‡Šæ”¾ã€‚&lt;/p>
&lt;h4 id="å¼•ç”¨è®¡æ•°ä¸ŽåŽŸå­æ“ä½œ">å¼•ç”¨è®¡æ•°ä¸ŽåŽŸå­æ“ä½œ &lt;a href="#%e5%bc%95%e7%94%a8%e8%ae%a1%e6%95%b0%e4%b8%8e%e5%8e%9f%e5%ad%90%e6%93%8d%e4%bd%9c" class="anchor">ðŸ”—&lt;/a>&lt;/h4>&lt;p>&lt;code>std::shared_ptr&lt;/code> çš„æ ¸å¿ƒæœºåˆ¶æ˜¯å¼•ç”¨è®¡æ•°ã€‚æ¯ä¸ª &lt;code>shared_ptr&lt;/code> ä¼šç»´æŠ¤ä¸€ä¸ªå¼•ç”¨è®¡æ•°ã€‚å½“å¤šä¸ª &lt;code>shared_ptr&lt;/code> æŒ‡å‘åŒä¸€ä¸ªå¯¹è±¡æ—¶ï¼Œè®¡æ•°å™¨ä¼šå¢žåŠ ï¼›å½“ä¸€ä¸ª &lt;code>shared_ptr&lt;/code> è¢«é”€æ¯æ—¶ï¼Œè®¡æ•°å™¨ä¼šå‡å°‘ã€‚å¦‚æžœè®¡æ•°å™¨å½’é›¶ï¼Œè¡¨æ˜Žæ²¡æœ‰ä»»ä½• &lt;code>shared_ptr&lt;/code> å†æŒ‡å‘è¯¥å¯¹è±¡ï¼Œè¿™æ—¶å¯¹è±¡ä¼šè¢«åˆ é™¤ã€‚&lt;/p>
&lt;p>å¼•ç”¨è®¡æ•°é€šå¸¸ç”±ä¸€ä¸ªæŽ§åˆ¶å—ï¼ˆcontrol blockï¼‰ç®¡ç†ã€‚æŽ§åˆ¶å—ä¸ä»…ä¿å­˜å¼•ç”¨è®¡æ•°ï¼Œè¿˜ä¼šä¿å­˜å¯¹è±¡æœ¬èº«ä»¥åŠä¸Žå¯¹è±¡ç”Ÿå‘½å‘¨æœŸç›¸å…³çš„å…¶ä»–ä¿¡æ¯ã€‚&lt;code>std::shared_ptr&lt;/code> çš„å®žçŽ°ä¸€èˆ¬ä½¿ç”¨â€œéžä¾µå…¥å¼å¼•ç”¨è®¡æ•°â€ï¼ˆå³ä¸åµŒå…¥å¯¹è±¡æœ¬èº«ï¼‰ã€‚&lt;/p>
&lt;p>ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">template&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">typename&lt;/span> T&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">control_block&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">public&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> control_block(T&lt;span style="color:#f92672">*&lt;/span> ptr)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">:&lt;/span> ref_count(&lt;span style="color:#ae81ff">1&lt;/span>), obj(ptr) {}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// å¢žåŠ å¼•ç”¨è®¡æ•°
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">add_ref&lt;/span>() { &lt;span style="color:#f92672">++&lt;/span>ref_count; }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// å‡å°‘å¼•ç”¨è®¡æ•°
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">release_ref&lt;/span>() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (&lt;span style="color:#f92672">--&lt;/span>ref_count &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">delete&lt;/span> obj; &lt;span style="color:#75715e">// åˆ é™¤å¯¹è±¡
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">delete&lt;/span> &lt;span style="color:#66d9ef">this&lt;/span>; &lt;span style="color:#75715e">// åˆ é™¤æŽ§åˆ¶å—
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> T&lt;span style="color:#f92672">*&lt;/span> &lt;span style="color:#a6e22e">get&lt;/span>() { &lt;span style="color:#66d9ef">return&lt;/span> obj; }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">private&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> std&lt;span style="color:#f92672">::&lt;/span>atomic&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">int&lt;/span>&lt;span style="color:#f92672">&amp;gt;&lt;/span> ref_count; &lt;span style="color:#75715e">// å¼•ç”¨è®¡æ•°
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> T&lt;span style="color:#f92672">*&lt;/span> obj; &lt;span style="color:#75715e">// å®žé™…å¯¹è±¡
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>};
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="ç®€åŒ–ç‰ˆ-shared_ptr-å®žçŽ°">ç®€åŒ–ç‰ˆ &lt;code>shared_ptr&lt;/code> å®žçŽ° &lt;a href="#%e7%ae%80%e5%8c%96%e7%89%88-shared_ptr-%e5%ae%9e%e7%8e%b0" class="anchor">ðŸ”—&lt;/a>&lt;/h4>&lt;p>ä¸‹é¢æ˜¯ä¸€ä¸ªç®€åŒ–ç‰ˆçš„ &lt;code>shared_ptr&lt;/code> å®žçŽ°ç¤ºä¾‹ã€‚è¿™ä¸ªç‰ˆæœ¬ä»ç„¶æœ‰ä¸€äº›é‡è¦ç»†èŠ‚éœ€è¦æ³¨æ„ï¼Œæ¯”å¦‚åŽŸå­æ“ä½œå’Œå¼‚å¸¸å®‰å…¨ç­‰é—®é¢˜ï¼Œä½†å¯ä»¥å¸®åŠ©ç†è§£ &lt;code>shared_ptr&lt;/code> çš„åŸºæœ¬åŽŸç†ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">template&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">typename&lt;/span> T&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">my_shared_ptr&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">private&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> T&lt;span style="color:#f92672">*&lt;/span> ptr;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> control_block&lt;span style="color:#f92672">&amp;lt;&lt;/span>T&lt;span style="color:#f92672">&amp;gt;*&lt;/span> ctrl_block;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">public&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">explicit&lt;/span> my_shared_ptr(T&lt;span style="color:#f92672">*&lt;/span> p &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">nullptr&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">:&lt;/span> ptr(p), ctrl_block(&lt;span style="color:#66d9ef">new&lt;/span> control_block&lt;span style="color:#f92672">&amp;lt;&lt;/span>T&lt;span style="color:#f92672">&amp;gt;&lt;/span>(p)) {}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// æ‹·è´æž„é€ å‡½æ•°
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> my_shared_ptr(&lt;span style="color:#66d9ef">const&lt;/span> my_shared_ptr&lt;span style="color:#f92672">&amp;amp;&lt;/span> other)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">:&lt;/span> ptr(other.ptr), ctrl_block(other.ctrl_block) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (ctrl_block) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ctrl_block&lt;span style="color:#f92672">-&amp;gt;&lt;/span>add_ref();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// æžæž„å‡½æ•°
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#f92672">~&lt;/span>my_shared_ptr() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (ctrl_block) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ctrl_block&lt;span style="color:#f92672">-&amp;gt;&lt;/span>release_ref();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> T&lt;span style="color:#f92672">*&lt;/span> &lt;span style="color:#66d9ef">operator&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>() { &lt;span style="color:#66d9ef">return&lt;/span> ptr; }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> T&lt;span style="color:#f92672">&amp;amp;&lt;/span> &lt;span style="color:#66d9ef">operator&lt;/span>&lt;span style="color:#f92672">*&lt;/span>() { &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#f92672">*&lt;/span>ptr; }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>};
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="stdweak_ptrçš„å®žçŽ°">&lt;code>std::weak_ptr&lt;/code>çš„å®žçŽ° &lt;a href="#stdweak_ptr%e7%9a%84%e5%ae%9e%e7%8e%b0" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;p>&lt;code>std::weak_ptr&lt;/code> æ˜¯ä¸Ž &lt;code>std::shared_ptr&lt;/code> é…åˆä½¿ç”¨çš„æ™ºèƒ½æŒ‡é’ˆï¼Œå®ƒè§£å†³äº† &lt;code>shared_ptr&lt;/code> åœ¨æŸäº›åœºæ™¯ä¸‹çš„å¾ªçŽ¯å¼•ç”¨é—®é¢˜ã€‚&lt;/p>
&lt;p>å¾ªçŽ¯å¼•ç”¨é—®é¢˜å‘ç”Ÿåœ¨ä¸¤ä¸ªæˆ–å¤šä¸ªå¯¹è±¡é€šè¿‡ &lt;code>shared_ptr&lt;/code> ç›¸äº’å¼•ç”¨æ—¶ï¼Œå¯¼è‡´å¼•ç”¨è®¡æ•°æ°¸è¿œä¸ä¸ºé›¶ï¼Œä»Žè€Œå¼•å‘å†…å­˜æ³„æ¼ã€‚ä¸ºäº†é¿å…è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¼•å…¥äº† &lt;code>weak_ptr&lt;/code>ã€‚&lt;/p>
&lt;h4 id="ä¸ºä»€ä¹ˆéœ€è¦-weak_ptr">ä¸ºä»€ä¹ˆéœ€è¦ &lt;code>weak_ptr&lt;/code> &lt;a href="#%e4%b8%ba%e4%bb%80%e4%b9%88%e9%9c%80%e8%a6%81-weak_ptr" class="anchor">ðŸ”—&lt;/a>&lt;/h4>&lt;p>&lt;code>std::weak_ptr&lt;/code> ä¸å¢žåŠ å¼•ç”¨è®¡æ•°ï¼Œå› æ­¤å®ƒä¸ä¼šå½±å“å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸã€‚å½“ä¸€ä¸ªå¯¹è±¡çš„æ‰€æœ‰ &lt;code>shared_ptr&lt;/code> è¢«é”€æ¯åŽï¼Œ&lt;code>weak_ptr&lt;/code> å°†å˜ä¸ºâ€œæ‚¬æŒ‚â€çŠ¶æ€ã€‚è¿™ä¸Žæ™®é€šæŒ‡é’ˆçš„â€œç©ºæ‚¬æŒ‡é’ˆâ€ï¼ˆdangling pointerï¼‰ä¸åŒï¼Œç©ºæ‚¬çš„ &lt;code>weak_ptr&lt;/code> ä¼šè¿”å›žç©ºæŒ‡é’ˆ &lt;code>nullptr&lt;/code>ï¼Œè¡¨æ˜Žè¯¥å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸå·²ç»ç»“æŸã€‚&lt;/p>
&lt;p>&lt;code>weak_ptr&lt;/code> æä¾›äº†ä¸€ç§è®¿é—® &lt;code>shared_ptr&lt;/code> çš„æ–¹å¼ï¼Œä½†å¹¶ä¸æŽ§åˆ¶å¯¹è±¡çš„é”€æ¯ï¼Œå› æ­¤å®ƒå¯ä»¥æœ‰æ•ˆé¿å…å¾ªçŽ¯å¼•ç”¨é—®é¢˜ã€‚&lt;/p>
&lt;p>é€šè¿‡ &lt;code>weak_ptr&lt;/code>ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¸å»¶é•¿å¯¹è±¡ç”Ÿå‘½å‘¨æœŸçš„å‰æä¸‹ï¼Œæ£€æŸ¥å¯¹è±¡æ˜¯å¦ä»ç„¶å­˜åœ¨ï¼Œå¹¶è®¿é—®å®ƒã€‚å…·ä½“æ¥è¯´ï¼Œ&lt;code>weak_ptr&lt;/code> å¯ä»¥é€šè¿‡è°ƒç”¨ &lt;code>lock()&lt;/code> æ–¹æ³•æ¥åˆ›å»ºä¸€ä¸ª &lt;code>shared_ptr&lt;/code>ï¼Œå¦‚æžœå¯¹è±¡è¿˜å­˜åœ¨ï¼ˆå³å¼•ç”¨è®¡æ•°å¤§äºŽé›¶ï¼‰ï¼Œåˆ™è¿”å›žä¸€ä¸ªæœ‰æ•ˆçš„ &lt;code>shared_ptr&lt;/code>ï¼Œå¦åˆ™è¿”å›žç©ºæŒ‡é’ˆã€‚&lt;/p>
&lt;h4 id="æŽ§åˆ¶å—çš„æ‰©å±•">æŽ§åˆ¶å—çš„æ‰©å±• &lt;a href="#%e6%8e%a7%e5%88%b6%e5%9d%97%e7%9a%84%e6%89%a9%e5%b1%95" class="anchor">ðŸ”—&lt;/a>&lt;/h4>&lt;p>ä¸ºäº†æ”¯æŒ&lt;code>std::weak_ptr&lt;/code>ï¼Œ æˆ‘ä»¬éœ€è¦æ‰©å±•æŽ§åˆ¶å—çš„åŠŸèƒ½ ï¼Œä½¿å…¶èƒ½åŒæ—¶ç®¡ç†å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ï¼ˆ&lt;code>ref_count&lt;/code>ï¼‰å’Œå¼±å¼•ç”¨è®¡æ•°ï¼ˆ&lt;code>weak_count&lt;/code>ï¼‰ï¼Œä»Žè€Œä¿æŒå¯¹å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸçš„æ­£ç¡®ç®¡ç†ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">template&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">typename&lt;/span> T&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">control_block&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">public&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> control_block(T&lt;span style="color:#f92672">*&lt;/span> ptr)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">:&lt;/span> ref_count(&lt;span style="color:#ae81ff">1&lt;/span>), weak_count(&lt;span style="color:#ae81ff">1&lt;/span>), obj(ptr) {}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// å¢žåŠ å¼•ç”¨è®¡æ•°
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">add_ref&lt;/span>() { &lt;span style="color:#f92672">++&lt;/span>ref_count; }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// å¢žåŠ å¼•ç”¨è®¡æ•°
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">bool&lt;/span> &lt;span style="color:#a6e22e">lock&lt;/span>() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">int&lt;/span> prev &lt;span style="color:#f92672">=&lt;/span> ref_count.load(); &lt;span style="color:#75715e">// ä½¿ç”¨åŠ è½½å½“å‰å€¼ï¼Œé¿å…é‡å¤è¯»å–
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">while&lt;/span> (prev &lt;span style="color:#f92672">&amp;gt;&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span> &lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span> &lt;span style="color:#f92672">!&lt;/span>ref_count.compare_exchange_weak(prev, prev &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>)) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> prev &lt;span style="color:#f92672">=&lt;/span> ref_count.load(); &lt;span style="color:#75715e">// å¦‚æžœå¤±è´¥ï¼Œé‡æ–°åŠ è½½å½“å‰å€¼
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> prev &lt;span style="color:#f92672">&amp;gt;&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>; &lt;span style="color:#75715e">// å¦‚æžœ prev &amp;gt; 0ï¼Œè¡¨ç¤ºé”å®šæˆåŠŸ
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// å‡å°‘å¼•ç”¨è®¡æ•°
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">release_ref&lt;/span>() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (&lt;span style="color:#f92672">--&lt;/span>ref_count &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">delete&lt;/span> obj; &lt;span style="color:#75715e">// åˆ é™¤å¯¹è±¡
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> release_control_block(); &lt;span style="color:#75715e">// å°è¯•åˆ é™¤æŽ§åˆ¶å—
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// å¢žåŠ å¼±å¼•ç”¨è®¡æ•°
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">add_weak_ref&lt;/span>() { &lt;span style="color:#f92672">++&lt;/span>weak_count; }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// å‡å°‘å¼±å¼•ç”¨è®¡æ•°
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">release_weak_ref&lt;/span>() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (weak_count.fetch_sub(&lt;span style="color:#ae81ff">1&lt;/span>) &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">delete&lt;/span> &lt;span style="color:#66d9ef">this&lt;/span>; &lt;span style="color:#75715e">// åˆ é™¤æŽ§åˆ¶å—
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> T&lt;span style="color:#f92672">*&lt;/span> &lt;span style="color:#a6e22e">get&lt;/span>() { &lt;span style="color:#66d9ef">return&lt;/span> obj; }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">private&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// åˆ é™¤æŽ§åˆ¶å—ï¼Œåªæœ‰åœ¨å¼±å¼•ç”¨è®¡æ•°ä¸º0æ—¶æ‰åˆ é™¤æŽ§åˆ¶å—
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> release_control_block() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (weak_count &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">delete&lt;/span> &lt;span style="color:#66d9ef">this&lt;/span>; &lt;span style="color:#75715e">// åˆ é™¤æŽ§åˆ¶å—
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> std&lt;span style="color:#f92672">::&lt;/span>atomic&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">int&lt;/span>&lt;span style="color:#f92672">&amp;gt;&lt;/span> ref_count; &lt;span style="color:#75715e">// å¼ºå¼•ç”¨è®¡æ•°
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>atomic&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">int&lt;/span>&lt;span style="color:#f92672">&amp;gt;&lt;/span> weak_count; &lt;span style="color:#75715e">// å¼±å¼•ç”¨è®¡æ•°
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> T&lt;span style="color:#f92672">*&lt;/span> obj; &lt;span style="color:#75715e">// å®žé™…å¯¹è±¡
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>};
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="weak_ptr-çš„ç®€åŒ–ç‰ˆå®žçŽ°">&lt;code>weak_ptr&lt;/code> çš„ç®€åŒ–ç‰ˆå®žçŽ° &lt;a href="#weak_ptr-%e7%9a%84%e7%ae%80%e5%8c%96%e7%89%88%e5%ae%9e%e7%8e%b0" class="anchor">ðŸ”—&lt;/a>&lt;/h4>&lt;p>ä¸‹é¢æ˜¯ä¸€ä¸ªç®€åŒ–ç‰ˆçš„ &lt;code>weak_ptr&lt;/code> å®žçŽ°ï¼Œå®ƒä¸Ž &lt;code>shared_ptr&lt;/code> å…±äº«ç›¸åŒçš„æŽ§åˆ¶å—ã€‚&lt;code>weak_ptr&lt;/code> æœ¬èº«ä¸å¢žåŠ å¼•ç”¨è®¡æ•°ï¼Œå› æ­¤ä¸ä¼šå½±å“å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">template&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">typename&lt;/span> T&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">my_weak_ptr&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">public&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> my_weak_ptr() &lt;span style="color:#f92672">:&lt;/span> ctrl_block(&lt;span style="color:#66d9ef">nullptr&lt;/span>) {}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// ä»Ž shared_ptr æž„é€  my_weak_ptr
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> my_weak_ptr(&lt;span style="color:#66d9ef">const&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>shared_ptr&lt;span style="color:#f92672">&amp;lt;&lt;/span>T&lt;span style="color:#f92672">&amp;gt;&amp;amp;&lt;/span> shared)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">:&lt;/span> ctrl_block(shared.ctrl_block) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ctrl_block&lt;span style="color:#f92672">-&amp;gt;&lt;/span>add_weak_ref();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">~&lt;/span>my_weak_ptr() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (ctrl_block) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ctrl_block&lt;span style="color:#f92672">-&amp;gt;&lt;/span>release_weak_ref();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// å°è¯•èŽ·å–æŒ‡å‘å¯¹è±¡çš„ shared_ptr
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>shared_ptr&lt;span style="color:#f92672">&amp;lt;&lt;/span>T&lt;span style="color:#f92672">&amp;gt;&lt;/span> lock() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>shared_ptr&lt;span style="color:#f92672">&amp;lt;&lt;/span>T&lt;span style="color:#f92672">&amp;gt;&lt;/span>(&lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#66d9ef">this&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">private&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> control_block&lt;span style="color:#f92672">&amp;lt;&lt;/span>T&lt;span style="color:#f92672">&amp;gt;*&lt;/span> ctrl_block; &lt;span style="color:#75715e">// æŽ§åˆ¶å—
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>};
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">template&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">typename&lt;/span> T&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">my_shared_ptr&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">private&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> T&lt;span style="color:#f92672">*&lt;/span> ptr;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> control_block&lt;span style="color:#f92672">&amp;lt;&lt;/span>T&lt;span style="color:#f92672">&amp;gt;*&lt;/span> ctrl_block;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">public&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> my_shared_ptr(&lt;span style="color:#66d9ef">const&lt;/span> my_weak_ptr&lt;span style="color:#f92672">&amp;lt;&lt;/span>T&lt;span style="color:#f92672">&amp;gt;&amp;amp;&lt;/span> weak_ptr) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (weak_ptr.ctrl_block &lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span> weak_ptr.ctrl_block&lt;span style="color:#f92672">-&amp;gt;&lt;/span>lock()) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ptr &lt;span style="color:#f92672">=&lt;/span> weak_ptr.ptr;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ctrl_block &lt;span style="color:#f92672">=&lt;/span> weak_ptr.ctrl_block();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> } &lt;span style="color:#66d9ef">else&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">throw&lt;/span> &lt;span style="color:#a6e22e">exception&lt;/span>(&lt;span style="color:#e6db74">&amp;#34;bad weak ptr&amp;#34;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>};
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="ç†è§£å¹¶ä¼˜åŒ–stdatomictæ“ä½œ">ç†è§£å¹¶ä¼˜åŒ–&lt;code>std::atomic&amp;lt;T&amp;gt;&lt;/code>æ“ä½œ &lt;a href="#%e7%90%86%e8%a7%a3%e5%b9%b6%e4%bc%98%e5%8c%96stdatomict%e6%93%8d%e4%bd%9c" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;p>åœ¨ä¸Šé¢çš„ä»£ç ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†&lt;code>std::atomic&amp;lt;int&amp;gt;&lt;/code>ä½œä¸ºæ™ºèƒ½æŒ‡é’ˆçš„å¼•ç”¨è®¡æ•°ã€‚ä¸Žç›´æŽ¥ä½¿ç”¨&lt;code>int&lt;/code>å˜é‡ä¸åŒï¼Œ&lt;code>std::atomic&amp;lt;int&amp;gt;&lt;/code>å¯ä»¥åœ¨å¤šçº¿ç¨‹çŽ¯å¢ƒä¸­æ­£ç¡®åœ°ç®¡ç†å¯¹åŒä¸€æ™ºèƒ½æŒ‡é’ˆçš„å¼•ç”¨è®¡æ•°ã€‚&lt;/p>
&lt;p>ç„¶è€Œï¼Œåœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œæˆ‘ä»¬ä»…ä½¿ç”¨äº†&lt;code>std::atomic&amp;lt;int&amp;gt;&lt;/code>çš„åŸºæœ¬æ“ä½œï¼ˆå¦‚è‡ªå¢žã€è‡ªå‡å’Œèµ‹å€¼ç­‰ï¼‰ï¼Œè¿™äº›æ“ä½œé»˜è®¤ä½¿ç”¨&lt;code>memory_order_seq_cst&lt;/code>å†…å­˜åºï¼ˆç¨åŽä¼šè®¨è®ºï¼‰ã€‚åœ¨å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­ï¼Œ&lt;code>std::atomic&amp;lt;T&amp;gt;&lt;/code>æä¾›äº†å¤šç§å†…å­˜åºï¼ˆmemory orderingï¼‰é€‰é¡¹ï¼Œç”¨ä»¥æŽ§åˆ¶æ“ä½œçš„å¯è§æ€§å’Œæ‰§è¡Œé¡ºåºï¼Œä»¥ç¡®ä¿æ•°æ®ä¸€è‡´æ€§ã€‚ä¸åŒçš„å†…å­˜åºç­–ç•¥å†³å®šäº†ç¼–è¯‘å™¨å’ŒCPUå¯¹æŒ‡ä»¤çš„é‡æŽ’åºç¨‹åº¦ã€‚&lt;/p>
&lt;p>å¼€å‘è€…çš„ç›®æ ‡æ˜¯é€‰æ‹©åˆé€‚çš„å†…å­˜åºï¼Œä¼˜åŒ–ç¨‹åºæ€§èƒ½ï¼ŒåŒæ—¶ç¡®ä¿ç¨‹åºçš„æ­£ç¡®æ€§ã€‚&lt;/p>
&lt;h3 id="å†…å­˜åºçš„æ ¸å¿ƒæ¦‚å¿µ">å†…å­˜åºçš„æ ¸å¿ƒæ¦‚å¿µ &lt;a href="#%e5%86%85%e5%ad%98%e5%ba%8f%e7%9a%84%e6%a0%b8%e5%bf%83%e6%a6%82%e5%bf%b5" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;p>ç†è§£å†…å­˜åºçš„å…³é”®åœ¨äºŽ&lt;strong>é‡æŽ’åº&lt;/strong>å’Œ&lt;strong>è·¨çº¿ç¨‹å¯è§æ€§&lt;/strong>ï¼š&lt;/p>
&lt;ol>
&lt;li>
&lt;p>&lt;strong>é‡æŽ’åºï¼ˆReorderingï¼‰&lt;/strong>&lt;br>
ç¼–è¯‘å™¨å’ŒCPUå¯èƒ½ä¼šé‡æŽ’æŒ‡ä»¤ï¼Œä»¥ä¼˜åŒ–æ€§èƒ½ã€‚ä¾‹å¦‚ï¼Œå®ƒä»¬å¯èƒ½ä¼šæå‰æ‰§è¡ŒæŸäº›è®¡ç®—ï¼Œæˆ–è€…å°†å­˜å‚¨æ“ä½œæŽ¨è¿Ÿæ‰§è¡Œã€‚æ­£ç¡®ä½¿ç”¨&lt;code>std::atomic&lt;/code>å¯ä»¥é˜²æ­¢æŸäº›å…³é”®æ“ä½œè¢«é”™è¯¯åœ°é‡æŽ’åºã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>å¯è§æ€§ï¼ˆVisibilityï¼‰&lt;/strong>&lt;br>
åœ¨å¤šçº¿ç¨‹çŽ¯å¢ƒä¸­ï¼Œä¸€ä¸ªçº¿ç¨‹å¯¹å˜é‡çš„ä¿®æ”¹å¯èƒ½ä¸ä¼šç«‹å³è¢«å…¶ä»–çº¿ç¨‹çœ‹åˆ°ï¼Œæˆ–è€…å¤šä¸ªçº¿ç¨‹å¯¹åŒä¸€å˜é‡çš„æ“ä½œé¡ºåºå¯èƒ½ä¸ç¡®å®šã€‚åŽŸå­æ“ä½œçš„å†…å­˜åºå†³å®šäº†å…¶ä»–çº¿ç¨‹ä½•æ—¶èƒ½çœ‹åˆ°è¿™äº›ä¿®æ”¹ã€‚&lt;/p>
&lt;/li>
&lt;/ol>
&lt;h3 id="ä¸åŒå†…å­˜åºçš„ä½œç”¨åŠä½¿ç”¨åœºæ™¯">ä¸åŒå†…å­˜åºçš„ä½œç”¨åŠä½¿ç”¨åœºæ™¯ &lt;a href="#%e4%b8%8d%e5%90%8c%e5%86%85%e5%ad%98%e5%ba%8f%e7%9a%84%e4%bd%9c%e7%94%a8%e5%8f%8a%e4%bd%bf%e7%94%a8%e5%9c%ba%e6%99%af" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;h4 id="memory_order_relaxedæ¾æ•£é¡ºåºæœ€ä½Žå¼€é”€">&lt;code>memory_order_relaxed&lt;/code>ï¼ˆæ¾æ•£é¡ºåºï¼Œæœ€ä½Žå¼€é”€ï¼‰ &lt;a href="#memory_order_relaxed%e6%9d%be%e6%95%a3%e9%a1%ba%e5%ba%8f%e6%9c%80%e4%bd%8e%e5%bc%80%e9%94%80" class="anchor">ðŸ”—&lt;/a>&lt;/h4>&lt;ul>
&lt;li>&lt;strong>ç‰¹ç‚¹&lt;/strong>ï¼šä¸ä¿è¯é¡ºåºï¼Œä»…ä¿è¯æ“ä½œæ˜¯&lt;strong>åŽŸå­çš„&lt;/strong>ã€‚&lt;/li>
&lt;li>&lt;strong>ä½œç”¨&lt;/strong>ï¼šç¡®ä¿åŒä¸€&lt;code>std::atomic&amp;lt;T&amp;gt;&lt;/code>å˜é‡çš„è¯»å†™æ“ä½œæ˜¯åŽŸå­çš„ï¼Œä½†ä¸æä¾›çº¿ç¨‹é—´çš„åŒæ­¥ï¼Œä¸å½±å“å¯è§æ€§æˆ–é¡ºåºã€‚&lt;/li>
&lt;li>&lt;strong>é€‚ç”¨åœºæ™¯&lt;/strong>ï¼šé€‚ç”¨äºŽ&lt;strong>æ•°æ®ç«žäº‰ä¸å½±å“ç¨‹åºæ­£ç¡®æ€§&lt;/strong>çš„åœºæ™¯ï¼Œå¦‚&lt;strong>æ— ä¾èµ–çš„è®¡æ•°&lt;/strong>ï¼ˆç»Ÿè®¡çº¿ç¨‹æ•°ã€äº‹ä»¶è®¡æ•°ç­‰ï¼‰ã€‚&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>ç¤ºä¾‹&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>std&lt;span style="color:#f92672">::&lt;/span>atomic&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">int&lt;/span>&lt;span style="color:#f92672">&amp;gt;&lt;/span> counter{&lt;span style="color:#ae81ff">0&lt;/span>};
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>counter.fetch_add(&lt;span style="color:#ae81ff">1&lt;/span>, std&lt;span style="color:#f92672">::&lt;/span>memory_order_relaxed); &lt;span style="color:#75715e">// ä»…ä¿è¯åŽŸå­æ€§ï¼Œä¸ä¿è¯å¯è§æ€§
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™é‡Œï¼Œ&lt;code>fetch_add&lt;/code>ç¡®ä¿&lt;code>counter&lt;/code>è‡ªå¢žæ“ä½œä¸ä¼šä¸¢å¤±ï¼Œä½†ä¸åŒçº¿ç¨‹çš„ä¿®æ”¹å¯èƒ½ä¼šè¢«å»¶è¿Ÿçœ‹åˆ°ã€‚&lt;/p>
&lt;h4 id="memory_order_acquireèŽ·å–é˜²æ­¢é‡æŽ’åºåˆ°å‰">&lt;code>memory_order_acquire&lt;/code>ï¼ˆèŽ·å–ï¼Œé˜²æ­¢é‡æŽ’åºåˆ°å‰ï¼‰ &lt;a href="#memory_order_acquire%e8%8e%b7%e5%8f%96%e9%98%b2%e6%ad%a2%e9%87%8d%e6%8e%92%e5%ba%8f%e5%88%b0%e5%89%8d" class="anchor">ðŸ”—&lt;/a>&lt;/h4>&lt;ul>
&lt;li>&lt;strong>ç‰¹ç‚¹&lt;/strong>ï¼šä¿è¯&lt;strong>å½“å‰çº¿ç¨‹&lt;/strong>åœ¨&lt;code>acquire&lt;/code>ä¹‹åŽçš„æ‰€æœ‰æ“ä½œä¸ä¼šè¢«é‡æŽ’åºåˆ°&lt;code>acquire&lt;/code>ä¹‹å‰ï¼Œå› æ­¤ï¼Œå…¶ä»–çº¿ç¨‹ä¸­ç›¸åŒåŽŸå­å˜é‡çš„é‡Šæ”¾æ“ä½œï¼ˆrelease operationï¼‰ä¹‹å‰çš„å†™å…¥å¯¹å½“å‰çº¿ç¨‹æ˜¯å¯è§çš„ã€‚&lt;/li>
&lt;li>&lt;strong>é€‚ç”¨åœºæ™¯&lt;/strong>ï¼šç”¨äºŽ&lt;strong>è¯»å–&lt;/strong>å…±äº«æ•°æ®ï¼Œç¡®ä¿å½“å‰çº¿ç¨‹èƒ½å¤Ÿçœ‹åˆ°å…¶ä»–çº¿ç¨‹ä¹‹å‰å¯¹è¯¥å˜é‡çš„ä¿®æ”¹ã€‚&lt;/li>
&lt;/ul>
&lt;h4 id="memory_order_releaseé‡Šæ”¾é˜²æ­¢é‡æŽ’åºåˆ°åŽ">&lt;code>memory_order_release&lt;/code>ï¼ˆé‡Šæ”¾ï¼Œé˜²æ­¢é‡æŽ’åºåˆ°åŽï¼‰ &lt;a href="#memory_order_release%e9%87%8a%e6%94%be%e9%98%b2%e6%ad%a2%e9%87%8d%e6%8e%92%e5%ba%8f%e5%88%b0%e5%90%8e" class="anchor">ðŸ”—&lt;/a>&lt;/h4>&lt;ul>
&lt;li>&lt;strong>ç‰¹ç‚¹&lt;/strong>ï¼šç¡®ä¿&lt;strong>å½“å‰çº¿ç¨‹&lt;/strong>åœ¨&lt;code>release&lt;/code>ä¹‹å‰çš„æ‰€æœ‰æ“ä½œä¸ä¼šè¢«é‡æŽ’åºåˆ°&lt;code>release&lt;/code>ä¹‹åŽï¼Œå› æ­¤ï¼Œå½“å‰æ“ä½œæ‰€åœ¨çº¿ç¨‹ä¹‹å‰çš„å†™å…¥ï¼Œåœ¨å…¶ä»–çº¿ç¨‹æ–½åŠ å æœ‰æ“ä½œï¼ˆacquire operationï¼‰ä¹‹åŽæ˜¯å¯è§çš„ã€‚&lt;/li>
&lt;li>&lt;strong>é€‚ç”¨åœºæ™¯&lt;/strong>ï¼šç”¨äºŽ&lt;strong>å†™å…¥&lt;/strong>å…±äº«æ•°æ®ï¼Œç¡®ä¿å…¶ä»–çº¿ç¨‹èƒ½åœ¨&lt;code>acquire&lt;/code>è¯»å–æ—¶çœ‹åˆ°ä¿®æ”¹ã€‚&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>ç¤ºä¾‹&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>std&lt;span style="color:#f92672">::&lt;/span>atomic&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">int&lt;/span>&lt;span style="color:#f92672">&amp;gt;&lt;/span> flag{&lt;span style="color:#ae81ff">0&lt;/span>};
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">int&lt;/span> data &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">producer&lt;/span>() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> data &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">42&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> flag.store(&lt;span style="color:#ae81ff">1&lt;/span>, std&lt;span style="color:#f92672">::&lt;/span>memory_order_release); &lt;span style="color:#75715e">// è®©æ¶ˆè´¹è€…å¯ä»¥çœ‹åˆ° data=42
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">consumer&lt;/span>() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">while&lt;/span> (flag.load(std&lt;span style="color:#f92672">::&lt;/span>memory_order_acquire) &lt;span style="color:#f92672">!=&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>); &lt;span style="color:#75715e">// ç¡®ä¿ data=42 å¯è§
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>cout &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> data &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>endl; &lt;span style="color:#75715e">// ç¡®ä¿ data çš„ä¿®æ”¹å¯¹æœ¬çº¿ç¨‹å¯è§
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>&lt;code>store(release)&lt;/code>ç¡®ä¿&lt;code>data=42&lt;/code>å‘ç”Ÿåœ¨&lt;code>flag=1&lt;/code>ä¹‹å‰ã€‚&lt;/li>
&lt;li>&lt;code>load(acquire)&lt;/code>ç¡®ä¿&lt;code>flag=1&lt;/code>ä¹‹åŽï¼Œ&lt;code>data=42&lt;/code>å¯¹æ¶ˆè´¹è€…çº¿ç¨‹å¯è§ã€‚&lt;/li>
&lt;li>é€šè¿‡&lt;code>acquire-release&lt;/code>ï¼Œæ¶ˆè´¹è€…çº¿ç¨‹èƒ½å¤Ÿæ­£ç¡®çœ‹åˆ°ç”Ÿäº§è€…çº¿ç¨‹çš„&lt;code>data&lt;/code>ä¿®æ”¹ã€‚&lt;/li>
&lt;/ul>
&lt;h4 id="memory_order_acq_relèŽ·å–-é‡Šæ”¾åŒå‘åŒæ­¥">&lt;code>memory_order_acq_rel&lt;/code>ï¼ˆèŽ·å–-é‡Šæ”¾ï¼ŒåŒå‘åŒæ­¥ï¼‰ &lt;a href="#memory_order_acq_rel%e8%8e%b7%e5%8f%96-%e9%87%8a%e6%94%be%e5%8f%8c%e5%90%91%e5%90%8c%e6%ad%a5" class="anchor">ðŸ”—&lt;/a>&lt;/h4>&lt;ul>
&lt;li>&lt;strong>ç‰¹ç‚¹&lt;/strong>ï¼šç»“åˆ&lt;code>acquire&lt;/code>å’Œ&lt;code>release&lt;/code>ï¼Œç”¨äºŽ**è¯»-æ”¹-å†™ï¼ˆRead-Modify-Write, RMWï¼‰**æ“ä½œï¼Œç¡®ä¿ï¼š
&lt;ul>
&lt;li>è¯»å–æ—¶ä½¿ç”¨&lt;code>acquire&lt;/code>è¯­ä¹‰ï¼Œä¿è¯ä¹‹å‰çš„ä¿®æ”¹å¯¹å½“å‰çº¿ç¨‹å¯è§ã€‚&lt;/li>
&lt;li>å†™å…¥æ—¶ä½¿ç”¨&lt;code>release&lt;/code>è¯­ä¹‰ï¼Œä¿è¯å½“å‰ä¿®æ”¹å¯¹åŽç»­çº¿ç¨‹å¯è§ã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;strong>é€‚ç”¨åœºæ™¯&lt;/strong>ï¼šç”¨äºŽ&lt;strong>è¯»-æ”¹-å†™&lt;/strong>ï¼ˆå¦‚&lt;code>fetch_add()&lt;/code>ã€&lt;code>exchange()&lt;/code>ï¼‰æ“ä½œï¼Œç¡®ä¿å¤šä¸ªçº¿ç¨‹èƒ½å¤Ÿæ­£ç¡®åè°ƒã€‚&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>ç¤ºä¾‹&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>std&lt;span style="color:#f92672">::&lt;/span>atomic&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">int&lt;/span>&lt;span style="color:#f92672">&amp;gt;&lt;/span> value{&lt;span style="color:#ae81ff">0&lt;/span>};
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>value.fetch_add(&lt;span style="color:#ae81ff">1&lt;/span>, std&lt;span style="color:#f92672">::&lt;/span>memory_order_acq_rel); &lt;span style="color:#75715e">// è¯»å†™éƒ½ä¿è¯å¯è§æ€§
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>åœ¨è¿™é‡Œï¼Œ&lt;code>fetch_add&lt;/code>åŒæ—¶è¯»å–æ—§å€¼å¹¶å†™å…¥æ–°å€¼ï¼š&lt;/p>
&lt;ul>
&lt;li>è¯»å–æ—¶ä½¿ç”¨&lt;code>acquire&lt;/code>è¯­ä¹‰ï¼Œç¡®ä¿å®ƒèƒ½çœ‹åˆ°å…¶ä»–çº¿ç¨‹çš„ä¿®æ”¹ã€‚&lt;/li>
&lt;li>å†™å…¥æ—¶ä½¿ç”¨&lt;code>release&lt;/code>è¯­ä¹‰ï¼Œç¡®ä¿å®ƒçš„ä¿®æ”¹èƒ½è¢«å…¶ä»–çº¿ç¨‹çœ‹åˆ°ã€‚&lt;/li>
&lt;/ul>
&lt;h4 id="memory_order_seq_csté¡ºåºä¸€è‡´æ€§æœ€ä¸¥æ ¼">&lt;code>memory_order_seq_cst&lt;/code>ï¼ˆé¡ºåºä¸€è‡´æ€§ï¼Œæœ€ä¸¥æ ¼ï¼‰ &lt;a href="#memory_order_seq_cst%e9%a1%ba%e5%ba%8f%e4%b8%80%e8%87%b4%e6%80%a7%e6%9c%80%e4%b8%a5%e6%a0%bc" class="anchor">ðŸ”—&lt;/a>&lt;/h4>&lt;ul>
&lt;li>&lt;strong>ç‰¹ç‚¹&lt;/strong>ï¼šæ‰€æœ‰ä½¿ç”¨&lt;code>memory_order_seq_cst&lt;/code>çš„åŽŸå­æ“ä½œåœ¨&lt;strong>æ‰€æœ‰çº¿ç¨‹çœ‹æ¥&lt;/strong>éƒ½æ˜¯æŒ‰ç…§ç›¸åŒçš„é¡ºåºæ‰§è¡Œçš„ï¼Œå³å…¨å±€ä¸€è‡´çš„æ—¶åºã€‚&lt;/li>
&lt;li>&lt;strong>é€‚ç”¨åœºæ™¯&lt;/strong>ï¼š
&lt;ul>
&lt;li>éœ€è¦ä¸¥æ ¼åŒæ­¥çš„åœºæ™¯ï¼Œå¦‚&lt;strong>é”&lt;/strong>ã€&lt;strong>åŒæ­¥å˜é‡&lt;/strong>ã€&lt;strong>ä¸´ç•ŒåŒºä¿æŠ¤&lt;/strong>ç­‰ã€‚&lt;/li>
&lt;li>é€‚ç”¨äºŽ&lt;strong>å¤šçº¿ç¨‹äº¤äº’å¤æ‚&lt;/strong>ã€éš¾ä»¥ç®¡ç†ä¾èµ–å…³ç³»çš„æƒ…å†µã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>ä¿è¯&lt;/strong>ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;code>seq_cst&lt;/code>ç¡®ä¿æ‰€æœ‰æ“ä½œä¸¥æ ¼æŒ‰ç…§å…¨å±€ç»Ÿä¸€é¡ºåºæ‰§è¡Œï¼Œé¿å…ä¹±åºé—®é¢˜ã€‚&lt;/li>
&lt;/ul>
&lt;h3 id="ç›´è§‚æ¯”å–»">ç›´è§‚æ¯”å–» &lt;a href="#%e7%9b%b4%e8%a7%82%e6%af%94%e5%96%bb" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;ul>
&lt;li>&lt;code>relaxed&lt;/code>ï¼šéšæ„å†™ç¬”è®°ï¼Œä½†ä¸ä¿è¯åˆ«äººèƒ½çœ‹åˆ°ã€‚&lt;/li>
&lt;li>&lt;code>acquire&lt;/code>ï¼š&lt;strong>è¿›é—¨æ£€æŸ¥å…¬å‘Šæ &lt;/strong>ï¼Œç¡®ä¿çœ‹åˆ°ä¹‹å‰çš„é€šçŸ¥ã€‚&lt;/li>
&lt;li>&lt;code>release&lt;/code>ï¼š&lt;strong>ç¦»å¼€æ—¶æ›´æ–°å…¬å‘Šæ &lt;/strong>ï¼Œè®©åŽæ¥çš„äººçœ‹åˆ°ã€‚&lt;/li>
&lt;li>&lt;code>acq_rel&lt;/code>ï¼š&lt;strong>è¿›é—¨çœ‹å…¬å‘Š + èµ°å‰æ›´æ–°å…¬å‘Š&lt;/strong>ã€‚&lt;/li>
&lt;li>&lt;code>seq_cst&lt;/code>ï¼š&lt;strong>æ‰€æœ‰äººæŒ‰åŒæ ·é¡ºåºå†™ã€çœ‹å…¬å‘Š&lt;/strong>ï¼Œä¿è¯ä¸€è‡´æ€§ã€‚&lt;/li>
&lt;/ul>
&lt;p>æ ¹æ®ä¸åŒåœºæ™¯åˆç†é€‰æ‹©å†…å­˜åºï¼Œå¯ä»¥æé«˜å¹¶å‘ç¨‹åºçš„æ­£ç¡®æ€§å’Œæ€§èƒ½ã€‚&lt;/p>
&lt;h3 id="ä¼˜åŒ–æŽ§åˆ¶å—ä¸­çš„åŽŸå­å˜é‡">ä¼˜åŒ–æŽ§åˆ¶å—ä¸­çš„åŽŸå­å˜é‡ &lt;a href="#%e4%bc%98%e5%8c%96%e6%8e%a7%e5%88%b6%e5%9d%97%e4%b8%ad%e7%9a%84%e5%8e%9f%e5%ad%90%e5%8f%98%e9%87%8f" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;atomic&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">template&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">typename&lt;/span> T&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">control_block&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">public&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> control_block(T&lt;span style="color:#f92672">*&lt;/span> ptr)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">:&lt;/span> ref_count(&lt;span style="color:#ae81ff">1&lt;/span>), weak_count(&lt;span style="color:#ae81ff">1&lt;/span>), obj(ptr) {}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// å¢žåŠ å¼•ç”¨è®¡æ•°
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">add_ref&lt;/span>() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ref_count.fetch_add(&lt;span style="color:#ae81ff">1&lt;/span>, std&lt;span style="color:#f92672">::&lt;/span>memory_order_relaxed);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// å°è¯•å¢žåŠ å¼ºå¼•ç”¨è®¡æ•°ï¼ˆä»…å½“å¯¹è±¡ä»ç„¶å­˜æ´»æ—¶ï¼‰
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">bool&lt;/span> &lt;span style="color:#a6e22e">lock&lt;/span>() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">int&lt;/span> prev &lt;span style="color:#f92672">=&lt;/span> ref_count.load(std&lt;span style="color:#f92672">::&lt;/span>memory_order_acquire);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">while&lt;/span> (prev &lt;span style="color:#f92672">&amp;gt;&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (ref_count.compare_exchange_weak(prev, prev &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> std&lt;span style="color:#f92672">::&lt;/span>memory_order_acquire, std&lt;span style="color:#f92672">::&lt;/span>memory_order_relaxed)) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> true; &lt;span style="color:#75715e">// æˆåŠŸé”å®š
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> false; &lt;span style="color:#75715e">// å¯¹è±¡å·²è¢«é‡Šæ”¾
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// é‡Šæ”¾å¼ºå¼•ç”¨
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">release_ref&lt;/span>() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (ref_count.fetch_sub(&lt;span style="color:#ae81ff">1&lt;/span>, std&lt;span style="color:#f92672">::&lt;/span>memory_order_acq_rel) &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">delete&lt;/span> obj; &lt;span style="color:#75715e">// åˆ é™¤å¯¹è±¡
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> release_control_block(); &lt;span style="color:#75715e">// å°è¯•åˆ é™¤æŽ§åˆ¶å—
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// å¢žåŠ å¼±å¼•ç”¨è®¡æ•°
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">add_weak_ref&lt;/span>() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> weak_count.fetch_add(&lt;span style="color:#ae81ff">1&lt;/span>, std&lt;span style="color:#f92672">::&lt;/span>memory_order_relaxed);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// é‡Šæ”¾å¼±å¼•ç”¨è®¡æ•°
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">release_weak_ref&lt;/span>() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (weak_count.fetch_sub(&lt;span style="color:#ae81ff">1&lt;/span>, std&lt;span style="color:#f92672">::&lt;/span>memory_order_acq_rel) &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">delete&lt;/span> &lt;span style="color:#66d9ef">this&lt;/span>; &lt;span style="color:#75715e">// åˆ é™¤æŽ§åˆ¶å—
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> T&lt;span style="color:#f92672">*&lt;/span> &lt;span style="color:#a6e22e">get&lt;/span>() { &lt;span style="color:#66d9ef">return&lt;/span> obj; }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">private&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// åˆ é™¤æŽ§åˆ¶å—ï¼Œä»…å½“å¼±å¼•ç”¨è®¡æ•°ä¹Ÿå½’é›¶æ—¶
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> release_control_block() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (weak_count.fetch_sub(&lt;span style="color:#ae81ff">1&lt;/span>, std&lt;span style="color:#f92672">::&lt;/span>memory_order_acq_rel) &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">delete&lt;/span> &lt;span style="color:#66d9ef">this&lt;/span>; &lt;span style="color:#75715e">// åˆ é™¤æŽ§åˆ¶å—
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> std&lt;span style="color:#f92672">::&lt;/span>atomic&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">int&lt;/span>&lt;span style="color:#f92672">&amp;gt;&lt;/span> ref_count; &lt;span style="color:#75715e">// å¼ºå¼•ç”¨è®¡æ•°
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>atomic&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">int&lt;/span>&lt;span style="color:#f92672">&amp;gt;&lt;/span> weak_count; &lt;span style="color:#75715e">// å¼±å¼•ç”¨è®¡æ•°
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> T&lt;span style="color:#f92672">*&lt;/span> obj; &lt;span style="color:#75715e">// å®žé™…å¯¹è±¡
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>};
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="å‚è€ƒ">å‚è€ƒ &lt;a href="#%e5%8f%82%e8%80%83" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;ul>
&lt;li>&lt;a href="https://zhuanlan.zhihu.com/p/532215950">C++å†…å­˜ç®¡ç†ï¼šshared_ptr/weak_ptræºç &lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.cnblogs.com/Solstice/archive/2010/02/10/dtor_meets_threads.html">å½“æžæž„å‡½æ•°é‡åˆ°å¤šçº¿ç¨‹ â”€â”€ C++ ä¸­çº¿ç¨‹å®‰å…¨çš„å¯¹è±¡å›žè°ƒ&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://liam.page/2021/12/11/memory-order-cpp-02/">ç¨‹åºå‘˜çš„è‡ªæˆ‘ä¿®å…»ï¼ˆâ‘«ï¼‰ï¼šC++ çš„å†…å­˜é¡ºåº&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>std::visitå®žçŽ°è¿è¡Œæ—¶å¤šæ€ - C++ for the Antiquatedï¼ˆä¹‹ä¸‰ï¼‰</title><link>https://wizmann.top/posts/std-visit-polymorphism-cpp-for-the-antiquated-3/</link><pubDate>Sat, 04 Jan 2025 00:00:00 +0000</pubDate><guid>https://wizmann.top/posts/std-visit-polymorphism-cpp-for-the-antiquated-3/</guid><description>&lt;p>åœ¨ä¼ ç»Ÿçš„ &lt;strong>C++&lt;/strong> ä¸­ï¼Œ&lt;strong>è¿è¡Œæ—¶å¤šæ€&lt;/strong> é€šå¸¸ä¾èµ–äºŽ &lt;strong>â€œæŽ¥å£ - è™šå‡½æ•°â€&lt;/strong> æœºåˆ¶ï¼Œé€šè¿‡æŠ½è±¡ç±»ã€å…·ä½“ç±»ä¸Žå¯¹è±¡çš„è®¾è®¡æ¥å®žçŽ°ã€‚è¿™ç§å¤šæ€æ–¹å¼é€šå¸¸è¢«ç§°ä¸º &lt;strong>å­ç±»åž‹å¤šæ€&lt;/strong>ï¼ˆ&lt;em>Subtype Polymorphism&lt;/em>ï¼‰ã€‚&lt;/p>
&lt;p>åœ¨ä¹‹å‰çš„æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬ä»‹ç»äº†çŽ°ä»£ C++ å¼•å…¥çš„ &lt;code>std::variant&lt;/code> â€”â€” ä¸€ç§ç±»åž‹å®‰å…¨çš„è”åˆä½“ï¼Œä»¥åŠå¦‚ä½•å€ŸåŠ© &lt;code>std::visit&lt;/code> åœ¨ç±»åž‹å®‰å…¨çš„å‰æä¸‹ï¼ŒåŠ¨æ€åœ°è®¿é—®è”åˆä½“ä¸­çš„ä¸åŒç±»åž‹ï¼Œå¹¶æ‰§è¡Œç›¸åº”çš„é€»è¾‘ã€‚è¿™ç§å¤šæ€æ–¹å¼è¢«ç§°ä¸º &lt;strong>ä¸´æ—¶å¤šæ€&lt;/strong>ï¼ˆ&lt;em>Ad-hoc Polymorphism&lt;/em>ï¼‰ã€‚&lt;/p>
&lt;p>é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€ç§è¢«ç§°ä¸º &lt;strong>å‚æ•°åŒ–å¤šæ€&lt;/strong>ï¼ˆ&lt;em>Parametric Polymorphism&lt;/em>ï¼‰ï¼Œå³æˆ‘ä»¬ç†ŸçŸ¥çš„ &lt;strong>C++ æ¨¡æ¿&lt;/strong>ã€‚å®ƒå…è®¸æˆ‘ä»¬ç¼–å†™ä¸Žç±»åž‹æ— å…³çš„ä»£ç ï¼Œæä¾›æ›´å¼ºçš„æ³›åž‹ç¼–ç¨‹èƒ½åŠ›ã€‚ç”±äºŽæœ¬ç¯‡æ–‡ç« çš„é‡ç‚¹å¹¶ä¸åœ¨æ­¤ï¼Œæˆ‘ä»¬æš‚ä¸”ä¸å±•å¼€ã€‚&lt;/p>
&lt;p>åœ¨æœ¬ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†é‡ç‚¹å¯¹æ¯” &lt;strong>å­ç±»åž‹å¤šæ€&lt;/strong> å’Œ &lt;strong>ä¸´æ—¶å¤šæ€&lt;/strong> çš„ä¼˜åŠ£ï¼Œåˆ†æžå®ƒä»¬åœ¨å®žé™…åœºæ™¯ä¸­çš„åº”ç”¨ä¸Žæƒè¡¡ï¼Œå¸Œæœ›èƒ½æ›´å¥½åœ°ç†è§£å’Œé€‰æ‹©åˆé€‚çš„å¤šæ€æœºåˆ¶ã€‚&lt;/p>
&lt;h2 id="ä¸´æ—¶å¤šæ€çš„å®žçŽ°åŽŸç†">&lt;strong>ä¸´æ—¶å¤šæ€çš„å®žçŽ°åŽŸç†&lt;/strong> &lt;a href="#%e4%b8%b4%e6%97%b6%e5%a4%9a%e6%80%81%e7%9a%84%e5%ae%9e%e7%8e%b0%e5%8e%9f%e7%90%86" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;p>&lt;strong>ä¸´æ—¶å¤šæ€&lt;/strong>ï¼ˆ&lt;em>Ad-hoc Polymorphism&lt;/em>ï¼‰ä¸Ž &lt;strong>å­ç±»åž‹å¤šæ€&lt;/strong>ï¼ˆ&lt;em>Subtype Polymorphism&lt;/em>ï¼‰åœ¨å®žçŽ°åŽŸç†ä¸Šæœ‰ä¸€å®šçš„ç›¸ä¼¼æ€§ï¼šå®ƒä»¬éƒ½ä¾èµ–äºŽåœ¨ç±»åž‹ä¸­å¼•å…¥é¢å¤–çš„ä¿¡æ¯æ¥å†³å®šä¸åŒç±»åž‹åº”æ‰§è¡Œçš„å‡½æ•°é€»è¾‘ã€‚&lt;/p>
&lt;ul>
&lt;li>&lt;strong>å­ç±»åž‹å¤šæ€&lt;/strong>ï¼šä¾èµ–äºŽ&lt;strong>è™šè¡¨ï¼ˆvtableï¼‰&lt;/strong> å’Œ &lt;strong>è™šæŒ‡é’ˆï¼ˆvptrï¼‰&lt;/strong>ï¼Œé€šè¿‡è¿è¡Œæ—¶çš„åŠ¨æ€åˆ†æ´¾æ¥ç¡®å®šè°ƒç”¨å“ªä¸ªæ´¾ç”Ÿç±»çš„æˆå‘˜å‡½æ•°ã€‚&lt;/li>
&lt;li>&lt;strong>ä¸´æ—¶å¤šæ€&lt;/strong>ï¼šä¾èµ–ä¸€ä¸ª &lt;strong>æžšä¸¾å€¼ï¼ˆenumï¼‰&lt;/strong> æ¥è¡¨ç¤ºç±»åž‹ä¿¡æ¯ï¼Œé€šè¿‡æ˜¾å¼çš„ &lt;code>switch-case&lt;/code> æˆ– &lt;code>if-else&lt;/code> è¯­å¥æ¥é€‰æ‹©ä¸åŒçš„é€»è¾‘åˆ†æ”¯ã€‚&lt;/li>
&lt;/ul>
&lt;h3 id="ç®€å•ç¤ºä¾‹æ¨¡æ‹Ÿ-stdvisit">&lt;strong>ç®€å•ç¤ºä¾‹ï¼šæ¨¡æ‹Ÿ std::visit&lt;/strong> &lt;a href="#%e7%ae%80%e5%8d%95%e7%a4%ba%e4%be%8b%e6%a8%a1%e6%8b%9f-stdvisit" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;blockquote>
&lt;p>è¿™é‡Œåªä½¿ç”¨äº†ä¼ ç»ŸC++çš„å®žçŽ°ï¼Œå…³äºŽ&lt;code>std::visit&lt;/code>çš„æ›´è¯¦ç»†çš„è§£è¯»ï¼Œå¯ä»¥å‚è€ƒæœ¬ç³»åˆ—çš„â€œåŠ¨æ‰‹å®žçŽ°std::visitâ€ä¸€æ–‡ã€‚&lt;/p>&lt;/blockquote>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;iostream&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;string&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;cassert&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">enum&lt;/span> &lt;span style="color:#a6e22e">EType&lt;/span> &lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#66d9ef">uint8_t&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> TYPE_Int &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> TYPE_Float &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> TYPE_String &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">2&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>};
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">struct&lt;/span> &lt;span style="color:#a6e22e">MyVariant&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> EType type;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">void&lt;/span>&lt;span style="color:#f92672">*&lt;/span> obj;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>};
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">MyVisitor&lt;/span>(MyVariant&lt;span style="color:#f92672">&amp;amp;&lt;/span> var) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">switch&lt;/span> (var.type) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">case&lt;/span> TYPE_Int:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> std&lt;span style="color:#f92672">::&lt;/span>cout &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#e6db74">&amp;#34;Int: &amp;#34;&lt;/span> &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#f92672">*&lt;/span>(&lt;span style="color:#66d9ef">int&lt;/span>&lt;span style="color:#f92672">*&lt;/span>)var.obj &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>endl;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">break&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">case&lt;/span> TYPE_Float:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> std&lt;span style="color:#f92672">::&lt;/span>cout &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#e6db74">&amp;#34;Float: &amp;#34;&lt;/span> &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#f92672">*&lt;/span>(&lt;span style="color:#66d9ef">float&lt;/span>&lt;span style="color:#f92672">*&lt;/span>)var.obj &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>endl;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">break&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">case&lt;/span> TYPE_String:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> std&lt;span style="color:#f92672">::&lt;/span>cout &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#e6db74">&amp;#34;String: &amp;#34;&lt;/span> &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#f92672">*&lt;/span>(std&lt;span style="color:#f92672">::&lt;/span>string&lt;span style="color:#f92672">*&lt;/span>)var.obj &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>endl;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">break&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">default&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> assert(false &lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span> &lt;span style="color:#e6db74">&amp;#34;Unknown type!&amp;#34;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">break&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">int&lt;/span> &lt;span style="color:#a6e22e">main&lt;/span>() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">int&lt;/span> i &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">42&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">float&lt;/span> f &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">3.14f&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> std&lt;span style="color:#f92672">::&lt;/span>string s &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#e6db74">&amp;#34;Hello&amp;#34;&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> MyVariant var1 &lt;span style="color:#f92672">=&lt;/span> {TYPE_Int, &lt;span style="color:#f92672">&amp;amp;&lt;/span>i};
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> MyVariant var2 &lt;span style="color:#f92672">=&lt;/span> {TYPE_Float, &lt;span style="color:#f92672">&amp;amp;&lt;/span>f};
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> MyVariant var3 &lt;span style="color:#f92672">=&lt;/span> {TYPE_String, &lt;span style="color:#f92672">&amp;amp;&lt;/span>s};
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> MyVisitor(var1);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> MyVisitor(var2);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> MyVisitor(var3);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="åŽŸç†è§£æž">&lt;strong>åŽŸç†è§£æž&lt;/strong> &lt;a href="#%e5%8e%9f%e7%90%86%e8%a7%a3%e6%9e%90" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;ol>
&lt;li>&lt;strong>EType æžšä¸¾&lt;/strong>
&lt;ul>
&lt;li>å®šä¹‰äº†ä¸€ä¸ªæžšä¸¾ç±»åž‹ &lt;code>EType&lt;/code>ï¼Œç”¨äºŽæ ‡è¯† &lt;code>MyVariant&lt;/code> å½“å‰å­˜å‚¨çš„å…·ä½“ç±»åž‹ã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;strong>MyVariant ç»“æž„ä½“&lt;/strong>
&lt;ul>
&lt;li>&lt;code>type&lt;/code> å­—æ®µä¿å­˜å½“å‰å¯¹è±¡çš„ç±»åž‹ä¿¡æ¯ã€‚&lt;/li>
&lt;li>&lt;code>obj&lt;/code> å­—æ®µæ˜¯ä¸€ä¸ªé€šç”¨æŒ‡é’ˆï¼ŒæŒ‡å‘å®žé™…å­˜å‚¨çš„æ•°æ®å¯¹è±¡ã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;strong>MyVisitor å‡½æ•°&lt;/strong>
&lt;ul>
&lt;li>é€šè¿‡ &lt;code>switch-case&lt;/code> è¯­å¥ï¼ŒåŸºäºŽ &lt;code>type&lt;/code> å­—æ®µé€‰æ‹©ä¸åŒçš„åˆ†æ”¯é€»è¾‘æ¥è®¿é—®å’Œæ‰“å°ä¸åŒç±»åž‹çš„æ•°æ®ã€‚&lt;/li>
&lt;li>å¦‚æžœé‡åˆ°æœªçŸ¥ç±»åž‹ï¼Œç¨‹åºä¼šè§¦å‘ &lt;code>assert&lt;/code> ä»¥é˜²æ­¢æœªå®šä¹‰è¡Œä¸ºã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ol>
&lt;h3 id="æ€§èƒ½ä¼˜åŒ–æ€è€ƒ">&lt;strong>æ€§èƒ½ä¼˜åŒ–æ€è€ƒ&lt;/strong> &lt;a href="#%e6%80%a7%e8%83%bd%e4%bc%98%e5%8c%96%e6%80%9d%e8%80%83" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;p>åœ¨å®žé™…åº”ç”¨ä¸­ï¼Œ&lt;code>switch-case&lt;/code> è¯­å¥å¯èƒ½éšç€ç±»åž‹æ•°é‡çš„å¢žåŠ è€Œå¯¼è‡´æ€§èƒ½å¼€é”€ã€‚å¯ä»¥é€šè¿‡äºŒåˆ†æŸ¥æ‰¾ï¼ˆBinary Searchï¼‰æ–¹æ³•è¿›è¡Œä¼˜åŒ–ï¼Œå‡å°‘ &lt;code>switch-case&lt;/code> çš„åˆ†æ”¯æ·±åº¦ã€‚&lt;/p>
&lt;h2 id="ä¸´æ—¶å¤šæ€çš„æ€§èƒ½åˆ†æž">ä¸´æ—¶å¤šæ€çš„æ€§èƒ½åˆ†æž &lt;a href="#%e4%b8%b4%e6%97%b6%e5%a4%9a%e6%80%81%e7%9a%84%e6%80%a7%e8%83%bd%e5%88%86%e6%9e%90" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;p>è™šå‡½æ•°å¸¸å› å…¶è¾ƒä½Žçš„æ€§èƒ½è€Œå—åˆ°æ‰¹è¯„ã€‚ä¸ºäº†æ›´å¥½åœ°äº†è§£è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å°†å¯¹æ¯”ä½¿ç”¨è™šå‡½æ•°å®žçŽ°çš„â€œå­ç±»åž‹å¤šæ€â€å’Œé€šè¿‡ &lt;code>std::visit&lt;/code> å®žçŽ°çš„â€œä¸´æ—¶å¤šæ€â€åœ¨æ€§èƒ½ä¸Šçš„å·®å¼‚ã€‚&lt;/p>
&lt;ul>
&lt;li>ä½¿ç”¨è™šå‡½æ•°å®žçŽ°çš„&lt;a href="https://gist.github.com/Wizmann/df65af6d214c3b4ae296363839477b94">ä»£ç &lt;/a>&lt;/li>
&lt;li>ä½¿ç”¨&lt;code>std::visit&lt;/code> + &lt;code>std::variant&amp;lt;object&amp;gt;&lt;/code> å®žçŽ°çš„&lt;a href="https://gist.github.com/Wizmann/f1494312a8e0cf30b97e9d8580fa9d6d">ä»£ç &lt;/a>&lt;/li>
&lt;li>ä½¿ç”¨&lt;code>std::visit&lt;/code> + &lt;code>std::variant&amp;lt;ptr&amp;gt;&lt;/code> å®žçŽ°çš„&lt;a href="https://gist.github.com/Wizmann/a25708bcd732df8f6e3d158f7105b6c9">ä»£ç &lt;/a>&lt;/li>
&lt;/ul>
&lt;p>ç»“æžœå¦‚ä¸‹ï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code># ä½¿ç”¨g++ --std=c++17 -O2ç¼–è¯‘è¿è¡Œ
# ä½¿ç”¨è™šå‡½æ•°å®žçŽ°
Total Object Creation Time: 55.53 ms
Total Visit Time: 6.99 ms
# ä½¿ç”¨std::visit + std::variant&amp;lt;object&amp;gt;å®žçŽ°
Total Object Creation Time: 26.88 ms
Total Visit Time: 5.93 ms
# ä½¿ç”¨std::visit + std::variant&amp;lt;ptr&amp;gt;å®žçŽ°
Total Object Creation Time: 52.15 ms
Total Visit Time: 6.05 ms
&lt;/code>&lt;/pre>&lt;h3 id="ç»“æžœåˆ†æž">ç»“æžœåˆ†æž &lt;a href="#%e7%bb%93%e6%9e%9c%e5%88%86%e6%9e%90" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;ul>
&lt;li>å†…å­˜ç®¡ç†å¼€é”€ï¼š
ä½¿ç”¨è™šå‡½æ•°çš„å­ç±»åž‹å¤šæ€å®žçŽ°é€šå¸¸éœ€è¦åŠ¨æ€ç”³è¯·å’Œé‡Šæ”¾å†…å­˜ï¼Œä»Žè€Œå¼•å…¥äº†é¢å¤–çš„å†…å­˜ç®¡ç†å¼€é”€ã€‚è€Œä½¿ç”¨åŸºäºŽ &lt;code>std::variant&amp;lt;object&amp;gt;&lt;/code>çš„ä¸´æ—¶å¤šæ€å¯ä»¥ä¸€æ¬¡æ€§åˆ†é…æ‰€æœ‰å†…å­˜ï¼Œè™½ç„¶å¯èƒ½å­˜åœ¨ä¸€å®šç¨‹åº¦çš„å†…å­˜æµªè´¹ï¼Œä½†é¿å…äº†é¢‘ç¹çš„åŠ¨æ€å†…å­˜ç®¡ç†ã€‚&lt;/li>
&lt;li>æ€§èƒ½æŽ¥è¿‘ï¼Œ&lt;code>std::visit&lt;/code> ç•¥ä¼˜ï¼š
è™½ç„¶è™šå‡½æ•°å’Œ &lt;code>std::visit&lt;/code> çš„æ€§èƒ½å·®è·ä¸å¤§ï¼Œä½† &lt;code>std::visit&lt;/code> ç•¥å¾®ä¼˜äºŽè™šå‡½æ•°ã€‚ä¸¤è€…éƒ½å¼•å…¥äº†é¢å¤–çš„å¼€é”€ä»¥å®žçŽ°å¤šæ€ã€‚&lt;/li>
&lt;/ul>
&lt;h2 id="é€šè¿‡ä¸´æ—¶å¤šæ€å®žçŽ°vistoræ¨¡å¼">é€šè¿‡ä¸´æ—¶å¤šæ€å®žçŽ°Vistoræ¨¡å¼ &lt;a href="#%e9%80%9a%e8%bf%87%e4%b8%b4%e6%97%b6%e5%a4%9a%e6%80%81%e5%ae%9e%e7%8e%b0vistor%e6%a8%a1%e5%bc%8f" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;p>Visitoræ¨¡å¼æ˜¯ä¸€ç§è¡Œä¸ºè®¾è®¡æ¨¡å¼ï¼Œç”¨äºŽå°†æ•°æ®ç»“æž„çš„æ“ä½œä¸Žæ•°æ®ç»“æž„æœ¬èº«åˆ†ç¦»ã€‚å®ƒé€šå¸¸é€šè¿‡â€œå­ç±»åž‹å¤šæ€â€æ¥å®žçŽ°ï¼Œå…¶ä¸­æ¯ä¸ªå…·ä½“ç±»åž‹çš„å¯¹è±¡éƒ½æŽ¥å—ä¸€ä¸ªè®¿é—®è€…ï¼ˆVisitorï¼‰å¹¶å¯¹å…¶è¿›è¡Œç›¸åº”çš„å¤„ç†ã€‚ä½¿ç”¨è™šå‡½æ•°å’Œç»§æ‰¿æ˜¯å®žçŽ°è¿™ä¸€æ¨¡å¼çš„ä¸€ç§æ–¹å¼ï¼Œä½†æœ‰æ—¶æˆ‘ä»¬å¯ä»¥ç”¨æ›´è½»é‡çš„æ–¹å¼æ¥å®žçŽ°ï¼Œæ¯”å¦‚é€šè¿‡ä¸´æ—¶å¤šæ€ç»“åˆ &lt;code>std::variant&lt;/code> å’Œ &lt;code>std::visit&lt;/code>ã€‚&lt;/p>
&lt;h3 id="ä½¿ç”¨è™šå‡½æ•°å®žçŽ°visitoræ¨¡å¼">ä½¿ç”¨è™šå‡½æ•°å®žçŽ°Visitoræ¨¡å¼ &lt;a href="#%e4%bd%bf%e7%94%a8%e8%99%9a%e5%87%bd%e6%95%b0%e5%ae%9e%e7%8e%b0visitor%e6%a8%a1%e5%bc%8f" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;p>æˆ‘ä»¬é¦–å…ˆæ¥çœ‹ä¸€ä¸ªä¼ ç»Ÿçš„é€šè¿‡å­ç±»åž‹å¤šæ€å®žçŽ°Visitoræ¨¡å¼çš„ä¾‹å­ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">struct&lt;/span> &lt;span style="color:#a6e22e">IVisitor&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">struct&lt;/span> &lt;span style="color:#a6e22e">IResource&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">virtual&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">accept&lt;/span>(IVisitor&lt;span style="color:#f92672">*&lt;/span> visitor) &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>};
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">struct&lt;/span> &lt;span style="color:#a6e22e">IVisitor&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">virtual&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">visit&lt;/span>(IResource&lt;span style="color:#f92672">*&lt;/span> res) &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>};
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">MyResource&lt;/span> &lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#66d9ef">public&lt;/span> IResource {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">public&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">void&lt;/span> accept(IVisitor&lt;span style="color:#f92672">*&lt;/span> visitor) &lt;span style="color:#66d9ef">override&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> visitor&lt;span style="color:#f92672">-&amp;gt;&lt;/span>visit(&lt;span style="color:#66d9ef">this&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>};
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">MyVisitor&lt;/span> &lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#66d9ef">public&lt;/span> IVisitor {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">public&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">void&lt;/span> visit(IResource&lt;span style="color:#f92672">*&lt;/span> res) &lt;span style="color:#66d9ef">override&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// å¤„ç†èµ„æº
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>};
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™ç§å®žçŽ°æ–¹å¼è™½ç„¶èƒ½å¾ˆå¥½åœ°åˆ†ç¦»æ•°æ®å’Œæ“ä½œï¼Œä½†å®ƒä¹Ÿæœ‰ä¸€äº›ä¸è¶³ä¹‹å¤„ï¼š&lt;/p>
&lt;ul>
&lt;li>æ¯æ¬¡è°ƒç”¨ &lt;code>visit&lt;/code> éƒ½éœ€è¦é€šè¿‡è™šå‡½æ•°æ¥é—´æŽ¥è°ƒç”¨æ–¹æ³•ï¼Œè¿™ä¼šå¼•å…¥é¢å¤–çš„æ€§èƒ½å¼€é”€ã€‚&lt;/li>
&lt;li>&lt;code>visitor&lt;/code> æ— æ³•åœ¨ &lt;code>visit&lt;/code> æ—¶ç›´æŽ¥èŽ·å–èµ„æºå¯¹è±¡çš„ç±»åž‹ä¿¡æ¯ï¼Œé€šå¸¸éœ€è¦é¢å¤–ä¼ é€’ç±»åž‹ä¿¡æ¯æˆ–è€…è®©èµ„æºç±»æš´éœ²æ›´å¤šçš„æŽ¥å£ã€‚&lt;/li>
&lt;/ul>
&lt;h3 id="ä½¿ç”¨-stdvisit-å®žçŽ°visitoræ¨¡å¼">ä½¿ç”¨ &lt;code>std::visit&lt;/code> å®žçŽ°Visitoræ¨¡å¼ &lt;a href="#%e4%bd%bf%e7%94%a8-stdvisit-%e5%ae%9e%e7%8e%b0visitor%e6%a8%a1%e5%bc%8f" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;p>é€šè¿‡ &lt;code>std::visit&lt;/code> å’Œ &lt;code>std::variant&lt;/code>ï¼Œæˆ‘ä»¬å¯ä»¥æ˜¾å¼åœ°é€šè¿‡ç±»åž‹ä¿¡æ¯æ¥å¤„ç†æ¯ç§èµ„æºç±»åž‹ï¼Œé¿å…äº†è™šå‡½æ•°è°ƒç”¨çš„å¼€é”€ï¼ŒåŒæ—¶ä½¿å¾—ä»£ç æ›´åŠ ç®€æ´å’Œç±»åž‹å®‰å…¨ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªé€šè¿‡ä¸´æ—¶å¤šæ€å®žçŽ°Visitoræ¨¡å¼çš„ä¾‹å­ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">using&lt;/span> ResourceUnion &lt;span style="color:#f92672">=&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>variant&lt;span style="color:#f92672">&amp;lt;&lt;/span>ResourceA, ResourceB, ResourceC&lt;span style="color:#f92672">&amp;gt;&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>std&lt;span style="color:#f92672">::&lt;/span>vector&lt;span style="color:#f92672">&amp;lt;&lt;/span>ResourceUnion&lt;span style="color:#f92672">&amp;gt;&lt;/span> resources;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">for&lt;/span> (&lt;span style="color:#66d9ef">auto&lt;/span>&lt;span style="color:#f92672">&amp;amp;&lt;/span> res : resources) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> std&lt;span style="color:#f92672">::&lt;/span>visit([](&lt;span style="color:#66d9ef">auto&lt;/span>&lt;span style="color:#f92672">&amp;amp;&lt;/span> res) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">using&lt;/span> T &lt;span style="color:#f92672">=&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>decay_t&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">decltype&lt;/span>(res)&lt;span style="color:#f92672">&amp;gt;&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#a6e22e">constexpr&lt;/span> (std&lt;span style="color:#f92672">::&lt;/span>is_same_v&lt;span style="color:#f92672">&amp;lt;&lt;/span>T, ResourceA&lt;span style="color:#f92672">&amp;gt;&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// å¤„ç†ç±»åž‹ä¸º ResourceA çš„èµ„æº
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> } &lt;span style="color:#66d9ef">else&lt;/span> &lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#a6e22e">constexpr&lt;/span> (std&lt;span style="color:#f92672">::&lt;/span>is_same_v&lt;span style="color:#f92672">&amp;lt;&lt;/span>T, ResourceB&lt;span style="color:#f92672">&amp;gt;&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// å¤„ç†ç±»åž‹ä¸º ResourceB çš„èµ„æº
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> } &lt;span style="color:#66d9ef">else&lt;/span> &lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#a6e22e">constexpr&lt;/span> (std&lt;span style="color:#f92672">::&lt;/span>is_same_v&lt;span style="color:#f92672">&amp;lt;&lt;/span>T, ResourceC&lt;span style="color:#f92672">&amp;gt;&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// å¤„ç†ç±»åž‹ä¸º ResourceC çš„èµ„æº
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> } &lt;span style="color:#66d9ef">else&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">static_assert&lt;/span>(always_false_v&lt;span style="color:#f92672">&amp;lt;&amp;gt;&lt;/span>, &lt;span style="color:#e6db74">&amp;#34;Unhandled type!&amp;#34;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }, res);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="ä¼˜ç‚¹ä¸Žåˆ†æž">ä¼˜ç‚¹ä¸Žåˆ†æž &lt;a href="#%e4%bc%98%e7%82%b9%e4%b8%8e%e5%88%86%e6%9e%90" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;ol>
&lt;li>
&lt;p>&lt;strong>ç±»åž‹å®‰å…¨&lt;/strong>ï¼š
ä½¿ç”¨ &lt;code>std::visit&lt;/code> æ—¶ï¼Œç¼–è¯‘å™¨å¯ä»¥æ ¹æ®ç±»åž‹æŽ¨æ–­å¹¶ä¸ºæ¯ç§ç±»åž‹ç”Ÿæˆä¸åŒçš„ä»£ç è·¯å¾„ï¼Œä»Žè€Œé¿å…äº†è¿è¡Œæ—¶é”™è¯¯å’Œç±»åž‹é”™è¯¯ï¼Œæå‡äº†ç±»åž‹å®‰å…¨æ€§ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>æ€§èƒ½&lt;/strong>ï¼š
ç”±äºŽä¸å†ä¾èµ–è™šå‡½æ•°ï¼Œ&lt;code>std::visit&lt;/code> èƒ½é¿å…æ¯æ¬¡è°ƒç”¨ &lt;code>visit&lt;/code> æ—¶çš„è™šå‡½æ•°å¼€é”€ï¼Œä»Žè€Œæé«˜äº†æ€§èƒ½ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>ç®€æ´æ€§&lt;/strong>ï¼š
é€šè¿‡ &lt;code>std::variant&lt;/code> å’Œ &lt;code>std::visit&lt;/code>ï¼Œä»£ç æ›´åŠ ç®€æ´ä¸”ä¸éœ€è¦ç¹ççš„ç»§æ‰¿ç»“æž„ã€‚æ¯ä¸ªèµ„æºç±»åž‹åªéœ€å…³æ³¨å…¶è‡ªèº«çš„å®žçŽ°ï¼Œè€Œæ— éœ€å¤„ç†ä¸åŒè®¿é—®è€…çš„é€»è¾‘ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>æ‰©å±•æ€§&lt;/strong>ï¼š
å¦‚æžœè¦æ–°å¢žèµ„æºç±»åž‹ï¼Œåªéœ€åœ¨ &lt;code>std::variant&lt;/code> ä¸­æ·»åŠ æ–°ç±»åž‹ï¼Œå¹¶åœ¨ &lt;code>std::visit&lt;/code> çš„ lambda è¡¨è¾¾å¼ä¸­æ·»åŠ å¯¹åº”çš„åˆ†æ”¯ï¼Œé¿å…äº†ä¿®æ”¹çŽ°æœ‰ä»£ç çš„é£Žé™©ã€‚&lt;/p>
&lt;/li>
&lt;/ol>
&lt;h2 id="ä¸´æ—¶å¤šæ€çš„ä¼˜ç‚¹ä¸Žç¼ºç‚¹">ä¸´æ—¶å¤šæ€çš„ä¼˜ç‚¹ä¸Žç¼ºç‚¹ &lt;a href="#%e4%b8%b4%e6%97%b6%e5%a4%9a%e6%80%81%e7%9a%84%e4%bc%98%e7%82%b9%e4%b8%8e%e7%bc%ba%e7%82%b9" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;h3 id="ä¼˜ç‚¹">ä¼˜ç‚¹ï¼š &lt;a href="#%e4%bc%98%e7%82%b9" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;ol>
&lt;li>&lt;strong>ç±»åž‹å®‰å…¨&lt;/strong>ï¼š&lt;code>std::variant&lt;/code> ä¸Ž &lt;code>std::visit&lt;/code> ç¡®ä¿äº†ç±»åž‹å®‰å…¨ï¼Œé¿å…äº†è®¸å¤šä¼ ç»Ÿå¤šæ€æœºåˆ¶ä¸­çš„é”™è¯¯ã€‚&lt;/li>
&lt;li>&lt;strong>æ€§èƒ½ä¼˜åŒ–&lt;/strong>ï¼šç›¸è¾ƒäºŽè™šå‡½æ•°ï¼Œ&lt;code>std::visit&lt;/code> é€šè¿‡ç±»åž‹æŠ˜å å’Œç¼–è¯‘æ—¶åˆ†æ”¯ä¼˜åŒ–ï¼Œé€šå¸¸è¡¨çŽ°å‡ºæ›´å¥½çš„æ€§èƒ½ï¼Œå°¤å…¶åœ¨æ²¡æœ‰åŠ¨æ€å†…å­˜ç®¡ç†æ—¶ã€‚&lt;/li>
&lt;li>&lt;strong>è‡ªç”±ç»„ç»‡åŠŸèƒ½å‡½æ•°&lt;/strong>ï¼šä½ å¯ä»¥çµæ´»åœ°å°†åŠŸèƒ½å‡½æ•°ç»„ç»‡åœ¨ä¸€ä¸ªåœ°æ–¹ï¼Œè€Œæ— éœ€ä¿®æ”¹æ¯ä¸ªå…·ä½“ç±»åž‹ã€‚&lt;/li>
&lt;/ol>
&lt;h3 id="ç¼ºç‚¹">ç¼ºç‚¹ï¼š &lt;a href="#%e7%bc%ba%e7%82%b9" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;ol>
&lt;li>&lt;strong>èŒè´£åˆ†æ•£&lt;/strong>ï¼šæ¯ä¸ªç±»åž‹çš„è¡Œä¸ºéƒ½å¯èƒ½åˆ†æ•£åˆ°å¤šä¸ª&lt;code>visit&lt;/code>å‡½æ•°ä¸­ï¼Œå¯¼è‡´ä»£ç éš¾ä»¥ç»´æŠ¤ã€‚&lt;/li>
&lt;li>&lt;strong>é«˜è€¦åˆé£Žé™©&lt;/strong>ï¼šå½“æ–°å¢žç±»åž‹æ—¶ï¼Œæ‰€æœ‰è®¿é—®é€»è¾‘éœ€è¦ä¿®æ”¹ï¼Œå¯èƒ½å¸¦æ¥è¾ƒé«˜çš„è€¦åˆåº¦ï¼Œå°¤å…¶åœ¨ç±»åž‹è¾ƒå¤šæ—¶ã€‚&lt;/li>
&lt;/ol>
&lt;h2 id="å‚è€ƒ">å‚è€ƒ &lt;a href="#%e5%8f%82%e8%80%83" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;ul>
&lt;li>C++20é«˜çº§ç¼–ç¨‹ï¼ˆç½—èƒ½ï¼‰ â€”â€” 1.6 è¿è¡Œæ—¶å¤šæ€&lt;/li>
&lt;li>&lt;a href="https://wiyi.org/polymorphism-in-java.html">æ·±å…¥ç†è§£é¢å‘å¯¹è±¡ä¸­çš„å¤šæ€&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://refactoringguru.cn/design-patterns/visitor/cpp/example">C++ è®¿é—®è€…æ¨¡å¼è®²è§£å’Œä»£ç ç¤ºä¾‹&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>åŠ¨æ‰‹å®žçŽ°std::visit - C++ for the Antiquatedï¼ˆä¹‹äºŒï¼‰</title><link>https://wizmann.top/posts/std-visit-cpp-for-the-antiquated-2/</link><pubDate>Wed, 01 Jan 2025 00:00:00 +0000</pubDate><guid>https://wizmann.top/posts/std-visit-cpp-for-the-antiquated-2/</guid><description>&lt;h2 id="stdvariant-ä¸Ž-stdvisit">std::variant ä¸Ž std::visit &lt;a href="#stdvariant-%e4%b8%8e-stdvisit" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;h3 id="stdvariant">std::variant &lt;a href="#stdvariant" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;p>&lt;code>std::variant&lt;/code> æ˜¯ C++17 å¼•å…¥çš„ç±»åž‹å®‰å…¨çš„è”åˆä½“ï¼ˆtype-safe unionï¼‰ï¼Œå¯ä»¥åœ¨å¤šä¸ªé¢„å®šä¹‰ç±»åž‹ä¸­å­˜å‚¨ä»»æ„ä¸€ä¸ªå€¼ã€‚ä¸Žä¼ ç»Ÿçš„ &lt;code>union&lt;/code> ä¸åŒï¼Œ&lt;code>std::variant&lt;/code> èƒ½å¤Ÿåœ¨è¿è¡Œæ—¶å®‰å…¨åœ°æ£€æŸ¥å½“å‰å­˜å‚¨çš„ç±»åž‹ï¼Œé¿å…æœªå®šä¹‰è¡Œä¸ºã€‚&lt;/p>
&lt;p>å…¶æ ¸å¿ƒç‰¹ç‚¹å¦‚ä¸‹ï¼š&lt;/p>
&lt;ul>
&lt;li>ç±»åž‹å®‰å…¨ï¼šè®¿é—®å€¼æ—¶è¿›è¡Œç±»åž‹æ£€æŸ¥ï¼Œé˜²æ­¢ç±»åž‹é”™è¯¯ã€‚&lt;/li>
&lt;li>å›ºå®šç±»åž‹é›†åˆï¼šå­˜å‚¨ç±»åž‹åœ¨ç¼–è¯‘æ—¶ç¡®å®šã€‚&lt;/li>
&lt;li>å¼‚å¸¸å®‰å…¨ï¼šåœ¨èµ‹å€¼å¤±è´¥æ—¶ä¼šè¿›å…¥æ— æ•ˆçŠ¶æ€ï¼ˆstd::monostateï¼‰ã€‚&lt;/li>
&lt;/ul>
&lt;h3 id="stdvisit">std::visit &lt;a href="#stdvisit" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;p>&lt;code>std::visit&lt;/code> æ˜¯ä¸€ä¸ªè®¿é—®å™¨å‡½æ•°ï¼Œç”¨äºŽè®¿é—® &lt;code>std::variant&lt;/code> ä¸­å½“å‰å­˜å‚¨çš„å€¼ã€‚å®ƒé€šè¿‡ä¸€ä¸ªå¯è°ƒç”¨å¯¹è±¡ï¼ˆå¦‚ Lambda è¡¨è¾¾å¼ï¼‰æ¥å¤„ç†å­˜å‚¨çš„å€¼ï¼Œä»Žè€Œå®žçŽ°ç¼–è¯‘æ—¶å¤šæ€ã€‚&lt;/p>
&lt;p>å…¶æ ¸å¿ƒç‰¹ç‚¹å¦‚ä¸‹ï¼š&lt;/p>
&lt;ul>
&lt;li>ç»Ÿä¸€è®¿é—®æŽ¥å£ï¼šæ— è®ºå­˜å‚¨çš„æ˜¯å“ªç§ç±»åž‹ï¼Œéƒ½å¯ä»¥é€šè¿‡åŒä¸€ä¸ªå‡½æ•°è¿›è¡Œè®¿é—®ã€‚&lt;/li>
&lt;li>ç±»åž‹å®‰å…¨ï¼šç¡®ä¿æ‰€æœ‰å¯èƒ½çš„ç±»åž‹éƒ½è¢«æ­£ç¡®å¤„ç†ã€‚&lt;/li>
&lt;/ul>
&lt;h3 id="ä»£ç ç¤ºä¾‹">ä»£ç ç¤ºä¾‹ &lt;a href="#%e4%bb%a3%e7%a0%81%e7%a4%ba%e4%be%8b" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;iostream&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;vector&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;variant&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;type_traits&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">template&lt;/span>&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">typename&lt;/span> T&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">inline&lt;/span> &lt;span style="color:#66d9ef">constexpr&lt;/span> &lt;span style="color:#66d9ef">bool&lt;/span> always_false_v &lt;span style="color:#f92672">=&lt;/span> false;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">int&lt;/span> &lt;span style="color:#a6e22e">main&lt;/span>() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> std&lt;span style="color:#f92672">::&lt;/span>vector&lt;span style="color:#f92672">&amp;lt;&lt;/span>std&lt;span style="color:#f92672">::&lt;/span>variant&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">int&lt;/span>, &lt;span style="color:#66d9ef">float&lt;/span>, std&lt;span style="color:#f92672">::&lt;/span>string&lt;span style="color:#f92672">&amp;gt;&amp;gt;&lt;/span> items {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">10&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">3.14f&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;foobar&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> };
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">for&lt;/span> (&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">auto&lt;/span>&lt;span style="color:#f92672">&amp;amp;&lt;/span> item : items) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> std&lt;span style="color:#f92672">::&lt;/span>visit([](&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">auto&lt;/span>&lt;span style="color:#f92672">&amp;amp;&lt;/span> arg) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">using&lt;/span> T &lt;span style="color:#f92672">=&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>decay_t&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">decltype&lt;/span>(arg)&lt;span style="color:#f92672">&amp;gt;&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#66d9ef">constexpr&lt;/span> (std&lt;span style="color:#f92672">::&lt;/span>is_same_v&lt;span style="color:#f92672">&amp;lt;&lt;/span>T, &lt;span style="color:#66d9ef">int&lt;/span>&lt;span style="color:#f92672">&amp;gt;&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> std&lt;span style="color:#f92672">::&lt;/span>cout &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#e6db74">&amp;#34;int: &amp;#34;&lt;/span> &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> arg &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>endl;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> } &lt;span style="color:#66d9ef">else&lt;/span> &lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#66d9ef">constexpr&lt;/span> (std&lt;span style="color:#f92672">::&lt;/span>is_same_v&lt;span style="color:#f92672">&amp;lt;&lt;/span>T, &lt;span style="color:#66d9ef">float&lt;/span>&lt;span style="color:#f92672">&amp;gt;&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> std&lt;span style="color:#f92672">::&lt;/span>cout &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#e6db74">&amp;#34;float: &amp;#34;&lt;/span> &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> arg &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>endl;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> } &lt;span style="color:#66d9ef">else&lt;/span> &lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#66d9ef">constexpr&lt;/span> (std&lt;span style="color:#f92672">::&lt;/span>is_same_v&lt;span style="color:#f92672">&amp;lt;&lt;/span>T, std&lt;span style="color:#f92672">::&lt;/span>string&lt;span style="color:#f92672">&amp;gt;&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> std&lt;span style="color:#f92672">::&lt;/span>cout &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#e6db74">&amp;#34;std::string: &amp;#34;&lt;/span> &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> arg &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>endl;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> } &lt;span style="color:#66d9ef">else&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">static_assert&lt;/span>(always_false_v&lt;span style="color:#f92672">&amp;lt;&amp;gt;&lt;/span>, &lt;span style="color:#e6db74">&amp;#34;Unhandled type!&amp;#34;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }, item);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="ä»£ç åˆ†æž">ä»£ç åˆ†æž &lt;a href="#%e4%bb%a3%e7%a0%81%e5%88%86%e6%9e%90" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;ol>
&lt;li>
&lt;p>&lt;strong>&lt;code>std::variant&amp;lt;int, float, std::string&amp;gt;&lt;/code>&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>è¿™æ˜¯ä¸€ä¸ªç±»åž‹å®‰å…¨çš„è”åˆä½“ï¼Œå¯ä»¥å­˜å‚¨ &lt;code>int&lt;/code>ã€&lt;code>float&lt;/code> æˆ– &lt;code>std::string&lt;/code> ä¸­çš„ä»»æ„ä¸€ç§ç±»åž‹ã€‚&lt;/li>
&lt;li>å°†å¤šä¸ª &lt;code>std::variant&lt;/code> å­˜å‚¨åœ¨ &lt;code>std::vector&lt;/code> ä¸­ï¼Œå½¢æˆä¸€ä¸ªç»Ÿä¸€çš„å®¹å™¨ã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>&lt;code>std::visit&lt;/code>&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>ä½¿ç”¨ &lt;code>std::visit&lt;/code> è®¿é—®æ¯ä¸ª &lt;code>std::variant&lt;/code> å…ƒç´ ã€‚&lt;/li>
&lt;li>ä¼ å…¥ä¸€ä¸ª&lt;strong>æ³›åž‹ Lambda è¡¨è¾¾å¼&lt;/strong>ï¼Œé€šè¿‡ &lt;code>if constexpr&lt;/code> åœ¨ç¼–è¯‘æ—¶åˆ†å‘åˆ°ä¸åŒçš„åˆ†æ”¯ï¼Œå¤„ç†ä¸åŒç±»åž‹çš„å€¼ã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>&lt;code>if constexpr&lt;/code> ä¸Ž &lt;code>std::is_same_v&lt;/code>&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>ä½¿ç”¨ &lt;code>std::is_same_v&lt;/code> åˆ¤æ–­å­˜å‚¨çš„å®žé™…ç±»åž‹ã€‚&lt;/li>
&lt;li>æ ¹æ®ç±»åž‹è¿›è¡Œä¸åŒçš„è¾“å‡ºæ“ä½œã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>ç±»åž‹å®‰å…¨&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>å¦‚æžœæ·»åŠ ä¸€ä¸ªæœªå¤„ç†çš„ç±»åž‹ï¼Œç¼–è¯‘å™¨ä¼šåœ¨ &lt;code>static_assert&lt;/code> ä¸­æŠ¥é”™ï¼Œæé†’å¼€å‘è€…è¡¥å……å¤„ç†é€»è¾‘ã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ol>
&lt;h2 id="ä½¿ç”¨ä¼ ç»Ÿcå®žçŽ°stdvisit">ä½¿ç”¨ä¼ ç»ŸC++å®žçŽ°std::visit &lt;a href="#%e4%bd%bf%e7%94%a8%e4%bc%a0%e7%bb%9fc%e5%ae%9e%e7%8e%b0stdvisit" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;h3 id="å®žçŽ°stdvariant">å®žçŽ°std::variant &lt;a href="#%e5%ae%9e%e7%8e%b0stdvariant" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;p>åœ¨ä¼ ç»Ÿ C++ ä¸­ï¼Œæˆ‘ä»¬åªæœ‰ç®€å•çš„ &lt;code>union&lt;/code> æ¥å®žçŽ°â€œè”åˆä½“â€è¯­ä¹‰ã€‚ç„¶è€Œï¼Œ&lt;code>union&lt;/code> å­˜åœ¨ä¸€äº›å±€é™æ€§ï¼š&lt;/p>
&lt;ul>
&lt;li>æ— æ³•å­˜å‚¨éžå¹³å‡¡ç±»åž‹ï¼ˆä¾‹å¦‚ &lt;code>std::string&lt;/code>ï¼‰ã€‚&lt;/li>
&lt;li>æ— æ³•è·Ÿè¸ªå½“å‰å­˜å‚¨çš„ç±»åž‹ã€‚&lt;/li>
&lt;li>æ— æ³•è¿›è¡Œç±»åž‹å®‰å…¨æ£€æŸ¥ã€‚&lt;/li>
&lt;/ul>
&lt;p>è€Œ &lt;code>std::variant&lt;/code> é€šè¿‡ç±»åž‹ç´¢å¼•å’Œç±»åž‹åŒ¹é…æ¥æä¾›ç±»åž‹å®‰å…¨ï¼Œæ”¯æŒå¤šç§ç±»åž‹çš„å­˜å‚¨ä¸Žè®¿é—®ã€‚&lt;/p>
&lt;h3 id="å®žçŽ°-stdvisit">å®žçŽ° std::visit &lt;a href="#%e5%ae%9e%e7%8e%b0-stdvisit" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;p>å®žçŽ° &lt;code>std::visit&lt;/code> éœ€è¦ä½¿ç”¨ä¸€ä¸ªå¯è°ƒç”¨å¯¹è±¡ï¼ˆä¾‹å¦‚ Visitorï¼‰æ¥è®¿é—® &lt;code>std::variant&lt;/code> ä¸­çš„å€¼ã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒåœ¨ç¼–è¯‘æ—¶æ ¹æ®å®žé™…ç±»åž‹åŒ¹é…ç›¸åº”çš„ &lt;code>operator()&lt;/code> æ–¹æ³•ã€‚&lt;/p>
&lt;p>ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;iostream&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;vector&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;variant&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;type_traits&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">struct&lt;/span> &lt;span style="color:#a6e22e">Visitor&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">int&lt;/span> &lt;span style="color:#a6e22e">operator&lt;/span>()(&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span>&lt;span style="color:#f92672">&amp;amp;&lt;/span> item) &lt;span style="color:#66d9ef">const&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> std&lt;span style="color:#f92672">::&lt;/span>cout &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#e6db74">&amp;#34;int: &amp;#34;&lt;/span> &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> item &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>endl;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">int&lt;/span> &lt;span style="color:#a6e22e">operator&lt;/span>()(&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">float&lt;/span>&lt;span style="color:#f92672">&amp;amp;&lt;/span> item) &lt;span style="color:#66d9ef">const&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> std&lt;span style="color:#f92672">::&lt;/span>cout &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#e6db74">&amp;#34;float: &amp;#34;&lt;/span> &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> item &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>endl;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">int&lt;/span> &lt;span style="color:#a6e22e">operator&lt;/span>()(&lt;span style="color:#66d9ef">const&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>string&lt;span style="color:#f92672">&amp;amp;&lt;/span> item) &lt;span style="color:#66d9ef">const&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> std&lt;span style="color:#f92672">::&lt;/span>cout &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#e6db74">&amp;#34;string: &amp;#34;&lt;/span> &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> item &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>endl;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#ae81ff">2&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>};
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">int&lt;/span> &lt;span style="color:#a6e22e">main&lt;/span>() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> std&lt;span style="color:#f92672">::&lt;/span>variant&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">int&lt;/span>, &lt;span style="color:#66d9ef">float&lt;/span>, std&lt;span style="color:#f92672">::&lt;/span>string&lt;span style="color:#f92672">&amp;gt;&lt;/span> item(&lt;span style="color:#ae81ff">114.514f&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// èŽ·å–å½“å‰ç±»åž‹çš„ç´¢å¼•
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>cout &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> item.index() &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>endl; &lt;span style="color:#75715e">// è¾“å‡º: 1 (float çš„ç´¢å¼•)
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// èŽ·å–å½“å‰å­˜å‚¨çš„å€¼
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>cout &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>get&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">float&lt;/span>&lt;span style="color:#f92672">&amp;gt;&lt;/span>(item) &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>endl; &lt;span style="color:#75715e">// è¾“å‡º: 114.514
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">try&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> std&lt;span style="color:#f92672">::&lt;/span>cout &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>get&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">int&lt;/span>&lt;span style="color:#f92672">&amp;gt;&lt;/span>(item) &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>endl;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> } &lt;span style="color:#66d9ef">catch&lt;/span> (&lt;span style="color:#66d9ef">const&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>bad_variant_access&lt;span style="color:#f92672">&amp;amp;&lt;/span> e) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> std&lt;span style="color:#f92672">::&lt;/span>cout &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> e.what() &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>endl; &lt;span style="color:#75715e">// ç±»åž‹ä¸åŒ¹é…ï¼ŒæŠ›å‡ºå¼‚å¸¸
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// ä½¿ç”¨ Visitor è®¿é—®å€¼
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>cout &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>visit(Visitor{}, item) &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>endl; &lt;span style="color:#75715e">// è¾“å‡º: 1 (float ç±»åž‹è¿”å›ž 1)
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="å®žçŽ°çš„æ ¸å¿ƒè¦ç‚¹">å®žçŽ°çš„æ ¸å¿ƒè¦ç‚¹ &lt;a href="#%e5%ae%9e%e7%8e%b0%e7%9a%84%e6%a0%b8%e5%bf%83%e8%a6%81%e7%82%b9" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;p>å®žçŽ° &lt;code>std::visit&lt;/code> çš„å…³é”®åœ¨äºŽä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;strong>ç±»åž‹ç´¢å¼• (&lt;code>index()&lt;/code>)&lt;/strong>&lt;br>
æ ¹æ®ä¼ å…¥çš„ &lt;code>std::variant&lt;/code> å‚æ•°ç±»åž‹ï¼Œç¡®å®šå…¶åœ¨ç±»åž‹é›†åˆä¸­çš„ç´¢å¼•ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>ç±»åž‹è®¿é—® (&lt;code>std::get&amp;lt;T&amp;gt;&lt;/code>)&lt;/strong>&lt;br>
æ ¹æ®ä¼ å…¥çš„æ¨¡æ¿ç±»åž‹ &lt;code>T&lt;/code>ï¼ŒèŽ·å–å­˜å‚¨çš„å€¼ã€‚å¦‚æžœç±»åž‹ä¸åŒ¹é…ï¼ŒæŠ›å‡ºå¼‚å¸¸ï¼Œç¡®ä¿ç±»åž‹å®‰å…¨ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>ç±»åž‹åˆ†æ´¾ (&lt;code>std::visit&lt;/code>)&lt;/strong>&lt;br>
æ ¹æ®å½“å‰å­˜å‚¨çš„ç±»åž‹ï¼Œè°ƒç”¨ &lt;code>Visitor&lt;/code> ä¸­å¯¹åº”çš„ &lt;code>operator()&lt;/code> æ–¹æ³•ã€‚å¯ä»¥é€šè¿‡ &lt;code>switch-case&lt;/code> æˆ–æ¨¡æ¿åŒ¹é…æ¥å®žçŽ°ç±»åž‹åˆ†å‘ã€‚&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h3 id="ä»£ç å®žçŽ°0---åŸºæœ¬æ¡†æž¶">ä»£ç å®žçŽ°0 - åŸºæœ¬æ¡†æž¶ &lt;a href="#%e4%bb%a3%e7%a0%81%e5%ae%9e%e7%8e%b00---%e5%9f%ba%e6%9c%ac%e6%a1%86%e6%9e%b6" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">template&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">typename&lt;/span>... Ts&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">MyVariant&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">public&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">template&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">typename&lt;/span> T&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> MyVariant(&lt;span style="color:#66d9ef">const&lt;/span> T&lt;span style="color:#f92672">&amp;amp;&lt;/span> item) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> setValue(item);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">private&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">template&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">typename&lt;/span> T&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">void&lt;/span> setValue(&lt;span style="color:#66d9ef">const&lt;/span> T&lt;span style="color:#f92672">&amp;amp;&lt;/span> item) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// TODO
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// ç”¨äºŽå­˜å‚¨â€œè”åˆä½“â€çš„æ•°æ®
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">union&lt;/span> &lt;span style="color:#a6e22e">Storage&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Storage() {}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">~&lt;/span>Storage() {}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> std&lt;span style="color:#f92672">::&lt;/span>aligned_union_t&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>, Ts...&lt;span style="color:#f92672">&amp;gt;&lt;/span> data;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> } storage;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>};
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="ä»£ç å®žçŽ°1---indexå‡½æ•°">ä»£ç å®žçŽ°1 - index()å‡½æ•° &lt;a href="#%e4%bb%a3%e7%a0%81%e5%ae%9e%e7%8e%b01---index%e5%87%bd%e6%95%b0" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;p>æˆ‘ä»¬ä½¿ç”¨ç»å…¸çš„æ¨¡æ¿é€’å½’æ¥æŸ¥æ‰¾ç±»åž‹å¯¹åº”çš„ç´¢å¼•ã€‚åŒæ—¶ï¼Œåˆ©ç”¨ &lt;code>constexpr&lt;/code> æ¥ç®€åŒ–ç¼–è¯‘æ—¶è®¡ç®—çš„è¿‡ç¨‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">template&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span>std&lt;span style="color:#f92672">::&lt;/span>size_t N, &lt;span style="color:#66d9ef">typename&lt;/span>... Types&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">using&lt;/span> TupleElement &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">typename&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>tuple_element&lt;span style="color:#f92672">&amp;lt;&lt;/span>N, std&lt;span style="color:#f92672">::&lt;/span>tuple&lt;span style="color:#f92672">&amp;lt;&lt;/span>Types...&lt;span style="color:#f92672">&amp;gt;&amp;gt;::&lt;/span>type;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">template&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">typename&lt;/span> T, &lt;span style="color:#66d9ef">typename&lt;/span>... Types&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">struct&lt;/span> &lt;span style="color:#a6e22e">TypeIndex&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">template&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">typename&lt;/span> T, &lt;span style="color:#66d9ef">typename&lt;/span> First, &lt;span style="color:#66d9ef">typename&lt;/span>... Rest&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">struct&lt;/span> &lt;span style="color:#a6e22e">TypeIndex&lt;/span>&lt;span style="color:#f92672">&amp;lt;&lt;/span>T, First, Rest...&lt;span style="color:#f92672">&amp;gt;&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">constexpr&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> value &lt;span style="color:#f92672">=&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>is_same&lt;span style="color:#f92672">&amp;lt;&lt;/span>T, First&lt;span style="color:#f92672">&amp;gt;::&lt;/span>value
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">?&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">:&lt;/span> (TypeIndex&lt;span style="color:#f92672">&amp;lt;&lt;/span>T, Rest...&lt;span style="color:#f92672">&amp;gt;::&lt;/span>value &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span> &lt;span style="color:#f92672">?&lt;/span> &lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span> &lt;span style="color:#f92672">:&lt;/span> TypeIndex&lt;span style="color:#f92672">&amp;lt;&lt;/span>T, Rest...&lt;span style="color:#f92672">&amp;gt;::&lt;/span>value &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>};
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">template&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">typename&lt;/span> T&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">struct&lt;/span> &lt;span style="color:#a6e22e">TypeIndex&lt;/span>&lt;span style="color:#f92672">&amp;lt;&lt;/span>T&lt;span style="color:#f92672">&amp;gt;&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">constexpr&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> value &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>};
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">template&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">typename&lt;/span> T, &lt;span style="color:#66d9ef">typename&lt;/span>... Ts&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">constexpr&lt;/span> &lt;span style="color:#66d9ef">bool&lt;/span> containsType() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> TypeIndex&lt;span style="color:#f92672">&amp;lt;&lt;/span>T, Ts...&lt;span style="color:#f92672">&amp;gt;::&lt;/span>value &lt;span style="color:#f92672">!=&lt;/span> &lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>é€šè¿‡ä¸Šè¿°ä»£ç ï¼Œæˆ‘ä»¬å®žçŽ°äº†åœ¨ç¼–è¯‘æœŸç¡®å®šä¼ å…¥ç±»åž‹å¯¹åº”çš„ç±»åž‹ç´¢å¼•ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">template&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">typename&lt;/span>... Ts&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">template&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">typename&lt;/span> T&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">void&lt;/span> MyVariant&lt;span style="color:#f92672">&amp;lt;&lt;/span>Ts...&lt;span style="color:#f92672">&amp;gt;::&lt;/span>setValue(&lt;span style="color:#66d9ef">const&lt;/span> T&lt;span style="color:#f92672">&amp;amp;&lt;/span> item) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">using&lt;/span> TargetType &lt;span style="color:#f92672">=&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>decay_t&lt;span style="color:#f92672">&amp;lt;&lt;/span>T&lt;span style="color:#f92672">&amp;gt;&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">static_assert&lt;/span>(containsType&lt;span style="color:#f92672">&amp;lt;&lt;/span>TargetType&lt;span style="color:#f92672">&amp;gt;&lt;/span>(), &lt;span style="color:#e6db74">&amp;#34;Type not supported&amp;#34;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">new&lt;/span> (&lt;span style="color:#f92672">&amp;amp;&lt;/span>storage.data) TargetType(item);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> typeIndex &lt;span style="color:#f92672">=&lt;/span> getTypeIndex&lt;span style="color:#f92672">&amp;lt;&lt;/span>TargetType&lt;span style="color:#f92672">&amp;gt;&lt;/span>();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="ä»£ç å®žçŽ°2---get-å‡½æ•°">ä»£ç å®žçŽ°2 - &lt;code>get()&lt;/code> å‡½æ•° &lt;a href="#%e4%bb%a3%e7%a0%81%e5%ae%9e%e7%8e%b02---get-%e5%87%bd%e6%95%b0" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;p>æˆ‘ä»¬å®žçŽ°äº†ä¸€ä¸ªå‡½æ•° &lt;code>MyVariant::get()&lt;/code>ï¼Œé€šè¿‡æ£€æŸ¥ &lt;code>typeIndex&lt;/code> æ¥ç¡®ä¿èŽ·å–çš„ç±»åž‹ä¸Žå­˜å‚¨ç±»åž‹ä¸€è‡´ã€‚&lt;/p>
&lt;p>æˆ‘ä»¬ä¹Ÿèƒ½å¯ä»¥é€šè¿‡&lt;code>MyGet&lt;/code>å‡½æ•°æ¨¡æ‹Ÿ&lt;code>std::get&amp;lt;T&amp;gt;&lt;/code>å‡½æ•°çš„è¡Œä¸ºã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">template&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">typename&lt;/span>... Ts&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">MyVariant&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">template&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">typename&lt;/span> T, &lt;span style="color:#66d9ef">typename&lt;/span>... Ts&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>T&lt;span style="color:#f92672">&amp;amp;&lt;/span> MyGet(MyVariant&lt;span style="color:#f92672">&amp;lt;&lt;/span>Ts...&lt;span style="color:#f92672">&amp;gt;&amp;amp;&lt;/span> var) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> var.&lt;span style="color:#66d9ef">template&lt;/span> get&lt;span style="color:#f92672">&amp;lt;&lt;/span>T&lt;span style="color:#f92672">&amp;gt;&lt;/span>();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">template&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">typename&lt;/span>... Ts&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">template&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">typename&lt;/span> T&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>T&lt;span style="color:#f92672">&amp;amp;&lt;/span> MyVariant&lt;span style="color:#f92672">&amp;lt;&lt;/span>Ts...&lt;span style="color:#f92672">&amp;gt;::&lt;/span>get() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">using&lt;/span> TargetType &lt;span style="color:#f92672">=&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>decay_t&lt;span style="color:#f92672">&amp;lt;&lt;/span>T&lt;span style="color:#f92672">&amp;gt;&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (TypeIndex&lt;span style="color:#f92672">&amp;lt;&lt;/span>T, Ts...&lt;span style="color:#f92672">&amp;gt;::&lt;/span>value &lt;span style="color:#f92672">!=&lt;/span> typeIndex) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">throw&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>runtime_error(&lt;span style="color:#e6db74">&amp;#34;Wrong type&amp;#34;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#66d9ef">reinterpret_cast&lt;/span>&lt;span style="color:#f92672">&amp;lt;&lt;/span>TargetType&lt;span style="color:#f92672">*&amp;gt;&lt;/span>(&lt;span style="color:#f92672">&amp;amp;&lt;/span>storage.data);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="ä»£ç å®žçŽ°3---visitå‡½æ•°">ä»£ç å®žçŽ°3 - &lt;code>visit&lt;/code>å‡½æ•° &lt;a href="#%e4%bb%a3%e7%a0%81%e5%ae%9e%e7%8e%b03---visit%e5%87%bd%e6%95%b0" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;p>æŽ¥ä¸‹æ¥æ˜¯ &lt;code>visit()&lt;/code> å‡½æ•°çš„å®žçŽ°ã€‚å®ƒé€šè¿‡é€’å½’æ–¹å¼ä¾æ¬¡è®¿é—® &lt;code>std::variant&lt;/code> ä¸­çš„æ¯ç§ç±»åž‹ï¼Œå¹¶è°ƒç”¨ä¸Žä¹‹å¯¹åº”çš„å¤„ç†å‡½æ•°ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">template&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span>std&lt;span style="color:#f92672">::&lt;/span>size_t N, &lt;span style="color:#66d9ef">typename&lt;/span>... Types&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">using&lt;/span> TupleElement &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">typename&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>tuple_element&lt;span style="color:#f92672">&amp;lt;&lt;/span>N, std&lt;span style="color:#f92672">::&lt;/span>tuple&lt;span style="color:#f92672">&amp;lt;&lt;/span>Types...&lt;span style="color:#f92672">&amp;gt;&amp;gt;::&lt;/span>type;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">template&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">typename&lt;/span>... Ts&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">template&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">typename&lt;/span> TVisitor&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">auto&lt;/span> MyVariant&lt;span style="color:#f92672">&amp;lt;&lt;/span>Ts...&lt;span style="color:#f92672">&amp;gt;::&lt;/span>visit(TVisitor&lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span> visitor) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">using&lt;/span> FirstType &lt;span style="color:#f92672">=&lt;/span> TupleElement&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>, Ts...&lt;span style="color:#f92672">&amp;gt;&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">using&lt;/span> RetT &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">decltype&lt;/span>(visitor(std&lt;span style="color:#f92672">::&lt;/span>declval&lt;span style="color:#f92672">&amp;lt;&lt;/span>FirstType&lt;span style="color:#f92672">&amp;gt;&lt;/span>()));
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> visitImpl&lt;span style="color:#f92672">&amp;lt;&lt;/span>RetT, TVisitor, Ts...&lt;span style="color:#f92672">&amp;gt;&lt;/span>(std&lt;span style="color:#f92672">::&lt;/span>forward&lt;span style="color:#f92672">&amp;lt;&lt;/span>TVisitor&lt;span style="color:#f92672">&amp;gt;&lt;/span>(visitor));
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">template&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">typename&lt;/span>... Ts&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">template&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">typename&lt;/span> RetT, &lt;span style="color:#66d9ef">typename&lt;/span> TVisitor, &lt;span style="color:#66d9ef">typename&lt;/span> First, &lt;span style="color:#66d9ef">typename&lt;/span>... Rest&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>RetT MyVariant&lt;span style="color:#f92672">&amp;lt;&lt;/span>Ts...&lt;span style="color:#f92672">&amp;gt;::&lt;/span>visitImpl(TVisitor&lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span> visitor) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (getTypeIndex&lt;span style="color:#f92672">&amp;lt;&lt;/span>First&lt;span style="color:#f92672">&amp;gt;&lt;/span>() &lt;span style="color:#f92672">==&lt;/span> typeIndex) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#a6e22e">visitor&lt;/span>(get&lt;span style="color:#f92672">&amp;lt;&lt;/span>First&lt;span style="color:#f92672">&amp;gt;&lt;/span>());
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> } &lt;span style="color:#66d9ef">else&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// é€’å½’è®¿é—®å‰©ä½™çš„ç±»åž‹
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">return&lt;/span> visitImpl&lt;span style="color:#f92672">&amp;lt;&lt;/span>RetT, TVisitor, Rest...&lt;span style="color:#f92672">&amp;gt;&lt;/span>(std&lt;span style="color:#f92672">::&lt;/span>forward&lt;span style="color:#f92672">&amp;lt;&lt;/span>TVisitor&lt;span style="color:#f92672">&amp;gt;&lt;/span>(visitor));
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">template&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">typename&lt;/span>... Ts&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">template&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">typename&lt;/span> RetT, &lt;span style="color:#66d9ef">typename&lt;/span> TVisitor&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>RetT MyVariant&lt;span style="color:#f92672">&amp;lt;&lt;/span>Ts...&lt;span style="color:#f92672">&amp;gt;::&lt;/span>visitImpl(&lt;span style="color:#a6e22e">[[maybe_unused]]&lt;/span>TVisitor&lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span> visitor) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// åŸºç¡€æƒ…å†µï¼šæ‰€æœ‰ç±»åž‹éƒ½å·²æ£€æŸ¥ï¼Œæœªæ‰¾åˆ°åŒ¹é…çš„ç±»åž‹
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">throw&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>runtime_error(&lt;span style="color:#e6db74">&amp;#34;Wrong type&amp;#34;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="æ€»ç»“">æ€»ç»“ &lt;a href="#%e6%80%bb%e7%bb%93" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;p>åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å®žçŽ°äº†ä¸€ä¸ªç®€å•ç‰ˆçš„ &lt;code>std::variant&lt;/code> å’Œ &lt;code>std::visit&lt;/code>ï¼Œé€šè¿‡ä¼ ç»Ÿ C++ å®žçŽ°äº†ç±»åž‹å®‰å…¨çš„è”åˆä½“æ•°æ®ç»“æž„ã€‚æˆ‘ä»¬ä¾æ¬¡é€šè¿‡ä»¥ä¸‹æ­¥éª¤æž„å»ºäº†è¿™ä¸€ç³»ç»Ÿï¼š&lt;/p>
&lt;ol>
&lt;li>
&lt;p>&lt;strong>&lt;code>MyVariant&lt;/code> ç±»çš„åŸºæœ¬æ¡†æž¶&lt;/strong>ï¼šé€šè¿‡è”åˆä½“ (&lt;code>union&lt;/code>) å­˜å‚¨ä¸åŒç±»åž‹çš„æ•°æ®ï¼Œå¹¶ä½¿ç”¨æ¨¡æ¿æž„é€ å‡½æ•°åŠ¨æ€è®¾ç½®å€¼ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>ç±»åž‹ç´¢å¼• (&lt;code>index()&lt;/code>) çš„å®žçŽ°&lt;/strong>ï¼šä½¿ç”¨æ¨¡æ¿é€’å½’æŠ€æœ¯ç»“åˆ &lt;code>constexpr&lt;/code> æ¥å®žçŽ°ç±»åž‹çš„ç¼–è¯‘æ—¶ç´¢å¼•æŸ¥æ‰¾ï¼Œä»Žè€Œåœ¨è¿è¡Œæ—¶æ ¹æ®ç±»åž‹ç´¢å¼•æ¥è®¿é—®å¯¹åº”çš„å€¼ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>&lt;code>get()&lt;/code> å‡½æ•°&lt;/strong>ï¼šå®žçŽ°äº†èŽ·å–å­˜å‚¨å€¼çš„å‡½æ•°ï¼Œå¹¶é€šè¿‡ç±»åž‹æ£€æŸ¥ç¡®ä¿ç±»åž‹å®‰å…¨ã€‚å¦‚æžœè®¿é—®äº†é”™è¯¯ç±»åž‹çš„æ•°æ®ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>&lt;code>visit()&lt;/code> å‡½æ•°&lt;/strong>ï¼šå®žçŽ°äº†ä¸€ä¸ªå¯æ‰©å±•çš„è®¿é—®æœºåˆ¶ï¼Œä½¿å¾—ä¸åŒç±»åž‹çš„å€¼å¯ä»¥é€šè¿‡åŒä¸€ä¸ª &lt;code>Visitor&lt;/code> è¢«è®¿é—®å’Œå¤„ç†ã€‚é€šè¿‡é€’å½’çš„æ–¹å¼ï¼Œç³»ç»Ÿèƒ½å¤ŸåŠ¨æ€åœ°è®¿é—®ä¸åŒç±»åž‹çš„å€¼ï¼Œå¹¶è°ƒç”¨ç›¸åº”çš„å¤„ç†å‡½æ•°ã€‚&lt;/p>
&lt;/li>
&lt;/ol>
&lt;p>é€šè¿‡è¿™äº›å®žçŽ°ï¼Œæˆ‘ä»¬æˆåŠŸæ¨¡æ‹Ÿäº† C++ æ ‡å‡†åº“ä¸­çš„ &lt;code>std::variant&lt;/code> å’Œ &lt;code>std::visit&lt;/code> åŠŸèƒ½ã€‚åŒæ—¶ï¼Œé€šè¿‡å¯¹æ¯”å¯ä»¥çœ‹å‡ºï¼ŒçŽ°ä»£ C++ æä¾›äº†æ›´å¼ºå¤§çš„æ¨¡æ¿å…ƒç¼–ç¨‹èƒ½åŠ›ã€‚åˆ©ç”¨è¿™äº›ç‰¹æ€§ï¼Œæˆ‘ä»¬èƒ½å¤Ÿä½¿ç”¨æ›´ç›´è§‚çš„è¯­æ³•ï¼Œåœ¨ç¼–è¯‘æœŸé—´å®žçŽ°é«˜æ•ˆä¸”ç±»åž‹å®‰å…¨çš„è”åˆä½“è®¿é—®ï¼Œä»Žè€Œæä¾›ä¸€ç§çµæ´»ã€ç±»åž‹å®‰å…¨çš„æ–¹å¼æ¥å¤„ç†å¤šç±»åž‹æ•°æ®ã€‚&lt;/p></description></item><item><title>constexprè¯¦è§£ - C++ for the Antiquatedï¼ˆä¹‹ä¸€ï¼‰</title><link>https://wizmann.top/posts/constexpr-cpp-for-the-antiquated-1/</link><pubDate>Sat, 28 Dec 2024 00:00:00 +0000</pubDate><guid>https://wizmann.top/posts/constexpr-cpp-for-the-antiquated-1/</guid><description>&lt;p>åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†æ·±å…¥è®¨è®º C++ ä¸­çš„å¸¸é‡è¡¨è¾¾å¼ï¼ˆ&lt;code>constexpr&lt;/code>ï¼‰åŠå…¶ä¸Žä¼ ç»Ÿçš„&lt;code>const&lt;/code>å¸¸é‡çš„åŒºåˆ«ï¼Œå¹¶ç»“åˆå®žé™…ä»£ç ç¤ºä¾‹è¿›è¡Œè¯´æ˜Žã€‚åŒæ—¶ï¼Œæˆ‘ä»¬è¿˜ä¼šæŽ¢è®¨&lt;code>constexpr&lt;/code>å‡½æ•°åœ¨æ¨¡æ¿ç¼–ç¨‹ä¸­çš„åº”ç”¨ï¼Œä»¥åŠ C++11 ä¹‹åŽå¯¹å¸¸é‡è¡¨è¾¾å¼çš„ä¼˜åŒ–ä¸Žæ‰©å±•ã€‚&lt;/p>
&lt;h2 id="å¸¸é‡è¡¨è¾¾å¼constexpr">å¸¸é‡è¡¨è¾¾å¼ï¼ˆconstexprï¼‰ &lt;a href="#%e5%b8%b8%e9%87%8f%e8%a1%a8%e8%be%be%e5%bc%8fconstexpr" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;p>åœ¨ C++ ä¸­ï¼Œ&lt;code>const&lt;/code> å…³é”®å­—é€šå¸¸ç”¨äºŽä¿®é¥°å˜é‡ã€å¼•ç”¨å’ŒæŒ‡é’ˆï¼Œä½¿å¾—å®ƒä»¬åœ¨è¿è¡Œæ—¶ä¸èƒ½è¢«ä¿®æ”¹ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ&lt;code>const&lt;/code> å¹¶æ²¡æœ‰åŒºåˆ†ç¼–è¯‘æœŸå¸¸é‡å’Œè¿è¡Œæ—¶å¸¸é‡ï¼Œå®ƒåªæ˜¯ä¿è¯äº†è¿™äº›å˜é‡åœ¨è¿è¡Œæ—¶ä¸å¯ä¿®æ”¹ã€‚&lt;/p>
&lt;p>ä¾‹å¦‚ï¼Œä½¿ç”¨ &lt;code>const&lt;/code> å£°æ˜Žçš„å˜é‡åœ¨è¿è¡Œæ—¶å…¶å€¼æ˜¯å›ºå®šçš„ï¼Œä½†å¹¶ä¸æ„å‘³ç€å®ƒä»¬åœ¨ç¼–è¯‘æ—¶å·²çŸ¥ã€‚&lt;/p>
&lt;p>ä¸‹é¢æ˜¯ä¼ ç»Ÿ C++ ä¸­ &lt;code>const&lt;/code> å…³é”®å­—çš„ä¸€äº›å¸¸è§ç”¨æ³•ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#define CONSTANT_1 114514 &lt;/span>&lt;span style="color:#75715e">// å®ä¹Ÿæ˜¯ä¸€ç§å¸¸é‡
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">char&lt;/span>&lt;span style="color:#f92672">*&lt;/span> helloworld1 &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#e6db74">&amp;#34;helloworld&amp;#34;&lt;/span>; &lt;span style="color:#75715e">// const å­—ç¬¦ä¸²
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> value1 &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>; &lt;span style="color:#75715e">// å¸¸é‡å€¼
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> value2 &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">2&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> value3 &lt;span style="color:#f92672">=&lt;/span> value1 &lt;span style="color:#f92672">+&lt;/span> value2; &lt;span style="color:#75715e">// è¿è¡Œæ—¶è®¡ç®—
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> value8 &lt;span style="color:#f92672">=&lt;/span> pow(value2, value3);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> arr_pow_of_2[] &lt;span style="color:#f92672">=&lt;/span> {&lt;span style="color:#ae81ff">1&lt;/span>, &lt;span style="color:#ae81ff">2&lt;/span>, &lt;span style="color:#ae81ff">4&lt;/span>}; &lt;span style="color:#75715e">// æ•°ç»„åˆå§‹åŒ–
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>åœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œè™½ç„¶ const ä¿®é¥°çš„å˜é‡åœ¨ç¨‹åºè¿è¡ŒæœŸé—´ä¸èƒ½ä¿®æ”¹ï¼Œä½†å®ƒä»¬çš„å€¼æ˜¯åœ¨è¿è¡Œæ—¶è®¡ç®—çš„ã€‚å› æ­¤ï¼Œæˆ‘ä»¬æ— æ³•åœ¨ç¼–è¯‘æ—¶å°†å®ƒä»¬è§†ä¸ºå¸¸é‡ã€‚æ‰€ä»¥ï¼Œ&lt;code>const&lt;/code> å˜é‡ä¹Ÿå¯ä»¥æœ‰å†…å­˜åœ°å€ï¼Œå¹¶ä¸”åœ¨æŸäº›æƒ…å†µä¸‹å¯ä»¥ä½¿ç”¨ &lt;code>const_cast&lt;/code> å¼ºè¡Œè¿›è¡Œä¿®æ”¹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;cstdio&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;cstdint&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;iostream&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;cmath&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">MakeChange&lt;/span>(&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span>&lt;span style="color:#f92672">&amp;amp;&lt;/span> x) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">*&lt;/span>(&lt;span style="color:#66d9ef">const_cast&lt;/span>&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">int&lt;/span>&lt;span style="color:#f92672">*&amp;gt;&lt;/span>(&lt;span style="color:#f92672">&amp;amp;&lt;/span>x)) &lt;span style="color:#f92672">=&lt;/span> x &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">int&lt;/span> &lt;span style="color:#a6e22e">main&lt;/span>() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">int&lt;/span> x &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> MakeChange(x);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> std&lt;span style="color:#f92672">::&lt;/span>cout &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> x &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>endl; &lt;span style="color:#75715e">// è¾“å‡ºï¼š2
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="å¼•å…¥-constexpr">å¼•å…¥ constexpr &lt;a href="#%e5%bc%95%e5%85%a5-constexpr" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;p>C++11 å¼•å…¥äº† &lt;code>constexpr&lt;/code>ï¼Œå®ƒçš„å­—é¢æ„æ€æ˜¯ &lt;code>constant expression&lt;/code>ï¼ˆå¸¸é‡è¡¨è¾¾å¼ï¼‰ï¼Œç”¨äºŽåœ¨ç¼–è¯‘æ—¶è®¡ç®—å¸¸é‡å€¼ã€‚ä¸Ž &lt;code>const&lt;/code> ä¸åŒï¼Œ&lt;code>constexpr&lt;/code> ç¡®ä¿ä¸€ä¸ªå˜é‡æˆ–è€…å‡½æ•°çš„å€¼æ˜¯åœ¨ç¼–è¯‘æ—¶å·²çŸ¥çš„ï¼Œç¼–è¯‘å™¨ä¼šåœ¨ç¼–è¯‘æ—¶å¯¹å…¶è¿›è¡Œæ±‚å€¼ã€‚&lt;/p>
&lt;p>é€šè¿‡ä½¿ç”¨ &lt;code>constexpr&lt;/code>ï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰ç¼–è¯‘æ—¶å¸¸é‡ï¼Œå¹¶ä¸” &lt;code>constexpr&lt;/code> å‡½æ•°åœ¨æŸäº›æƒ…å†µä¸‹ä¹Ÿèƒ½å¤Ÿåœ¨ç¼–è¯‘æœŸè®¡ç®—ç»“æžœã€‚&lt;/p>
&lt;p>ä½¿ç”¨ &lt;code>constexpr&lt;/code> é‡å†™ä¸Šè¿°ä»£ç ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">constexpr&lt;/span> &lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">char&lt;/span>&lt;span style="color:#f92672">*&lt;/span> helloworld1 &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#e6db74">&amp;#34;helloworld&amp;#34;&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">constexpr&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> value1 &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">constexpr&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> value2 &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">2&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">constexpr&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> value3 &lt;span style="color:#f92672">=&lt;/span> value1 &lt;span style="color:#f92672">+&lt;/span> value2; &lt;span style="color:#75715e">// ç¼–è¯‘æœŸè®¡ç®—
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">constexpr&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> value8 &lt;span style="color:#f92672">=&lt;/span> pow(value2, value3); &lt;span style="color:#75715e">// ç¼–è¯‘æœŸè®¡ç®—
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// ç¼–è¯‘æœŸåˆå§‹åŒ–æ•°ç»„
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">constexpr&lt;/span> &lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> arr_pow_of_2[] &lt;span style="color:#f92672">=&lt;/span> {&lt;span style="color:#ae81ff">1&lt;/span>, &lt;span style="color:#ae81ff">2&lt;/span>, &lt;span style="color:#ae81ff">4&lt;/span>};
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="å¸¸é‡è¡¨è¾¾å¼å‡½æ•°">å¸¸é‡è¡¨è¾¾å¼å‡½æ•° &lt;a href="#%e5%b8%b8%e9%87%8f%e8%a1%a8%e8%be%be%e5%bc%8f%e5%87%bd%e6%95%b0" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;p>&lt;code>constexpr&lt;/code> ä¸ä»…å¯ä»¥ä¿®é¥°å˜é‡ï¼Œè¿˜å¯ä»¥ä¿®é¥°å‡½æ•°ã€‚&lt;code>constexpr&lt;/code> å‡½æ•°çš„ç‰¹æ€§æ˜¯ï¼Œè‹¥è¾“å…¥çš„å‚æ•°æ˜¯ç¼–è¯‘æ—¶å¸¸é‡ï¼Œé‚£ä¹ˆå®ƒçš„è¿”å›žå€¼ä¹Ÿæ˜¯ä¸€ä¸ªç¼–è¯‘æ—¶å¸¸é‡ã€‚&lt;/p>
&lt;p>ä»¥ä¸‹æ˜¯ä¸€ä¸ªè®¡ç®— Fibonacci æ•°åˆ—çš„ç¤ºä¾‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">constexpr&lt;/span> &lt;span style="color:#66d9ef">uint64_t&lt;/span> MOD &lt;span style="color:#f92672">=&lt;/span> (&lt;span style="color:#ae81ff">1LL&lt;/span> &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#ae81ff">62&lt;/span>) &lt;span style="color:#f92672">-&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>; &lt;span style="color:#75715e">// ç¼–è¯‘æ—¶å¸¸é‡
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">constexpr&lt;/span> &lt;span style="color:#66d9ef">uint64_t&lt;/span> &lt;span style="color:#a6e22e">fib&lt;/span>(&lt;span style="color:#66d9ef">uint64_t&lt;/span> n) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">uint64_t&lt;/span> a &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>, b &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">for&lt;/span> (&lt;span style="color:#66d9ef">int&lt;/span> i &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>; i &lt;span style="color:#f92672">&amp;lt;&lt;/span> n; &lt;span style="color:#f92672">++&lt;/span>i) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">uint64_t&lt;/span> temp &lt;span style="color:#f92672">=&lt;/span> a &lt;span style="color:#f92672">+&lt;/span> b;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> a &lt;span style="color:#f92672">=&lt;/span> b;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> b &lt;span style="color:#f92672">=&lt;/span> temp &lt;span style="color:#f92672">%&lt;/span> MOD;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> b;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">int&lt;/span> &lt;span style="color:#a6e22e">main&lt;/span>() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// åœ¨ç¼–è¯‘æœŸè®¡ç®— Fibonacci æ•°åˆ—
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">constexpr&lt;/span> &lt;span style="color:#66d9ef">uint64_t&lt;/span> result &lt;span style="color:#f92672">=&lt;/span> fib(&lt;span style="color:#ae81ff">123456&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> std&lt;span style="color:#f92672">::&lt;/span>cout &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> result &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>endl;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>åœ¨è¿™æ®µä»£ç ä¸­ï¼Œ&lt;code>fib&lt;/code> å‡½æ•°è¢«æ ‡è®°ä¸º &lt;code>constexpr&lt;/code>ï¼Œå› æ­¤å½“ä¼ å…¥å¸¸é‡å‚æ•°æ—¶ï¼Œç¼–è¯‘å™¨ä¼šåœ¨ç¼–è¯‘æœŸé—´è®¡ç®—å‡º Fibonacci æ•°åˆ—çš„ç¬¬ &lt;code>123456&lt;/code> é¡¹ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ&lt;code>constexpr&lt;/code> å‡½æ•°çš„è®¡ç®—å­˜åœ¨ä¸€äº›é™åˆ¶ï¼š&lt;/p>
&lt;ol>
&lt;li>&lt;strong>é€’å½’æ·±åº¦é™åˆ¶&lt;/strong>ï¼šconstexpr å‡½æ•°çš„é€’å½’æ·±åº¦é€šå¸¸å—åˆ°ç¼–è¯‘å™¨çš„é™åˆ¶ï¼Œå¦‚æžœé€’å½’è¿‡æ·±ï¼Œç¼–è¯‘å™¨å¯èƒ½ä¼šäº§ç”Ÿé”™è¯¯æˆ–è­¦å‘Šã€‚&lt;/li>
&lt;li>&lt;strong>è®¡ç®—æ•ˆçŽ‡&lt;/strong>ï¼šå°½ç®¡å¸¸é‡è¡¨è¾¾å¼å‡½æ•°å¯ä»¥åœ¨ç¼–è¯‘æœŸè®¡ç®—ï¼Œä½†å¯¹äºŽå¤æ‚çš„è¿ç®—ï¼Œå¯èƒ½ä¼šå¢žåŠ ç¼–è¯‘æ—¶é—´ï¼Œå› ä¸ºç¼–è¯‘å™¨éœ€è¦è¿›è¡Œæ›´å¤šçš„è®¡ç®—ã€‚&lt;/li>
&lt;/ol>
&lt;h3 id="constexpr-vs-æ¨¡æ¿å…ƒç¼–ç¨‹">constexpr vs æ¨¡æ¿å…ƒç¼–ç¨‹ &lt;a href="#constexpr-vs-%e6%a8%a1%e6%9d%bf%e5%85%83%e7%bc%96%e7%a8%8b" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;p>&lt;code>constexpr&lt;/code> å‡½æ•°çš„ä½¿ç”¨åœ¨æŸç§ç¨‹åº¦ä¸Šç®€åŒ–äº†æ¨¡æ¿å…ƒç¼–ç¨‹ã€‚ä¼ ç»Ÿçš„æ¨¡æ¿å…ƒç¼–ç¨‹å¯ä»¥å®žçŽ°ä¸Ž &lt;code>constexpr&lt;/code> ç±»ä¼¼çš„åŠŸèƒ½ï¼Œä½†ä»£ç ç»“æž„é€šå¸¸æ›´åŠ å¤æ‚ã€‚ä¸‹é¢æ˜¯ä½¿ç”¨æ¨¡æ¿å…ƒç¼–ç¨‹è®¡ç®— Fibonacci æ•°åˆ—çš„ä»£ç ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">uint64_t&lt;/span> MOD &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">1999&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">template&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">uint64_t&lt;/span> N&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">struct&lt;/span> &lt;span style="color:#a6e22e">Fibonacci&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">uint64_t&lt;/span> value &lt;span style="color:#f92672">=&lt;/span> (Fibonacci&lt;span style="color:#f92672">&amp;lt;&lt;/span>N &lt;span style="color:#f92672">-&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#f92672">&amp;gt;::&lt;/span>value &lt;span style="color:#f92672">+&lt;/span> Fibonacci&lt;span style="color:#f92672">&amp;lt;&lt;/span>N &lt;span style="color:#f92672">-&lt;/span> &lt;span style="color:#ae81ff">2&lt;/span>&lt;span style="color:#f92672">&amp;gt;::&lt;/span>value) &lt;span style="color:#f92672">%&lt;/span> MOD;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>};
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">template&lt;/span> &lt;span style="color:#f92672">&amp;lt;&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">struct&lt;/span> &lt;span style="color:#a6e22e">Fibonacci&lt;/span>&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#f92672">&amp;gt;&lt;/span> { &lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">uint64_t&lt;/span> value &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>; };
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">template&lt;/span> &lt;span style="color:#f92672">&amp;lt;&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">struct&lt;/span> &lt;span style="color:#a6e22e">Fibonacci&lt;/span>&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#f92672">&amp;gt;&lt;/span> { &lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">uint64_t&lt;/span> value &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>; };
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">int&lt;/span> &lt;span style="color:#a6e22e">main&lt;/span>() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> std&lt;span style="color:#f92672">::&lt;/span>cout &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#e6db74">&amp;#34;Fibonacci(40): &amp;#34;&lt;/span> &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> Fibonacci&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#ae81ff">40&lt;/span>&lt;span style="color:#f92672">&amp;gt;::&lt;/span>value &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>endl;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>åœ¨è¿™ä¸ªæ¨¡æ¿å…ƒç¼–ç¨‹ç¤ºä¾‹ä¸­ï¼ŒFibonacci ç»“æž„ä½“ä½¿ç”¨é€’å½’æ¨¡æ¿è®¡ç®— Fibonacci æ•°åˆ—çš„ç¬¬ N é¡¹ã€‚è¿™ä¸Ž &lt;code>constexpr&lt;/code> å‡½æ•°ç±»ä¼¼ï¼Œä½†æ¨¡æ¿å…ƒç¼–ç¨‹çš„è¯­æ³•æ›´åŠ ç¹çã€‚&lt;code>constexpr&lt;/code> çš„ä¼˜åŠ¿åœ¨äºŽå®ƒèƒ½å¤Ÿå†™å‡ºæ›´åŠ æŽ¥è¿‘æ­£å¸¸é€»è¾‘ä»£ç çš„å½¢å¼ï¼Œå¹¶ä¸”å…·æœ‰æ›´å¼ºçš„è¡¨è¾¾èƒ½åŠ›&lt;/p>
&lt;h3 id="c14-å¯¹å¸¸é‡è¡¨è¾¾å¼å‡½æ•°çš„å¢žå¼º">C++14 å¯¹å¸¸é‡è¡¨è¾¾å¼å‡½æ•°çš„å¢žå¼º &lt;a href="#c14-%e5%af%b9%e5%b8%b8%e9%87%8f%e8%a1%a8%e8%be%be%e5%bc%8f%e5%87%bd%e6%95%b0%e7%9a%84%e5%a2%9e%e5%bc%ba" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;p>åœ¨ C++14 ä¸­ï¼Œå¸¸é‡è¡¨è¾¾å¼å‡½æ•°å¾—åˆ°äº†è¿›ä¸€æ­¥çš„å¢žå¼ºã€‚å…·ä½“å¢žå¼ºåŒ…æ‹¬ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;strong>æ”¯æŒå±€éƒ¨å˜é‡&lt;/strong>ï¼š&lt;code>constexpr&lt;/code> å‡½æ•°å¯ä»¥å£°æ˜Žå’Œåˆå§‹åŒ–å±€éƒ¨å˜é‡ï¼Œä½†ä¸èƒ½å£°æ˜Žæœªåˆå§‹åŒ–çš„å˜é‡ã€&lt;code>static&lt;/code> æˆ– &lt;code>thread_local&lt;/code> å˜é‡ã€‚&lt;/li>
&lt;li>&lt;strong>æ”¯æŒ if å’Œ switch è¯­å¥&lt;/strong>ï¼š&lt;code>constexpr&lt;/code> å‡½æ•°å¯ä»¥ä½¿ç”¨ &lt;code>if&lt;/code> å’Œ &lt;code>switch&lt;/code> è¯­å¥æ¥æŽ§åˆ¶æµç¨‹ï¼Œä½†ä¸èƒ½ä½¿ç”¨ &lt;code>got&lt;/code>oã€‚&lt;/li>
&lt;li>&lt;strong>æ”¯æŒå¾ªçŽ¯è¯­å¥&lt;/strong>ï¼š&lt;code>constexpr&lt;/code> å‡½æ•°æ”¯æŒæ‰€æœ‰ç±»åž‹çš„å¾ªçŽ¯è¯­å¥ï¼ŒåŒ…æ‹¬ &lt;code>for&lt;/code>ã€&lt;code>while&lt;/code> å’Œ &lt;code>do-while&lt;/code>ã€‚&lt;/li>
&lt;li>&lt;strong>ä¿®æ”¹ç”Ÿå‘½å‘¨æœŸ&lt;/strong>ï¼šåœ¨ constexpr å‡½æ•°å†…éƒ¨ï¼Œå¯ä»¥ä¿®æ”¹å±€éƒ¨å˜é‡å’Œéžå¸¸é‡å¼•ç”¨å‚æ•°&lt;/li>
&lt;li>&lt;strong>è¿”å›žå€¼å¯ä»¥æ˜¯ void&lt;/strong>ï¼š&lt;code>constexpr&lt;/code> å‡½æ•°å¯ä»¥å£°æ˜Žè¿”å›žç±»åž‹ä¸º &lt;code>void&lt;/code>ã€‚&lt;/li>
&lt;/ul>
&lt;h2 id="å¸¸é‡è¡¨è¾¾å¼ä¸Žæ¨¡æ¿å‡½æ•°">å¸¸é‡è¡¨è¾¾å¼ä¸Žæ¨¡æ¿å‡½æ•° &lt;a href="#%e5%b8%b8%e9%87%8f%e8%a1%a8%e8%be%be%e5%bc%8f%e4%b8%8e%e6%a8%a1%e6%9d%bf%e5%87%bd%e6%95%b0" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;p>åœ¨ C++11 å¼•å…¥ &lt;code>constexpr&lt;/code> åŽï¼Œå»ºè®®åœ¨æ‰€æœ‰éœ€è¦å¸¸é‡è¯­ä¹‰çš„åœºæ™¯ä¸­ä½¿ç”¨ &lt;code>constexpr&lt;/code>ã€‚&lt;code>constexpr&lt;/code> å˜é‡å’Œå‡½æ•°ä½œä¸ºç¼–è¯‘æ—¶å¸¸é‡ï¼Œåœ¨æ¨¡æ¿å‡½æ•°ä¸­å…·æœ‰å¹¿æ³›çš„åº”ç”¨åœºæ™¯ï¼Œèƒ½å¤Ÿæ˜¾è‘—æå‡ç¨‹åºçš„æ•ˆçŽ‡å’Œå¯è¯»æ€§ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;cstdio&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;cstdint&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">template&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">typename&lt;/span> T&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">constexpr&lt;/span> T square(T x) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> x &lt;span style="color:#f92672">*&lt;/span> x;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">int&lt;/span> &lt;span style="color:#a6e22e">main&lt;/span>() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">constexpr&lt;/span> &lt;span style="color:#66d9ef">uint64_t&lt;/span> square2 &lt;span style="color:#f92672">=&lt;/span> square(&lt;span style="color:#ae81ff">2&lt;/span>); &lt;span style="color:#75715e">// è®¡ç®—å¸¸é‡çš„å¹³æ–¹
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">constexpr&lt;/span> &lt;span style="color:#66d9ef">double&lt;/span> square2_0 &lt;span style="color:#f92672">=&lt;/span> square(&lt;span style="color:#ae81ff">2.0&lt;/span>); &lt;span style="color:#75715e">// è®¡ç®—æµ®ç‚¹æ•°çš„å¹³æ–¹
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> printf(&lt;span style="color:#e6db74">&amp;#34;%lu&lt;/span>&lt;span style="color:#ae81ff">\t&lt;/span>&lt;span style="color:#e6db74">%.04lf&lt;/span>&lt;span style="color:#ae81ff">\n&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span>, square2, square2_0); &lt;span style="color:#75715e">// è¾“å‡ºç»“æžœ
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ¨¡æ¿å‡½æ•° &lt;code>square&lt;/code> ä½¿ç”¨äº† &lt;code>constexpr&lt;/code>ï¼Œç¡®ä¿åœ¨ç¼–è¯‘æ—¶å°±å¯ä»¥è®¡ç®—ç»“æžœã€‚å¯¹äºŽä¸åŒç±»åž‹çš„å‚æ•°ï¼ˆå¦‚æ•´æ•°ã€æµ®ç‚¹æ•°ï¼‰ï¼Œæ¨¡æ¿ä¼šè‡ªåŠ¨è¿›è¡Œå®žä¾‹åŒ–ã€‚&lt;/p>
&lt;p>å¦‚æžœæ¨¡æ¿å‚æ•°ä¸æ˜¯ç¼–è¯‘æœŸå¸¸é‡ï¼Œ&lt;code>constexpr&lt;/code> å°†ä¸ä¼šåœ¨ç¼–è¯‘æœŸæ‰§è¡Œï¼Œä½†å‡½æ•°æœ¬èº«ä»ç„¶æ˜¯æœ‰æ•ˆçš„ã€‚&lt;/p>
&lt;h2 id="constexpr-å‡½æ•°ä¸­çš„åŠ¨æ€å†…å­˜åˆ†é…">constexpr å‡½æ•°ä¸­çš„åŠ¨æ€å†…å­˜åˆ†é… &lt;a href="#constexpr-%e5%87%bd%e6%95%b0%e4%b8%ad%e7%9a%84%e5%8a%a8%e6%80%81%e5%86%85%e5%ad%98%e5%88%86%e9%85%8d" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;p>åœ¨ C++20 ä¸­ï¼Œ&lt;code>constexpr&lt;/code> å‡½æ•°å¾—åˆ°äº†è¿›ä¸€æ­¥å¢žå¼ºï¼Œæ”¯æŒåœ¨ç¼–è¯‘æœŸè¿›è¡ŒåŠ¨æ€å†…å­˜åˆ†é…ï¼Œä½†ä»ç„¶å­˜åœ¨ä¸€äº›é™åˆ¶ã€‚&lt;/p>
&lt;p>&lt;code>std::array&lt;/code> çš„æ‰€æœ‰æ•°æ®éƒ½å­˜å‚¨åœ¨æ ˆä¸Šï¼Œè€Œä¸æ˜¯å †ä¸Šã€‚ä¸¥æ ¼çš„è¯´ï¼Œ&lt;code>std::array&lt;/code>ä¸æ¶‰åŠåŠ¨æ€å†…å­˜åˆ†é…ã€‚æ‰€ä»¥&lt;code>std::array&lt;/code>å¯ä»¥åœ¨&lt;code>constexpr&lt;/code>å‡½æ•°ä¸­è¢«åˆå§‹åŒ–ã€ä¿®æ”¹å¹¶è¿”å›žã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;cstdio&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;cstdint&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;vector&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;array&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">template&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">int&lt;/span> maxstep&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">100&lt;/span>&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">constexpr&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>array&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">int&lt;/span>, maxstep&lt;span style="color:#f92672">&amp;gt;&lt;/span> Collatz(&lt;span style="color:#66d9ef">int&lt;/span> x) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> std&lt;span style="color:#f92672">::&lt;/span>array&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">int&lt;/span>, maxstep&lt;span style="color:#f92672">&amp;gt;&lt;/span> path;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">int&lt;/span> idx &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">while&lt;/span> (true) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> path[idx&lt;span style="color:#f92672">++&lt;/span>] &lt;span style="color:#f92672">=&lt;/span> x;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (x &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">break&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (x &lt;span style="color:#f92672">%&lt;/span> &lt;span style="color:#ae81ff">2&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> x &lt;span style="color:#f92672">/=&lt;/span> &lt;span style="color:#ae81ff">2&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> } &lt;span style="color:#66d9ef">else&lt;/span> &lt;span style="color:#a6e22e">if&lt;/span> (x &lt;span style="color:#f92672">%&lt;/span> &lt;span style="color:#ae81ff">2&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> x &lt;span style="color:#f92672">=&lt;/span> x &lt;span style="color:#f92672">*&lt;/span> &lt;span style="color:#ae81ff">3&lt;/span> &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> path;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">int&lt;/span> &lt;span style="color:#a6e22e">main&lt;/span>() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">constexpr&lt;/span> &lt;span style="color:#66d9ef">auto&lt;/span> path &lt;span style="color:#f92672">=&lt;/span> Collatz(&lt;span style="color:#ae81ff">12345&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">for&lt;/span> (&lt;span style="color:#66d9ef">auto&lt;/span> item : path) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (item &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">break&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> printf(&lt;span style="color:#e6db74">&amp;#34;%d&lt;/span>&lt;span style="color:#ae81ff">\n&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span>, item);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è€Œå¯¹äºŽ&lt;code>std::string&lt;/code>æˆ–è€…&lt;code>std::vector&lt;/code>è¿™ç§ éœ€è¦åœ¨å †ä¸Šåˆ†é…å†…å­˜çš„æ•°æ®ç»“æž„ï¼Œæˆ‘ä»¬åˆ™ä¸å¯ä»¥åœ¨constexprå‡½æ•°ä¸­ç›´æŽ¥è¿”å›žã€‚ä½†æ˜¯å¯ä»¥åœ¨constexprå‡½æ•°ä¸­åˆ™ç”¨å…¶è¿›è¡Œè®¡ç®—ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;cstdio&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;cstdint&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;vector&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;array&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;string&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">constexpr&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> &lt;span style="color:#a6e22e">square&lt;/span>(&lt;span style="color:#66d9ef">int&lt;/span> x) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> x &lt;span style="color:#f92672">*&lt;/span> x;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">constexpr&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> &lt;span style="color:#a6e22e">CountPrimes&lt;/span>(&lt;span style="color:#66d9ef">int&lt;/span> n) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> std&lt;span style="color:#f92672">::&lt;/span>vector&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">int&lt;/span>&lt;span style="color:#f92672">&amp;gt;&lt;/span> primes{&lt;span style="color:#ae81ff">2&lt;/span>, &lt;span style="color:#ae81ff">3&lt;/span>};
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">for&lt;/span> (&lt;span style="color:#66d9ef">int&lt;/span> i &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">5&lt;/span>; i &lt;span style="color:#f92672">&amp;lt;=&lt;/span> n; i &lt;span style="color:#f92672">+=&lt;/span> &lt;span style="color:#ae81ff">2&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">bool&lt;/span> flag &lt;span style="color:#f92672">=&lt;/span> true;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">for&lt;/span> (&lt;span style="color:#66d9ef">auto&lt;/span> prime : primes) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (i &lt;span style="color:#f92672">%&lt;/span> prime &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> flag &lt;span style="color:#f92672">=&lt;/span> false;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">break&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (square(prime) &lt;span style="color:#f92672">&amp;gt;=&lt;/span> i) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">break&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (flag) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> primes.push_back(i);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> primes.size();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">int&lt;/span> &lt;span style="color:#a6e22e">main&lt;/span>() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">constexpr&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> cnt &lt;span style="color:#f92672">=&lt;/span> CountPrimes(&lt;span style="color:#ae81ff">100&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> printf(&lt;span style="color:#e6db74">&amp;#34;%d&lt;/span>&lt;span style="color:#ae81ff">\n&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span>, cnt);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="constexpr-virtual-å‡½æ•°">constexpr virtual å‡½æ•° &lt;a href="#constexpr-virtual-%e5%87%bd%e6%95%b0" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;p>åœ¨ C++20 ä¸­ï¼Œ&lt;code>constexpr&lt;/code> å‡½æ•°å¯ä»¥ä¸Ž &lt;code>virtual&lt;/code> å…³é”®å­—ç»“åˆä½¿ç”¨ï¼Œå®žçŽ°åœ¨ç¼–è¯‘æœŸè¿›è¡Œå¤šæ€æ±‚å€¼ã€‚&lt;/p>
&lt;p>è™šå‡½æ•°çš„ constexpr é™åˆ¶ï¼šconstexpr è™šå‡½æ•°åªèƒ½åœ¨ç¼–è¯‘æœŸæ±‚å€¼ï¼Œå‰ææ˜¯å…¶è¢«è°ƒç”¨çš„å…·ä½“å¯¹è±¡ç±»åž‹æ˜¯ç¡®å®šçš„ã€‚&lt;/p>
&lt;p>åœ¨ constexpr ä¸Šä¸‹æ–‡ä¸­è°ƒç”¨ virtual å‡½æ•°æ—¶ï¼Œè°ƒç”¨å°†ç»‘å®šåˆ°å…·ä½“æ´¾ç”Ÿç±»çš„å®žçŽ°ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;cstdio&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;cstdint&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">struct&lt;/span> &lt;span style="color:#a6e22e">Base&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">constexpr&lt;/span> &lt;span style="color:#66d9ef">virtual&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> &lt;span style="color:#a6e22e">Value&lt;/span>() &lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>; &lt;span style="color:#75715e">// è™šæ‹Ÿ constexpr å‡½æ•°
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>};
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">struct&lt;/span> &lt;span style="color:#a6e22e">Derived1&lt;/span> &lt;span style="color:#f92672">:&lt;/span> Base {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">constexpr&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> &lt;span style="color:#a6e22e">Value&lt;/span>() &lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">override&lt;/span> { &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>; }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>};
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">struct&lt;/span> &lt;span style="color:#a6e22e">Derived2&lt;/span> &lt;span style="color:#f92672">:&lt;/span> Base {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">constexpr&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> &lt;span style="color:#a6e22e">Value&lt;/span>() &lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">override&lt;/span> { &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#ae81ff">2&lt;/span>; }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>};
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">constexpr&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> &lt;span style="color:#a6e22e">Calc&lt;/span>() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Base&lt;span style="color:#f92672">*&lt;/span> d1 &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> Derived1(); &lt;span style="color:#75715e">// constexpr ä¸­åˆ†é…å†…å­˜
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> Base&lt;span style="color:#f92672">*&lt;/span> d2 &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> Derived2();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">int&lt;/span> value &lt;span style="color:#f92672">=&lt;/span> d1&lt;span style="color:#f92672">-&amp;gt;&lt;/span>Value() &lt;span style="color:#f92672">+&lt;/span> d2&lt;span style="color:#f92672">-&amp;gt;&lt;/span>Value(); &lt;span style="color:#75715e">// è°ƒç”¨è™šå‡½æ•°
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">delete&lt;/span> d1; &lt;span style="color:#75715e">// å¿…é¡»é‡Šæ”¾å†…å­˜
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">delete&lt;/span> d2;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> value;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">int&lt;/span> &lt;span style="color:#a6e22e">main&lt;/span>() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">constexpr&lt;/span> &lt;span style="color:#66d9ef">auto&lt;/span> v &lt;span style="color:#f92672">=&lt;/span> Calc(); &lt;span style="color:#75715e">// åœ¨ç¼–è¯‘æœŸè®¡ç®—
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> printf(&lt;span style="color:#e6db74">&amp;#34;%d&lt;/span>&lt;span style="color:#ae81ff">\n&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span>, v);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> v;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="å¸¸é‡è¡¨è¾¾å¼ç”¨äºŽæ¨¡æ¿å‡½æ•°çš„ç±»åž‹åˆ¤æ–­">å¸¸é‡è¡¨è¾¾å¼ç”¨äºŽæ¨¡æ¿å‡½æ•°çš„ç±»åž‹åˆ¤æ–­ &lt;a href="#%e5%b8%b8%e9%87%8f%e8%a1%a8%e8%be%be%e5%bc%8f%e7%94%a8%e4%ba%8e%e6%a8%a1%e6%9d%bf%e5%87%bd%e6%95%b0%e7%9a%84%e7%b1%bb%e5%9e%8b%e5%88%a4%e6%96%ad" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;p>åœ¨ C++17 ä¸­å¼•å…¥çš„ &lt;code>if constexpr&lt;/code> æä¾›äº†ä¸€ç§æ›´åŠ ç®€æ´å’Œå¯è¯»çš„æ–¹å¼æ¥è¿›è¡Œæ¨¡æ¿å…ƒç¼–ç¨‹çš„ç±»åž‹åˆ¤æ–­ã€‚æ ¹æ®ç±»åž‹ç‰¹æ€§ï¼Œåœ¨ç¼–è¯‘æœŸé€‰æ‹©ä¸åŒçš„åˆ†æ”¯è·¯å¾„ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;cstdio&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;cstdint&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;iostream&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;cmath&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;type_traits&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">template&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">typename&lt;/span> T&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">bool&lt;/span> equal(&lt;span style="color:#66d9ef">const&lt;/span> T&lt;span style="color:#f92672">&amp;amp;&lt;/span> a, &lt;span style="color:#66d9ef">const&lt;/span> T&lt;span style="color:#f92672">&amp;amp;&lt;/span> b) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#a6e22e">constexpr&lt;/span> (std&lt;span style="color:#f92672">::&lt;/span>is_integral_v&lt;span style="color:#f92672">&amp;lt;&lt;/span>T&lt;span style="color:#f92672">&amp;gt;&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> a &lt;span style="color:#f92672">==&lt;/span> b; &lt;span style="color:#75715e">// æ•´æ•°ç±»åž‹ç›´æŽ¥æ¯”è¾ƒ
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> } &lt;span style="color:#66d9ef">else&lt;/span> &lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#a6e22e">constexpr&lt;/span> (std&lt;span style="color:#f92672">::&lt;/span>is_floating_point_v&lt;span style="color:#f92672">&amp;lt;&lt;/span>T&lt;span style="color:#f92672">&amp;gt;&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> fabs(a &lt;span style="color:#f92672">-&lt;/span> b) &lt;span style="color:#f92672">&amp;lt;=&lt;/span> &lt;span style="color:#ae81ff">1e-3&lt;/span>; &lt;span style="color:#75715e">// æµ®ç‚¹æ•°è¿›è¡Œè¯¯å·®æ¯”è¾ƒ
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> } &lt;span style="color:#66d9ef">else&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">static_assert&lt;/span>(std&lt;span style="color:#f92672">::&lt;/span>is_arithmetic_v&lt;span style="color:#f92672">&amp;lt;&lt;/span>T&lt;span style="color:#f92672">&amp;gt;&lt;/span> &lt;span style="color:#f92672">||&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>is_pointer_v&lt;span style="color:#f92672">&amp;lt;&lt;/span>T&lt;span style="color:#f92672">&amp;gt;&lt;/span>, &lt;span style="color:#e6db74">&amp;#34;not supported&amp;#34;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">int&lt;/span> &lt;span style="color:#a6e22e">main&lt;/span>() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> std&lt;span style="color:#f92672">::&lt;/span>cout &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>boolalpha;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> std&lt;span style="color:#f92672">::&lt;/span>cout &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> equal(&lt;span style="color:#ae81ff">1&lt;/span>, &lt;span style="color:#ae81ff">1&lt;/span>) &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>endl; &lt;span style="color:#75715e">// true
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>cout &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> equal(&lt;span style="color:#ae81ff">1L&lt;/span>, &lt;span style="color:#ae81ff">1L&lt;/span>) &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>endl; &lt;span style="color:#75715e">// true
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>cout &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> equal(&lt;span style="color:#ae81ff">1.0000001&lt;/span>, &lt;span style="color:#ae81ff">1.000002&lt;/span>) &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>endl; &lt;span style="color:#75715e">// true
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>cout &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> equal(&lt;span style="color:#ae81ff">1.0000001&lt;/span>, &lt;span style="color:#ae81ff">2.000002&lt;/span>) &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>endl; &lt;span style="color:#75715e">// false
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>åœ¨ä¼ ç»ŸC++ä¸­ï¼Œæˆ‘ä»¬å¸¸ç”¨&lt;code>std::enable_if&lt;/code>æ¥å®žçŽ°ç±»ä¼¼çš„åŠŸèƒ½ã€‚ä½†æ˜¯å¾ˆæ˜Žæ˜¾ï¼Œè¯­æ³•ä¼šæ˜¾å¾—è¿‡äºŽç¬¨é‡ã€‚&lt;/p>
&lt;pre tabindex="0">&lt;code>#include &amp;lt;type_traits&amp;gt;
#include &amp;lt;cmath&amp;gt;
#include &amp;lt;cstdio&amp;gt;
// æ•´æ•°ç±»åž‹
template &amp;lt;typename T&amp;gt;
typename std::enable_if&amp;lt;std::is_integral&amp;lt;T&amp;gt;::value, bool&amp;gt;::type
equal(const T&amp;amp; a, const T&amp;amp; b) {
return a == b;
}
// æµ®ç‚¹ç±»åž‹
template &amp;lt;typename T&amp;gt;
typename std::enable_if&amp;lt;std::is_floating_point&amp;lt;T&amp;gt;::value, bool&amp;gt;::type
equal(const T&amp;amp; a, const T&amp;amp; b) {
return std::fabs(a - b) &amp;lt;= 1e-3;
}
// å…¶ä»–ç±»åž‹
template &amp;lt;typename T&amp;gt;
typename std::enable_if&amp;lt;
!(std::is_integral&amp;lt;T&amp;gt;::value || std::is_floating_point&amp;lt;T&amp;gt;::value), bool&amp;gt;::type
equal(const T&amp;amp; a, const T&amp;amp; b) {
static_assert(std::is_arithmetic&amp;lt;T&amp;gt;::value || std::is_pointer&amp;lt;T&amp;gt;::value, &amp;#34;not supported&amp;#34;);
return false;
}
int main() {
puts(equal(1, 1) ? &amp;#34;true&amp;#34; : &amp;#34;false&amp;#34;); // æ•´æ•°
puts(equal(1.0000001, 1.000002) ? &amp;#34;true&amp;#34; : &amp;#34;false&amp;#34;); // æµ®ç‚¹
return 0;
}
&lt;/code>&lt;/pre>&lt;h2 id="ä½¿ç”¨constevalå¼ºåˆ¶ä½¿ç”¨ç¼–è¯‘æœŸæ±‚å€¼">ä½¿ç”¨&lt;code>consteval&lt;/code>å¼ºåˆ¶ä½¿ç”¨ç¼–è¯‘æœŸæ±‚å€¼ &lt;a href="#%e4%bd%bf%e7%94%a8consteval%e5%bc%ba%e5%88%b6%e4%bd%bf%e7%94%a8%e7%bc%96%e8%af%91%e6%9c%9f%e6%b1%82%e5%80%bc" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;p>&lt;code>consteval&lt;/code> æ˜¯åœ¨ C++20 ä¸­å¼•å…¥çš„å…³é”®å­—ï¼Œç”¨äºŽå£°æ˜Žç«‹å³å‡½æ•°ï¼ˆimmediate functionï¼‰ã€‚ç«‹å³å‡½æ•°è¦æ±‚åœ¨ç¼–è¯‘æ—¶è¿›è¡Œæ±‚å€¼ï¼Œä¸èƒ½åœ¨è¿è¡Œæ—¶è°ƒç”¨ã€‚
å¦‚æžœè°ƒç”¨ä¸€ä¸ª&lt;code>consteval&lt;/code>ã€‚å¦‚æžœè°ƒç”¨ &lt;code>consteval&lt;/code> å‡½æ•°æ—¶æ— æ³•åœ¨ç¼–è¯‘æœŸè®¡ç®—ï¼Œç¼–è¯‘å™¨å°†æŠ¥é”™ã€‚&lt;/p>
&lt;p>&lt;code>constexpr&lt;/code> å‡½æ•°åœ¨æŸäº›æƒ…å†µä¸‹å¯èƒ½ä¼šé€€åŒ–ä¸ºè¿è¡Œæ—¶è°ƒç”¨ï¼Œ&lt;code>consteval&lt;/code> å¯ä»¥é¿å…è¿™ç§æƒ…å†µã€‚&lt;/p>
&lt;p>ä¾‹å¦‚ï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code>#include &amp;lt;iostream&amp;gt;
// consteval å¼ºåˆ¶è¦æ±‚åœ¨ç¼–è¯‘æ—¶è¿›è¡Œè®¡ç®—
consteval int factorial(int n) {
return (n &amp;lt;= 1) ? 1 : (n * factorial(n - 1));
}
int main() {
constexpr int result = factorial(5); // OKï¼šåœ¨ç¼–è¯‘æ—¶è®¡ç®—
std::cout &amp;lt;&amp;lt; &amp;#34;Factorial of 5 is: &amp;#34; &amp;lt;&amp;lt; result &amp;lt;&amp;lt; std::endl;
// int runtime = 5;
// std::cout &amp;lt;&amp;lt; &amp;#34;Factorial of runtime: &amp;#34; &amp;lt;&amp;lt; factorial(runtime) &amp;lt;&amp;lt; std::endl;
// é”™è¯¯ï¼šfactorial å¿…é¡»åœ¨ç¼–è¯‘æ—¶è°ƒç”¨
return 0;
}
&lt;/code>&lt;/pre>&lt;h2 id="ä½¿ç”¨constinitæ˜¾å¼è¦æ±‚ç¼–è¯‘æ—¶åˆå§‹åŒ–">ä½¿ç”¨&lt;code>constinit&lt;/code>æ˜¾å¼è¦æ±‚ç¼–è¯‘æ—¶åˆå§‹åŒ– &lt;a href="#%e4%bd%bf%e7%94%a8constinit%e6%98%be%e5%bc%8f%e8%a6%81%e6%b1%82%e7%bc%96%e8%af%91%e6%97%b6%e5%88%9d%e5%a7%8b%e5%8c%96" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;p>&lt;code>constinit&lt;/code> å…³é”®å­—ç”¨äºŽæ˜¾å¼è¦æ±‚å…¨å±€æˆ–é™æ€å˜é‡åœ¨ç¼–è¯‘æœŸå®Œæˆåˆå§‹åŒ–ã€‚
å¦‚æžœå˜é‡æ— æ³•åœ¨ç¼–è¯‘æ—¶åˆå§‹åŒ–ï¼Œç¼–è¯‘å™¨å°†æŠ¥é”™ã€‚
&lt;code>constinit&lt;/code> ä¸èƒ½ç”¨äºŽå±€éƒ¨å˜é‡ã€‚&lt;/p>
&lt;p>ä¸Ž &lt;code>constexpr&lt;/code> ä¸åŒï¼Œ&lt;code>constinit&lt;/code> å˜é‡å¯ä»¥åœ¨è¿è¡Œæ—¶è¢«ä¿®æ”¹ã€‚
çº¿ç¨‹å®‰å…¨æ€§ï¼šåœ¨å¤šçº¿ç¨‹çŽ¯å¢ƒä¸­ï¼Œ&lt;code>constinit&lt;/code> ç¡®ä¿å˜é‡åœ¨ç¼–è¯‘æœŸåˆå§‹åŒ–ï¼Œé¿å…çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚&lt;/p>
&lt;pre tabindex="0">&lt;code>#include &amp;lt;array&amp;gt;
// ç¼–è¯‘æ—¶åˆå§‹åŒ–
constexpr int compute(int v) { return v * v * v; }
constinit int global = compute(10);
// é”™è¯¯ï¼šconstinit å˜é‡ä¸èƒ½ä¾èµ–è¿è¡Œæ—¶åˆå§‹åŒ–
// constinit int another = global;
int main() {
global = 100; // å…è®¸åœ¨è¿è¡Œæ—¶ä¿®æ”¹
// é”™è¯¯ï¼šconstinit å˜é‡ä¸æ˜¯å¸¸é‡ï¼Œä¸èƒ½ç”¨ä½œæ•°ç»„å¤§å°
// std::array&amp;lt;int, global&amp;gt; arr;
std::cout &amp;lt;&amp;lt; &amp;#34;Global value: &amp;#34; &amp;lt;&amp;lt; global &amp;lt;&amp;lt; std::endl;
return 0;
}
&lt;/code>&lt;/pre>&lt;h2 id="æ€»ç»“">æ€»ç»“ &lt;a href="#%e6%80%bb%e7%bb%93" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;ul>
&lt;li>&lt;code>constexpr&lt;/code>åœ¨å¤šæ•°æƒ…å†µä¸‹å¯ä»¥æ›¿ä»£&lt;code>const&lt;/code>ä»¥è¡¨è¾¾â€œç¼–è¯‘æœŸå¸¸é‡â€çš„è¯­ä¹‰ï¼Œå¯ç”¨äºŽå‡½æ•°ã€å˜é‡ã€ç±»ç­‰åœºæ™¯ã€‚constexpr æ”¯æŒåœ¨ç¼–è¯‘æœŸå’Œè¿è¡ŒæœŸè¿›è¡Œæ±‚å€¼ï¼Œä½†åœ¨æŸäº›æƒ…å†µä¸‹å¯èƒ½ä¼šé€€åŒ–ä¸ºè¿è¡ŒæœŸæ±‚å€¼ã€‚&lt;/li>
&lt;li>å¸¸é‡è¡¨è¾¾å¼å‡½æ•° æä¾›äº†ä¸€ç§æ›´æ¸…æ™°çš„ç¼–è¯‘æœŸè®¡ç®—æ–¹å¼ï¼Œèƒ½å¤Ÿåœ¨ä¸€å®šç¨‹åº¦ä¸Šå–ä»£å¤æ‚ä¸”æ™¦æ¶©çš„æ¨¡æ¿å…ƒç¼–ç¨‹ã€‚éšç€ C++ æ ‡å‡†çš„æ¼”è¿›ï¼Œ&lt;code>constexpr&lt;/code> å‡½æ•°é€æ­¥æ”¯æŒäº†æ›´å¤æ‚çš„è¯­æ³•å’Œé€»è¾‘ï¼Œä¾‹å¦‚æ¡ä»¶è¯­å¥ã€å¾ªçŽ¯è¯­å¥å’Œå±€éƒ¨å˜é‡ã€‚ä½†å¯¹äºŽæžç«¯å¤æ‚çš„è®¡ç®—åœºæ™¯ï¼Œç¼–è¯‘æœŸè®¡ç®—å¯èƒ½å¯¼è‡´æ˜¾è‘—çš„ç¼–è¯‘æ—¶é—´å¼€é”€ã€‚&lt;/li>
&lt;li>&lt;code>constexpr&lt;/code>å¯ä»¥åœ¨æ¨¡æ¿å‡½æ•°ä¸­ç”¨äºŽç±»åž‹åˆ¤æ–­ï¼Œé€šè¿‡&lt;code>if constexpr&lt;/code>è¯­æ³•æœ‰æ•ˆåœ°å–ä»£&lt;code>std::enable_if&lt;/code>ï¼Œä»Žè€Œç®€åŒ–æ¨¡æ¿ç¼–ç¨‹ï¼Œæé«˜ä»£ç çš„å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚&lt;/li>
&lt;li>&lt;code>constexpr&lt;/code>å‡½æ•°çš„éšå¼é€€åŒ–é£Žé™©ï¼šåœ¨æŸäº›åœºæ™¯ä¸‹ï¼Œ&lt;code>constexpr&lt;/code> å‡½æ•°å¯èƒ½åœ¨è¿è¡Œæ—¶æ‰§è¡Œã€‚è‹¥éœ€è¦ä¸¥æ ¼ä¿è¯ä»…åœ¨ç¼–è¯‘æœŸæ±‚å€¼ï¼Œå¯ä»¥ä½¿ç”¨ &lt;code>consteval&lt;/code> æ¥å¼ºåˆ¶è¿›è¡Œç¼–è¯‘æœŸæ±‚å€¼ï¼Œé¿å…ä¸å¿…è¦çš„è¿è¡Œæ—¶å¼€é”€ã€‚&lt;/li>
&lt;li>&lt;code>constinit&lt;/code>æä¾›äº†ä¸€ç§æ˜¾å¼è¦æ±‚å˜é‡åœ¨ç¼–è¯‘æ—¶å®Œæˆåˆå§‹åŒ–çš„æœºåˆ¶ï¼Œé€‚ç”¨äºŽéž&lt;code>constexpr&lt;/code>å˜é‡ã€‚è¿™åœ¨å…¨å±€å’Œé™æ€å˜é‡çš„åˆå§‹åŒ–ä¸­å°¤ä¸ºæœ‰ç”¨ï¼ŒåŒæ—¶ä¹Ÿä¿è¯äº†å¤šçº¿ç¨‹çŽ¯å¢ƒä¸‹çš„åˆå§‹åŒ–å®‰å…¨æ€§ã€‚&lt;/li>
&lt;/ul></description></item><item><title>CPUç¼“å­˜ä¸€è‡´æ€§ä¸Žå†…å­˜ä¸€è‡´æ€§ï¼ˆç¬¬äºŒéƒ¨åˆ†-å†…å­˜ä¸€è‡´æ€§ï¼‰</title><link>https://wizmann.top/posts/cache-coherence-and-memory-order-2/</link><pubDate>Sun, 01 Sep 2024 00:24:00 +0000</pubDate><guid>https://wizmann.top/posts/cache-coherence-and-memory-order-2/</guid><description>&lt;h2 id="ç¼“å­˜ä¸€è‡´æ€§ä¸Žå†…å­˜ä¸€è‡´æ€§">ç¼“å­˜ä¸€è‡´æ€§ä¸Žå†…å­˜ä¸€è‡´æ€§ &lt;a href="#%e7%bc%93%e5%ad%98%e4%b8%80%e8%87%b4%e6%80%a7%e4%b8%8e%e5%86%85%e5%ad%98%e4%b8%80%e8%87%b4%e6%80%a7" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;p>ç¼“å­˜ä¸€è‡´æ€§å’Œå†…å­˜ä¸€è‡´æ€§æ˜¯å¤šå¤„ç†å™¨ç³»ç»Ÿä¸­çš„ä¸¤ä¸ªä¸åŒæ¦‚å¿µï¼Œå®ƒä»¬è§£å†³çš„æ˜¯ä¸åŒç±»åž‹çš„å†…å­˜è®¿é—®é—®é¢˜ã€‚&lt;/p>
&lt;p>ç¼“å­˜ä¸€è‡´æ€§åè®®ï¼ˆå¦‚ MESI åè®®ï¼‰ç”¨äºŽè§£å†³å¤šä¸ªå¤„ç†å™¨å¯¹ç›¸åŒå†…å­˜ä½ç½®è¿›è¡Œè®¿é—®å’Œä¿®æ”¹æ—¶çš„æ•°æ®ä¸€è‡´æ€§é—®é¢˜ã€‚å®ƒç¡®ä¿å„å¤„ç†å™¨çš„ç¼“å­˜ä¸­é’ˆå¯¹åŒä¸€å†…å­˜åœ°å€çš„å‰¯æœ¬ä¿æŒä¸€è‡´ï¼Œé¿å…å› ç¼“å­˜ä¸åŒæ­¥è€Œå¯¼è‡´çš„æ•°æ®é”™è¯¯ã€‚&lt;/p>
&lt;p>è€Œå†…å­˜ä¸€è‡´æ€§å…³æ³¨çš„æ˜¯å¤„ç†å™¨å¯¹å¤šä¸ªä¸åŒå†…å­˜åœ°å€çš„è®¿é—®é¡ºåºé—®é¢˜ã€‚å½“ä¸åŒå¤„ç†å™¨çš„å†…å­˜è®¿é—®é¡ºåºä¸Žç¨‹åºä»£ç ä¸­çš„é¢„æœŸé¡ºåºä¸ä¸€è‡´æ—¶ï¼Œå°±ä¼šå¼•å‘å†…å­˜ä¸€è‡´æ€§é—®é¢˜ã€‚å®ƒè¦æ±‚å„å¤„ç†å™¨æŒ‰ç…§ä¸€å®šçš„è§„åˆ™è®¿é—®å†…å­˜ï¼Œä»¥ä¿æŒç¨‹åºé€»è¾‘çš„æ­£ç¡®æ€§ã€‚&lt;/p>
&lt;p>ç®€è€Œè¨€ä¹‹ï¼Œç¼“å­˜ä¸€è‡´æ€§è§£å†³çš„æ˜¯åŒä¸€å†…å­˜ä½ç½®çš„æ•°æ®åŒæ­¥é—®é¢˜ï¼Œè€Œå†…å­˜ä¸€è‡´æ€§åˆ™æ¶‰åŠå¤šä¸ªå†…å­˜ä½ç½®çš„è®¿é—®é¡ºåºé—®é¢˜ã€‚&lt;/p>
&lt;h2 id="å†…å­˜ä¹±åºè®¿é—®äº§ç”Ÿçš„åŽŸå› ">å†…å­˜ä¹±åºè®¿é—®äº§ç”Ÿçš„åŽŸå›  &lt;a href="#%e5%86%85%e5%ad%98%e4%b9%b1%e5%ba%8f%e8%ae%bf%e9%97%ae%e4%ba%a7%e7%94%9f%e7%9a%84%e5%8e%9f%e5%9b%a0" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;p>å†…å­˜ä¹±åºè®¿é—®çš„åŽŸå› å¯ä»¥ä»Žä¸¤ä¸ªæ–¹é¢æ¥ç†è§£ï¼šç¨‹åºé¡ºåºï¼ˆProgram Order, POï¼‰å’Œå†…å­˜é¡ºåºï¼ˆMemory Order, MOï¼‰ã€‚ç¨‹åºé¡ºåºæ˜¯æŒ‡ç¨‹åºä»£ç ä¸­ç¼–å†™çš„å†…å­˜è®¿é—®åºåˆ—ï¼Œåæ˜ äº†ç¨‹åºå‘˜é¢„æœŸçš„æŒ‡ä»¤æ‰§è¡Œé¡ºåºã€‚æŒ‰ç…§ç¨‹åºé¡ºåºï¼ŒæŒ‡ä»¤åº”è¯¥ä¾æ¬¡è¢«æ‰§è¡Œï¼Œä»¥ç¡®ä¿ç¨‹åºçš„é€»è¾‘æ­£ç¡®æ€§ã€‚ç„¶è€Œï¼Œåœ¨å®žé™…æ‰§è¡Œä¸­ï¼Œç³»ç»Ÿä¸­å¯èƒ½å­˜åœ¨ä¸€ç§ä¸åŒçš„é¡ºåºï¼Œå³å†…å­˜é¡ºåºã€‚&lt;/p>
&lt;p>å†…å­˜é¡ºåºæ˜¯æŒ‡ç³»ç»Ÿä¸­æ‰€æœ‰å¤„ç†å™¨å¯¹å†…å­˜æ“ä½œè¾¾æˆä¸€è‡´çš„è®¿é—®é¡ºåºã€‚ç”±äºŽçŽ°ä»£è®¡ç®—æœºç³»ç»Ÿé€šå¸¸ç”±å¤šä¸ªå¤„ç†å™¨å…±åŒæ“ä½œå…±äº«å†…å­˜ï¼Œä¸ºäº†æé«˜æ•´ä½“æ€§èƒ½ï¼Œè¿™äº›å¤„ç†å™¨å¯èƒ½ä¼šå¯¹å†…å­˜æ“ä½œè¿›è¡Œé‡æŽ’åºï¼Œä»Žè€Œäº§ç”Ÿä¸Žç¨‹åºé¡ºåºä¸ä¸€è‡´çš„å†…å­˜é¡ºåºã€‚&lt;/p>
&lt;p>è¿™ç§å†…å­˜ä¹±åºè®¿é—®çš„çŽ°è±¡ä¸»è¦æ˜¯ä¸ºäº†ä¼˜åŒ–ç¨‹åºæ‰§è¡Œæ•ˆçŽ‡ï¼Œé€šå¸¸å‘ç”Ÿåœ¨ä¸¤ä¸ªé˜¶æ®µï¼šç¼–è¯‘é˜¶æ®µå’Œæ‰§è¡Œé˜¶æ®µã€‚åœ¨ç¼–è¯‘é˜¶æ®µï¼Œç¼–è¯‘å™¨ä¼šå¯¹ä»£ç è¿›è¡Œä¼˜åŒ–ï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´æŒ‡ä»¤çš„é‡æŽ’åºï¼Œä»¥æé«˜æ‰§è¡Œæ•ˆçŽ‡ã€‚åœ¨æ‰§è¡Œé˜¶æ®µï¼Œå¤šä¸ª CPU ä¹‹é—´çš„äº¤äº’ä¹Ÿä¼šå¼•èµ·å†…å­˜è®¿é—®é¡ºåºçš„ä¸ä¸€è‡´ã€‚&lt;/p>
&lt;p>åœ¨å•å¤„ç†å™¨ç³»ç»Ÿä¸­ï¼ŒCPU å¯¹æŒ‡ä»¤çš„ä¹±åºæ‰§è¡Œå’Œé‡æŽ’å¯¹äºŽç¨‹åºå‘˜æ¥è¯´æ˜¯é€æ˜Žçš„ï¼Œå³ç¨‹åºçš„æ‰§è¡Œç»“æžœä¸Žé¡ºåºæ‰§è¡Œçš„ç»“æžœæ˜¯ä¸€è‡´çš„ã€‚ç„¶è€Œï¼Œåœ¨å¤šå¤„ç†å™¨ç³»ç»Ÿä¸­ï¼Œä¸åŒçš„å¤„ç†å™¨ï¼ˆæˆ–ç§°ä¸ºè§‚å¯Ÿè€…ï¼‰å¯èƒ½ä¼šè§‚å¯Ÿåˆ°ä¸åŒçš„å†…å­˜æ‰§è¡Œé¡ºåºï¼Œè¿™ä¸ŽæŒ‡ä»¤çš„å®žé™…æ‰§è¡Œé¡ºåºä¸å®Œå…¨ä¸€è‡´ï¼Œä»Žè€Œå¯¼è‡´æ½œåœ¨çš„åŒæ­¥é—®é¢˜å’Œæ•°æ®ä¸ä¸€è‡´æ€§ã€‚&lt;/p>
&lt;h2 id="å‡ ç§å¸¸è§çš„ä¸€è‡´æ€§æ¨¡åž‹">å‡ ç§å¸¸è§çš„ä¸€è‡´æ€§æ¨¡åž‹ &lt;a href="#%e5%87%a0%e7%a7%8d%e5%b8%b8%e8%a7%81%e7%9a%84%e4%b8%80%e8%87%b4%e6%80%a7%e6%a8%a1%e5%9e%8b" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;p>åœ¨å¤šå¤„ç†å™¨ç³»ç»Ÿä¸­ï¼Œå†…å­˜ä¸€è‡´æ€§æ¨¡åž‹å†³å®šäº†ä¸åŒå¤„ç†å™¨ä¹‹é—´å¦‚ä½•è§‚å¯Ÿå’Œæ‰§è¡Œå†…å­˜æ“ä½œçš„é¡ºåºã€‚ä»¥ä¸‹ä»‹ç»å‡ ç§å¸¸è§çš„ä¸€è‡´æ€§æ¨¡åž‹ï¼š&lt;/p>
&lt;h3 id="é¡ºåºä¸€è‡´æ€§æ¨¡åž‹sequential-consistency-sc">é¡ºåºä¸€è‡´æ€§æ¨¡åž‹ï¼ˆSequential Consistency, SCï¼‰ &lt;a href="#%e9%a1%ba%e5%ba%8f%e4%b8%80%e8%87%b4%e6%80%a7%e6%a8%a1%e5%9e%8bsequential-consistency-sc" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;p>é¡ºåºä¸€è‡´æ€§æ¨¡åž‹çš„æ¦‚å¿µæœ€æ—©ç”± Leslie Lamport åœ¨ 1979 å¹´çš„è®ºæ–‡ã€Šå¦‚ä½•æž„å»ºæ­£ç¡®æ‰§è¡Œå¤šå¤„ç†ç¨‹åºçš„å¤šå¤„ç†è®¡ç®—æœºã€‹ä¸­æå‡ºã€‚æŒ‰ç…§ä»–çš„å®šä¹‰ï¼š&lt;/p>
&lt;p>ä»»ä½•æ‰§è¡Œçš„ç»“æžœéƒ½ä¸Žæ‰€æœ‰å¤„ç†å™¨çš„æ“ä½œæŒ‰ç…§æŸç§é¡ºåºä¾æ¬¡æ‰§è¡Œçš„ç»“æžœç›¸åŒï¼Œå¹¶ä¸”æ¯ä¸ªå¤„ç†å™¨çš„æ“ä½œåœ¨è¿™ä¸ªé¡ºåºä¸­å‡ºçŽ°çš„é¡ºåºä¸Žå…¶ç¨‹åºä¸­æŒ‡å®šçš„é¡ºåºä¸€è‡´ã€‚æ»¡è¶³è¿™ä¸€æ¡ä»¶çš„å¤šå¤„ç†å™¨è¢«ç§°ä¸ºé¡ºåºä¸€è‡´æ€§ç³»ç»Ÿã€‚&lt;/p>
&lt;p>é¡ºåºä¸€è‡´æ€§æ¨¡åž‹ä¿è¯äº†æ¯ä¸ªåŠ è½½ï¼ˆLoadï¼‰å’Œå­˜å‚¨ï¼ˆStoreï¼‰æŒ‡ä»¤æŒ‰ç…§ç¨‹åºä¸­æŒ‡å®šçš„ä¸¥æ ¼é¡ºåºæ‰§è¡Œï¼Œç¡®ä¿äº†â€œè¯»-&amp;gt;è¯»â€ã€â€œè¯»-&amp;gt;å†™â€ã€â€œå†™-&amp;gt;å†™â€ä»¥åŠâ€œå†™-&amp;gt;è¯»â€å››ç§æ“ä½œçš„é¡ºåºã€‚è¿™ç§æ¨¡åž‹æä¾›äº†æœ€å¼ºçš„å†…å­˜ä¸€è‡´æ€§ä¿è¯ï¼Œä½†ä»£ä»·æ˜¯è¾ƒä½Žçš„æ‰§è¡Œæ•ˆçŽ‡ï¼Œå› ä¸ºå®ƒä¸å…è®¸ä»»ä½•å½¢å¼çš„æŒ‡ä»¤é‡æŽ’åºã€‚&lt;/p>
&lt;h3 id="å¤„ç†å™¨ä¸€è‡´æ€§æ¨¡åž‹processor-consistency-pc">å¤„ç†å™¨ä¸€è‡´æ€§æ¨¡åž‹ï¼ˆProcessor Consistency, PC) &lt;a href="#%e5%a4%84%e7%90%86%e5%99%a8%e4%b8%80%e8%87%b4%e6%80%a7%e6%a8%a1%e5%9e%8bprocessor-consistency-pc" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;p>å¤„ç†å™¨ä¸€è‡´æ€§æ¨¡åž‹æ˜¯é¡ºåºä¸€è‡´æ€§æ¨¡åž‹çš„å¼±åŒ–ç‰ˆæœ¬ï¼Œå®ƒæ”¾å®½äº†å¯¹â€œå†™-&amp;gt;è¯»â€æ“ä½œé¡ºåºçš„è¦æ±‚ã€‚è¯¥æ¨¡åž‹å…è®¸å¤„ç†å™¨åœ¨è¯»å–æ—¶ä»Žå­˜å‚¨ç¼“å†²åŒºï¼ˆStore Bufferï¼‰ä¸­èŽ·å–ä¸€ä¸ªå°šæœªå†™å…¥ç¼“å­˜çš„å€¼ï¼Œå³ä½¿è¿™ä¸ªå€¼è¿˜æ²¡æœ‰è¢«å…¶ä»–å¤„ç†å™¨çœ‹åˆ°ã€‚x86-64 å®žçŽ°çš„å…¨åºå†™ï¼ˆTotal Store Ordering, TSOï¼‰æ¨¡åž‹å°±æ˜¯å¤„ç†å™¨ä¸€è‡´æ€§çš„ä¸€ç§ã€‚TSO å…è®¸ä¸€å®šç¨‹åº¦çš„ä¹±åºæ‰§è¡Œï¼Œæé«˜äº†ç³»ç»Ÿçš„æ€§èƒ½ï¼ŒåŒæ—¶ä»ç„¶æä¾›äº†è¾ƒå¼ºçš„ä¸€è‡´æ€§ä¿è¯ã€‚&lt;/p>
&lt;h3 id="å¼±ä¸€è‡´æ€§æ¨¡åž‹weak-consistency-wc">å¼±ä¸€è‡´æ€§æ¨¡åž‹ï¼ˆWeak Consistency, WCï¼‰ &lt;a href="#%e5%bc%b1%e4%b8%80%e8%87%b4%e6%80%a7%e6%a8%a1%e5%9e%8bweak-consistency-wc" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;p>å¼±ä¸€è‡´æ€§æ¨¡åž‹è¿›ä¸€æ­¥å¼±åŒ–äº†å¤„ç†å™¨ä¸€è‡´æ€§æ¨¡åž‹çš„è¦æ±‚ï¼Œæ”¾å®½äº†å¯¹â€œè¯»-&amp;gt;è¯»â€ã€â€œè¯»-&amp;gt;å†™â€ã€â€œå†™-&amp;gt;å†™â€ä»¥åŠâ€œå†™-&amp;gt;è¯»â€å››ç§æ“ä½œé¡ºåºçš„çº¦æŸã€‚ä¸ºäº†ç¡®ä¿ç¨‹åºæ‰§è¡Œçš„æ­£ç¡®æ€§ï¼Œç¨‹åºå‘˜éœ€è¦åœ¨åˆé€‚çš„åœ°æ–¹æ˜¾å¼æ·»åŠ åŒæ­¥æ“ä½œã€‚åœ¨è¿™ç§æ¨¡åž‹ä¸­ï¼Œå¤šå¤„ç†å™¨ç³»ç»Ÿçš„å†…å­˜è®¿é—®æ»¡è¶³ä»¥ä¸‹ä¸‰ä¸ªæ¡ä»¶æ—¶ç§°ä¸ºå¼±ä¸€è‡´æ€§å†…å­˜è®¿é—®ï¼š&lt;/p>
&lt;ul>
&lt;li>å¯¹å…¨å±€åŒæ­¥å˜é‡çš„è®¿é—®æ˜¯é¡ºåºä¸€è‡´çš„&lt;/li>
&lt;li>åœ¨ä¸€ä¸ªåŒæ­¥æ“ä½œï¼ˆå¦‚å†…å­˜å±éšœæŒ‡ä»¤ï¼‰æ‰§è¡Œä¹‹å‰ï¼Œæ‰€æœ‰å…ˆå‰çš„æ•°æ®è®¿é—®å¿…é¡»å®Œæˆï¼›&lt;/li>
&lt;li>åœ¨ä¸€ä¸ªæ­£å¸¸çš„æ•°æ®è®¿é—®ï¼ˆå¦‚æ•°æ®è®¿é—®æŒ‡ä»¤ï¼‰æ‰§è¡Œä¹‹å‰ï¼Œæ‰€æœ‰å…ˆå‰çš„åŒæ­¥æ“ä½œï¼ˆå¦‚å†…å­˜å±éšœæŒ‡ä»¤ï¼‰å¿…é¡»å®Œæˆã€‚&lt;/li>
&lt;/ul>
&lt;h3 id="é‡Šæ”¾ä¸€è‡´æ€§æ¨¡åž‹release-consistency-rc">é‡Šæ”¾ä¸€è‡´æ€§æ¨¡åž‹ï¼ˆRelease Consistency, RCï¼‰ &lt;a href="#%e9%87%8a%e6%94%be%e4%b8%80%e8%87%b4%e6%80%a7%e6%a8%a1%e5%9e%8brelease-consistency-rc" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;p>é‡Šæ”¾ä¸€è‡´æ€§æ¨¡åž‹æ˜¯åœ¨å¼±ä¸€è‡´æ€§æ¨¡åž‹çš„åŸºç¡€ä¸Šå¼•å…¥äº†â€œèŽ·å–â€ï¼ˆacquireï¼‰å’Œâ€œé‡Šæ”¾â€ï¼ˆreleaseï¼‰å±éšœåŽŸè¯­ï¼Œç”¨äºŽç®€åŒ–å…±äº«æ•°æ®çš„äº’æ–¥è®¿é—®ã€‚&lt;/p>
&lt;p>åœ¨è¯¥æ¨¡åž‹ä¸­ï¼Œâ€œèŽ·å–â€å±éšœåŽŸè¯­åŽé¢çš„è¯»å†™æ“ä½œä¸èƒ½è¢«é‡æŽ’åˆ°è¯¥å±éšœä¹‹å‰ï¼Œâ€œé‡Šæ”¾â€å±éšœåŽŸè¯­å‰é¢çš„è¯»å†™æ“ä½œä¸èƒ½è¢«é‡æŽ’åˆ°è¯¥å±éšœä¹‹åŽã€‚è¿™ç§æœºåˆ¶èƒ½å¤Ÿæ›´é«˜æ•ˆåœ°ç®¡ç†å¤šå¤„ç†å™¨ç³»ç»Ÿä¸­çš„å…±äº«æ•°æ®è®¿é—®ï¼Œæé«˜å¹¶è¡Œæ€§èƒ½ã€‚&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/Wizmann/assets/38b192183bdefe1e658707d505a5263f12e4ba34/wizmann-pic/image_1724584827296_0.png" alt="">&lt;/p>
&lt;p>è¿™äº›å†…å­˜ä¸€è‡´æ€§æ¨¡åž‹æä¾›äº†ä»Žä¸¥æ ¼åˆ°å®½æ¾çš„ä¸åŒé€‰æ‹©ï¼Œé€‚åº”ä¸åŒçš„åº”ç”¨éœ€æ±‚å’Œæ€§èƒ½è¦æ±‚ã€‚é€‰æ‹©åˆé€‚çš„ä¸€è‡´æ€§æ¨¡åž‹å¯¹å¤šå¤„ç†å™¨ç³»ç»Ÿçš„è®¾è®¡å’Œä¼˜åŒ–è‡³å…³é‡è¦ã€‚&lt;/p>
&lt;h2 id="å››ç§å†…å­˜ä¹±åº">å››ç§å†…å­˜ä¹±åº &lt;a href="#%e5%9b%9b%e7%a7%8d%e5%86%85%e5%ad%98%e4%b9%b1%e5%ba%8f" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;p>åœ¨å¤šå¤„ç†å™¨ç³»ç»Ÿä¸­ï¼Œä¸ºäº†ä¼˜åŒ–æ€§èƒ½ï¼Œå¤„ç†å™¨å¯èƒ½ä¼šå¯¹å†…å­˜æ“ä½œè¿›è¡Œä¸åŒç±»åž‹çš„ä¹±åºæ‰§è¡Œã€‚è¿™ç§ä¹±åºè¡Œä¸ºåŒ…æ‹¬å››ç§ä¸»è¦ç±»åž‹ï¼Œæ¯ä¸€ç§éƒ½ä¼šä»¥ä¸åŒçš„æ–¹å¼å½±å“å¤šçº¿ç¨‹ç¨‹åºçš„æ­£ç¡®æ€§å’Œä¸€è‡´æ€§ã€‚&lt;/p>
&lt;h3 id="loadload-ä¹±åº">LoadLoad ä¹±åº &lt;a href="#loadload-%e4%b9%b1%e5%ba%8f" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;p>LoadLoad ä¹±åºæŒ‡çš„æ˜¯åŽç»­çš„åŠ è½½ï¼ˆè¯»å–ï¼‰æ“ä½œå¯ä»¥åœ¨å…ˆå‰çš„åŠ è½½æ“ä½œå®Œæˆä¹‹å‰å¼€å§‹ï¼Œæˆ–è€…ä¸¤ä¸ªåŠ è½½æ“ä½œçš„å®Œæˆé¡ºåºä¸Žå®ƒä»¬çš„å‘èµ·é¡ºåºä¸åŒã€‚è¿™æ„å‘³ç€å¤„ç†å™¨å¯èƒ½ä¼šä¼˜å…ˆæ‰§è¡ŒåŽå‘èµ·çš„åŠ è½½æ“ä½œã€‚è¿™ç§ä¹±åºä¼˜åŒ–å¯èƒ½æœ‰åŠ©äºŽæé«˜ç¨‹åºçš„æ‰§è¡Œé€Ÿåº¦ï¼Œä½†å¦‚æžœæœªåŠ ä»¥æŽ§åˆ¶ï¼Œå¯èƒ½ä¼šå¯¼è‡´æŸäº›çº¿ç¨‹è¯»å–åˆ°ä¸ä¸€è‡´çš„æ•°æ®ã€‚&lt;/p>
&lt;h3 id="loadstore-ä¹±åº">LoadStore ä¹±åº &lt;a href="#loadstore-%e4%b9%b1%e5%ba%8f" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;p>LoadStore ä¹±åºè¡¨ç¤ºä¸€ä¸ªå­˜å‚¨ï¼ˆå†™å…¥ï¼‰æ“ä½œå¯ä»¥åœ¨ä¹‹å‰å‘èµ·çš„åŠ è½½æ“ä½œå®Œæˆä¹‹å‰å¼€å§‹æ‰§è¡Œï¼Œæˆ–è€…å†™æ“ä½œå¯èƒ½â€œè¶…è¶Šâ€è¯»æ“ä½œã€‚å°½ç®¡è¿™ç§ä¼˜åŒ–å¯ä»¥æé«˜å¤„ç†å™¨çš„æ€§èƒ½ï¼Œä½†åœ¨å¤šçº¿ç¨‹ç¨‹åºä¸­å¯èƒ½å¯¼è‡´æ„å¤–çš„è¡Œä¸ºã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªçº¿ç¨‹å¯èƒ½ä¼šçœ‹åˆ°æ•°æ®è¢«å†™å…¥ä¹‹å‰çš„çŠ¶æ€ï¼Œå¯¼è‡´é€»è¾‘é”™è¯¯æˆ–æ•°æ®ä¸ä¸€è‡´ã€‚&lt;/p>
&lt;h3 id="storeload-ä¹±åº">StoreLoad ä¹±åº &lt;a href="#storeload-%e4%b9%b1%e5%ba%8f" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;p>StoreLoad ä¹±åºæ˜¯å››ç§ä¹±åºç±»åž‹ä¸­å¯¹ç¼–ç¨‹æ¨¡åž‹å½±å“æœ€å¤§çš„ä¸€ç§ã€‚å®ƒå…è®¸ä¸€ä¸ªåŠ è½½æ“ä½œåœ¨ä¹‹å‰çš„å­˜å‚¨æ“ä½œå®Œæˆä¹‹å‰å¼€å§‹ï¼Œæˆ–è€…è¯»å–æ“ä½œå¯èƒ½çœ‹åˆ°å†™æ“ä½œçš„ç»“æžœï¼Œå³ä½¿è¿™ä¸ªå†™æ“ä½œåœ¨ç¨‹åºä¸­çš„é¡ºåºä¸Šåº”è¯¥å‘ç”Ÿåœ¨è¯»æ“ä½œä¹‹åŽã€‚è¿™ç§ä¹±åºæ‰§è¡Œå¯èƒ½å¯¼è‡´ä¸€ä¸ªçº¿ç¨‹è¯»å–åˆ°å¦ä¸€ä¸ªçº¿ç¨‹çš„â€œæ—§â€å€¼ï¼Œè€Œä¸æ˜¯æœ€æ–°å†™å…¥çš„å€¼ï¼Œä»Žè€Œå¼•å‘æ•°æ®åŒæ­¥é—®é¢˜ã€‚&lt;/p>
&lt;h3 id="storestore-ä¹±åº">StoreStore ä¹±åº &lt;a href="#storestore-%e4%b9%b1%e5%ba%8f" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;p>StoreStore ä¹±åºæ¶‰åŠä¸¤ä¸ªè¿žç»­çš„å­˜å‚¨æ“ä½œï¼Œå…¶ä¸­åŽä¸€ä¸ªå­˜å‚¨æ“ä½œå¯ä»¥åœ¨ç¬¬ä¸€ä¸ªæ“ä½œå®Œæˆä¹‹å‰å¼€å§‹ï¼Œæˆ–è€…å®ƒä»¬çš„å®Œæˆé¡ºåºä¸Žå®ƒä»¬è¢«å‘èµ·çš„é¡ºåºä¸åŒã€‚è¿™æ„å‘³ç€ï¼ŒåŽä¸€ä¸ªå†™æ“ä½œçš„ç»“æžœå¯èƒ½åœ¨å‰ä¸€ä¸ªå†™æ“ä½œçš„ç»“æžœå¯¹å…¶ä»–å¤„ç†å™¨å¯è§ä¹‹å‰å°±å·²ç»è¢«è§‚å¯Ÿåˆ°ï¼Œä»Žè€Œé€ æˆæ•°æ®é¡ºåºçš„ä¸ä¸€è‡´ã€‚&lt;/p>
&lt;h3 id="ç®¡ç†å†…å­˜ä¹±åºçš„é‡è¦æ€§">ç®¡ç†å†…å­˜ä¹±åºçš„é‡è¦æ€§ &lt;a href="#%e7%ae%a1%e7%90%86%e5%86%85%e5%ad%98%e4%b9%b1%e5%ba%8f%e7%9a%84%e9%87%8d%e8%a6%81%e6%80%a7" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;p>æ­£ç¡®ç®¡ç†è¿™äº›ä¹±åºè¡Œä¸ºå¯¹äºŽå¹¶å‘ç¼–ç¨‹è‡³å…³é‡è¦ï¼Œç‰¹åˆ«æ˜¯åœ¨è®¾è®¡æ— é”æ•°æ®ç»“æž„å’Œç¼–å†™å¤šçº¿ç¨‹ç¨‹åºæ—¶ã€‚å¦‚æžœä¸åŠ ä»¥æŽ§åˆ¶ï¼Œè¿™äº›ä¹±åºå¯èƒ½å¯¼è‡´æ•°æ®ä¸ä¸€è‡´ã€éš¾ä»¥é‡çŽ°çš„é”™è¯¯å’Œç¨‹åºå´©æºƒã€‚ä¸ºäº†é¿å…è¿™äº›é—®é¢˜ï¼ŒçŽ°ä»£å¤„ç†å™¨å’Œç¼–ç¨‹è¯­è¨€æä¾›äº†å„ç§å†…å­˜å±éšœï¼ˆMemory Barriersï¼‰æˆ–å†…å­˜é¡ºåºï¼ˆMemory Orderï¼‰æŒ‡ä»¤ï¼Œç¡®ä¿åœ¨å…³é”®çš„ç¨‹åºç‚¹ä¸Šå¼ºåˆ¶æ‰§è¡Œæ‰€éœ€çš„å†…å­˜æ“ä½œé¡ºåºã€‚è¿™äº›æœºåˆ¶å¸®åŠ©ç¨‹åºå‘˜åœ¨ä¼˜åŒ–æ€§èƒ½çš„åŒæ—¶ï¼Œç»´æŠ¤æ•°æ®çš„ä¸€è‡´æ€§å’Œæ­£ç¡®æ€§ã€‚&lt;/p>
&lt;h2 id="ä½¿ç”¨litmuså·¥å…·åˆ†æžå†…å­˜ä¹±åº---ä»¥x86-tsoä¸ºä¾‹">ä½¿ç”¨Litmuså·¥å…·åˆ†æžå†…å­˜ä¹±åº - ä»¥x86-TSOä¸ºä¾‹ &lt;a href="#%e4%bd%bf%e7%94%a8litmus%e5%b7%a5%e5%85%b7%e5%88%86%e6%9e%90%e5%86%85%e5%ad%98%e4%b9%b1%e5%ba%8f---%e4%bb%a5x86-tso%e4%b8%ba%e4%be%8b" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;p>åœ¨å¹¶å‘ç¼–ç¨‹ä¸­ï¼Œç†è§£å’ŒéªŒè¯å†…å­˜æ¨¡åž‹çš„è¡Œä¸ºå¯¹äºŽç¡®ä¿ç¨‹åºçš„æ­£ç¡®æ€§è‡³å…³é‡è¦ã€‚ä»¥ x86 Total Store Order (x86-TSO) ä¸ºä¾‹ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Litmus æµ‹è¯•å·¥å…·æ¥åˆ†æžå†…å­˜ä¹±åºçŽ°è±¡ï¼Œå¹¶äº†è§£å¦‚ä½•é€šè¿‡å†…å­˜å±éšœæ¥é¿å…è¿™ç§æƒ…å†µã€‚&lt;/p>
&lt;blockquote>
&lt;p>Litmuså·¥å…·å¯ä»¥åœ¨&lt;a href="https://developer.arm.com/herd7">è¿™é‡Œ&lt;/a>åœ¨çº¿è¯•ç”¨ï¼Œä¹Ÿå¯ä»¥å®‰è£…åˆ°æœ¬åœ°çŽ¯å¢ƒ&lt;/p>&lt;/blockquote>
&lt;h3 id="x86-total-store-order-x86-tso">x86 Total Store Order (x86-TSO) &lt;a href="#x86-total-store-order-x86-tso" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;p>&lt;img src="https://raw.githubusercontent.com/Wizmann/assets/master/wizmann-pic/24-09-01/1725159498577_mem-tso_1723970692408_0.png" alt="">&lt;/p>
&lt;p>åœ¨ x86 æž¶æž„ä¸­ï¼ŒStore Bufferï¼ˆå­˜å‚¨ç¼“å†²åŒºï¼‰ç”¨äºŽæš‚æ—¶å­˜æ”¾å¤„ç†å™¨çš„å†™æ“ä½œï¼Œè€Œä¸ç«‹å³å°†å…¶å†™å…¥ä¸»å­˜ã€‚è¿™ç§æœºåˆ¶æé«˜äº†å¤„ç†å™¨çš„æ€§èƒ½ï¼Œå› ä¸ºå®ƒå…è®¸å¤„ç†å™¨åœ¨å†™æ“ä½œå°šæœªå®Œæˆæ—¶ç»§ç»­æ‰§è¡ŒåŽç»­æŒ‡ä»¤ã€‚ç„¶è€Œï¼ŒStore Buffer ä¹Ÿå¯¼è‡´äº†æŸäº›å†…å­˜æ“ä½œçš„å¯è§æ€§é—®é¢˜ï¼Œç‰¹åˆ«æ˜¯åœ¨å¤šå¤„ç†å™¨çŽ¯å¢ƒä¸­ã€‚&lt;/p>
&lt;p>x86 Total Store Order (x86-TSO) æ¨¡åž‹çš„ç‰¹æ€§æ­£æ˜¯ç”±è¿™ç§ Store Buffer æœºåˆ¶å†³å®šçš„ã€‚ç”±äºŽå†™æ“ä½œåœ¨ Store Buffer ä¸­æš‚å­˜ï¼Œx86-TSO æ¨¡åž‹ä¿è¯äº†ä¸€äº›å…³é”®ç‰¹æ€§ï¼ŒåŒæ—¶ä¹Ÿåšå‡ºäº†ä¸€äº›åŸºäºŽæ€§èƒ½çš„å¦¥åï¼š&lt;/p>
&lt;ul>
&lt;li>å†™æ“ä½œé¡ºåºä¸€è‡´æ€§ï¼šæ‰€æœ‰å†™æ“ä½œæŒ‰ç…§ç¨‹åºçš„é¡ºåºæ‰§è¡Œï¼Œå¹¶å¯¹æ‰€æœ‰å¤„ç†å™¨å¯è§ï¼Œå³å†™æ“ä½œåœ¨ Store Buffer åˆ·æ–°åˆ°ä¸»å­˜ä¹‹å‰ï¼Œä¸ä¼šè¢«å…¶ä»–å¤„ç†å™¨çœ‹åˆ°ã€‚&lt;/li>
&lt;li>è¯»æ“ä½œçš„è‡ªæˆ‘å¯è§æ€§ï¼šå¤„ç†å™¨å¯ä»¥ç«‹å³çœ‹åˆ°è‡ªå·±åœ¨ Store Buffer ä¸­çš„æœ€æ–°å†™å…¥ï¼Œå³æœ¬å¤„ç†å™¨çš„è¯»æ“ä½œå¯ä»¥ä»Ž Store Buffer ä¸­è¯»å–æœªæäº¤åˆ°ä¸»å­˜çš„å€¼ã€‚&lt;/li>
&lt;li>é˜²æ­¢æŸäº›é‡æŽ’åºï¼šä¸ºäº†é¿å…å›  Store Buffer å¯¼è‡´çš„è¯»å†™ä¹±åºï¼Œx86-TSO ç¦æ­¢å†™æ“ä½œä¸Žå…¶åŽçš„è¯»æ“ä½œé‡æŽ’åºï¼Œç¡®ä¿è¯»å†™é¡ºåºä¸€è‡´ã€‚&lt;/li>
&lt;li>å…è®¸éƒ¨åˆ†è¯»æ“ä½œé‡æŽ’åºï¼šä¸ºäº†è¿›ä¸€æ­¥æå‡æ€§èƒ½ï¼Œå¤„ç†å™¨å…è®¸ä¸€äº›è¯»æ“ä½œçš„é‡æŽ’åºï¼Œä½†ä»ç„¶éµå¾ªä¸¥æ ¼çš„è§„åˆ™ä»¥ä¿è¯ç¨‹åºçš„æ­£ç¡®æ€§ã€‚&lt;/li>
&lt;/ul>
&lt;h3 id="ä½¿ç”¨-litmus-éªŒè¯-x86-çš„-storeload-ä¹±åº">ä½¿ç”¨ Litmus éªŒè¯ x86 çš„ StoreLoad ä¹±åº &lt;a href="#%e4%bd%bf%e7%94%a8-litmus-%e9%aa%8c%e8%af%81-x86-%e7%9a%84-storeload-%e4%b9%b1%e5%ba%8f" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Litmus å·¥å…·æ¥éªŒè¯åœ¨ x86-TSO å†…å­˜æ¨¡åž‹ä¸‹çš„ StoreLoad ä¹±åºè¡Œä¸ºã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªç¤ºä¾‹ä»£ç ï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code class="language-litmus" data-lang="litmus">X86 SB
{ x = 0; y = 0; }
P0 | P1 ;
MOV [y],$1 | MOV [x],$1 ;
MOV EAX,[x] | MOV EAX,[y] ;
exists
(0:EAX=0 /\ 1:EAX=0)
&lt;/code>&lt;/pre>&lt;p>åœ¨æ‰§è¡Œè¯¥ä»£ç åŽï¼ŒLitmus ä¼šç”Ÿæˆå››ç§å¯èƒ½çš„ç»“æžœï¼Œåˆ†åˆ«å¯¹åº”ä¸åŒçš„æ‰§è¡Œé¡ºåºã€‚&lt;/p>
&lt;h4 id="ç»“æžœ1">ç»“æžœ1 &lt;a href="#%e7%bb%93%e6%9e%9c1" class="anchor">ðŸ”—&lt;/a>&lt;/h4>&lt;p>&lt;img src="https://raw.githubusercontent.com/Wizmann/assets/master/wizmann-pic/24-09-01/1725159921512_graph3_1725095884015_0.png" alt="">&lt;/p>
&lt;p>åœ¨ç»“æžœ1ä¸­ï¼Œç¨‹åºæŒ‰ç…§ä¸¥æ ¼çš„é¡ºåºæ‰§è¡Œï¼Œæ¯ä¸ªå¤„ç†å™¨çš„å†…å­˜æ“ä½œé¡ºåºä¸Žç¨‹åºä¸­çš„é¡ºåºä¸€è‡´ã€‚&lt;/p>
&lt;p>å›¾ä¸­ï¼Œpoï¼ˆProgram Orderï¼‰è¡¨ç¤ºç¨‹åºé¡ºåºï¼Œrfï¼ˆReads-Fromï¼‰è¡¨ç¤ºæ¯ä¸ªè¯»æ“ä½œä»Žå“ªä¸ªå†™æ“ä½œä¸­è¯»å–çš„å€¼ã€‚ç”±äºŽå†…å­˜æ“ä½œæŒ‰ç…§é¢„æœŸé¡ºåºæ‰§è¡Œï¼Œè¿™ç§æƒ…å†µæ²¡æœ‰è¿›ä¸€æ­¥çš„ä¹±åºè¡Œä¸ºï¼Œå› æ­¤ä¸éœ€è¦è¿›ä¸€æ­¥åˆ†æž&lt;/p>
&lt;h4 id="ç»“æžœ2ç»“æžœ3">ç»“æžœ2/ç»“æžœ3 &lt;a href="#%e7%bb%93%e6%9e%9c2%e7%bb%93%e6%9e%9c3" class="anchor">ðŸ”—&lt;/a>&lt;/h4>&lt;p>&lt;img src="https://raw.githubusercontent.com/Wizmann/assets/master/wizmann-pic/24-09-01/1725160079968_graph1_1725098202554_0.png" alt="">
&lt;img src="https://raw.githubusercontent.com/Wizmann/assets/master/wizmann-pic/24-09-01/1725160089725_graph2_1725098310293_0.png" alt="">&lt;/p>
&lt;p>ç»“æžœ2å’Œç»“æžœ3æ˜¯å¯¹ç§°çš„ï¼Œè¡¨ç¤ºåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå†…å­˜çš„è¯»å–å‘ç”Ÿäº†â€œä¹±åºâ€ï¼Œå³è¯»å–æ“ä½œè¢«é‡æŽ’åˆ°äº†å†™å…¥æ“ä½œä¹‹å‰ã€‚åœ¨ Litmus ä¸­ï¼Œè¿™ç§æƒ…å†µè¢«æ ‡è®°ä¸º frï¼ˆFrom-Readï¼‰ï¼Œè¡¨ç¤ºä¸€ä¸ªå†™æ“ä½œè¦†ç›–äº†ä¸€ä¸ªè¯»æ“ä½œæ‰€è¯»å–çš„å€¼ï¼Œå³è¿™ä¸ªå†™æ“ä½œå‘ç”Ÿåœ¨è¯»æ“ä½œä¹‹åŽã€‚è¿™ç§â€œå†™è¯»â€æ“ä½œçš„ä¹±åºå¯èƒ½æ˜¯ç”±äºŽæ‰§è¡Œé¡ºåºçš„ä¸åŒï¼Œä¹Ÿå¯èƒ½æ˜¯å†…å­˜æ¨¡åž‹çš„é¡ºåºé€ æˆçš„ã€‚&lt;/p>
&lt;h4 id="ç»“æžœ4">ç»“æžœ4 &lt;a href="#%e7%bb%93%e6%9e%9c4" class="anchor">ðŸ”—&lt;/a>&lt;/h4>&lt;p>&lt;img src="https://raw.githubusercontent.com/Wizmann/assets/master/wizmann-pic/24-09-01/1725160171251_graph0_1725099005660_0.png" alt="">&lt;/p>
&lt;p>ç»“æžœ4è¡¨ç¤ºä¸¤ä¸ªçº¿ç¨‹å„è‡ªéƒ½å‘ç”Ÿäº† frï¼Œå³æ¯ä¸ªçº¿ç¨‹çš„è¯»æ“ä½œéƒ½è¢«é‡æŽ’åˆ°äº†å†™æ“ä½œä¹‹å‰ã€‚è¿™ç§æƒ…å†µå±•ç¤ºäº†æœ€å¤æ‚çš„ä¹±åºè¡Œä¸ºï¼Œå…¶ä¸­ä¸¤ä¸ªçº¿ç¨‹çš„è¯»æ“ä½œåˆ†åˆ«â€œè¶…è¶Šâ€äº†å„è‡ªçš„å†™æ“ä½œã€‚&lt;/p>
&lt;h3 id="ä½¿ç”¨å†…å­˜å±éšœmfenceæŒ‡ä»¤é¿å…å†…å­˜ä¹±åº">ä½¿ç”¨å†…å­˜å±éšœï¼ˆMFENCEï¼‰æŒ‡ä»¤é¿å…å†…å­˜ä¹±åº &lt;a href="#%e4%bd%bf%e7%94%a8%e5%86%85%e5%ad%98%e5%b1%8f%e9%9a%9cmfence%e6%8c%87%e4%bb%a4%e9%81%bf%e5%85%8d%e5%86%85%e5%ad%98%e4%b9%b1%e5%ba%8f" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;p>ä¸ºäº†é¿å…è¿™ç§ä¹±åºæƒ…å†µï¼Œå¯ä»¥ä½¿ç”¨ MFENCEï¼ˆMemory Fenceï¼‰ æŒ‡ä»¤ã€‚åœ¨ x86 æž¶æž„ä¸­ï¼ŒMFENCE æ˜¯ä¸€ç§å¼ºåˆ¶å†…å­˜å±éšœï¼Œç¡®ä¿æ‰€æœ‰åœ¨ MFENCE ä¹‹å‰çš„å†…å­˜æ“ä½œï¼ˆæ— è®ºæ˜¯è¯»è¿˜æ˜¯å†™ï¼‰åœ¨æ‰€æœ‰ MFENCE ä¹‹åŽçš„å†…å­˜æ“ä½œä¹‹å‰å®Œæˆã€‚è¿™æ„å‘³ç€åœ¨åŒä¸€çº¿ç¨‹å†…ï¼ŒMFENCE ä¿è¯äº†å†…å­˜æ“ä½œçš„é¡ºåºæ€§ï¼šMFENCE ä¹‹å‰çš„æ“ä½œå¯¹å…¶ä»–çº¿ç¨‹å¯è§åŽï¼Œæ‰å¯ä»¥æ‰§è¡Œ MFENCE ä¹‹åŽçš„æ“ä½œã€‚&lt;/p>
&lt;p>æˆ‘ä»¬å¯ä»¥å°† Litmus ä»£ç ä¿®æ”¹å¦‚ä¸‹ï¼Œä»¥æ’å…¥ MFENCE æŒ‡ä»¤ï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code class="language-litmus" data-lang="litmus">X86 SB
{ x = 0; y = 0; }
P0 | P1 ;
MOV [y],$1 | MOV [x],$1 ;
MFENCE | MFENCE ;
MOV EAX,[x] | MOV EAX,[y] ;
exists
(0:EAX=0 /\ 1:EAX=0)
&lt;/code>&lt;/pre>&lt;p>åœ¨åŠ å…¥å†…å­˜å±éšœåŽï¼Œæˆ‘ä»¬çœ‹åˆ°ç»“æžœ1åˆ°ç»“æžœ3ä¾ç„¶ä¼šå‡ºçŽ°ï¼Œä½†ç»“æžœ4å›  MFENCE çš„å­˜åœ¨è€Œè¢«é¿å…ã€‚é€šè¿‡ MFENCE ç¡®ä¿äº†å†…å­˜æ“ä½œçš„é¡ºåºæ€§ï¼Œä»Žè€Œé˜²æ­¢äº†æŸäº›ç±»åž‹çš„å†…å­˜ä¹±åºï¼Œä¿è¯äº†å¤šçº¿ç¨‹ç¨‹åºçš„æ­£ç¡®æ€§å’Œä¸€è‡´æ€§ã€‚&lt;/p>
&lt;h2 id="æŽ¥ä¸‹æ¥">æŽ¥ä¸‹æ¥&amp;hellip; &lt;a href="#%e6%8e%a5%e4%b8%8b%e6%9d%a5" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;p>ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬ä¼šä»‹ç»C++çš„å†…å­˜é¡ºåºæ¨¡åž‹ï¼Œå¹¶ä¸”åˆ†æžæ›´å¤æ‚çš„å†…å­˜ä¹±åºé—®é¢˜&lt;/p>
&lt;h2 id="references">References &lt;a href="#references" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;ul>
&lt;li>&lt;a href="https://colobu.com/2021/06/30/hwmm/">ç¡¬ä»¶å†…å­˜æ¨¡åž‹&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://book.douban.com/subject/36240082/">RISC-Vä½“ç³»ç»“æž„ç¼–ç¨‹ä¸Žå®žè·µ&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.microsoft.com/en-us/research/publication/make-multiprocessor-computer-correctly-executes-multiprocess-programs/">How to Make a Multiprocessor Computer That Correctly Executes Multiprocess Programs&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://dl.acm.org/doi/10.1145/285930.285991">Memory access buffering in multiprocessors&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.cl.cam.ac.uk/~pes20/weakmemory/tacas11.pdf">Litmus: Running Tests Against Hardware&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://developer.arm.com/herd7">Herd7 Simulator&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/0voice/dpdk_engineer_manual/blob/main/%E5%A4%A7%E4%BC%9APPT/NA%202021-Memory%20Model%20Simulation%20Tool%20-%20Herd7.pdf">Memory Model Simulation Tool - Herd7&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://community.arm.com/arm-community-blogs/b/architectures-and-processors-blog/posts/how-to-use-the-memory-model-tool#intuitively">A working example of how to use the herd7 Memory Model Tool&lt;/a>&lt;/li>
&lt;/ul>
&lt;div class="alert alert-info" role="alert">æœ¬æ–‡å¤§ï¼ˆåˆ’æŽ‰ï¼‰éƒ¨åˆ†å†…å®¹ç”±ChatGPT4ç”Ÿæˆ&lt;/div></description></item><item><title>CPUç¼“å­˜ä¸€è‡´æ€§ä¸Žå†…å­˜ä¸€è‡´æ€§ï¼ˆç¬¬ä¸€éƒ¨åˆ†-MESIåè®®ï¼‰</title><link>https://wizmann.top/posts/cache-coherence-and-memory-order/</link><pubDate>Mon, 18 Mar 2024 23:21:35 +0000</pubDate><guid>https://wizmann.top/posts/cache-coherence-and-memory-order/</guid><description>&lt;p>åœ¨å¯¹ç§°å¤šå¤„ç†ç³»ç»Ÿï¼ˆSymmetric Multiprocessing, SMPï¼‰ä¸­ï¼Œä¸€ä¸ªå˜é‡ï¼ˆæˆ–å†…å­˜ä½ç½®ï¼‰å¯ä»¥åŒæ—¶å­˜åœ¨äºŽå¤šä¸ªCPUçš„ç¼“å­˜è¡Œä¸­ã€‚ä¸ºäº†æä¾›å®Œç¾Žçš„ç”¨æˆ·çº§æŠ½è±¡ï¼Œä»»ä½•å¯¹ä¸€ä¸ªæˆ–å¤šä¸ªå˜é‡çš„ä¿®æ”¹éƒ½åº”è¯¥è¢«å¼ºåˆ¶åŒæ­¥ï¼Œä»¥ç¡®ä¿å…¶å®ƒCPUçš„ç¼“å­˜å¾—åˆ°æ›´æ–°ã€‚
ç„¶è€Œï¼Œåœ¨å®žçŽ°ä¸Šï¼Œç”±äºŽCPUä¹‹é—´é€šå¸¸é€šè¿‡æ€»çº¿äº’è”ï¼Œå®ƒä»¬ä¸èƒ½åŒæ—¶å¯¹å¤šä¸ªç¼“å­˜è¿›è¡Œå†™æ“ä½œã€‚&lt;/p>
&lt;h3 id="ç¼“å­˜ä¸€è‡´æ€§">ç¼“å­˜ä¸€è‡´æ€§ &lt;a href="#%e7%bc%93%e5%ad%98%e4%b8%80%e8%87%b4%e6%80%a7" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;p>ç¼“å­˜ä¸€è‡´æ€§æ˜¯æŒ‡åœ¨ä¸€ä¸ªå¤šå¤„ç†å™¨ç³»ç»Ÿä¸­ï¼Œç¡®ä¿å½“æŸä¸ªå¤„ç†å™¨ä¿®æ”¹äº†å­˜å‚¨åœ¨å…±äº«èµ„æºï¼ˆå¦‚ä¸»å†…å­˜æˆ–ç¼“å­˜ä¸­çš„æ•°æ®ï¼‰æ—¶ï¼Œå…¶ä»–å¤„ç†å™¨èƒ½å¤Ÿè®¿é—®åˆ°æœ€æ–°çš„æ•°æ®ç‰ˆæœ¬ï¼Œä»Žè€Œä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ã€‚&lt;/p>
&lt;p>ä¸ºäº†è¾¾åˆ°è¿™ä¸€ç›®æ ‡ï¼Œç¼“å­˜ä¸€è‡´æ€§æœºåˆ¶å¿…é¡»å¤„ç†ä¸¤ä¸ªä¸»è¦é—®é¢˜ï¼šå†™ä¼ æ’­ï¼ˆWrite Propagationï¼‰å’Œäº‹åŠ¡ä¸²è¡ŒåŒ–ï¼ˆTransaction Serializationï¼‰ã€‚&lt;/p>
&lt;p>å†™ä¼ æ’­ç¡®ä¿ä¸€ä¸ªå¤„ç†å™¨æ ¸å¿ƒçš„å†™æ“ä½œèƒ½è¢«ä¼ æ’­å¹¶è¢«å…¶ä»–å¤„ç†å™¨æ ¸å¿ƒæ‰€è§ã€‚è€Œäº‹åŠ¡ä¸²è¡ŒåŒ–åˆ™ç¡®ä¿æ‰€æœ‰å¤„ç†å™¨æ ¸å¿ƒçš„å†™æ“ä½œæŒ‰ç…§ä¸€å®šçš„é¡ºåºæ‰§è¡Œï¼Œå¯¹æ‰€æœ‰å¤„ç†å™¨æ ¸å¿ƒè€Œè¨€è¿™ä¸ªé¡ºåºæ˜¯ä¸€è‡´çš„ã€‚è¿™ä¸¤ä¸ªæœºåˆ¶å…±åŒå·¥ä½œï¼Œç¡®ä¿äº†å³ä½¿å¤šä¸ªCPUå¯èƒ½å¹¶å‘åœ°ä¿®æ”¹åŒä¸€ä»½æ•°æ®ï¼Œå®ƒä»¬ä¹Ÿèƒ½çœ‹åˆ°ä¸€è‡´çš„æ•°æ®è§†å›¾ã€‚&lt;/p>
&lt;h3 id="mesiåè®®">MESIåè®® &lt;a href="#mesi%e5%8d%8f%e8%ae%ae" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;p>ä¸ºäº†å®žçŽ°ç¼“å­˜ä¸€è‡´æ€§ï¼Œå¤šç§åè®®å’Œæœºåˆ¶è¢«è®¾è®¡å‡ºæ¥ï¼Œå…¶ä¸­MESIåè®®æ˜¯æœ€å¹¿æ³›ä½¿ç”¨çš„ä¸€ç§æœºåˆ¶ã€‚&lt;/p>
&lt;blockquote>
&lt;p>å®žé™…ä¸Šï¼ŒAMDå¤„ç†å™¨ä½¿ç”¨çš„æ˜¯MOESIåè®®ï¼ŒIntelå¤„ç†å™¨ä½¿ç”¨çš„æ˜¯MESIFåè®®ã€‚è¿™ä¸¤ç§åè®®éƒ½æ˜¯MESIåè®®çš„å˜ç§ã€‚è¿™é‡Œä¸å±•å¼€è®¨è®ºã€‚&lt;/p>&lt;/blockquote>
&lt;p>MESI åè®®é€šè¿‡å®šä¹‰ç¼“å­˜è¡Œçš„å››ç§çŠ¶æ€â€”â€”ä¿®æ”¹ï¼ˆModifiedï¼‰ã€ç‹¬å ï¼ˆExclusiveï¼‰ã€å…±äº«ï¼ˆSharedï¼‰å’Œæ— æ•ˆï¼ˆInvalidï¼‰ï¼Œç®¡ç†å¤šä¸ªå¤„ç†å™¨ç¼“å­˜ä¹‹é—´çš„ä¸€è‡´æ€§ã€‚çŠ¶æ€ä¹‹é—´çš„è½¬æ¢å—åˆ°ç¼“å­˜åè®®æŽ§åˆ¶ï¼Œä»¥ç¡®ä¿æ•°æ®çš„ä¸€è‡´æ€§å’ŒåŒæ­¥ã€‚&lt;/p>
&lt;ul>
&lt;li>ç‹¬å ï¼ˆExclusive, Eï¼‰ï¼šç¼“å­˜è¡Œä»…å­˜åœ¨äºŽå½“å‰ç¼“å­˜ä¸­ï¼Œå¹¶ä¸”æ˜¯å¹²å‡€çš„ï¼ˆå³ç¼“å­˜æ•°æ®ä¸Žä¸»å­˜æ•°æ®ä¸€è‡´ï¼‰ã€‚å½“å…¶ä»–ç¼“å­˜å°è¯•è¯»å–è¯¥æ•°æ®æ—¶ï¼ŒçŠ¶æ€è½¬å˜ä¸ºå…±äº«ï¼›å½“å‰ç¼“å­˜å†™å…¥æ•°æ®æ—¶ï¼Œè½¬å˜ä¸ºå·²ä¿®æ”¹çŠ¶æ€&lt;/li>
&lt;li>å…±äº«ï¼ˆShared, Sï¼‰ï¼šç¼“å­˜è¡ŒåŒæ—¶å­˜åœ¨äºŽå…¶ä»–ç¼“å­˜ä¸­ï¼Œå¹¶ä¸”æ˜¯å¹²å‡€çš„ã€‚è¯¥ç¼“å­˜è¡Œå¯ä»¥åœ¨ä»»æ„æ—¶åˆ»è¢«æŠ›å¼ƒ&lt;/li>
&lt;li>å·²ä¿®æ”¹ï¼ˆModified, Mï¼‰ï¼šç¼“å­˜è¡Œçš„æ•°æ®æ˜¯â€œè„â€çš„ï¼ˆå³ä¸Žä¸»å­˜çš„å€¼ä¸åŒï¼‰ã€‚å¦‚æžœå…¶ä»– CPU æ ¸å¿ƒéœ€è¦è¯»å–è¿™å—æ•°æ®ï¼Œè¯¥ç¼“å­˜è¡Œå¿…é¡»å…ˆå›žå†™åˆ°ä¸»å­˜ï¼Œç„¶åŽçŠ¶æ€è½¬å˜ä¸ºå…±äº«&lt;/li>
&lt;li>æ— æ•ˆï¼ˆInvalid, Iï¼‰ï¼šè¡¨ç¤ºè¯¥ç¼“å­˜è¡Œæ— æ•ˆï¼Œå³ä¸ºç©ºã€‚ä¸Šæ–‡æåˆ°çš„ç¼“å­˜ç­–ç•¥ä¼šä¼˜å…ˆå¡«å……æ— æ•ˆè¡Œ&lt;/li>
&lt;/ul>
&lt;p>ç®€å•æ¥è¯´ï¼ŒMESIçš„è®¾è®¡ç›®æ ‡åœ¨äºŽï¼š&lt;/p>
&lt;ol>
&lt;li>é˜²æ­¢å¤šä¸ªå¤„ç†å™¨æ ¸å¿ƒåŒæ—¶å¯¹å…±äº«æ•°æ®è¿›è¡Œä¿®æ”¹ã€‚ä»»ä½•éœ€è¦ä¿®æ”¹å…±äº«æ•°æ®çš„æ ¸å¿ƒéƒ½ä¼šå…ˆå‘å‡ºRFOï¼ˆRead For Ownershipï¼‰è¯·æ±‚æ¥èŽ·å–è¯¥ç¼“å­˜å—çš„æ‰€æœ‰æƒï¼Œå¹¶ä½¿å…¶ä»–å¤„ç†å™¨æ ¸å¿ƒä¸­çš„ç›¸åº”ç¼“å­˜å—å˜ä¸ºæ— æ•ˆã€‚&lt;/li>
&lt;li>é€šè¿‡æŽ¨è¿Ÿå†™å›žæ“ä½œæ¥å‡å°‘å¯¹å†…å­˜çš„é¢‘ç¹ä¿®æ”¹ï¼Œç¡®ä¿åªæœ‰åœ¨å¿…è¦æ—¶æ‰å°†ç¼“å­˜ä¸­çš„æ›´æ”¹å†™å›žå†…å­˜ã€‚&lt;/li>
&lt;/ol>
&lt;h3 id="mesi-çš„çŠ¶æ€è½¬ç§»">MESI çš„çŠ¶æ€è½¬ç§» &lt;a href="#mesi-%e7%9a%84%e7%8a%b6%e6%80%81%e8%bd%ac%e7%a7%bb" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;p>MESI åè®®çš„çŠ¶æ€è½¬ç§»å¦‚ä¸‹ï¼š&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/Wizmann/assets/master/wizmann-pic/24-03-31/1711876193915_Diagrama_MESI.gif" alt="">&lt;/p>
&lt;ul>
&lt;li>ä»Žæ— æ•ˆï¼ˆIï¼‰åˆ°ç‹¬å ï¼ˆEï¼‰ï¼šå½“ CPU éœ€è¦å†™å…¥ä¸€ä¸ªç¼“å­˜è¡Œè€Œè¯¥è¡Œå½“å‰çŠ¶æ€ä¸ºæ— æ•ˆæ—¶ï¼Œå¦‚æžœå…¶ä»– CPU ç¼“å­˜ä¸­æ²¡æœ‰è¯¥ç¼“å­˜è¡Œçš„å‰¯æœ¬ï¼Œè¯¥è¡ŒçŠ¶æ€å˜ä¸ºç‹¬å ã€‚è¿™è¡¨æ˜Žå½“å‰ CPU ç¼“å­˜ä¸­çš„æ•°æ®æ˜¯æœ€æ–°çš„ï¼Œä¸”æ²¡æœ‰å…¶ä»–å‰¯æœ¬å­˜åœ¨&lt;/li>
&lt;li>ä»Žæ— æ•ˆï¼ˆIï¼‰åˆ°å…±äº«ï¼ˆSï¼‰ï¼šå½“ CPU éœ€è¦è¯»å–ä¸€ä¸ªç¼“å­˜è¡Œè€Œè¯¥è¡Œå½“å‰çŠ¶æ€ä¸ºæ— æ•ˆæ—¶ï¼Œå¦‚æžœå…¶ä»– CPU ç¼“å­˜ä¸­å­˜åœ¨è¯¥ç¼“å­˜è¡Œçš„å‰¯æœ¬ï¼Œåˆ™è¯¥è¡ŒçŠ¶æ€å˜ä¸ºå…±äº«&lt;/li>
&lt;li>ä»Žå…±äº«ï¼ˆSï¼‰åˆ°ç‹¬å ï¼ˆEï¼‰ï¼šå½“ä¸€ä¸ª CPU æƒ³è¦å†™å…¥ä¸€ä¸ªå¤„äºŽå…±äº«çŠ¶æ€çš„ç¼“å­˜è¡Œæ—¶ï¼Œå¿…é¡»é¦–å…ˆèŽ·å–å…¶ä»–æ‰€æœ‰ CPU ä¸Šè¯¥ç¼“å­˜è¡Œçš„ç‹¬å è®¿é—®æƒï¼Œå¦‚æžœæˆåŠŸï¼Œè¯¥ç¼“å­˜è¡ŒçŠ¶æ€å˜ä¸ºç‹¬å &lt;/li>
&lt;li>ä»Žç‹¬å ï¼ˆEï¼‰åˆ°ä¿®æ”¹ï¼ˆMï¼‰ï¼šå½“ CPU å¯¹å¤„äºŽç‹¬å çŠ¶æ€çš„ç¼“å­˜è¡Œè¿›è¡Œå†™æ“ä½œæ—¶ï¼Œè¯¥ç¼“å­˜è¡ŒçŠ¶æ€å˜ä¸ºä¿®æ”¹ã€‚è¿™è¡¨ç¤ºæ•°æ®å·²è¢«å½“å‰ CPU ä¿®æ”¹ï¼Œä¸”ä¸Žä¸»å­˜ä¸åŒæ­¥&lt;/li>
&lt;li>ä»Žä¿®æ”¹ï¼ˆMï¼‰åˆ°å…±äº«ï¼ˆSï¼‰ï¼šå½“å…¶ä»– CPU è¯·æ±‚è¯»å–å¤„äºŽä¿®æ”¹çŠ¶æ€çš„ç¼“å­˜è¡Œæ—¶ï¼Œå½“å‰ CPU å¿…é¡»å°†è¯¥ç¼“å­˜è¡Œçš„æ•°æ®å†™å›žä¸»å­˜ï¼Œå¹¶å°†ç¼“å­˜è¡ŒçŠ¶æ€æ”¹ä¸ºå…±äº«ï¼Œä»¥ä¾¿å…¶ä»– CPU å¯ä»¥è¯»å–æœ€æ–°æ•°ã€‚&lt;/li>
&lt;li>ä»Žä»»ä½•çŠ¶æ€åˆ°æ— æ•ˆï¼ˆIï¼‰ï¼šå½“ CPU æŽ¥æ”¶åˆ°å…¶ä»– CPU å‘å‡ºçš„æ— æ•ˆåŒ–è¯·æ±‚æ—¶ï¼Œå¦‚æžœå½“å‰ CPU ç¼“å­˜ä¸­æœ‰è¯¥ç¼“å­˜è¡Œçš„å‰¯æœ¬ï¼Œä¸è®ºå®ƒå¤„äºŽä½•ç§çŠ¶æ€ï¼Œéƒ½å¿…é¡»å°†å…¶æ ‡è®°ä¸ºæ— æ•ˆã€‚è¿™é€šå¸¸å‘ç”Ÿåœ¨å…¶ä»– CPU æƒ³è¦å†™å…¥åŒä¸€ç¼“å­˜è¡Œçš„æƒ…å†µä¸‹&lt;/li>
&lt;/ul>
&lt;blockquote>
&lt;p>å¯ä»¥ä½¿ç”¨è¿™ä¸ª&lt;a href="https://www.scss.tcd.ie/Jeremy.Jones/VivioJS/caches/MESI.htm">ç®€å•çš„æ¨¡æ‹Ÿå™¨&lt;/a>æ¥æ¨¡æ‹ŸMESIåè®®çš„å·¥ä½œçŠ¶æ€&lt;/p>&lt;/blockquote>
&lt;h3 id="mesiçš„ä¼˜åŒ–">MESIçš„ä¼˜åŒ– &lt;a href="#mesi%e7%9a%84%e4%bc%98%e5%8c%96" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;p>éšç€å¤šæ ¸å¤„ç†å™¨çš„æ™®åŠå’Œç³»ç»Ÿå¤æ‚åº¦çš„å¢žåŠ ï¼ŒMESIåè®®é¢ä¸´ç€æ€§èƒ½ç“¶é¢ˆå’Œæ•ˆçŽ‡é—®é¢˜ã€‚å› æ­¤ï¼Œä¸ºäº†æé«˜ç³»ç»Ÿæ€§èƒ½å’Œç¼©çŸ­å“åº”æ—¶é—´ï¼Œå¯¹MESIåè®®çš„ä¼˜åŒ–å˜å¾—éžå¸¸å¿…è¦ã€‚&lt;/p>
&lt;h4 id="å†™ç¼“å†²åŒºstore-bufferæœºåˆ¶">å†™ç¼“å†²åŒºï¼ˆStore Bufferï¼‰æœºåˆ¶ &lt;a href="#%e5%86%99%e7%bc%93%e5%86%b2%e5%8c%bastore-buffer%e6%9c%ba%e5%88%b6" class="anchor">ðŸ”—&lt;/a>&lt;/h4>&lt;p>åœ¨è¿›è¡Œå†™å…¥æ“ä½œæ—¶ï¼Œä¸€ä¸ªCPUæ ¸å¿ƒï¼ˆä¾‹å¦‚æ ¸å¿ƒ1ï¼‰é¦–å…ˆéœ€è¦å¹¿æ’­ä¸€ä¸ªè¯»å–ä¸ºäº†å†™å…¥ï¼ˆRead For Ownershipï¼ŒRFOï¼‰è¯·æ±‚ï¼Œä»¥èŽ·å¾—å¯¹åº”æ•°æ®çš„ç‹¬å è®¿é—®æƒã€‚åœ¨ç­‰å¾…å…¶ä»–æ ¸å¿ƒå“åº”æ­¤è¯·æ±‚å¹¶å‘é€å›žç¡®è®¤ä¿¡å·ï¼ˆACKï¼‰æœŸé—´ï¼Œæ ¸å¿ƒ1åŽŸæœ¬éœ€è¦ç©ºé—²ç­‰å¾…ï¼Œè¿™æ— ç–‘æ˜¯å¯¹CPUèµ„æºçš„ä¸€ç§æµªè´¹ã€‚&lt;/p>
&lt;p>ä¸ºäº†æé«˜æ•ˆçŽ‡ï¼ŒçŽ°ä»£CPUè®¾è®¡äº†â€œå†™ç¼“å†²åŒºâ€æœºåˆ¶ã€‚é€šè¿‡è¿™ç§æœºåˆ¶ï¼Œå½“æ ¸å¿ƒ1å‘å‡ºRFOè¯·æ±‚å¹¶å°†å†™å…¥æ“ä½œæ”¾å…¥å†™ç¼“å†²åŒºåŽï¼Œå®ƒå¯ä»¥ç«‹å³ç»§ç»­æ‰§è¡Œå…¶ä»–ä»»åŠ¡ï¼Œè€Œä¸éœ€è¦ç­‰å¾…ACKçš„åˆ°æ¥ã€‚ä¸€æ—¦æ”¶åˆ°ACKï¼ŒCPUå†ä»Žå†™ç¼“å†²åŒºä¸­å–å‡ºå†™å…¥æ“ä½œï¼Œå®žé™…å†™å…¥åˆ°ç¼“å­˜ä¸­ã€‚è¿™æ ·ä¸ä»…ä¼˜åŒ–äº†CPUçš„å·¥ä½œæµç¨‹ï¼Œè¿˜æå‡äº†å¤„ç†å™¨çš„æ•´ä½“æ•ˆèƒ½ã€‚&lt;/p>
&lt;h4 id="å¤±æ•ˆé˜Ÿåˆ—invalidation-queue">å¤±æ•ˆé˜Ÿåˆ—ï¼ˆInvalidation Queueï¼‰ &lt;a href="#%e5%a4%b1%e6%95%88%e9%98%9f%e5%88%97invalidation-queue" class="anchor">ðŸ”—&lt;/a>&lt;/h4>&lt;p>ä¸ºäº†è§£å†³æ ¸å¿ƒåœ¨å¿™ç¢Œæ—¶æ— æ³•åŠæ—¶å“åº”RFOè¯·æ±‚çš„é—®é¢˜ï¼ŒçŽ°ä»£CPUå¼•å…¥äº†â€œå¤±æ•ˆé˜Ÿåˆ—â€æœºåˆ¶ã€‚æ”¶åˆ°çš„RFOè¯·æ±‚è¢«æ”¾å…¥å¤±æ•ˆé˜Ÿåˆ—ï¼Œå¹¶ç«‹å³å‘é€å›žACKï¼Œå¾…æ ¸å¿ƒå®Œæˆæ‰‹å¤´ä¸Šçš„ä»»åŠ¡åŽï¼Œå†å¤„ç†å¤±æ•ˆé˜Ÿåˆ—ä¸­çš„è¯·æ±‚ã€‚è¿™ç§è®¾è®¡æœ‰æ•ˆåœ°ç¼©çŸ­äº†ç­‰å¾…æ—¶é—´ï¼ŒåŠ é€Ÿäº†æ•°æ®åŒæ­¥è¿‡ç¨‹ã€‚&lt;/p>
&lt;h3 id="mesiçš„æ½œåœ¨é—®é¢˜">MESIçš„æ½œåœ¨é—®é¢˜ &lt;a href="#mesi%e7%9a%84%e6%bd%9c%e5%9c%a8%e9%97%ae%e9%a2%98" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;h4 id="false-sharing">False Sharing &lt;a href="#false-sharing" class="anchor">ðŸ”—&lt;/a>&lt;/h4>&lt;p>ç”±äºŽCPUä»¥64Bçš„Cache Lineä¸ºæœ€å°å•ä½ä»Žå†…å­˜ä¸­åŠ è½½æ•°æ®ï¼Œå¯èƒ½ä¼šå‡ºçŽ°è¿™æ ·çš„é—®é¢˜ï¼š&lt;/p>
&lt;p>å‡è®¾å˜é‡aå’Œbä½äºŽåŒä¸€ä¸ªCache Lineä¸­ï¼Œå½“å‰CPU0å’ŒCPU1éƒ½å°†è¿™ä¸ªCache LineåŠ è½½åˆ°Cacheï¼ŒCPU0åªä¿®æ”¹å˜é‡aï¼ŒCPU1åªè¯»å–å˜é‡bã€‚å½“CPU0ä¿®æ”¹aæ—¶ï¼ŒCPU1çš„Cache Lineä¼šå˜ä¸ºInvalidçŠ¶æ€ï¼Œå³ä½¿CPU1å¹¶æ²¡æœ‰ä¿®æ”¹bï¼Œè¿™ä¼šå¯¼è‡´CPU1ä»Žå†…å­˜æˆ–å…¶å®ƒæ ¸å¿ƒé‡æ–°åŠ è½½Cache Lineä¸­çš„æ‰€æœ‰å˜é‡ï¼Œå½±å“æ€§èƒ½ã€‚è¿™å°±æ˜¯False Sharingã€‚&lt;/p>
&lt;p>è§£å†³False Sharingçš„å¸¸ç”¨æ–¹æ³•æ˜¯è¿›è¡Œå­—èŠ‚å¡«å……ï¼Œåœ¨aå’Œbä¹‹é—´å¡«å……æ— æ„ä¹‰çš„å˜é‡ï¼Œä½¿ä¸€ä¸ªå˜é‡å•ç‹¬å ç”¨ä¸€ä¸ªCache Lineã€‚&lt;/p>
&lt;h4 id="rmwæ“ä½œ">RMWæ“ä½œ &lt;a href="#rmw%e6%93%8d%e4%bd%9c" class="anchor">ðŸ”—&lt;/a>&lt;/h4>&lt;p>åœ¨å¹¶å‘ç¼–ç¨‹ä¸­ï¼Œè¯»-æ”¹-å†™ï¼ˆRMWï¼‰æ“ä½œï¼Œå¦‚æ¯”è¾ƒå¹¶äº¤æ¢ï¼ˆCASï¼‰å’ŒåŽŸå­åŠ ï¼ˆADDï¼‰ï¼Œéœ€ä½œä¸ºå•ä¸€çš„åŽŸå­æ“ä½œæ‰§è¡Œä»¥é¿å…æ•°æ®ç«žäº‰ã€‚&lt;/p>
&lt;p>å°½ç®¡MESIç¼“å­˜ä¸€è‡´æ€§åè®®ç¡®ä¿äº†å¤„ç†å™¨æ ¸å¿ƒé—´ç¼“å­˜è¡ŒçŠ¶æ€çš„ä¸€è‡´æ€§ï¼Œå®ƒå¹¶ä¸è§£å†³æ“ä½œçš„åŽŸå­æ€§é—®é¢˜ã€‚åœ¨RMWæ“ä½œä¸­ï¼Œç”±äºŽä»Žè¯»å–åˆ°å†™å›žçš„æ—¶é—´çª—å£å†…å¯èƒ½å‘ç”Ÿå…¶ä»–å¤„ç†å™¨çš„å¹²é¢„ä¿®æ”¹ï¼Œå¯èƒ½å¯¼è‡´æ•°æ®ç«žäº‰å’ŒçŠ¶æ€ä¸ä¸€è‡´ã€‚&lt;/p>
&lt;p>åœ¨ä¸ºæ­¤ï¼Œ&lt;code>LOCK&lt;/code>æŒ‡ä»¤è¢«ç”¨æ¥ç¡®ä¿RMWæ“ä½œçš„åŽŸå­æ€§ï¼Œé€šè¿‡é”å®šæ“ä½œæ¶‰åŠçš„ç¼“å­˜è¡Œï¼Œé˜²æ­¢åœ¨æ“ä½œå®Œæˆå‰è¢«å…¶ä»–å¤„ç†å™¨è®¿é—®ï¼Œä»Žè€Œæœ‰æ•ˆåœ°è§£å†³äº†æ•°æ®ç«žäº‰é—®é¢˜ï¼Œä¿éšœäº†æ“ä½œçš„å®‰å…¨æ€§å’Œæ•°æ®çš„ä¸€è‡´æ€§ã€‚&lt;/p>
&lt;h4 id="å†™ç¼“å†²åŒºstore-bufferä¼˜åŒ–å¸¦æ¥çš„æ½œåœ¨é—®é¢˜">å†™ç¼“å†²åŒºï¼ˆStore Bufferï¼‰ä¼˜åŒ–å¸¦æ¥çš„æ½œåœ¨é—®é¢˜ &lt;a href="#%e5%86%99%e7%bc%93%e5%86%b2%e5%8c%bastore-buffer%e4%bc%98%e5%8c%96%e5%b8%a6%e6%9d%a5%e7%9a%84%e6%bd%9c%e5%9c%a8%e9%97%ae%e9%a2%98" class="anchor">ðŸ”—&lt;/a>&lt;/h4>&lt;p>å†™ç¼“å†²åŒºå¸¦æ¥çš„æœ€ä¸»è¦çš„é—®é¢˜æ˜¯ä¸Žå…¶ä»–æ ¸å¿ƒçš„æ•°æ®ä¸€è‡´æ€§é—®é¢˜ã€‚ç”±äºŽå†™æ“ä½œè¢«å»¶è¿Ÿæ‰§è¡Œï¼Œå…¶ä»–æ ¸å¿ƒå¯èƒ½åœ¨è¿™æ®µæ—¶é—´å†…è¯»å–åˆ°äº†æ—§çš„æ•°æ®å€¼ï¼Œä»Žè€Œå¯¼è‡´æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ã€‚æ­¤å¤–ï¼Œå†™ç¼“å†²åŒºå¯èƒ½å¯¼è‡´å†…å­˜é¡ºåºçš„é—®é¢˜ï¼Œå³ç¼–å†™çš„ç¨‹åºé€»è¾‘ä¸Žå®žé™…æ‰§è¡Œé€»è¾‘ä¸ç¬¦ã€‚&lt;/p>
&lt;h4 id="å¤±æ•ˆé˜Ÿåˆ—invalidation-queueå¸¦æ¥çš„æ½œåœ¨é—®é¢˜">å¤±æ•ˆé˜Ÿåˆ—ï¼ˆInvalidation Queueï¼‰å¸¦æ¥çš„æ½œåœ¨é—®é¢˜ &lt;a href="#%e5%a4%b1%e6%95%88%e9%98%9f%e5%88%97invalidation-queue%e5%b8%a6%e6%9d%a5%e7%9a%84%e6%bd%9c%e5%9c%a8%e9%97%ae%e9%a2%98" class="anchor">ðŸ”—&lt;/a>&lt;/h4>&lt;p>å¤±æ•ˆé˜Ÿåˆ—æé«˜äº†å“åº”é€Ÿåº¦ï¼Œä½†å®ƒä¹Ÿå¯èƒ½å¼•å…¥æ–°çš„é—®é¢˜ã€‚å¤±æ•ˆé˜Ÿåˆ—å…è®¸CPUæ ¸å¿ƒåœ¨ç¡®è®¤æŽ¥æ”¶åˆ°å¤±æ•ˆè¯·æ±‚åŽï¼Œå»¶è¿Ÿå¤„ç†è¿™äº›è¯·æ±‚ã€‚è¿™ç§å»¶è¿Ÿå¯èƒ½å¯¼è‡´æ•°æ®åœ¨ä¸åŒæ ¸å¿ƒé—´çš„ä¸€è‡´æ€§é—®é¢˜ï¼Œå³ä¸€ä¸ªæ ¸å¿ƒå¯èƒ½ä¼šåœ¨çŸ­æ—¶é—´å†…ç»§ç»­ä½¿ç”¨å·²ç»å¤±æ•ˆçš„æ•°æ®ï¼Œè€Œè¿™æ®µæ—¶é—´å†…å…¶ä»–æ ¸å¿ƒå·²ç»ä¿®æ”¹äº†è¿™éƒ¨åˆ†æ•°æ®ã€‚&lt;/p>
&lt;h2 id="å‚è€ƒé“¾æŽ¥">å‚è€ƒé“¾æŽ¥ &lt;a href="#%e5%8f%82%e8%80%83%e9%93%be%e6%8e%a5" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;ul>
&lt;li>&lt;a href="https://zh.wikipedia.org/wiki/MESI%E5%8D%8F%E8%AE%AE">MESIåè®®&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/LeoYang90/Golang-Internal-Notes/blob/master/Go%20%E5%86%85%E5%AD%98%E4%B8%80%E8%87%B4%E6%80%A7%E6%A8%A1%E5%9E%8B.md#go-%E5%86%85%E5%AD%98%E4%B8%80%E8%87%B4%E6%80%A7%E6%A8%A1%E5%9E%8B">Go å†…å­˜ä¸€è‡´æ€§æ¨¡åž‹&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://juejin.cn/post/7158395475362578462">12 å¼ å›¾çœ‹æ‡‚ CPU ç¼“å­˜ä¸€è‡´æ€§ä¸Ž MESI åè®®ï¼ŒçœŸçš„ä¸€è‡´å—ï¼Ÿ&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://wudaijun.com/2019/04/cache-coherence-and-memory-consistency/">Cacheä¸€è‡´æ€§å’Œå†…å­˜ä¸€è‡´æ€§&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://blog.chongsheng.art/post/golang/cpu-cache-memory-barrier/">CPUç¼“å­˜æž¶æž„åˆ°å†…å­˜å±éšœ&lt;/a>&lt;/li>
&lt;/ul>
&lt;div class="alert alert-info" role="alert">æœ¬æ–‡å¤§ï¼ˆåˆ’æŽ‰ï¼‰éƒ¨åˆ†å†…å®¹ç”±ChatGPT4ç”Ÿæˆ&lt;/div></description></item><item><title>å†…å­˜å±éšœåˆæŽ¢</title><link>https://wizmann.top/posts/read-paper-barrier/</link><pubDate>Thu, 08 May 2014 19:05:26 +0000</pubDate><guid>https://wizmann.top/posts/read-paper-barrier/</guid><description>&lt;h2 id="åŽŸæ–‡åœ°å€">åŽŸæ–‡åœ°å€ &lt;a href="#%e5%8e%9f%e6%96%87%e5%9c%b0%e5%9d%80" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;p>&lt;a href="http://ridiculousfish.com/blog/posts/barrier.html">Barrier February 17th, 2007&lt;/a>&lt;/p>
&lt;h2 id="å‰è¨€å¤šæ ¸æ—¶ä»£çš„æŒ‘æˆ˜">å‰è¨€ï¼šå¤šæ ¸æ—¶ä»£çš„æŒ‘æˆ˜ &lt;a href="#%e5%89%8d%e8%a8%80%e5%a4%9a%e6%a0%b8%e6%97%b6%e4%bb%a3%e7%9a%84%e6%8c%91%e6%88%98" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;p>å°½ç®¡80æ ¸å¿ƒçš„æµ®ç‚¹è¿ç®—å·¨å…½ä»ç„¶é¥ä¸å¯åŠï¼Œå¤šæ ¸å¤„ç†å™¨çš„æ—¶ä»£å·²ç»åˆ°æ¥ã€‚å¤šæ ¸å¤„ç†å™¨çš„æ¦‚å¿µå¹¶éžæ–°é²œäº‹ç‰©ï¼Œåœ¨Power Macintosh 9500ä¸­å°±å·²ç»é‡‡ç”¨äº†å¤šæ ¸å¤„ç†å™¨æŠ€æœ¯ã€‚çŽ°åœ¨ï¼Œè®©æˆ‘ä»¬æ·±å…¥ç†è§£å¤šæ ¸å¤„ç†å™¨çš„å†…åœ¨æœºåˆ¶ã€‚&lt;/p>
&lt;h2 id="çº¿ç¨‹æŠ€æœ¯æŽ¢è®¨">çº¿ç¨‹æŠ€æœ¯æŽ¢è®¨ &lt;a href="#%e7%ba%bf%e7%a8%8b%e6%8a%80%e6%9c%af%e6%8e%a2%e8%ae%a8" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;h3 id="åè¯è§£é‡Š">åè¯è§£é‡Š &lt;a href="#%e5%90%8d%e8%af%8d%e8%a7%a3%e9%87%8a" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;h4 id="çº¿ç¨‹">çº¿ç¨‹ &lt;a href="#%e7%ba%bf%e7%a8%8b" class="anchor">ðŸ”—&lt;/a>&lt;/h4>&lt;p>çº¿ç¨‹æ˜¯ä¸€ç§æ‹¥æœ‰å…±äº«åœ°å€ç©ºé—´çš„ã€èƒ½è¢«æŠ¢å å¼è°ƒåº¦çš„æ‰§è¡Œä¸Šä¸‹æ–‡ã€‚&lt;/p>
&lt;h4 id="å¤šçº¿ç¨‹">å¤šçº¿ç¨‹ &lt;a href="#%e5%a4%9a%e7%ba%bf%e7%a8%8b" class="anchor">ðŸ”—&lt;/a>&lt;/h4>&lt;p>å¤šçº¿ç¨‹æ˜¯ä¸€ç§ç”¨äºŽç®€åŒ–æŽ§åˆ¶æµã€ç»•è¿‡é˜»å¡žç³»ç»Ÿè°ƒç”¨çš„æ–¹æ³•ï¼Œå¹¶ä¸ä¸“é—¨ç”¨äºŽå®žçŽ°ç¨‹åºçš„å¹¶è¡ŒåŒ–ã€‚&lt;/p>
&lt;h4 id="å¹¶å‘å¤šçº¿ç¨‹">å¹¶å‘å¤šçº¿ç¨‹ &lt;a href="#%e5%b9%b6%e5%8f%91%e5%a4%9a%e7%ba%bf%e7%a8%8b" class="anchor">ðŸ”—&lt;/a>&lt;/h4>&lt;p>ç‰©ç†ä¸Šå¹¶è¡Œæ‰§è¡Œçš„çº¿ç¨‹ï¼Œæ—¨åœ¨é€šè¿‡åˆ©ç”¨å¤šæ ¸å¤„ç†å™¨ä¼˜åŒ–ç³»ç»Ÿæ€§èƒ½ã€‚&lt;/p>
&lt;h3 id="å¹¶å‘å¤šçº¿ç¨‹çš„æŒ‘æˆ˜">â€œå¹¶å‘å¤šçº¿ç¨‹â€çš„æŒ‘æˆ˜ &lt;a href="#%e5%b9%b6%e5%8f%91%e5%a4%9a%e7%ba%bf%e7%a8%8b%e7%9a%84%e6%8c%91%e6%88%98" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;p>å°½ç®¡å¹¶å‘å¤šçº¿ç¨‹è¢«å¹¿æ³›è®¨è®ºï¼Œå…¶æŒ‘æˆ˜å¹¶éžæºè‡ªè‡ªç„¶åŽŸå› ï¼Œè€Œæ˜¯æˆ‘ä»¬è‡ªå·±çš„è®¾è®¡é€‰æ‹©æ‰€é€ æˆçš„ã€‚ä¸»è¦é—®é¢˜åœ¨äºŽï¼Œé’ˆå¯¹å•çº¿ç¨‹ç¨‹åºçš„è¿‡åº¦ä¼˜åŒ–åœ¨å¤šçº¿ç¨‹çŽ¯å¢ƒä¸­ä¸å†é€‚ç”¨ã€‚&lt;/p>
&lt;p>å…·ä½“æ¥è¯´ï¼Œç”±äºŽCPUçš„æ‰§è¡Œé€Ÿåº¦è¿œè¶…å†…å­˜å“åº”é€Ÿåº¦ï¼Œæˆ‘ä»¬å¼€å§‹å¯¹å†…å­˜å†…å®¹è¿›è¡Œâ€œé¢„æµ‹â€ï¼Œä»Žè€Œé¿å…CPUç­‰å¾…å†…å­˜æ£€æŸ¥ã€‚è¿™é‡Œçš„â€œé¢„æµ‹â€å®žé™…ä¸Šæ˜¯CPUå’Œç¼–è¯‘å™¨å¯¹å†…å­˜çŠ¶æ€åšå‡ºçš„è¶Šæ¥è¶Šæ¿€è¿›çš„å‡è®¾ã€‚&lt;/p>
&lt;h2 id="ç¤ºä¾‹åˆ†æž">ç¤ºä¾‹åˆ†æž &lt;a href="#%e7%a4%ba%e4%be%8b%e5%88%86%e6%9e%90" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;h3 id="å†™çº¿ç¨‹ç¤ºä¾‹">å†™çº¿ç¨‹ç¤ºä¾‹ &lt;a href="#%e5%86%99%e7%ba%bf%e7%a8%8b%e7%a4%ba%e4%be%8b" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// åˆå§‹æ—¶ variable1 = variable2 = 0;
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">while&lt;/span> (&lt;span style="color:#ae81ff">1&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> variable1&lt;span style="color:#f92672">++&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> variable2&lt;span style="color:#f92672">++&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="è¯»çº¿ç¨‹ç¤ºä¾‹">è¯»çº¿ç¨‹ç¤ºä¾‹ &lt;a href="#%e8%af%bb%e7%ba%bf%e7%a8%8b%e7%a4%ba%e4%be%8b" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">while&lt;/span> (&lt;span style="color:#ae81ff">1&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> local2 &lt;span style="color:#f92672">=&lt;/span> variable2;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> local1 &lt;span style="color:#f92672">=&lt;/span> variable1;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (local2 &lt;span style="color:#f92672">&amp;gt;&lt;/span> local1) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> print(&lt;span style="color:#e6db74">&amp;#34;Error!&amp;#34;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ­£å¸¸é€»è¾‘ä¸‹ï¼Œlocal2 åº”å½“å§‹ç»ˆå°äºŽæˆ–ç­‰äºŽ local1ï¼Œå› ä¸º variable1 æ€»æ˜¯åœ¨ variable2 ä¹‹åŽå¢žåŠ ã€‚&lt;/p>
&lt;p>ç„¶è€Œï¼ŒçŽ°å®žæ˜¯å¦å¦‚æ­¤ï¼Ÿ&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;cstdio&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;iostream&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;ctime&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;pthread.h&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;sys/time.h&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;unistd.h&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">using&lt;/span> &lt;span style="color:#66d9ef">namespace&lt;/span> std;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">unsigned&lt;/span> variable1 &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">unsigned&lt;/span> variable2 &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#define ITERATIONS 200000000
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#a6e22e">writer&lt;/span>(&lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#f92672">*&lt;/span>unused) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">for&lt;/span> (;;) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> variable1 &lt;span style="color:#f92672">=&lt;/span> variable1 &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> variable2 &lt;span style="color:#f92672">=&lt;/span> variable2 &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> NULL;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#a6e22e">reader&lt;/span>(&lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#f92672">*&lt;/span>unused) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">struct&lt;/span> &lt;span style="color:#a6e22e">timeval&lt;/span> start, end;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> gettimeofday(&lt;span style="color:#f92672">&amp;amp;&lt;/span>start, NULL);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">unsigned&lt;/span> i, failureCount &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">for&lt;/span> (i&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>; i &lt;span style="color:#f92672">&amp;lt;&lt;/span> ITERATIONS; i&lt;span style="color:#f92672">++&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">unsigned&lt;/span> v2 &lt;span style="color:#f92672">=&lt;/span> variable2;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">unsigned&lt;/span> v1 &lt;span style="color:#f92672">=&lt;/span> variable1;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (v2 &lt;span style="color:#f92672">&amp;gt;&lt;/span> v1) failureCount&lt;span style="color:#f92672">++&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> gettimeofday(&lt;span style="color:#f92672">&amp;amp;&lt;/span>end, NULL);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">double&lt;/span> seconds &lt;span style="color:#f92672">=&lt;/span> end.tv_sec &lt;span style="color:#f92672">+&lt;/span> end.tv_usec &lt;span style="color:#f92672">/&lt;/span> &lt;span style="color:#ae81ff">1000000.&lt;/span> &lt;span style="color:#f92672">-&lt;/span> start.tv_sec &lt;span style="color:#f92672">-&lt;/span> start.tv_usec &lt;span style="color:#f92672">/&lt;/span> &lt;span style="color:#ae81ff">1000000.&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> printf(&lt;span style="color:#e6db74">&amp;#34;%u failure%s (%2.1f percent of the time) in %2.1f seconds&lt;/span>&lt;span style="color:#ae81ff">\n&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> failureCount, failureCount &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span> &lt;span style="color:#f92672">?&lt;/span> &lt;span style="color:#e6db74">&amp;#34;&amp;#34;&lt;/span> &lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#e6db74">&amp;#34;s&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> (&lt;span style="color:#ae81ff">100.&lt;/span> &lt;span style="color:#f92672">*&lt;/span> failureCount) &lt;span style="color:#f92672">/&lt;/span> ITERATIONS, seconds);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> exit(&lt;span style="color:#ae81ff">0&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> NULL;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">int&lt;/span> &lt;span style="color:#a6e22e">main&lt;/span>(&lt;span style="color:#66d9ef">void&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> pthread_t thread1, thread2;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> pthread_create(&lt;span style="color:#f92672">&amp;amp;&lt;/span>thread1, NULL, writer, NULL);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> pthread_create(&lt;span style="color:#f92672">&amp;amp;&lt;/span>thread2, NULL, reader, NULL);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">for&lt;/span> (;;) sleep(&lt;span style="color:#ae81ff">1000000&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¾“å‡ºç»“æžœï¼š&lt;code>0 failures (0.0 percent of the time) in 1.2 seconds&lt;/code>&lt;/p>
&lt;h3 id="è²Œä¼¼æ˜¯æ­£ç¡®çš„">è²Œä¼¼æ˜¯æ­£ç¡®çš„ï¼Ÿ &lt;a href="#%e8%b2%8c%e4%bc%bc%e6%98%af%e6%ad%a3%e7%a1%ae%e7%9a%84" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;p>ç¨‹åºè¿è¡Œçš„æ­£å¦‚æˆ‘ä»¬é¢„æœŸçš„é‚£æ ·ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ç¡®ä¿¡ç¨‹åºæ˜¯ä¸€å®šæ­£ç¡®çš„å—ï¼Ÿ&lt;/p>
&lt;p>ä¸èƒ½ã€‚&lt;/p>
&lt;p>å› ä¸ºç¨‹åºä¸­çš„ä¸¤ä¸ªçº¿ç¨‹å¦‚æžœåœ¨åŒä¸€ä¸ªCPUä¸Šè¢«è°ƒåº¦ï¼Œæˆ‘ä»¬æ°¸è¿œéƒ½ä¼šå¾—åˆ°æ­£ç¡®çš„ç»“æžœã€‚&lt;/p>
&lt;h3 id="çº¿ç¨‹ä¸Žä¸åŒçš„cpuè¿›è¡Œç»‘å®š">çº¿ç¨‹ä¸Žä¸åŒçš„CPUè¿›è¡Œç»‘å®š &lt;a href="#%e7%ba%bf%e7%a8%8b%e4%b8%8e%e4%b8%8d%e5%90%8c%e7%9a%84cpu%e8%bf%9b%e8%a1%8c%e7%bb%91%e5%ae%9a" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#a6e22e">writer&lt;/span>(&lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#f92672">*&lt;/span>unused) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> cpu_set_t cpuset;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> CPU_ZERO(&lt;span style="color:#f92672">&amp;amp;&lt;/span>cpuset);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> CPU_SET(&lt;span style="color:#ae81ff">0&lt;/span>, &lt;span style="color:#f92672">&amp;amp;&lt;/span>cpuset);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> sched_setaffinity(&lt;span style="color:#ae81ff">0&lt;/span>, &lt;span style="color:#66d9ef">sizeof&lt;/span>(cpuset), &lt;span style="color:#f92672">&amp;amp;&lt;/span>cpuset);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#a6e22e">reader&lt;/span>(&lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#f92672">*&lt;/span>unused) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> cpu_set_t cpuset;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> CPU_ZERO(&lt;span style="color:#f92672">&amp;amp;&lt;/span>cpuset);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> CPU_SET(&lt;span style="color:#ae81ff">2&lt;/span>, &lt;span style="color:#f92672">&amp;amp;&lt;/span>cpuset);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> sched_setaffinity(&lt;span style="color:#ae81ff">0&lt;/span>, &lt;span style="color:#66d9ef">sizeof&lt;/span>(cpuset), &lt;span style="color:#f92672">&amp;amp;&lt;/span>cpuset);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// p.s. æˆ‘æœºå™¨æ˜¯i5åŒæ ¸å››çº¿ç¨‹ï¼Œæ‰€ä»¥ç»‘åœ¨äº†CPU0å’ŒCPU2ä¸Š
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç»“æžœï¼š&lt;code>0 failures (0.0 percent of the time) in 1.4 seconds&lt;/code>&lt;/p>
&lt;h3 id="ä¼¼ä¹Žä»ç„¶æ˜¯å‡†ç¡®çš„">ä¼¼ä¹Žä»ç„¶æ˜¯å‡†ç¡®çš„ &lt;a href="#%e4%bc%bc%e4%b9%8e%e4%bb%8d%e7%84%b6%e6%98%af%e5%87%86%e7%a1%ae%e7%9a%84" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;p>å°½ç®¡å¦‚æ­¤ï¼Œæˆ‘ä»¬è€ƒè™‘åˆ°CPUå¯¹å˜é‡çš„æ“ä½œå…¶å®žæ˜¯ä½œç”¨åœ¨å¯„å­˜å™¨ä¸Šï¼Œè€Œvariable1å’Œvariable2ç´§å¯†ç›¸é‚»ï¼Œè¿™å¯èƒ½å¯¼è‡´å®ƒä»¬ä½äºŽç¼“å­˜çš„åŒä¸€è¡Œã€‚å› æ­¤ï¼Œå®ƒä»¬æœ‰å¯èƒ½ä¼šåŒæ—¶è¢«å†™å…¥ç¼“å­˜å¹¶ä¸€èµ·å†™å›žå†…å­˜ã€‚&lt;/p>
&lt;p>ä¸ºäº†è§‚å¯Ÿä¸åŒçš„æ•ˆæžœï¼Œæˆ‘ä»¬å°è¯•å°†è¿™ä¸¤ä¸ªå˜é‡åˆ†åˆ«æ”¾ç½®åœ¨å †å’Œæ ˆä¸Šã€‚&lt;/p>
&lt;pre tabindex="0">&lt;code>0 failures (0.0 percent of the time) in 1.2 seconds
0 failures (0.0 percent of the time) in 1.2 seconds
2000000000 failures (100.0 percent of the time) in 1.2 seconds
&lt;/code>&lt;/pre>&lt;p>&lt;strong>å¤ªæ„Ÿäººäº†ï¼&lt;/strong>&lt;/p>
&lt;h3 id="æˆ‘ä»¬çš„æ•Œäºº--ç¼–è¯‘å™¨">æˆ‘ä»¬çš„æ•Œäºº â€”â€” ç¼–è¯‘å™¨ &lt;a href="#%e6%88%91%e4%bb%ac%e7%9a%84%e6%95%8c%e4%ba%ba--%e7%bc%96%e8%af%91%e5%99%a8" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;blockquote>
&lt;p>Multithreading bugs are very delicate.&lt;/p>&lt;/blockquote>
&lt;p>å¹¶è¡Œå¤šçº¿ç¨‹çš„é”™è¯¯æ€»æ˜¯é‚£ä¹ˆçš„å¥‡å¦™ï¼Œä¹Ÿè®¸ä½ çš„ç¨‹åºè¿è¡Œäº†å‡ å¤©å®‰ç„¶æ— æ™ï¼Œä½†æ˜¯åœ¨æŸä¸€å¤©æŸä¸€æ—¶çªç„¶å‡ºçŽ°äº†éš¾ä»¥å¤çŽ°çš„ç²¾å¦™bugã€‚&lt;/p>
&lt;p>å¦‚æžœå¤šä¸ªçº¿ç¨‹è°ƒåº¦åœ¨åŒä¸€ä¸ªCPUæ ¸å¿ƒä¸Šï¼ŒBugä¼šè¢«æŽ©ç›–ã€‚ &lt;br>
å¦‚æžœå¤šä¸ªå˜é‡åœ¨CPUåŒä¸€è¡ŒCacheä¸Šï¼ŒBugä¼šè¢«æŽ©ç›–ã€‚ &lt;br>
å¦‚æžœä½ äººå“è¶³å¤Ÿå¥½çš„è¯ï¼ŒBugåŒæ ·ä¼šè¢«æŽ©ç›–ã€‚&lt;/p>
&lt;p>ä½†æ˜¯ï¼Œå¦‚æžœæˆ‘ä»¬æŽ’é™¤äº†ä»¥ä¸Šçš„æƒ…å†µåŽï¼Œé—®é¢˜å°±æµ®çŽ°å‡ºæ¥äº†ã€‚&lt;/p>
&lt;p>æˆ‘ä»¬æ¥çœ‹ä¸€çœ‹readerçš„åæ±‡ç¼–ä»£ç ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>(gdb) disas reader
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Dump of assembler code &lt;span style="color:#66d9ef">for&lt;/span> function reader(&lt;span style="color:#66d9ef">void&lt;/span>&lt;span style="color:#f92672">*&lt;/span>)&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x0000000000400950&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> push &lt;span style="color:#f92672">%&lt;/span>rbx
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x0000000000400951&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> xor &lt;span style="color:#f92672">%&lt;/span>eax,&lt;span style="color:#f92672">%&lt;/span>eax
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x0000000000400953&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">3&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> mov &lt;span style="color:#960050;background-color:#1e0010">$&lt;/span>&lt;span style="color:#ae81ff">0x10&lt;/span>,&lt;span style="color:#f92672">%&lt;/span>ecx
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x0000000000400958&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">8&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> mov &lt;span style="color:#960050;background-color:#1e0010">$&lt;/span>&lt;span style="color:#ae81ff">0x80&lt;/span>,&lt;span style="color:#f92672">%&lt;/span>esi
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x000000000040095d&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">13&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> xor &lt;span style="color:#f92672">%&lt;/span>ebx,&lt;span style="color:#f92672">%&lt;/span>ebx
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x000000000040095f&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">15&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> sub &lt;span style="color:#960050;background-color:#1e0010">$&lt;/span>&lt;span style="color:#ae81ff">0xa0&lt;/span>,&lt;span style="color:#f92672">%&lt;/span>rsp
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x0000000000400966&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">22&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> mov &lt;span style="color:#f92672">%&lt;/span>rsp,&lt;span style="color:#f92672">%&lt;/span>rdi
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x0000000000400969&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">25&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> mov &lt;span style="color:#f92672">%&lt;/span>rsp,&lt;span style="color:#f92672">%&lt;/span>rdx
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x000000000040096c&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">28&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> rep stos &lt;span style="color:#f92672">%&lt;/span>rax,&lt;span style="color:#f92672">%&lt;/span>es:(&lt;span style="color:#f92672">%&lt;/span>rdi)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x000000000040096f&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">31&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> xor &lt;span style="color:#f92672">%&lt;/span>edi,&lt;span style="color:#f92672">%&lt;/span>edi
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x0000000000400971&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">33&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> movq &lt;span style="color:#960050;background-color:#1e0010">$&lt;/span>&lt;span style="color:#ae81ff">0x4&lt;/span>,(&lt;span style="color:#f92672">%&lt;/span>rsp)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x0000000000400979&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">41&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> callq &lt;span style="color:#ae81ff">0x400790&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span>sched_setaffinity&lt;span style="color:#960050;background-color:#1e0010">@&lt;/span>plt&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x000000000040097e&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">46&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> lea &lt;span style="color:#ae81ff">0x80&lt;/span>(&lt;span style="color:#f92672">%&lt;/span>rsp),&lt;span style="color:#f92672">%&lt;/span>rdi
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x0000000000400986&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">54&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> xor &lt;span style="color:#f92672">%&lt;/span>esi,&lt;span style="color:#f92672">%&lt;/span>esi
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x0000000000400988&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">56&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> callq &lt;span style="color:#ae81ff">0x400710&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span>gettimeofday&lt;span style="color:#960050;background-color:#1e0010">@&lt;/span>plt&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x000000000040098d&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">61&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> mov &lt;span style="color:#ae81ff">0x2006e4&lt;/span>(&lt;span style="color:#f92672">%&lt;/span>rip),&lt;span style="color:#f92672">%&lt;/span>rax &lt;span style="color:#960050;background-color:#1e0010">#&lt;/span> &lt;span style="color:#ae81ff">0x601078&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span>variable2_p&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x0000000000400994&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">68&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> mov &lt;span style="color:#ae81ff">0x2006e6&lt;/span>(&lt;span style="color:#f92672">%&lt;/span>rip),&lt;span style="color:#f92672">%&lt;/span>edx &lt;span style="color:#960050;background-color:#1e0010">#&lt;/span> &lt;span style="color:#ae81ff">0x601080&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span>variable1&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x000000000040099a&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">74&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> mov (&lt;span style="color:#f92672">%&lt;/span>rax),&lt;span style="color:#f92672">%&lt;/span>ecx
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x000000000040099c&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">76&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> mov &lt;span style="color:#960050;background-color:#1e0010">$&lt;/span>&lt;span style="color:#ae81ff">0x77359400&lt;/span>,&lt;span style="color:#f92672">%&lt;/span>eax
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x00000000004009a1&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">81&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> nopl &lt;span style="color:#ae81ff">0x0&lt;/span>(&lt;span style="color:#f92672">%&lt;/span>rax)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x00000000004009a8&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">88&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> cmp &lt;span style="color:#f92672">%&lt;/span>ecx,&lt;span style="color:#f92672">%&lt;/span>edx
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x00000000004009aa&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">90&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> adc &lt;span style="color:#960050;background-color:#1e0010">$&lt;/span>&lt;span style="color:#ae81ff">0x0&lt;/span>,&lt;span style="color:#f92672">%&lt;/span>ebx
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x00000000004009ad&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">93&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> sub &lt;span style="color:#960050;background-color:#1e0010">$&lt;/span>&lt;span style="color:#ae81ff">0x1&lt;/span>,&lt;span style="color:#f92672">%&lt;/span>eax
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x00000000004009b0&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">96&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> jne &lt;span style="color:#ae81ff">0x4009a8&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span>reader(&lt;span style="color:#66d9ef">void&lt;/span>&lt;span style="color:#f92672">*&lt;/span>)&lt;span style="color:#f92672">+&lt;/span>&lt;span style="color:#ae81ff">88&lt;/span>&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x00000000004009b2&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">98&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> lea &lt;span style="color:#ae81ff">0x90&lt;/span>(&lt;span style="color:#f92672">%&lt;/span>rsp),&lt;span style="color:#f92672">%&lt;/span>rdi
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x00000000004009ba&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">106&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> xor &lt;span style="color:#f92672">%&lt;/span>esi,&lt;span style="color:#f92672">%&lt;/span>esi
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x00000000004009bc&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">108&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> callq &lt;span style="color:#ae81ff">0x400710&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span>gettimeofday&lt;span style="color:#960050;background-color:#1e0010">@&lt;/span>plt&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x00000000004009c1&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">113&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> cvtsi2sdq &lt;span style="color:#ae81ff">0x98&lt;/span>(&lt;span style="color:#f92672">%&lt;/span>rsp),&lt;span style="color:#f92672">%&lt;/span>xmm0
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x00000000004009cb&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">123&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> cvtsi2sdq &lt;span style="color:#ae81ff">0x90&lt;/span>(&lt;span style="color:#f92672">%&lt;/span>rsp),&lt;span style="color:#f92672">%&lt;/span>xmm1
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x00000000004009d5&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">133&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> movsd &lt;span style="color:#ae81ff">0x1a3&lt;/span>(&lt;span style="color:#f92672">%&lt;/span>rip),&lt;span style="color:#f92672">%&lt;/span>xmm3 &lt;span style="color:#960050;background-color:#1e0010">#&lt;/span> &lt;span style="color:#ae81ff">0x400b80&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x00000000004009dd&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">141&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> mov &lt;span style="color:#f92672">%&lt;/span>ebx,&lt;span style="color:#f92672">%&lt;/span>eax
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x00000000004009df&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">143&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> cvtsi2sdq &lt;span style="color:#ae81ff">0x88&lt;/span>(&lt;span style="color:#f92672">%&lt;/span>rsp),&lt;span style="color:#f92672">%&lt;/span>xmm2
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x00000000004009e9&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">153&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> cmp &lt;span style="color:#960050;background-color:#1e0010">$&lt;/span>&lt;span style="color:#ae81ff">0x1&lt;/span>,&lt;span style="color:#f92672">%&lt;/span>ebx
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x00000000004009ec&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">156&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> mov &lt;span style="color:#960050;background-color:#1e0010">$&lt;/span>&lt;span style="color:#ae81ff">0x400b3d&lt;/span>,&lt;span style="color:#f92672">%&lt;/span>ecx
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x00000000004009f1&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">161&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> mov &lt;span style="color:#960050;background-color:#1e0010">$&lt;/span>&lt;span style="color:#ae81ff">0x1&lt;/span>,&lt;span style="color:#f92672">%&lt;/span>edi
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x00000000004009f6&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">166&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> divsd &lt;span style="color:#f92672">%&lt;/span>xmm3,&lt;span style="color:#f92672">%&lt;/span>xmm0
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x00000000004009fa&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">170&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> mov &lt;span style="color:#f92672">%&lt;/span>ebx,&lt;span style="color:#f92672">%&lt;/span>edx
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x00000000004009fc&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">172&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> mov &lt;span style="color:#960050;background-color:#1e0010">$&lt;/span>&lt;span style="color:#ae81ff">0x400b40&lt;/span>,&lt;span style="color:#f92672">%&lt;/span>esi
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x0000000000400a01&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">177&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> divsd &lt;span style="color:#f92672">%&lt;/span>xmm3,&lt;span style="color:#f92672">%&lt;/span>xmm2
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x0000000000400a05&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">181&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> addsd &lt;span style="color:#f92672">%&lt;/span>xmm0,&lt;span style="color:#f92672">%&lt;/span>xmm1
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x0000000000400a09&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">185&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> cvtsi2sdq &lt;span style="color:#ae81ff">0x80&lt;/span>(&lt;span style="color:#f92672">%&lt;/span>rsp),&lt;span style="color:#f92672">%&lt;/span>xmm0
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x0000000000400a13&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">195&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> subsd &lt;span style="color:#f92672">%&lt;/span>xmm0,&lt;span style="color:#f92672">%&lt;/span>xmm1
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x0000000000400a17&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">199&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> cvtsi2sd &lt;span style="color:#f92672">%&lt;/span>rax,&lt;span style="color:#f92672">%&lt;/span>xmm0
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x0000000000400a1c&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">204&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> mov &lt;span style="color:#960050;background-color:#1e0010">$&lt;/span>&lt;span style="color:#ae81ff">0x400b3c&lt;/span>,&lt;span style="color:#f92672">%&lt;/span>eax
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x0000000000400a21&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">209&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> cmovne &lt;span style="color:#f92672">%&lt;/span>rax,&lt;span style="color:#f92672">%&lt;/span>rcx
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x0000000000400a25&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">213&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> mov &lt;span style="color:#960050;background-color:#1e0010">$&lt;/span>&lt;span style="color:#ae81ff">0x2&lt;/span>,&lt;span style="color:#f92672">%&lt;/span>eax
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x0000000000400a2a&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">218&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> mulsd &lt;span style="color:#ae81ff">0x156&lt;/span>(&lt;span style="color:#f92672">%&lt;/span>rip),&lt;span style="color:#f92672">%&lt;/span>xmm0 &lt;span style="color:#960050;background-color:#1e0010">#&lt;/span> &lt;span style="color:#ae81ff">0x400b88&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x0000000000400a32&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">226&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> subsd &lt;span style="color:#f92672">%&lt;/span>xmm2,&lt;span style="color:#f92672">%&lt;/span>xmm1
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x0000000000400a36&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">230&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> divsd &lt;span style="color:#ae81ff">0x152&lt;/span>(&lt;span style="color:#f92672">%&lt;/span>rip),&lt;span style="color:#f92672">%&lt;/span>xmm0 &lt;span style="color:#960050;background-color:#1e0010">#&lt;/span> &lt;span style="color:#ae81ff">0x400b90&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x0000000000400a3e&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">238&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> callq &lt;span style="color:#ae81ff">0x400700&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span>__printf_chk&lt;span style="color:#960050;background-color:#1e0010">@&lt;/span>plt&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x0000000000400a43&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">243&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> xor &lt;span style="color:#f92672">%&lt;/span>edi,&lt;span style="color:#f92672">%&lt;/span>edi
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0x0000000000400a45&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">245&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> callq &lt;span style="color:#ae81ff">0x4006f0&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span>exit&lt;span style="color:#960050;background-color:#1e0010">@&lt;/span>plt&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç®€è€Œè¨€ä¹‹ï¼Œå…³é”®åœ¨ä»¥ä¸‹å‡ å¥ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">0x000000000040098d&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">61&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> mov &lt;span style="color:#ae81ff">0x2006e4&lt;/span>(&lt;span style="color:#f92672">%&lt;/span>rip),&lt;span style="color:#f92672">%&lt;/span>rax &lt;span style="color:#960050;background-color:#1e0010">#&lt;/span> &lt;span style="color:#ae81ff">0x601078&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span>variable2_p&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">0x0000000000400994&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">68&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> mov &lt;span style="color:#ae81ff">0x2006e6&lt;/span>(&lt;span style="color:#f92672">%&lt;/span>rip),&lt;span style="color:#f92672">%&lt;/span>edx &lt;span style="color:#960050;background-color:#1e0010">#&lt;/span> &lt;span style="color:#ae81ff">0x601080&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span>variable1&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">0x000000000040099a&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">74&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> mov (&lt;span style="color:#f92672">%&lt;/span>rax),&lt;span style="color:#f92672">%&lt;/span>ecx
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">0x000000000040099c&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">76&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> mov &lt;span style="color:#960050;background-color:#1e0010">$&lt;/span>&lt;span style="color:#ae81ff">0x77359400&lt;/span>,&lt;span style="color:#f92672">%&lt;/span>eax
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">0x00000000004009a1&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">81&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> nopl &lt;span style="color:#ae81ff">0x0&lt;/span>(&lt;span style="color:#f92672">%&lt;/span>rax)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">0x00000000004009a8&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">88&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> cmp &lt;span style="color:#f92672">%&lt;/span>ecx,&lt;span style="color:#f92672">%&lt;/span>edx
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">0x00000000004009aa&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">90&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> adc &lt;span style="color:#960050;background-color:#1e0010">$&lt;/span>&lt;span style="color:#ae81ff">0x0&lt;/span>,&lt;span style="color:#f92672">%&lt;/span>ebx
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">0x00000000004009ad&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">93&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> sub &lt;span style="color:#960050;background-color:#1e0010">$&lt;/span>&lt;span style="color:#ae81ff">0x1&lt;/span>,&lt;span style="color:#f92672">%&lt;/span>eax
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">0x00000000004009b0&lt;/span> &lt;span style="color:#f92672">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">96&lt;/span>&lt;span style="color:#f92672">&amp;gt;:&lt;/span> jne &lt;span style="color:#ae81ff">0x4009a8&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span>reader(&lt;span style="color:#66d9ef">void&lt;/span>&lt;span style="color:#f92672">*&lt;/span>)&lt;span style="color:#f92672">+&lt;/span>&lt;span style="color:#ae81ff">88&lt;/span>&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œå¾ªçŽ¯ä½“åœ¨+88ï½ž+96è¡Œï¼Œè€Œå¯¹variable1ä¸Žvariable2çš„å–å€¼éƒ½æ”¾åœ¨äº†å¾ªçŽ¯ä»¥å¤–ã€‚&lt;/p>
&lt;blockquote>
&lt;p>æ³¨ï¼š&lt;br>
adcæ˜¯å¸¦è¿›ä½åŠ æ³•ï¼Œadc $0x0, %ebx =&amp;gt; %ebx = $0x0 + %ebx + CF &lt;br>
cmpçš„ç»“æžœæ­£æ˜¯æ”¾åœ¨CFï¼ˆå¤§äºŽè¡¨ç¤ºä¸ºæº¢å‡ºï¼‰ï¼ŒZFï¼ˆç›¸ç­‰è¡¨ç¤ºä¸º0ï¼‰ï¼ŒPFï¼ˆå°äºŽè¡¨ç¤ºä¸º-1,åˆ™ä½Ž8ä½å…¨ä¸º1,æ•…æœ‰å¶æ•°ä¸ª1ï¼‰&lt;/p>&lt;/blockquote>
&lt;p>æ­£æ˜¯è¿™ä¸ªâ€œå°æ„å¤–â€ï¼Œå¯¼è‡´äº†æˆ‘ä»¬çš„ç»“æžœè¦ä¸æ˜¯100%æ­£ç¡®ï¼Œè¦ä¸æ˜¯100%é”™è¯¯ã€‚&lt;/p>
&lt;h4 id="ä½¿ç”¨volitile">ä½¿ç”¨volitileï¼ˆï¼Ÿï¼‰ &lt;a href="#%e4%bd%bf%e7%94%a8volitile" class="anchor">ðŸ”—&lt;/a>&lt;/h4>&lt;p>è®©æˆ‘ä»¬ä¿®æ”¹ä¸€ä¸‹ä»£ç ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">volatile&lt;/span> &lt;span style="color:#66d9ef">unsigned&lt;/span> variable1 &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">volatile&lt;/span> &lt;span style="color:#66d9ef">unsigned&lt;/span> &lt;span style="color:#f92672">*&lt;/span>variable2_p &lt;span style="color:#f92672">=&lt;/span> NULL;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#define ITERATIONS 500000000LL &lt;/span>&lt;span style="color:#75715e">// è°ƒå°ä¸€ä¸‹æ•°æ®è§„æ¨¡ï¼Œå› ä¸ºvolatileå¤ªæ…¢äº†_(:Ð·ã€âˆ )_
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æˆ‘å¾—å‡ºçš„æ¥çš„ç»“æžœæ˜¯ï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code>0 failures (0.0 percent of the time) in 9.6 seconds
&lt;/code>&lt;/pre>&lt;p>è€Œä½œè€…å¾—å‡ºçš„ç»“æžœæ˜¯ï¼š
ï¼ˆæ—¶é—´ä¸Šçš„å·®å¼‚ä¸è®¡ï¼Œå› ä¸ºæˆ‘ä»¬çš„æ•°æ®è§„æ¨¡ä¸ä¸€æ ·ï¼Œæˆ‘å®žéªŒçš„æ¬¡æ•°è¦å¤šä¸€äº›ã€‚&lt;/p>
&lt;pre tabindex="0">&lt;code>fish ) ./a.out
12462711 failures (24.9 percent of the time) in 3.7 seconds
&lt;/code>&lt;/pre>&lt;p>ä»Žä½œè€…çš„ç»“æžœæ¥çœ‹ï¼Œçœ‹èµ·æ¥æ•ˆæžœå¥½äº†å¾ˆå¤šï¼Œè™½ç„¶æ…¢äº†30å¤šå€ï¼Œä½†æ˜¯ç»“æžœå¹¶ä¸æ˜¯å…¨å¯¹å…¨é”™äº†ã€‚&lt;/p>
&lt;p>è€Œä»Žæˆ‘çš„ç»“æžœæ¥çœ‹ï¼Œvolatileçœ‹ä¼¼ç¥žä¸¹å¦™è¯ï¼Œè§£å†³äº†æ‰€æœ‰çš„é—®é¢˜ã€‚(both g++ and clang++)&lt;/p>
&lt;p>&lt;strong>è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢?&lt;/strong>&lt;/p>
&lt;p>å…¶åŽŸå› åœ¨äºŽä½“ç³»ç»“æž„çš„å·®å¼‚ã€‚volatileåªèƒ½ä¿è¯å¦‚ä¸‹ä¸¤ç‚¹ï¼š&lt;/p>
&lt;ul>
&lt;li>volatileå˜é‡çš„è®¿é—®ä¸ä¼šä¼˜åŒ–æˆå¯„å­˜å™¨è®¿é—®ï¼Œè€Œæ˜¯æ¯æ¬¡éƒ½åŽ»è®¿é—®â€œå†…å­˜â€ï¼ˆè¿™ä¸ªå¼•å·ä¸€ä¼šå†è§£é‡Šï¼‰&lt;/li>
&lt;li>volatileå˜é‡é—´çš„è®¿é—®é¡ºåºä¸ä¼šè¢«ç¼–è¯‘å™¨ä¹±åº&lt;/li>
&lt;/ul>
&lt;p>è€Œå…¶ä»–çš„ä¸€åˆ‡ï¼Œvolatileå’Œç¼–è¯‘å™¨éƒ½ä¸ä¼šç»™å‡ºä»»ä½•ä¿è¯ã€‚&lt;/p>
&lt;p>ä¾‹å¦‚ï¼Œä¸åŒçš„CPUéƒ½æœ‰å…¶å†…éƒ¨çš„ç§æœ‰Cacheï¼ŒCPUçš„å†…å­˜è®¿é—®ï¼Œå¦‚æžœå‘½ä¸­äº†Cacheï¼Œåˆ™ä¸ä¼šçœŸæ­£çš„è®¿é—®å†…å­˜ã€‚ä½†ç”±äºŽå…¶ç§æœ‰Cacheå¯¹äºŽå…¶å®ƒçš„CPUæ˜¯ä¸å¯è§çš„ï¼Œä½¿ç”¨volatileå°±åŸ‹ä¸‹çš„Bugçš„ç§å­ã€‚&lt;/p>
&lt;p>è™½ç„¶åœ¨æˆ‘ä»¬çš„å®žéªŒä¸­ï¼Œç¨‹åºè¿è¡Œçš„å¾ˆå¥½ï¼Œæ²¡æœ‰å‡ºçŽ°Bugã€‚ä½†æ˜¯ï¼Œä¸€æ˜¯ç”±äºŽå¤šçº¿ç¨‹çš„Bugéƒ½æ˜¯subtleå’Œdelicateçš„ï¼Œæˆ‘ä¸èƒ½ä¿è¯åœ¨ä¸€ä¸ªéœ€è¦7x24å·¥ä½œçš„æœåŠ¡å™¨ç¨‹åºä¸­ï¼Œå®ƒä¸ä¼šå‡ºçŽ°ä»»ä½•Bugï¼›äºŒæ˜¯è‡³å°‘æˆ‘ä»¬çš„ä»£ç æ˜¯** not portable **çš„ï¼Œå¦‚æžœæœ‰ä¸€å¤©ï¼Œæˆ‘ä»¬ä»Žx86-64å¹³å°åˆ‡æ¢åˆ°äº†&lt;code>PowerPC&lt;/code>ï¼Ÿæˆ–æ˜¯&lt;code>IA64&lt;/code>ï¼Ÿæˆ‘ä»¬ä¸èƒ½ä¿è¯åœ¨è¿™äº›ä½“ç³»ç»“æž„ä¸Šï¼Œç¼–è¯‘å™¨å’ŒCPUèƒ½ä¸ºæˆ‘ä»¬æä¾›åŒæ ·çš„ä¿éšœã€‚&lt;/p>
&lt;p>äºŽæ˜¯æœ‰äººé«˜å£°ç–¾å‘¼ï¼š volatileä¸èƒ½ç”¨æ¥åšä¸ºå¤šçº¿ç¨‹çš„åŒæ­¥æœºåˆ¶ï¼&lt;/p>
&lt;blockquote>
&lt;p>è¡¥å……äºŽ20240317ï¼šåœ¨ä¸€å°è€æ—§çš„å®‰å“æ‰‹æœºä¸Šé‡å¤äº†å®žéªŒï¼Œvolatileç¡®å®žæ— æ³•æä¾›ç›¸å…³çš„ä¿éšœ&lt;/p>&lt;/blockquote>
&lt;pre tabindex="0">&lt;code>~/tmp $ clang++ -O2 a.cc &amp;amp;&amp;amp; ./a.out
99880586 failures (49.9 percent of the time) in 3.0 seconds
&lt;/code>&lt;/pre>&lt;h4 id="å°å¿ƒcpuçš„è¡Œä¸º">å°å¿ƒCPUçš„è¡Œä¸º &lt;a href="#%e5%b0%8f%e5%bf%83cpu%e7%9a%84%e8%a1%8c%e4%b8%ba" class="anchor">ðŸ”—&lt;/a>&lt;/h4>&lt;p>åœ¨å…ˆå‰çš„å®žéªŒä¸­ï¼Œå°½ç®¡ç¨‹åºçš„è¡¨çŽ°ä¸Žé¢„æœŸä¸€è‡´ï¼Œä½†æˆ‘ä»¬æ— æ³•ç¡®ä¿CPUå°†å§‹ç»ˆæŒ‰é¡ºåºæ‰§è¡Œä»£ç ã€‚å®žé™…ä¸Šï¼ŒCPUå¯èƒ½ä¼šå¯¹æ“ä½œé¡ºåºè¿›è¡Œä¼˜åŒ–ï¼Œä¾‹å¦‚ï¼Œå°†var1++å’Œvar2++çš„æ‰§è¡Œé¡ºåºè°ƒæ¢ï¼Œè¿™åœ¨å½“å‰ä¸»æµçš„CPUä¸­æ˜¯å¸¸è§çš„åšæ³•ã€‚&lt;/p>
&lt;p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œç”±äºŽä¹±åºæ‰§è¡Œä¼šå¯¼è‡´åŠŸè€—å¢žåŠ ï¼ŒæŸäº›å¤„ç†å™¨å¦‚ARMå’ŒIntel Atomå·²ç»å–æ¶ˆäº†è¿™ä¸€æœºåˆ¶ã€‚ç„¶è€Œï¼Œæˆ‘ä»¬æ— æ³•é¢„çŸ¥æœªæ¥ä»£ç å¯èƒ½ä¼šåœ¨å“ªç§ç¡¬ä»¶æž¶æž„ä¸Šè¿è¡Œï¼Œä¾‹å¦‚ARMé›†ç¾¤ï¼Œè¿™éœ€è¦æˆ‘ä»¬ä¿æŒè­¦æƒ•ã€‚&lt;/p>
&lt;h4 id="é¿å…ä½¿ç”¨é”">é¿å…ä½¿ç”¨é” &lt;a href="#%e9%81%bf%e5%85%8d%e4%bd%bf%e7%94%a8%e9%94%81" class="anchor">ðŸ”—&lt;/a>&lt;/h4>&lt;p>é€šå¸¸æƒ…å†µä¸‹ï¼Œé€šè¿‡å¼•å…¥äº’æ–¥é”ï¼ˆmutexï¼‰ä¼¼ä¹Žèƒ½å¤Ÿè§£å†³å¹¶å‘é—®é¢˜ã€‚ç„¶è€Œï¼Œæ ¹æ®ä½œè€…çš„æµ‹è¯•ï¼Œå¼•å…¥äº’æ–¥é”å¯èƒ½ä¼šå¯¼è‡´ç¨‹åºé€Ÿåº¦é™ä½Žè‡³åŽŸæ¥çš„1/130ï¼Œè€Œè‡ªæ—‹é”ï¼ˆspinlockï¼‰ä¹Ÿå¯èƒ½ä½¿å¾—é€Ÿåº¦é™ä½Žè‡³åŽŸæ¥çš„1/4ã€‚&lt;/p>
&lt;p>å› æ­¤ï¼Œæˆ‘ä»¬åº”è¯¥æš‚ç¼“ï¼Œä»”ç»†è€ƒè™‘ä½œè€…æŽ¥ä¸‹æ¥çš„å»ºè®®ã€‚&lt;/p>
&lt;h3 id="å†…å­˜å±éšœçš„åº”ç”¨">å†…å­˜å±éšœçš„åº”ç”¨ &lt;a href="#%e5%86%85%e5%ad%98%e5%b1%8f%e9%9a%9c%e7%9a%84%e5%ba%94%e7%94%a8" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;p>åœ¨å¤šCPUçŽ¯å¢ƒä¸­ï¼Œå¤„ç†å™¨å¾€å¾€ç‹¬ç«‹è¿è¡Œï¼Œä¸ä¼šåè°ƒå½¼æ­¤çš„æ“ä½œã€‚&lt;/p>
&lt;p>ç›®å‰ï¼Œæˆ‘ä»¬é¢ä¸´ä¸¤ä¸ªå¹¶ä¸ç†æƒ³çš„è§£å†³æ–¹æ¡ˆï¼šä¸€æ˜¯å°†æ‰€æœ‰çº¿ç¨‹é™åˆ¶åœ¨å•ä¸ªCPUä¸Šè¿è¡Œï¼ŒäºŒæ˜¯é€šè¿‡å¼•å…¥é‡é‡çº§é”æ¥åŒæ­¥æ“ä½œã€‚è¿™äº›æ–¹æ³•éƒ½ä¸å°½äººæ„ï¼Œä¸”æ•ˆçŽ‡ä½Žä¸‹ã€‚&lt;/p>
&lt;p>å®žé™…ä¸Šï¼Œæˆ‘ä»¬éœ€è¦åšçš„æ˜¯ï¼Œé€šè¿‡å†…å­˜å±éšœæŠ€æœ¯ï¼Œæš‚æ—¶é˜»æ­¢ç¼–è¯‘å™¨æˆ–CPUå¯¹ç¨‹åºä¸­çš„æ•°æ®è¯»å†™æ“ä½œè¿›è¡Œé‡æŽ’åºã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">for&lt;/span> (;;) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> variable1 &lt;span style="color:#f92672">=&lt;/span> variable1 &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> barrier();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">*&lt;/span>variable2 &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#f92672">*&lt;/span>variable2 &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™æ ·æˆ‘ä»¬ä¿è¯äº†ï¼Œåœ¨var1++å¿…ç„¶æ—©äºŽvar2++ã€‚var2++åŽé¢ä¹Ÿå¯ä»¥åŠ ä¸€é“barrierï¼Œåªä¸è¿‡åœ¨æˆ‘ä»¬çš„åœºæ™¯ä¸‹ï¼Œæä¾›è¿™ç§ä¿è¯æ˜¯ä¸å¿…é¡»çš„ã€‚&lt;/p>
&lt;p>ä½œè€…åˆåšäº†ä¸€æ¬¡è¯•éªŒã€‚&lt;/p>
&lt;pre tabindex="0">&lt;code>fish ) ./a.out
260 failures (0.0 percent of the time) in 0.9 seconds
&lt;/code>&lt;/pre>&lt;p>è¿™æ¬¡ä¸”é”™è¯¯å‡å°‘äº†è®¸å¤šã€‚&lt;/p>
&lt;p>æˆ‘ä»¬å†æŠŠè¯»çº¿ç¨‹å†™åŠ ä¸Šmemory barrier.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">for&lt;/span> (i&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>; i &lt;span style="color:#f92672">&amp;lt;&lt;/span> ITERATIONS; i&lt;span style="color:#f92672">++&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">unsigned&lt;/span> v2 &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#f92672">*&lt;/span>variable2;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> barrier();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">unsigned&lt;/span> v1 &lt;span style="color:#f92672">=&lt;/span> variable1;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (v2 &lt;span style="color:#f92672">&amp;gt;&lt;/span> v1) failureCount&lt;span style="color:#f92672">++&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>çœ‹çœ‹ç»“æžœï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code>fish ) ./a.out
0 failures (0.0 percent of the time) in 4.2 seconds
&lt;/code>&lt;/pre>&lt;p>ç¨‹åºè¡¨çŽ°å‡ºäº†æ­£ç¡®çš„ç»“æžœã€‚&lt;/p>
&lt;p>æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œå¦‚æžœä½ å¯¹çº¿ç¨‹Açš„è¯»å†™é¡ºåºåšå‡ºè¦æ±‚ï¼Œå¿…ç„¶çš„ï¼Œä½ ä¹Ÿè¦å¯¹çº¿ç¨‹Bçš„é¡ºåºåšè¦æ±‚ï¼Œä»¥æ­¤ç±»æŽ¨ï¼Œçº¿ç¨‹Cï¼Œçº¿ç¨‹Dâ€¦â€¦&lt;/p>
&lt;p>æ‰€ä»¥ï¼Œ&lt;strong>Memory barriers always come in pairs, or triplets or more.&lt;/strong>&lt;/p>
&lt;p>åŒæ ·çš„ï¼Œçº¿ç¨‹é”ä¹Ÿæ˜¯è¿™æ ·çš„ï¼Œè‡ªå·±é”è‡ªå·±æ€»ä¸æ˜¯ä¸€ç§æ„‰å¿«çš„ä½“éªŒï¼ˆç¬‘&lt;/p>
&lt;h3 id="cpuçš„ä¹±åºæ‰§è¡Œ">CPUçš„ä¹±åºæ‰§è¡Œ &lt;a href="#cpu%e7%9a%84%e4%b9%b1%e5%ba%8f%e6%89%a7%e8%a1%8c" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°PowerPCæœ‰ä¸‰ç§å†…å­˜å±éšœï¼Œè€ŒDEC Alphaå¹³å°æœ‰æ›´å¤šã€‚è¿™æ„å‘³ç€ï¼ŒCPUä½¿ç”¨æ›´æ¿€è¿›çš„ç­–ç•¥æ¥é‡æŽ’æŒ‡ä»¤ï¼Œè€Œå¼ºåˆ¶é™åˆ¶å…¶é‡æŽ’çš„ä»£ä»·æ˜¯éžå¸¸é«˜çš„ã€‚&lt;/p>
&lt;p>è€Œx86å¹³å°åˆ™éžå¸¸å®ˆåºï¼Œä½œè€…çŒœæµ‹å…¶åŽŸå› æ˜¯ç”±äºŽæ—©æœŸx86çš„æŒ‡ä»¤æŠ€æœ¯å¹¶éžå®Œå–„ï¼Œè€Œåœ¨é‚£æ—¶å†…å­˜ä¸ŽCPUçš„é€Ÿåº¦ä¸åƒçŽ°åœ¨è¿™æ ·æ‚¬æ®Šï¼Œæ‰€ä»¥x86ä½¿ç”¨äº†&lt;code>strongly ordered memory&lt;/code>è€Œéžåƒä¸Šé¢å‡ æ¬¾CPUä¸€æ ·çš„é‡‡ç”¨è¿‡å¤šçš„æŒ‡ä»¤é‡æŽ’åºã€‚å¦‚ä»Šï¼Œç”±äºŽx86èƒŒä¸Šäº†å‘å‰å…¼å®¹æ€§çš„åŒ…è¢±ï¼Œçœ‹ä¼¼æˆ‘ä»¬çš„&amp;quot;å¥½æ—¥å­&amp;quot;ä¸€ç›´ä¸ä¼šç»“æŸã€‚&lt;/p>
&lt;p>x86-64ï¼Œåšä¸ºx86çš„64ä½å‡çº§ç‰ˆï¼ŒåŒæ ·æ²¡æœ‰å®žçŽ°&lt;code>weakly ordered&lt;/code>ï¼Œæˆ–è€…è¯´ï¼Œä¿ç•™äº†å®žçŽ°&lt;code>weakly ordered&lt;/code>çš„æƒåˆ©ã€‚è€Œ&lt;code>IA64&lt;/code>å¹³å°ï¼Œå¦‚&lt;code>Itanium&lt;/code>ï¼Œåˆ™å®žçŽ°äº†&lt;code>weakly ordered&lt;/code>ã€‚&lt;/p>
&lt;p>ä½œè€…çŒœæµ‹x86_64ä¹‹æ‰€ä»¥ä¿å®ˆï¼Œæ˜¯ä¸ºäº†ä¸ŽIA64å¹³å°å¯¹æŠ—ã€‚x86_64çš„å¯¹äºŽx86è‰¯å¥½çš„å…¼å®¹æ€§å¯ä»¥è®©ç¨‹åºå‘˜å¤šæ´»å‡ å¹´ï¼Œæ‰€ä»¥x86_64åœ¨å¸‚åœºçš„è¡¨çŽ°æ›´å¥½ã€‚&lt;/p>
&lt;p>ä½œè€…è¿˜è¡¨ç¤ºï¼Œè€Œè‹¹æžœæ”¾å¼ƒIA64å¹³å°è½¬æŠ•x86-64å¤šå°‘æœ‰ä¸€äº›å¯æƒœï¼Œå› ä¸ºè‹¹æžœå¹¶æ²¡æœ‰ç§»æ¤æ€§é—®é¢˜ï¼ŒPowerPCå·²ç»é€æ¸è¡°è½ï¼Œä¸ºä»€ä¹ˆä¸è¯•è¯•IA64å‘¢ã€‚&lt;/p>
&lt;p>å®žé™…ä¸Šï¼Œæ ¹æ®Wikipediaï¼ŒçŽ°åœ¨æ”¯æŒIA64çš„æ“ä½œç³»ç»Ÿéžå¸¸å°‘ï¼Œåªæœ‰WinNT Familyï¼ŒRed Hat Linuxï¼ŒDebian/Gentoo/Suseä»¥åŠå…¶å®ƒã€‚è€Œä»ŽWindows Server 2008 R2ä¹‹åŽï¼ŒMicrosoftä¹Ÿè¡¨ç¤ºä¸å†æ”¯æŒItaniumã€‚æ‰€ä»¥ä»ŽçŽ°åœ¨çœ‹æ¥ï¼ŒIA64å¹³å°ç›¸å¯¹x86/x64æ¥è¯´ï¼Œæ˜¯å¤±è´¥çš„ã€‚&lt;/p>
&lt;h3 id="åŒé‡æ£€æŸ¥é”">åŒé‡æ£€æŸ¥é” &lt;a href="#%e5%8f%8c%e9%87%8d%e6%a3%80%e6%9f%a5%e9%94%81" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;p>è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹å¦‚ä¸‹çš„Obj-Cä»£ç &lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-objc" data-lang="objc">&lt;span style="display:flex;">&lt;span>+ &lt;span style="color:#a6e22e">getSharedObject&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">id&lt;/span> sharedObject;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (&lt;span style="color:#f92672">!&lt;/span> sharedObject) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> LOCK;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (&lt;span style="color:#f92672">!&lt;/span> sharedObject) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> sharedObject &lt;span style="color:#f92672">=&lt;/span> [[self alloc] init];
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> UNLOCK;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> sharedObject;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™æ˜¯éžå¸¸ç»å…¸çš„ä¸€ç§DCLP(Double Checked Lock Pattern)çš„å®žçŽ°ã€‚&lt;/p>
&lt;p>è¿™ä¸ªçœ‹èµ·æ¥ä¸é”™ï¼Œä½†æ˜¯ä½ å·²ç»çŸ¥é“è¿™å¹¶ä¸é è°±äº†ã€‚å½“æˆ‘ä»¬åˆå§‹åŒ–æˆ‘ä»¬çš„å…±äº«å•ä¾‹ï¼Œå…ˆè¦å†ä¿®æ”¹ç±»å†…çš„æŒ‡é’ˆï¼Œä½¿å…¶æŒ‡å‘ä¸€å—å£°æ˜Žå¥½çš„å†…å­˜ï¼Œå†åˆå§‹åŒ–ä¸€ä¸ªsharedObjectçš„instanceã€‚&lt;/p>
&lt;p>ä¸è¿‡ï¼Œä½ æ˜¯çŸ¥é“çš„ï¼ŒCPUå’Œç¼–è¯‘å™¨ä¼šæŠŠä¸€åˆ‡éƒ½æžç ¸ï¼Œå®ƒä»¬ä¼šä»¥ä»»æ„çš„é¡ºåºæ‰§è¡Œæˆ‘ä»¬çš„å‘½ä»¤ï¼ŒåŒæ—¶å¤„ç†å™¨ä¹‹é—´äº’ç›¸ä¸é€šæ°”ï¼ŒäºŽæ˜¯å°±ä¼šå‡ºçŽ°å¦‚ä¸‹çš„æƒ…å†µï¼š&lt;/p>
&lt;p>çº¿ç¨‹Aä¸ºæŒ‡é’ˆå£°æ˜Žäº†ä¸€æ®µç©ºé—´ï¼Œä½†æ˜¯è¿˜æ²¡æ¥åŠåˆå§‹åŒ–è¿™ä¸ªinstanceï¼Œçº¿ç¨‹Aå°±è¢«æŒ‚èµ·äº†ã€‚&lt;/p>
&lt;p>ä¹‹åŽçº¿ç¨‹BæŽ¥ç®¡ä¸€åˆ‡ï¼Œå‘çŽ°æŒ‡é’ˆæœ‰å€¼ï¼Œç»“æžœå› ä¸ºè®¿é—®äº†é‡ŽæŒ‡é’ˆå¯¼è‡´ç¨‹åºæŒ‚æŽ‰ã€‚&lt;/p>
&lt;p>ä¸è¿‡æ ¹æ®ä¸Šé¢çš„æ–‡ç« ï¼Œä½ ä»¬åº”è¯¥çŸ¥é“æ€Žä¹ˆå¤„ç†è¿™ä¸ªé—®é¢˜äº† â€”â€” è¯•è¯•å†…å­˜å±éšœï¼&lt;/p>
&lt;p>p.s. å¦‚æžœå¤§å®¶å¯¹obj-cä¸ç†Ÿæ‚‰çš„è¯ï¼Œå¯ä»¥çœ‹æˆ‘å¦å¤–ä¸€ç¯‡æ–‡ç« ã€‚é‚£ç¯‡æ–‡ç« æ˜¯å…³äºŽScott Meyerså¤§ç¥žå†™çš„ä¸€ç¯‡è®ºæ–‡ï¼Œä¸“é—¨ç”¨æ¥è®¨è®ºDCLPé—®é¢˜çš„ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-objc" data-lang="objc">&lt;span style="display:flex;">&lt;span>+ &lt;span style="color:#a6e22e">getSharedObject&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">id&lt;/span> sharedObject;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (&lt;span style="color:#f92672">!&lt;/span> sharedObject) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> LOCK;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (&lt;span style="color:#f92672">!&lt;/span> sharedObject) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">id&lt;/span> temp &lt;span style="color:#f92672">=&lt;/span> [[self alloc] init];
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> OSMemoryBarrier();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> sharedObject &lt;span style="color:#f92672">=&lt;/span> temp;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> UNLOCK;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> OSMemoryBarrier();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> sharedObject;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è€Œåœ¨ã€ŠC++ and the Perils of Double-Checked Lockingã€‹ä¸€æ–‡ä¸­ï¼ŒScott Meyerså’ŒAndrei Alexandrescuç»™å‡ºçš„è§£å†³æ–¹æ¡ˆå¦‚ä¸‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>Singleton&lt;span style="color:#f92672">*&lt;/span> Singleton&lt;span style="color:#f92672">::&lt;/span>instance () {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Singleton&lt;span style="color:#f92672">*&lt;/span> tmp &lt;span style="color:#f92672">=&lt;/span> pInstance;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// insert memory barrier
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75715e">// clear the cache to flush ``pInstance``
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75715e">// prevents &amp;#34;downwards migration&amp;#34; of Singletonâ€™s construction (by another thread);
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">if&lt;/span> (tmp &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Lock lock;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> tmp &lt;span style="color:#f92672">=&lt;/span> pInstance;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (tmp &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> tmp &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> Singleton;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// insert memory barrier
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75715e">// prevent optimistic that eliminate the temporary variable ``tmp``
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75715e">// prevents &amp;#34;upwards migration&amp;#34; of pInstanceâ€™s initialization
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> pInstance &lt;span style="color:#f92672">=&lt;/span> tmp;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> tmp;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¸¤ç§è§£å†³æ–¹æ¡ˆçš„memory barrieræ’å…¥çš„ä½ç½®ä¸åŒã€‚ä½†æ˜¯éƒ½ä¸èƒ½è¯´æ˜¯é”™çš„ã€‚å› ä¸ºä¸€ä¸ªæ˜¯ä¼ static instanceï¼Œä¸€ä¸ªæ˜¯ä¼ pointerã€‚&lt;/p>
&lt;p>å…¶å®žè¿˜æœ‰æ›´â€œæš´åŠ›â€çš„æ–¹æ³•ã€‚&lt;/p>
&lt;p>ç›´æŽ¥æ¥ä¸€æŠŠå¤§é”ï¼Œå“å½“æŠŠæ•´ä¸ªå‡½æ•°é”èµ·æ¥ï¼Œå¹¶ä¸”åœ¨æ¯ä¸€ä¸ªçº¿ç¨‹å†…ä¿ç•™ä¸€ä¸ª&lt;strong>æœ¬çº¿ç¨‹ä¸“å±ž&lt;/strong>æŒ‡å‘å•ä¾‹çš„æŒ‡é’ˆï¼ˆåšcacheï¼‰ã€‚è¿™æ ·Nä¸ªçº¿ç¨‹åªéœ€è¦è°ƒç”¨è¿™ä¸ªå‡½æ•°Næ¬¡ï¼Œçº¿ç¨‹ç«žäº‰ä¹Ÿç›¸å¯¹å°‘å¾ˆå¤šã€‚å¹¶ä¸”æ ¹æ®Linuxä¸‹çš„futexæŠ€æœ¯ï¼Œæ— ç«žäº‰ä¸‹çš„é”ç›¸å¯¹èŠ‚çœäº†ä¸å°‘èµ„æºã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>Singleton&lt;span style="color:#f92672">*&lt;/span> Singleton&lt;span style="color:#f92672">::&lt;/span>instance() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Lock lock;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span>(pInstance &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> pInstance &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> Singleton;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> pInstance;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="æˆ‘ä»¬çœŸçš„éœ€è¦è¿™ä¹ˆåšå—">æˆ‘ä»¬çœŸçš„éœ€è¦è¿™ä¹ˆåšå— &lt;a href="#%e6%88%91%e4%bb%ac%e7%9c%9f%e7%9a%84%e9%9c%80%e8%a6%81%e8%bf%99%e4%b9%88%e5%81%9a%e5%90%97" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;p>ä¸Šé¢çš„obj-cä»£ç ä¸­ï¼Œä¿è¯åŒé‡æ£€æŸ¥é”æ­£ç¡®çš„ï¼Œå…¶å®žæ˜¯ç¬¬äºŒä¸ªå†…å­˜å±éšœã€‚ä½†æ˜¯ï¼Œåœ¨é‚£é‡Œï¼Œæˆ‘ä»¬éœ€è¦çš„å…¶å®žæ˜¯ä¸€ä¸ª&amp;quot;data dependency barrier&amp;quot;ã€‚&lt;/p>
&lt;p>Linuxå†…æ ¸ä¸­ç»™å‡ºå¾ˆå¤šç»è¿‡ç²¾å¿ƒä¼˜åŒ–çš„å†…å­˜å±éšœï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œå¯ä»¥ä½¿ç”¨ã€‚ä¸è¿‡ï¼Œè¦åœ¨ä½¿ç”¨çš„æ—¶å€™å†™å¥½æ³¨é‡Šï¼Œä¸€æ˜¯ä¸ºäº†æœªæ¥çš„éªŒè¯ï¼ŒäºŒæ˜¯ä¸ºäº†è®°å½•è‡ªå·±å½“æ—¶çš„æ€è·¯ã€‚&lt;/p>
&lt;p>æ¯•ç«Ÿå¤šçº¿ç¨‹çš„æ“ä½œè¦å°å¿ƒå†å°å¿ƒï¼Œæˆ‘ä»¬éœ€è¦å……è¶³çš„ç†ç”±ï¼Œæ›´å¤šçš„å°å¿ƒæ¥åº”å¯¹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-obj-c" data-lang="obj-c">&lt;span style="display:flex;">&lt;span>+ &lt;span style="color:#a6e22e">getSharedObject&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">id&lt;/span> sharedObject;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (&lt;span style="color:#f92672">!&lt;/span> sharedObject) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> LOCK;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (&lt;span style="color:#f92672">!&lt;/span> sharedObject) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">id&lt;/span> temp &lt;span style="color:#f92672">=&lt;/span> [[self alloc] init];
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> OSMemoryBarrier();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> sharedObject &lt;span style="color:#f92672">=&lt;/span> temp;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> UNLOCK;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">/* data dependency memory barrier here */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> sharedObject;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="ä¸€åˆ‡éƒ½ç»“æŸäº†å—">ä¸€åˆ‡éƒ½ç»“æŸäº†å—ï¼Ÿ &lt;a href="#%e4%b8%80%e5%88%87%e9%83%bd%e7%bb%93%e6%9d%9f%e4%ba%86%e5%90%97" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;p>æ˜¯çš„ã€‚ä¸è¿‡è®©æˆ‘ä»¬æ€»ç»“ä¸€ä¸‹å§ã€‚&lt;/p>
&lt;p>&lt;img src="https://github.com/Wizmann/assets/raw/master/wizmann-tk-pic/barrier_tank.png" alt="Mutex Tank">&lt;/p>
&lt;ul>
&lt;li>å¤„ç†å™¨å’Œç¼–è¯‘å™¨å¹¶ä¸èƒ½å……åˆ†ä¿è¯ä»£ç æ‰§è¡Œçš„é¡ºåºï¼Œå®ƒä»¬ä¼šæŠŠä½ çš„ä»£ç åˆ°å¤„ç§»åŠ¨ã€‚æ‰€ä»¥&lt;strong>Be warned and wary!&lt;/strong>&lt;/li>
&lt;li>å¤šçº¿ç¨‹çš„é”™è¯¯æ˜¯éžå¸¸subtleå’Œdelicateçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¾ˆéš¾è®¾è®¡æµ‹è¯•ç”¨ä¾‹&lt;/li>
&lt;li>å› æ­¤ï¼Œåˆ«æŒ‡è´£QAäº†ï¼Œä»–ä»¬ä¹Ÿä¸æ˜¯æ•…æ„çš„ã€‚RDè¦å¯¹è‡ªå·±çš„ä»£ç è´Ÿè´£&lt;/li>
&lt;li>é”å¾ˆå®‰å…¨ï¼Œä½†æ˜¯ä¹Ÿå¾ˆé‡&lt;/li>
&lt;li>å†…å­˜å±éšœæ˜¯ä¸€ç§æ›´å¿«çš„ï¼Œä¸é˜»å¡žçš„ï¼Œä¸ä¼šæ­»é”çš„ä¸€ç§é”çš„æ›¿ä»£ç‰©ã€‚å®ƒä»¬æ€»è¦èŠ±è´¹æ›´å¤šçš„å¿ƒæ€ï¼Œå¹¶ä¸”ä¹Ÿä¸æ˜¯åˆ°å¤„å¯ç”¨çš„é“¶å¼¹ã€‚ä½†æ˜¯å®ƒç¡®å®žå¾ˆå¿«ï¼Œæœ‰æ›´å¥½çš„ä¼¸ç¼©æ€§ã€‚&lt;/li>
&lt;li>å†…å­˜å±éšœå¾€å¾€æ˜¯æˆå¯¹å‡ºçŽ°çš„ã€‚äº†è§£ç¬¬äºŒä¸ªå†…å­˜å±éšœè¦å‡ºçŽ°åœ¨å“ªé‡Œï¼Œæœ‰åŠ©äºŽä½ ç†è§£ä½ çš„ä»£ç ï¼Œå³ä½¿ä½ æ‰€ä½¿ç”¨çš„ä½“ç³»ç»“æž„ä¸éœ€è¦ç¬¬äºŒä¸ªå†…å­˜å±éšœã€‚&lt;/li>
&lt;/ul>
&lt;h3 id="æ‰©å±•é˜…è¯»">æ‰©å±•é˜…è¯» &lt;a href="#%e6%89%a9%e5%b1%95%e9%98%85%e8%af%bb" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;p>&lt;a href="https://www.kernel.org/doc/Documentation/memory-barriers.txt">LINUX KERNEL MEMORY BARRIERS&lt;/a>&lt;/p>
&lt;p>&lt;a href="http://citeseerx.ist.psu.edu/viewdoc/summary?doi=10.1.1.17.8112">Memory Consistency and Event Ordering in Scalable Shared-Memory Multiprocessors&lt;/a>&lt;/p></description></item><item><title>alloca vs placement new</title><link>https://wizmann.top/posts/alloca-vs-placement-new/</link><pubDate>Mon, 07 Apr 2014 21:08:59 +0000</pubDate><guid>https://wizmann.top/posts/alloca-vs-placement-new/</guid><description>&lt;h2 id="what">WHAT?! &lt;a href="#what" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;p>For most time, we use &lt;code>malloc&lt;/code> or &lt;code>new&lt;/code> for memory allocation, which will get it on &lt;em>heap&lt;/em>.&lt;/p>
&lt;p>However, access memory on &lt;em>heap&lt;/em> is not as effective as the memory on &lt;em>stack&lt;/em>, because the heap is &amp;ldquo;free-floating region of memory&amp;rdquo;. To the contrary, memory on &lt;em>stack&lt;/em> is managed by CPU automacitally and tightly. As a result, the further of the &lt;em>stack&lt;/em> compared to &lt;em>heap&lt;/em> is that we can have a faster read/write speed due to the fact that &lt;em>stack&lt;/em> memory is more likely to optimized by &lt;strong>CPU cache&lt;/strong>, in addition, it only uses a single instruction to allocate or deallocate &lt;em>stack&lt;/em> memory. Just like this.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>sub esp, &lt;span style="color:#ae81ff">0x10&lt;/span>; &lt;span style="color:#f92672">=&amp;gt;&lt;/span> allocate
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>add esp, &lt;span style="color:#ae81ff">0x10&lt;/span>; &lt;span style="color:#f92672">=&amp;gt;&lt;/span> deallocate
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="alloca">alloca &lt;a href="#alloca" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;p>The &lt;code>alloca()&lt;/code> function allocates memory from the &lt;em>stack&lt;/em>.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">int&lt;/span> &lt;span style="color:#f92672">*&lt;/span>p &lt;span style="color:#f92672">=&lt;/span> (&lt;span style="color:#66d9ef">int&lt;/span>&lt;span style="color:#f92672">*&lt;/span>)alloca(&lt;span style="color:#66d9ef">sizeof&lt;/span>(&lt;span style="color:#66d9ef">int&lt;/span>) &lt;span style="color:#f92672">*&lt;/span> size);
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>It&amp;rsquo;s quite the same as the &lt;code>malloc&lt;/code> way. But we shouldn&amp;rsquo;t free the memory allocated on the &lt;em>stack&lt;/em>; these memory will be automatically deallocated when you leave the function(&lt;strong>not the code block&lt;/strong>).&lt;/p>
&lt;h2 id="placement-new">placement new &lt;a href="#placement-new" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;p>The placement new is one of the overloads of the &lt;code>new&lt;/code> functions; this new syntax can do something as the &lt;code>alloca()&lt;/code> function.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">char&lt;/span> buffer[&lt;span style="color:#ae81ff">1024&lt;/span>];
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">int&lt;/span> &lt;span style="color:#f92672">*&lt;/span>p &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span>(buffer) &lt;span style="color:#66d9ef">int&lt;/span>[&lt;span style="color:#ae81ff">64&lt;/span>];
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>The placement new can be also used in some other scenarios but won&amp;rsquo;t be mentioned here.&lt;/p>
&lt;h2 id="variable-length-array">variable-length array &lt;a href="#variable-length-array" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;p>C90 and C++ both support the variable-length array which will be allocated on &lt;em>stack&lt;/em>, and it will be deallocted whhen you leave the &lt;strong>clode block&lt;/strong>, such as &amp;ldquo;if&amp;rdquo;, &amp;ldquo;while&amp;rdquo;, etc.&lt;/p>
&lt;p>This is much simplified, but be ware if you use both variable-length array and &lt;code>alloca()&lt;/code> in the same function, the deallocation of the array will also free anything more recenly allocated by alloca.&lt;/p>
&lt;h2 id="defects">Defects &lt;a href="#defects" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;p>&lt;em>Stack&lt;/em> has its limitation. If the allocation on &lt;em>stack&lt;/em> causes &lt;strong>stack overflow&lt;/strong> error, then the behavior of the program is undefined.&lt;/p>
&lt;p>Further, the variable-length array and &lt;code>alloca()&lt;/code> are not included in &lt;em>ANSI-C&lt;/em> standard and therefore could limit portability.&lt;/p>
&lt;p>The Google C++ style guide encourage developers to use &lt;code>scoped_ptr&lt;/code> or &lt;code>scopted_array&lt;/code> instead of variable-length array and &lt;code>alloca()&lt;/code>.&lt;/p>
&lt;h2 id="some-experiment">Some experiment &lt;a href="#some-experiment" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// compile with: g++ -std=c++0x -O2 -Wall -g -o &amp;#34;foo.cc&amp;#34; &amp;#34;foo&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;cstdio&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;cstdlib&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;cstring&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;iostream&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;algorithm&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">using&lt;/span> &lt;span style="color:#66d9ef">namespace&lt;/span> std;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#define print(x) cout &amp;lt;&amp;lt; x &amp;lt;&amp;lt; endl
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#define input(x) cin &amp;gt;&amp;gt; x
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#if defined(__i386__)
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">static&lt;/span> __inline__ &lt;span style="color:#66d9ef">unsigned&lt;/span> &lt;span style="color:#66d9ef">long&lt;/span> &lt;span style="color:#66d9ef">long&lt;/span> &lt;span style="color:#a6e22e">rdtsc&lt;/span>(&lt;span style="color:#66d9ef">void&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">unsigned&lt;/span> &lt;span style="color:#66d9ef">long&lt;/span> &lt;span style="color:#66d9ef">long&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> x;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> __asm__ &lt;span style="color:#66d9ef">volatile&lt;/span> (&lt;span style="color:#e6db74">&amp;#34;.byte 0x0f, 0x31&amp;#34;&lt;/span> &lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#e6db74">&amp;#34;=A&amp;#34;&lt;/span> (x));
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> x;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#elif defined(__x86_64__)
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">static&lt;/span> __inline__ &lt;span style="color:#66d9ef">unsigned&lt;/span> &lt;span style="color:#66d9ef">long&lt;/span> &lt;span style="color:#66d9ef">long&lt;/span> &lt;span style="color:#a6e22e">rdtsc&lt;/span>(&lt;span style="color:#66d9ef">void&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">unsigned&lt;/span> hi, lo;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> __asm__ __volatile__ (&lt;span style="color:#e6db74">&amp;#34;rdtsc&amp;#34;&lt;/span> &lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#e6db74">&amp;#34;=a&amp;#34;&lt;/span>(lo), &lt;span style="color:#e6db74">&amp;#34;=d&amp;#34;&lt;/span>(hi));
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> ( (&lt;span style="color:#66d9ef">unsigned&lt;/span> &lt;span style="color:#66d9ef">long&lt;/span> &lt;span style="color:#66d9ef">long&lt;/span>)lo)&lt;span style="color:#f92672">|&lt;/span>( ((&lt;span style="color:#66d9ef">unsigned&lt;/span> &lt;span style="color:#66d9ef">long&lt;/span> &lt;span style="color:#66d9ef">long&lt;/span>)hi)&lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span>&lt;span style="color:#ae81ff">32&lt;/span> );
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#endif
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">//#define MEMORY_ON_HEAP
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">//#define MEMORY_ON_STACK
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> SIZE &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">102400&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">int&lt;/span> &lt;span style="color:#f92672">*&lt;/span>array[SIZE] &lt;span style="color:#f92672">=&lt;/span> {NULL};
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">int&lt;/span> &lt;span style="color:#a6e22e">main&lt;/span>()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">unsigned&lt;/span> &lt;span style="color:#66d9ef">long&lt;/span> &lt;span style="color:#66d9ef">long&lt;/span> start &lt;span style="color:#f92672">=&lt;/span> rdtsc();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">#ifdef MEMORY_ON_HEAP &lt;/span>&lt;span style="color:#75715e">// RDSTC: 20586280
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">for&lt;/span> (&lt;span style="color:#66d9ef">int&lt;/span> i &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>; i &lt;span style="color:#f92672">&amp;lt;&lt;/span> SIZE; i&lt;span style="color:#f92672">++&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> array[i] &lt;span style="color:#f92672">=&lt;/span> (&lt;span style="color:#66d9ef">int&lt;/span>&lt;span style="color:#f92672">*&lt;/span>)malloc(&lt;span style="color:#66d9ef">sizeof&lt;/span>(&lt;span style="color:#66d9ef">int&lt;/span>));
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">*&lt;/span>array[i] &lt;span style="color:#f92672">=&lt;/span> i;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">#endif
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">#ifdef MEMORY_ON_STACK &lt;/span>&lt;span style="color:#75715e">// RDSTC: 3660502
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">for&lt;/span> (&lt;span style="color:#66d9ef">int&lt;/span> i &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>; i &lt;span style="color:#f92672">&amp;lt;&lt;/span> SIZE; i&lt;span style="color:#f92672">++&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> array[i] &lt;span style="color:#f92672">=&lt;/span> (&lt;span style="color:#66d9ef">int&lt;/span>&lt;span style="color:#f92672">*&lt;/span>)alloca(&lt;span style="color:#66d9ef">sizeof&lt;/span>(&lt;span style="color:#66d9ef">int&lt;/span>));
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">*&lt;/span>array[i] &lt;span style="color:#f92672">=&lt;/span> i;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">#endif
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">unsigned&lt;/span> &lt;span style="color:#66d9ef">long&lt;/span> &lt;span style="color:#66d9ef">long&lt;/span> end &lt;span style="color:#f92672">=&lt;/span> rdtsc();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> print(end &lt;span style="color:#f92672">-&lt;/span> start);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>You can use &lt;code>info register esp&lt;/code> in gdb to inspect the &lt;em>stack&lt;/em> pointer before and after you call the allocation function or declare a variable-length array.&lt;/p></description></item><item><title>ä½¿ç”¨æ–°ç±»åž‹åˆ›å»ºæ›´äººæ€§åŒ–çš„ä»£ç </title><link>https://wizmann.top/posts/humanity-code-with-new-classes/</link><pubDate>Mon, 09 Dec 2013 15:01:00 +0000</pubDate><guid>https://wizmann.top/posts/humanity-code-with-new-classes/</guid><description>&lt;h2 id="å•¥">å•¥ï¼Ÿ &lt;a href="#%e5%95%a5" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;p>è¿™ç¯‡æ–‡ç« è®¨è®ºäº†å¦‚ä½•é€šè¿‡æ–°å»ºå¹¶éžâ€å¿…è¦â€œçš„æ–°ç±»åž‹ï¼Œæ¥äº§ç”Ÿæ›´äººæ€§åŒ–çš„C++ä»£ç ã€‚&lt;/p>
&lt;p>å…³é”®è¯ï¼š&lt;/p>
&lt;ul>
&lt;li>RAII&lt;/li>
&lt;li>æ™ºèƒ½æŒ‡é’ˆ&lt;/li>
&lt;li>æŽ¥å£å‹å¥½&lt;/li>
&lt;li>æ¨¡æ¿&lt;/li>
&lt;li>æ¨¡æ¿ç‰¹åŒ–&lt;/li>
&lt;li>ä¾èµ–ç¼–è¯‘å™¨çš„ç¼ºçœè¡Œä¸º&lt;/li>
&lt;/ul>
&lt;p>å¯¹äºŽC++çš„è‰ºæœ¯ï¼Œæˆ‘åªæ˜¯ä¸ªå…¥é—¨è€…ã€‚å¦‚æžœæ–‡ç« ä¸­æœ‰ä»€ä¹ˆé—®é¢˜ï¼Œæ¬¢è¿Žå¤§å®¶æŒ‡å‡ºï¼Œæˆ‘ä¼šåŠæ—¶è¿›è¡Œä¿®æ”¹ã€‚&lt;/p>
&lt;h2 id="ä¸€ä¸ªå‹å¥½çš„äº’æ–¥é”">ä¸€ä¸ªå‹å¥½çš„äº’æ–¥é” &lt;a href="#%e4%b8%80%e4%b8%aa%e5%8f%8b%e5%a5%bd%e7%9a%84%e4%ba%92%e6%96%a5%e9%94%81" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;h3 id="äº’æ–¥é”çš„å®šä¹‰">äº’æ–¥é”çš„å®šä¹‰ &lt;a href="#%e4%ba%92%e6%96%a5%e9%94%81%e7%9a%84%e5%ae%9a%e4%b9%89" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;blockquote>
&lt;p>äº’æ–¥é”ï¼ˆè‹±è¯­ï¼šè‹±è¯­ï¼šMutual exclusionï¼Œç¼©å†™ Mutexï¼‰æ˜¯ä¸€ç§ç”¨äºŽå¤šçº¿ç¨‹ç¼–ç¨‹ä¸­ï¼Œé˜²æ­¢ä¸¤æ¡çº¿ç¨‹åŒæ—¶å¯¹åŒä¸€å…¬å…±èµ„æºï¼ˆæ¯”å¦‚å…¨å±€å˜é‡ï¼‰è¿›è¡Œè¯»å†™çš„æœºåˆ¶ã€‚è¯¥ç›®çš„é€šè¿‡å°†ä»£ç åˆ‡ç‰‡æˆä¸€ä¸ªä¸€ä¸ªçš„ä¸´ç•ŒåŒºåŸŸï¼ˆcritical sectionï¼‰è¾¾æˆã€‚ä¸´ç•ŒåŒºåŸŸæŒ‡çš„æ˜¯ä¸€å—å¯¹å…¬å…±èµ„æºè¿›è¡Œè®¿é—®çš„ä»£ç ï¼Œå¹¶éžä¸€ç§æœºåˆ¶æˆ–æ˜¯ç®—æ³•ã€‚ä¸€ä¸ªç¨‹åºã€è¿›ç¨‹ã€çº¿ç¨‹å¯ä»¥æ‹¥æœ‰å¤šä¸ªä¸´ç•ŒåŒºåŸŸï¼Œä½†æ˜¯å¹¶ä¸ä¸€å®šä¼šåº”ç”¨äº’æ–¥é”ã€‚&lt;/p>&lt;/blockquote>
&lt;h3 id="å¦‚ä½•ä½¿ç”¨äº’æ–¥é”">å¦‚ä½•ä½¿ç”¨äº’æ–¥é” &lt;a href="#%e5%a6%82%e4%bd%95%e4%bd%bf%e7%94%a8%e4%ba%92%e6%96%a5%e9%94%81" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;p>è¿™é‡Œåªåšæœ€ç®€å•çš„ç¤ºèŒƒã€‚å…·ä½“çš„ä½¿ç”¨æ–¹æ³•å’ŒåŽŸç†ä¸åœ¨æœ¬æ–‡çš„è®¨è®ºèŒƒå›´ä¹‹å†…ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;pthread.h&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">MyIntArray&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// ä¸€ä¸ªå‡æƒ³çš„æ•°ç»„ç±»åž‹ï¼Œæ”¯æŒå¤šçº¿ç¨‹ä¸‹çš„Append Onlyæ“ä½œã€‚
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">public&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> MyIntArray()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> _vec.clear();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> pthread_mutex_init(&lt;span style="color:#f92672">&amp;amp;&lt;/span>_mutex, NULL);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">int&lt;/span> &lt;span style="color:#a6e22e">push_back&lt;/span>(&lt;span style="color:#66d9ef">int&lt;/span> v)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> pthread_mutex_lock(&lt;span style="color:#f92672">&amp;amp;&lt;/span>_mutex);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">//
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75715e">// åœ¨è¿™é‡Œåšä¸€äº›å·¥ä½œ, ä¾‹å¦‚æ‰“Logï¼ŒæŠ½é£Žç­‰
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75715e">//
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> vec.push_back(v);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> pthread_mutex_unlock(&lt;span style="color:#f92672">&amp;amp;&lt;/span>_mutex);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">private&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> pthread_mutex_t _mutex;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> vector&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">int&lt;/span>&lt;span style="color:#f92672">&amp;gt;&lt;/span> _vec;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>};
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä»£ç ä¸éœ€è¦å¤šè§£é‡Šï¼Œé€šè¿‡ä¸€ä¸ªé”æ¥ä¿è¯å¤šçº¿ç¨‹push_backå‡½æ•°çš„å¯é‡å…¥æ€§ã€‚&lt;/p>
&lt;p>ä½†æ˜¯æˆ‘ä»¬éœ€è¦å¯¹ä»£ç çš„å®‰å…¨æ€§åšä¸€äº›è¯„ä¼°ã€‚&lt;/p>
&lt;p>ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¦‚ä½•å¤„ç†ï¼Œå‡½æ•°åœ¨unlock mutexä¹‹å‰å¼‚å¸¸ç»“æŸçš„æƒ…å†µã€‚&lt;/p>
&lt;p>è¿™å¹¶ä¸æ˜¯ä¸å¯èƒ½çš„ï¼Œä¾‹å¦‚&lt;code>vec.push_back(v)&lt;/code>æŠ›å‡ºäº†ä¸€ä¸ª&lt;code>std::bad_alloc&lt;/code>å¼‚å¸¸ã€‚æˆ–è€…åœ¨è¿™ä¹‹å‰å› ä¸ºä¸€äº›åŽŸå› ï¼Œå‡½æ•°åšå‡ºäº†&lt;code>return -1&lt;/code>çš„è¡Œä¸ºã€‚&lt;/p>
&lt;p>ä¹Ÿè®¸æˆ‘ä»¬åœ¨é€»è¾‘ä¸Šå¯ä»¥æŽ¥å—è¿™äº›é”™è¯¯ï¼ˆæ¯”å¦‚åšå‡ºä¸€äº›å¤±è´¥å¤„ç†ï¼‰ã€‚ä½†æ˜¯ï¼Œå¯¹äºŽå› ä¸ºæˆ‘ä»¬æ²¡æœ‰unlockæˆ‘ä»¬çš„åŒæ­¥é”ï¼ŒäºŽæ˜¯æ­»é”å°±äº§ç”Ÿäº†ã€‚&lt;/p>
&lt;p>è¿™æ˜¯ä¸€ä¸ªæžå¤§çš„éšæ‚£ï¼Œæ­»é”çš„å±å®³æˆ‘ä¹Ÿä¸ç”¨å¤šè¯´ã€‚&lt;/p>
&lt;p>é‚£ä¹ˆæˆ‘ä»¬æœ‰ä»€ä¹ˆæ–¹æ³•å¯ä»¥é¿å…è¿™ç§å±€é¢ã€‚&lt;/p>
&lt;h3 id="ä¸€ä¸ªæ–°çš„mutexç±»åž‹">ä¸€ä¸ªæ–°çš„Mutexç±»åž‹ &lt;a href="#%e4%b8%80%e4%b8%aa%e6%96%b0%e7%9a%84mutex%e7%b1%bb%e5%9e%8b" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨&lt;strong>æžæž„å‡½æ•°&lt;/strong>çš„ç‰¹æ€§æ¥ç¼–å†™å¦‚ä¸‹çš„ç±»ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;pthread.h&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">Mutex&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">public&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Mutex(&lt;span style="color:#66d9ef">explicit&lt;/span> pthread_mutex_t&lt;span style="color:#f92672">*&lt;/span> i_mutex_ptr)&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> _mutex(i_mutex_ptr){}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">lock&lt;/span>()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> pthread_mutex_lock(_mutex);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">~&lt;/span>Mutex()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> pthread_mutex_unlock(_mutex);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">private&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Mutex(); &lt;span style="color:#75715e">// disable the empty construct funtion
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> pthread_mutex_t &lt;span style="color:#f92672">*&lt;/span>_mutex;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>OKï¼Œå¦‚æžœæˆ‘ä»¬ä½¿ç”¨è¿™ä¸ªç±»åšä¸ºåŒæ­¥é”çš„ç®¡ç†ç±»ï¼Œé‚£ä¹ˆï¼Œå¦‚æžœå‡½æ•°ä¸­å‡ºçŽ°äº†éžé¢„æœŸçš„æƒ…å†µè€Œè·³å‡ºçš„æ—¶å€™ã€‚&lt;code>Mutex&lt;/code>ç±»å°±ä¼šè‡ªåŠ¨è°ƒç”¨è‡ªèº«çš„æžæž„å‡½æ•°æ¥è§£é”ã€‚é¿å…äº†æ­»é”çš„å‘ç”Ÿã€‚&lt;/p>
&lt;h3 id="æ€»ç»“">æ€»ç»“ &lt;a href="#%e6%80%bb%e7%bb%93" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;p>&lt;code>pthread_mutex_t&lt;/code>æ˜¯ä¸€ä¸ªç±»åž‹ï¼Œä½†æ˜¯æˆ‘ä»¬åœ¨è¿™ä¸ªç±»åž‹ä¹‹ä¸Šåˆæ–°å»ºäº†ä¸€ä¸ªæ–°çš„ç±»åž‹æ¥è¿›è¡Œèµ„æºç®¡ç†ã€‚ä»¥æ­¤æ¥èŽ·å¾—æ›´äººæ€§åŒ–ï¼Œæ›´å®‰å…¨ä»¥åŠæ›´å¯è¯»çš„ä»£ç ã€‚&lt;/p>
&lt;h3 id="æ‹“å±•é˜…è¯»">æ‹“å±•é˜…è¯» &lt;a href="#%e6%8b%93%e5%b1%95%e9%98%85%e8%af%bb" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;ul>
&lt;li>&lt;a href="http://www.searchtb.com/2011/01/pthreads-mutex-vs-pthread-spinlock.html">Pthreads mutex vs Pthreads spinlock&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>å¯¹äºŽmutexå’Œspinlockæœ‰ä¸€ä¸ªè¯¦ç»†çš„ä»‹ç»ï¼Œå¹¶ä¸”å¯¹æ¯”äº†è¿™ä¸¤ç§é”çš„æ€§èƒ½ã€‚&lt;/p>
&lt;ul>
&lt;li>Effective C++ æ¡æ¬¾14&lt;/li>
&lt;/ul>
&lt;p>ä»¥ä¸Šçš„ä¾‹å­æ¥æºäºŽæ­¤ï¼Œå¹¶ä¸”åšäº†ä¸€äº›ç®€åŒ–ã€‚&lt;/p>
&lt;h2 id="å¥æŸ„ç±»">å¥æŸ„ç±» &lt;a href="#%e5%8f%a5%e6%9f%84%e7%b1%bb" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;p>æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œç”±äºŽC++æ²¡æœ‰è‡ªåŠ¨å†…å­˜å›žæ”¶æœºåˆ¶ï¼Œæ‰€ä»¥å†…å­˜æ“ä½œéƒ½éœ€è¦ä»£ç ç¼–å†™è€…æ‰‹åŠ¨å®Œæˆã€‚&lt;/p>
&lt;p>è¿™å°±é€ æˆäº†æ½œåœ¨çš„å†…å­˜æ³„éœ²é—®é¢˜ â€”â€”â€”â€” ä¸å°å¿ƒæ‰‹è´±æ€Žä¹ˆåŠžï¼Ÿ&lt;/p>
&lt;p>äºŽæ˜¯æˆ‘ä»¬å°±å¼•å…¥äº†å¥æŸ„ç±»ï¼Œä¸€ç§ä½¿ç”¨&lt;strong>å¼•ç”¨è®¡æ•°æ³•&lt;/strong>æ¥ç®¡ç†å†…å­˜çš„æ–¹æ³•ã€‚&lt;/p>
&lt;h3 id="ä¸€ä¸ªæ³›åž‹å¥æŸ„ç±»">ä¸€ä¸ªæ³›åž‹å¥æŸ„ç±» &lt;a href="#%e4%b8%80%e4%b8%aa%e6%b3%9b%e5%9e%8b%e5%8f%a5%e6%9f%84%e7%b1%bb" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;p>ä»£ç æ¥è‡ªã€ŠC++ Primer ç¬¬4ç‰ˆã€‹ï¼Œæœ‰å°å°çš„æ ¼å¼ä¸Šçš„æ”¹åŠ¨ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">/* generic handle class: Provides pointerlike behavior. Although
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">access through
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">* an unbound Handle is checked and throws a runtime_error exception.
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">* The object to which the Handle points is deleted when the last
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">Handle goes away.
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">* Users should allocate new objects of type T and bind them to a
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">Handle.
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">* Once an object is bound to a Handle,, the user must not delete
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">that object.
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">*/&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">template&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">T&lt;/span>&lt;span style="color:#f92672">&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">Handle&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">public&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// unbound handle
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> Handle(T &lt;span style="color:#f92672">*&lt;/span>p &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>)&lt;span style="color:#f92672">:&lt;/span> ptr(p), use(&lt;span style="color:#66d9ef">new&lt;/span> size_t(&lt;span style="color:#ae81ff">1&lt;/span>)) { }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// overloaded operators to support pointer behavior
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> T&lt;span style="color:#f92672">&amp;amp;&lt;/span> &lt;span style="color:#66d9ef">operator&lt;/span>&lt;span style="color:#f92672">*&lt;/span>();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> T&lt;span style="color:#f92672">*&lt;/span> &lt;span style="color:#66d9ef">operator&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">const&lt;/span> T&lt;span style="color:#f92672">&amp;amp;&lt;/span> &lt;span style="color:#66d9ef">operator&lt;/span>&lt;span style="color:#f92672">*&lt;/span>() &lt;span style="color:#66d9ef">const&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">const&lt;/span> T&lt;span style="color:#f92672">*&lt;/span> &lt;span style="color:#66d9ef">operator&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>() &lt;span style="color:#66d9ef">const&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// copy control: normal pointer behavior, but last Handle deletes the object
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> Handle(&lt;span style="color:#66d9ef">const&lt;/span> Handle&lt;span style="color:#f92672">&amp;amp;&lt;/span> h)&lt;span style="color:#f92672">:&lt;/span> ptr(h.ptr), use(h.use) { &lt;span style="color:#f92672">++*&lt;/span>use; }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Handle&lt;span style="color:#f92672">&amp;amp;&lt;/span> &lt;span style="color:#66d9ef">operator&lt;/span>&lt;span style="color:#f92672">=&lt;/span>(&lt;span style="color:#66d9ef">const&lt;/span> Handle&lt;span style="color:#f92672">&amp;amp;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">~&lt;/span>Handle() { rem_ref(); }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">private&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> T&lt;span style="color:#f92672">*&lt;/span> ptr;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// shared object
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> size_t &lt;span style="color:#f92672">*&lt;/span>use;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// count of how many Handle spointto *ptr
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">rem_ref&lt;/span>()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (&lt;span style="color:#f92672">--*&lt;/span>use &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>) { &lt;span style="color:#66d9ef">delete&lt;/span> ptr; &lt;span style="color:#66d9ef">delete&lt;/span> use; }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>};
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æˆ‘ä»¬ä»Žä»£ç ä¸­å¯ä»¥çœ‹åˆ°ï¼ŒHandleç±»ä¸­ä½¿ç”¨äº†&lt;code>size_t *use&lt;/code>ç”¨æ¥å¯¹äºŽå¯¹è±¡è¿›è¡Œå¼•ç”¨è®¡æ•°ã€‚å¦‚æžœè®¡æ•°ä¸º0ï¼Œåˆ™Handleç±»ä¼šåˆ é™¤è‡ªèº«ã€‚ä¹Ÿè®¸æˆ‘ä»¬ä¼šå¿˜è®°é‡Šæ”¾å†…å­˜ï¼Œä½†æ˜¯ç¼–è¯‘å™¨ä¼šå¸®ä½ ç®¡ç†å¥½ä½ çš„å¯¹è±¡çš„ã€‚&lt;/p>
&lt;h3 id="å¥æŸ„ç±»çš„å¦ä¸€ä¸ªä¼˜ç‚¹">å¥æŸ„ç±»çš„å¦ä¸€ä¸ªä¼˜ç‚¹ &lt;a href="#%e5%8f%a5%e6%9f%84%e7%b1%bb%e7%9a%84%e5%8f%a6%e4%b8%80%e4%b8%aa%e4%bc%98%e7%82%b9" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;p>å¥æŸ„ç±»çš„å¦ä¸€ä¸ªä¼˜ç‚¹æ˜¯å¯ä»¥é™ä½Žæ–‡ä»¶é—´çš„ç¼–è¯‘ä¾å­˜å…³ç³»ã€‚&lt;/p>
&lt;p>å¥æŸ„ç±»å¯ä»¥å°†æŽ¥å£ä»Žå®žçŽ°ä¸­åˆ†ç¦»ï¼Œä»Žè€Œåˆ†ç¦»ç¼–è¯‘ä¾èµ–ã€‚&lt;/p>
&lt;p>ä¾‹å¦‚ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ª&lt;code>Person&lt;/code>ç±»ï¼Œåˆå£°æ˜Žäº†&lt;code>PersonImpl&lt;/code>å¥æŸ„ç±»ã€‚&lt;/p>
&lt;p>åˆ™æˆ‘ä»¬å¦‚æžœä¿®æ”¹äº†&lt;code>Person&lt;/code>ç±»çš„å®žçŽ°éƒ¨åˆ†ï¼Œå¹¶ä¸”ä¿æŒæŽ¥å£éƒ¨åˆ†ä¸å˜ã€‚åˆ™æˆ‘ä»¬åªéœ€è¦é‡æ–°ç¼–è¯‘å«å…¥&lt;code>Person&lt;/code>ç±»çš„æ–‡ä»¶ã€‚å«å…¥&lt;code>PersonImpl&lt;/code>ç±»çš„æ–‡ä»¶ä¸éœ€è¦é‡æ–°ç¼–è¯‘ã€‚&lt;/p>
&lt;h3 id="shared_ptr">shared_ptr &lt;a href="#shared_ptr" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;p>shared_ptræ˜¯boostä¸­å¼•å…¥çš„æ–°ç±»åž‹ï¼ŒåŽŸç†å’Œå¥æŸ„ç±»ç±»ä¼¼ï¼Œä½†æ˜¯åŠ å…¥äº†å¦‚ä¸‹ç‰¹æ€§ã€‚&lt;/p>
&lt;ul>
&lt;li>çº¿ç¨‹å®‰å…¨&lt;/li>
&lt;li>æ”¯æŒè‡ªå®šä¹‰æžæž„æ“ä½œï¼ˆåˆ é™¤å™¨ï¼‰&lt;/li>
&lt;li>æœ‰çŽ°æˆçš„åº“ä¸ºå•¥ä¸ç”¨&lt;/li>
&lt;/ul>
&lt;p>åœ¨ã€ŠEffective C++ã€‹ä¸€ä¹¦ä¸­ï¼Œä½œè€…å¯¹äºŽ&lt;code>shared_ptr&lt;/code>å¤§ä¸ºæŽ¨å´‡ï¼Œç”¨äº†å¾ˆå¤§ç¯‡å¹…æ¥ä»‹ç»å®ƒçš„ç”¨æ³•ï¼Œåœ¨è¿™é‡Œå°±ä¸èµ˜è¿°äº†ã€‚&lt;/p>
&lt;h3 id="æ½œåœ¨é—®é¢˜">æ½œåœ¨é—®é¢˜ &lt;a href="#%e6%bd%9c%e5%9c%a8%e9%97%ae%e9%a2%98" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;p>æœ‰å¤±æœ‰å¾—ï¼Œæˆ‘ä»¬åœ¨ä¸€å®šç¨‹åº¦ä¸Šæå‡äº†å†…å­˜å®‰å…¨æ€§çš„åŒæ—¶ï¼Œæˆ‘ä»¬ä¹Ÿå¿…é¡»ä»˜å‡ºä¸€å®šçš„ä»£ä»·ã€‚&lt;/p>
&lt;ul>
&lt;li>å†…å­˜æ€§èƒ½é—®é¢˜&lt;/li>
&lt;/ul>
&lt;p>æˆ‘ä»¬çš„ä¸€ä¸ªå¥æŸ„ç±»æˆ–æ™ºèƒ½æŒ‡é’ˆä¸­ï¼Œä¸ä»…æœ‰æˆ‘ä»¬çš„å¯¹è±¡æŒ‡é’ˆï¼Œè€Œä¸”è¿˜ä¿å­˜ç€å¼•ç”¨è®¡æ•°ã€‚å¦‚æžœæˆ‘ä»¬å¤„äºŽå†…å­˜æ•æ„Ÿçš„åœºæ™¯ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¿…é¡»è®¤çœŸçš„è€ƒè™‘æ”¶ç›Šå’Œä»£ä»·ã€‚&lt;/p>
&lt;ul>
&lt;li>è®¡ç®—æ€§èƒ½é—®é¢˜&lt;/li>
&lt;/ul>
&lt;p>å¦‚æžœæˆ‘ä»¬çš„å¥æŸ„ç±»éœ€è¦çº¿ç¨‹å®‰å…¨æ€§ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¹Ÿå¿…é¡»è¦ä»˜å‡ºç›¸åº”çš„æ—¶é—´ä¸Šçš„ä»£ä»·ã€‚&lt;/p>
&lt;h3 id="æ‹“å±•é˜…è¯»-1">æ‹“å±•é˜…è¯» &lt;a href="#%e6%8b%93%e5%b1%95%e9%98%85%e8%af%bb-1" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;ul>
&lt;li>
&lt;p>ã€ŠEffective C++ã€‹ç¬¬ä¸‰ç«  èµ„æºç®¡ç†&lt;/p>
&lt;/li>
&lt;li>
&lt;p>ã€ŠC++ Primerç¬¬å››ç‰ˆã€‹ 16.5 ä¸€ä¸ªæ³›åž‹å¥æŸ„ç±»&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h2 id="é˜²æ­¢æŽ¥å£è¯¯ç”¨">é˜²æ­¢æŽ¥å£è¯¯ç”¨ &lt;a href="#%e9%98%b2%e6%ad%a2%e6%8e%a5%e5%8f%a3%e8%af%af%e7%94%a8" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;p>Pythonæœ‰ä¸€ä¸ªéžå¸¸å¥½çš„ç‰¹æ€§ï¼ˆä¹Ÿè®¸åˆ«çš„è¯­è¨€ä¹Ÿæœ‰ï¼‰ã€‚ä¾‹å¦‚ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-python" data-lang="python">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">def&lt;/span> &lt;span style="color:#a6e22e">pass_date&lt;/span>(year, month, day):
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">pass&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">def&lt;/span> &lt;span style="color:#a6e22e">foo&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> pass_date(year&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">1234&lt;/span>, month&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">5&lt;/span>, day&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">6&lt;/span>)
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>åœ¨å‡½æ•°çš„è°ƒç”¨ä¸­ï¼Œå¯ä»¥æ˜Žç¡®å½¢å‚ä¸Žå®žå‚çš„å¯¹åº”å…³ç³»ã€‚è¿™å°±å¯ä»¥ä»Žå¾ˆå¤§ç¨‹åº¦ä¸Šè§£å†³äº†æŽ¥å£è¯¯ç”¨çš„é—®é¢˜ã€‚&lt;/p>
&lt;p>è€Œåœ¨C++ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ–°å»ºç±»åž‹æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚&lt;/p>
&lt;p>è¿˜ä»¥&lt;code>pass_date&lt;/code>è¿™ä¸ªå‡½æ•°ä¸ºä¾‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">struct&lt;/span> &lt;span style="color:#a6e22e">Year&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">explicit&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> year;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>};
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">struct&lt;/span> &lt;span style="color:#a6e22e">Month&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">explicit&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> month;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>};
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">struct&lt;/span> &lt;span style="color:#a6e22e">Day&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">explicit&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> day;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>};
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">Date&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">public&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">void&lt;/span> pass_date(Year year, Month month, Day day) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// pass
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>};
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">foo&lt;/span>()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Date date;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> date.psss_date(Year(&lt;span style="color:#ae81ff">1234&lt;/span>), Month(&lt;span style="color:#ae81ff">5&lt;/span>), Day(&lt;span style="color:#ae81ff">6&lt;/span>));
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="åç‰¹åŒ–ç±»ä¸­çš„æˆå‘˜å‡½æ•°">åç‰¹åŒ–ç±»ä¸­çš„æˆå‘˜å‡½æ•° &lt;a href="#%e5%81%8f%e7%89%b9%e5%8c%96%e7%b1%bb%e4%b8%ad%e7%9a%84%e6%88%90%e5%91%98%e5%87%bd%e6%95%b0" class="anchor">ðŸ”—&lt;/a>&lt;/h2>&lt;p>è¿™ä¸ªæ–¹æ³•æ¥æºäºŽstackoverflowä¸Šçš„ä¸€ä¸ª&lt;a href="http://stackoverflow.com/questions/20147821/c-how-to-partial-specialization-a-template-function-in-a-template-class">é—®é¢˜&lt;/a>ã€‚&lt;/p>
&lt;p>æˆ‘æ¯”è¾ƒæŽ¨å´‡ä¸‹é¢è¿™ä¸ªç­”æ¡ˆï¼Œè™½ç„¶å®ƒä¸æ˜¯è¢«é¡¶çš„æœ€å¤šçš„é‚£ä¸ªã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">template&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">typename&lt;/span> Group, &lt;span style="color:#66d9ef">int&lt;/span> p&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">struct&lt;/span> &lt;span style="color:#a6e22e">ApplyNorm&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">static&lt;/span> Group &lt;span style="color:#a6e22e">apply&lt;/span>(Group x, Group y, Group z)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> { &lt;span style="color:#66d9ef">return&lt;/span> pow( pow(x, p) &lt;span style="color:#f92672">+&lt;/span> pow(y, p) &lt;span style="color:#f92672">+&lt;/span> pow(z, p), (&lt;span style="color:#ae81ff">1.0&lt;/span> &lt;span style="color:#f92672">/&lt;/span> p) ); }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>};
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// Here specialize for 2
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">template&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">typename&lt;/span> Group&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">struct&lt;/span> &lt;span style="color:#a6e22e">ApplyNorm&lt;/span>&lt;span style="color:#f92672">&amp;lt;&lt;/span>Group, &lt;span style="color:#ae81ff">2&lt;/span>&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">static&lt;/span> Group &lt;span style="color:#a6e22e">apply&lt;/span>(Group x, Group y, Group z)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> std&lt;span style="color:#f92672">::&lt;/span>cout &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#e6db74">&amp;#34;spec: &amp;#34;&lt;/span> &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>endl;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> sqrt( x &lt;span style="color:#f92672">*&lt;/span> x &lt;span style="color:#f92672">+&lt;/span> y &lt;span style="color:#f92672">*&lt;/span> y &lt;span style="color:#f92672">+&lt;/span> z &lt;span style="color:#f92672">*&lt;/span> z );
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>};
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">template&lt;/span>&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">typename&lt;/span> Group&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">struct&lt;/span> &lt;span style="color:#a6e22e">Vector3D&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Group x, y, z;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Vector3D(Group x, Group y, Group z) &lt;span style="color:#f92672">:&lt;/span> x(x), y(y), z(z) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">template&lt;/span>&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">int&lt;/span> p&lt;span style="color:#f92672">&amp;gt;&lt;/span> Group Norm() &lt;span style="color:#66d9ef">const&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>};
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">template&lt;/span>&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">typename&lt;/span> Group&lt;span style="color:#f92672">&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">template&lt;/span>&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">int&lt;/span> p&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Group Vector3D&lt;span style="color:#f92672">&amp;lt;&lt;/span>Group&lt;span style="color:#f92672">&amp;gt;::&lt;/span>Norm() &lt;span style="color:#66d9ef">const&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> ApplyNorm&lt;span style="color:#f92672">&amp;lt;&lt;/span>Group, p&lt;span style="color:#f92672">&amp;gt;::&lt;/span>apply(x, y, z); &lt;span style="color:#75715e">// use the helper...
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">int&lt;/span> &lt;span style="color:#a6e22e">main&lt;/span>() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// your code goes here
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> Vector3D&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">double&lt;/span>&lt;span style="color:#f92672">&amp;gt;&lt;/span> v(&lt;span style="color:#ae81ff">1.&lt;/span>, &lt;span style="color:#ae81ff">2.&lt;/span>, &lt;span style="color:#ae81ff">3.&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> std&lt;span style="color:#f92672">::&lt;/span>cout &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> v.Norm&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#f92672">&amp;gt;&lt;/span>() &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>endl;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> std&lt;span style="color:#f92672">::&lt;/span>cout &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> v.Norm&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#ae81ff">2&lt;/span>&lt;span style="color:#f92672">&amp;gt;&lt;/span>() &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> std&lt;span style="color:#f92672">::&lt;/span>endl;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å®ƒä½¿ç”¨ä¸€ä¸ªæ–°ç±»&lt;code>ApplyNorm&lt;/code>å®žçŽ°äº†ç±»æˆå‘˜å‡½æ•°çš„åç‰¹åŒ–ã€‚&lt;/p>
&lt;h3 id="æ‹“å±•é˜…è¯»-2">æ‹“å±•é˜…è¯» &lt;a href="#%e6%8b%93%e5%b1%95%e9%98%85%e8%af%bb-2" class="anchor">ðŸ”—&lt;/a>&lt;/h3>&lt;p>ã€ŠC++ Primerç¬¬4ç‰ˆã€‹ 16.6 æ¨¡æ¿ç‰¹åŒ–&lt;/p></description></item></channel></rss>